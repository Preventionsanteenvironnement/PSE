<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon bilan de la semaine</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            min-height: 100vh;
            padding: 16px;
        }
        .container { max-width: 520px; margin: 0 auto; }

        /* === HEADER === */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 1.4rem;
            color: #2d3436;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 0.82rem;
            color: #636e72;
            line-height: 1.4;
        }

        /* === FONT CONTROLS === */
        .font-controls {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin-bottom: 10px;
        }
        .font-btn {
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 800;
            font-size: 0.85rem;
            cursor: pointer;
            background: #4b6ee6;
            color: #fff;
            font-family: inherit;
            touch-action: manipulation;
        }
        .font-btn:active { transform: translateY(1px); }

        /* === CARDS === */
        .card {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card h2 {
            font-size: 1.05rem;
            color: #2d3436;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card h2 .step-num {
            background: #4b6ee6;
            color: #fff;
            width: 26px; height: 26px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        /* === HUMEUR EMOJIS === */
        .humeur-row {
            display: flex;
            justify-content: space-around;
            gap: 6px;
            margin-bottom: 12px;
        }
        .humeur-btn {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.72rem;
            color: #636e72;
            font-family: inherit;
            flex: 1;
        }
        .humeur-btn .humeur-emoji { font-size: 1.8rem; }
        .humeur-btn:hover { background: #eef2ff; }
        .humeur-btn.selected {
            border-color: #4b6ee6;
            background: #e3f2fd;
            transform: scale(1.03);
        }

        /* === SLIDER === */
        .slider-section { margin-bottom: 14px; }
        .slider-section label {
            font-size: 0.85rem;
            color: #555;
            display: block;
            margin-bottom: 6px;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-row input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
        }
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: #4b6ee6;
            cursor: pointer;
        }
        .slider-val {
            font-weight: 700;
            font-size: 1rem;
            min-width: 30px;
            text-align: right;
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 2px;
        }

        /* === TEXTAREA === */
        .field-group { margin-bottom: 14px; }
        .field-group label {
            font-size: 0.85rem;
            color: #555;
            display: block;
            margin-bottom: 6px;
        }
        .field-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.85rem;
            font-family: inherit;
            resize: none;
            min-height: 60px;
            transition: border-color 0.2s;
            line-height: 1.4;
        }
        .field-textarea:focus {
            outline: none;
            border-color: #4b6ee6;
        }

        /* === MATIERES === */
        .matieres-setup { margin-bottom: 14px; }
        .matieres-setup p {
            font-size: 0.82rem;
            color: #636e72;
            margin-bottom: 10px;
        }
        .matieres-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .matieres-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.85rem;
            font-family: inherit;
        }
        .matieres-input:focus { outline: none; border-color: #4b6ee6; }
        .btn-add-matiere {
            background: #4b6ee6;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 8px 14px;
            font-size: 0.85rem;
            cursor: pointer;
            font-family: inherit;
            white-space: nowrap;
        }
        .btn-add-matiere:hover { background: #3b5bdb; }

        .matieres-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        .matiere-tag {
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 0.78rem;
            color: #4338ca;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .matiere-tag .tag-remove {
            cursor: pointer;
            color: #94a3b8;
            font-weight: 700;
            font-size: 0.9rem;
            line-height: 1;
        }
        .matiere-tag .tag-remove:hover { color: #ef4444; }

        /* Mati√®re bilan row */
        .matiere-bilan {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .matiere-bilan:last-child { border-bottom: none; }
        .matiere-bilan .mb-name {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 600;
            color: #334155;
        }
        .mb-btns { display: flex; gap: 4px; }
        .mb-btn {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
        }
        .mb-btn:hover { background: #eef2ff; }
        .mb-btn.selected-bien { border-color: #22c55e; background: #f0fdf4; }
        .mb-btn.selected-moyen { border-color: #f59e0b; background: #fffbeb; }
        .mb-btn.selected-difficile { border-color: #ef4444; background: #fef2f2; }

        /* === OBJECTIF === */
        .objectif-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            color: #fff;
        }
        .objectif-box label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
            display: block;
            margin-bottom: 8px;
        }
        .objectif-textarea {
            width: 100%;
            padding: 10px 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            background: rgba(255,255,255,0.95);
            color: #333;
        }
        .objectif-textarea:focus { outline: 2px solid rgba(255,255,255,0.5); }

        /* === BOUTON ENREGISTRER === */
        .btn-save {
            width: 100%;
            padding: 14px;
            background: #22c55e;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
            margin-top: 12px;
        }
        .btn-save:hover { background: #16a34a; }

        .save-confirm {
            display: none;
            text-align: center;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }
        .save-confirm.visible { display: block; }
        .save-confirm .check { font-size: 2.5rem; margin-bottom: 8px; }

        /* === JOURNAL / HISTORIQUE === */
        .journal-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .journal-title h2 { margin-bottom: 0; }
        .btn-clear {
            background: none;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.72rem;
            color: #94a3b8;
            cursor: pointer;
            font-family: inherit;
        }
        .btn-clear:hover { border-color: #ef4444; color: #ef4444; }

        .journal-empty {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
            font-size: 0.85rem;
        }

        /* Historique entr√©e */
        .hist-entry {
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .hist-entry:last-child { border-bottom: none; }
        .hist-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .hist-date {
            font-size: 0.72rem;
            color: #94a3b8;
        }
        .hist-humeur { font-size: 1.3rem; }
        .hist-bars {
            display: flex;
            gap: 4px;
            align-items: center;
            flex: 1;
        }
        .hist-bar-label {
            font-size: 0.65rem;
            color: #94a3b8;
            min-width: 28px;
        }
        .hist-bar {
            flex: 1;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }
        .hist-bar-fill {
            height: 100%;
            border-radius: 3px;
        }
        .hist-matieres {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        .hist-mat-tag {
            font-size: 0.68rem;
            padding: 2px 8px;
            border-radius: 10px;
            border: 1px solid;
        }
        .hist-mat-bien { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .hist-mat-moyen { background: #fffbeb; border-color: #fde68a; color: #92400e; }
        .hist-mat-difficile { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
        .hist-objectif {
            font-size: 0.78rem;
            color: #555;
            margin-top: 6px;
            font-style: italic;
        }

        .btn-new {
            width: 100%;
            padding: 12px;
            background: #4b6ee6;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            font-family: inherit;
        }
        .btn-new:hover { background: #3b5bdb; }

        /* === FOOTER === */
        .footer {
            text-align: center;
            padding: 20px 0 10px;
            font-size: 0.7rem;
            color: #b0b8c1;
        }

        /* === ANIMATIONS === */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 400px) {
            .humeur-btn { padding: 8px 6px; }
            .humeur-btn .humeur-emoji { font-size: 1.5rem; }
            .card { padding: 16px; }
            .mb-btn { padding: 5px 7px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- FONT CONTROLS -->
    <div class="font-controls">
        <button class="font-btn" type="button" onclick="changeSize(-1)">A-</button>
        <button class="font-btn" type="button" onclick="changeSize(1)">A+</button>
    </div>

    <!-- HEADER -->
    <div class="header">
        <h1>üìã Mon bilan de la semaine</h1>
        <p>Prends 5 minutes pour faire le point sur ta semaine. Tout reste sur ton t√©l√©phone, personne d'autre ne verra tes r√©ponses.</p>
    </div>

    <!-- SECTION 1 ‚Äî HUMEUR & RESSENTI -->
    <div class="card" id="card-humeur">
        <h2><span class="step-num">1</span> Comment s'est pass√©e ma semaine ?</h2>

        <label style="font-size:0.85rem; color:#555; margin-bottom:8px; display:block;">Mon humeur cette semaine</label>
        <div class="humeur-row" id="humeur-row">
            <button class="humeur-btn" onclick="selectHumeur(this, 'super', 'üòÑ')">
                <span class="humeur-emoji">üòÑ</span>Super
            </button>
            <button class="humeur-btn" onclick="selectHumeur(this, 'bien', 'üôÇ')">
                <span class="humeur-emoji">üôÇ</span>Bien
            </button>
            <button class="humeur-btn" onclick="selectHumeur(this, 'moyen', 'üòê')">
                <span class="humeur-emoji">üòê</span>Moyen
            </button>
            <button class="humeur-btn" onclick="selectHumeur(this, 'difficile', 'üòî')">
                <span class="humeur-emoji">üòî</span>Difficile
            </button>
            <button class="humeur-btn" onclick="selectHumeur(this, 'tres-difficile', 'üòû')">
                <span class="humeur-emoji">üòû</span>Dur
            </button>
        </div>

        <div class="slider-section">
            <label>Ma motivation pour le lyc√©e</label>
            <div class="slider-row">
                <input type="range" id="motivation-range" min="0" max="10" value="5" oninput="updateMotivation(this.value)">
                <span class="slider-val" id="motivation-val" style="color:#f59e0b;">5</span>
            </div>
            <div class="slider-labels"><span>Tr√®s faible</span><span>Tr√®s forte</span></div>
        </div>

        <div class="field-group">
            <label>‚ú® Le moment fort de ma semaine</label>
            <textarea class="field-textarea" id="moment-fort" placeholder="Un truc positif, une r√©ussite, un bon moment..."></textarea>
        </div>

        <div class="field-group">
            <label>‚ö° Ce qui a √©t√© difficile</label>
            <textarea class="field-textarea" id="moment-difficile" placeholder="Une difficult√©, un probl√®me, un moment compliqu√©..."></textarea>
        </div>
    </div>

    <!-- SECTION 2 ‚Äî MATIERES -->
    <div class="card" id="card-matieres">
        <h2><span class="step-num">2</span> Mes mati√®res cette semaine</h2>

        <!-- Zone setup mati√®res (premi√®re fois) -->
        <div id="matieres-setup">
            <p>Ajoute tes mati√®res (elles seront m√©moris√©es pour les prochaines semaines) :</p>
            <div class="matieres-input-row">
                <input type="text" class="matieres-input" id="matiere-input" placeholder="Ex: Fran√ßais, Maths, PSE..." onkeydown="if(event.key==='Enter'){event.preventDefault();ajouterMatiere();}">
                <button class="btn-add-matiere" onclick="ajouterMatiere()">+ Ajouter</button>
            </div>
            <div class="matieres-tags" id="matieres-tags"></div>
        </div>

        <!-- Zone bilan par mati√®re -->
        <div id="matieres-bilan"></div>

        <div class="field-group" style="margin-top:12px;">
            <label>üí¨ Un commentaire sur une mati√®re ? (facultatif)</label>
            <textarea class="field-textarea" id="commentaire-matiere" placeholder="Ex: j'ai progress√© en maths, j'ai du mal en anglais..."></textarea>
        </div>
    </div>

    <!-- SECTION 3 ‚Äî OBJECTIF -->
    <div class="card" id="card-objectif">
        <h2><span class="step-num">3</span> Ma semaine prochaine</h2>

        <div class="objectif-box">
            <label>üéØ La semaine prochaine, je veux...</label>
            <textarea class="objectif-textarea" id="objectif" placeholder="Un objectif concret : mieux m'organiser, participer plus, r√©viser tel contr√¥le..."></textarea>
        </div>

        <button class="btn-save" id="btn-save" onclick="enregistrerBilan()">‚úÖ Enregistrer mon bilan</button>

        <div class="save-confirm" id="save-confirm">
            <div class="check">‚úÖ</div>
            <p style="font-size:0.9rem; color:#636e72;">Bilan enregistr√© ! Tu peux voir ton historique ci-dessous.</p>
        </div>
    </div>

    <!-- JOURNAL / HISTORIQUE -->
    <div class="card" id="card-journal">
        <div class="journal-title">
            <h2>üìä Mon historique</h2>
            <button class="btn-clear" id="btn-clear" onclick="effacerJournal()">üóëÔ∏è Effacer</button>
        </div>
        <div id="journal-content">
            <div class="journal-empty">Aucun bilan pour le moment.</div>
        </div>
        <button class="btn-new" id="btn-new" onclick="nouveauBilan()" style="display:none;">üìã Nouveau bilan</button>
    </div>

    <div class="footer">Mon bilan de la semaine ‚Äî Espace Parcours & R√©flexion</div>
</div>

<script>
// =============================================
// √âTAT
// =============================================
let state = {
    humeur: null,
    humeurEmoji: null,
    motivation: 5,
    matieresBilan: {} // { "Maths": "bien", "Fran√ßais": "moyen", ... }
};

let matieres = []; // liste des mati√®res de l'√©l√®ve
const STORAGE_MATIERES = 'bilan_semaine_matieres';
const STORAGE_JOURNAL = 'bilan_semaine_journal';

// =============================================
// FONT SIZE
// =============================================
let currentSize = 16;
function changeSize(delta) {
    currentSize += delta;
    if (currentSize < 12) currentSize = 12;
    if (currentSize > 24) currentSize = 24;
    document.documentElement.style.fontSize = currentSize + 'px';
}

// =============================================
// AUTO-RESIZE TEXTAREAS
// =============================================
function initAutoResize() {
    document.querySelectorAll('textarea').forEach(function(ta) {
        var resize = function() {
            ta.style.height = 'auto';
            ta.style.height = (ta.scrollHeight + 2) + 'px';
        };
        ta.addEventListener('input', resize);
        resize();
    });
}

// =============================================
// SECTION 1 ‚Äî HUMEUR
// =============================================
function selectHumeur(el, val, emoji) {
    document.querySelectorAll('.humeur-btn').forEach(function(b) { b.classList.remove('selected'); });
    el.classList.add('selected');
    state.humeur = val;
    state.humeurEmoji = emoji;
}

function updateMotivation(val) {
    state.motivation = parseInt(val);
    var display = document.getElementById('motivation-val');
    display.textContent = val;
    if (val <= 3) display.style.color = '#ef4444';
    else if (val <= 6) display.style.color = '#f59e0b';
    else display.style.color = '#22c55e';
}

// =============================================
// SECTION 2 ‚Äî MATIERES
// =============================================
function chargerMatieres() {
    try {
        matieres = JSON.parse(localStorage.getItem(STORAGE_MATIERES)) || [];
    } catch(e) { matieres = []; }
    renderMatiereTags();
    renderMatiereBilan();
}

function ajouterMatiere() {
    var input = document.getElementById('matiere-input');
    var nom = input.value.trim();
    if (!nom) return;
    // √âviter les doublons
    if (matieres.indexOf(nom) > -1) { input.value = ''; return; }
    matieres.push(nom);
    localStorage.setItem(STORAGE_MATIERES, JSON.stringify(matieres));
    input.value = '';
    renderMatiereTags();
    renderMatiereBilan();
}

function supprimerMatiere(idx) {
    var nom = matieres[idx];
    matieres.splice(idx, 1);
    delete state.matieresBilan[nom];
    localStorage.setItem(STORAGE_MATIERES, JSON.stringify(matieres));
    renderMatiereTags();
    renderMatiereBilan();
}

function renderMatiereTags() {
    var container = document.getElementById('matieres-tags');
    if (matieres.length === 0) {
        container.innerHTML = '';
        return;
    }
    var html = '';
    matieres.forEach(function(m, i) {
        html += '<span class="matiere-tag">' + escHtml(m) + ' <span class="tag-remove" onclick="supprimerMatiere(' + i + ')">√ó</span></span>';
    });
    container.innerHTML = html;
}

function renderMatiereBilan() {
    var container = document.getElementById('matieres-bilan');
    if (matieres.length === 0) {
        container.innerHTML = '';
        return;
    }
    var html = '';
    matieres.forEach(function(m) {
        var current = state.matieresBilan[m] || null;
        html += '<div class="matiere-bilan">';
        html += '<span class="mb-name">' + escHtml(m) + '</span>';
        html += '<div class="mb-btns">';
        html += '<button class="mb-btn' + (current === 'bien' ? ' selected-bien' : '') + '" onclick="selectMatiereBilan(this, \'' + escAttr(m) + '\', \'bien\')" title="Bien">üòä</button>';
        html += '<button class="mb-btn' + (current === 'moyen' ? ' selected-moyen' : '') + '" onclick="selectMatiereBilan(this, \'' + escAttr(m) + '\', \'moyen\')" title="Moyen">üòê</button>';
        html += '<button class="mb-btn' + (current === 'difficile' ? ' selected-difficile' : '') + '" onclick="selectMatiereBilan(this, \'' + escAttr(m) + '\', \'difficile\')" title="Difficile">üòü</button>';
        html += '</div></div>';
    });
    container.innerHTML = html;
}

function selectMatiereBilan(el, matiere, niveau) {
    // Toggle: si d√©j√† s√©lectionn√©, d√©selectionner
    if (state.matieresBilan[matiere] === niveau) {
        delete state.matieresBilan[matiere];
    } else {
        state.matieresBilan[matiere] = niveau;
    }
    renderMatiereBilan();
}

// =============================================
// ENREGISTRER
// =============================================
function enregistrerBilan() {
    if (!state.humeur) {
        alert('Choisis ton humeur de la semaine !');
        return;
    }

    var semaineDu = getDateDeLaSemaine();

    var entry = {
        semaine: semaineDu,
        humeur: state.humeur,
        humeurEmoji: state.humeurEmoji,
        motivation: state.motivation,
        momentFort: document.getElementById('moment-fort').value.trim(),
        momentDifficile: document.getElementById('moment-difficile').value.trim(),
        matieres: JSON.parse(JSON.stringify(state.matieresBilan)),
        commentaireMatiere: document.getElementById('commentaire-matiere').value.trim(),
        objectif: document.getElementById('objectif').value.trim(),
        timestamp: Date.now()
    };

    // Sauvegarder
    var journal = [];
    try { journal = JSON.parse(localStorage.getItem(STORAGE_JOURNAL)) || []; } catch(e) {}
    journal.unshift(entry);
    if (journal.length > 20) journal = journal.slice(0, 20);
    localStorage.setItem(STORAGE_JOURNAL, JSON.stringify(journal));

    // Feedback
    document.getElementById('btn-save').style.display = 'none';
    document.getElementById('save-confirm').classList.add('visible');
    document.getElementById('btn-new').style.display = 'block';

    renderJournal();
}

function getDateDeLaSemaine() {
    var now = new Date();
    // Trouver le lundi de la semaine en cours
    var day = now.getDay();
    var diff = now.getDate() - day + (day === 0 ? -6 : 1);
    var lundi = new Date(now.setDate(diff));
    return lundi.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
}

// =============================================
// JOURNAL / HISTORIQUE
// =============================================
function renderJournal() {
    var journal = [];
    try { journal = JSON.parse(localStorage.getItem(STORAGE_JOURNAL)) || []; } catch(e) {}

    var container = document.getElementById('journal-content');
    var btnClear = document.getElementById('btn-clear');

    if (journal.length === 0) {
        container.innerHTML = '<div class="journal-empty">Aucun bilan pour le moment.</div>';
        btnClear.style.display = 'none';
        return;
    }
    btnClear.style.display = 'block';

    var html = '';
    var display = journal.slice(0, 5);
    display.forEach(function(e) {
        var motColor = e.motivation <= 3 ? '#ef4444' : (e.motivation <= 6 ? '#f59e0b' : '#22c55e');
        var motWidth = (e.motivation / 10) * 100;

        html += '<div class="hist-entry">';
        html += '<div class="hist-header">';
        html += '<span class="hist-date">Sem. ' + e.semaine + '</span>';
        html += '<span class="hist-humeur">' + e.humeurEmoji + '</span>';
        html += '<div class="hist-bars">';
        html += '<span class="hist-bar-label">Motiv.</span>';
        html += '<div class="hist-bar"><div class="hist-bar-fill" style="width:' + motWidth + '%; background:' + motColor + ';"></div></div>';
        html += '</div></div>';

        // Mati√®res r√©sum√©
        var mats = e.matieres || {};
        var matKeys = Object.keys(mats);
        if (matKeys.length > 0) {
            html += '<div class="hist-matieres">';
            matKeys.forEach(function(m) {
                var cls = 'hist-mat-' + mats[m];
                var emoji = mats[m] === 'bien' ? 'üòä' : (mats[m] === 'moyen' ? 'üòê' : 'üòü');
                html += '<span class="hist-mat-tag ' + cls + '">' + emoji + ' ' + escHtml(m) + '</span>';
            });
            html += '</div>';
        }

        // Objectif
        if (e.objectif) {
            html += '<div class="hist-objectif">üéØ ' + escHtml(e.objectif) + '</div>';
        }
        html += '</div>';
    });

    if (journal.length > 5) {
        html += '<p style="text-align:center; font-size:0.72rem; color:#94a3b8; margin-top:8px;">+ ' + (journal.length - 5) + ' bilans precedents</p>';
    }

    container.innerHTML = html;
}

function effacerJournal() {
    if (!confirm('Effacer tout ton historique ? Cette action est irreversible.')) return;
    localStorage.removeItem(STORAGE_JOURNAL);
    renderJournal();
}

function nouveauBilan() {
    // Reset state
    state = { humeur: null, humeurEmoji: null, motivation: 5, matieresBilan: {} };

    // Reset UI
    document.querySelectorAll('.humeur-btn').forEach(function(b) { b.classList.remove('selected'); });
    document.getElementById('motivation-range').value = 5;
    updateMotivation(5);
    document.getElementById('moment-fort').value = '';
    document.getElementById('moment-difficile').value = '';
    document.getElementById('commentaire-matiere').value = '';
    document.getElementById('objectif').value = '';
    document.getElementById('btn-save').style.display = 'block';
    document.getElementById('save-confirm').classList.remove('visible');

    renderMatiereBilan();

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// =============================================
// UTILS
// =============================================
function escHtml(str) {
    var div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
}

function escAttr(str) {
    return (str || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// =============================================
// INIT
// =============================================
chargerMatieres();
renderJournal();
initAutoResize();
</script>

</body>
</html>
