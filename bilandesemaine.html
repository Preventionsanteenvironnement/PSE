<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon bilan de la semaine</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            min-height: 100vh;
            padding: 16px;
        }
        .container { max-width: 520px; margin: 0 auto; }

        /* === FONT CONTROLS === */
        .font-controls {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin-bottom: 10px;
        }
        .font-btn {
            border: none; border-radius: 8px; padding: 6px 12px;
            font-weight: 800; font-size: 0.85rem; cursor: pointer;
            background: #4b6ee6; color: #fff; font-family: inherit;
            touch-action: manipulation;
        }
        .font-btn:active { transform: translateY(1px); }

        /* === HEADER === */
        .header { text-align: center; margin-bottom: 16px; }
        .header h1 { font-size: 1.4rem; color: #2d3436; margin-bottom: 4px; }
        .header p { font-size: 0.82rem; color: #636e72; line-height: 1.4; }

        /* === STREAK === */
        .streak-bar {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px; padding: 12px 16px;
            color: #fff; margin-bottom: 16px;
            text-align: center; animation: fadeIn 0.3s ease;
        }
        .streak-bar.visible { display: block; }
        .streak-bar .streak-num { font-size: 1.8rem; font-weight: 800; }
        .streak-bar .streak-label { font-size: 0.78rem; opacity: 0.9; }
        .streak-bar .streak-badges { margin-top: 8px; display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
        .streak-badge {
            background: rgba(255,255,255,0.2); border-radius: 20px;
            padding: 3px 10px; font-size: 0.7rem;
        }
        .streak-badge.locked { opacity: 0.4; }

        /* === CARDS === */
        .card {
            background: #fff; border-radius: 15px; padding: 20px;
            margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card h2 {
            font-size: 1.05rem; color: #2d3436; margin-bottom: 14px;
            display: flex; align-items: center; gap: 8px;
        }
        .card h2 .step-num {
            background: #4b6ee6; color: #fff; width: 26px; height: 26px;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 0.8rem; flex-shrink: 0;
        }

        /* === DASHBOARD === */
        .dashboard { display: none; animation: fadeIn 0.3s ease; }
        .dashboard.visible { display: block; }
        .dash-title {
            font-size: 0.9rem; font-weight: 700; color: #2d3436;
            margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
        }

        /* Graph humeur */
        .graph-container { position: relative; height: 100px; margin-bottom: 16px; }
        .graph-row {
            display: flex; align-items: flex-end; justify-content: space-around;
            height: 80px; padding: 0 4px; border-bottom: 1px solid #e2e8f0;
        }
        .graph-col {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            flex: 1;
        }
        .graph-emoji { font-size: 1.2rem; }
        .graph-bar-wrap { width: 20px; border-radius: 4px 4px 0 0; overflow: hidden; }
        .graph-bar {
            width: 100%; border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }
        .graph-label { font-size: 0.6rem; color: #94a3b8; margin-top: 2px; }

        /* Mati√®res r√©sum√© dashboard */
        .dash-matieres {
            display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;
        }
        .dash-mat {
            font-size: 0.72rem; padding: 4px 10px; border-radius: 20px;
            border: 1px solid; display: flex; align-items: center; gap: 4px;
        }
        .dash-mat-bien { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .dash-mat-moyen { background: #fffbeb; border-color: #fde68a; color: #92400e; }
        .dash-mat-difficile { background: #fef2f2; border-color: #fecaca; color: #991b1b; }

        /* Objectif rappel */
        .objectif-rappel {
            display: none; background: #fffbeb; border: 1px solid #fde68a;
            border-radius: 12px; padding: 14px; margin-bottom: 16px;
            animation: fadeIn 0.3s ease;
        }
        .objectif-rappel.visible { display: block; }
        .objectif-rappel .rappel-title {
            font-size: 0.82rem; color: #92400e; font-weight: 600; margin-bottom: 6px;
        }
        .objectif-rappel .rappel-text {
            font-size: 0.85rem; color: #333; font-style: italic; margin-bottom: 10px;
        }
        .rappel-btns { display: flex; gap: 8px; }
        .rappel-btn {
            flex: 1; padding: 8px; border: 2px solid transparent;
            border-radius: 10px; cursor: pointer; font-size: 0.82rem;
            font-family: inherit; text-align: center; transition: all 0.2s;
            background: #f8f9fa;
        }
        .rappel-btn:hover { transform: scale(1.02); }
        .rappel-btn.selected-oui { border-color: #22c55e; background: #f0fdf4; }
        .rappel-btn.selected-partiel { border-color: #f59e0b; background: #fffbeb; }
        .rappel-btn.selected-non { border-color: #ef4444; background: #fef2f2; }

        /* === HUMEUR EMOJIS === */
        .humeur-row {
            display: flex; justify-content: space-around; gap: 6px; margin-bottom: 12px;
        }
        .humeur-btn {
            background: #f8f9fa; border: 2px solid transparent;
            border-radius: 12px; padding: 10px 8px; cursor: pointer;
            transition: all 0.2s; display: flex; flex-direction: column;
            align-items: center; gap: 4px; font-size: 0.7rem;
            color: #636e72; font-family: inherit; flex: 1;
        }
        .humeur-btn .humeur-emoji { font-size: 1.8rem; }
        .humeur-btn:hover { background: #eef2ff; }
        .humeur-btn.selected { border-color: #4b6ee6; background: #e3f2fd; transform: scale(1.03); }

        /* === SLIDER === */
        .slider-section { margin-bottom: 14px; }
        .slider-section label { font-size: 0.85rem; color: #555; display: block; margin-bottom: 6px; }
        .slider-row { display: flex; align-items: center; gap: 10px; }
        .slider-row input[type="range"] {
            flex: 1; -webkit-appearance: none; height: 6px;
            border-radius: 3px; background: #e2e8f0; outline: none;
        }
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 22px; height: 22px;
            border-radius: 50%; background: #4b6ee6; cursor: pointer;
        }
        .slider-val { font-weight: 700; font-size: 1rem; min-width: 30px; text-align: right; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #94a3b8; margin-top: 2px; }

        /* === TEXTAREA === */
        .field-group { margin-bottom: 14px; }
        .field-group label { font-size: 0.85rem; color: #555; display: block; margin-bottom: 6px; }
        .field-textarea {
            width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0;
            border-radius: 10px; font-size: 0.85rem; font-family: inherit;
            resize: none; min-height: 55px; transition: border-color 0.2s; line-height: 1.4;
        }
        .field-textarea:focus { outline: none; border-color: #4b6ee6; }

        /* === MATIERES === */
        .matieres-setup p { font-size: 0.82rem; color: #636e72; margin-bottom: 10px; }
        .matieres-input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .matieres-input {
            flex: 1; padding: 8px 12px; border: 2px solid #e2e8f0;
            border-radius: 10px; font-size: 0.85rem; font-family: inherit;
        }
        .matieres-input:focus { outline: none; border-color: #4b6ee6; }
        .btn-add-matiere {
            background: #4b6ee6; color: #fff; border: none; border-radius: 10px;
            padding: 8px 14px; font-size: 0.85rem; cursor: pointer;
            font-family: inherit; white-space: nowrap;
        }
        .btn-add-matiere:hover { background: #3b5bdb; }
        .matieres-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .matiere-tag {
            background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 20px;
            padding: 4px 10px; font-size: 0.78rem; color: #4338ca;
            display: flex; align-items: center; gap: 6px;
        }
        .matiere-tag .tag-remove { cursor: pointer; color: #94a3b8; font-weight: 700; font-size: 0.9rem; line-height: 1; }
        .matiere-tag .tag-remove:hover { color: #ef4444; }

        .matiere-bilan {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 0; border-bottom: 1px solid #f1f5f9;
        }
        .matiere-bilan:last-child { border-bottom: none; }
        .matiere-bilan .mb-name { flex: 1; font-size: 0.85rem; font-weight: 600; color: #334155; }
        .mb-btns { display: flex; gap: 4px; }
        .mb-btn {
            background: #f8f9fa; border: 2px solid transparent; border-radius: 8px;
            padding: 6px 10px; cursor: pointer; font-size: 1rem;
            transition: all 0.2s; font-family: inherit;
        }
        .mb-btn:hover { background: #eef2ff; }
        .mb-btn.sel-bien { border-color: #22c55e; background: #f0fdf4; }
        .mb-btn.sel-moyen { border-color: #f59e0b; background: #fffbeb; }
        .mb-btn.sel-difficile { border-color: #ef4444; background: #fef2f2; }

        /* === ENERGIE 3 JAUGES === */
        .energie-grid { display: flex; gap: 10px; margin-bottom: 14px; }
        .energie-item { flex: 1; text-align: center; }
        .energie-item label { font-size: 0.75rem; color: #636e72; display: block; margin-bottom: 6px; }
        .energie-item .energie-emoji { font-size: 1.4rem; margin-bottom: 4px; }
        .energie-item input[type="range"] {
            width: 100%; -webkit-appearance: none; height: 8px;
            border-radius: 4px; background: #e2e8f0; outline: none;
            writing-mode: vertical-lr; direction: rtl;
            height: 80px; width: 8px;
        }
        .energie-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px;
            border-radius: 50%; background: #4b6ee6; cursor: pointer;
        }
        .energie-val { font-size: 0.85rem; font-weight: 700; margin-top: 4px; }

        /* === FORCES / BADGES === */
        .forces-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .force-btn {
            background: #f8f9fa; border: 2px solid transparent; border-radius: 10px;
            padding: 8px 12px; cursor: pointer; font-size: 0.78rem;
            transition: all 0.2s; font-family: inherit; color: #555;
        }
        .force-btn:hover { background: #eef2ff; }
        .force-btn.selected { border-color: #4b6ee6; background: #dbeafe; color: #1e40af; font-weight: 600; }

        /* === MOT DE LA SEMAINE === */
        .mot-input {
            width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0;
            border-radius: 10px; font-size: 1rem; font-family: inherit;
            text-align: center; font-weight: 600; transition: border-color 0.2s;
        }
        .mot-input:focus { outline: none; border-color: #4b6ee6; }
        .mot-nuage {
            display: none; flex-wrap: wrap; gap: 6px; justify-content: center;
            margin-top: 12px; padding: 12px; background: #f8f9fa;
            border-radius: 10px;
        }
        .mot-nuage.visible { display: flex; }
        .mot-tag { padding: 3px 10px; border-radius: 20px; background: #eef2ff; color: #4338ca; }

        /* === OBJECTIF === */
        .objectif-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px; padding: 16px; color: #fff;
        }
        .objectif-box label { font-size: 0.85rem; color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px; }
        .objectif-textarea {
            width: 100%; padding: 10px 12px; border: none; border-radius: 10px;
            font-size: 0.85rem; font-family: inherit; resize: none;
            min-height: 50px; background: rgba(255,255,255,0.95); color: #333;
        }
        .objectif-textarea:focus { outline: 2px solid rgba(255,255,255,0.5); }

        /* === BOUTON ENREGISTRER === */
        .btn-save {
            width: 100%; padding: 14px; background: #22c55e; color: #fff;
            border: none; border-radius: 12px; font-size: 1rem; font-weight: 700;
            cursor: pointer; font-family: inherit; margin-top: 12px;
            transition: background 0.2s;
        }
        .btn-save:hover { background: #16a34a; }
        .save-confirm { display: none; text-align: center; padding: 16px; animation: fadeIn 0.3s ease; }
        .save-confirm.visible { display: block; }
        .save-confirm .check { font-size: 2.5rem; margin-bottom: 8px; }

        /* === HISTORIQUE === */
        .journal-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .journal-title h2 { margin-bottom: 0; }
        .btn-clear {
            background: none; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 6px 10px; font-size: 0.72rem; color: #94a3b8;
            cursor: pointer; font-family: inherit;
        }
        .btn-clear:hover { border-color: #ef4444; color: #ef4444; }
        .journal-empty { text-align: center; padding: 20px; color: #94a3b8; font-size: 0.85rem; }

        .hist-entry { padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .hist-entry:last-child { border-bottom: none; }
        .hist-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .hist-date { font-size: 0.72rem; color: #94a3b8; }
        .hist-humeur { font-size: 1.2rem; }
        .hist-motivation {
            flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;
        }
        .hist-motivation-fill { height: 100%; border-radius: 3px; }
        .hist-matieres { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
        .hist-mat-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 8px; border: 1px solid; }
        .hist-mat-bien { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .hist-mat-moyen { background: #fffbeb; border-color: #fde68a; color: #92400e; }
        .hist-mat-difficile { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
        .hist-energie { display: flex; gap: 8px; margin-top: 4px; font-size: 0.7rem; color: #636e72; }
        .hist-objectif { font-size: 0.75rem; color: #555; margin-top: 4px; font-style: italic; }
        .hist-objectif-result { font-style: normal; font-weight: 600; }
        .hist-mot { font-size: 0.78rem; color: #4338ca; font-weight: 600; margin-top: 4px; }
        .hist-forces { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
        .hist-force-tag { font-size: 0.62rem; padding: 2px 6px; border-radius: 8px; background: #dbeafe; color: #1e40af; }

        .btn-new {
            width: 100%; padding: 12px; background: #4b6ee6; color: #fff;
            border: none; border-radius: 12px; font-size: 0.9rem;
            font-weight: 600; cursor: pointer; margin-top: 12px; font-family: inherit;
        }
        .btn-new:hover { background: #3b5bdb; }

        .footer { text-align: center; padding: 20px 0 10px; font-size: 0.7rem; color: #b0b8c1; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 400px) {
            .humeur-btn { padding: 8px 4px; }
            .humeur-btn .humeur-emoji { font-size: 1.5rem; }
            .card { padding: 16px; }
            .mb-btn { padding: 5px 7px; font-size: 0.9rem; }
            .energie-item input[type="range"] { height: 60px; }
        }
    </style>
</head>
<body>
<div class="container">

    <div class="font-controls">
        <button class="font-btn" type="button" onclick="changeSize(-1)">A-</button>
        <button class="font-btn" type="button" onclick="changeSize(1)">A+</button>
    </div>

    <div class="header">
        <h1>üìã Mon bilan de la semaine</h1>
        <p>Prends quelques minutes pour faire le point. Tout reste sur ton telephone, personne d'autre ne verra tes reponses.</p>
    </div>

    <!-- STREAK / BADGES -->
    <div class="streak-bar" id="streak-bar">
        <div class="streak-num" id="streak-num">0</div>
        <div class="streak-label" id="streak-label">semaines consecutives</div>
        <div class="streak-badges" id="streak-badges"></div>
    </div>

    <!-- DASHBOARD (visible si bilans existants) -->
    <div class="card dashboard" id="dashboard">
        <div class="dash-title">üìä Mon evolution</div>
        <div class="graph-container">
            <div class="graph-row" id="graph-humeur"></div>
        </div>
        <div class="dash-title" style="margin-top:8px;">üìö Mes matieres (derniere semaine)</div>
        <div class="dash-matieres" id="dash-matieres"></div>
    </div>

    <!-- RAPPEL OBJECTIF PRECEDENT -->
    <div class="objectif-rappel" id="objectif-rappel">
        <div class="rappel-title">üéØ La semaine derniere, tu voulais :</div>
        <div class="rappel-text" id="rappel-text"></div>
        <div class="rappel-btns">
            <button class="rappel-btn" onclick="selectRappel(this,'oui')">‚úÖ Reussi</button>
            <button class="rappel-btn" onclick="selectRappel(this,'partiel')">üîÑ En partie</button>
            <button class="rappel-btn" onclick="selectRappel(this,'non')">‚ùå Pas encore</button>
        </div>
    </div>

    <!-- SECTION 1 ‚Äî HUMEUR -->
    <div class="card" id="card-humeur">
        <h2><span class="step-num">1</span> Mon humeur et ma motivation</h2>
        <div class="humeur-row" id="humeur-row">
            <button class="humeur-btn" onclick="selectHumeur(this,'super','üòÑ')"><span class="humeur-emoji">üòÑ</span>Super</button>
            <button class="humeur-btn" onclick="selectHumeur(this,'bien','üôÇ')"><span class="humeur-emoji">üôÇ</span>Bien</button>
            <button class="humeur-btn" onclick="selectHumeur(this,'moyen','üòê')"><span class="humeur-emoji">üòê</span>Moyen</button>
            <button class="humeur-btn" onclick="selectHumeur(this,'difficile','üòî')"><span class="humeur-emoji">üòî</span>Difficile</button>
            <button class="humeur-btn" onclick="selectHumeur(this,'tres-difficile','üòû')"><span class="humeur-emoji">üòû</span>Dur</button>
        </div>
        <div class="slider-section">
            <label>Ma motivation</label>
            <div class="slider-row">
                <input type="range" id="motivation-range" min="0" max="10" value="5" oninput="updateSliderColor(this,'motivation-val')">
                <span class="slider-val" id="motivation-val" style="color:#f59e0b;">5</span>
            </div>
            <div class="slider-labels"><span>Tres faible</span><span>Tres forte</span></div>
        </div>
        <div class="field-group">
            <label>‚ú® Le moment fort de ma semaine</label>
            <textarea class="field-textarea" id="moment-fort" placeholder="Une reussite, un bon moment..."></textarea>
        </div>
        <div class="field-group">
            <label>‚ö° Ce qui a ete difficile</label>
            <textarea class="field-textarea" id="moment-difficile" placeholder="Un probleme, un moment complique..."></textarea>
        </div>
    </div>

    <!-- SECTION 2 ‚Äî MATIERES -->
    <div class="card" id="card-matieres">
        <h2><span class="step-num">2</span> Mes matieres</h2>
        <div id="matieres-setup">
            <p>Ajoute tes matieres (elles seront memorisees) :</p>
            <div class="matieres-input-row">
                <input type="text" class="matieres-input" id="matiere-input" placeholder="Ex: Francais, Maths, PSE..." onkeydown="if(event.key==='Enter'){event.preventDefault();ajouterMatiere();}">
                <button class="btn-add-matiere" onclick="ajouterMatiere()">+ Ajouter</button>
            </div>
            <div class="matieres-tags" id="matieres-tags"></div>
        </div>
        <div id="matieres-bilan"></div>
        <div class="field-group" style="margin-top:12px;">
            <label>üí¨ Un commentaire ? (facultatif)</label>
            <textarea class="field-textarea" id="commentaire-matiere" placeholder="J'ai progresse en..., j'ai du mal en..."></textarea>
        </div>
    </div>

    <!-- SECTION 3 ‚Äî ENERGIE -->
    <div class="card" id="card-energie">
        <h2><span class="step-num">3</span> Mon energie cette semaine</h2>
        <div class="energie-grid">
            <div class="energie-item">
                <div class="energie-emoji">üèÉ</div>
                <label>Physique</label>
                <input type="range" id="energie-physique" min="0" max="10" value="5" oninput="updateEnergieVal('physique', this.value)">
                <div class="energie-val" id="energie-physique-val" style="color:#f59e0b;">5</div>
            </div>
            <div class="energie-item">
                <div class="energie-emoji">üß†</div>
                <label>Mentale</label>
                <input type="range" id="energie-mentale" min="0" max="10" value="5" oninput="updateEnergieVal('mentale', this.value)">
                <div class="energie-val" id="energie-mentale-val" style="color:#f59e0b;">5</div>
            </div>
            <div class="energie-item">
                <div class="energie-emoji">üë•</div>
                <label>Sociale</label>
                <input type="range" id="energie-sociale" min="0" max="10" value="5" oninput="updateEnergieVal('sociale', this.value)">
                <div class="energie-val" id="energie-sociale-val" style="color:#f59e0b;">5</div>
            </div>
        </div>
    </div>

    <!-- SECTION 4 ‚Äî FORCES -->
    <div class="card" id="card-forces">
        <h2><span class="step-num">4</span> Mes forces cette semaine</h2>
        <p style="font-size:0.82rem; color:#636e72; margin-bottom:10px;">Coche tout ce que tu as reussi a faire :</p>
        <div class="forces-grid" id="forces-grid">
            <button class="force-btn" onclick="toggleForce(this)">‚è∞ Ponctuel(e)</button>
            <button class="force-btn" onclick="toggleForce(this)">üôã J'ai participe</button>
            <button class="force-btn" onclick="toggleForce(this)">ü§ù J'ai aide quelqu'un</button>
            <button class="force-btn" onclick="toggleForce(this)">üìù Devoirs faits</button>
            <button class="force-btn" onclick="toggleForce(this)">üßò Reste calme</button>
            <button class="force-btn" onclick="toggleForce(this)">üéØ Concentre(e)</button>
            <button class="force-btn" onclick="toggleForce(this)">üìñ J'ai revise</button>
            <button class="force-btn" onclick="toggleForce(this)">üí™ J'ai persevere</button>
            <button class="force-btn" onclick="toggleForce(this)">üó£Ô∏è J'ai ose parler</button>
            <button class="force-btn" onclick="toggleForce(this)">üéí Materiel pret</button>
        </div>
    </div>

    <!-- SECTION 5 ‚Äî MOT + OBJECTIF -->
    <div class="card" id="card-objectif">
        <h2><span class="step-num">5</span> Pour finir</h2>

        <div class="field-group">
            <label>üí¨ Un mot qui resume ma semaine</label>
            <input type="text" class="mot-input" id="mot-semaine" placeholder="Ex: fatigue, fierte, stress, progres..." maxlength="30">
        </div>
        <div class="mot-nuage" id="mot-nuage"></div>

        <div class="objectif-box" style="margin-top:14px;">
            <label>üéØ La semaine prochaine, je veux...</label>
            <textarea class="objectif-textarea" id="objectif" placeholder="Un objectif concret..."></textarea>
        </div>

        <button class="btn-save" id="btn-save" onclick="enregistrerBilan()">‚úÖ Enregistrer mon bilan</button>
        <div class="save-confirm" id="save-confirm">
            <div class="check">‚úÖ</div>
            <p style="font-size:0.9rem; color:#636e72;">Bilan enregistre !</p>
        </div>
    </div>

    <!-- HISTORIQUE -->
    <div class="card" id="card-journal">
        <div class="journal-title">
            <h2>üìî Historique</h2>
            <button class="btn-clear" id="btn-clear" onclick="effacerJournal()">üóëÔ∏è Effacer</button>
        </div>
        <div id="journal-content"><div class="journal-empty">Aucun bilan pour le moment.</div></div>
        <button class="btn-new" id="btn-new" onclick="nouveauBilan()" style="display:none;">üìã Nouveau bilan</button>
    </div>

    <div class="footer">Mon bilan de la semaine</div>
</div>

<script>
// =============================================
// CONSTANTES
// =============================================
var STORAGE_MATIERES = 'bilan_semaine_matieres';
var STORAGE_JOURNAL = 'bilan_semaine_journal';
var HUMEUR_SCORES = { 'super': 5, 'bien': 4, 'moyen': 3, 'difficile': 2, 'tres-difficile': 1 };
var HUMEUR_EMOJIS_MAP = { 'super': 'üòÑ', 'bien': 'üôÇ', 'moyen': 'üòê', 'difficile': 'üòî', 'tres-difficile': 'üòû' };
var BADGES = [
    { id: 'first', label: 'üå± Premier bilan', condition: function(j){ return j.length >= 1; } },
    { id: 'streak3', label: 'üî• 3 semaines', condition: function(j){ return getStreak(j) >= 3; } },
    { id: 'streak5', label: '‚≠ê 5 semaines', condition: function(j){ return getStreak(j) >= 5; } },
    { id: 'streak10', label: 'üèÜ 10 semaines', condition: function(j){ return getStreak(j) >= 10; } },
    { id: 'obj3', label: 'üéØ 3 objectifs reussis', condition: function(j){ return countObjectifsReussis(j) >= 3; } },
    { id: 'obj10', label: 'üíé 10 objectifs reussis', condition: function(j){ return countObjectifsReussis(j) >= 10; } }
];

// =============================================
// ETAT
// =============================================
var state = {
    humeur: null, humeurEmoji: null, motivation: 5,
    matieresBilan: {},
    energiePhysique: 5, energieMentale: 5, energieSociale: 5,
    forces: [],
    rappelObjectif: null
};
var matieres = [];

// =============================================
// FONT
// =============================================
var currentSize = 16;
function changeSize(d) {
    currentSize += d;
    if (currentSize < 12) currentSize = 12;
    if (currentSize > 24) currentSize = 24;
    document.documentElement.style.fontSize = currentSize + 'px';
}

// =============================================
// HUMEUR
// =============================================
function selectHumeur(el, val, emoji) {
    document.querySelectorAll('.humeur-btn').forEach(function(b){ b.classList.remove('selected'); });
    el.classList.add('selected');
    state.humeur = val;
    state.humeurEmoji = emoji;
}

function updateSliderColor(input, valId) {
    var val = parseInt(input.value);
    var display = document.getElementById(valId);
    display.textContent = val;
    display.style.color = val <= 3 ? '#ef4444' : (val <= 6 ? '#f59e0b' : '#22c55e');
    if (valId === 'motivation-val') state.motivation = val;
}

// =============================================
// MATIERES
// =============================================
function chargerMatieres() {
    try { matieres = JSON.parse(localStorage.getItem(STORAGE_MATIERES)) || []; } catch(e) { matieres = []; }
    renderMatiereTags();
    renderMatiereBilan();
}

function ajouterMatiere() {
    var input = document.getElementById('matiere-input');
    var nom = input.value.trim();
    if (!nom || matieres.indexOf(nom) > -1) { input.value = ''; return; }
    matieres.push(nom);
    localStorage.setItem(STORAGE_MATIERES, JSON.stringify(matieres));
    input.value = '';
    renderMatiereTags();
    renderMatiereBilan();
}

function supprimerMatiere(idx) {
    delete state.matieresBilan[matieres[idx]];
    matieres.splice(idx, 1);
    localStorage.setItem(STORAGE_MATIERES, JSON.stringify(matieres));
    renderMatiereTags();
    renderMatiereBilan();
}

function renderMatiereTags() {
    var c = document.getElementById('matieres-tags');
    c.innerHTML = matieres.map(function(m, i) {
        return '<span class="matiere-tag">' + esc(m) + ' <span class="tag-remove" onclick="supprimerMatiere(' + i + ')">√ó</span></span>';
    }).join('');
}

function renderMatiereBilan() {
    var c = document.getElementById('matieres-bilan');
    if (!matieres.length) { c.innerHTML = ''; return; }
    c.innerHTML = matieres.map(function(m) {
        var cur = state.matieresBilan[m] || '';
        return '<div class="matiere-bilan"><span class="mb-name">' + esc(m) + '</span><div class="mb-btns">'
            + '<button class="mb-btn' + (cur==='bien'?' sel-bien':'') + '" onclick="selMat(this,\'' + escA(m) + '\',\'bien\')">üòä</button>'
            + '<button class="mb-btn' + (cur==='moyen'?' sel-moyen':'') + '" onclick="selMat(this,\'' + escA(m) + '\',\'moyen\')">üòê</button>'
            + '<button class="mb-btn' + (cur==='difficile'?' sel-difficile':'') + '" onclick="selMat(this,\'' + escA(m) + '\',\'difficile\')">üòü</button>'
            + '</div></div>';
    }).join('');
}

function selMat(el, m, n) {
    state.matieresBilan[m] = (state.matieresBilan[m] === n) ? null : n;
    if (!state.matieresBilan[m]) delete state.matieresBilan[m];
    renderMatiereBilan();
}

// =============================================
// ENERGIE
// =============================================
function updateEnergieVal(type, val) {
    val = parseInt(val);
    var display = document.getElementById('energie-' + type + '-val');
    display.textContent = val;
    display.style.color = val <= 3 ? '#ef4444' : (val <= 6 ? '#f59e0b' : '#22c55e');
    if (type === 'physique') state.energiePhysique = val;
    else if (type === 'mentale') state.energieMentale = val;
    else state.energieSociale = val;
}

// =============================================
// FORCES
// =============================================
function toggleForce(el) {
    el.classList.toggle('selected');
    var txt = el.textContent.trim();
    var idx = state.forces.indexOf(txt);
    if (idx > -1) state.forces.splice(idx, 1);
    else state.forces.push(txt);
}

// =============================================
// RAPPEL OBJECTIF
// =============================================
function selectRappel(el, val) {
    document.querySelectorAll('.rappel-btn').forEach(function(b){ b.className = 'rappel-btn'; });
    el.classList.add('selected-' + val);
    state.rappelObjectif = val;
}

function showRappelObjectif() {
    var journal = getJournal();
    if (journal.length === 0) return;
    var last = journal[0];
    if (!last.objectif) return;
    document.getElementById('rappel-text').textContent = '"' + last.objectif + '"';
    document.getElementById('objectif-rappel').classList.add('visible');
}

// =============================================
// DASHBOARD
// =============================================
function renderDashboard() {
    var journal = getJournal();
    if (journal.length < 1) return;

    // Streak
    var streak = getStreak(journal);
    if (streak > 0) {
        document.getElementById('streak-num').textContent = streak;
        document.getElementById('streak-label').textContent = streak === 1 ? 'semaine' : 'semaines consecutives';
        // Badges
        var badgesHtml = BADGES.map(function(b) {
            var unlocked = b.condition(journal);
            return '<span class="streak-badge' + (unlocked ? '' : ' locked') + '">' + b.label + '</span>';
        }).join('');
        document.getElementById('streak-badges').innerHTML = badgesHtml;
        document.getElementById('streak-bar').classList.add('visible');
    }

    // Graph humeur (6 derniers)
    var recent = journal.slice(0, 6).reverse();
    var graphHtml = recent.map(function(e) {
        var score = HUMEUR_SCORES[e.humeur] || 3;
        var h = (score / 5) * 60;
        var colors = ['', '#ef4444', '#f97316', '#f59e0b', '#22c55e', '#10b981'];
        return '<div class="graph-col">'
            + '<div class="graph-emoji">' + (e.humeurEmoji || 'üòê') + '</div>'
            + '<div class="graph-bar-wrap" style="height:60px;display:flex;align-items:flex-end;">'
            + '<div class="graph-bar" style="height:' + h + 'px;background:' + colors[score] + ';"></div></div>'
            + '<div class="graph-label">' + (e.semaine || '') + '</div></div>';
    }).join('');
    document.getElementById('graph-humeur').innerHTML = graphHtml;

    // Matieres derniere semaine
    var lastMats = journal[0].matieres || {};
    var matKeys = Object.keys(lastMats);
    if (matKeys.length) {
        document.getElementById('dash-matieres').innerHTML = matKeys.map(function(m) {
            var emoji = lastMats[m] === 'bien' ? 'üòä' : (lastMats[m] === 'moyen' ? 'üòê' : 'üòü');
            return '<span class="dash-mat dash-mat-' + lastMats[m] + '">' + emoji + ' ' + esc(m) + '</span>';
        }).join('');
    }

    document.getElementById('dashboard').classList.add('visible');
}

// =============================================
// MOT NUAGE
// =============================================
function renderMotNuage() {
    var journal = getJournal();
    var mots = [];
    journal.forEach(function(e) { if (e.motSemaine) mots.push(e.motSemaine); });
    if (mots.length < 2) return;
    var container = document.getElementById('mot-nuage');
    // Tailles variables basees sur la frequence
    var freq = {};
    mots.forEach(function(m) { var k = m.toLowerCase(); freq[k] = (freq[k] || 0) + 1; });
    var html = Object.keys(freq).map(function(m) {
        var size = 0.7 + (freq[m] * 0.15);
        if (size > 1.3) size = 1.3;
        return '<span class="mot-tag" style="font-size:' + size + 'rem;">' + esc(m) + '</span>';
    }).join('');
    container.innerHTML = html;
    container.classList.add('visible');
}

// =============================================
// ENREGISTRER
// =============================================
function enregistrerBilan() {
    if (!state.humeur) { alert('Choisis ton humeur !'); return; }

    var entry = {
        semaine: getDateSemaine(),
        humeur: state.humeur,
        humeurEmoji: state.humeurEmoji,
        motivation: state.motivation,
        momentFort: document.getElementById('moment-fort').value.trim(),
        momentDifficile: document.getElementById('moment-difficile').value.trim(),
        matieres: JSON.parse(JSON.stringify(state.matieresBilan)),
        commentaireMatiere: document.getElementById('commentaire-matiere').value.trim(),
        energiePhysique: state.energiePhysique,
        energieMentale: state.energieMentale,
        energieSociale: state.energieSociale,
        forces: state.forces.slice(),
        motSemaine: document.getElementById('mot-semaine').value.trim(),
        objectif: document.getElementById('objectif').value.trim(),
        rappelObjectif: state.rappelObjectif,
        timestamp: Date.now()
    };

    var journal = getJournal();
    journal.unshift(entry);
    if (journal.length > 30) journal = journal.slice(0, 30);
    localStorage.setItem(STORAGE_JOURNAL, JSON.stringify(journal));

    document.getElementById('btn-save').style.display = 'none';
    document.getElementById('save-confirm').classList.add('visible');
    document.getElementById('btn-new').style.display = 'block';

    renderJournal();
    renderDashboard();
    renderMotNuage();
}

// =============================================
// JOURNAL / HISTORIQUE
// =============================================
function renderJournal() {
    var journal = getJournal();
    var c = document.getElementById('journal-content');
    var btnClear = document.getElementById('btn-clear');
    if (!journal.length) {
        c.innerHTML = '<div class="journal-empty">Aucun bilan pour le moment.</div>';
        btnClear.style.display = 'none'; return;
    }
    btnClear.style.display = 'block';
    var html = '';
    journal.slice(0, 6).forEach(function(e) {
        var motColor = e.motivation <= 3 ? '#ef4444' : (e.motivation <= 6 ? '#f59e0b' : '#22c55e');
        var motW = (e.motivation / 10) * 100;
        html += '<div class="hist-entry"><div class="hist-header">'
            + '<span class="hist-date">Sem. ' + e.semaine + '</span>'
            + '<span class="hist-humeur">' + (e.humeurEmoji || 'üòê') + '</span>'
            + '<div class="hist-motivation"><div class="hist-motivation-fill" style="width:' + motW + '%;background:' + motColor + ';"></div></div></div>';

        // Matieres
        var mats = e.matieres || {};
        var mk = Object.keys(mats);
        if (mk.length) {
            html += '<div class="hist-matieres">' + mk.map(function(m) {
                var em = mats[m]==='bien'?'üòä':(mats[m]==='moyen'?'üòê':'üòü');
                return '<span class="hist-mat-tag hist-mat-' + mats[m] + '">' + em + ' ' + esc(m) + '</span>';
            }).join('') + '</div>';
        }

        // Energie
        if (e.energiePhysique !== undefined) {
            html += '<div class="hist-energie">üèÉ ' + e.energiePhysique + ' | üß† ' + e.energieMentale + ' | üë• ' + e.energieSociale + '</div>';
        }

        // Forces
        if (e.forces && e.forces.length) {
            html += '<div class="hist-forces">' + e.forces.map(function(f) {
                return '<span class="hist-force-tag">' + esc(f) + '</span>';
            }).join('') + '</div>';
        }

        // Mot
        if (e.motSemaine) html += '<div class="hist-mot">üí¨ "' + esc(e.motSemaine) + '"</div>';

        // Objectif + resultat
        if (e.objectif) {
            var res = '';
            if (e.rappelObjectif === 'oui') res = ' <span class="hist-objectif-result" style="color:#22c55e;">‚úÖ</span>';
            else if (e.rappelObjectif === 'partiel') res = ' <span class="hist-objectif-result" style="color:#f59e0b;">üîÑ</span>';
            else if (e.rappelObjectif === 'non') res = ' <span class="hist-objectif-result" style="color:#ef4444;">‚ùå</span>';
            html += '<div class="hist-objectif">üéØ ' + esc(e.objectif) + res + '</div>';
        }
        html += '</div>';
    });
    if (journal.length > 6) html += '<p style="text-align:center;font-size:0.72rem;color:#94a3b8;margin-top:8px;">+ ' + (journal.length-6) + ' bilans precedents</p>';
    c.innerHTML = html;
}

function effacerJournal() {
    if (!confirm('Effacer tout ton historique ?')) return;
    localStorage.removeItem(STORAGE_JOURNAL);
    renderJournal();
    document.getElementById('dashboard').classList.remove('visible');
    document.getElementById('streak-bar').classList.remove('visible');
    document.getElementById('objectif-rappel').classList.remove('visible');
    document.getElementById('mot-nuage').classList.remove('visible');
}

function nouveauBilan() {
    state = { humeur:null, humeurEmoji:null, motivation:5, matieresBilan:{}, energiePhysique:5, energieMentale:5, energieSociale:5, forces:[], rappelObjectif:null };
    document.querySelectorAll('.humeur-btn,.force-btn').forEach(function(b){ b.classList.remove('selected'); });
    document.getElementById('motivation-range').value = 5;
    updateSliderColor(document.getElementById('motivation-range'), 'motivation-val');
    ['energie-physique','energie-mentale','energie-sociale'].forEach(function(id){
        document.getElementById(id).value = 5;
        updateEnergieVal(id.replace('energie-',''), 5);
    });
    ['moment-fort','moment-difficile','commentaire-matiere','objectif'].forEach(function(id){ document.getElementById(id).value = ''; });
    document.getElementById('mot-semaine').value = '';
    document.getElementById('btn-save').style.display = 'block';
    document.getElementById('save-confirm').classList.remove('visible');
    renderMatiereBilan();
    showRappelObjectif();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// =============================================
// UTILS
// =============================================
function esc(s) { var d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }
function escA(s) { return (s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }
function getJournal() { try { return JSON.parse(localStorage.getItem(STORAGE_JOURNAL)) || []; } catch(e) { return []; } }

function getDateSemaine() {
    var n = new Date();
    var d = n.getDay();
    var diff = n.getDate() - d + (d === 0 ? -6 : 1);
    var lundi = new Date(n.getFullYear(), n.getMonth(), diff);
    return lundi.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
}

function getStreak(journal) {
    if (!journal.length) return 0;
    var streak = 1;
    for (var i = 1; i < journal.length; i++) {
        var diff = journal[i-1].timestamp - journal[i].timestamp;
        // Si moins de 10 jours entre 2 bilans, on considere que c'est consecutif
        if (diff < 10 * 24 * 60 * 60 * 1000) streak++;
        else break;
    }
    return streak;
}

function countObjectifsReussis(journal) {
    var count = 0;
    journal.forEach(function(e) { if (e.rappelObjectif === 'oui') count++; });
    return count;
}

// =============================================
// INIT
// =============================================
chargerMatieres();
renderJournal();
renderDashboard();
showRappelObjectif();
renderMotNuage();

// Auto-resize textareas
document.querySelectorAll('textarea').forEach(function(ta) {
    ta.addEventListener('input', function() {
        ta.style.height = 'auto';
        ta.style.height = (ta.scrollHeight + 2) + 'px';
    });
});
</script>
</body>
</html>
