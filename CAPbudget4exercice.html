<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Budget de Mat√©o - Tr√©sorerie et Dette</title>
    <style>
        /* Styles de base conserv√©s */
        :root {
            --recettes-color: #d4edda;
            --recettes-border: #28a745;
            --fixe-color: #cce5ff;
            --fixe-border: #007bff;
            --courant-color: #fff3cd;
            --courant-border: #ffc107;
            --occas-color: #f8d7da;
            --occas-border: #dc3545;
            --epargne-color: #e6e0ff;
            --epargne-border: #6f42c1;
            
            --recette-travail: #a2d9c2;
            --recette-social: #7fc3af;
            --recette-autre: #55aa99;

            --bg-color: #f9f9f9;
            --text-color: #333;
            /* Couleur pour les √©l√©ments de tr√©sorerie/dette */
            --tresorerie-color: #ff9999; 
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: #2c3e50; margin-bottom: 10px; }

        .legend-bar {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            background: #fff;
            padding: 8px 15px;
            border-radius: 50px;
            border: 1px solid #ddd;
        }
        
        .context-box {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 1.15rem;
            position: relative;
        }

        .audio-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: background 0.2s;
        }

        #item-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            background: white;
            padding: 15px;
            border-radius: 10px;
            min-height: 80px;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 20px;
            border: 2px dashed #ccc;
        }

        .draggable-item {
            padding: 10px 20px;
            background-color: white;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: grab;
            user-select: none;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, background-color 0.2s;
        }

        /* Le Tableau - 5 colonnes */
        .budget-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            gap: 10px; 
            width: 100%;
            max-width: 1200px;
        }

        .column {
            background: white;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 400px;
            border-top: 6px solid #ccc;
        }

        .column h3 {
            text-align: center;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
        }
        
        /* Conteneur sp√©cial pour les Recettes (identique) */
        #col-recettes { 
            border-top-color: var(--recettes-border); 
            display: grid;
            grid-template-rows: auto 1fr auto;
        }

        .recette-sub-zones {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }

        .sub-zone {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            min-height: 80px;
        }
        .sub-zone h4 {
            font-size: 0.9rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 0 0 5px 0;
            padding-bottom: 3px;
            border-bottom: 1px dashed #fff;
        }

        .sub-zone[data-category="recette-travail"] { background-color: var(--recette-travail); }
        .sub-zone[data-category="recette-social"] { background-color: var(--recette-social); }
        .sub-zone[data-category="recette-autre"] { background-color: var(--recette-autre); }

        .drop-zone {
            flex-grow: 1;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.02);
            transition: background 0.3s;
            min-height: 80px;
        }

        /* Couleurs des D√©penses (identique) */
        #col-fixes { border-top-color: var(--fixe-border); }
        #col-fixes .drop-zone { background-color: var(--fixe-color); }

        #col-courantes { border-top-color: var(--courant-border); }
        #col-courantes .drop-zone { background-color: var(--courant-color); }

        #col-occas { border-top-color: var(--occas-border); }
        #col-occas .drop-zone { background-color: var(--occas-color); }

        #col-epargne { border-top-color: var(--epargne-border); }
        #col-epargne .drop-zone { background-color: var(--epargne-color); }

        /* Zones de calcul et Synth√®se */
        .calc-zone {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #eee;
            text-align: center;
        }
        
        input[type="number"] {
            width: 90px;
            padding: 8px;
            font-size: 1.1rem;
            border: 2px solid #ccc;
            border-radius: 5px;
            text-align: right;
            margin-bottom: 5px;
        }

        .verify-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 5px;
        }
        
        .feedback-msg {
            display: block;
            font-size: 0.95rem;
            margin-top: 8px;
            font-weight: bold;
            min-height: 1.2em;
        }

        .correct { color: #28a745; }
        .incorrect { color: #dc3545; }

        .final-synthesis {
            margin-top: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            border-left: 10px solid #dc3545; /* Rouge pour l'alerte tr√©sorerie */
        }

        .synthesis-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .synthesis-row.tr√©sorerie-alerte {
            font-weight: bold; 
            font-size: 1.4rem; 
            color: #dc3545;
        }
        
        /* Ajustements Responsive */
        @media (max-width: 1200px) {
            .budget-container { grid-template-columns: repeat(3, 1fr); } 
            #col-recettes { grid-column: span 3; }
        }
        @media (max-width: 900px) {
            .budget-container { grid-template-columns: 1fr 1fr; } 
            #col-recettes { grid-column: span 2; }
        }

    </style>
</head>
<body>

    <h1>üí∞ Le Budget de Mat√©o - Le Vrai Bilan de Tr√©sorerie</h1>

    <div class="legend-bar">
        <span>Objectif : Calculer le solde de tr√©sorerie. Attention aux op√©rations non encore encaiss√©es/d√©caiss√©es.</span>
    </div>

    <div class="context-box">
        <button id="main-audio-btn" class="audio-btn" onclick="toggleAudio()">
            <span>‚ñ∂Ô∏è Lire l'histoire</span>
        </button>
        
        <div id="text-content">
            Mat√©o a deux emplois √† temps partiel. Il a re√ßu ce mois-ci son **salaire du premier emploi (1 100 ‚Ç¨)**. Son **salaire du second emploi (700 ‚Ç¨)** sera encaiss√© seulement le mois prochain.<br>
            
            Il a vendu une partie de sa collection de bandes dessin√©es pour **250 ‚Ç¨**, encaiss√©s imm√©diatement.<br><br>
            
            Ses charges fixes : Loyer (600 ‚Ç¨), Assurance (60 ‚Ç¨), Pr√™t Personnel (150 ‚Ç¨), Abonnements (30 ‚Ç¨).<br>
            
            Ses d√©penses courantes : Courses alimentaires (280 ‚Ç¨), Transport/Essence (110 ‚Ç¨).<br><br>
            
            Ce mois-ci, il a fait de grosses d√©penses :
            * Achat d'un v√©lo √©lectrique √† cr√©dit (500 ‚Ç¨). **Le pr√©l√®vement de ce mois est de 0 ‚Ç¨**.
            * Il a d√ª payer **50 ‚Ç¨** de **frais bancaires** (agios) car il a √©t√© √† d√©couvert au d√©but du mois.
            * Achat d'un billet de concert pay√© en esp√®ces : **70 ‚Ç¨**.<br>
            
            Enfin, pour pr√©parer ses √©tudes futures, il met **100 ‚Ç¨** dans un Plan √âpargne Logement (PEL) chaque mois.
        </div>
    </div>

    <div style="width:100%; max-width:1200px; text-align:left; margin-bottom:5px; font-size:1.1rem;">
        <strong>1. Classe les √©tiquettes selon leur nature (Recette, D√©pense, √âpargne). Attention √† la date d'encaissement/d√©caissement !</strong>
    </div>
    
    <div id="item-bank" ondrop="drop(event)" ondragover="allowDrop(event)">
    </div>

    <div class="budget-container">
        <div class="column" id="col-recettes">
            <h3>Recettes</h3>
            <div class="recette-sub-zones">
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-travail">
                    <h4>Travail (Salaire, Prime, Honoraires)</h4>
                </div>
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-social">
                    <h4>Social/√âtat (Aide, Remboursement)</h4>
                </div>
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-autre">
                    <h4>Autre (Vente, Cadeau, Non-Travail)</h4>
                </div>
            </div>
            <div class="calc-zone">
                <label>Total Recettes : </label>
                <input type="number" id="input-recettes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('recette', 'input-recettes', 'msg-recettes')">V√©rifier</button>
                <span id="msg-recettes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-fixes">
            <h3>D√©penses Fixes</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="fixe"></div>
            <div class="calc-zone">
                <label>Total : </label>
                <input type="number" id="input-fixes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('fixe', 'input-fixes', 'msg-fixes')">V√©rifier</button>
                <span id="msg-fixes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-courantes">
            <h3>D√©penses Courantes</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="courante"></div>
            <div class="calc-zone">
                <label>Total : </label>
                <input type="number" id="input-courantes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('courante', 'input-courantes', 'msg-courantes')">V√©rifier</button>
                <span id="msg-courantes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-occas">
            <h3>D√©penses Occas.</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="occas"></div>
            <div class="calc-zone">
                <label>Total : </label>
                <input type="number" id="input-occas" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('occas', 'input-occas', 'msg-occas')">V√©rifier</button>
                <span id="msg-occas" class="feedback-msg"></span>
            </div>
        </div>
        
        <div class="column" id="col-epargne">
            <h3>√âpargne/Transfert</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="epargne"></div>
            <div class="calc-zone">
                <label>Total : </label>
                <input type="number" id="input-epargne" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('epargne', 'input-epargne', 'msg-epargne')">V√©rifier</button>
                <span id="msg-epargne" class="feedback-msg"></span>
            </div>
        </div>
    </div>

    <div class="final-synthesis">
        <h2>üö® Le Bilan de Tr√©sorerie</h2>
        <p>Calcule le solde **R√âEL** sur le compte bancaire ce mois-ci. (Seules les op√©rations effectives).</p>
        
        <div class="synthesis-row">
            <span>Total des **Recettes EFFECTIVES** (Encaiss√©es ce mois) :</span>
            <input type="number" id="final-recettes-effectives" placeholder="..."> ‚Ç¨
        </div>
        <div class="synthesis-row">
            <span>Total des **D√©penses EFFECTIVES** (D√©caiss√©es ce mois) :</span>
            <input type="number" id="final-depenses-effectives" placeholder="..."> ‚Ç¨
        </div>
        <div class="synthesis-row">
            <span>Total des **Transferts/√âpargne** (D√©caiss√©s ce mois) :</span>
            <input type="number" id="final-epargne-effective" placeholder="..."> ‚Ç¨
        </div>
        <hr>
        <div class="synthesis-row tr√©sorerie-alerte">
            <span>SOLDE de Tr√©sorerie (R eff. - D eff. - E eff.) :</span>
            <input type="number" id="final-solde" placeholder="..."> ‚Ç¨
        </div>
        
        <div style="text-align: center; margin-top:10px;">
             <button class="verify-btn" onclick="verifierBilanMateo()" style="font-size:1.1rem; padding: 10px 20px;">V√©rifier le Solde</button>
             <div id="msg-bilan" class="feedback-msg" style="font-size:1.1rem; margin-top:10px;"></div>
        </div>

        <div class="result-options" id="budget-status" style="opacity: 0.3; pointer-events: none;">
            <p style="width:100%; text-align:center; margin-bottom:10px;">La situation de tr√©sorerie est : </p>
            <label>
                <input type="radio" name="budget" value="positive">
                <span>Positive (en s√©curit√©)</span>
            </label>
            <label>
                <input type="radio" name="budget" value="n√©gative">
                <span>N√©gative (√† d√©couvert)</span>
            </label>
            <label>
                <input type="radio" name="budget" value="√©quilibre">
                <span>√âquilibr√©e (proche de z√©ro)</span>
            </label>
        </div>
        <div style="text-align: center; margin-top:20px;">
            <button class="verify-btn" onclick="verifierConclusionMateo()" id="btn-conclusion" style="display:none; padding:10px 25px;">V√©rifier la r√©ponse</button>
             <div id="msg-conclusion" class="feedback-msg"></div>
        </div>
    </div>

    <script>
        // --- DONN√âES DE MAT√âO ---
        const items = [
            // Recettes
            { id: 1, name: "Salaire Emploi 1", val: 1100, cat: "recette-travail", globalCat: "recette", tresorerie: 1100 }, // Effective
            { id: 2, name: "Salaire Emploi 2 (√† encaisser le mois prochain)", val: 700, cat: "recette-travail", globalCat: "recette", tresorerie: 0 }, // Non effective
            { id: 3, name: "Vente BD (encaiss√©)", val: 250, cat: "recette-autre", globalCat: "recette", tresorerie: 250 }, // Effective
            
            // D√©penses
            { id: 4, name: "Loyer", val: 600, cat: "fixe", globalCat: "depense", tresorerie: -600 }, 
            { id: 5, name: "Assurance", val: 60, cat: "fixe", globalCat: "depense", tresorerie: -60 },
            { id: 6, name: "Pr√™t Personnel", val: 150, cat: "fixe", globalCat: "depense", tresorerie: -150 },
            { id: 7, name: "Abonnements", val: 30, cat: "fixe", globalCat: "depense", tresorerie: -30 },
            
            { id: 8, name: "Courses Alim.", val: 280, cat: "courante", globalCat: "depense", tresorerie: -280 },
            { id: 9, name: "Transport/Essence", val: 110, cat: "courante", globalCat: "depense", tresorerie: -110 },
            
            { id: 10, name: "Achat V√©lo √âlectrique (cr√©dit 0‚Ç¨ ce mois)", val: 500, cat: "occas", globalCat: "depense", tresorerie: 0 }, // D√©pense, mais tr√©sorerie 0 ce mois-ci
            { id: 11, name: "Frais Bancaires (Agios)", val: 50, cat: "occas", globalCat: "depense", tresorerie: -50 }, 
            { id: 12, name: "Billet de Concert (pay√© en esp√®ces)", val: 70, cat: "occas", globalCat: "depense", tresorerie: -70 }, // La sortie d'esp√®ce est une sortie de tr√©sorerie
            
            // √âpargne / Transfert
            { id: 13, name: "√âpargne PEL", val: 100, cat: "epargne", globalCat: "epargne", tresorerie: -100 }
        ];
        
        // --- CALCULS R√âELS ---
        
        // 1. Calcul du budget "th√©orique" (Somme de toutes les recettes/d√©penses, y compris Salaire 2 et Cr√©dit v√©lo)
        const totalRecettesTheoriques = items.filter(i => i.globalCat === 'recette').reduce((a, b) => a + b.val, 0); // 1100 + 700 + 250 = 2050
        const totalDepensesTheoriques = items.filter(i => i.globalCat === 'depense').reduce((a, b) => a + b.val, 0); // 600+60+150+30 + 280+110 + 500+50+70 = 1850
        const totalEpargneTheorique = items.filter(i => i.globalCat === 'epargne').reduce((a, b) => a + b.val, 0); // 100
        
        // 2. Calcul du solde de "Tr√©sorerie" (Ce qui est entr√©/sorti du compte ce mois)
        const totalRecettesEffectives = items.reduce((sum, item) => sum + (item.tresorerie > 0 ? item.tresorerie : 0), 0); // 1100 + 250 = 1350
        const totalDepensesEffectivesEtEpargne = items.reduce((sum, item) => sum + (item.tresorerie < 0 ? Math.abs(item.tresorerie) : 0), 0); // 600+60+150+30 + 280+110 + 50+70 + 100 = 1450

        const soldeReelTresorerie = totalRecettesEffectives - totalDepensesEffectivesEtEpargne; // 1350 - 1450 = -100

        // --- LOGIQUE G√âN√âRALE (Recyclage des fonctions pr√©c√©dentes) ---
        const bank = document.getElementById("item-bank");
        items.sort(() => Math.random() - 0.5); // M√©lange

        items.forEach(item => {
            let el = document.createElement("div");
            el.classList.add("draggable-item");
            el.setAttribute("draggable", "true");
            el.setAttribute("id", "item-" + item.id);
            el.setAttribute("data-val", item.val);
            el.setAttribute("data-cat", item.cat); 
            el.setAttribute("data-global-cat", item.globalCat); 
            el.setAttribute("data-tresorerie", item.tresorerie); // Nouvelle donn√©e pour le bilan
            el.innerText = `${item.name} (${item.val} ‚Ç¨)`;
            
            el.addEventListener("dragstart", drag);
            el.addEventListener("click", function() { selectItem(el); });
            bank.appendChild(el);
        });

        let selectedItem = null;

        function selectItem(el) {
            if(selectedItem) {
                selectedItem.style.backgroundColor = "white";
                selectedItem.style.borderColor = "#555";
            }
            if (selectedItem === el) {
                selectedItem = null;
                return;
            }
            selectedItem = el;
            el.style.backgroundColor = "#e2e6ea";
            el.style.borderColor = "#007bff";
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add("drag-over");
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            selectItem(ev.target);
        }

        function drop(ev) {
            ev.preventDefault();
            document.querySelectorAll('.drop-zone, .sub-zone, #item-bank').forEach(z => z.classList.remove('drag-over'));

            let data = ev.dataTransfer ? ev.dataTransfer.getData("text") : null;
            let draggedElement;

            if (data) draggedElement = document.getElementById(data);
            else if (selectedItem) draggedElement = selectedItem;
            else return;

            let target = ev.target;
            while (!target.classList.contains("drop-zone") && !target.classList.contains("sub-zone") && target.id !== "item-bank" && target.tagName !== "BODY") {
                target = target.parentElement;
            }

            if (target.classList.contains("drop-zone") || target.classList.contains("sub-zone") || target.id === "item-bank") {
                target.appendChild(draggedElement);
            }
            
            if(selectedItem) {
                selectedItem.style.backgroundColor = "white";
                selectedItem.style.borderColor = "#555";
                selectedItem = null;
            }
        }

        document.querySelectorAll('.drop-zone, .sub-zone, #item-bank').forEach(zone => {
            zone.addEventListener('click', function(e) {
                if (selectedItem && e.target !== selectedItem && !e.target.closest('.draggable-item')) {
                    zone.appendChild(selectedItem);
                    selectedItem.style.backgroundColor = "white";
                    selectedItem.style.borderColor = "#555";
                    selectedItem = null;
                }
            });
            zone.addEventListener('dragleave', function() { zone.classList.remove("drag-over"); });
        });


        // --- V√âRIFICATION LOGIQUE (Maintenue pour la classification) ---
        
        function verifierColonneGlobale(globalCatName, inputId, msgId) {
            let dropZones = [];
            
            if (globalCatName === 'recette') {
                dropZones = document.querySelectorAll(`.sub-zone[data-category^="recette-"]`);
            } else {
                dropZones = document.querySelectorAll(`.drop-zone[data-category="${globalCatName}"]`);
            }
            
            const input = document.getElementById(inputId);
            const msg = document.getElementById(msgId);
            
            let sumItems = 0;
            let errors = false;

            for (let zone of dropZones) {
                for (let item of zone.children) {
                    let itemVal = parseInt(item.getAttribute("data-val"));
                    let itemCat = item.getAttribute("data-cat"); 
                    let expectedCat = zone.getAttribute("data-category");
                    
                    if (globalCatName === 'recette' ? itemCat !== expectedCat : itemCat !== globalCatName) {
                        errors = true;
                        item.style.border = "3px solid #dc3545"; 
                        setTimeout(() => item.style.border = "2px solid #555", 3000);
                    } else {
                        sumItems += itemVal;
                        item.style.border = "2px solid #28a745"; 
                    }
                }
            }

            if (errors) {
                msg.innerHTML = "‚ö†Ô∏è Il y a une erreur de classification. Rev√©rifie la NATURE du poste (m√™me si non encaiss√©).";
                msg.className = "feedback-msg incorrect";
                return;
            }

            let userVal = parseInt(input.value);
            // Pour Mat√©o, le total est bas√© sur la valeur totale (y compris salaire non encaiss√©)
            let totalReelAttendu = items.filter(i => (globalCatName === 'recette' ? i.globalCat === 'recette' : i.cat === globalCatName)).reduce((a, b) => a + b.val, 0);

            if (isNaN(userVal)) {
                msg.innerHTML = "√âcris le total dans la case.";
                msg.className = "feedback-msg";
                return;
            }

            if (userVal === totalReelAttendu) {
                msg.innerHTML = "‚úÖ Classification et Total Th√©orique corrects.";
                msg.className = "feedback-msg correct";
                input.style.borderColor = "#28a745";
                input.style.backgroundColor = "#e8f5e9";
                input.disabled = true; 
                
                // Ici, on ne met PAS √† jour les totaux finaux, car ils sont bas√©s sur la tr√©sorerie !
                
            } else {
                msg.innerHTML = "‚ùå Le calcul est faux. Le total doit inclure TOUTES les valeurs, m√™me non encaiss√©es/d√©caiss√©es ce mois-ci. (Total attendu : " + totalReelAttendu + " ‚Ç¨)";
                msg.className = "feedback-msg incorrect";
            }
        }

        // --- V√âRIFICATION BILAN TR√âSORERIE ---
        function verifierBilanMateo() {
            // Totaux saisis par l'utilisateur
            const rEff = parseInt(document.getElementById('final-recettes-effectives').value) || 0;
            const dEff = parseInt(document.getElementById('final-depenses-effectives').value) || 0;
            const eEff = parseInt(document.getElementById('final-epargne-effective').value) || 0;
            const s = parseInt(document.getElementById('final-solde').value);
            const msg = document.getElementById('msg-bilan');

            // 1. V√©rifier si les 5 totaux de classification sont valid√©s
            if (document.getElementById('input-recettes').disabled === false || 
                document.getElementById('input-fixes').disabled === false ||
                document.getElementById('input-courantes').disabled === false ||
                document.getElementById('input-occas').disabled === false ||
                document.getElementById('input-epargne').disabled === false) {
                
                msg.innerHTML = "‚ö†Ô∏è Valide d'abord les 5 totaux de classification (Recettes, DF, DC, DO, √âpargne).";
                msg.className = "feedback-msg incorrect";
                return;
            }

            let errors = [];

            // 2. V√©rification des totaux de tr√©sorerie report√©s
            // Recettes effectives : 1100 (Salaire 1) + 250 (Vente BD) = 1350
            if (rEff !== totalRecettesEffectives) errors.push("Total Recettes EFFECTIVES report√© incorrect. (Attendu : " + totalRecettesEffectives + " ‚Ç¨)");
            
            // D√©penses effectives (DF+DC+DO) : 600+60+150+30 + 280+110 + 50+70 = 1310
            const totalDepensesEffectivesReelles = totalDepensesEffectivesEtEpargne - totalEpargneReelle; // 1450 - 100 = 1350
            if (dEff !== totalDepensesEffectivesReelles) errors.push("Total D√©penses (DF+DC+DO) EFFECTIVES report√© incorrect. (Attendu : " + totalDepensesEffectivesReelles + " ‚Ç¨)");
            
            // √âpargne effective : 100 (PEL)
            if (eEff !== totalEpargneReelle) errors.push("Total √âpargne EFFECTIVE report√© incorrect. (Attendu : " + totalEpargneReelle + " ‚Ç¨)");


            if (errors.length > 0) {
                msg.innerHTML = "‚ùå " + errors.join(" ");
                msg.className = "feedback-msg incorrect";
                return;
            }

            // 3. V√©rification du solde final : R eff - (D eff + E eff)
            const soldeCalcule = rEff - dEff - eEff;
            
            if (s === soldeReelTresorerie) {
                msg.innerHTML = "‚úÖ Solde de tr√©sorerie correct : " + soldeReelTresorerie + " ‚Ç¨.";
                msg.className = "feedback-msg correct";
                document.getElementById('budget-status').style.opacity = "1";
                document.getElementById('budget-status').style.pointerEvents = "auto";
                document.getElementById('btn-conclusion').style.display = "inline-block";
            } else {
                msg.innerHTML = "‚ö†Ô∏è Solde de tr√©sorerie faux. Il faut faire Recettes EFFECTIVES - D√©penses EFFECTIVES - √âpargne EFFECTIVE. (Attendu : " + soldeReelTresorerie + " ‚Ç¨)";
                msg.className = "feedback-msg incorrect";
            }
        }

        function verifierConclusionMateo() {
            const radios = document.getElementsByName('budget');
            let selected;
            for(let radio of radios) { if(radio.checked) selected = radio.value; }
            
            const msg = document.getElementById('msg-conclusion');

            let correctStatus = "";
            if (soldeReelTresorerie > 0) correctStatus = "positive";
            else if (soldeReelTresorerie < 0) correctStatus = "n√©gative";
            else correctStatus = "√©quilibre";

            if (selected === correctStatus) {
                msg.innerHTML = "üéâ BRAVO ! La tr√©sorerie de Mat√©o est **n√©gative** (√† d√©couvert) de " + Math.abs(soldeReelTresorerie) + " ‚Ç¨ √† cause du salaire diff√©r√© et des agios.";
                msg.className = "feedback-msg correct";
                msg.style.fontSize = "1.3rem";
                document.body.style.backgroundColor = "#ffdddd"; // Couleur d'alerte pour finir
            } else {
                msg.innerHTML = "Non. Le solde est de " + soldeReelTresorerie + " ‚Ç¨. Quel est le statut ?";
                msg.className = "feedback-msg incorrect";
            }
        }

        // --- AUDIO GESTION (Play/Stop & Clean Text) ---
        let isSpeaking = false;
        
        function toggleAudio() {
            const btn = document.getElementById('main-audio-btn');
            
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                btn.classList.remove('playing');
                btn.innerHTML = '<span>‚ñ∂Ô∏è Lire l\'histoire</span>';
            } else {
                let text = document.getElementById('text-content').innerText;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                utterance.rate = 0.9;
                
                utterance.onend = function() {
                    isSpeaking = false;
                    btn.classList.remove('playing');
                    btn.innerHTML = '<span>‚ñ∂Ô∏è Lire l\'histoire</span>';
                };

                window.speechSynthesis.speak(utterance);
                isSpeaking = true;
                btn.classList.add('playing');
                btn.innerHTML = '<span>‚èπÔ∏è Arr√™ter</span>';
            }
        }
    </script>
</body>
</html>