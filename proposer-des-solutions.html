<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Module D2 - Proposer des solutions (Carla)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --accent:#0f766e;
      --line:#e5e7eb;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#b45309;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --radius:18px;
      --pad:16px;
      --max:1240px;
      --focus:0 0 0 3px rgba(15,118,110,.22);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --fs: 16.5px;
      --lh: 1.45;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      font-size:var(--fs);
      line-height:var(--lh);
      color:var(--ink);
      background:linear-gradient(180deg, #fff, var(--bg));
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:18px 14px 26px}
    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      padding:14px 16px; background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted); background:#fff;
      font-size:13px; font-weight:950;
    }
    h1{margin:8px 0 4px; font-size:22px; line-height:1.2}
    .sub{color:var(--muted); margin:0; font-size:14px}
    .h-right{display:flex; flex-direction:column; gap:10px; align-items:flex-end}
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:950; font-size:14px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      user-select:none;
    }
    .btn:hover{border-color:#d1d5db}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.primary{background:linear-gradient(180deg, #0f766e, #0b5f58); color:#fff; border-color:#0b5f58}
    .pill{
      font-family:var(--mono);
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; color:var(--muted); font-size:13px; font-weight:950;
    }

    .top{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
      margin-bottom:12px;
    }
    .topHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .topHead h2{margin:0; font-size:18px}
    .muted{color:var(--muted)}
    .docs{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .docs{grid-template-columns: 1fr 1fr;}
    }
    .docBox{
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }
    .docHead{
      padding:10px 12px;
      background:rgba(17,24,39,.03);
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .docHead b{font-size:14px}
    .docHead .small{color:var(--muted); font-size:13px}
    .docImg{display:block; width:100%; height:auto}

    .footer{
      margin-top:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .progress{
      width:100%; height:12px; border-radius:999px;
      background:#eef2f7; overflow:hidden; border:1px solid var(--line);
    }
    .bar{height:100%; width:0%; background:linear-gradient(90deg, #0f766e, #7c2d12)}
    .small{font-size:13px; color:var(--muted)}
    .mono{font-family:var(--mono)}

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 1fr 1fr;}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
      min-width:0;
    }
    .card h2{margin:0 0 8px; font-size:18px}

    .q{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg, rgba(17,24,39,.02), rgba(17,24,39,.00));
    }
    .qhead{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .qtitle{font-weight:950}
    .scoreTag{
      font-family:var(--mono);
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-weight:950;
    }
    input[type="text"], textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:15px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, textarea:focus, select:focus{outline:none; box-shadow:var(--focus)}
    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      margin-top:10px;
    }
    @media (min-width: 620px){ .row{grid-template-columns: 1fr 1fr;} }
    .row.one{grid-template-columns:1fr}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; font-weight:950; font-size:13px; color:var(--muted);
    }
    .ok{color:var(--ok); border-color:rgba(22,163,74,.3); background:rgba(22,163,74,.06)}
    .bad{color:var(--bad); border-color:rgba(220,38,38,.3); background:rgba(220,38,38,.06)}
    .warnTag{color:var(--warn); border-color:rgba(180,83,9,.3); background:rgba(180,83,9,.06)}
    .feedback{margin-top:10px}
    .fbLine{margin:6px 0; padding:8px 10px; border-radius:14px; border:1px solid var(--line); background:#fff}

    .miniTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      margin-top:10px;
    }
    .miniTable th, .miniTable td{
      padding:10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      text-align:left;
    }
    .miniTable th{background:rgba(17,24,39,.03); font-size:14px}
    .miniTable tr:last-child td{border-bottom:none}
    .miniTable .right{text-align:right; font-family:var(--mono)}

    @media print{
      @page { size: A4 landscape; margin: 10mm; }
      body{background:#fff}
      header, .top, .card{box-shadow:none}
      .btn{display:none}
      .wrap{max-width:none; padding:0}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="badge">MODULE D2</div>
        <h1>Proposer des solutions</h1>
        <p class="sub">Objectif : etre capable d’utiliser des documents pour calculer, deduire et proposer des solutions.</p>
      </div>
      <div class="h-right">
        <div class="pill" id="saveState">Sauvegarde : active</div>
        <button class="btn" type="button" id="btnReset">Reinitialiser</button>
      </div>
    </header>

    <section class="top">
      <div class="topHead">
        <div>
          <h2>Documents</h2>
          <div class="small">S’appuyer sur les documents B et D pour repondre.</div>
        </div>
        <div class="pill mono" id="globalScore">Score : 0 / 18</div>
      </div>

      <div class="docs">
        <div class="docBox">
          <div class="docHead">
            <b>Document B</b>
            <span class="small">Budget previsionnel mensuel de Carla</span>
          </div>
          <img class="docImg" src="document-b-budget-carla.jpg" alt="Document B budget Carla" />
        </div>

        <div class="docBox">
          <div class="docHead">
            <b>Document D</b>
            <span class="small">Exemples de comptes epargne (1er fevrier 2025)</span>
          </div>
          <img class="docImg" src="doc-d-comptes-epargne-2025-02-01.jpg" alt="Document D comptes epargne" />
        </div>
      </div>

      <div class="footer">
        <div style="min-width:220px; flex:1">
          <div class="small">Progression</div>
          <div class="progress" aria-label="progression">
            <div class="bar" id="bar"></div>
          </div>
        </div>
        <div class="small">Note finale sur 20 : score auto /18 + points C6 (0 a 2) par l’enseignant.</div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <h2>11) Calculer et deduire</h2>

        <div class="q" id="q11">
          <div class="qhead">
            <div class="qtitle">11.1 Calculer le montant des depenses, des recettes et de l’epargne</div>
            <div class="scoreTag">C2 • 8 pts</div>
          </div>

          <div class="muted">Consigne : Completer le tableau (montants en euros).</div>

          <table class="miniTable" aria-label="Tableau calculs">
            <tr>
              <th>Rubrique</th>
              <th class="right">Montant</th>
            </tr>
            <tr>
              <td>Recettes (total)</td>
              <td class="right"><input id="recettes" type="text" inputmode="decimal" placeholder="Ecrire ici" /></td>
            </tr>
            <tr>
              <td>Charges fixes (total)</td>
              <td class="right"><input id="fixes" type="text" inputmode="decimal" placeholder="Ecrire ici" /></td>
            </tr>
            <tr>
              <td>Depenses courantes (total)</td>
              <td class="right"><input id="courantes" type="text" inputmode="decimal" placeholder="Ecrire ici" /></td>
            </tr>
            <tr>
              <td>Depenses d’equipement et de renouvellement (total)</td>
              <td class="right"><input id="equip" type="text" inputmode="decimal" placeholder="Ecrire ici" /></td>
            </tr>
            <tr>
              <td>Depenses (total)</td>
              <td class="right"><input id="depenses" type="text" inputmode="decimal" placeholder="Ecrire ici" /></td>
            </tr>
            <tr>
              <td>Epargne (mensuelle)</td>
              <td class="right"><input id="epargne" type="text" inputmode="decimal" placeholder="Ecrire ici" /></td>
            </tr>
          </table>

          <div class="small" style="margin-top:10px">
            Aide : Depenses (total) = fixes + courantes + equipement. Epargne = recettes - depenses.
          </div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q11">Corriger</button>
            <span class="tag warnTag" id="q11tag">A faire</span>
          </div>
          <div class="feedback" id="q11fb"></div>
        </div>

        <div class="q" id="q112">
          <div class="qhead">
            <div class="qtitle">11.2 Deduire si Carla a economise assez en 5 mois</div>
            <div class="scoreTag">C2 • 4 pts</div>
          </div>

          <div class="muted">Consigne : Remplir les cases puis conclure.</div>

          <div class="row">
            <div>
              <label class="small" for="epargne5">Epargne sur 5 mois (en €)</label>
              <input id="epargne5" type="text" inputmode="decimal" placeholder="Ecrire ici" />
            </div>
            <div>
              <label class="small" for="manque">Somme manquante ou restante (en €)</label>
              <input id="manque" type="text" inputmode="decimal" placeholder="Ecrire ici" />
            </div>
          </div>

          <div class="row one">
            <div>
              <label class="small" for="conclusion">Conclure (1 phrase)</label>
              <textarea id="conclusion" placeholder="Ecrire ici"></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q112">Corriger</button>
            <span class="tag warnTag" id="q112tag">A faire</span>
          </div>
          <div class="feedback" id="q112fb"></div>
        </div>
      </div>

      <div class="card">
        <h2>12–13) Proposer et choisir</h2>

        <div class="q" id="q12">
          <div class="qhead">
            <div class="qtitle">12 Proposer a Carla deux solutions si l’epargne est insuffisante</div>
            <div class="scoreTag">C4 • 4 pts</div>
          </div>

          <div class="muted">Consigne : Ecrire deux solutions concretes.</div>

          <div class="row one">
            <div>
              <label class="small" for="sol1">Solution 1</label>
              <textarea id="sol1" placeholder="Ecrire ici"></textarea>
            </div>
          </div>
          <div class="row one">
            <div>
              <label class="small" for="sol2">Solution 2</label>
              <textarea id="sol2" placeholder="Ecrire ici"></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q12">Corriger</button>
            <span class="tag warnTag" id="q12tag">A faire</span>
          </div>
          <div class="feedback" id="q12fb"></div>
        </div>

        <div class="q" id="q13">
          <div class="qhead">
            <div class="qtitle">13 Choisir le compte epargne le plus adapte et argumenter</div>
            <div class="scoreTag">C5 • 6 pts</div>
          </div>

          <div class="muted">Consigne : Choisir un compte puis argumenter avec le document D.</div>

          <div class="row">
            <div>
              <label class="small" for="compte">Compte choisi</label>
              <select id="compte">
                <option value="">Selectionner</option>
                <option value="la">Livret A</option>
                <option value="lj">Livret jeune</option>
                <option value="pel">PEL</option>
                <option value="lep">LEP</option>
              </select>
            </div>
            <div>
              <label class="small" for="args">Argumenter (2 phrases)</label>
              <textarea id="args" placeholder="Ecrire ici"></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q13">Corriger</button>
            <span class="tag warnTag" id="q13tag">A faire</span>
          </div>
          <div class="feedback" id="q13fb"></div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn primary" type="button" id="btnFinal">Calculer le score auto</button>
          <button class="btn" type="button" id="btnExport">Exporter la copie</button>
        </div>
        <div class="feedback" id="finalFb"></div>
      </div>
    </section>
  </div>

  <script>
    const STORE_KEY = "pse_d2_proposer_solutions_v1";
    const state = {
      q11:{recettes:"", fixes:"", courantes:"", equip:"", depenses:"", epargne:""},
      q112:{epargne5:"", manque:"", conclusion:""},
      q12:{sol1:"", sol2:""},
      q13:{compte:"", args:""}
    };

    function $(sel, root=document){ return root.querySelector(sel); }
    function $all(sel, root=document){ return [...root.querySelectorAll(sel)]; }

    function save(){
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
      $("#saveState").textContent = "Sauvegarde : active";
      computeProgress();
    }

    function load(){
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return;
      try{
        const p = JSON.parse(raw);
        if(p && typeof p === "object"){
          Object.assign(state, p);
        }
      }catch(e){}
    }

    function resetAll(){
      localStorage.removeItem(STORE_KEY);
      location.reload();
    }

    function tag(el, kind, text){
      el.className = "tag " + (kind || "");
      el.textContent = text;
    }

    function mkLine(host, text, ok, warn){
      const line = document.createElement("div");
      line.className = "fbLine";
      line.textContent = text;
      if(ok){
        line.style.borderColor = "rgba(22,163,74,.28)";
        line.style.background = "rgba(22,163,74,.06)";
      }else if(warn){
        line.style.borderColor = "rgba(180,83,9,.28)";
        line.style.background = "rgba(180,83,9,.06)";
      }else{
        line.style.borderColor = "rgba(220,38,38,.28)";
        line.style.background = "rgba(220,38,38,.06)";
      }
      host.appendChild(line);
    }

    function normNum(s){
      return (String(s||"")
        .replace(/\s/g,"")
        .replace("€","")
        .replace(",", ".")
        .replace(/[^\d.\-]/g,"")
      );
    }
    function toNum(s){
      const x = Number(normNum(s));
      return Number.isFinite(x) ? x : NaN;
    }
    function almostEq(a, b){
      const x = Number(a), y = Number(b);
      if(!Number.isFinite(x) || !Number.isFinite(y)) return false;
      return Math.abs(x - y) < 0.02;
    }

    const EXPECT = {
      recettes: 1375.00,
      fixes: 593.27,
      courantes: 508.50,
      equip: 172.50,
      depenses: 1274.27,
      epargne: 100.73,
      epargne5: 503.65,
      manque: 185.35
    };

    function correctQ11(){
      const fb = $("#q11fb");
      fb.innerHTML = "";
      let pts = 0;

      const r = toNum($("#recettes").value);
      const f = toNum($("#fixes").value);
      const c = toNum($("#courantes").value);
      const e = toNum($("#equip").value);
      const d = toNum($("#depenses").value);
      const s = toNum($("#epargne").value);

      const okR = almostEq(r, EXPECT.recettes);
      const okF = almostEq(f, EXPECT.fixes);
      const okC = almostEq(c, EXPECT.courantes);
      const okE = almostEq(e, EXPECT.equip);
      const okD = almostEq(d, EXPECT.depenses);
      const okS = almostEq(s, EXPECT.epargne);

      const flags = [okR,okF,okC,okE,okD,okS];
      pts = Math.round((flags.filter(Boolean).length / flags.length) * 8);

      mkLine(fb, okR ? "Recettes : correct" : "Recettes : a verifier avec le document B", okR, !okR && !isNaN(r));
      mkLine(fb, okF ? "Charges fixes : correct" : "Charges fixes : a verifier", okF, !okF && !isNaN(f));
      mkLine(fb, okC ? "Depenses courantes : correct" : "Depenses courantes : a verifier", okC, !okC && !isNaN(c));
      mkLine(fb, okE ? "Equipement/renouvellement : correct" : "Equipement/renouvellement : a verifier", okE, !okE && !isNaN(e));
      mkLine(fb, okD ? "Depenses (total) : correct" : "Depenses (total) : a recalculer (fixes + courantes + equipement)", okD, !okD && !isNaN(d));
      mkLine(fb, okS ? "Epargne : correct" : "Epargne : a recalculer (recettes - depenses)", okS, !okS && !isNaN(s));

      tag($("#q11tag"), pts>=7 ? "ok" : (pts>=4 ? "warnTag" : "bad"), `Score : ${pts} / 8`);
      return pts;
    }

    function correctQ112(){
      const fb = $("#q112fb");
      fb.innerHTML = "";
      let pts = 0;

      const e5 = toNum($("#epargne5").value);
      const manque = toNum($("#manque").value);
      const concl = ($("#conclusion").value || "").toLowerCase();

      const okE5 = almostEq(e5, EXPECT.epargne5);
      const okManque = almostEq(manque, EXPECT.manque);

      const hasLack = /(manque|insuffisant|pas assez|reste a payer)/i.test(concl);
      const hasPhone = /(xgphone|smartphone)/i.test(concl);
      const hasNum = /(\d+)/.test(concl);
      const okConcl = (hasLack && (hasPhone || hasNum)) && concl.trim().length >= 35;

      pts += okE5 ? 1 : 0;
      pts += okManque ? 1 : 0;
      pts += okConcl ? 2 : 0;

      mkLine(fb, okE5 ? "Epargne sur 5 mois : correct" : "Epargne sur 5 mois : a calculer (epargne mensuelle x 5)", okE5, !okE5 && !isNaN(e5));
      mkLine(fb, okManque ? "Somme manquante/restante : correct" : "Somme manquante/restante : a calculer (prix - epargne sur 5 mois)", okManque, !okManque && !isNaN(manque));
      mkLine(fb, okConcl ? "Conclusion : OK" : "Conclusion : ecrire une phrase complete (assez / pas assez + justification)", okConcl, !okConcl && concl.trim().length>0);

      tag($("#q112tag"), pts===4 ? "ok" : (pts>=2 ? "warnTag" : "bad"), `Score : ${pts} / 4`);
      return pts;
    }

    function scoreTextSolution(text){
      const t = (text||"").toLowerCase();
      const lenOk = t.trim().length >= 45;
      const ideas = [
        /(economiser|epargner).*(plus|mois|temps)/i,
        /(reduire|diminuer|supprimer).*(depense|loisir|cadeau|habill|vacance|equipement)/i,
        /(augmenter).*(recette|revenu|heures|job|stage)/i
      ];
      const hasIdea = ideas.some(rx => rx.test(t));
      return {lenOk, hasIdea};
    }

    function correctQ12(){
      const fb = $("#q12fb");
      fb.innerHTML = "";
      let pts = 0;

      const s1 = $("#sol1").value || "";
      const s2 = $("#sol2").value || "";

      const a1 = scoreTextSolution(s1);
      const a2 = scoreTextSolution(s2);

      const ok1 = a1.lenOk && a1.hasIdea;
      const ok2 = a2.lenOk && a2.hasIdea;

      pts = (ok1?2:0) + (ok2?2:0);

      mkLine(fb, ok1 ? "Solution 1 : OK" : "Solution 1 : ecrire une solution concrete (plus de temps / moins de depenses / plus de recettes)", ok1, !ok1 && s1.trim().length>0);
      mkLine(fb, ok2 ? "Solution 2 : OK" : "Solution 2 : ecrire une solution concrete (differente si possible)", ok2, !ok2 && s2.trim().length>0);

      tag($("#q12tag"), pts===4 ? "ok" : (pts>=2 ? "warnTag" : "bad"), `Score : ${pts} / 4`);
      return pts;
    }

    function correctQ13(){
      const fb = $("#q13fb");
      fb.innerHTML = "";
      let pts = 0;

      const compte = $("#compte").value || "";
      const args = ($("#args").value || "").toLowerCase();

      const okChoice = (compte === "lep");

      const hasRevenus = /(revenu|revenus|seuil|ne depasse)/i.test(args);
      const hasTaux = /(taux|interet|rentab)/i.test(args);
      const hasDispo = /(disponible|tout moment|retirer)/i.test(args);
      const count = [hasRevenus, hasTaux, hasDispo].filter(Boolean).length;
      const lenOk = args.trim().length >= 70;

      pts += okChoice ? 2 : 0;
      pts += (lenOk ? 2 : 0);
      pts += (count >= 2 ? 2 : (count === 1 ? 1 : 0));

      mkLine(fb, okChoice ? "Compte choisi : coherent" : "Compte choisi : a verifier avec le document D", okChoice, !okChoice && compte);
      mkLine(fb, lenOk ? "Argumentation : longueur suffisante" : "Argumentation : ecrire au moins 2 phrases", lenOk, !lenOk && args.trim().length>0);
      mkLine(fb, count>=2 ? "Criteres : au moins 2 criteres utilises (revenus / taux / disponibilite)" :
                 (count===1 ? "Criteres : ajouter un 2e critere (revenus / taux / disponibilite)" :
                             "Criteres : utiliser des criteres du document D"),
            count>=2, count===1);

      tag($("#q13tag"), pts>=5 ? "ok" : (pts>=3 ? "warnTag" : "bad"), `Score : ${pts} / 6`);
      return pts;
    }

    function computeProgress(){
      const done11 = ["recettes","fixes","courantes","equip","depenses","epargne"].every(id => ($("#"+id).value||"").trim().length>0);
      const done112 = ["epargne5","manque"].every(id => ($("#"+id).value||"").trim().length>0) && ($("#conclusion").value||"").trim().length>0;
      const done12 = ($("#sol1").value||"").trim().length>0 && ($("#sol2").value||"").trim().length>0;
      const done13 = ($("#compte").value||"") && ($("#args").value||"").trim().length>0;

      const done = [done11,done112,done12,done13].filter(Boolean).length;
      const pct = Math.round((done/4)*100);
      $("#bar").style.width = pct + "%";
    }

    function updateGlobalScore(){
      const total = correctQ11() + correctQ112() + correctQ12() + correctQ13();
      $("#globalScore").textContent = `Score : ${total} / 18`;
      return total;
    }

    function finalScore(){
      const total = updateGlobalScore();
      const fb = $("#finalFb");
      fb.innerHTML = "";
      const line = document.createElement("div");
      line.className = "fbLine";
      line.style.borderColor = "rgba(15,118,110,.28)";
      line.style.background = "rgba(15,118,110,.06)";
      line.innerHTML = `<b>Score auto</b> : <span class="mono">${total} / 18</span> • Note finale : <span class="mono">${total} / 18</span> + points C6 (0 a 2)`;
      fb.appendChild(line);
      computeProgress();
    }

    function exportCopy(){
      const total = updateGlobalScore();
      const lines = [];
      lines.push("MODULE D2 - Proposer des solutions (Carla)");
      lines.push("Nom : ____________________   Prenom : ____________________   Classe : __________");
      lines.push("");
      lines.push("11.1 Calculer (C2)");
      lines.push("Recettes : " + ($("#recettes").value||""));
      lines.push("Fixes : " + ($("#fixes").value||""));
      lines.push("Courantes : " + ($("#courantes").value||""));
      lines.push("Equipement : " + ($("#equip").value||""));
      lines.push("Depenses : " + ($("#depenses").value||""));
      lines.push("Epargne : " + ($("#epargne").value||""));
      lines.push("");
      lines.push("11.2 Deduire (C2)");
      lines.push("Epargne 5 mois : " + ($("#epargne5").value||""));
      lines.push("Manque/restant : " + ($("#manque").value||""));
      lines.push("Conclusion : " + ($("#conclusion").value||""));
      lines.push("");
      lines.push("12 Solutions (C4)");
      lines.push("Solution 1 : " + ($("#sol1").value||""));
      lines.push("Solution 2 : " + ($("#sol2").value||""));
      lines.push("");
      lines.push("13 Choisir un compte (C5)");
      lines.push("Compte : " + ($("#compte").value||""));
      lines.push("Argumentation : " + ($("#args").value||""));
      lines.push("");
      lines.push("Total auto : " + total + "/18");
      lines.push("Points C6 : +0 a +2 (enseignant)");
      const blob = new Blob([lines.join("\n")], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "copie_d2_proposer_solutions.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function bindStore(){
      ["recettes","fixes","courantes","equip","depenses","epargne"].forEach(id=>{
        const el = $("#"+id);
        el.addEventListener("input", ()=>{
          state.q11[id] = el.value;
          save();
        });
      });

      ["epargne5","manque","conclusion"].forEach(id=>{
        const el = $("#"+id);
        el.addEventListener("input", ()=>{
          state.q112[id] = el.value;
          save();
        });
      });

      ["sol1","sol2"].forEach(id=>{
        const el = $("#"+id);
        el.addEventListener("input", ()=>{
          state.q12[id] = el.value;
          save();
        });
      });

      $("#compte").addEventListener("change", ()=>{
        state.q13.compte = $("#compte").value;
        save();
      });
      $("#args").addEventListener("input", ()=>{
        state.q13.args = $("#args").value;
        save();
      });
    }

    function restoreUI(){
      Object.entries(state.q11).forEach(([k,v])=>{ const el = $("#"+k); if(el) el.value = v || ""; });
      Object.entries(state.q112).forEach(([k,v])=>{ const el = $("#"+k); if(el) el.value = v || ""; });
      $("#sol1").value = state.q12.sol1 || "";
      $("#sol2").value = state.q12.sol2 || "";
      $("#compte").value = state.q13.compte || "";
      $("#args").value = state.q13.args || "";
    }

    function init(){
      load();
      restoreUI();
      bindStore();

      $("#btnReset").addEventListener("click", resetAll);

      $all("[data-correct]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.dataset.correct;
          if(id==="q11") correctQ11();
          if(id==="q112") correctQ112();
          if(id==="q12") correctQ12();
          if(id==="q13") correctQ13();
          updateGlobalScore();
          computeProgress();
        });
      });

      $("#btnFinal").addEventListener("click", finalScore);
      $("#btnExport").addEventListener("click", exportCopy);

      computeProgress();
      updateGlobalScore();
    }

    init();
  </script>
</body>
</html>
