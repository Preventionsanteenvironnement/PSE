<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSE D2 - Etat du budget : equilibre, excedentaire, deficitaire</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --accent:#7c2d12;
      --accent2:#0f766e;
      --line:#e5e7eb;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#b45309;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --radius:18px;
      --pad:18px;
      --max:980px;
      --focus:0 0 0 3px rgba(15,118,110,.22);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --fontDys: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --fs: 16.5px;
      --lh: 1.45;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      font-size:var(--fs);
      line-height:var(--lh);
      color:var(--ink);
      background:linear-gradient(180deg, #fff, var(--bg));
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:22px 16px 36px}
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      padding:18px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted); background:#fff;
      font-size:13px; font-weight:900;
    }
    h1{margin:10px 0 4px; font-size:22px; line-height:1.2}
    .sub{color:var(--muted); margin:0}
    .h-right{display:flex; flex-direction:column; gap:10px; align-items:flex-end}
    .toggles{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:900; font-size:14px;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      user-select:none;
    }
    .btn:hover{border-color:#d1d5db}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.primary{background:linear-gradient(180deg, #0f766e, #0b5f58); color:#fff; border-color:#0b5f58}
    .btn.primary:hover{filter:brightness(1.03)}
    .pill{
      font-family:var(--mono);
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; color:var(--muted); font-size:13px; font-weight:950;
    }
    .grid{display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px}
    @media (min-width: 900px){ .grid{grid-template-columns: 1.05fr .95fr;} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
      min-width:0;
    }
    .card h2{margin:0 0 10px; font-size:18px}
    .card h3{margin:14px 0 8px; font-size:16px}
    .muted{color:var(--muted)}
    .note{
      border-left:5px solid var(--accent2);
      background:linear-gradient(180deg, rgba(15,118,110,.08), rgba(15,118,110,.03));
      padding:10px 12px; border-radius:14px;
    }
    .twoCol{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 700px){ .twoCol{grid-template-columns:1fr 1fr} }
    .mini{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .mini b{display:block; margin-bottom:6px}
    .klist{margin:10px 0 0; padding-left:18px}
    .klist li{margin:6px 0}
    .hr{height:1px; background:var(--line); margin:14px 0}
    .q{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg, rgba(17,24,39,.02), rgba(17,24,39,.00));
    }
    .qhead{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .qtitle{font-weight:950}
    .scoreTag{
      font-family:var(--mono);
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-weight:950;
    }
    .rows{display:grid; gap:10px; margin-top:10px}
    .row{
      display:grid; grid-template-columns: 1fr; gap:10px;
      padding:10px; border:1px solid var(--line); border-radius:16px; background:#fff;
    }
    @media (min-width: 720px){ .row{grid-template-columns: 1.2fr .8fr;} }

    select, input[type="text"], input[type="number"], textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:15px;
    }
    select:focus, input:focus, textarea:focus{outline:none; box-shadow:var(--focus)}
    textarea{min-height:92px; resize:vertical}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; font-weight:950; font-size:13px; color:var(--muted);
    }
    .ok{color:var(--ok); border-color:rgba(22,163,74,.3); background:rgba(22,163,74,.06)}
    .bad{color:var(--bad); border-color:rgba(220,38,38,.3); background:rgba(220,38,38,.06)}
    .warnTag{color:var(--warn); border-color:rgba(180,83,9,.3); background:rgba(180,83,9,.06)}
    .feedback{margin-top:10px}
    .fbLine{margin:6px 0; padding:8px 10px; border-radius:14px; border:1px solid var(--line); background:#fff}

    .progress{
      width:100%; height:12px; border-radius:999px;
      background:#eef2f7; overflow:hidden; border:1px solid var(--line);
    }
    .bar{height:100%; width:0%; background:linear-gradient(90deg, #0f766e, #7c2d12)}
    .footer{
      margin-top:14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .small{font-size:13px; color:var(--muted)}
    .mono{font-family:var(--mono)}
    body.dyslexie{
      font-family:var(--fontDys);
      letter-spacing:.35px;
      word-spacing:.1em;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    th{background:rgba(17,24,39,.04); text-align:left}
    tr:last-child td{border-bottom:none}
    .right{ text-align:right }
    .calcGrid{
      display:grid; grid-template-columns:1fr; gap:10px;
      margin-top:10px;
    }
    @media (min-width: 720px){ .calcGrid{grid-template-columns:1fr 1fr 1fr} }
    .calcCell{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:linear-gradient(180deg, rgba(17,24,39,.02), rgba(17,24,39,0));
    }
    .calcCell b{display:block; margin-bottom:6px}
    .pill2{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; font-weight:950; font-size:13px;
    }
    .g{color:#166534; border-color:rgba(22,101,52,.25); background:rgba(22,101,52,.06)}
    .b{color:#075985; border-color:rgba(7,89,133,.25); background:rgba(7,89,133,.06)}
    .r{color:#991b1b; border-color:rgba(153,27,27,.25); background:rgba(153,27,27,.06)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="h-left">
        <div class="badge">PSE THEMATIQUE D2 • CAP</div>
        <h1>Etat du budget : equilibre, excedentaire, deficitaire</h1>
        <p class="sub">
          Objectif : etre capable de determiner le solde d’un budget et d’identifier l’etat du budget.
        </p>
      </div>

      <div class="h-right">
        <div class="pill" id="saveState">Sauvegarde : active</div>
        <div class="toggles">
          <button class="btn" id="btnDys" type="button" aria-pressed="false">Mode lecture</button>
          <button class="btn" id="btnReset" type="button">Reinitialiser</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Cours express</h2>

        <div class="note">
          <b>Solde</b>
          Solde = recettes - depenses
        </div>

        <div class="twoCol" style="margin-top:12px">
          <div class="mini">
            <b>Budget excedentaire</b>
            <div class="muted">Recettes &gt; depenses</div>
            <div class="pill2 b" style="margin-top:8px">Solde positif</div>
            <ul class="klist">
              <li>Possibilite d’epargner</li>
              <li>Factures payees + reserve pour les imprevus</li>
            </ul>
          </div>

          <div class="mini">
            <b>Budget equilibre</b>
            <div class="muted">Recettes = depenses</div>
            <div class="pill2 g" style="margin-top:8px">Solde nul</div>
            <ul class="klist">
              <li>Factures payees</li>
              <li>Mais peu ou pas de reserve pour les imprevus</li>
            </ul>
          </div>
        </div>

        <div class="mini" style="margin-top:10px">
          <b>Budget deficitaire</b>
          <div class="muted">Recettes &lt; depenses</div>
          <div class="pill2 r" style="margin-top:8px">Solde negatif</div>
          <ul class="klist">
            <li>Risque de dettes / surendettement</li>
            <li>Factures pas toutes payees</li>
          </ul>
        </div>

        <div class="hr"></div>

        <div class="note">
          <b>Regle principale</b>
          Il est preferable que les recettes soient superieures aux depenses, pour garder une reserve (epargne) et faire face aux imprevus.
        </div>

        <div class="hr"></div>

        <div class="footer">
          <div style="min-width:220px; flex:1">
            <div class="small">Progression</div>
            <div class="progress" aria-label="progression">
              <div class="bar" id="bar"></div>
            </div>
          </div>
          <div class="pill mono" id="globalScore">Score : 0 / 18</div>
        </div>

        <div class="small" style="margin-top:10px">
          Note finale sur 20 : score auto /18 + points C6 (0 a 2) ajoutes par l’enseignant.
        </div>
      </section>

      <section class="card" id="devoir">
        <h2>Devoir en autonomie</h2>
        <p class="muted" style="margin-top:-2px">Bareme : 18 points auto + 2 points C6 (enseignant).</p>

        <!-- Ex 1 -->
        <div class="q" id="q1">
          <div class="qhead">
            <div class="qtitle">Exercice 1 – Identifier l’etat du budget</div>
            <div class="scoreTag">C2 • 3 pts</div>
          </div>
          <div class="muted">Verbes : Identifier, Associer.</div>

          <div class="rows" id="q1rows"></div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q1">Corriger</button>
            <span class="tag warnTag" id="q1tag">A faire</span>
          </div>
          <div class="feedback" id="q1fb"></div>
        </div>

        <!-- Ex 2 -->
        <div class="q" id="q2">
          <div class="qhead">
            <div class="qtitle">Exercice 2 – Analyser des situations</div>
            <div class="scoreTag">C2 • 6 pts</div>
          </div>
          <div class="muted">Verbes : Identifier, Determiner.</div>

          <div style="margin-top:10px">
            <table aria-label="situations">
              <thead>
                <tr>
                  <th>Situation</th>
                  <th>Solde du compte</th>
                  <th>Depenses par rapport aux recettes</th>
                  <th>Etat du budget</th>
                </tr>
              </thead>
              <tbody id="q2tbody"></tbody>
            </table>
          </div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q2">Corriger</button>
            <span class="tag warnTag" id="q2tag">A faire</span>
          </div>
          <div class="feedback" id="q2fb"></div>
        </div>

        <!-- Ex 3 -->
        <div class="q" id="q3">
          <div class="qhead">
            <div class="qtitle">Exercice 3 – Calculer un solde et conclure</div>
            <div class="scoreTag">C2 • 6 pts</div>
          </div>
          <div class="muted">Verbes : Calculer, Determiner.</div>

          <div class="rows" id="q3rows"></div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q3">Corriger</button>
            <span class="tag warnTag" id="q3tag">A faire</span>
          </div>
          <div class="feedback" id="q3fb"></div>
        </div>

        <!-- Ex 4 -->
        <div class="q" id="q4">
          <div class="qhead">
            <div class="qtitle">Exercice 4 – Relier l’etat du budget et la consequence</div>
            <div class="scoreTag">C2 • 3 pts</div>
          </div>
          <div class="muted">Verbes : Associer, Identifier.</div>

          <div class="rows" id="q4rows"></div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q4">Corriger</button>
            <span class="tag warnTag" id="q4tag">A faire</span>
          </div>
          <div class="feedback" id="q4fb"></div>
        </div>

        <!-- C6 -->
        <div class="q" id="q5">
          <div class="qhead">
            <div class="qtitle">Exercice 5 – Reponse ecrite</div>
            <div class="scoreTag">C6 • +0 a +2 (enseignant)</div>
          </div>
          <div class="muted">Verbes : Expliquer, Justifier.</div>

          <label class="small" for="q5txt">
            Expliquer la regle principale de gestion d’un budget et donner 1 exemple concret.
          </label>
          <textarea id="q5txt" placeholder="Ecrire 6 a 8 lignes..."></textarea>

          <div class="actions">
            <button class="btn" type="button" id="btnHelp">Verifier (aide)</button>
            <span class="tag warnTag" id="q5tag">A rendre</span>
          </div>
          <div class="feedback" id="q5fb"></div>
        </div>

        <div class="hr"></div>

        <div class="actions">
          <button class="btn primary" type="button" id="btnFinal">Calculer le score auto</button>
          <button class="btn" type="button" id="btnExport">Exporter la copie</button>
        </div>

        <div class="feedback" id="finalFb"></div>
      </section>
    </div>
  </div>

  <script>
    const STORE_KEY = "pse_d2_etat_budget_v1";

    const state = {
      dys:false,
      q1:{},
      q2:{},
      q3:{},
      q4:{},
      q5:{text:""}
    };

    const ETATS = [
      {v:"exc", t:"Excedentaire"},
      {v:"eq", t:"Equilibre"},
      {v:"def", t:"Deficitaire"}
    ];

    const SOLDE = [
      {v:"pos", t:"Positif"},
      {v:"nul", t:"Nul"},
      {v:"neg", t:"Negatif"}
    ];

    const COMP = [
      {v:"sup", t:"Depenses superieures aux recettes"},
      {v:"inf", t:"Depenses inferieures aux recettes"},
      {v:"ega", t:"Depenses egales aux recettes"}
    ];

    // Ex1
    const q1Items = [
      {id:"a1", text:"Recettes superieures aux depenses. Solde positif.", answer:"exc"},
      {id:"a2", text:"Recettes egales aux depenses. Solde nul.", answer:"eq"},
      {id:"a3", text:"Recettes inferieures aux depenses. Solde negatif.", answer:"def"}
    ];

    // Ex2
    const q2Situations = [
      {
        id:"s1",
        text:"Noemie, 18 ans, met regulierement 25 euros sur son compte epargne a la fin du mois.",
        ans:{solde:"pos", comp:"inf", etat:"exc"}
      },
      {
        id:"s2",
        text:"Coumba depense sans verifier ses comptes. A la fin du mois, elle n’a plus assez d’argent pour payer toutes ses factures.",
        ans:{solde:"neg", comp:"sup", etat:"def"}
      },
      {
        id:"s3",
        text:"Tristan a depense tout son salaire a la fin du mois. Il n’a cependant pas fait appel a ses economies.",
        ans:{solde:"nul", comp:"ega", etat:"eq"}
      }
    ];

    // Ex3
    const q3Cases = [
      {id:"c1", recettes:980, depenses:910, solde:70, etat:"exc"},
      {id:"c2", recettes:650, depenses:650, solde:0, etat:"eq"},
      {id:"c3", recettes:1200, depenses:1325, solde:-125, etat:"def"}
    ];

    // Ex4
    const q4Cons = [
      {id:"k1", text:"Les factures sont toutes payees. Les economies sont a placer sur un compte qui rapporte des interets.", answer:"exc"},
      {id:"k2", text:"Les factures sont toutes payees, mais il ne reste plus d’argent pour faire face aux imprevus.", answer:"eq"},
      {id:"k3", text:"Les factures ne sont pas toutes payees. Il faut trouver une solution pour ne pas etre surendette.", answer:"def"}
    ];

    function $(sel, root=document){ return root.querySelector(sel); }
    function $all(sel, root=document){ return [...root.querySelectorAll(sel)]; }

    function save(){
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
      $("#saveState").textContent = "Sauvegarde : active";
    }

    function load(){
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return;
      try{
        const payload = JSON.parse(raw);
        if(payload && typeof payload === "object"){
          Object.assign(state, payload);
          state.q1 = payload.q1 || state.q1;
          state.q2 = payload.q2 || state.q2;
          state.q3 = payload.q3 || state.q3;
          state.q4 = payload.q4 || state.q4;
          state.q5 = payload.q5 || state.q5;
        }
      }catch(e){}
    }

    function setDys(on){
      state.dys = on;
      document.body.classList.toggle("dyslexie", on);
      const btn = $("#btnDys");
      btn.setAttribute("aria-pressed", on ? "true" : "false");
      btn.textContent = on ? "Mode lecture : active" : "Mode lecture";
      save();
    }

    function resetAll(){
      localStorage.removeItem(STORE_KEY);
      location.reload();
    }

    function tag(el, kind, text){
      el.className = "tag " + (kind || "");
      el.textContent = text;
    }

    function buildQ1(){
      const host = $("#q1rows");
      host.innerHTML = "";
      q1Items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <b>${it.text}</b>
          </div>
          <div>
            <label class="small" for="q1_${it.id}">Etat</label>
            <select id="q1_${it.id}">
              <option value="">Selectionner</option>
              ${ETATS.map(e=>`<option value="${e.v}">${e.t}</option>`).join("")}
            </select>
          </div>
        `;
        host.appendChild(row);
      });
    }

    function buildQ2(){
      const body = $("#q2tbody");
      body.innerHTML = "";
      q2Situations.forEach(s=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${s.text}</b></td>
          <td>
            <select id="q2_sol_${s.id}">
              <option value="">Selectionner</option>
              ${SOLDE.map(x=>`<option value="${x.v}">${x.t}</option>`).join("")}
            </select>
          </td>
          <td>
            <select id="q2_cmp_${s.id}">
              <option value="">Selectionner</option>
              ${COMP.map(x=>`<option value="${x.v}">${x.t}</option>`).join("")}
            </select>
          </td>
          <td>
            <select id="q2_eta_${s.id}">
              <option value="">Selectionner</option>
              ${ETATS.map(x=>`<option value="${x.v}">${x.t}</option>`).join("")}
            </select>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    function buildQ3(){
      const host = $("#q3rows");
      host.innerHTML = "";
      q3Cases.forEach(c=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <b>Cas ${c.id.toUpperCase()}</b>
            <div class="small muted">Recettes : <span class="mono">${c.recettes}</span> • Depenses : <span class="mono">${c.depenses}</span></div>
            <div class="small muted">Calculer le solde puis determiner l’etat.</div>
          </div>
          <div>
            <div style="display:grid; gap:8px">
              <input id="q3_sol_${c.id}" type="number" inputmode="numeric" placeholder="Solde (recettes - depenses)" />
              <select id="q3_eta_${c.id}">
                <option value="">Etat du budget</option>
                ${ETATS.map(x=>`<option value="${x.v}">${x.t}</option>`).join("")}
              </select>
            </div>
          </div>
        `;
        host.appendChild(row);
      });
    }

    function buildQ4(){
      const host = $("#q4rows");
      host.innerHTML = "";
      q4Cons.forEach(k=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <b>${k.text}</b>
          </div>
          <div>
            <label class="small" for="q4_${k.id}">Etat correspondant</label>
            <select id="q4_${k.id}">
              <option value="">Selectionner</option>
              ${ETATS.map(x=>`<option value="${x.v}">${x.t}</option>`).join("")}
            </select>
          </div>
        `;
        host.appendChild(row);
      });
    }

    function bindAll(){
      // q1
      q1Items.forEach(it=>{
        const sel = $(`#q1_${it.id}`);
        sel.addEventListener("change", ()=>{
          state.q1[it.id] = sel.value;
          save();
        });
      });

      // q2
      q2Situations.forEach(s=>{
        ["sol","cmp","eta"].forEach(kind=>{
          const sel = $(`#q2_${kind}_${s.id}`);
          sel.addEventListener("change", ()=>{
            state.q2[s.id] = state.q2[s.id] || {};
            if(kind==="sol") state.q2[s.id].solde = sel.value;
            if(kind==="cmp") state.q2[s.id].comp = sel.value;
            if(kind==="eta") state.q2[s.id].etat = sel.value;
            save();
          });
        });
      });

      // q3
      q3Cases.forEach(c=>{
        const sol = $(`#q3_sol_${c.id}`);
        const eta = $(`#q3_eta_${c.id}`);
        sol.addEventListener("input", ()=>{
          state.q3[c.id] = state.q3[c.id] || {};
          state.q3[c.id].solde = sol.value;
          save();
        });
        eta.addEventListener("change", ()=>{
          state.q3[c.id] = state.q3[c.id] || {};
          state.q3[c.id].etat = eta.value;
          save();
        });
      });

      // q4
      q4Cons.forEach(k=>{
        const sel = $(`#q4_${k.id}`);
        sel.addEventListener("change", ()=>{
          state.q4[k.id] = sel.value;
          save();
        });
      });

      // q5
      $("#q5txt").addEventListener("input", ()=>{
        state.q5.text = $("#q5txt").value;
        save();
      });
      $("#btnHelp").addEventListener("click", helpQ5);
    }

    function applyLoaded(){
      setDys(!!state.dys);

      q1Items.forEach(it=>{
        $(`#q1_${it.id}`).value = state.q1[it.id] || "";
      });

      q2Situations.forEach(s=>{
        const o = state.q2[s.id] || {};
        $(`#q2_sol_${s.id}`).value = o.solde || "";
        $(`#q2_cmp_${s.id}`).value = o.comp || "";
        $(`#q2_eta_${s.id}`).value = o.etat || "";
      });

      q3Cases.forEach(c=>{
        const o = state.q3[c.id] || {};
        $(`#q3_sol_${c.id}`).value = (o.solde ?? "");
        $(`#q3_eta_${c.id}`).value = o.etat || "";
      });

      q4Cons.forEach(k=>{
        $(`#q4_${k.id}`).value = state.q4[k.id] || "";
      });

      $("#q5txt").value = state.q5.text || "";
    }

    function mkLine(fb, text, ok, warn){
      const line = document.createElement("div");
      line.className = "fbLine";
      line.textContent = text;
      if(ok){
        line.style.borderColor = "rgba(22,163,74,.28)";
        line.style.background = "rgba(22,163,74,.06)";
      }else if(warn){
        line.style.borderColor = "rgba(180,83,9,.28)";
        line.style.background = "rgba(180,83,9,.06)";
      }else{
        line.style.borderColor = "rgba(220,38,38,.28)";
        line.style.background = "rgba(220,38,38,.06)";
      }
      fb.appendChild(line);
    }

    function correctQ1(){
      const fb = $("#q1fb");
      fb.innerHTML = "";
      let good = 0;
      q1Items.forEach(it=>{
        const val = state.q1[it.id] || "";
        const ok = val === it.answer;
        if(ok) good++;
        mkLine(fb, ok ? "Correct" : "A revoir", ok, !ok && val!=="");
      });
      const pts = Math.round((good / q1Items.length) * 3);
      tag($("#q1tag"), pts===3 ? "ok" : (pts>=2 ? "warnTag" : "bad"), `Score : ${pts} / 3`);
      return pts;
    }

    function correctQ2(){
      const fb = $("#q2fb");
      fb.innerHTML = "";
      let good = 0;
      const totalChecks = q2Situations.length * 3;

      q2Situations.forEach(s=>{
        const o = state.q2[s.id] || {};
        const ok1 = (o.solde || "") === s.ans.solde;
        const ok2 = (o.comp || "") === s.ans.comp;
        const ok3 = (o.etat || "") === s.ans.etat;
        good += [ok1,ok2,ok3].filter(Boolean).length;

        const line = document.createElement("div");
        line.className = "fbLine";
        const status = (ok1 && ok2 && ok3) ? "correct" : "a revoir";
        line.textContent = `Situation : ${status}`;
        line.style.borderColor = (ok1 && ok2 && ok3) ? "rgba(22,163,74,.28)" : "rgba(220,38,38,.28)";
        line.style.background = (ok1 && ok2 && ok3) ? "rgba(22,163,74,.06)" : "rgba(220,38,38,.06)";
        fb.appendChild(line);
      });

      const pts = Math.round((good / totalChecks) * 6);
      tag($("#q2tag"), pts===6 ? "ok" : (pts>=4 ? "warnTag" : "bad"), `Score : ${pts} / 6`);
      return pts;
    }

    function correctQ3(){
      const fb = $("#q3fb");
      fb.innerHTML = "";
      let good = 0;
      const totalChecks = q3Cases.length * 2;

      q3Cases.forEach(c=>{
        const o = state.q3[c.id] || {};
        const sol = Number(o.solde);
        const ok1 = Number.isFinite(sol) && sol === c.solde;
        const ok2 = (o.etat || "") === c.etat;
        good += [ok1,ok2].filter(Boolean).length;

        const line = document.createElement("div");
        line.className = "fbLine";
        const status = (ok1 && ok2) ? "correct" : "a revoir";
        line.textContent = `Cas ${c.id.toUpperCase()} : ${status}`;
        line.style.borderColor = (ok1 && ok2) ? "rgba(22,163,74,.28)" : "rgba(220,38,38,.28)";
        line.style.background = (ok1 && ok2) ? "rgba(22,163,74,.06)" : "rgba(220,38,38,.06)";
        fb.appendChild(line);
      });

      const pts = Math.round((good / totalChecks) * 6);
      tag($("#q3tag"), pts===6 ? "ok" : (pts>=4 ? "warnTag" : "bad"), `Score : ${pts} / 6`);
      return pts;
    }

    function correctQ4(){
      const fb = $("#q4fb");
      fb.innerHTML = "";
      let good = 0;
      q4Cons.forEach(k=>{
        const val = state.q4[k.id] || "";
        const ok = val === k.answer;
        if(ok) good++;
        const line = document.createElement("div");
        line.className = "fbLine";
        line.textContent = ok ? "Correct" : "A revoir";
        line.style.borderColor = ok ? "rgba(22,163,74,.28)" : "rgba(220,38,38,.28)";
        line.style.background = ok ? "rgba(22,163,74,.06)" : "rgba(220,38,38,.06)";
        fb.appendChild(line);
      });
      const pts = Math.round((good / q4Cons.length) * 3);
      tag($("#q4tag"), pts===3 ? "ok" : (pts>=2 ? "warnTag" : "bad"), `Score : ${pts} / 3`);
      return pts;
    }

    function helpQ5(){
      const t = ($("#q5txt").value || "").trim();
      const fb = $("#q5fb");
      fb.innerHTML = "";

      const hasRule = /(recettes|revenus).*(superieur|plus).*depenses/i.test(t) || /(depenses).*(inferieur|moins).*(recettes|revenus)/i.test(t);
      const hasReserve = /(reserve|epargne|imprevus)/i.test(t);
      const hasExample = /(exemple|par exemple|ex:|ex\.|comme)/i.test(t);
      const lenOk = t.length >= 220;

      const mk = (ok, good, bad)=>{
        const d = document.createElement("div");
        d.className = "fbLine";
        d.textContent = ok ? good : bad;
        d.style.borderColor = ok ? "rgba(22,163,74,.28)" : "rgba(180,83,9,.28)";
        d.style.background = ok ? "rgba(22,163,74,.06)" : "rgba(180,83,9,.06)";
        fb.appendChild(d);
      };

      mk(lenOk, "Longueur : suffisante", "Longueur : ecrire un peu plus");
      mk(hasRule, "Regle : recettes et depenses bien expliquees", "Regle : ecrire que recettes doivent etre superieures aux depenses");
      mk(hasReserve, "Reserve : epargne / imprevus mentionnes", "Reserve : ajouter epargne / imprevus");
      mk(hasExample, "Exemple : present", "Exemple : ajouter un exemple concret");

      tag($("#q5tag"), (lenOk && hasRule && hasReserve && hasExample) ? "ok" : "warnTag", "A rendre (enseignant)");
      computeProgress();
    }

    function computeProgress(){
      const q1Done = q1Items.every(it => (state.q1[it.id] || "") !== "");
      const q2Done = q2Situations.every(s => {
        const o = state.q2[s.id] || {};
        return (o.solde||"") && (o.comp||"") && (o.etat||"");
      });
      const q3Done = q3Cases.every(c => {
        const o = state.q3[c.id] || {};
        return (o.solde ?? "") !== "" && (o.etat || "") !== "";
      });
      const q4Done = q4Cons.every(k => (state.q4[k.id] || "") !== "");
      const q5Done = ($("#q5txt").value || "").trim().length > 0;

      const done = [q1Done,q2Done,q3Done,q4Done,q5Done].filter(Boolean).length;
      const pct = Math.round((done/5)*100);
      $("#bar").style.width = pct + "%";
    }

    function updateGlobalScore(){
      const p1 = correctQ1();
      const p2 = correctQ2();
      const p3 = correctQ3();
      const p4 = correctQ4();
      const total = p1+p2+p3+p4;
      $("#globalScore").textContent = `Score : ${total} / 18`;
      return total;
    }

    function finalScore(){
      const total = updateGlobalScore();
      computeProgress();

      const fb = $("#finalFb");
      fb.innerHTML = "";
      const line = document.createElement("div");
      line.className = "fbLine";
      line.style.borderColor = "rgba(15,118,110,.28)";
      line.style.background = "rgba(15,118,110,.06)";
      line.innerHTML = `<b>Score auto</b> : <span class="mono">${total} / 18</span> • Note finale : <span class="mono">${total} / 18</span> + points C6 (0 a 2) par l’enseignant`;
      fb.appendChild(line);
    }

    function exportCopy(){
      const p1 = correctQ1();
      const p2 = correctQ2();
      const p3 = correctQ3();
      const p4 = correctQ4();
      const total18 = p1+p2+p3+p4;

      const lines = [];
      lines.push("PSE D2 - Etat du budget");
      lines.push("Nom : ____________________   Prenom : ____________________   Classe : __________");
      lines.push("");

      lines.push("Exercice 1");
      q1Items.forEach(it=>{
        lines.push(`- ${it.text} -> ${state.q1[it.id] || ""}`);
      });
      lines.push(`Score auto : ${p1}/3`);
      lines.push("");

      lines.push("Exercice 2");
      q2Situations.forEach(s=>{
        const o = state.q2[s.id] || {};
        lines.push(`- ${s.text}`);
        lines.push(`  Solde : ${o.solde || ""} ; Depenses vs recettes : ${o.comp || ""} ; Etat : ${o.etat || ""}`);
      });
      lines.push(`Score auto : ${p2}/6`);
      lines.push("");

      lines.push("Exercice 3");
      q3Cases.forEach(c=>{
        const o = state.q3[c.id] || {};
        lines.push(`- Cas ${c.id.toUpperCase()} (R ${c.recettes} / D ${c.depenses}) -> Solde ${o.solde ?? ""} ; Etat ${o.etat || ""}`);
      });
      lines.push(`Score auto : ${p3}/6`);
      lines.push("");

      lines.push("Exercice 4");
      q4Cons.forEach(k=>{
        lines.push(`- ${k.text} -> ${state.q4[k.id] || ""}`);
      });
      lines.push(`Score auto : ${p4}/3`);
      lines.push("");

      lines.push("Exercice 5 (C6)");
      lines.push($("#q5txt").value || "");
      lines.push("Points C6 : +0 a +2 (enseignant)");
      lines.push("");

      lines.push(`Total auto : ${total18}/18`);
      lines.push("Fin");

      const blob = new Blob([lines.join("\n")], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "copie_pse_etat_budget.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function bindCorrectors(){
      $all("[data-correct]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.correct;
          if(id==="q1") correctQ1();
          if(id==="q2") correctQ2();
          if(id==="q3") correctQ3();
          if(id==="q4") correctQ4();
          $("#globalScore").textContent = `Score : ${correctQ1()+correctQ2()+correctQ3()+correctQ4()} / 18`;
          computeProgress();
        });
      });
    }

    function init(){
      load();

      buildQ1();
      buildQ2();
      buildQ3();
      buildQ4();

      bindAll();
      applyLoaded();
      bindCorrectors();

      $("#btnDys").addEventListener("click", ()=> setDys(!state.dys));
      $("#btnReset").addEventListener("click", resetAll);
      $("#btnFinal").addEventListener("click", finalScore);
      $("#btnExport").addEventListener("click", exportCopy);

      window.addEventListener("click", computeProgress);
      window.addEventListener("keyup", computeProgress);

      computeProgress();
      $("#globalScore").textContent = `Score : ${correctQ1()+correctQ2()+correctQ3()+correctQ4()} / 18`;
    }

    init();
  </script>
</body>
</html>
