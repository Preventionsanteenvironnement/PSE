<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSE CAP - Gestion du Budget</title>
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #334155;
      --primary: #0f766e;
      --secondary: #0ea5e9;
      --accent: #f59e0b;
      --success: #22c55e;
      --error: #ef4444;
      --line: #e2e8f0;
      --radius: 12px;
      --font: "Verdana", sans-serif;
    }
    body{
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 15px;
      line-height: 1.6;
    }
    .container{ max-width: 900px; margin: 0 auto; }

    /* En-t√™te */
    header{
      background: white;
      border-left: 6px solid var(--primary);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 25px;
    }
    h1{ margin: 0; color: var(--primary); font-size: 1.6rem; }
    .intro{ font-size: 0.95rem; color: #64748b; margin-top: 5px; }

    /* Zone de cours (M√©mos) */
    .memo-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }
    @media(min-width: 700px){ .memo-grid{ grid-template-columns: 1fr 1fr; } }

    .memo-card{
      background: #fff;
      padding: 15px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      font-size: 0.9rem;
    }
    .memo-title{ font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .tag{ padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white;}
    
    .bg-fixe{ background: #dc2626; }
    .bg-courante{ background: #ea580c; }
    .bg-occas{ background: #16a34a; }
    .bg-social{ background: #7c3aed; }
    .bg-travail{ background: #2563eb; }

    /* Zone Exercice */
    .exercise-section{
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .question-block{
      border-bottom: 1px solid var(--line);
      padding: 20px 0;
    }
    .question-block:last-child{ border-bottom: none; }

    .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .q-title-row { display: flex; align-items: center; gap: 10px; }
    .q-title{ font-size: 1.1rem; font-weight: bold; }
    
    /* Bouton Audio */
    .btn-audio {
      background: #e0f2fe;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: transform 0.2s, background 0.2s;
      color: var(--secondary);
    }
    .btn-audio:hover { transform: scale(1.1); background: #bae6fd; }
    .btn-audio:active { transform: scale(0.95); }

    .q-context{ font-style: italic; color: #64748b; margin-bottom: 15px; display: block; }

    .btn-group{ display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    
    .btn{
      border: 2px solid var(--line);
      background: white;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
      transition: all 0.2s;
    }
    .btn:hover{ background: #f1f5f9; border-color: #cbd5e1; }
    
    .btn.correct{ background: #dcfce7; border-color: #22c55e; color: #15803d; pointer-events: none; }
    .btn.wrong{ background: #fee2e2; border-color: #ef4444; color: #991b1b; animation: shake 0.3s; }
    .btn.inactive{ opacity: 0.5; pointer-events: none; }

    .feedback{
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }
    .fb-hint{ background: #fff7ed; border-left: 4px solid var(--accent); color: #9a3412; }
    .fb-success{ background: #f0fdf4; border-left: 4px solid var(--success); color: #166534; }
    .fb-sol{ background: #eff6ff; border-left: 4px solid var(--secondary); color: #1e40af; }

    .btn-sos{
      background: transparent;
      border: none;
      text-decoration: underline;
      color: #64748b;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 8px;
      display: none;
    }
    .btn-sos:hover{ color: var(--secondary); }

    .progress-container{
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-top: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(5px);
      margin: 0 -15px -15px -15px;
      border-radius: 0 0 var(--radius) var(--radius);
      z-index: 100;
    }
    .bar-bg{ flex: 1; height: 10px; background: #e2e8f0; border-radius: 5px; margin: 0 15px; overflow: hidden; }
    .bar-fill{ height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.4s ease; }

    @keyframes shake {
      0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
    }

    /* --- STYLE ZONE ENVOI --- */
    #pse-envoi-prof {
      margin: 30px auto 20px;
      padding: 20px;
      background: #f0f9ff;
      border: 2px solid #0ea5e9;
      border-radius: 12px;
      text-align: center;
    }
    #pse-envoi-prof h3 { margin-top: 0; color: #0369a1; }
    .input-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
    .input-field { padding: 10px; border: 1px solid #ccc; border-radius: 8px; flex: 1; min-width: 150px; }
    #pse-btn-envoyer {
      padding: 12px 25px; background: #0284c7; color: #fff; border: none; border-radius: 50px;
      font-weight: 700; cursor: pointer; transition: 0.3s;
    }
    #pse-btn-envoyer:hover { background: #0369a1; }
    #pse-msg { margin-top: 10px; font-weight: bold; min-height: 20px; }

  </style>
</head>
<body>

<div class="container">

  <header>
    <h1>üí∞ G√©rer son Budget (CAP)</h1>
    <span class="intro">Entra√Æne-toi √† identifier les revenus, classer les d√©penses et √©quilibrer un budget.</span>
  </header>

  <section class="memo-grid">
    <div class="memo-card">
      <div class="memo-title"><span class="tag bg-travail">REVENU TRAVAIL</span> vs <span class="tag bg-social">REVENU SOCIAL</span></div>
      <ul style="padding-left: 20px; margin: 5px 0;">
        <li><b>Travail :</b> Salaire, primes, r√©mun√©ration des ind√©pendants.</li>
        <li><b>Social :</b> Aides de l'√âtat (Allocations familiales, Ch√¥mage, Retraite, Bourse).</li>
      </ul>
    </div>
    <div class="memo-card">
      <div class="memo-title">LES 3 TYPES DE D√âPENSES</div>
      <ul style="padding-left: 20px; margin: 5px 0;">
        <li><b style="color:#dc2626">Fixes :</b> Obligatoires & Incompressibles (Loyer, Assurances).</li>
        <li><b style="color:#ea580c">Courantes :</b> Obligatoires mais Compressibles (Alimentation, Essence).</li>
        <li><b style="color:#16a34a">Occasionnelles :</b> √âquipement & Plaisir (V√™tements, Cadeaux).</li>
      </ul>
    </div>
  </section>

  <section class="exercise-section" id="quiz-container">
    </section>

  <div id="pse-envoi-prof">
    <h3>üöÄ Envoyer mon r√©sultat</h3>
    <div class="input-row">
      <input type="text" id="pse-eleve-code" class="input-field" placeholder="Identifiant (ex: P12)" autocomplete="off">
      
      <select id="pse-eleve-classe" class="input-field">
        <option value="">-- Ma classe --</option>
        <option value="CAP 1">CAP 1</option>
        <option value="CAP 2">CAP 2</option>
        <option value="2nde Bac Pro">2nde Bac Pro</option>
        <option value="1√®re Bac Pro">1√®re Bac Pro</option>
        <option value="Tle Bac Pro">Tle Bac Pro</option>
        <option value="Autre">Autre</option>
      </select>
    </div>
    <button id="pse-btn-envoyer">Envoyer au professeur üì§</button>
    <div id="pse-msg"></div>
  </div>

  <div class="progress-container">
    <div id="score-display" style="font-weight:bold; color:var(--text)">Score : 0/0</div>
    <div class="bar-bg"><div class="bar-fill" id="progress-bar"></div></div>
    <div style="font-size:0.8rem; color:#64748b">Continue comme √ßa !</div>
  </div>

</div>

<script>
  /* --- GESTION AUDIO (Synth√®se vocale) --- */
  function speakText(text) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'fr-FR'; 
      utterance.rate = 0.9;     
      utterance.pitch = 1;
      window.speechSynthesis.speak(utterance);
    } else {
      alert("D√©sol√©, votre navigateur ne supporte pas la lecture audio.");
    }
  }

  /* --- DONN√âES BAS√âES SUR TES IMAGES --- */
  const questions = [
    // PARTIE 1 : REVENUS
    {
      id: 1,
      category: "Revenus",
      title: "Allocations familiales",
      context: "Ronan et Rose re√ßoivent 462‚Ç¨ pour leurs 4 enfants.",
      type: "choix",
      options: ["Revenu li√© au travail", "Revenu social"],
      correct: "Revenu social",
      indice1: "Cet argent vient de l'√âtat pour aider la famille, pas d'un employeur.",
      indice2: "C'est une prestation sociale (comme sur le document A).",
      expli: "C'est un <b>Revenu Social</b>. C'est une aide de l'√âtat redistribu√©e aux familles."
    },
    {
      id: 2,
      category: "Revenus",
      title: "Salaire de Laetitia",
      context: "Laetitia est h√¥tesse de caisse et re√ßoit 1280‚Ç¨ √† la fin du mois.",
      type: "choix",
      options: ["Revenu li√© au travail", "Revenu social"],
      correct: "Revenu li√© au travail",
      indice1: "Elle re√ßoit cet argent en √©change d'une activit√© productive chez un employeur.",
      indice2: "Sur le document A, le salaire est class√© dans les revenus d'activit√©.",
      expli: "C'est un <b>Revenu du travail</b> (salaire) car elle travaille pour un employeur."
    },
    
    // PARTIE 2 : D√âPENSES
    {
      id: 3,
      category: "D√©penses",
      title: "Loyer de l'appartement",
      context: "315,20 ‚Ç¨ √† payer tous les mois au propri√©taire.",
      type: "choix",
      options: ["D√©pense Fixe", "D√©pense Courante", "D√©pense Occasionnelle"],
      correct: "D√©pense Fixe",
      indice1: "C'est une d√©pense obligatoire et 'incompressible' (tu ne peux pas changer le montant).",
      indice2: "Regarde la colonne de gauche du budget de Carla.",
      expli: "C'est une <b>Charge Fixe</b>. C'est obligatoire et le montant est stable chaque mois."
    },
    {
      id: 4,
      category: "D√©penses",
      title: "Courses Alimentaires",
      context: "Achat de nourriture au supermarch√©.",
      type: "choix",
      options: ["D√©pense Fixe", "D√©pense Courante", "D√©pense Occasionnelle"],
      correct: "D√©pense Courante",
      indice1: "C'est obligatoire (il faut manger) mais c'est 'compressible'.",
      indice2: "Tu peux r√©duire cette d√©pense en achetant des produits moins chers.",
      expli: "C'est une <b>D√©pense Courante</b>. C'est vital, mais on peut agir sur le montant (marques, quantit√©s)."
    },
    {
      id: 5,
      category: "D√©penses",
      title: "Achat d'un cadeau",
      context: "Pour l'anniversaire d'un ami.",
      type: "choix",
      options: ["D√©pense Fixe", "D√©pense Courante", "D√©pense Occasionnelle"],
      correct: "D√©pense Occasionnelle",
      indice1: "Ce n'est pas tous les mois. On peut le remettre √† plus tard.",
      indice2: "Cela fait partie des d√©penses d'√©quipement ou de renouvellement.",
      expli: "C'est une <b>D√©pense Occasionnelle</b> (ou d'√©quipement). Ce n'est pas vital et c'est irr√©gulier."
    },

    // PARTIE 3 : √âTAT DU BUDGET
    {
      id: 6,
      category: "Budget",
      title: "Situation de Coumba",
      context: "D√©penses > Recettes. Elle ne peut plus payer ses factures.",
      type: "choix",
      options: ["Budget √âquilibr√©", "Budget Exc√©dentaire", "Budget D√©ficitaire"],
      correct: "Budget D√©ficitaire",
      indice1: "La balance penche du c√¥t√© rouge (D√©penses).",
      indice2: "Le solde est n√©gatif. Elle d√©pense plus qu'elle ne gagne.",
      expli: "Le budget est <b>D√©ficitaire</b>. Attention au risque de surendettement !"
    },
    {
      id: 7,
      category: "Budget",
      title: "Situation de No√©mie",
      context: "Recettes > D√©penses. Elle met 25‚Ç¨ de c√¥t√© sur son livret.",
      type: "choix",
      options: ["Budget √âquilibr√©", "Budget Exc√©dentaire", "Budget D√©ficitaire"],
      correct: "Budget Exc√©dentaire",
      indice1: "Il lui reste de l'argent √† la fin du mois (Solde positif).",
      indice2: "La balance penche du c√¥t√© bleu (Ressources).",
      expli: "Le budget est <b>Exc√©dentaire</b>. C'est parfait pour √©pargner en cas d'impr√©vu."
    }
  ];

  /* --- MOTEUR DE L'EXERCICE --- */
  const container = document.getElementById('quiz-container');
  let score = 0;
  
  function initQuiz(){
    // On annule toute lecture en cours au chargement
    if('speechSynthesis' in window) window.speechSynthesis.cancel();

    document.getElementById('score-display').innerText = `Score : 0 / ${questions.length}`;
    
    questions.forEach((q, index) => {
      // Texte √† lire : Titre + Contexte
      const textToRead = `${q.title}. ${q.context}`;
      const safeText = textToRead.replace(/'/g, "\\'").replace(/"/g, '&quot;');

      // Structure HTML de la question
      const div = document.createElement('div');
      div.className = 'question-block';
      div.innerHTML = `
        <div class="q-header">
          <div style="font-size:0.8rem; text-transform:uppercase; color:#94a3b8; font-weight:bold">${q.category}</div>
          <div style="font-size:0.8rem; background:#f1f5f9; padding:2px 8px; border-radius:10px">Question ${index+1}</div>
        </div>
        
        <div class="q-title-row">
            <div class="q-title">${q.title}</div>
            <button class="btn-audio" onclick="speakText('${safeText}')" title="√âcouter la question">üîä</button>
        </div>
        
        <span class="q-context">${q.context}</span>
        
        <div class="btn-group" id="opts-${q.id}">
          ${q.options.map(opt => `<button class="btn" onclick="checkAnswer(${q.id}, '${opt}', this)">${opt}</button>`).join('')}
        </div>

        <div id="fb-${q.id}" class="feedback"></div>
        <button id="sos-${q.id}" class="btn-sos" onclick="giveSolution(${q.id})">Je bloque, voir la r√©ponse</button>
      `;
      container.appendChild(div);
      
      q.attempts = 0;
      q.solved = false;
    });
  }

  function checkAnswer(id, answer, btn){
    const q = questions.find(item => item.id === id);
    if(q.solved) return;

    const fb = document.getElementById(`fb-${id}`);
    const sos = document.getElementById(`sos-${id}`);
    const group = document.getElementById(`opts-${id}`);

    if(answer === q.correct){
      // GAGN√â
      btn.classList.add('correct');
      fb.style.display = 'block';
      fb.className = 'feedback fb-success';
      fb.innerHTML = `<b>Bravo !</b> ${q.expli}`;
      
      Array.from(group.children).forEach(b => {
        if(b !== btn) b.classList.add('inactive');
      });
      
      sos.style.display = 'none';
      q.solved = true;
      if(q.attempts === 0) score++; 
      else score += 0.5; 
      
      updateGlobalScore();
      
    } else {
      // PERDU
      q.attempts++;
      btn.classList.add('wrong');
      
      fb.style.display = 'block';
      fb.className = 'feedback fb-hint';
      
      if(q.attempts === 1){
        fb.innerHTML = `‚ö†Ô∏è Pas tout √† fait. <b>Indice :</b> ${q.indice1}`;
      } else {
        fb.innerHTML = `‚ö†Ô∏è Toujours pas. <b>Indice :</b> ${q.indice2}`;
        sos.style.display = 'inline-block'; 
      }
    }
  }

  function giveSolution(id){
    const q = questions.find(item => item.id === id);
    if(q.solved) return;
    
    const fb = document.getElementById(`fb-${id}`);
    const sos = document.getElementById(`sos-${id}`);
    const group = document.getElementById(`opts-${id}`);
    
    q.solved = true;
    
    fb.style.display = 'block';
    fb.className = 'feedback fb-sol';
    fb.innerHTML = `<b>Solution :</b> La bonne r√©ponse √©tait <b>${q.correct}</b>.<br/>${q.expli}`;
    sos.style.display = 'none';
    
    Array.from(group.children).forEach(b => {
      if(b.innerText === q.correct) b.classList.add('correct');
      else b.classList.add('inactive');
    });
    
    updateGlobalScore();
  }

  function updateGlobalScore(){
    const solvedCount = questions.filter(q => q.solved).length;
    const percent = (solvedCount / questions.length) * 100;
    
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('score-display').innerText = `Score : ${score} / ${questions.length}`;
  }

  // Lancement
  initQuiz();
</script>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const codeEl = document.getElementById("pse-eleve-code");
  const classeEl = document.getElementById("pse-eleve-classe");
  const btn = document.getElementById("pse-btn-envoyer");
  const msg = document.getElementById("pse-msg");

  const LS_CODE = "pse_code_eleve";
  const LS_CLASSE = "pse_classe_eleve";

  // Initialisation au chargement
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", loadSavedData);
  } else {
    loadSavedData();
  }

  function loadSavedData() {
    try {
      const savedCode = localStorage.getItem(LS_CODE);
      const savedClasse = localStorage.getItem(LS_CLASSE);
      if (savedCode) codeEl.value = savedCode;
      if (savedClasse) classeEl.value = savedClasse;
    } catch (e) { console.warn("LocalStorage indisponible"); }
  }

  btn.addEventListener("click", async () => {
    const code = (codeEl.value || "").trim();
    const classe = (classeEl.value || "").trim();

    if (!code || !classe) {
      msg.style.color = "#dc2626";
      msg.textContent = "‚ö†Ô∏è Merci de remplir ton Identifiant et ta Classe.";
      return;
    }

    // Sauvegarde locale
    try {
      localStorage.setItem(LS_CODE, code);
      localStorage.setItem(LS_CLASSE, classe);
    } catch (e) {}

    // Feedback visuel
    btn.disabled = true;
    btn.style.opacity = "0.7";
    msg.style.color = "#0284c7";
    msg.textContent = "Envoi en cours...";

    try {
      /* ENVOI CORRECT VERS LA COLLECTION BACPRO */
      await addDoc(collection(db, "bacpro"), {
        meta: {
          createdAt: new Date().toISOString(),
          nom: code,          // Code mis dans 'nom' pour que le prof le voie
          prenom: "",         
          classe: classe,
          type: "exercice",
          support: "Gestion_Budget_CAP"
        },
        resultat: {
          score: score + " / " + questions.length,
          url: location.href,
          titre: document.title
        }
      });

      msg.style.color = "#16a34a";
      msg.textContent = "‚úÖ R√©sultat envoy√© ! (Tu peux renvoyer si tu am√©liores ton score)";
      
      setTimeout(() => {
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.textContent = "Renvoyer le nouveau score üì§";
      }, 2000);

    } catch (e) {
      console.error(e);
      msg.style.color = "#dc2626";
      msg.textContent = "Erreur de connexion. R√©essaie.";
      btn.disabled = false;
      btn.style.opacity = "1";
    }
  });
</script>

</body>
</html>
