<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Module C9 : Les Risques Psychosociaux (RPS)</title>
  <style>
    :root {
      --primary: #4f46e5; /* Indigo */
      --secondary: #eef2ff;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #1f2937;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --radius: 12px;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      margin: 0;
      padding: 15px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Cartes G√©n√©rales */
    .card {
      background: var(--card);
      padding: 25px;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
    }

    h1 {
      text-align: center;
      color: var(--primary);
      font-size: 1.8rem;
      margin: 0 0 10px 0;
    }

    h2 {
      color: var(--primary);
      font-size: 1.3rem;
      border-bottom: 2px solid var(--secondary);
      padding-bottom: 8px;
      margin-top: 0;
    }

    h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: #374151;
    }

    /* En-t√™te P√©dagogique */
    .header-info {
      background-color: var(--secondary);
      border-left: 5px solid var(--primary);
      padding: 15px;
      border-radius: var(--radius);
    }
    .header-info p { margin: 5px 0; }

    /* Identification */
    .identity-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #4b5563;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      background-color: #fff;
      box-sizing: border-box; /* Important pour mobile */
    }

    /* Questions / Exercices */
    .question-item {
      background-color: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid var(--border);
    }
    
    .question-label {
      font-weight: 600;
      margin-bottom: 10px;
      display: block;
    }

    select.answer-select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--primary);
      color: var(--primary);
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Radios & Checkboxes */
    .options-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .option-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .option-label:hover { background: #f3f4f6; }
    input[type="radio"], input[type="checkbox"] { transform: scale(1.2); }

    /* Correction & Feedback */
    .feedback {
      margin-top: 10px;
      padding: 12px;
      border-radius: 6px;
      font-size: 0.95rem;
      display: none; /* Cach√© par d√©faut */
    }
    .fb-correct {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    .fb-incorrect {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .correct-answer-display {
      font-weight: bold;
      margin-top: 5px;
      display: block;
    }

    /* R√©sultat Final */
    .result-section {
      text-align: center;
      background: #312e81; /* Indigo fonc√© */
      color: white;
      padding: 30px;
      border-radius: var(--radius);
      margin-top: 20px;
    }
    
    #final-score {
      font-size: 2.5rem;
      font-weight: 800;
      margin: 10px 0;
      color: #818cf8;
    }

    #btn-action {
      background-color: var(--success);
      color: white;
      border: none;
      padding: 18px 36px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    #btn-action:hover { transform: translateY(-2px); filter: brightness(1.1); }
    #btn-action:active { transform: scale(0.98); }
    #btn-action:disabled { background-color: #9ca3af; cursor: not-allowed; }

    .error-msg {
      color: #fca5a5;
      font-weight: bold;
      margin-bottom: 10px;
      display: none;
    }

    /* Audio Button (Optionnel) */
    .btn-audio {
      background: none;
      border: 2px solid #e0e7ff;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 10px;
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-audio:hover { background: #e0e7ff; }

    @media (max-width: 600px) {
      .identity-grid { grid-template-columns: 1fr; }
      h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

<div class="container">

  <div class="card">
    <h1>Module C9 : Les Risques Psychosociaux (RPS)</h1>
    <div class="header-info">
      <p><strong>Objectif :</strong> Identifier les facteurs de risques, les cons√©quences et les mesures de pr√©vention.</p>
      <p><strong>Comp√©tences :</strong> C1 (Traiter l'information) - C4 (Analyser une situation).</p>
    </div>

    <div class="identity-grid">
      <div class="form-group">
        <label for="student-id">Identifiant √©l√®ve *</label>
        <input type="text" id="student-id" placeholder="Ex: P12, NOM Pr√©nom...">
      </div>
      <div class="form-group">
        <label for="student-class">Classe *</label>
        <select id="student-class">
          <option value="">-- Choisir --</option>
          <option value="2BACPRO_GATL1">2BACPRO_GATL1</option>
          <option value="2BACPRO_GATL2">2BACPRO_GATL2</option>
          <option value="1BACPRO_AGO1">1BACPRO_AGO1</option>
          <option value="1BACPRO_AGO2">1BACPRO_AGO2</option>
          <option value="TBACPRO_AGO1">TBACPRO_AGO1</option>
          <option value="TBACPRO_AGO2">TBACPRO_AGO2</option>
          <option value="2_MELEC">2_MELEC</option>
          <option value="1_MELEC">1_MELEC</option>
          <option value="T_MELEC">T_MELEC</option>
          <option value="CAP_PSR1">CAP_PSR1</option>
          <option value="CAP_PSR2">CAP_PSR2</option>
          <option value="CAP_VAN1">CAP_VAN1</option>
          <option value="CAP_VAN2">CAP_VAN2</option>
          <option value="CAP_CAN1">CAP_CAN1</option>
          <option value="CAP_CAN2">CAP_CAN2</option>
          <option value="CAP_HORT1">CAP_HORT1</option>
          <option value="CAP_HORT2">CAP_HORT2</option>
          <option value="CAP_JP1">CAP_JP1</option>
          <option value="CAP_JP2">CAP_JP2</option>
          <option value="Autre">Autre</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Exercice 1 ‚Äî Identifier les Facteurs de Risques (5 pts) <button class="btn-audio" onclick="speak('Pour chaque situation, choisis le type de facteur de risque correspondant.')">üîà</button></h2>
    <p>Indique pour chaque situation s'il s'agit de Stress (Organisation), Violence Interne (Relations) ou Violence Externe.</p>

    <div class="question-item">
      <span class="question-label">1. Un client insulte le vendeur au comptoir.</span>
      <select id="q1-1" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence Interne</option>
        <option value="externe">Violence Externe</option>
      </select>
      <div id="fb-q1-1" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">2. Marc est surcharg√© de travail et manque d'autonomie.</span>
      <select id="q1-2" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence Interne</option>
        <option value="externe">Violence Externe</option>
      </select>
      <div id="fb-q1-2" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">3. Deux coll√®gues se disputent violemment dans l'atelier.</span>
      <select id="q1-3" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence Interne</option>
        <option value="externe">Violence Externe</option>
      </select>
      <div id="fb-q1-3" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">4. Harc√®lement moral de la part d'un sup√©rieur.</span>
      <select id="q1-4" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence Interne</option>
        <option value="externe">Violence Externe</option>
      </select>
      <div id="fb-q1-4" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">5. Agression physique par un usager lors d'une intervention.</span>
      <select id="q1-5" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence Interne</option>
        <option value="externe">Violence Externe</option>
      </select>
      <div id="fb-q1-5" class="feedback"></div>
    </div>
  </div>

  <div class="card">
    <h2>Exercice 2 ‚Äî Classer les Cons√©quences (5 pts) <button class="btn-audio" onclick="speak('Indique si la cons√©quence concerne la sant√© du salari√© ou l\'entreprise.')">üîà</button></h2>
    
    <div class="question-item">
      <span class="question-label">1. D√©pression ou Burn-out</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-1" value="sante"> Sant√© du Salari√©</label>
        <label class="option-label"><input type="radio" name="q2-1" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-1" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">2. Augmentation de l'absent√©isme</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-2" value="sante"> Sant√© du Salari√©</label>
        <label class="option-label"><input type="radio" name="q2-2" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-2" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">3. Troubles musculo-squelettiques (TMS) / Mal de dos</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-3" value="sante"> Sant√© du Salari√©</label>
        <label class="option-label"><input type="radio" name="q2-3" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-3" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">4. Baisse de la productivit√© et de la qualit√©</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-4" value="sante"> Sant√© du Salari√©</label>
        <label class="option-label"><input type="radio" name="q2-4" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-4" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">5. Suicide ou tentative de suicide</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-5" value="sante"> Sant√© du Salari√©</label>
        <label class="option-label"><input type="radio" name="q2-5" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-5" class="feedback"></div>
    </div>
  </div>

  <div class="card">
    <h2>Exercice 3 ‚Äî Mesures de Pr√©vention (5 pts) <button class="btn-audio" onclick="speak('Associe chaque mesure de pr√©vention √† sa cat√©gorie.')">üîà</button></h2>
    
    <div class="question-item">
      <span class="question-label">1. Distribuer un d√©pliant sur les risques psychosociaux.</span>
      <select id="q3-1" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation / Pr√©vention</option>
      </select>
      <div id="fb-q3-1" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">2. Apprendre aux managers √† g√©rer les conflits (Jeux de r√¥les).</span>
      <select id="q3-2" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation / Pr√©vention</option>
      </select>
      <div id="fb-q3-2" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">3. R√©organiser le travail pour r√©duire la surcharge.</span>
      <select id="q3-3" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation / Pr√©vention</option>
      </select>
      <div id="fb-q3-3" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">4. Favoriser le travail en √©quipe et l'autonomie.</span>
      <select id="q3-4" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation / Pr√©vention</option>
      </select>
      <div id="fb-q3-4" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">5. Prise en charge par un psychologue (cellule d'√©coute).</span>
      <select id="q3-5" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation / Pr√©vention</option>
      </select>
      <div id="fb-q3-5" class="feedback"></div>
    </div>
  </div>

  <div class="card">
    <h2>Exercice 4 ‚Äî D√©finitions (5 pts) <button class="btn-audio" onclick="speak('R√©ponds aux questions de vocabulaire.')">üîà</button></h2>

    <div class="question-item">
      <span class="question-label">1. Comment appelle-t-on l'√©puisement professionnel d√ª √† une surcharge de travail et au stress ?</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-1" value="burnout"> Le Burn-out</label>
        <label class="option-label"><input type="radio" name="q4-1" value="boreout"> Le Bore-out</label>
      </div>
      <div id="fb-q4-1" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">2. Comment appelle-t-on l'ennui au travail qui m√®ne √† l'√©puisement ?</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-2" value="burnout"> Le Burn-out</label>
        <label class="option-label"><input type="radio" name="q4-2" value="boreout"> Le Bore-out</label>
      </div>
      <div id="fb-q4-2" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">3. Vrai ou Faux : Le harc√®lement sexuel fait partie des violences internes.</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-3" value="vrai"> Vrai</label>
        <label class="option-label"><input type="radio" name="q4-3" value="faux"> Faux</label>
      </div>
      <div id="fb-q4-3" class="feedback"></div>
    </div>
  </div>

  <div class="result-section">
    <div id="error-message" class="error-msg"></div>
    
    <div id="score-display" style="display:none;">
      <h3>Ton Bilan</h3>
      <p id="final-score">-- / 20 points</p>
      <p id="score-comment"></p>
    </div>

    <button id="btn-action" onclick="handleValidation()">Voir mon r√©sultat</button>
    <div id="firebase-log" style="margin-top:10px; font-size:0.9rem; color:#a5b4fc; min-height:20px;"></div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Configuration Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Fonction Audio
  window.speak = function(text) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'fr-FR';
      window.speechSynthesis.speak(msg);
    }
  }

  // Fonction de correction globale
  window.handleValidation = async function() {
    const idEleve = document.getElementById("student-id").value.trim();
    const classeEleve = document.getElementById("student-class").value;
    const errorMsg = document.getElementById("error-message");
    const btn = document.getElementById("btn-action");
    const log = document.getElementById("firebase-log");

    // 1. V√©rification Identit√©
    if (!idEleve || !classeEleve) {
      errorMsg.textContent = "‚ö†Ô∏è Merci de saisir ton identifiant et de choisir ta classe.";
      errorMsg.style.display = "block";
      return;
    }
    errorMsg.style.display = "none";
    btn.disabled = true;
    btn.textContent = "Correction en cours...";

    // 2. Correction & Calcul du Score
    let totalScore = 0;
    
    // EXERCICE 1 (5 pts)
    const ans1 = {
      "q1-1": "externe",
      "q1-2": "stress",
      "q1-3": "interne",
      "q1-4": "interne",
      "q1-5": "externe"
    };
    totalScore += checkSelects(ans1, 1);

    // EXERCICE 2 (5 pts)
    const ans2 = {
      "q2-1": "sante",
      "q2-2": "entreprise",
      "q2-3": "sante",
      "q2-4": "entreprise",
      "q2-5": "sante"
    };
    totalScore += checkRadios(ans2, 1);

    // EXERCICE 3 (5 pts)
    const ans3 = {
      "q3-1": "information",
      "q3-2": "formation",
      "q3-3": "organisation",
      "q3-4": "organisation",
      "q3-5": "organisation"
    };
    totalScore += checkSelects(ans3, 1);

    // EXERCICE 4 (5 pts)
    // Q4-1 & Q4-2 (2 pts each approx, total 5 adjusted) -> Let's give 1.5, 1.5, 2
    let pts4 = 0;
    pts4 += checkRadioSingle("q4-1", "burnout", 1.5);
    pts4 += checkRadioSingle("q4-2", "boreout", 1.5);
    pts4 += checkRadioSingle("q4-3", "vrai", 2);
    totalScore += pts4;

    // Arrondi score
    totalScore = Math.min(20, Math.round(totalScore * 10) / 10);

    // 3. Affichage R√©sultat
    const scoreDisplay = document.getElementById("score-display");
    const finalScoreTxt = document.getElementById("final-score");
    const scoreComment = document.getElementById("score-comment");
    
    scoreDisplay.style.display = "block";
    finalScoreTxt.textContent = `${totalScore} / 20 points`;
    
    if(totalScore >= 16) scoreComment.textContent = "Bravo ! C'est excellent.";
    else if(totalScore >= 10) scoreComment.textContent = "Bien, les notions sont comprises.";
    else scoreComment.textContent = "√Ä revoir. Regarde bien la correction d√©taill√©e.";

    // 4. Envoi Firebase (Discret)
    try {
      await addDoc(collection(db, "bacpro"), {
        meta: {
          createdAt: new Date().toISOString(),
          nom: idEleve,
          prenom: idEleve,
          classe: classeEleve,
          type: "exercice",
          support: "C9_RPS_Facteurs"
        },
        resultat: {
          score: `${totalScore} / 20`,
          url: location.href,
          titre: document.title
        }
      });
      log.textContent = "R√©sultat enregistr√© ‚úîÔ∏è";
      btn.textContent = "Mettre √† jour mon r√©sultat";
    } catch (e) {
      console.error(e);
      log.textContent = "Erreur de connexion (Score affich√©)";
      btn.textContent = "R√©essayer l'envoi";
    } finally {
      btn.disabled = false;
    }
  }

  // --- Fonctions Utilitaires de Correction ---

  function checkSelects(answers, ptsPerQuestion) {
    let score = 0;
    for (const [id, correctVal] of Object.entries(answers)) {
      const el = document.getElementById(id);
      const fb = document.getElementById("fb-" + id);
      fb.style.display = "block";
      
      if (el.value === correctVal) {
        score += ptsPerQuestion;
        fb.className = "feedback fb-correct";
        fb.innerHTML = "‚úÖ Correct !";
      } else {
        fb.className = "feedback fb-incorrect";
        let label = "";
        // R√©cup√©ration texte option pour feedback
        const opt = el.querySelector(`option[value="${correctVal}"]`);
        if(opt) label = opt.text;
        fb.innerHTML = `‚ùå Faux. La bonne r√©ponse √©tait : <strong>${label}</strong>`;
      }
    }
    return score;
  }

  function checkRadios(answers, ptsPerQuestion) {
    let score = 0;
    for (const [name, correctVal] of Object.entries(answers)) {
      const selected = document.querySelector(`input[name="${name}"]:checked`);
      const fb = document.getElementById("fb-" + name);
      fb.style.display = "block";

      if (selected && selected.value === correctVal) {
        score += ptsPerQuestion;
        fb.className = "feedback fb-correct";
        fb.innerHTML = "‚úÖ Correct !";
      } else {
        fb.className = "feedback fb-incorrect";
        // Mapping simple pour affichage (peut √™tre am√©lior√©)
        let displayVal = correctVal === "sante" ? "Sant√© du Salari√©" : "Entreprise";
        fb.innerHTML = `‚ùå Faux. C'est une cons√©quence sur : <strong>${displayVal}</strong>`;
      }
    }
    return score;
  }

  function checkRadioSingle(name, correctVal, pts) {
    const selected = document.querySelector(`input[name="${name}"]:checked`);
    const fb = document.getElementById("fb-" + name);
    fb.style.display = "block";
    
    if (selected && selected.value === correctVal) {
      fb.className = "feedback fb-correct";
      fb.innerHTML = "‚úÖ Correct !";
      return pts;
    } else {
      fb.className = "feedback fb-incorrect";
      // Recherche du label associ√© pour affichage propre
      /* Note: Pour simplifier ici, on met un message g√©n√©rique ou on cible sp√©cifiquement */
      let msg = correctVal;
      if(correctVal === "burnout") msg = "Le Burn-out (surcharge)";
      if(correctVal === "boreout") msg = "Le Bore-out (ennui)";
      if(correctVal === "vrai") msg = "Vrai";
      fb.innerHTML = `‚ùå Faux. La r√©ponse √©tait : <strong>${msg}</strong>`;
      return 0;
    }
  }
</script>

</body>
</html>