<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Compétence 6 — Communication claire (oral)</title>

  <style>
    :root{
      --bg:#070B14; --card:#0E1630; --card2:#0B1228;
      --text:#EAF0FF; --muted:#A9B6DE; --line:rgba(255,255,255,.08);
      --accent:#6D7CFF; --good:#2ED3B7; --bad:#FF5C7A; --warn:#FFD36D;
      --shadow: 0 18px 60px rgba(0,0,0,.45); --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(109,124,255,.20), transparent 55%),
                  radial-gradient(900px 650px at 80% 30%, rgba(46,211,183,.15), transparent 55%),
                  radial-gradient(700px 500px at 50% 95%, rgba(255,92,122,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .container{width:min(980px, 94vw); margin:18px auto 72px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius:22px; box-shadow:var(--shadow);
      position:sticky; top:10px; z-index:50; backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .badge{
      width:42px; height:42px; border-radius:14px; display:grid; place-items:center;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), rgba(255,255,255,.05) 60%),
                  linear-gradient(135deg, rgba(109,124,255,.85), rgba(46,211,183,.75));
      box-shadow: 0 12px 30px rgba(109,124,255,.18);
      font-weight:800;
    }
    .brand h1{font-size:16px; margin:0; line-height:1.2;}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pills{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.04); font-size:12px; color:var(--muted);
    }
    .fontBtns{display:flex; gap:8px; align-items:center;}
    .fontBtn{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      line-height:1;
      -webkit-tap-highlight-color: transparent;
    }
    .fontBtn:active{transform: translateY(1px);}
    .hero{
      margin:18px 0 14px; padding:18px; border-radius:var(--radius);
      border:1px solid var(--line); background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .hero h2{margin:0 0 8px; font-size:18px;}
    .hero .sub{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}
    .grid{display:grid; grid-template-columns: 1fr; gap:14px;}
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .card .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px; background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
      border-bottom:1px solid var(--line);
    }
    .tag{display:flex; align-items:center; gap:10px; min-width:0;}
    .tag .t{
      font-weight:800; font-size:13px; padding:6px 10px; border-radius:999px;
      background: rgba(109,124,255,.14); border:1px solid rgba(109,124,255,.35);
    }
    .tag .ttl{font-weight:800; font-size:14px; margin:0;}
    .meta{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; color:var(--muted); font-size:12px;}
    .meta .m{padding:6px 10px; border:1px solid var(--line); border-radius:999px; background: rgba(255,255,255,.03);}
    .card .body{padding:14px 14px 16px;}
    .prompt{border:1px solid var(--line); background: rgba(255,255,255,.03); border-radius:16px; padding:12px;}
    .prompt h3{margin:0 0 8px; font-size:14px;}
    .prompt p{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      appearance:none; border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(46,211,183,.18), rgba(46,211,183,.06));
      color: var(--text); border-radius:14px; padding:10px 12px;
      font-weight:800; font-size:13px; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button.secondary{background: rgba(255,255,255,.03); color: var(--muted);}
    button:active{transform: translateY(1px);}
    .q{margin-top:10px; border:1px solid var(--line); background: rgba(11,18,40,.6); border-radius:16px; padding:12px;}
    .q .qtitle{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .q .qtitle h4{margin:0; font-size:14px;}
    .points{font-size:12px; color:var(--muted); padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.03); white-space:nowrap;}
    .options{display:grid; gap:10px; margin-top:10px;}
    .opt{border:1px solid var(--line); background: rgba(255,255,255,.03); border-radius:14px; padding:10px; display:flex; gap:10px; align-items:flex-start;}
    .opt input{transform: translateY(2px);}
    .opt label{cursor:pointer; color: var(--text); font-size:13px; line-height:1.35;}
    .feedback{margin-top:10px; border-radius:14px; border:1px dashed rgba(255,255,255,.18); padding:10px; background: rgba(255,255,255,.02); color: var(--muted); font-size:13px; line-height:1.45;}
    .feedback.good{border-color: rgba(46,211,183,.7); color: rgba(234,255,248,.95); background: rgba(46,211,183,.08);}
    .feedback.bad{border-color: rgba(255,92,122,.7); color: rgba(255,240,244,.95); background: rgba(255,92,122,.06);}
    .feedback.warn{border-color: rgba(255,211,109,.7); color: rgba(255,250,240,.95); background: rgba(255,211,109,.06);}
    textarea, select{
      width:100%; border-radius:14px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); color: var(--text);
      padding:10px 12px; font-size:13px; outline:none;
    }
    textarea{min-height:110px; resize:vertical;}

    .bank{border:1px solid var(--line); border-radius:16px; padding:10px; background: rgba(255,255,255,.02);}
    .bankhead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;}
    .bankhead .title{font-weight:800; font-size:13px;}
    .chips{display:flex; flex-wrap:wrap; gap:10px;}
    .chip{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      border-radius:999px; padding:10px 12px; font-size:13px; line-height:1;
      cursor:pointer; user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .chip.selected{outline:2px solid rgba(109,124,255,.7); background: rgba(109,124,255,.12);}
    .zones{display:grid; gap:10px; margin-top:10px;}
    .zone{
      border:1px dashed rgba(109,124,255,.5);
      background: rgba(109,124,255,.06);
      border-radius:16px; padding:10px; min-height:48px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .zone .label{font-weight:800; font-size:13px;}
    .zone .slot{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;}
    .hint{margin-top:8px; color: var(--muted); font-size:12px;}
    .footerScore{margin-top:12px; border:1px solid var(--line); border-radius:16px; padding:12px; background: rgba(255,255,255,.02);}
    .footerScore .big{font-size:16px; font-weight:900;}
    .footerScore .muted{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.4;}

    @media (max-width: 520px){
      .topbar{flex-direction:column; align-items:stretch;}
      .brand{width:100%;}
      .pills{justify-content:flex-start;}
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="badge">C6</div>
        <div style="min-width:0">
          <h1>Compétence 6 — Communication claire (oral)</h1>
          <p>S’entraîner à transmettre l’essentiel avec un registre adapté</p>
        </div>
      </div>

      <div class="pills">
        <div class="pill">Mobile + PC</div>
        <div class="pill">Auto-correction + score</div>
        <div class="pill">C6</div>

        <div class="fontBtns" aria-label="Taille du texte">
          <button class="fontBtn" type="button" onclick="changeSize(-1)" aria-label="Réduire le texte">A-</button>
          <button class="fontBtn" type="button" onclick="changeSize(1)" aria-label="Agrandir le texte">A+</button>
        </div>
      </div>
    </div>

    <div class="hero">
      <h2>Objectif</h2>
      <p class="sub">S’entraîner à communiquer clairement, avec une syntaxe simple et adaptée au contexte (écrit et oral).</p>
    </div>

    <div class="grid">
      <div class="card" id="a1">
        <div class="head">
          <div class="tag"><div class="t">Exercice 1</div><p class="ttl">Dire l’essentiel à l’oral</p></div>
          <div class="meta"><div class="m">6 pts</div><div class="m">C6</div></div>
        </div>

        <div class="body">
          <div class="prompt">
            <h3>Situation</h3>
            <p>Tu dois prévenir rapidement un responsable après un incident (atelier sécurisé). Objectif : message court et compréhensible.</p>
          </div>

          <div class="q">
            <div class="qtitle"><h4>Coche les 3 informations indispensables</h4><div class="points">6 pts</div></div>
            <div class="options">
              <div class="opt"><input type="checkbox" id="a1q1a" value="a"><label for="a1q1a">Où cela s’est passé (lieu précis)</label></div>
              <div class="opt"><input type="checkbox" id="a1q1b" value="b"><label for="a1q1b">Ce qui s’est passé (fait observable)</label></div>
              <div class="opt"><input type="checkbox" id="a1q1c" value="c"><label for="a1q1c">État de la personne (ex : douleur, consciente)</label></div>
              <div class="opt"><input type="checkbox" id="a1q1d" value="d"><label for="a1q1d">Ton avis sur les collègues</label></div>
              <div class="opt"><input type="checkbox" id="a1q1e" value="e"><label for="a1q1e">Une rumeur sur la cause</label></div>
            </div>
            <div class="feedback" id="fb_a1q1"></div>
          </div>

          <div class="controls">
            <button id="btn_a1_check" type="button">Corriger</button>
            <button class="secondary" id="btn_a1_reset" type="button">Réinitialiser</button>
          </div>

          <div class="footerScore" id="score_a1">
            <div class="big">Score : 0 / 6</div>
            <div class="muted">Astuce : où + fait + état = message utile.</div>
          </div>
        </div>
      </div>

      <div class="card" id="a2">
        <div class="head">
          <div class="tag"><div class="t">Exercice 2</div><p class="ttl">Choisir le bon registre (respectueux)</p></div>
          <div class="meta"><div class="m">6 pts</div><div class="m">C6</div></div>
        </div>

        <div class="body">
          <div class="prompt">
            <h3>Consigne</h3>
            <p>Tu dois demander à un collègue de ranger un outil dangereux qui traîne. Choisis la meilleure phrase (ferme et respectueuse).</p>
          </div>

          <div class="q">
            <div class="qtitle"><h4>Choisis la meilleure formulation</h4><div class="points">6 pts</div></div>
            <div class="options">
              <div class="opt"><input type="radio" name="a2q1" id="a2q1a" value="a"><label for="a2q1a">T’es sérieux ? Range ça, t’abuses.</label></div>
              <div class="opt"><input type="radio" name="a2q1" id="a2q1b" value="b"><label for="a2q1b">Tu peux ranger la scie sur son support, s’il te plaît ? Là, elle gêne le passage et c’est risqué.</label></div>
              <div class="opt"><input type="radio" name="a2q1" id="a2q1c" value="c"><label for="a2q1c">Je vais le faire à ta place, laisse tomber.</label></div>
            </div>
            <div class="feedback" id="fb_a2q1"></div>
          </div>

          <div class="controls">
            <button id="btn_a2_check" type="button">Corriger</button>
            <button class="secondary" id="btn_a2_reset" type="button">Réinitialiser</button>
          </div>

          <div class="footerScore" id="score_a2">
            <div class="big">Score : 0 / 6</div>
            <div class="muted">Astuce : demande claire + raison simple = communication efficace.</div>
          </div>
        </div>
      </div>

      <div class="card" id="a3">
        <div class="head">
          <div class="tag"><div class="t">Exercice 3</div><p class="ttl">Mini-script oral (tap-to-place)</p></div>
          <div class="meta"><div class="m">8 pts</div><div class="m">C6</div></div>
        </div>

        <div class="body">
          <div class="prompt">
            <h3>Consigne</h3>
            <p>Mode téléphone : touche une phrase (elle devient violette), puis touche une zone pour la déposer. Touche une phrase dans une zone pour la retirer.</p>
            <p class="hint">Objectif : fait → impact → solution → demande.</p>
          </div>

          <div class="q">
            <div class="qtitle"><h4>Place chaque phrase au bon endroit</h4><div class="points">8 pts</div></div>

            <div class="bank" id="tap_bank_2">
              <div class="bankhead">
                <div class="title">Banque (à placer)</div>
                <button type="button" class="secondary" id="tap_reset_2">Réinitialiser</button>
              </div>
              <div class="chips"></div>
            </div>

            <div class="zones"></div>
            <div class="feedback" id="fb_tap2"></div>
          </div>

          <div class="controls">
            <button id="btn_a3_check" type="button">Corriger</button>
            <button class="secondary" id="btn_a3_reset" type="button">Réinitialiser</button>
          </div>

          <div class="footerScore" id="score_a3">
            <div class="big">Score : 0 / 8</div>
            <div class="muted">Astuce : plus c’est simple et factuel, plus c’est clair.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentSize = parseInt(getComputedStyle(document.documentElement).fontSize, 10) || 16;
    function changeSize(delta) {
      currentSize += delta;
      if (currentSize < 12) currentSize = 12;
      if (currentSize > 24) currentSize = 24;
      document.documentElement.style.fontSize = currentSize + 'px';
      const h1 = document.querySelector('h1');
      if(h1) h1.style.fontSize = (2 * (currentSize/16)) + 'rem';
    }
  </script>

  <script>
    function $(sel, el=document){ return el.querySelector(sel); }
    function $all(sel, el=document){ return Array.from(el.querySelectorAll(sel)); }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function save(key,value){ try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){} }
    function load(key,fallback=null){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch(e){ return fallback; } }

    function setFeedback(box,type,html){
      box.classList.remove('good','bad','warn');
      if(type) box.classList.add(type);
      box.innerHTML = html;
    }

    function makeTapToPlace(root, config){
      const bankEl = root.querySelector(config.bankId);
      const chipsEl = bankEl.querySelector('.chips');
      const zonesEl = root.querySelector('.zones');
      const itemById = new Map(config.items.map(i=>[i.id,i]));
      let state = load(config.stateKey, null);

      if(!state){
        state = {selected:null, bank: config.items.map(i=>i.id), placed:{}};
        config.zones.forEach(z=> state.placed[z.key]=[]);
      }

      let selectedId = state.selected;

      function persist(){
        state.selected = selectedId;
        save(config.stateKey, state);
      }

      function render(){
        chipsEl.innerHTML='';
        state.bank.forEach(id=>{
          const item=itemById.get(id); if(!item) return;
          const b=document.createElement('button'); b.type='button';
          b.className='chip'+(selectedId===id?' selected':'');
          b.textContent=item.text; b.dataset.id=id;
          b.addEventListener('click', ()=>{
            selectedId = (selectedId===id?null:id);
            state.selected=selectedId; persist(); render();
          });
          chipsEl.appendChild(b);
        });

        zonesEl.innerHTML='';
        config.zones.forEach(z=>{
          const wrap=document.createElement('div');
          wrap.className='zone';
          wrap.innerHTML = `<div class='label'>${z.label}</div><div class='slot'></div>`;
          const slot=wrap.querySelector('.slot');

          (state.placed[z.key]||[]).forEach(id=>{
            const item=itemById.get(id); if(!item) return;
            const b=document.createElement('button'); b.type='button'; b.className='chip';
            b.textContent=item.text; b.dataset.id=id;
            b.addEventListener('click', ()=>{
              state.placed[z.key]=(state.placed[z.key]||[]).filter(x=>x!==id);
              state.bank.push(id);
              selectedId=null; state.selected=null;
              persist(); render();
            });
            slot.appendChild(b);
          });

          wrap.addEventListener('click', (ev)=>{
            if(ev.target && ev.target.classList && ev.target.classList.contains('chip')) return;
            if(!selectedId) return;
            const item=itemById.get(selectedId); if(!item) return;
            if(z.accept && z.accept.length && !z.accept.includes(item.key)) return;
            const max = (z.max ?? 99);
            const arr = state.placed[z.key] || [];
            if(arr.length>=max) return;
            state.bank = state.bank.filter(x=>x!==selectedId);
            arr.push(selectedId); state.placed[z.key]=arr;
            selectedId=null; state.selected=null;
            persist(); render();
          }, {passive:true});

          zonesEl.appendChild(wrap);
        });
      }

      function reset(){
        state = {selected:null, bank: config.items.map(i=>i.id), placed:{}};
        config.zones.forEach(z=> state.placed[z.key]=[]);
        selectedId=null;
        persist(); render();
      }

      render();
      return { reset, getState:()=>JSON.parse(JSON.stringify(state)) };
    }
  </script>

  <script>
    (function(){
      const KEY='C6_ORAL_V1';
      const st=load(KEY,{a1:[],a2:null});

      $all('#a1 input[type="checkbox"]').forEach(cb=> cb.checked = st.a1.includes(cb.value));
      if(st.a2){
        const r=document.querySelector(`#a2 input[name="a2q1"][value="${st.a2}"]`);
        if(r) r.checked=true;
      }

      function persist(){
        st.a1 = $all('#a1 input[type="checkbox"]:checked').map(x=>x.value);
        st.a2 = $('#a2 input[name="a2q1"]:checked')?.value || null;
        save(KEY, st);
      }
      $all('#a1 input').forEach(el=> el.addEventListener('change', persist));
      $all('#a2 input').forEach(el=> el.addEventListener('change', persist));

      function scoreA1(){
        const sel=new Set($all('#a1 input[type="checkbox"]:checked').map(x=>x.value));
        let pts=0;
        if(sel.has('a')) pts+=2;
        if(sel.has('b')) pts+=2;
        if(sel.has('c')) pts+=2;
        if(sel.has('d')) pts-=1;
        if(sel.has('e')) pts-=1;
        pts=clamp(pts,0,6);

        const fb=$('#fb_a1q1');
        if(sel.size===0) setFeedback(fb,'warn','Coche 3 informations indispensables.');
        else if(pts===6 && sel.size===3) setFeedback(fb,'good','Parfait : message court et utile.');
        else setFeedback(fb,'warn','On vise surtout : lieu + fait observable + état.');

        $('#score_a1 .big').textContent = `Score : ${pts} / 6`;
        return pts;
      }

      function scoreA2(){
        const v=$('#a2 input[name="a2q1"]:checked')?.value || null;
        let pts=0;
        if(v==='b') pts=6;

        const fb=$('#fb_a2q1');
        if(!v) setFeedback(fb,'warn','Choisis une phrase.');
        else if(v==='b') setFeedback(fb,'good','Oui : demande claire + politesse + raison.');
        else setFeedback(fb,'bad','Trop agressif ou trop effacé : cherche le juste milieu.');

        $('#score_a2 .big').textContent = `Score : ${pts} / 6`;
        return pts;
      }

      const tapRoot=document.getElementById('a3');
      const items=[
        {id:'s1', text:'Je constate qu’une palette bloque partiellement le passage.', key:'fait'},
        {id:'s2', text:'Ça augmente le risque de chute ou de collision.', key:'impact'},
        {id:'s3', text:'Je propose de la déplacer et de baliser la zone le temps de le faire.', key:'solution'},
        {id:'s4', text:'Tu valides que je le fais tout de suite ?', key:'demande'},
      ];
      const zones=[
        {key:'fait', label:'Fait observable', accept:['fait'], max:1},
        {key:'impact', label:'Impact / risque', accept:['impact'], max:1},
        {key:'solution', label:'Solution proposée', accept:['solution'], max:1},
        {key:'demande', label:'Demande / validation', accept:['demande'], max:1},
      ];
      const tap=makeTapToPlace(tapRoot,{stateKey:'C6_TAP_ORAL_V1', bankId:'#tap_bank_2', zones, items});

      $('#tap_reset_2').addEventListener('click', ()=>tap.reset());
      $('#btn_a3_reset').addEventListener('click', ()=>tap.reset());

      function scoreTap(){
        const s=tap.getState();
        let pts=0;
        const exp={fait:'fait',impact:'impact',solution:'solution',demande:'demande'};
        Object.keys(exp).forEach(k=>{
          const arr=s.placed[k]||[];
          if(arr.length===1){
            const it=items.find(x=>x.id===arr[0]);
            if(it && it.key===exp[k]) pts+=2;
          }
        });

        const fb=$('#fb_tap2');
        if(pts===8) setFeedback(fb,'good','Très clair : fait → impact → solution → demande.');
        else setFeedback(fb,'warn','Reviens au plan : fait → impact → solution → demande.');

        $('#score_a3 .big').textContent = `Score : ${pts} / 8`;
        return pts;
      }

      $('#btn_a1_check').addEventListener('click', ()=>{ persist(); scoreA1(); });
      $('#btn_a2_check').addEventListener('click', ()=>{ persist(); scoreA2(); });
      $('#btn_a3_check').addEventListener('click', ()=>{ scoreTap(); });

      $('#btn_a1_reset').addEventListener('click', ()=>{
        $all('#a1 input[type="checkbox"]').forEach(x=>x.checked=false);
        setFeedback($('#fb_a1q1'),'','');
        $('#score_a1 .big').textContent='Score : 0 / 6';
        st.a1=[]; persist();
      });

      $('#btn_a2_reset').addEventListener('click', ()=>{
        $all('#a2 input[name="a2q1"]').forEach(x=>x.checked=false);
        setFeedback($('#fb_a2q1'),'','');
        $('#score_a2 .big').textContent='Score : 0 / 6';
        st.a2=null; persist();
      });

      setFeedback($('#fb_a1q1'),'','');
      setFeedback($('#fb_a2q1'),'','');
      setFeedback($('#fb_tap2'),'','');
    })();
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentDocId = null;
    let startTime = Date.now();

    function getIdentity() { return localStorage.getItem("cockpit_student_id"); }

    async function demarrerVisite() {
      try {
        let userCode = getIdentity() || "ANONYME";
        let userClass = localStorage.getItem("cockpit_student_class") || "VISITEUR";
        const pageName = document.title || window.location.pathname.split("/").pop();
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);

        const ref = await addDoc(collection(db, "statistiques_usage"), {
          page: pageName,
          userCode: userCode,
          classe: userClass,
          device: isMobile ? "Mobile" : "Desktop",
          action: "Consultation",
          duree: 0,
          timestamp: serverTimestamp(),
          date: new Date().toISOString()
        });

        currentDocId = ref.id;

        setInterval(async () => {
          if (currentDocId && document.visibilityState === "visible") {
            try {
              await updateDoc(doc(db, "statistiques_usage", currentDocId), {
                duree: Math.floor((Date.now() - startTime) / 1000)
              });
            } catch (e) {}
          }
        }, 10000);

      } catch (e) { console.warn("Erreur Tracker", e); }
    }

    demarrerVisite();
  </script>
</body>
</html>
