<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSE D2 - Seance 1 (Partie 1) - Le budget et les revenus</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --accent:#7c2d12;
      --accent2:#0f766e;
      --line:#e5e7eb;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#b45309;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --radius:18px;
      --pad:18px;
      --max:980px;
      --focus:0 0 0 3px rgba(15,118,110,.22);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --fontDys: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --fs: 16.5px;
      --lh: 1.45;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      font-size:var(--fs);
      line-height:var(--lh);
      color:var(--ink);
      background:linear-gradient(180deg, #fff, var(--bg));
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:22px 16px 36px}
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      padding:18px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .h-left{min-width:0}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted); background:#fff;
      font-size:13px; font-weight:600;
    }
    h1{margin:10px 0 4px; font-size:22px; line-height:1.2}
    .sub{color:var(--muted); margin:0}
    .h-right{display:flex; flex-direction:column; gap:10px; align-items:flex-end}
    .toggles{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:650; font-size:14px;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      user-select:none;
    }
    .btn:hover{border-color:#d1d5db}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.primary{background:linear-gradient(180deg, #0f766e, #0b5f58); color:#fff; border-color:#0b5f58}
    .btn.primary:hover{filter:brightness(1.03)}
    .pill{
      font-family:var(--mono);
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; color:var(--muted); font-size:13px; font-weight:700;
    }
    .grid{
      display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px;
    }
    @media (min-width: 900px){
      .grid{grid-template-columns: 1.05fr .95fr;}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
      min-width:0;
    }
    .card h2{margin:0 0 10px; font-size:18px}
    .card h3{margin:14px 0 8px; font-size:16px}
    .muted{color:var(--muted)}
    .note{
      border-left:5px solid var(--accent2);
      background:linear-gradient(180deg, rgba(15,118,110,.08), rgba(15,118,110,.03));
      padding:10px 12px; border-radius:14px;
    }
    .twoCol{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 700px){
      .twoCol{grid-template-columns:1fr 1fr}
    }
    .mini{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .mini b{display:block; margin-bottom:6px}
    .klist{margin:10px 0 0; padding-left:18px}
    .klist li{margin:6px 0}
    .hr{height:1px; background:var(--line); margin:14px 0}
    .step{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 12px; border-radius:16px; border:1px solid var(--line); background:#fff;
      margin:10px 0;
    }
    .n{
      flex:0 0 auto;
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      background:linear-gradient(180deg, rgba(124,45,18,.14), rgba(124,45,18,.06));
      border:1px solid rgba(124,45,18,.18);
      font-weight:800;
      color:var(--accent);
    }
    .step .t{min-width:0}
    .prompt{font-weight:700}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .q{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg, rgba(17,24,39,.02), rgba(17,24,39,.00));
    }
    .qhead{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .qtitle{font-weight:800}
    .scoreTag{
      font-family:var(--mono);
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-weight:800;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{border-color:#d1d5db}
    .chip[aria-pressed="true"]{border-color:rgba(15,118,110,.55); box-shadow:var(--focus)}
    .chip:focus{outline:none; box-shadow:var(--focus)}
    .rows{display:grid; gap:10px; margin-top:10px}
    .row{
      display:grid; grid-template-columns: 1fr; gap:10px;
      padding:10px; border:1px solid var(--line); border-radius:16px; background:#fff;
    }
    @media (min-width: 720px){
      .row{grid-template-columns: 1.2fr .8fr;}
    }
    select, input[type="text"], textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:15px;
    }
    select:focus, input[type="text"]:focus, textarea:focus{outline:none; box-shadow:var(--focus)}
    textarea{min-height:88px; resize:vertical}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; font-weight:800; font-size:13px; color:var(--muted);
    }
    .ok{color:var(--ok); border-color:rgba(22,163,74,.3); background:rgba(22,163,74,.06)}
    .bad{color:var(--bad); border-color:rgba(220,38,38,.3); background:rgba(220,38,38,.06)}
    .warnTag{color:var(--warn); border-color:rgba(180,83,9,.3); background:rgba(180,83,9,.06)}
    .feedback{margin-top:10px}
    .fbLine{margin:6px 0; padding:8px 10px; border-radius:14px; border:1px solid var(--line); background:#fff}
    .progress{
      width:100%;
      height:12px;
      border-radius:999px;
      background:#eef2f7;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, #0f766e, #7c2d12);
    }
    .footer{
      margin-top:14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .small{font-size:13px; color:var(--muted)}
    .mono{font-family:var(--mono)}
    body.dyslexie{
      font-family:var(--fontDys);
      letter-spacing:.35px;
      word-spacing:.1em;
    }
    .kbd{
      font-family:var(--mono); font-size:12px; padding:3px 6px; border:1px solid var(--line); border-radius:8px; background:#fff; color:var(--muted); font-weight:800
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="h-left">
        <div class="badge">PSE THEMATIQUE D2 • CAP • Seance 1 • Partie 1</div>
        <h1>Le budget et les revenus</h1>
        <p class="sub">
          Objectif : etre capable d’identifier les categories de recettes et de depenses d’un budget, puis de distinguer les revenus lies au travail, les revenus sociaux et les autres revenus.
        </p>
      </div>

      <div class="h-right">
        <div class="pill" id="saveState">Sauvegarde : active</div>
        <div class="toggles">
          <button class="btn" id="btnDys" type="button" aria-pressed="false">Mode lecture</button>
          <button class="btn" id="btnReset" type="button">Reinitialiser</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Cours express</h2>

        <div class="note">
          <b>A retenir</b>
          Un budget = l’ensemble des recettes (revenus) et des depenses d’un particulier pour une periode donnee.
        </div>

        <div class="twoCol" style="margin-top:12px">
          <div class="mini">
            <b>1) Recettes</b>
            Argent qui entre.
            <ul class="klist">
              <li>Revenus lies au travail : salaire, primes, heures supplementaires</li>
              <li>Revenus sociaux : aides versees par l’Etat ou des organismes sociaux selon la situation</li>
              <li>Autres revenus : vente d’un objet, cadeaux, remboursement, petits boulots ponctuels</li>
            </ul>
          </div>

          <div class="mini">
            <b>2) Depenses</b>
            Argent qui sort.
            <ul class="klist">
              <li>Loyer, factures, courses, transport, loisirs</li>
              <li>Les types de depenses seront vus dans la partie suivante</li>
            </ul>
          </div>
        </div>

        <div class="hr"></div>

        <h3>Exemples rapides</h3>
        <div class="twoCol">
          <div class="mini">
            <b>Revenus lies au travail</b>
            Salaire mensuel, prime, heures supplementaires.
          </div>
          <div class="mini">
            <b>Revenus sociaux</b>
            Allocations familiales, aide au logement, Pole emploi.
          </div>
        </div>

        <div class="mini" style="margin-top:10px">
          <b>Autres revenus</b>
          Vente d’un telephone, remboursement d’un ami, cadeau, vente en ligne.
        </div>

        <div class="hr"></div>

        <div class="step">
          <div class="n">1</div>
          <div class="t">
            <div class="prompt">Consigne</div>
            <div class="muted">
              Travailler dans l’ordre. Cliquer sur Corriger quand tout est rempli.
            </div>
          </div>
        </div>

        <div class="footer">
          <div style="min-width:220px; flex:1">
            <div class="small">Progression</div>
            <div class="progress" aria-label="progression">
              <div class="bar" id="bar"></div>
            </div>
          </div>
          <div class="pill mono" id="globalScore">Score : 0 / 20</div>
        </div>
      </section>

      <section class="card" id="devoir">
        <h2>Devoir en autonomie</h2>
        <p class="muted" style="margin-top:-2px">
          Bareme : 18 points sur les exercices + 2 points pour la qualite de la reponse ecrite (C6).
        </p>

        <div class="q" id="q1">
          <div class="qhead">
            <div class="qtitle">Exercice 1 – Completer la definition de budget</div>
            <div class="scoreTag">C2 • 4 pts</div>
          </div>
          <div class="muted">Verbes : Replacer puis Verifier.</div>

          <div class="rows" style="margin-top:10px">
            <div class="row">
              <div>
                <b>Phrase</b>
                <div style="margin-top:6px">
                  Le budget est l’ensemble des
                  <span class="kbd" id="b1">(choisir)</span>
                  (= revenus) et des
                  <span class="kbd" id="b2">(choisir)</span>
                  (= sommes d’argent prelevees) d’un
                  <span class="kbd" id="b3">(choisir)</span>
                  pour une
                  <span class="kbd" id="b4">(choisir)</span>.
                </div>
              </div>
              <div>
                <b>Etiquettes</b>
                <div class="chips" role="group" aria-label="etiquettes budget">
                  <button class="chip" type="button" data-chip="recettes">recettes</button>
                  <button class="chip" type="button" data-chip="depenses">depenses</button>
                  <button class="chip" type="button" data-chip="particulier">particulier</button>
                  <button class="chip" type="button" data-chip="periode donnee">periode donnee</button>
                </div>
                <div class="small" style="margin-top:10px">
                  Astuce : cliquer sur une etiquette puis sur un emplacement a remplir.
                </div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q1">Corriger</button>
            <span class="tag warnTag" id="q1tag">A faire</span>
          </div>
          <div class="feedback" id="q1fb"></div>
        </div>

        <div class="q" id="q2">
          <div class="qhead">
            <div class="qtitle">Exercice 2 – Distinguer les types de revenus</div>
            <div class="scoreTag">C2 • 6 pts</div>
          </div>
          <div class="muted">Verbes : Identifier, Classer.</div>

          <div class="rows" id="q2rows"></div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q2">Corriger</button>
            <span class="tag warnTag" id="q2tag">A faire</span>
          </div>
          <div class="feedback" id="q2fb"></div>
        </div>

        <div class="q" id="q3">
          <div class="qhead">
            <div class="qtitle">Exercice 3 – Recette ou depense, puis type de recette</div>
            <div class="scoreTag">C2 • 6 pts</div>
          </div>
          <div class="muted">Verbes : Classer, Justifier.</div>

          <div class="rows" id="q3rows"></div>

          <div class="actions">
            <button class="btn" type="button" data-correct="q3">Corriger</button>
            <span class="tag warnTag" id="q3tag">A faire</span>
          </div>
          <div class="feedback" id="q3fb"></div>
        </div>

        <div class="q" id="q4">
          <div class="qhead">
            <div class="qtitle">Exercice 4 – Reponse ecrite</div>
            <div class="scoreTag">C6 • 2 pts</div>
          </div>
          <div class="muted">Verbes : Expliquer, Illustrer.</div>

          <label for="q4txt" class="small">
            Expliquer, avec un exemple, la difference entre revenu lie au travail et revenu social.
          </label>
          <textarea id="q4txt" placeholder="Ecrire 4 a 6 lignes..."></textarea>

          <div class="actions">
            <button class="btn" type="button" data-correct="q4">Verifier</button>
            <span class="tag warnTag" id="q4tag">A faire</span>
          </div>
          <div class="feedback" id="q4fb"></div>
        </div>

        <div class="hr"></div>

        <div class="actions">
          <button class="btn primary" type="button" id="btnFinal">Calculer la note</button>
          <button class="btn" type="button" id="btnExport">Exporter la copie</button>
        </div>

        <div class="feedback" id="finalFb"></div>
      </section>
    </div>
  </div>

  <script>
    const STORE_KEY = "pse_d2_budget_revenus_v1";

    const state = {
      dys: false,
      q1: { slot: ["","","",""], selectedChip: null },
      q2: {},
      q3: {},
      q4: { text: "" }
    };

    const q2Items = [
      { id:"i1", label:"Salaire mensuel", answer:"Travail" },
      { id:"i2", label:"Prime", answer:"Travail" },
      { id:"i3", label:"Allocations familiales", answer:"Social" },
      { id:"i4", label:"Aide au logement", answer:"Social" },
      { id:"i5", label:"Pole emploi", answer:"Social" },
      { id:"i6", label:"Vente d’un telephone", answer:"Autre" }
    ];

    const q3Items = [
      { id:"j1", label:"Loyer", nature:"Depense" },
      { id:"j2", label:"Salaire", nature:"Recette", type:"Travail" },
      { id:"j3", label:"Courses", nature:"Depense" },
      { id:"j4", label:"Aide au logement", nature:"Recette", type:"Social" },
      { id:"j5", label:"Concert", nature:"Depense" },
      { id:"j6", label:"Vente d’un objet", nature:"Recette", type:"Autre" }
    ];

    function $(sel, root=document){ return root.querySelector(sel); }
    function $all(sel, root=document){ return [...root.querySelectorAll(sel)]; }

    function save(){
      const payload = {
        dys: state.dys,
        q1: state.q1,
        q2: state.q2,
        q3: state.q3,
        q4: state.q4
      };
      localStorage.setItem(STORE_KEY, JSON.stringify(payload));
      $("#saveState").textContent = "Sauvegarde : active";
    }

    function load(){
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return;
      try{
        const payload = JSON.parse(raw);
        if(payload && typeof payload === "object"){
          state.dys = !!payload.dys;
          state.q1 = payload.q1 || state.q1;
          state.q2 = payload.q2 || state.q2;
          state.q3 = payload.q3 || state.q3;
          state.q4 = payload.q4 || state.q4;
        }
      }catch(e){}
    }

    function setDys(on){
      state.dys = on;
      document.body.classList.toggle("dyslexie", on);
      const btn = $("#btnDys");
      btn.setAttribute("aria-pressed", on ? "true" : "false");
      btn.textContent = on ? "Mode lecture : active" : "Mode lecture";
      save();
    }

    function resetAll(){
      localStorage.removeItem(STORE_KEY);
      location.reload();
    }

    function buildQ2(){
      const host = $("#q2rows");
      host.innerHTML = "";
      q2Items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <b>${it.label}</b>
            <div class="small muted">Identifier le type de revenu</div>
          </div>
          <div>
            <label class="small" for="q2_${it.id}">Choix</label>
            <select id="q2_${it.id}">
              <option value="">Selectionner</option>
              <option value="Travail">Revenu lie au travail</option>
              <option value="Social">Revenu social</option>
              <option value="Autre">Autre revenu</option>
            </select>
          </div>
        `;
        host.appendChild(row);
      });
    }

    function buildQ3(){
      const host = $("#q3rows");
      host.innerHTML = "";
      q3Items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <b>${it.label}</b>
            <div class="small muted">Classer puis justifier en 2 ou 3 mots</div>
          </div>
          <div>
            <div style="display:grid; gap:8px">
              <select id="q3_nat_${it.id}">
                <option value="">Recette ou depense</option>
                <option value="Recette">Recette</option>
                <option value="Depense">Depense</option>
              </select>
              <select id="q3_type_${it.id}">
                <option value="">Type de recette (si recette)</option>
                <option value="Travail">Revenu lie au travail</option>
                <option value="Social">Revenu social</option>
                <option value="Autre">Autre revenu</option>
              </select>
              <input id="q3_just_${it.id}" type="text" placeholder="Justification courte" />
            </div>
          </div>
        `;
        host.appendChild(row);
      });
    }

    function applyLoaded(){
      setDys(state.dys);
      updateBudgetSlots();

      q2Items.forEach(it=>{
        const v = state.q2[it.id] || "";
        $(`#q2_${it.id}`).value = v;
      });

      q3Items.forEach(it=>{
        const s = state.q3[it.id] || {};
        $(`#q3_nat_${it.id}`).value = s.nature || "";
        $(`#q3_type_${it.id}`).value = s.type || "";
        $(`#q3_just_${it.id}`).value = s.just || "";
        toggleTypeSelect(it.id);
      });

      $("#q4txt").value = state.q4.text || "";
    }

    function updateBudgetSlots(){
      const [a,b,c,d] = state.q1.slot;
      $("#b1").textContent = a ? a : "(choisir)";
      $("#b2").textContent = b ? b : "(choisir)";
      $("#b3").textContent = c ? c : "(choisir)";
      $("#b4").textContent = d ? d : "(choisir)";
    }

    function bindQ1(){
      const chips = $all("#q1 .chip");
      chips.forEach(ch=>{
        ch.addEventListener("click", ()=>{
          state.q1.selectedChip = ch.dataset.chip;
          chips.forEach(x=>x.setAttribute("aria-pressed","false"));
          ch.setAttribute("aria-pressed","true");
          save();
        });
      });

      const slots = [$("#b1"), $("#b2"), $("#b3"), $("#b4")];
      slots.forEach((slotEl, idx)=>{
        slotEl.style.cursor = "pointer";
        slotEl.addEventListener("click", ()=>{
          if(!state.q1.selectedChip) return;
          state.q1.slot[idx] = state.q1.selectedChip;
          updateBudgetSlots();
          save();
        });
      });
    }

    function bindQ2(){
      q2Items.forEach(it=>{
        const sel = $(`#q2_${it.id}`);
        sel.addEventListener("change", ()=>{
          state.q2[it.id] = sel.value;
          save();
        });
      });
    }

    function toggleTypeSelect(id){
      const nat = $(`#q3_nat_${id}`).value;
      const typeSel = $(`#q3_type_${id}`);
      if(nat !== "Recette"){
        typeSel.value = "";
        typeSel.disabled = true;
      }else{
        typeSel.disabled = false;
      }
    }

    function bindQ3(){
      q3Items.forEach(it=>{
        const natSel = $(`#q3_nat_${it.id}`);
        const typeSel = $(`#q3_type_${it.id}`);
        const just = $(`#q3_just_${it.id}`);

        natSel.addEventListener("change", ()=>{
          toggleTypeSelect(it.id);
          state.q3[it.id] = state.q3[it.id] || {};
          state.q3[it.id].nature = natSel.value;
          state.q3[it.id].type = typeSel.value;
          state.q3[it.id].just = just.value;
          save();
        });
        typeSel.addEventListener("change", ()=>{
          state.q3[it.id] = state.q3[it.id] || {};
          state.q3[it.id].nature = natSel.value;
          state.q3[it.id].type = typeSel.value;
          state.q3[it.id].just = just.value;
          save();
        });
        just.addEventListener("input", ()=>{
          state.q3[it.id] = state.q3[it.id] || {};
          state.q3[it.id].nature = natSel.value;
          state.q3[it.id].type = typeSel.value;
          state.q3[it.id].just = just.value;
          save();
        });
      });
    }

    function bindQ4(){
      const ta = $("#q4txt");
      ta.addEventListener("input", ()=>{
        state.q4.text = ta.value;
        save();
      });
    }

    function tag(el, kind, text){
      el.className = "tag " + (kind || "");
      el.textContent = text;
    }

    function correctQ1(){
      const ans = ["recettes","depenses","particulier","periode donnee"];
      const ok = state.q1.slot.map((v,i)=>v === ans[i]);
      const got = ok.filter(Boolean).length;
      const pts = Math.round((got/4) * 4);

      const fb = $("#q1fb");
      fb.innerHTML = "";
      ok.forEach((isOk, i)=>{
        const line = document.createElement("div");
        line.className = "fbLine";
        line.textContent = isOk ? `Emplacement ${i+1} : correct` : `Emplacement ${i+1} : a revoir`;
        line.style.borderColor = isOk ? "rgba(22,163,74,.28)" : "rgba(220,38,38,.28)";
        line.style.background = isOk ? "rgba(22,163,74,.06)" : "rgba(220,38,38,.06)";
        fb.appendChild(line);
      });

      tag($("#q1tag"), got===4 ? "ok" : (got>=2 ? "warnTag" : "bad"), `Score : ${pts} / 4`);
      return pts;
    }

    function correctQ2(){
      let good = 0;
      const fb = $("#q2fb");
      fb.innerHTML = "";

      q2Items.forEach(it=>{
        const val = state.q2[it.id] || "";
        const isOk = val === it.answer;
        if(isOk) good++;
        const line = document.createElement("div");
        line.className = "fbLine";
        line.textContent = `${it.label} : ${isOk ? "correct" : "a revoir"}`;
        line.style.borderColor = isOk ? "rgba(22,163,74,.28)" : "rgba(220,38,38,.28)";
        line.style.background = isOk ? "rgba(22,163,74,.06)" : "rgba(220,38,38,.06)";
        fb.appendChild(line);
      });

      const pts = Math.round((good / q2Items.length) * 6);
      tag($("#q2tag"), good===q2Items.length ? "ok" : (good>=4 ? "warnTag" : "bad"), `Score : ${pts} / 6`);
      return pts;
    }

    function correctQ3(){
      const fb = $("#q3fb");
      fb.innerHTML = "";
      let goodNature = 0;
      let goodType = 0;

      q3Items.forEach(it=>{
        const s = state.q3[it.id] || {};
        const natOk = (s.nature || "") === it.nature;
        if(natOk) goodNature++;

        let typeOk = true;
        if(it.nature === "Recette"){
          typeOk = (s.type || "") === it.type;
          if(typeOk) goodType++;
        }

        const line = document.createElement("div");
        line.className = "fbLine";
        const status = (natOk && typeOk) ? "correct" : "a revoir";
        line.textContent = `${it.label} : ${status}`;
        line.style.borderColor = (natOk && typeOk) ? "rgba(22,163,74,.28)" : "rgba(220,38,38,.28)";
        line.style.background = (natOk && typeOk) ? "rgba(22,163,74,.06)" : "rgba(220,38,38,.06)";
        fb.appendChild(line);
      });

      const ptsNature = Math.round((goodNature / q3Items.length) * 3);
      const recetteCount = q3Items.filter(x=>x.nature==="Recette").length;
      const ptsType = recetteCount ? Math.round((goodType / recetteCount) * 3) : 0;

      const pts = ptsNature + ptsType;
      tag($("#q3tag"), pts===6 ? "ok" : (pts>=4 ? "warnTag" : "bad"), `Score : ${pts} / 6`);
      return pts;
    }

    function correctQ4(){
      const t = ($("#q4txt").value || "").trim();
      const fb = $("#q4fb");
      fb.innerHTML = "";

      const minLen = 160;
      const hasBoth = /travail/i.test(t) && /social/i.test(t);
      const hasExample = /(exemple|par exemple|ex:|ex\\.|comme|salaire|prime|alloc|aide)/i.test(t);

      let pts = 0;
      if(t.length >= minLen) pts++;
      if(hasBoth && hasExample) pts++;

      const line1 = document.createElement("div");
      line1.className = "fbLine";
      line1.textContent = t.length >= minLen ? "Longueur : suffisante" : "Longueur : ajouter des lignes";
      line1.style.borderColor = t.length >= minLen ? "rgba(22,163,74,.28)" : "rgba(180,83,9,.28)";
      line1.style.background = t.length >= minLen ? "rgba(22,163,74,.06)" : "rgba(180,83,9,.06)";
      fb.appendChild(line1);

      const line2 = document.createElement("div");
      line2.className = "fbLine";
      line2.textContent = (hasBoth && hasExample) ? "Contenu : difference + exemple reperes" : "Contenu : preciser la difference et ajouter un exemple";
      line2.style.borderColor = (hasBoth && hasExample) ? "rgba(22,163,74,.28)" : "rgba(180,83,9,.28)";
      line2.style.background = (hasBoth && hasExample) ? "rgba(22,163,74,.06)" : "rgba(180,83,9,.06)";
      fb.appendChild(line2);

      tag($("#q4tag"), pts===2 ? "ok" : (pts===1 ? "warnTag" : "bad"), `Score : ${pts} / 2`);
      return pts;
    }

    function computeProgress(){
      const q1Done = state.q1.slot.filter(Boolean).length >= 4;
      const q2Done = q2Items.every(it => (state.q2[it.id] || "") !== "");
      const q3Done = q3Items.every(it => (state.q3[it.id] || {}).nature);
      const q4Done = ($("#q4txt").value || "").trim().length > 0;

      const done = [q1Done,q2Done,q3Done,q4Done].filter(Boolean).length;
      const pct = Math.round((done/4)*100);
      $("#bar").style.width = pct + "%";
    }

    function bindCorrectors(){
      $all("[data-correct]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.correct;
          if(id==="q1") correctQ1();
          if(id==="q2") correctQ2();
          if(id==="q3") correctQ3();
          if(id==="q4") correctQ4();
          updateGlobalScore(false);
          computeProgress();
        });
      });
    }

    function updateGlobalScore(finalMode){
      const p1 = correctQ1();
      const p2 = correctQ2();
      const p3 = correctQ3();
      const p4 = correctQ4();
      const total = p1+p2+p3+p4; // /18
      $("#globalScore").textContent = finalMode ? `Score : ${Math.min(20, total + 2)} / 20` : `Score : ${total} / 18`;
    }

    function finalGrade(){
      const p1 = correctQ1();
      const p2 = correctQ2();
      const p3 = correctQ3();
      const p4 = correctQ4();
      const auto18 = p1+p2+p3+p4;
      const note = Math.min(20, auto18 + 2);

      const fb = $("#finalFb");
      fb.innerHTML = "";
      const line = document.createElement("div");
      line.className = "fbLine";
      line.style.borderColor = "rgba(15,118,110,.28)";
      line.style.background = "rgba(15,118,110,.06)";
      line.innerHTML = `<b>Note proposee</b> : <span class="mono">${note} / 20</span> (18 points auto + 2 points C6 a valider par l’enseignant)`;
      fb.appendChild(line);

      updateGlobalScore(true);
      computeProgress();
    }

    function exportCopy(){
      const p1 = correctQ1();
      const p2 = correctQ2();
      const p3 = correctQ3();
      const p4 = correctQ4();
      const total18 = p1+p2+p3+p4;

      const lines = [];
      lines.push("PSE D2 - Seance 1 (Partie 1) - Le budget et les revenus");
      lines.push("Nom : ____________________   Prenom : ____________________   Classe : __________");
      lines.push("");
      lines.push("Exercice 1 - Definition de budget");
      lines.push(`Reponses : ${state.q1.slot.join(" | ")}`);
      lines.push(`Score auto : ${p1}/4`);
      lines.push("");
      lines.push("Exercice 2 - Types de revenus");
      q2Items.forEach(it=>{
        lines.push(`- ${it.label} -> ${state.q2[it.id] || ""}`);
      });
      lines.push(`Score auto : ${p2}/6`);
      lines.push("");
      lines.push("Exercice 3 - Recette ou depense + type de recette");
      q3Items.forEach(it=>{
        const s = state.q3[it.id] || {};
        lines.push(`- ${it.label} -> ${s.nature || ""} ; ${s.type || ""} ; Justif : ${s.just || ""}`);
      });
      lines.push(`Score auto : ${p3}/6`);
      lines.push("");
      lines.push("Exercice 4 - Reponse ecrite");
      lines.push(state.q4.text || "");
      lines.push(`Score auto : ${p4}/2`);
      lines.push("");
      lines.push(`Total auto : ${total18}/18`);
      lines.push("Points C6 (presentation, clarte, syntaxe) : +0 a +2 (enseignant)");
      lines.push("");
      lines.push("Fin");

      const blob = new Blob([lines.join("\\n")], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "copie_pse_budget_revenus.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function init(){
      load();
      buildQ2();
      buildQ3();
      bindQ1();
      bindQ2();
      bindQ3();
      bindQ4();
      applyLoaded();
      bindCorrectors();
      computeProgress();
      updateGlobalScore(false);

      $("#btnDys").addEventListener("click", ()=> setDys(!state.dys));
      $("#btnReset").addEventListener("click", resetAll);

      $("#btnFinal").addEventListener("click", finalGrade);
      $("#btnExport").addEventListener("click", exportCopy);

      window.addEventListener("click", computeProgress);
      window.addEventListener("keyup", computeProgress);

      q3Items.forEach(it=> toggleTypeSelect(it.id));
    }

    init();
  </script>
</body>
</html>
