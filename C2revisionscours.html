<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSE Bac Pro – A2 – Rythmes biologiques & Sommeil</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0c1830;
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.58);
      --accent:#7c5cff;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% 5%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 30%, rgba(34,197,94,.10), transparent 55%),
                  radial-gradient(900px 700px at 50% 120%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a{color:inherit}

    .wrap{
      max-width: 1020px;
      margin: 18px auto;
      padding: 14px;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }

    .title{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }

    .badge{
      flex:0 0 auto;
      width:46px;
      height:46px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, rgba(124,92,255,.35), rgba(34,197,94,.20));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
    }

    .badge span{font-weight:800; letter-spacing:.5px}

    h1{
      font-size: clamp(18px, 3.7vw, 30px);
      margin:0;
      line-height:1.12;
    }

    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size: 14px;
      line-height:1.35;
    }

    .pillrow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }

    .pill strong{color:var(--text)}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      align-items:start;
    }

    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
      .pillrow{justify-content:flex-start}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card .head{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }

    .card .head h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }

    .tag{
      font-size:12px;
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      user-select:none;
      white-space:nowrap;
    }

    .card .body{padding: 14px}

    .kblock{
      padding:12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(15,27,51,.55);
    }

    .kblock + .kblock{margin-top:10px}

    .kblock h3{
      margin:0 0 6px;
      font-size: 14px;
      color: rgba(255,255,255,.95);
    }

    .kblock ul{margin: 0; padding-left: 18px; color: var(--muted); line-height:1.45}
    .kblock li{margin:4px 0}

    .note{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(124,92,255,.08);
      border: 1px solid rgba(124,92,255,.25);
      color: var(--muted);
      line-height:1.45;
    }

    .ex{
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(12,24,48,.60);
    }

    .ex + .ex{margin-top:10px}

    .exhead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .exhead .left{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .exhead .label{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      user-select:none;
    }

    .chip strong{color:var(--text)}

    .q{
      margin:0;
      color: rgba(255,255,255,.95);
      font-size:14px;
      line-height:1.38;
    }

    .help{
      font-size: 12px;
      color: var(--muted2);
      line-height:1.35;
    }

    .opts{display:grid; gap:8px; margin-top:10px}

    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }

    .opt input{margin-top:3px}
    .opt:hover{border-color: rgba(124,92,255,.40)}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      touch-action: manipulation;
    }

    .btn:hover{border-color: rgba(124,92,255,.45)}

    .btn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.35), rgba(124,92,255,.18));
      border-color: rgba(124,92,255,.45);
    }

    .btn.good{
      background: linear-gradient(135deg, rgba(34,197,94,.25), rgba(34,197,94,.10));
      border-color: rgba(34,197,94,.35);
    }

    .btn.warn{
      background: linear-gradient(135deg, rgba(245,158,11,.22), rgba(245,158,11,.10));
      border-color: rgba(245,158,11,.35);
    }

    .btn:disabled{opacity:.55; cursor:not-allowed}

    .feedback{
      margin-top:10px;
      padding:10px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.20);
      color: var(--muted);
      line-height:1.45;
      display:none;
    }

    .feedback.show{display:block}

    .ok{border-color: rgba(34,197,94,.40)!important; background: rgba(34,197,94,.08)!important}
    .bad{border-color: rgba(239,68,68,.45)!important; background: rgba(239,68,68,.08)!important}

    .match{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }

    .pair{
      padding:10px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .pair .lhs{font-weight:700; color: rgba(255,255,255,.92)}
    .pair select{
      width: min(360px, 56vw);
      max-width:100%;
      padding:10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }

    .pair select:focus{border-color: rgba(124,92,255,.45)}

    .bank{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      min-height: 52px;
    }

    .token{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(124,92,255,.35);
      background: rgba(124,92,255,.12);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      font-size: 13px;
      white-space:nowrap;
    }

    .token.selected{
      border-color: rgba(124,92,255,.85);
      background: rgba(124,92,255,.28);
      box-shadow: 0 0 0 3px rgba(124,92,255,.18) inset;
    }

    .zones{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    @media (max-width: 560px){
      .zones{grid-template-columns:1fr}
    }

    .zone{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px;
      background: rgba(255,255,255,.02);
      min-height: 92px;
    }

    .zone h4{
      margin:0 0 8px;
      font-size: 13px;
      color: rgba(255,255,255,.90);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }

    .zone .hint{font-size:12px; color: var(--muted2)}

    .zone .slot{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .zone.active{border-color: rgba(124,92,255,.55)}

    textarea{
      width:100%;
      min-height: 84px;
      resize: vertical;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      line-height:1.45;
      font-size: 14px;
    }

    textarea:focus{border-color: rgba(124,92,255,.45)}

    .scorebar{
      margin-top:12px;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .scorebar .big{font-size: 18px; font-weight:900}
    .scorebar .small{color: var(--muted); font-size: 12px; line-height:1.35}

    .progress{
      height:10px;
      width: min(420px, 100%);
      background: rgba(255,255,255,.07);
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
    }

    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(124,92,255,.75), rgba(34,197,94,.70));
      transition: width .35s ease;
    }

    .footer{
      margin-top: 12px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.4;
      text-align:center;
    }

    @media print{
      body{background:white; color:black}
      .wrap{max-width:none}
      .pillrow, .scorebar .progress, .btn{display:none !important}
      .card{box-shadow:none; border:1px solid #bbb}
      .card .head{background:#f2f2f2; color:black}
      .kblock,.ex{background:white}
      .opt, .pair, .zone, .bank{background:white}
      textarea, select{background:white; color:black}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="badge"><span>A2</span></div>
        <div>
          <h1>Rythmes biologiques – Le sommeil</h1>
          <p class="subtitle">Fiche de cours + auto-évaluation (mobile + PC). Objectif : comprendre le cours et s'entraîner sur des questions type PSE.</p>
        </div>
      </div>
      <div class="pillrow">
        <div class="pill">Mode: <strong>mobile + PC</strong></div>
        <div class="pill">Auto-correction: <strong>oui</strong></div>
        <div class="pill">Total: <strong id="totalPts">/</strong></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="head">
          <h2>Rappels essentiels</h2>
          <div class="tag">Cours synthèse</div>
        </div>
        <div class="body">
          <div class="kblock">
            <h3>1) Rythmes biologiques et sommeil</h3>
            <ul>
              <li>Un <strong>rythme biologique</strong> est une variation régulière d'une fonction du corps.</li>
              <li>Le sommeil est un rythme biologique : une nuit comporte environ <strong>4 à 6 cycles</strong>.</li>
              <li>Un cycle dure environ <strong>90 minutes</strong> et comprend <strong>5 phases</strong> (du sommeil léger au sommeil paradoxal).</li>
              <li>Le <strong>sommeil lent profond</strong> participe surtout à la <strong>récupération physique</strong>.</li>
              <li>Le <strong>sommeil paradoxal</strong> participe surtout à la <strong>récupération mentale</strong> (mémoire, émotions).</li>
            </ul>
          </div>

          <div class="kblock">
            <h3>2) Désynchronisation : facteurs et effets</h3>
            <ul>
              <li>La <strong>désynchronisation</strong> = décalage entre nos rythmes biologiques et les rythmes imposés (travail, contraintes, voyages...).</li>
              <li>Facteurs fréquents : <strong>travail posté</strong>, <strong>travail de nuit</strong>, <strong>décalage horaire</strong>, horaires irréguliers.</li>
              <li>Conséquences possibles : santé (fatigue, troubles du sommeil), vie sociale (isolement), vie pro (erreurs, accidents).</li>
            </ul>
          </div>

          <div class="kblock">
            <h3>3) Travail de nuit : points clés</h3>
            <ul>
              <li>Le travail de nuit est <strong>réglementé</strong> car il augmente les risques pour la santé et la sécurité.</li>
              <li>Le salarié bénéficie notamment d'un <strong>repos quotidien de 11 heures</strong> après la période travaillée.</li>
              <li>Il peut exister une <strong>visite d'information et de prévention</strong> et des <strong>repos compensateurs</strong>.</li>
              <li>Le travail de nuit peut être un critère de <strong>pénibilité</strong> (selon seuils et conditions).</li>
            </ul>
          </div>

          <div class="kblock">
            <h3>4) Mesures favorables à un sommeil de qualité</h3>
            <ul>
              <li>Se détendre avant de dormir (activité calme).</li>
              <li>Se coucher à des heures régulières, écouter les signes de fatigue.</li>
              <li>Éviter dîners trop copieux et <strong>excitants</strong> (café, boissons énergisantes).</li>
              <li>Dormir dans un endroit calme, pas trop chaud, et dans l'obscurité.</li>
              <li>Limiter téléphone/tablette/ordinateur dans la chambre.</li>
            </ul>
          </div>

          <div class="note">
            Astuce méthode : lis la consigne, repère les mots-clés, puis cherche la bonne info dans le texte (C1) avant d'analyser (C2) ou d'expliquer (C3).
          </div>
        </div>
      </div>

      <div class="card" id="exo">
        <div class="head">
          <h2>Auto-évaluation notée</h2>
          <div class="tag">Exercices</div>
        </div>
        <div class="body">

          <div class="ex" data-ex="qcm" data-pts="4" id="ex1">
            <div class="exhead">
              <div class="left">
                <div class="label">
                  <span class="chip"><strong>Exercice 1</strong> – QCM</span>
                  <span class="chip">4 pts</span>
                  <span class="chip">C1</span>
                </div>
                <p class="q">Traiter une information : choisis les bonnes valeurs du cours.</p>
                <div class="help">Coche <strong>1 réponse</strong> par question.</div>
              </div>
            </div>

            <div class="kblock">
              <h3>1A. Nombre de cycles par nuit</h3>
              <div class="opts" data-qid="1A" data-right="b">
                <label class="opt"><input type="radio" name="q1A" value="a"> 1 à 2 cycles</label>
                <label class="opt"><input type="radio" name="q1A" value="b"> 4 à 6 cycles</label>
                <label class="opt"><input type="radio" name="q1A" value="c"> 10 à 12 cycles</label>
              </div>
            </div>

            <div class="kblock" style="margin-top:10px">
              <h3>1B. Durée moyenne d'un cycle</h3>
              <div class="opts" data-qid="1B" data-right="c">
                <label class="opt"><input type="radio" name="q1B" value="a"> 30 minutes</label>
                <label class="opt"><input type="radio" name="q1B" value="b"> 60 minutes</label>
                <label class="opt"><input type="radio" name="q1B" value="c"> 90 minutes</label>
              </div>
            </div>

            <div class="kblock" style="margin-top:10px">
              <h3>1C. Nombre de phases dans un cycle</h3>
              <div class="opts" data-qid="1C" data-right="a">
                <label class="opt"><input type="radio" name="q1C" value="a"> 5 phases</label>
                <label class="opt"><input type="radio" name="q1C" value="b"> 2 phases</label>
                <label class="opt"><input type="radio" name="q1C" value="c"> 8 phases</label>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-action="check" data-target="ex1">Corriger</button>
              <button class="btn" data-action="reset" data-target="ex1">Réinitialiser</button>
            </div>
            <div class="feedback" id="fb-ex1"></div>
          </div>


          <div class="ex" data-ex="match" data-pts="4" id="ex2">
            <div class="exhead">
              <div class="left">
                <div class="label">
                  <span class="chip"><strong>Exercice 2</strong> – Associer</span>
                  <span class="chip">4 pts</span>
                  <span class="chip">C3</span>
                </div>
                <p class="q">Expliquer : associe chaque notion à sa bonne explication.</p>
                <div class="help">Choisis dans les menus déroulants.</div>
              </div>
            </div>

            <div class="match">
              <div class="pair" data-right="physique">
                <div class="lhs">Sommeil lent profond</div>
                <select>
                  <option value="">Choisir…</option>
                  <option value="mentale">Récupération mentale</option>
                  <option value="physique">Récupération physique</option>
                  <option value="decalage">Décalage des rythmes</option>
                </select>
              </div>
              <div class="pair" data-right="mentale">
                <div class="lhs">Sommeil paradoxal</div>
                <select>
                  <option value="">Choisir…</option>
                  <option value="mentale">Récupération mentale</option>
                  <option value="physique">Récupération physique</option>
                  <option value="risque">Risque d'accident</option>
                </select>
              </div>
              <div class="pair" data-right="24h">
                <div class="lhs">Rythme circadien</div>
                <select>
                  <option value="">Choisir…</option>
                  <option value="24h">Se répète environ toutes les 24 heures</option>
                  <option value="90">Dure environ 90 minutes</option>
                  <option value="11h">Repos quotidien de 11 heures</option>
                </select>
              </div>
              <div class="pair" data-right="decalage">
                <div class="lhs">Désynchronisation</div>
                <select>
                  <option value="">Choisir…</option>
                  <option value="decalage">Décalage entre rythmes biologiques et rythmes imposés</option>
                  <option value="physique">Récupération physique</option>
                  <option value="cycles">4 à 6 cycles par nuit</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-action="check" data-target="ex2">Corriger</button>
              <button class="btn" data-action="reset" data-target="ex2">Réinitialiser</button>
            </div>
            <div class="feedback" id="fb-ex2"></div>
          </div>


          <div class="ex" data-ex="chips" data-pts="6" id="ex3">
            <div class="exhead">
              <div class="left">
                <div class="label">
                  <span class="chip"><strong>Exercice 3</strong> – Classer</span>
                  <span class="chip">6 pts</span>
                  <span class="chip">C2</span>
                </div>
                <p class="q">Analyser : classe les conséquences de la désynchronisation dans la bonne famille.</p>
                <div class="help"><strong>Mode téléphone</strong> : touche un chip (il devient violet), puis touche une zone pour le déposer. Pour retirer un chip d'une zone : touche le chip (sans sélection).</div>
              </div>
              <div class="chip">Thème : effets</div>
            </div>

            <div class="kblock">
              <h3>Banque (à placer)</h3>
              <div class="bank" id="bank-ex3" aria-label="Banque de mots">
                <span class="token" data-key="fatigue">Fatigue</span>
                <span class="token" data-key="isolement">Isolement</span>
                <span class="token" data-key="erreurs">Erreurs au travail</span>
                <span class="token" data-key="accidents">Accidents</span>
                <span class="token" data-key="troubles">Troubles du sommeil</span>
                <span class="token" data-key="performances">Baisse des performances</span>
              </div>
            </div>

            <div class="zones" data-chips="ex3">
              <div class="zone" data-zone="sante">
                <h4>Santé <span class="hint">(corps / sommeil)</span></h4>
                <div class="slot"></div>
              </div>
              <div class="zone" data-zone="sociale">
                <h4>Vie sociale <span class="hint">(famille / amis)</span></h4>
                <div class="slot"></div>
              </div>
              <div class="zone" data-zone="pro">
                <h4>Vie professionnelle <span class="hint">(travail)</span></h4>
                <div class="slot"></div>
              </div>
              <div class="zone" data-zone="risque">
                <h4>Conséquences sécurité <span class="hint">(danger)</span></h4>
                <div class="slot"></div>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-action="check" data-target="ex3">Corriger</button>
              <button class="btn" data-action="reset" data-target="ex3">Réinitialiser</button>
            </div>
            <div class="feedback" id="fb-ex3"></div>
          </div>


          <div class="ex" data-ex="free" data-pts="4" id="ex4">
            <div class="exhead">
              <div class="left">
                <div class="label">
                  <span class="chip"><strong>Exercice 4</strong> – Proposer</span>
                  <span class="chip">4 pts</span>
                  <span class="chip">C4</span>
                </div>
                <p class="q">Proposer : donne 3 mesures concrètes pour améliorer le sommeil d'un élève.</p>
                <div class="help">Écris des mesures <strong>réalistes</strong> (habitudes + environnement).</div>
              </div>
            </div>

            <textarea id="txt-ex4" placeholder="Exemple : se coucher à heure fixe, éviter les excitants, supprimer les écrans dans la chambre…"></textarea>

            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-action="check" data-target="ex4">Comparer à la correction</button>
              <button class="btn" data-action="reset" data-target="ex4">Réinitialiser</button>
            </div>
            <div class="feedback" id="fb-ex4"></div>
          </div>


          <div class="ex" data-ex="arg" data-pts="6" id="ex5">
            <div class="exhead">
              <div class="left">
                <div class="label">
                  <span class="chip"><strong>Exercice 5</strong> – Argumenter</span>
                  <span class="chip">6 pts</span>
                  <span class="chip">C5</span>
                </div>
                <p class="q">Argumente un choix (2 arguments) : un élève en alternance travaille parfois de nuit. Il hésite à appliquer des règles de sommeil strictes (heures régulières, pas d'écrans, dîner léger). Convaincs-le de faire ce choix.</p>
                <div class="help">Attendu : <strong>2 arguments</strong> liés au cours (santé / sécurité / performances).</div>
              </div>
            </div>

            <textarea id="txt-ex5" placeholder="Je conseille ce choix parce que… (argument 1) … De plus… (argument 2)…"></textarea>

            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-action="check" data-target="ex5">Comparer à la correction</button>
              <button class="btn" data-action="reset" data-target="ex5">Réinitialiser</button>
            </div>
            <div class="feedback" id="fb-ex5"></div>
          </div>


          <div class="scorebar">
            <div>
              <div class="big">Score : <span id="scoreNow">0</span> / <span id="scoreMax">0</span></div>
              <div class="small" id="scoreHint">Corrige au moins un exercice pour voir le détail.</div>
            </div>
            <div class="progress" aria-label="Progression"><div id="bar"></div></div>
            <div class="row">
              <button class="btn good" id="finalBtn">Corriger tout</button>
              <button class="btn warn" id="resetAll">Tout réinitialiser</button>
            </div>
          </div>

          <div class="footer">Conseil : sur smartphone, utilise le mode chips (toucher pour sélectionner puis toucher la zone). Cela fonctionne sur iPhone/Android sans drag & drop.</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const $ = (sel, root=document) => root.querySelector(sel);

  const exos = $$('[id^="ex"]');
  const maxPts = exos.reduce((s, el)=> s + Number(el.dataset.pts||0), 0);
  $('#scoreMax').textContent = String(maxPts);
  $('#totalPts').textContent = String(maxPts) + ' pts';

  const state = {
    scoreByEx: new Map(),
    solved: new Set(),
    selectedToken: null,
  };

  function setScore(exId, pts, detail){
    state.scoreByEx.set(exId, {pts, detail});
    state.solved.add(exId);
    renderScore();
  }

  function renderScore(){
    const now = Array.from(state.scoreByEx.values()).reduce((s,o)=>s+o.pts,0);
    $('#scoreNow').textContent = String(now);
    const pct = maxPts ? Math.round((now/maxPts)*100) : 0;
    $('#bar').style.width = pct + '%';

    if(state.solved.size===0){
      $('#scoreHint').textContent = 'Corrige au moins un exercice pour voir le détail.';
      return;
    }

    const parts = Array.from(state.scoreByEx.entries())
      .map(([id,obj]) => `${id.replace('ex','Ex ')} : ${obj.pts}/${$('#'+id).dataset.pts}`);
    $('#scoreHint').textContent = parts.join(' • ');
  }

  function showFeedback(exId, html){
    const box = $('#fb-' + exId);
    if(!box) return;
    box.innerHTML = html;
    box.classList.add('show');
  }

  function clearFeedback(exId){
    const box = $('#fb-' + exId);
    if(!box) return;
    box.classList.remove('show');
    box.innerHTML = '';
  }

  function resetEx(exId){
    const ex = $('#'+exId);
    clearFeedback(exId);

    // QCM
    $$('input[type="radio"]', ex).forEach(r=>{r.checked=false; r.closest('.opt')?.classList.remove('ok','bad');});

    // MATCH
    $$('select', ex).forEach(s=>{s.value=''; s.closest('.pair')?.classList.remove('ok','bad');});

    // FREE
    $$('textarea', ex).forEach(t=>{t.value=''; t.classList.remove('ok','bad');});

    // CHIPS
    if(exId==='ex3'){
      const bank = $('#bank-ex3');
      const tokens = $$('[data-key]', ex);
      tokens.forEach(t=>{t.classList.remove('selected');});
      // move all tokens back to bank
      tokens.forEach(t=> bank.appendChild(t));
      $$('.zone', ex).forEach(z=>z.classList.remove('active','ok','bad'));
    }

    state.scoreByEx.delete(exId);
    state.solved.delete(exId);
    renderScore();
  }

  function resetAll(){
    exos.forEach(ex => resetEx(ex.id));
  }

  function checkQCM(exId){
    const ex = $('#'+exId);
    const groups = $$('[data-qid]', ex);
    let good = 0;
    let answered = 0;

    groups.forEach(g=>{
      const right = g.dataset.right;
      const chosen = $('input[type="radio"]:checked', g);
      const opts = $$('.opt', g);
      opts.forEach(o=>o.classList.remove('ok','bad'));

      if(chosen){
        answered++;
        const v = chosen.value;
        if(v === right){
          good++;
          chosen.closest('.opt')?.classList.add('ok');
        } else {
          chosen.closest('.opt')?.classList.add('bad');
          // highlight correct
          const correct = $(`input[value="${right}"]`, g);
          correct?.closest('.opt')?.classList.add('ok');
        }
      }
    });

    const ptsMax = Number(ex.dataset.pts||0);
    // 3 mini-questions => pts split
    const pts = Math.round((good / groups.length) * ptsMax);
    setScore(exId, pts);

    let msg = `<strong>Résultat :</strong> ${good}/${groups.length} bonnes réponses → <strong>${pts}/${ptsMax} pts</strong><br>`;
    if(answered < groups.length) msg += `<br><em>Tu n'as pas répondu à tout : corrige puis complète.</em>`;
    msg += `<br><br><strong>Correction rapide :</strong> 4 à 6 cycles • 90 minutes • 5 phases.`;
    showFeedback(exId, msg);
  }

  function checkMatch(exId){
    const ex = $('#'+exId);
    const pairs = $$('.pair', ex);
    let good = 0;

    pairs.forEach(p=>{
      p.classList.remove('ok','bad');
      const sel = $('select', p);
      const right = p.dataset.right;
      if(sel.value && sel.value === right){
        good++;
        p.classList.add('ok');
      } else {
        p.classList.add('bad');
      }
    });

    const ptsMax = Number(ex.dataset.pts||0);
    const pts = Math.round((good / pairs.length) * ptsMax);
    setScore(exId, pts);

    const corr = {
      physique:'Sommeil lent profond → récupération physique',
      mentale:'Sommeil paradoxal → récupération mentale',
      '24h':'Rythme circadien → ~24 h',
      decalage:'Désynchronisation → décalage entre rythmes'
    };
    const msg = `<strong>Résultat :</strong> ${good}/${pairs.length} → <strong>${pts}/${ptsMax} pts</strong><br>` +
      `<br><strong>Correction :</strong><br>• ${corr.physique}<br>• ${corr.mentale}<br>• ${corr['24h']}<br>• ${corr.decalage}`;
    showFeedback(exId, msg);
  }

  const ex3KeyToZone = {
    fatigue: 'sante',
    troubles: 'sante',
    isolement: 'sociale',
    erreurs: 'pro',
    performances: 'pro',
    accidents: 'risque'
  };

  function checkChips(exId){
    const ex = $('#'+exId);
    const zones = $$('.zone', ex);

    // mark
    let good = 0;
    let total = 0;

    zones.forEach(z=>{
      z.classList.remove('ok','bad');
      const zoneName = z.dataset.zone;
      const tokens = $$('[data-key]', z);
      tokens.forEach(t=>{
        total++;
        const k = t.dataset.key;
        if(ex3KeyToZone[k] === zoneName){
          good++;
        }
      });
    });

    const ptsMax = Number(ex.dataset.pts||0);
    const pts = total ? Math.round((good/total) * ptsMax) : 0;
    setScore(exId, pts);

    // show correction placements
    const corrLines = Object.entries(ex3KeyToZone)
      .map(([k,z])=>({
        k,
        z,
        txt: ({fatigue:'Fatigue', troubles:'Troubles du sommeil', isolement:'Isolement', erreurs:'Erreurs au travail', performances:'Baisse des performances', accidents:'Accidents'})[k]
      }))
      .reduce((acc,o)=>{
        acc[o.z] = acc[o.z] || [];
        acc[o.z].push(o.txt);
        return acc;
      },{});

    const msg = `<strong>Résultat :</strong> ${good}/${total} placements corrects → <strong>${pts}/${ptsMax} pts</strong><br><br>` +
      `<strong>Correction :</strong><br>` +
      `• Santé : ${corrLines.sante.join(', ')}<br>` +
      `• Vie sociale : ${corrLines.sociale.join(', ')}<br>` +
      `• Vie pro : ${corrLines.pro.join(', ')}<br>` +
      `• Sécurité : ${corrLines.risque.join(', ')}`;
    showFeedback(exId, msg);

    // visual: highlight zones where an item is wrong
    zones.forEach(z=>{
      const zoneName = z.dataset.zone;
      const tokens = $$('[data-key]', z);
      const wrong = tokens.some(t=> ex3KeyToZone[t.dataset.key] !== zoneName);
      z.classList.add(wrong ? 'bad' : 'ok');
    });
  }

  function norm(s){
    return (s||'')
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9\s]/g,' ')
      .replace(/\s+/g,' ')
      .trim();
  }

  function containsAny(text, keywords){
    const t = norm(text);
    return keywords.some(k => t.includes(norm(k)));
  }

  function checkFree(exId){
    const ex = $('#'+exId);
    const ptsMax = Number(ex.dataset.pts||0);
    const t = $('#txt-' + exId);
    const val = (t?.value||'').trim();

    if(!val){
      setScore(exId, 0);
      showFeedback(exId, `<strong>0/${ptsMax} pts</strong> : écris au moins 3 mesures avant de corriger.`);
      return;
    }

    const measures = [
      ['heures regulieres','se coucher a heure','heure reguliere','horaire regulier','routine'],
      ['eviter les excitants','cafe','boisson energisante','the'],
      ['supprimer les ecrans','telephone','tablette','ordinateur','ecran'],
      ['diner leger','manger leger','pas trop copieux'],
      ['calme','obscurite','pas trop chaud','16','18','temperature']
    ];

    let hits = 0;
    measures.forEach(kws=>{ if(containsAny(val, kws)) hits++; });

    // expect at least 3 distinct ideas
    let pts = 0;
    if(hits >= 3) pts = ptsMax;
    else if(hits === 2) pts = Math.max(1, Math.round(ptsMax*0.5));
    else if(hits === 1) pts = Math.max(1, Math.round(ptsMax*0.25));
    else pts = 0;

    setScore(exId, pts);

    const corr = `Exemples attendus : heures régulières • écouter les signes de fatigue • activité calme • éviter excitants • dîner léger • chambre calme/obscure/pas trop chaude • limiter les écrans.`;
    showFeedback(exId, `<strong>Auto-estimation :</strong> ${pts}/${ptsMax} pts (repérage d'idées dans ta réponse)<br><br><strong>Correction :</strong> ${corr}`);
  }

  function checkArg(exId){
    const ex = $('#'+exId);
    const ptsMax = Number(ex.dataset.pts||0);
    const t = $('#txt-' + exId);
    const val = (t?.value||'').trim();

    if(!val){
      setScore(exId, 0);
      showFeedback(exId, `<strong>0/${ptsMax} pts</strong> : écris 2 arguments avant de corriger.`);
      return;
    }

    const argA = ['fatigue','troubles du sommeil','sante','recuperation','horloge biologique','desynchronisation'];
    const argB = ['erreurs','accidents','securite','attention','concentration','performances'];
    const argC = ['memoire','recuperation mentale','stress','humeur'];

    let scoreParts = 0;
    if(containsAny(val, argA)) scoreParts++;
    if(containsAny(val, argB)) scoreParts++;
    if(containsAny(val, argC)) scoreParts++;

    // require at least 2 different axes
    let pts = 0;
    if(scoreParts >= 2) pts = ptsMax;
    else if(scoreParts === 1) pts = Math.max(2, Math.round(ptsMax*0.5));
    else pts = 0;

    setScore(exId, pts);

    const corr = `Exemple de réponse : Je te conseille ce choix car un sommeil régulier réduit la désynchronisation et donc la fatigue et les troubles du sommeil. De plus, mieux dormir améliore l'attention et la concentration, ce qui limite les erreurs et les accidents au travail et augmente les performances.`;
    showFeedback(exId, `<strong>Auto-estimation :</strong> ${pts}/${ptsMax} pts (présence d'arguments liés au cours)<br><br><strong>Correction :</strong> ${corr}`);
  }

  function check(exId){
    const ex = $('#'+exId);
    const type = ex.dataset.ex;
    if(type === 'qcm') return checkQCM(exId);
    if(type === 'match') return checkMatch(exId);
    if(type === 'chips') return checkChips(exId);
    if(type === 'free') return checkFree(exId);
    if(type === 'arg') return checkArg(exId);
  }

  // Buttons
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-action]');
    if(!btn) return;
    const action = btn.dataset.action;
    const target = btn.dataset.target;
    if(action === 'check') check(target);
    if(action === 'reset') resetEx(target);
  });

  // Final buttons
  $('#finalBtn').addEventListener('click', ()=>{
    ['ex1','ex2','ex3','ex4','ex5'].forEach(id=> check(id));
  });

  $('#resetAll').addEventListener('click', ()=> resetAll());

  // Chips interaction for ex3 (mobile + desktop)
  const ex3 = $('#ex3');
  const bank = $('#bank-ex3');

  function selectToken(token){
    $$('.token', ex3).forEach(t=>t.classList.remove('selected'));
    state.selectedToken = token;
    if(token){ token.classList.add('selected'); }
  }

  function clearZoneActive(){
    $$('.zone', ex3).forEach(z=>z.classList.remove('active'));
  }

  // Tap token: if inside a zone and no token is selected => remove to bank
  ex3.addEventListener('click', (e)=>{
    const token = e.target.closest('.token');
    if(!token) return;

    const inZone = token.closest('.zone');
    if(inZone && !state.selectedToken){
      bank.appendChild(token);
      clearZoneActive();
      clearFeedback('ex3');
      return;
    }

    // toggle select
    if(state.selectedToken === token){
      selectToken(null);
      clearZoneActive();
    } else {
      selectToken(token);
      // highlight zones
      $$('.zone', ex3).forEach(z=>z.classList.add('active'));
    }

    clearFeedback('ex3');
  });

  // Tap zone: place selected token
  $$('.zone', ex3).forEach(zone => {
    zone.addEventListener('click', ()=>{
      if(!state.selectedToken) return;
      const slot = $('.slot', zone);
      slot.appendChild(state.selectedToken);
      selectToken(null);
      clearZoneActive();
      clearFeedback('ex3');
    });
  });

  // Desktop drag & drop support (optional)
  // (keeps same behavior on mobile)
  $$('.token', ex3).forEach(t => {
    t.setAttribute('draggable','true');
    t.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', t.dataset.key);
      t.classList.add('selected');
    });
    t.addEventListener('dragend', ()=>{
      t.classList.remove('selected');
    });
  });

  function allowDrop(ev){ ev.preventDefault(); }

  [bank, ...$$('.zone .slot', ex3)].forEach(target => {
    target.addEventListener('dragover', allowDrop);
    target.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      const key = ev.dataTransfer.getData('text/plain');
      const token = $(`.token[data-key="${key}"]`, ex3);
      if(token) target.appendChild(token);
      clearFeedback('ex3');
    });
  });

  // init
  renderScore();
})();
</script>
</body>
</html>
