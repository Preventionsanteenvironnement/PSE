<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ“Š Mes RÃ©sultats PSE</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- âœ… Chart.js (fix 404) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- âœ… BDD Ã©lÃ¨ves -->
  <script src="data_eleves.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 0;
      background: #f8f9fa;
      color: #333;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* === HEADER === */
    header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      padding: 16px 20px;
      text-align: center;
      color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    h1 { margin: 0; font-weight: 700; font-size: 1.4em; }
    h1::before { content: "ğŸ“Š "; }

    main { padding: 12px; }

    /* === LOGIN SCREEN === */
    .login-screen {
      background: white;
      border-radius: 16px;
      padding: 30px 20px;
      max-width: 350px;
      margin: 30px auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      text-align: center;
    }
    .login-icon { font-size: 3.5em; margin-bottom: 15px; }
    .login-title { font-size: 1.3em; font-weight: 700; margin-bottom: 8px; color: #1e293b; }
    .login-subtitle { color: #64748b; margin-bottom: 20px; font-size: 0.9em; }
    .code-input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1.1em;
      text-align: center;
      letter-spacing: 3px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 12px;
      transition: border 0.2s;
    }
    .code-input:focus { outline: none; border-color: #f59e0b; }
    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .login-btn:active { transform: scale(0.98); }
    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 10px;
      border-radius: 8px;
      margin-top: 12px;
      display: none;
      font-size: 0.9em;
      border-left: 3px solid #dc2626;
    }
    .error-message.visible { display: block; }
    .btn-retour {
      background: #e2e8f0;
      color: #475569;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 12px;
      font-size: 0.9em;
    }

    /* === RESULTS SCREEN === */
    .results-screen { display: none; }
    .results-screen.active { display: block; }

    /* === STUDENT BANNER === */
    .student-banner {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #78350f;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .student-info { display: flex; align-items: center; gap: 10px; }
    .student-name { font-size: 1.1em; font-weight: 700; }
    .student-class {
      background: rgba(255,255,255,0.3);
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.85em;
    }
    .banner-actions { display: flex; gap: 8px; }
    .logout-btn, .btn-home {
      background: rgba(255,255,255,0.3);
      border: none;
      color: #78350f;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85em;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION MA POSTURE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .posture-section {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
      box-shadow: 0 2px 10px rgba(251, 191, 36, 0.3);
    }
    .posture-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .posture-title { font-size: 1.1em; font-weight: 700; color: #92400e; display: flex; align-items: center; gap: 6px; }
    .pronote-badge { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 700; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3); }
    .posture-etoiles { display: flex; justify-content: center; gap: 8px; margin: 12px 0; }
    .etoile-btn { font-size: 2em; background: none; border: none; cursor: pointer; transition: transform 0.2s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
    .etoile-btn:active { transform: scale(1.2); }
    .etoile-btn.empty { opacity: 0.3; }
    .posture-progress { background: rgba(255,255,255,0.5); border-radius: 10px; height: 8px; margin: 10px 0; overflow: hidden; }
    .posture-progress-bar { height: 100%; background: linear-gradient(90deg, #f59e0b, #22c55e); border-radius: 10px; transition: width 0.5s ease; }
    .posture-message { text-align: center; font-weight: 600; color: #78350f; font-size: 0.95em; }
    .posture-stats { display: flex; justify-content: center; gap: 16px; margin-top: 10px; font-size: 0.8em; color: #92400e; }
    .posture-stat { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.4); padding: 4px 10px; border-radius: 12px; }
    .posture-section.achieved { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3); }
    .posture-section.achieved .posture-title,
    .posture-section.achieved .posture-message,
    .posture-section.achieved .posture-stats { color: #166534; }
    .posture-section.achieved .pronote-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION MON HUMEUR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .humeur-section { background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .humeur-label { font-weight: 600; color: #64748b; font-size: 0.85em; white-space: nowrap; }
    .humeur-emojis { display: flex; gap: 6px; }
    .humeur-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #e2e8f0; background: white; font-size: 1.3em; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .humeur-btn:active { transform: scale(1.1); }
    .humeur-btn.selected { border-color: #ec4899; background: #fdf2f8; transform: scale(1.1); box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ONGLET / STYLES DIVERS (inchangÃ©s)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .tabs-container { margin-bottom: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .tabs-container::-webkit-scrollbar { display: none; }
    .tabs { display: flex; gap: 6px; padding: 4px; background: white; border-radius: 12px; min-width: max-content; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .tab { padding: 10px 14px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 0.8em; color: #64748b; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
    .tab.active { background: #f59e0b; color: white; box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3); }
    .tab:not(.active):active { background: #fef3c7; }
    .tab-badge { background: #ef4444; color: white; font-size: 0.65em; padding: 2px 5px; border-radius: 8px; font-weight: 700; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
    .stat-card { background: white; border-radius: 12px; padding: 14px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .stat-value { font-size: 1.5em; font-weight: 800; color: #f59e0b; }
    .stat-label { font-size: 0.75em; color: #64748b; margin-top: 2px; }

    .eval-card { background: white; border-radius: 12px; padding: 14px; margin-bottom: 10px; position: relative; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #f59e0b; }
    .eval-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .eval-title { font-weight: 700; font-size: 0.95em; color: #1e293b; margin-bottom: 6px; }
    .eval-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .eval-date { font-size: 0.8em; color: #64748b; }
    .status-badge { display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 700; }
    .status-corrected { background: #dcfce7; color: #166534; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-nn { background: #fed7aa; color: #c2410c; }
    .status-absent { background: #fee2e2; color: #991b1b; }
    .eval-note { font-weight: 800; font-size: 1.2em; padding: 6px 12px; border-radius: 8px; white-space: nowrap; }
    .note-excellent { background: #dcfce7; color: #166534; }
    .note-good { background: #dbeafe; color: #1e40af; }
    .note-average { background: #fef3c7; color: #92400e; }
    .note-poor { background: #fee2e2; color: #991b1b; }
    .note-pending { background: #e2e8f0; color: #64748b; }
    .note-nn { background: #fef3c7; color: #b45309; }
    .note-absent { background: #fee2e2; color: #dc2626; }
    .btn-view { width: 100%; margin-top: 10px; background: #3b82f6; color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; }
    .btn-view:disabled { background: #cbd5e1; cursor: not-allowed; }

    .suivi-header { background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; text-align: center; }
    .suivi-stats-row { display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; }
    .suivi-moyenne { font-size: 2em; font-weight: 800; }
    .suivi-presence { font-size: 1.4em; font-weight: 700; }
    .suivi-label { font-size: 0.85em; opacity: 0.9; margin-top: 8px; }
    .tendances-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
    .tendance-card { background: white; border-radius: 10px; padding: 10px 6px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .tendance-icon { font-size: 1.2em; }
    .tendance-label { font-size: 0.65em; color: #64748b; margin: 2px 0; }
    .tendance-value { font-size: 0.9em; font-weight: 700; }

    .seance-card { background: white; border-radius: 10px; margin-bottom: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-left: 4px solid #8b5cf6; }
    .seance-card.seance-absent { border-left-color: #f59e0b; background: #fffbeb; }
    .seance-header { display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; }
    .seance-info { display: flex; flex-direction: column; gap: 2px; }
    .seance-date { font-weight: 700; color: #1e293b; font-size: 0.9em; }
    .seance-module { font-size: 0.8em; color: #64748b; }
    .seance-note { display: flex; align-items: center; gap: 6px; }
    .seance-note-value { font-size: 1.1em; font-weight: 800; }
    .seance-note-icon { font-size: 1.2em; }
    .seance-note-value.absent { color: #92400e; }
    .note-excellent-suivi { color: #16a34a; }
    .note-good-suivi { color: #8b5cf6; }
    .note-average-suivi { color: #f59e0b; }
    .note-poor-suivi { color: #dc2626; }
    .seance-detail { display: none; padding: 12px; background: #f8fafc; border-top: 1px solid #e2e8f0; }
    .seance-detail.open { display: block; }
    .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.85em; }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { color: #64748b; }
    .detail-value { font-weight: 600; }
    .detail-value.good { color: #16a34a; }
    .detail-value.medium { color: #f59e0b; }
    .detail-value.bad { color: #dc2626; }
    .seance-comment { margin-top: 8px; padding: 10px; background: #eff6ff; border-radius: 6px; font-style: italic; color: #1e40af; font-size: 0.85em; border-left: 3px solid #3b82f6; }

    .bilan-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .bilan-semaine-info { background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 12px; border-radius: 10px; margin-bottom: 16px; text-align: center; border: 2px solid #10b981; }
    .bilan-semaine-titre { font-weight: 700; color: #065f46; font-size: 1em; }
    .bilan-semaine-dates { color: #047857; font-size: 0.85em; margin-top: 4px; }
    .bilan-form-group { background: #f8fafc; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .bilan-form-group label { display: block; font-weight: 600; color: #1e293b; margin-bottom: 10px; font-size: 0.9em; }
    .bilan-form-group label span { font-size: 1.1em; margin-right: 6px; }
    .bilan-slider-container { display: flex; align-items: center; gap: 12px; }
    .bilan-slider { flex: 1; height: 8px; border-radius: 4px; -webkit-appearance: none; background: linear-gradient(to right, #fee2e2, #fef3c7, #dcfce7); }
    .bilan-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: white; border: 3px solid #10b981; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .bilan-slider-value { font-size: 1.3em; min-width: 35px; text-align: center; }
    .bilan-radio-group { display: flex; gap: 6px; flex-wrap: wrap; }
    .bilan-radio-btn { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8em; transition: all 0.2s; background: white; }
    .bilan-radio-btn.selected { background: #10b981; color: white; border-color: #10b981; }
    .bilan-textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9em; resize: vertical; min-height: 60px; font-family: inherit; }
    .bilan-textarea:focus { outline: none; border-color: #10b981; }
    .bilan-submit-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 1em; font-weight: 700; cursor: pointer; margin-top: 8px; }
    .bilan-submit-btn:active { transform: scale(0.98); }
    .bilan-message { display: none; text-align: center; padding: 12px; background: #dcfce7; border-radius: 8px; color: #166534; font-weight: 600; margin-top: 12px; }
    .bilan-message.visible { display: block; }
    .bilan-historique { margin-top: 16px; padding-top: 16px; border-top: 2px dashed #e2e8f0; }
    .bilan-historique-titre { font-weight: 700; color: #065f46; margin-bottom: 12px; font-size: 0.95em; }
    .bilan-historique-item { background: #f0fdf4; border-radius: 8px; padding: 10px; margin-bottom: 8px; border-left: 3px solid #10b981; }
    .bilan-historique-semaine { font-weight: 600; color: #065f46; font-size: 0.85em; }
    .bilan-historique-resume { display: flex; gap: 12px; margin-top: 6px; flex-wrap: wrap; font-size: 0.8em; color: #047857; }

    .cours-module-card { background: white; border-radius: 10px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .cours-module-header { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 12px 14px; font-weight: 700; }
    .cours-module-header .module-code { font-size: 1em; }
    .cours-module-header .module-titre { font-size: 0.8em; opacity: 0.9; margin-top: 2px; }
    .cours-seances-list { padding: 8px 0; }
    .cours-seance-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-bottom: 1px solid #f1f5f9; }
    .cours-seance-row:last-child { border-bottom: none; }
    .cours-seance-info { display: flex; align-items: center; gap: 8px; }
    .cours-seance-icon { font-size: 1em; }
    .cours-seance-nom { font-weight: 600; font-size: 0.9em; }
    .cours-seance-date { font-size: 0.8em; color: #64748b; }
    .cours-seance-status { font-weight: 600; padding: 4px 8px; border-radius: 6px; font-size: 0.75em; }
    .cours-seance-status.recu { background: #dcfce7; color: #166534; }
    .cours-seance-status.manquant { background: #fee2e2; color: #991b1b; }
    .cours-alerte { background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
    .cours-alerte-icon { font-size: 1.2em; }
    .cours-alerte-text { font-weight: 600; color: #92400e; font-size: 0.9em; }

    .bienetre-content { background: white; border-radius: 16px; padding: 24px 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .bienetre-icon { font-size: 3em; margin-bottom: 12px; }
    .bienetre-titre { font-size: 1.2em; font-weight: 700; color: #1e293b; margin-bottom: 10px; }
    .bienetre-description { color: #64748b; line-height: 1.5; font-size: 0.9em; margin-bottom: 16px; }
    .bienetre-teaser { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .bienetre-teaser-card { background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 10px; padding: 14px 10px; border: 2px dashed #cbd5e1; }
    .bienetre-teaser-icon { font-size: 1.5em; margin-bottom: 6px; }
    .bienetre-teaser-text { font-weight: 600; color: #64748b; font-size: 0.8em; }

    .charts-row { display: grid; gap: 12px; margin-bottom: 12px; }
    .chart-card { background: white; border-radius: 12px; padding: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .chart-title { font-weight: 700; margin-bottom: 10px; color: #1e293b; font-size: 0.95em; }
    .chart-container { position: relative; height: 250px; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: flex-end; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; border-radius: 20px 20px 0 0; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
    .modal-title { font-size: 1.1em; font-weight: 700; }
    .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2em; font-weight: bold; }
    .modal-body { padding: 16px; }

    .empty-state { text-align: center; padding: 40px 16px; color: #94a3b8; }
    .empty-icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
    .empty-text { font-size: 0.95em; font-weight: 600; }

    .appreciation-block { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 4px solid #f59e0b; padding: 14px; border-radius: 8px; margin-bottom: 16px; }
    .appreciation-title { font-weight: 700; color: #78350f; margin-bottom: 8px; font-size: 0.95em; }
    .appreciation-title::before { content: "ğŸ’¬ "; }
    .appreciation-text { color: #78350f; line-height: 1.5; font-size: 0.9em; }

    .question-card-grid { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 14px; margin-bottom: 12px; }
    .question-header-grid { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; gap: 6px; }
    .question-number-grid { font-weight: 700; font-size: 1em; color: #f59e0b; }
    .question-comp-grid { background: #f0f9ff; padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 0.75em; color: #3b82f6; }
    .question-level-grid { padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 0.8em; }
    .question-text-grid { color: #1e293b; margin-bottom: 12px; line-height: 1.5; font-size: 0.9em; }
    .answer-section-grid { background: #f0f9ff; border-left: 3px solid #3b82f6; padding: 10px; border-radius: 0 6px 6px 0; margin-bottom: 8px; }
    .correction-section-grid { background: #dcfce7; border-left: 3px solid #22c55e; padding: 10px; border-radius: 0 6px 6px 0; margin-bottom: 8px; }
    .comment-section-grid { background: #fffbeb; border-left: 3px solid #fbbf24; padding: 10px; border-radius: 0 6px 6px 0; }
    .section-label-grid { font-weight: 600; margin-bottom: 6px; font-size: 0.85em; }
    .section-content-grid { line-height: 1.5; font-size: 0.85em; }
    .answer-section-grid .section-label-grid { color: #1e40af; }
    .correction-section-grid .section-label-grid { color: #166534; }
    .comment-section-grid .section-label-grid { color: #78350f; }
    .badge-M { background: #dcfce7; color: #166534; }
    .badge-A { background: #dbeafe; color: #1e40af; }
    .badge-I { background: #fef3c7; color: #92400e; }
    .badge-NT { background: #e2e8f0; color: #475569; }

    .question-compact { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: white; border: 1px solid #e2e8f0; border-left: 4px solid #22c55e; border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; gap: 8px; }
    .question-compact:active { background: #f8fafc; }
    .question-compact .qc-left { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
    .question-compact .qc-num { font-weight: 700; color: #64748b; font-size: 0.85em; white-space: nowrap; }
    .question-compact .qc-text { font-size: 0.82em; color: #475569; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .question-compact .qc-badge { flex-shrink: 0; }
    .question-compact-detail { display: none; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; margin-top: -6px; margin-bottom: 6px; }
    .question-compact-detail.open { display: block; }

    .matching-display { display: flex; flex-direction: column; gap: 4px; }
    .matching-row { display: flex; align-items: center; gap: 8px; font-size: 0.85em; padding: 4px 8px; background: rgba(255,255,255,0.5); border-radius: 4px; }
    .matching-arrow { color: #3b82f6; font-weight: 700; }

    .no-blueprint-info { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; text-align: center; color: #92400e; font-size: 0.85em; margin-bottom: 12px; }

    .no-print { }
    @media print {
      body { max-width: 100%; }
      .no-print { display: none !important; }
      header { position: static; }
    }

    /* Modal V2 (inchangÃ©) */
    .modal-note-banner { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-radius: 12px; margin-bottom: 16px; gap: 12px; }
    .modal-note-banner.excellent { background: linear-gradient(135deg, #dcfce7, #bbf7d0); }
    .modal-note-banner.good { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
    .modal-note-banner.average { background: linear-gradient(135deg, #fef3c7, #fde68a); }
    .modal-note-banner.poor { background: linear-gradient(135deg, #fee2e2, #fecaca); }
    .modal-note-banner.nn { background: linear-gradient(135deg, #f1f5f9, #e2e8f0); }
    .modal-note-big { font-size: 2em; font-weight: 800; line-height: 1; }
    .modal-note-banner.excellent .modal-note-big { color: #166534; }
    .modal-note-banner.good .modal-note-big { color: #1e40af; }
    .modal-note-banner.average .modal-note-big { color: #92400e; }
    .modal-note-banner.poor .modal-note-big { color: #991b1b; }
    .modal-note-banner.nn .modal-note-big { color: #475569; }
    .modal-note-bar { flex: 1; height: 10px; background: rgba(255,255,255,0.5); border-radius: 5px; overflow: hidden; }
    .modal-note-bar-fill { height: 100%; border-radius: 5px; transition: width 0.6s ease; }
    .modal-note-banner.excellent .modal-note-bar-fill { background: #16a34a; }
    .modal-note-banner.good .modal-note-bar-fill { background: #3b82f6; }
    .modal-note-banner.average .modal-note-bar-fill { background: #f59e0b; }
    .modal-note-banner.poor .modal-note-bar-fill { background: #ef4444; }

    .comp-summary { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 14px; margin-bottom: 16px; }
    .comp-summary-title { font-weight: 700; font-size: 0.95em; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    .comp-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
    .comp-row:last-child { border-bottom: none; }
    .comp-name { font-weight: 600; font-size: 0.85em; color: #475569; min-width: 30px; }
    .comp-bar-wrap { flex: 1; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
    .comp-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .comp-bar-fill.level-M { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .comp-bar-fill.level-A { background: linear-gradient(90deg, #60a5fa, #3b82f6); }
    .comp-bar-fill.level-I { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    .comp-bar-fill.level-NT { background: #cbd5e1; }
    .comp-points { font-size: 0.8em; font-weight: 700; color: #64748b; min-width: 50px; text-align: right; }
    .comp-level-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 28px; padding: 3px 8px; border-radius: 6px; font-size: 0.75em; font-weight: 800; }

    .modal-section-header { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 8px; margin-bottom: 10px; font-weight: 700; font-size: 0.9em; }
    .modal-section-header.section-errors { background: linear-gradient(135deg, #fef2f2, #fee2e2); color: #991b1b; border-left: 4px solid #ef4444; }
    .modal-section-header.section-success { background: linear-gradient(135deg, #f0fdf4, #dcfce7); color: #166534; border-left: 4px solid #22c55e; }
    .section-count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }

    .question-card-grid.card-error { border: 2px solid #fca5a5; border-left: 5px solid #ef4444; background: #fffbfb; }
    .question-card-grid.card-success { border: 1px solid #e2e8f0; border-left: 4px solid #22c55e; opacity: 0.9; }
  </style>
</head>

<body>
  <header class="no-print">
    <h1>Mes RÃ©sultats PSE</h1>
  </header>

  <div class="login-screen" id="loginScreen">
    <div class="login-icon">ğŸ”</div>
    <div class="login-title">AccÃ¨s Ã‰lÃ¨ve</div>
    <div class="login-subtitle">Entre ton code personnel</div>
    <input type="text" id="codeInput" class="code-input" placeholder="CODE" maxlength="12" autofocus>
    <button class="login-btn" onclick="connexion()">Se connecter</button>
    <div class="error-message" id="errorMsg">Code incorrect.</div>
    <button class="btn-retour" onclick="window.location.href='https://preventionsanteenvironnement.github.io/PSE/'">â¬…ï¸ Retour</button>
  </div>

  <div class="results-screen" id="resultsScreen">
    <main>
      <div class="student-banner no-print">
        <div class="student-info">
          <span class="student-name" id="studentName">Ã‰lÃ¨ve</span>
          <span class="student-class" id="studentClass">Classe</span>
        </div>
        <div class="banner-actions">
          <button class="btn-home" onclick="window.location.href='https://preventionsanteenvironnement.github.io/PSE/'">ğŸ </button>
          <button class="logout-btn" onclick="deconnexion()">ğŸšª</button>
        </div>
      </div>

      <div class="posture-section" id="postureSection">
        <div class="posture-header">
          <div class="posture-title">ğŸŒŸ Ma posture</div>
          <div class="pronote-badge" id="pronoteBadge">ğŸ¯ Encouragement Pronote</div>
        </div>
        <div class="posture-etoiles" id="postureEtoiles">
          <button class="etoile-btn empty" data-star="1">â˜†</button>
          <button class="etoile-btn empty" data-star="2">â˜†</button>
          <button class="etoile-btn empty" data-star="3">â˜†</button>
          <button class="etoile-btn empty" data-star="4">â˜†</button>
          <button class="etoile-btn empty" data-star="5">â˜†</button>
        </div>
        <div class="posture-progress"><div class="posture-progress-bar" id="postureProgressBar" style="width: 0%;"></div></div>
        <div class="posture-message" id="postureMessage">Continue comme Ã§a ! ğŸ†</div>
        <div class="posture-stats">
          <div class="posture-stat">ğŸ”¥ SÃ©rie : <strong id="serieActuelle">0</strong></div>
          <div class="posture-stat">ğŸ… Record : <strong id="serieRecord">0</strong></div>
        </div>
      </div>

      <div class="humeur-section" id="humeurSection">
        <div class="humeur-label">ğŸ˜Š Aujourd'hui :</div>
        <div class="humeur-emojis">
          <button class="humeur-btn" onclick="selectHumeur('super', 'ğŸ¤©')" data-humeur="super">ğŸ¤©</button>
          <button class="humeur-btn" onclick="selectHumeur('bien', 'ğŸ˜Š')" data-humeur="bien">ğŸ˜Š</button>
          <button class="humeur-btn" onclick="selectHumeur('normal', 'ğŸ˜')" data-humeur="normal">ğŸ˜</button>
          <button class="humeur-btn" onclick="selectHumeur('bof', 'ğŸ˜”')" data-humeur="bof">ğŸ˜”</button>
          <button class="humeur-btn" onclick="selectHumeur('difficile', 'ğŸ˜¢')" data-humeur="difficile">ğŸ˜¢</button>
        </div>
      </div>

      <div class="tabs-container no-print">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('evaluations', this)">ğŸ“Š Ã‰valuations</button>
          <button class="tab" onclick="switchTab('suivi', this)">ğŸ¯ En classe</button>
          <button class="tab" onclick="switchTab('bilan', this)">ğŸ“‹ Bilan</button>
          <button class="tab" onclick="switchTab('cours', this)">ğŸ“š Cours</button>
          <button class="tab" onclick="switchTab('bienetre', this)">ğŸŒ± Bien-Ãªtre <span class="tab-badge">BIENTÃ”T</span></button>
        </div>
      </div>

      <div class="tab-content active" id="tabEvaluations">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value" id="statMoyenne">--</div><div class="stat-label">Moyenne</div></div>
          <div class="stat-card"><div class="stat-value" id="statCorriges">0</div><div class="stat-label">CorrigÃ©es</div></div>
        </div>
        <div id="evalList"></div>
      </div>

      <div class="tab-content" id="tabSuivi">
        <div id="suiviContent"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Chargement...</div></div></div>
      </div>

      <div class="tab-content" id="tabBilan">
        <div class="bilan-card">
          <div class="bilan-semaine-info">
            <div class="bilan-semaine-titre">ğŸ“… Ma semaine</div>
            <div class="bilan-semaine-dates" id="bilanSemaineDates">Semaine du ... au ...</div>
          </div>
          <p style="color: #64748b; font-size: 0.85em; margin-bottom: 16px; text-align: center;">Fais le point sur ta semaine ! C'est <strong>ton espace</strong> pour t'auto-Ã©valuer. ğŸ¯</p>
          <div class="bilan-form-group"><label><span>ğŸ¯</span> Ma concentration</label><div class="bilan-slider-container"><input type="range" class="bilan-slider" id="bilanConcentration" min="1" max="5" value="3" oninput="updateSliderEmoji('bilanConcentration', 'bilanConcentrationEmoji')"><span class="bilan-slider-value" id="bilanConcentrationEmoji">ğŸ˜</span></div></div>
          <div class="bilan-form-group"><label><span>ğŸ’ª</span> Mon engagement</label><div class="bilan-slider-container"><input type="range" class="bilan-slider" id="bilanEngagement" min="1" max="5" value="3" oninput="updateSliderEmoji('bilanEngagement', 'bilanEngagementEmoji')"><span class="bilan-slider-value" id="bilanEngagementEmoji">ğŸ˜</span></div></div>
          <div class="bilan-form-group"><label><span>â¤ï¸</span> J'ai reconnu mes Ã©motions</label><div class="bilan-slider-container"><input type="range" class="bilan-slider" id="bilanEmotions" min="1" max="5" value="3" oninput="updateSliderEmoji('bilanEmotions', 'bilanEmotionsEmoji')"><span class="bilan-slider-value" id="bilanEmotionsEmoji">ğŸ˜</span></div></div>
          <div class="bilan-form-group"><label><span>ğŸ”¥</span> J'ai gÃ©rÃ© une difficultÃ©</label><div class="bilan-radio-group" id="bilanGestionGroup"><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGestion', 'oui', this)">âœ… Oui</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGestion', 'un_peu', this)">ğŸ¤ Un peu</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGestion', 'non', this)">âŒ Non</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGestion', 'pas_eu', this)">ğŸ¤· Pas eu</button></div><input type="hidden" id="bilanGestion" value=""></div>
          <div class="bilan-form-group"><label><span>ğŸ¤</span> Mes relations</label><div class="bilan-slider-container"><input type="range" class="bilan-slider" id="bilanRelations" min="1" max="5" value="3" oninput="updateSliderEmoji('bilanRelations', 'bilanRelationsEmoji')"><span class="bilan-slider-value" id="bilanRelationsEmoji">ğŸ˜</span></div></div>
          <div class="bilan-form-group"><label><span>âš¡</span> Conflit rencontrÃ© / rÃ©solu</label><div class="bilan-radio-group" id="bilanConflitGroup"><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanConflit', 'resolu', this)">âœ… RÃ©solu</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanConflit', 'en_cours', this)">â³ En cours</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanConflit', 'non_resolu', this)">âŒ Non</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanConflit', 'pas_eu', this)">ğŸ¤· Pas eu</button></div><input type="hidden" id="bilanConflit" value=""></div>
          <div class="bilan-form-group"><label><span>â­</span> Ma fiertÃ©</label><textarea class="bilan-textarea" id="bilanFierte" placeholder="De quoi es-tu fier(e) ?"></textarea></div>
          <div class="bilan-form-group"><label><span>ğŸ“Š</span> Ma semaine en un mot</label><div class="bilan-radio-group" id="bilanGlobalGroup"><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGlobal', 'super', this)">ğŸ¤© Super</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGlobal', 'bien', this)">ğŸ˜Š Bien</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGlobal', 'moyen', this)">ğŸ˜ Moyen</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGlobal', 'difficile', this)">ğŸ˜” Difficile</button></div><input type="hidden" id="bilanGlobal" value=""></div>
          <button class="bilan-submit-btn" onclick="sauvegarderBilan()">âœ… Enregistrer mon bilan</button>
          <div class="bilan-message" id="bilanMessage">âœ… Bilan enregistrÃ© ! Bravo ğŸ’ª</div>
          <div class="bilan-historique" id="bilanHistorique" style="display: none;">
            <div class="bilan-historique-titre">ğŸ“œ Mes bilans prÃ©cÃ©dents</div>
            <div id="bilanHistoriqueList"></div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tabCours">
        <div id="coursContent"><div class="empty-state"><div class="empty-icon">ğŸ“„</div><div class="empty-text">Chargement...</div></div></div>
      </div>

      <div class="tab-content" id="tabBienetre">
        <div class="bienetre-content">
          <div class="bienetre-icon">ğŸŒ±</div>
          <div class="bienetre-titre">Bien-Ãªtre & SantÃ©</div>
          <div class="bienetre-description">BientÃ´t disponible ! Tu trouveras ici des ressources pour mieux te connaÃ®tre et dÃ©velopper tes compÃ©tences psychosociales.<br><br><strong>BasÃ© sur SantÃ© Publique France ğŸ‡«ğŸ‡·</strong></div>
          <div class="bienetre-teaser">
            <div class="bienetre-teaser-card"><div class="bienetre-teaser-icon">â¤ï¸</div><div class="bienetre-teaser-text">Mes Ã©motions</div></div>
            <div class="bienetre-teaser-card"><div class="bienetre-teaser-icon">ğŸ’ª</div><div class="bienetre-teaser-text">GÃ©rer le stress</div></div>
            <div class="bienetre-teaser-card"><div class="bienetre-teaser-icon">ğŸ¤</div><div class="bienetre-teaser-text">Communiquer</div></div>
            <div class="bienetre-teaser-card"><div class="bienetre-teaser-icon">ğŸ¯</div><div class="bienetre-teaser-text">Me concentrer</div></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal-overlay" id="modalDetail">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">DÃ©tail</div>
        <button class="modal-close" onclick="fermerModal()">Ã—</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, collectionGroup, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUserCode = null;
    let currentEleveInfo = null;
    let allEvaluations = [];
    let allSuivis = [];

    window.connexion = async function() {
      const code = document.getElementById('codeInput').value.trim().toUpperCase();
      if (!code) return;
      document.getElementById('errorMsg').classList.remove('visible');
      try {
        let eleveInfo = null;
        if (typeof window.BDD_ELEVES !== 'undefined') {
          eleveInfo = window.BDD_ELEVES.find(e => e.userCode === code);
        }
        if (!eleveInfo) {
          document.getElementById('errorMsg').textContent = "Code inconnu.";
          document.getElementById('errorMsg').classList.add('visible');
          return;
        }
        currentUserCode = code;
        currentEleveInfo = eleveInfo;
        localStorage.setItem('pse_user_code', code);

        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('resultsScreen').classList.add('active');
        document.getElementById('studentName').textContent = code;
        document.getElementById('studentClass').textContent = eleveInfo.classe || "";

        await chargerDonnees();
        await enregistrerConsultation(code, eleveInfo.classe);
        chargerHumeurDuJour();
        initBilanSemaine();
      } catch (e) {
        console.error("Erreur connexion:", e);
        alert("Erreur: " + e.message);
      }
    };

    window.deconnexion = function() {
      localStorage.removeItem('pse_user_code');
      location.reload();
    };

    async function enregistrerConsultation(code, classe) {
      try {
        const now = new Date();
        const consultationRef = doc(db, "consultations", code);
        const docSnap = await getDoc(consultationRef);
        const count = docSnap.exists() ? (docSnap.data().nombreVisites || 0) : 0;
        await setDoc(consultationRef, {
          eleveCode: code,
          classe: classe,
          derniereConsultation: now.toISOString(),
          timestamp: serverTimestamp(),
          nombreVisites: count + 1
        }, { merge: true });
      } catch (error) { console.error("Erreur consultation:", error); }
    }

    async function chargerDonnees() {
      try {
        const qCopies = query(collectionGroup(db, "copies"), where("eleveCode", "==", currentUserCode));
        const snapCopies = await getDocs(qCopies);

        const qEvals = query(collectionGroup(db, "evaluations"), where("eleveCode", "==", currentUserCode));
        const snapEvals = await getDocs(qEvals);

        const evalsMap = new Map();
        snapEvals.forEach(docu => { const evalData = docu.data(); evalsMap.set(evalData.devoirId, evalData); });

        allEvaluations = [];
        snapCopies.forEach(docSnap => {
          const copie = docSnap.data();
          const evaluation = evalsMap.get(copie.devoirId);
          allEvaluations.push({
            id: docSnap.id,
            copie,
            evaluation,
            estCorrige: !!evaluation,
            devoirId: copie.devoirId,
            titre: copie.titre || "Devoir",
            date: copie.createdAtISO || copie.createdAt?.toDate?.() || new Date(),
            note: evaluation?.note_finale ?? null,
            nonNote: evaluation?.nonNote || false,
            appreciation: evaluation?.appreciation || "",
            competences: evaluation?.competences || {},
            questions: evaluation?.questions || {},
            reponses: copie.reponses || {}
          });
        });

        allEvaluations.sort((a, b) => new Date(b.date) - new Date(a.date));
        afficherStatistiques();
        afficherListeEvaluations();
        await chargerSuivi();
      } catch (e) { console.error("Erreur chargement:", e); }
    }

    function afficherStatistiques() {
      const corriges = allEvaluations.filter(e => e.estCorrige);
      const notes = corriges
        .filter(e => e.note !== null && e.note !== "NN" && e.note !== "ABS" && !e.nonNote && !isNaN(e.note))
        .map(e => parseFloat(e.note));
      const moyenne = notes.length > 0 ? (notes.reduce((a, b) => a + b, 0) / notes.length).toFixed(1) : "--";
      document.getElementById('statMoyenne').textContent = moyenne + (moyenne !== "--" ? "/20" : "");
      document.getElementById('statCorriges').textContent = corriges.length;
    }

    function afficherListeEvaluations() {
      const container = document.getElementById('evalList');
      if (allEvaluations.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Aucune Ã©valuation</div></div>`;
        return;
      }
      container.innerHTML = allEvaluations.map(item => {
        const dateStr =
          item.date instanceof Date ? item.date.toLocaleDateString('fr-FR') :
          typeof item.date === 'string' ? new Date(item.date).toLocaleDateString('fr-FR') : '--';

        let statusBadge;
        if (item.note === "ABS" || item.absent) statusBadge = '<span class="status-badge status-absent">ğŸš« Absent</span>';
        else if (item.note === "NN" || item.nonNote) statusBadge = '<span class="status-badge status-nn">âš ï¸ NN</span>';
        else if (item.estCorrige) statusBadge = '<span class="status-badge status-corrected">âœ“ CorrigÃ©</span>';
        else statusBadge = '<span class="status-badge status-pending">â³</span>';

        let noteClass = 'note-pending', noteText = '--';
        if (item.note === "ABS" || item.absent) { noteText = 'ABS'; noteClass = 'note-absent'; }
        else if (item.note === "NN" || item.nonNote) { noteText = 'NN'; noteClass = 'note-nn'; }
        else if (item.note !== null && !isNaN(item.note)) {
          noteText = parseFloat(item.note).toFixed(1);
          if (item.note >= 16) noteClass = 'note-excellent';
          else if (item.note >= 12) noteClass = 'note-good';
          else if (item.note >= 10) noteClass = 'note-average';
          else noteClass = 'note-poor';
        }

        return `<div class="eval-card">
          <div class="eval-header">
            <div>
              <div class="eval-title">${item.titre}</div>
              <div class="eval-meta"><span class="eval-date">ğŸ“… ${dateStr}</span>${statusBadge}</div>
            </div>
            <div class="eval-note ${noteClass}">${noteText}</div>
          </div>
          <button class="btn-view" onclick="ouvrirDetail('${item.id}')" ${!item.estCorrige ? 'disabled' : ''}>
            ğŸ‘ï¸ ${item.estCorrige ? 'Voir ma copie' : 'En attente...'}
          </button>
        </div>`;
      }).join('');
    }

    async function chargerSuivi() {
      if (!currentUserCode) return;
      try {
        const suiviRef = collection(db, "resultats", currentUserCode, "suivi");
        const suiviSnap = await getDocs(suiviRef);
        allSuivis = [];
        suiviSnap.forEach(docu => { allSuivis.push({ id: docu.id, ...docu.data() }); });
        allSuivis.sort((a, b) => {
          const dateA = a.date + ' ' + (a.heure || '00:00');
          const dateB = b.date + ' ' + (b.heure || '00:00');
          return dateB.localeCompare(dateA);
        });
        afficherSuivi();
        calculerPosture();
      } catch (error) { console.error("Erreur suivi:", error); }
    }

    function calculerMoyenneSuivi() {
      const seancesAvecNote = allSuivis.filter(s => !s.absent && s.noteSur20 !== null && s.noteSur20 !== undefined);
      if (seancesAvecNote.length === 0) return 0;
      return Math.round((seancesAvecNote.reduce((acc, s) => acc + (s.noteSur20 || 0), 0) / seancesAvecNote.length) * 10) / 10;
    }

    function calculerTendances() {
      const result = { travail: 0, oral: 0, attention: 0, porteVue: 0 };
      const seancesPresent = allSuivis.filter(s => !s.absent);
      if (seancesPresent.length === 0) return result;

      let travailBon = 0, travailTotal = 0;
      seancesPresent.forEach(s => {
        if (s.travail && s.travail !== 'ne') {
          travailTotal++;
          if (s.travail === 'tresbien' || s.travail === 'fait') travailBon++;
        }
      });
      if (travailTotal > 0) result.travail = Math.round((travailBon / travailTotal) * 100);

      let oralTotal = 0, oralCount = 0;
      seancesPresent.forEach(s => {
        if (s.oral !== undefined && s.oral !== null && s.oral !== 'ne') {
          const val = parseInt(s.oral);
          if (!isNaN(val)) { oralCount++; oralTotal += val; }
        }
      });
      if (oralCount > 0) result.oral = Math.round((oralTotal / oralCount / 4) * 100);

      let attentionBon = 0, attentionTotal = 0;
      seancesPresent.forEach(s => {
        if (s.attention && s.attention !== 'ne') {
          attentionTotal++;
          if (s.attention === 'bonne') attentionBon++;
        }
      });
      if (attentionTotal > 0) result.attention = Math.round((attentionBon / attentionTotal) * 100);

      let pvBon = 0, pvTotal = 0;
      seancesPresent.forEach(s => {
        if (s.porteVue && s.porteVue !== 'ne') {
          pvTotal++;
          if (s.porteVue === 'ok') pvBon++;
        }
      });
      if (pvTotal > 0) result.porteVue = Math.round((pvBon / pvTotal) * 100);

      return result;
    }

    function getNoteIconSuivi(note) { if (note >= 18) return 'ğŸ†'; if (note >= 15) return 'â­'; if (note >= 12) return 'ğŸ‘'; if (note >= 10) return 'ğŸ’ª'; return 'ğŸ“ˆ'; }
    function getNoteClassSuivi(note) { if (note >= 18) return 'note-excellent-suivi'; if (note >= 15) return 'note-good-suivi'; if (note >= 12) return 'note-average-suivi'; return 'note-poor-suivi'; }
    function formatDateSuivi(dateStr) { if (!dateStr) return '--'; const d = new Date(dateStr); return d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }); }

    function renderSeanceDetail(s) {
      let html = '';
      const travailMap = { 'tresbien': { label: 'âœ“âœ“ TrÃ¨s bien', cls: 'good' }, 'fait': { label: 'âœ“ Fait', cls: 'good' }, 'partiel': { label: 'âš ï¸ Partiel', cls: 'medium' }, 'insuffisant': { label: 'âŒ Non fait', cls: 'bad' } };
      const attentionMap = { 'bonne': { label: 'ğŸ˜Š Bonne', cls: 'good' }, 'moyenne': { label: 'ğŸ˜ Moyenne', cls: 'medium' }, 'insuffisante': { label: 'ğŸ˜• Insuffisante', cls: 'bad' } };
      const pvMap = { 'ok': { label: 'âœ… OK', cls: 'good' }, 'oubli': { label: 'âŒ OubliÃ©', cls: 'bad' } };
      if (s.travail && travailMap[s.travail]) html += `<div class="detail-row"><span class="detail-label">ğŸ“ Travail</span><span class="detail-value ${travailMap[s.travail].cls}">${travailMap[s.travail].label}</span></div>`;
      if (s.attention && attentionMap[s.attention]) html += `<div class="detail-row"><span class="detail-label">ğŸ§  Attention</span><span class="detail-value ${attentionMap[s.attention].cls}">${attentionMap[s.attention].label}</span></div>`;
      if (s.porteVue && pvMap[s.porteVue]) html += `<div class="detail-row"><span class="detail-label">ğŸ“ MatÃ©riel</span><span class="detail-value ${pvMap[s.porteVue].cls}">${pvMap[s.porteVue].label}</span></div>`;
      if (s.commentaire) html += `<div class="seance-comment">ğŸ’¬ ${s.commentaire}</div>`;
      return html || '<div style="color:#94a3b8;font-size:0.85em;">Pas de dÃ©tails</div>';
    }

    function afficherSuivi() {
      const container = document.getElementById('suiviContent');
      if (allSuivis.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Pas encore de suivi</div></div>`;
        return;
      }
      const seancesPresent = allSuivis.filter(s => !s.absent);
      const nbTotal = allSuivis.length, nbPresent = seancesPresent.length;
      const tauxPresence = nbTotal > 0 ? Math.round((nbPresent / nbTotal) * 100) : 0;
      const moyenne = calculerMoyenneSuivi();
      const tendances = calculerTendances();
      let moyenneIcon = moyenne >= 15 ? 'â­' : moyenne >= 12 ? 'ğŸ‘' : 'ğŸ“ˆ';
      let presenceColor = tauxPresence >= 85 ? '#16a34a' : tauxPresence >= 70 ? '#f59e0b' : '#dc2626';

      let html =
        `<div class="suivi-header">
          <div class="suivi-stats-row">
            <div class="suivi-moyenne">${moyenneIcon} ${moyenne}/20</div>
            <div class="suivi-presence" style="color: ${presenceColor};">ğŸ“… ${tauxPresence}%</div>
          </div>
          <div class="suivi-label">Moyenne â€¢ ${nbPresent}/${nbTotal} sÃ©ances</div>
        </div>

        <div class="tendances-grid">
          <div class="tendance-card"><div class="tendance-icon">ğŸ“</div><div class="tendance-label">Travail</div><div class="tendance-value">${tendances.travail}%</div></div>
          <div class="tendance-card"><div class="tendance-icon">ğŸ—£ï¸</div><div class="tendance-label">Oral</div><div class="tendance-value">${tendances.oral}%</div></div>
          <div class="tendance-card"><div class="tendance-icon">ğŸ§ </div><div class="tendance-label">Attention</div><div class="tendance-value">${tendances.attention}%</div></div>
          <div class="tendance-card"><div class="tendance-icon">ğŸ“</div><div class="tendance-label">MatÃ©riel</div><div class="tendance-value">${tendances.porteVue}%</div></div>
        </div>

        <h4 style="margin-bottom: 10px; color: #1e293b; font-size: 0.95em;">ğŸ“… Historique</h4>`;

      allSuivis.forEach((s, idx) => {
        const dateFormatted = formatDateSuivi(s.date);
        if (s.absent) {
          html += `<div class="seance-card seance-absent">
            <div class="seance-header">
              <div class="seance-info"><div class="seance-date">${dateFormatted}</div><div class="seance-module">${s.module || ''}</div></div>
              <div class="seance-note"><span class="seance-note-value absent">ABS</span><span class="seance-note-icon">ğŸš«</span></div>
            </div>
          </div>`;
        } else {
          const noteIcon = getNoteIconSuivi(s.noteSur20);
          const noteClass = getNoteClassSuivi(s.noteSur20);
          html += `<div class="seance-card">
            <div class="seance-header" onclick="toggleSeanceDetail(${idx})">
              <div class="seance-info"><div class="seance-date">${dateFormatted}</div><div class="seance-module">${s.module || ''}</div></div>
              <div class="seance-note"><span class="seance-note-value ${noteClass}">${s.noteSur20}/20</span><span class="seance-note-icon">${noteIcon}</span></div>
            </div>
            <div class="seance-detail" id="seanceDetail${idx}">${renderSeanceDetail(s)}</div>
          </div>`;
        }
      });

      container.innerHTML = html;
    }

    window.toggleSeanceDetail = function(idx) {
      const el = document.getElementById('seanceDetail' + idx);
      if (el) el.classList.toggle('open');
    };

    function calculerPosture() {
      const section = document.getElementById('postureSection');
      if (!section) return;

      const suivisTries = [...allSuivis].sort((a, b) => {
        const dateA = a.date + ' ' + (a.heure || '00:00');
        const dateB = b.date + ' ' + (b.heure || '00:00');
        return dateA.localeCompare(dateB);
      });

      function estSeanceParfaite(s) {
        if (s.absent) return false;
        if (s.bavardage && s.bavardage !== 'aucun') return false;
        if (s.telephone && s.telephone !== 'ok') return false;
        if (s.noteSur20 === null || s.noteSur20 === undefined || s.noteSur20 < 12) return false;
        return true;
      }

      let serieRecord = 0, tempSerie = 0;
      for (const s of suivisTries) {
        if (estSeanceParfaite(s)) { tempSerie++; if (tempSerie > serieRecord) serieRecord = tempSerie; }
        else tempSerie = 0;
      }

      let serieActuelle = 0;
      for (let i = suivisTries.length - 1; i >= 0; i--) {
        if (estSeanceParfaite(suivisTries[i])) serieActuelle++;
        else break;
      }

      let etoilesHtml = '';
      for (let i = 0; i < 5; i++) {
        etoilesHtml += i < serieActuelle
          ? `<button class="etoile-btn" data-star="${i+1}">â­</button>`
          : `<button class="etoile-btn empty" data-star="${i+1}">â˜†</button>`;
      }
      document.getElementById('postureEtoiles').innerHTML = etoilesHtml;
      document.getElementById('postureProgressBar').style.width = Math.min(100, (serieActuelle / 5) * 100) + '%';
      document.getElementById('serieActuelle').textContent = serieActuelle;
      document.getElementById('serieRecord').textContent = serieRecord;

      const messageEl = document.getElementById('postureMessage');
      const badgeEl = document.getElementById('pronoteBadge');

      if (serieActuelle >= 5) {
        section.classList.add('achieved');
        messageEl.textContent = 'ğŸ‰ BRAVO ! Objectif atteint !';
        badgeEl.innerHTML = 'ğŸ† DÃ‰BLOQUÃ‰ !';
      } else {
        section.classList.remove('achieved');
        const restant = 5 - serieActuelle;
        messageEl.textContent =
          serieActuelle === 0 ? 'Commence ta sÃ©rie ! ğŸ†' :
          serieActuelle === 4 ? "Plus qu'une sÃ©ance ! ğŸ†" :
          `Encore ${restant} sÃ©ance${restant > 1 ? 's' : ''} ! ğŸ†`;
      }
    }

    window.selectHumeur = async function(humeurKey, emoji) {
      document.querySelectorAll('.humeur-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelector(`.humeur-btn[data-humeur="${humeurKey}"]`)?.classList.add('selected');
      if (currentUserCode) {
        try {
          const today = new Date().toISOString().split('T')[0];
          await setDoc(doc(db, 'resultats', currentUserCode, 'emotions', today), {
            emotion: humeurKey,
            emoji: emoji,
            date: today,
            timestamp: serverTimestamp()
          });
        } catch (error) { console.error('Erreur humeur:', error); }
      }
    };

    async function chargerHumeurDuJour() {
      if (!currentUserCode) return;
      try {
        const today = new Date().toISOString().split('T')[0];
        const humeurSnap = await getDoc(doc(db, 'resultats', currentUserCode, 'emotions', today));
        if (humeurSnap.exists()) {
          document.querySelector(`.humeur-btn[data-humeur="${humeurSnap.data().emotion}"]`)?.classList.add('selected');
        }
      } catch (error) { console.error('Erreur chargement humeur:', error); }
    }

    window.updateSliderEmoji = function(sliderId, emojiId) {
      const emojis = ['ğŸ˜¢', 'ğŸ˜”', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];
      document.getElementById(emojiId).textContent = emojis[parseInt(document.getElementById(sliderId).value) - 1];
    };

    window.selectBilanRadio = function(inputId, value, btn) {
      btn.parentElement.querySelectorAll('.bilan-radio-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById(inputId).value = value;
    };

    function getSemaineActuelle() {
      const today = new Date(), dayOfWeek = today.getDay();
      const monday = new Date(today);
      monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      const options = { day: 'numeric', month: 'long' };
      return {
        display: `Semaine du ${monday.toLocaleDateString('fr-FR', options)} au ${sunday.toLocaleDateString('fr-FR', options)}`,
        key: monday.toISOString().split('T')[0]
      };
    }

    function initBilanSemaine() {
      const semaine = getSemaineActuelle();
      document.getElementById('bilanSemaineDates').textContent = semaine.display;
      chargerBilanSemaine(semaine.key);
    }

    async function chargerBilanSemaine(semaineKey) {
      if (!currentUserCode) return;
      try {
        const bilanSnap = await getDoc(doc(db, 'resultats', currentUserCode, 'bilans', semaineKey));
        if (bilanSnap.exists()) {
          const data = bilanSnap.data();
          if (data.concentration) { document.getElementById('bilanConcentration').value = data.concentration; updateSliderEmoji('bilanConcentration', 'bilanConcentrationEmoji'); }
          if (data.engagement) { document.getElementById('bilanEngagement').value = data.engagement; updateSliderEmoji('bilanEngagement', 'bilanEngagementEmoji'); }
          if (data.emotions) { document.getElementById('bilanEmotions').value = data.emotions; updateSliderEmoji('bilanEmotions', 'bilanEmotionsEmoji'); }
          if (data.relations) { document.getElementById('bilanRelations').value = data.relations; updateSliderEmoji('bilanRelations', 'bilanRelationsEmoji'); }
          if (data.fierte) document.getElementById('bilanFierte').value = data.fierte;
        }
        chargerBilanHistorique();
      } catch (error) { console.error('Erreur bilan:', error); }
    }

    window.sauvegarderBilan = async function() {
      if (!currentUserCode) return;
      const semaine = getSemaineActuelle();
      try {
        await setDoc(doc(db, 'resultats', currentUserCode, 'bilans', semaine.key), {
          semaine: semaine.key,
          semaineDisplay: semaine.display,
          concentration: parseInt(document.getElementById('bilanConcentration').value),
          engagement: parseInt(document.getElementById('bilanEngagement').value),
          emotions: parseInt(document.getElementById('bilanEmotions').value),
          relations: parseInt(document.getElementById('bilanRelations').value),
          gestion: document.getElementById('bilanGestion').value,
          conflit: document.getElementById('bilanConflit').value,
          global: document.getElementById('bilanGlobal').value,
          fierte: document.getElementById('bilanFierte').value.trim(),
          timestamp: serverTimestamp()
        });
        document.getElementById('bilanMessage').classList.add('visible');
        setTimeout(() => document.getElementById('bilanMessage').classList.remove('visible'), 3000);
        chargerBilanHistorique();
      } catch (error) { console.error('Erreur sauvegarde:', error); alert('Erreur'); }
    };

    async function chargerBilanHistorique() {
      if (!currentUserCode) return;
      try {
        const bilansSnap = await getDocs(collection(db, 'resultats', currentUserCode, 'bilans'));
        const bilans = [];
        bilansSnap.forEach(d => bilans.push({ id: d.id, ...d.data() }));

        const semaineActuelle = getSemaineActuelle().key;
        const anciensBilans = bilans.filter(b => b.semaine !== semaineActuelle).sort((a, b) => b.semaine.localeCompare(a.semaine)).slice(0, 4);

        const historiqueSection = document.getElementById('bilanHistorique');
        const historiqueEl = document.getElementById('bilanHistoriqueList');

        if (anciensBilans.length > 0) {
          historiqueSection.style.display = 'block';
          const globalEmojis = { 'super': 'ğŸ¤©', 'bien': 'ğŸ˜Š', 'moyen': 'ğŸ˜', 'difficile': 'ğŸ˜”' };
          historiqueEl.innerHTML = anciensBilans.map(b =>
            `<div class="bilan-historique-item">
              <div class="bilan-historique-semaine">${b.semaineDisplay || b.semaine}</div>
              <div class="bilan-historique-resume">
                <span>${globalEmojis[b.global] || '?'}</span>
                <span>ğŸ¯ ${b.concentration}/5</span>
                <span>ğŸ’ª ${b.engagement}/5</span>
              </div>
            </div>`
          ).join('');
        } else {
          historiqueSection.style.display = 'none';
        }
      } catch (error) { console.error('Erreur historique:', error); }
    }

    function afficherCours() {
      const container = document.getElementById('coursContent');
      const suivisAvecCours = allSuivis.filter(s => s.coursDistrib && s.coursDistrib !== 'aucun');
      if (suivisAvecCours.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“„</div><div class="empty-text">Pas encore de cours</div></div>`;
        return;
      }

      const parModule = {};
      suivisAvecCours.forEach(s => {
        const moduleKey = s.module || 'Inconnu';
        if (!parModule[moduleKey]) parModule[moduleKey] = { module: s.module, moduleTitre: s.moduleTitre, seances: [] };
        parModule[moduleKey].seances.push({ type: s.coursDistrib, date: s.date, recu: !(s.absent && s.coursRecu === false) });
      });

      let coursManquants = 0;
      Object.values(parModule).forEach(m => m.seances.forEach(s => { if (!s.recu) coursManquants++; }));

      const coursLabels = { 'seance1': 'SÃ©ance 1', 'seance2': 'SÃ©ance 2', 'seance3': 'SÃ©ance 3', 'seance4': 'SÃ©ance 4', 'complet': 'Cours complet' };

      let html = '';
      if (coursManquants > 0) html += `<div class="cours-alerte"><span class="cours-alerte-icon">âš ï¸</span><span class="cours-alerte-text">${coursManquants} cours Ã  rÃ©cupÃ©rer</span></div>`;

      Object.values(parModule).forEach(m => {
        html += `<div class="cours-module-card">
          <div class="cours-module-header">
            <div class="module-code">${m.module || 'Module'}</div>
            <div class="module-titre">${m.moduleTitre || ''}</div>
          </div>
          <div class="cours-seances-list">`;

        m.seances.sort((a, b) => a.date.localeCompare(b.date)).forEach(s => {
          const label = coursLabels[s.type] || s.type;
          const icon = s.type === 'complet' ? 'ğŸ“š' : 'ğŸ“„';
          html += `<div class="cours-seance-row">
            <div class="cours-seance-info">
              <span class="cours-seance-icon">${icon}</span>
              <div>
                <div class="cours-seance-nom">${label}</div>
                <div class="cours-seance-date">${formatDateSuivi(s.date)}</div>
              </div>
            </div>
            <span class="cours-seance-status ${s.recu ? 'recu' : 'manquant'}">${s.recu ? 'âœ… ReÃ§u' : 'âŒ Ã€ rÃ©cup'}</span>
          </div>`;
        });

        html += `</div></div>`;
      });

      container.innerHTML = html;
    }

    /* Modal dÃ©tail: ton code complet reste inchangÃ© ici (coller tel quel si tu veux), je nâ€™ai pas modifiÃ© sa logique */

    window.switchTab = function(tabName, btn) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
      if (tabName === 'cours') afficherCours();
    };

    window.addEventListener('DOMContentLoaded', () => {
      const savedCode = localStorage.getItem('pse_user_code');
      if (savedCode) { document.getElementById('codeInput').value = savedCode; connexion(); }
      document.getElementById('codeInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') connexion(); });
    });

    document.getElementById('modalDetail').addEventListener('click', (e) => {
      if (e.target.id === 'modalDetail') fermerModal();
    });

    window.fermerModal = function() {
      document.getElementById('modalDetail').classList.remove('active');
    };

   window.ouvrirDetail = async function(evalId) {
  const evaluation = allEvaluations.find(e => e.id === evalId);
  if (!evaluation || !evaluation.estCorrige) {
    alert('Ã‰valuation non disponible');
    return;
  }

  document.getElementById('modalTitle').textContent = evaluation.titre || 'DÃ©tail';
  
  let noteClass = 'nn';
  let noteText = 'NN';
  if (evaluation.note !== null && !isNaN(evaluation.note)) {
    const n = parseFloat(evaluation.note);
    noteText = n.toFixed(1);
    if (n >= 16) noteClass = 'excellent';
    else if (n >= 12) noteClass = 'good'; 
    else if (n >= 10) noteClass = 'average';
    else noteClass = 'poor';
  }

  let html = `
    <div class="modal-note-banner ${noteClass}">
      <div class="modal-note-big">${noteText}/20</div>
      <div class="modal-note-bar">
        <div class="modal-note-bar-fill" style="width: ${evaluation.note ? (evaluation.note/20*100) : 0}%"></div>
      </div>
    </div>
  `;

  if (evaluation.appreciation) {
    html += `
      <div class="appreciation-block">
        <div class="appreciation-title">ApprÃ©ciation gÃ©nÃ©rale</div>
        <div class="appreciation-text">${evaluation.appreciation}</div>
      </div>
    `;
  }

  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalDetail').classList.add('active');
};
  </script>
</body>
</html>
