<!DOCTYPE html>
<html lang="fr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>ğŸ“Š Mes RÃ©sultats PSE</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  Â  <script src="data_eleves.js"></script>
Â  Â  <style>
Â  Â  Â  Â  * { box-sizing: border-box; margin: 0; padding: 0; }
Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;Â 
Â  Â  Â  Â  Â  Â  max-width: 500px;Â 
Â  Â  Â  Â  Â  Â  margin: 0 auto;Â 
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  background: #f8f9fa;Â 
Â  Â  Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* === HEADER === */
Â  Â  Â  Â  header {Â 
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);Â 
Â  Â  Â  Â  Â  Â  padding: 16px 20px;Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
Â  Â  Â  Â  Â  Â  position: sticky;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  }
Â  Â  Â  Â  h1 { margin: 0; font-weight: 700; font-size: 1.4em; }
Â  Â  Â  Â  h1::before { content: "ğŸ“Š "; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  main { padding: 12px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* === LOGIN SCREEN === */
Â  Â  Â  Â  .login-screen {Â 
Â  Â  Â  Â  Â  Â  background: white;Â 
Â  Â  Â  Â  Â  Â  border-radius: 16px;Â 
Â  Â  Â  Â  Â  Â  padding: 30px 20px;Â 
Â  Â  Â  Â  Â  Â  max-width: 350px;Â 
Â  Â  Â  Â  Â  Â  margin: 30px auto;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 20px rgba(0,0,0,0.08);Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .login-icon { font-size: 3.5em; margin-bottom: 15px; }
Â  Â  Â  Â  .login-title { font-size: 1.3em; font-weight: 700; margin-bottom: 8px; color: #1e293b; }
Â  Â  Â  Â  .login-subtitle { color: #64748b; margin-bottom: 20px; font-size: 0.9em; }
Â  Â  Â  Â  .code-input {Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  padding: 14px;Â 
Â  Â  Â  Â  Â  Â  border: 2px solid #e2e8f0;Â 
Â  Â  Â  Â  Â  Â  border-radius: 12px;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.1em;Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  letter-spacing: 3px;Â 
Â  Â  Â  Â  Â  Â  font-weight: 700;Â 
Â  Â  Â  Â  Â  Â  text-transform: uppercase;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;Â 
Â  Â  Â  Â  Â  Â  transition: border 0.2s;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .code-input:focus { outline: none; border-color: #f59e0b; }
Â  Â  Â  Â  .login-btn {Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  padding: 14px;Â 
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);Â 
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  Â  Â  border-radius: 12px;Â 
Â  Â  Â  Â  Â  Â  font-size: 1em;Â 
Â  Â  Â  Â  Â  Â  font-weight: 700;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  transition: all 0.2s;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .login-btn:active { transform: scale(0.98); }
Â  Â  Â  Â  .error-message {Â 
Â  Â  Â  Â  Â  Â  background: #fef2f2;Â 
Â  Â  Â  Â  Â  Â  color: #dc2626;Â 
Â  Â  Â  Â  Â  Â  padding: 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  margin-top: 12px;Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  Â  Â  border-left: 3px solid #dc2626;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .error-message.visible { display: block; }
Â  Â  Â  Â  .btn-retour {Â 
Â  Â  Â  Â  Â  Â  background: #e2e8f0;Â 
Â  Â  Â  Â  Â  Â  color: #475569;Â 
Â  Â  Â  Â  Â  Â  padding: 10px 16px;Â 
Â  Â  Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  font-weight: 600;Â 
Â  Â  Â  Â  Â  Â  margin-top: 12px;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* === RESULTS SCREEN === */
Â  Â  Â  Â  .results-screen { display: none; }
Â  Â  Â  Â  .results-screen.active { display: block; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* === STUDENT BANNER === */
Â  Â  Â  Â  .student-banner {Â 
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);Â 
Â  Â  Â  Â  Â  Â  color: #78350f;Â 
Â  Â  Â  Â  Â  Â  padding: 12px 16px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 12px;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;Â 
Â  Â  Â  Â  Â  Â  gap: 8px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .student-info { display: flex; align-items: center; gap: 10px; }
Â  Â  Â  Â  .student-name { font-size: 1.1em; font-weight: 700; }
Â  Â  Â  Â  .student-class {Â 
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.3);Â 
Â  Â  Â  Â  Â  Â  padding: 4px 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  Â  Â  font-weight: 600;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.85em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .banner-actions { display: flex; gap: 8px; }
Â  Â  Â  Â  .logout-btn, .btn-home {Â 
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.3);Â 
Â  Â  Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  Â  Â  color: #78350f;Â 
Â  Â  Â  Â  Â  Â  padding: 6px 12px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  font-weight: 600;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.85em;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  Â  Â SECTION MA POSTURE
Â  Â  Â  Â  Â  Â â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
Â  Â  Â  Â  .posture-section {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 10px rgba(251, 191, 36, 0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â  .posture-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
Â  Â  Â  Â  .posture-title { font-size: 1.1em; font-weight: 700; color: #92400e; display: flex; align-items: center; gap: 6px; }
Â  Â  Â  Â  .pronote-badge { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 700; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3); }
Â  Â  Â  Â  .posture-etoiles { display: flex; justify-content: center; gap: 8px; margin: 12px 0; }
Â  Â  Â  Â  .etoile-btn { font-size: 2em; background: none; border: none; cursor: pointer; transition: transform 0.2s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
Â  Â  Â  Â  .etoile-btn:active { transform: scale(1.2); }
Â  Â  Â  Â  .etoile-btn.empty { opacity: 0.3; }
Â  Â  Â  Â  .posture-progress { background: rgba(255,255,255,0.5); border-radius: 10px; height: 8px; margin: 10px 0; overflow: hidden; }
Â  Â  Â  Â  .posture-progress-bar { height: 100%; background: linear-gradient(90deg, #f59e0b, #22c55e); border-radius: 10px; transition: width 0.5s ease; }
Â  Â  Â  Â  .posture-message { text-align: center; font-weight: 600; color: #78350f; font-size: 0.95em; }
Â  Â  Â  Â  .posture-stats { display: flex; justify-content: center; gap: 16px; margin-top: 10px; font-size: 0.8em; color: #92400e; }
Â  Â  Â  Â  .posture-stat { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.4); padding: 4px 10px; border-radius: 12px; }
Â  Â  Â  Â  .posture-section.achieved { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3); }
Â  Â  Â  Â  .posture-section.achieved .posture-title, .posture-section.achieved .posture-message, .posture-section.achieved .posture-stats { color: #166534; }
Â  Â  Â  Â  .posture-section.achieved .pronote-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }

Â  Â  Â  Â  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  Â  Â SECTION MON HUMEUR
Â  Â  Â  Â  Â  Â â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
Â  Â  Â  Â  .humeur-section { background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .humeur-label { font-weight: 600; color: #64748b; font-size: 0.85em; white-space: nowrap; }
Â  Â  Â  Â  .humeur-emojis { display: flex; gap: 6px; }
Â  Â  Â  Â  .humeur-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #e2e8f0; background: white; font-size: 1.3em; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
Â  Â  Â  Â  .humeur-btn:active { transform: scale(1.1); }
Â  Â  Â  Â  .humeur-btn.selected { border-color: #ec4899; background: #fdf2f8; transform: scale(1.1); box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2); }

Â  Â  Â  Â  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  Â  Â ONGLETS
Â  Â  Â  Â  Â  Â â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
Â  Â  Â  Â  .tabs-container { margin-bottom: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
Â  Â  Â  Â  .tabs-container::-webkit-scrollbar { display: none; }
Â  Â  Â  Â  .tabs { display: flex; gap: 6px; padding: 4px; background: white; border-radius: 12px; min-width: max-content; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .tab { padding: 10px 14px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 0.8em; color: #64748b; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
Â  Â  Â  Â  .tab.active { background: #f59e0b; color: white; box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3); }
Â  Â  Â  Â  .tab:not(.active):active { background: #fef3c7; }
Â  Â  Â  Â  .tab-badge { background: #ef4444; color: white; font-size: 0.65em; padding: 2px 5px; border-radius: 8px; font-weight: 700; }
Â  Â  Â  Â  .tab-content { display: none; }
Â  Â  Â  Â  .tab-content.active { display: block; }

Â  Â  Â  Â  /* === STATS GRID === */
Â  Â  Â  Â  .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
Â  Â  Â  Â  .stat-card { background: white; border-radius: 12px; padding: 14px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .stat-value { font-size: 1.5em; font-weight: 800; color: #f59e0b; }
Â  Â  Â  Â  .stat-label { font-size: 0.75em; color: #64748b; margin-top: 2px; }

Â  Â  Â  Â  /* === EVAL CARD === */
Â  Â  Â  Â  .eval-card { background: white; border-radius: 12px; padding: 14px; margin-bottom: 10px; position: relative; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #f59e0b; }
Â  Â  Â  Â  .eval-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
Â  Â  Â  Â  .eval-title { font-weight: 700; font-size: 0.95em; color: #1e293b; margin-bottom: 6px; }
Â  Â  Â  Â  .eval-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
Â  Â  Â  Â  .eval-date { font-size: 0.8em; color: #64748b; }
Â  Â  Â  Â  .status-badge { display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 700; }
Â  Â  Â  Â  .status-corrected { background: #dcfce7; color: #166534; }
Â  Â  Â  Â  .status-pending { background: #fef3c7; color: #92400e; }
Â  Â  Â  Â  .status-nn { background: #fed7aa; color: #c2410c; }
Â  Â  Â  Â  .status-absent { background: #fee2e2; color: #991b1b; }
Â  Â  Â  Â  .eval-note { font-weight: 800; font-size: 1.2em; padding: 6px 12px; border-radius: 8px; white-space: nowrap; }
Â  Â  Â  Â  .note-excellent { background: #dcfce7; color: #166534; }
Â  Â  Â  Â  .note-good { background: #dbeafe; color: #1e40af; }
Â  Â  Â  Â  .note-average { background: #fef3c7; color: #92400e; }
Â  Â  Â  Â  .note-poor { background: #fee2e2; color: #991b1b; }
Â  Â  Â  Â  .note-pending { background: #e2e8f0; color: #64748b; }
Â  Â  Â  Â  .note-nn { background: #fef3c7; color: #b45309; }
Â  Â  Â  Â  .note-absent { background: #fee2e2; color: #dc2626; }
Â  Â  Â  Â  .btn-view { width: 100%; margin-top: 10px; background: #3b82f6; color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; }
Â  Â  Â  Â  .btn-view:disabled { background: #cbd5e1; cursor: not-allowed; }

Â  Â  Â  Â  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  Â  Â ONGLET EN CLASSE
Â  Â  Â  Â  Â  Â â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
Â  Â  Â  Â  .suivi-header { background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; text-align: center; }
Â  Â  Â  Â  .suivi-stats-row { display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; }
Â  Â  Â  Â  .suivi-moyenne { font-size: 2em; font-weight: 800; }
Â  Â  Â  Â  .suivi-presence { font-size: 1.4em; font-weight: 700; }
Â  Â  Â  Â  .suivi-label { font-size: 0.85em; opacity: 0.9; margin-top: 8px; }
Â  Â  Â  Â  .suivi-badges { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
Â  Â  Â  Â  .suivi-badge { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 600; }
Â  Â  Â  Â  .tendances-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
Â  Â  Â  Â  .tendance-card { background: white; border-radius: 10px; padding: 10px 6px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .tendance-icon { font-size: 1.2em; }
Â  Â  Â  Â  .tendance-label { font-size: 0.65em; color: #64748b; margin: 2px 0; }
Â  Â  Â  Â  .tendance-value { font-size: 0.9em; font-weight: 700; }
Â  Â  Â  Â  .seance-card { background: white; border-radius: 10px; margin-bottom: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-left: 4px solid #8b5cf6; }
Â  Â  Â  Â  .seance-card.seance-absent { border-left-color: #f59e0b; background: #fffbeb; }
Â  Â  Â  Â  .seance-header { display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; }
Â  Â  Â  Â  .seance-info { display: flex; flex-direction: column; gap: 2px; }
Â  Â  Â  Â  .seance-date { font-weight: 700; color: #1e293b; font-size: 0.9em; }
Â  Â  Â  Â  .seance-module { font-size: 0.8em; color: #64748b; }
Â  Â  Â  Â  .seance-note { display: flex; align-items: center; gap: 6px; }
Â  Â  Â  Â  .seance-note-value { font-size: 1.1em; font-weight: 800; }
Â  Â  Â  Â  .seance-note-icon { font-size: 1.2em; }
Â  Â  Â  Â  .seance-note-value.absent { color: #92400e; }
Â  Â  Â  Â  .note-excellent-suivi { color: #16a34a; }
Â  Â  Â  Â  .note-good-suivi { color: #8b5cf6; }
Â  Â  Â  Â  .note-average-suivi { color: #f59e0b; }
Â  Â  Â  Â  .note-poor-suivi { color: #dc2626; }
Â  Â  Â  Â  .seance-detail { display: none; padding: 12px; background: #f8fafc; border-top: 1px solid #e2e8f0; }
Â  Â  Â  Â  .seance-detail.open { display: block; }
Â  Â  Â  Â  .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.85em; }
Â  Â  Â  Â  .detail-row:last-child { border-bottom: none; }
Â  Â  Â  Â  .detail-label { color: #64748b; }
Â  Â  Â  Â  .detail-value { font-weight: 600; }
Â  Â  Â  Â  .detail-value.good { color: #16a34a; }
Â  Â  Â  Â  .detail-value.medium { color: #f59e0b; }
Â  Â  Â  Â  .detail-value.bad { color: #dc2626; }
Â  Â  Â  Â  .seance-comment { margin-top: 8px; padding: 10px; background: #eff6ff; border-radius: 6px; font-style: italic; color: #1e40af; font-size: 0.85em; border-left: 3px solid #3b82f6; }

Â  Â  Â  Â  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  Â  Â ONGLET BILAN
Â  Â  Â  Â  Â  Â â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
Â  Â  Â  Â  .bilan-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .bilan-semaine-info { background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 12px; border-radius: 10px; margin-bottom: 16px; text-align: center; border: 2px solid #10b981; }
Â  Â  Â  Â  .bilan-semaine-titre { font-weight: 700; color: #065f46; font-size: 1em; }
Â  Â  Â  Â  .bilan-semaine-dates { color: #047857; font-size: 0.85em; margin-top: 4px; }
Â  Â  Â  Â  .bilan-form-group { background: #f8fafc; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
Â  Â  Â  Â  .bilan-form-group label { display: block; font-weight: 600; color: #1e293b; margin-bottom: 10px; font-size: 0.9em; }
Â  Â  Â  Â  .bilan-form-group label span { font-size: 1.1em; margin-right: 6px; }
Â  Â  Â  Â  .bilan-slider-container { display: flex; align-items: center; gap: 12px; }
Â  Â  Â  Â  .bilan-slider { flex: 1; height: 8px; border-radius: 4px; -webkit-appearance: none; background: linear-gradient(to right, #fee2e2, #fef3c7, #dcfce7); }
Â  Â  Â  Â  .bilan-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: white; border: 3px solid #10b981; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
Â  Â  Â  Â  .bilan-slider-value { font-size: 1.3em; min-width: 35px; text-align: center; }
Â  Â  Â  Â  .bilan-radio-group { display: flex; gap: 6px; flex-wrap: wrap; }
Â  Â  Â  Â  .bilan-radio-btn { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8em; transition: all 0.2s; background: white; }
Â  Â  Â  Â  .bilan-radio-btn.selected { background: #10b981; color: white; border-color: #10b981; }
Â  Â  Â  Â  .bilan-textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9em; resize: vertical; min-height: 60px; font-family: inherit; }
Â  Â  Â  Â  .bilan-textarea:focus { outline: none; border-color: #10b981; }
Â  Â  Â  Â  .bilan-submit-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 1em; font-weight: 700; cursor: pointer; margin-top: 8px; }
Â  Â  Â  Â  .bilan-submit-btn:active { transform: scale(0.98); }
Â  Â  Â  Â  .bilan-message { display: none; text-align: center; padding: 12px; background: #dcfce7; border-radius: 8px; color: #166534; font-weight: 600; margin-top: 12px; }
Â  Â  Â  Â  .bilan-message.visible { display: block; }
Â  Â  Â  Â  .bilan-historique { margin-top: 16px; padding-top: 16px; border-top: 2px dashed #e2e8f0; }
Â  Â  Â  Â  .bilan-historique-titre { font-weight: 700; color: #065f46; margin-bottom: 12px; font-size: 0.95em; }
Â  Â  Â  Â  .bilan-historique-item { background: #f0fdf4; border-radius: 8px; padding: 10px; margin-bottom: 8px; border-left: 3px solid #10b981; }
Â  Â  Â  Â  .bilan-historique-semaine { font-weight: 600; color: #065f46; font-size: 0.85em; }
Â  Â  Â  Â  .bilan-historique-resume { display: flex; gap: 12px; margin-top: 6px; flex-wrap: wrap; font-size: 0.8em; color: #047857; }

Â  Â  Â  Â  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  Â  Â ONGLET COURS
Â  Â  Â  Â  Â  Â â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
Â  Â  Â  Â  .cours-module-card { background: white; border-radius: 10px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .cours-module-header { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 12px 14px; font-weight: 700; }
Â  Â  Â  Â  .cours-module-header .module-code { font-size: 1em; }
Â  Â  Â  Â  .cours-module-header .module-titre { font-size: 0.8em; opacity: 0.9; margin-top: 2px; }
Â  Â  Â  Â  .cours-seances-list { padding: 8px 0; }
Â  Â  Â  Â  .cours-seance-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-bottom: 1px solid #f1f5f9; }
Â  Â  Â  Â  .cours-seance-row:last-child { border-bottom: none; }
Â  Â  Â  Â  .cours-seance-info { display: flex; align-items: center; gap: 8px; }
Â  Â  Â  Â  .cours-seance-icon { font-size: 1em; }
Â  Â  Â  Â  .cours-seance-nom { font-weight: 600; font-size: 0.9em; }
Â  Â  Â  Â  .cours-seance-date { font-size: 0.8em; color: #64748b; }
Â  Â  Â  Â  .cours-seance-status { font-weight: 600; padding: 4px 8px; border-radius: 6px; font-size: 0.75em; }
Â  Â  Â  Â  .cours-seance-status.recu { background: #dcfce7; color: #166534; }
Â  Â  Â  Â  .cours-seance-status.manquant { background: #fee2e2; color: #991b1b; }
Â  Â  Â  Â  .cours-alerte { background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
Â  Â  Â  Â  .cours-alerte-icon { font-size: 1.2em; }
Â  Â  Â  Â  .cours-alerte-text { font-weight: 600; color: #92400e; font-size: 0.9em; }

Â  Â  Â  Â  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  Â  Â ONGLET BIEN-ÃŠTRE
Â  Â  Â  Â  Â  Â â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
Â  Â  Â  Â  .bienetre-content { background: white; border-radius: 16px; padding: 24px 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .bienetre-icon { font-size: 3em; margin-bottom: 12px; }
Â  Â  Â  Â  .bienetre-titre { font-size: 1.2em; font-weight: 700; color: #1e293b; margin-bottom: 10px; }
Â  Â  Â  Â  .bienetre-description { color: #64748b; line-height: 1.5; font-size: 0.9em; margin-bottom: 16px; }
Â  Â  Â  Â  .bienetre-teaser { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
Â  Â  Â  Â  .bienetre-teaser-card { background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 10px; padding: 14px 10px; border: 2px dashed #cbd5e1; }
Â  Â  Â  Â  .bienetre-teaser-icon { font-size: 1.5em; margin-bottom: 6px; }
Â  Â  Â  Â  .bienetre-teaser-text { font-weight: 600; color: #64748b; font-size: 0.8em; }

Â  Â  Â  Â  /* === CHARTS === */
Â  Â  Â  Â  .charts-row { display: grid; gap: 12px; margin-bottom: 12px; }
Â  Â  Â  Â  .chart-card { background: white; border-radius: 12px; padding: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .chart-title { font-weight: 700; margin-bottom: 10px; color: #1e293b; font-size: 0.95em; }
Â  Â  Â  Â  .chart-container { position: relative; height: 250px; }

Â  Â  Â  Â  /* === MODAL === */
Â  Â  Â  Â  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: flex-end; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
Â  Â  Â  Â  .modal-overlay.active { display: flex; }
Â  Â  Â  Â  .modal-content { background: white; border-radius: 20px 20px 0 0; width: 100%; max-height: 90vh; overflow-y: auto; }
Â  Â  Â  Â  .modal-header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
Â  Â  Â  Â  .modal-title { font-size: 1.1em; font-weight: 700; }
Â  Â  Â  Â  .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2em; font-weight: bold; }
Â  Â  Â  Â  .modal-body { padding: 16px; }

Â  Â  Â  Â  /* === EMPTY STATE === */
Â  Â  Â  Â  .empty-state { text-align: center; padding: 40px 16px; color: #94a3b8; }
Â  Â  Â  Â  .empty-icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
Â  Â  Â  Â  .empty-text { font-size: 0.95em; font-weight: 600; }

Â  Â  Â  Â  /* === LOADING === */
Â  Â  Â  Â  .loading { text-align: center; padding: 30px; }
Â  Â  Â  Â  .spinner { border: 3px solid #f3f4f6; border-top: 3px solid #f59e0b; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
Â  Â  Â  Â  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

Â  Â  Â  Â  /* === APPRECIATION BLOCK === */
Â  Â  Â  Â  .appreciation-block { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 4px solid #f59e0b; padding: 14px; border-radius: 8px; margin-bottom: 16px; }
Â  Â  Â  Â  .appreciation-title { font-weight: 700; color: #78350f; margin-bottom: 8px; font-size: 0.95em; }
Â  Â  Â  Â  .appreciation-title::before { content: "ğŸ’¬ "; }
Â  Â  Â  Â  .appreciation-text { color: #78350f; line-height: 1.5; font-size: 0.9em; }

Â  Â  Â  Â  /* === QUESTION CARDS (base) === */
Â  Â  Â  Â  .question-card-grid { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 14px; margin-bottom: 12px; }
Â  Â  Â  Â  .question-header-grid { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; gap: 6px; }
Â  Â  Â  Â  .question-number-grid { font-weight: 700; font-size: 1em; color: #f59e0b; }
Â  Â  Â  Â  .question-comp-grid { background: #f0f9ff; padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 0.75em; color: #3b82f6; }
Â  Â  Â  Â  .question-level-grid { padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 0.8em; }
Â  Â  Â  Â  .question-text-grid { color: #1e293b; margin-bottom: 12px; line-height: 1.5; font-size: 0.9em; }
Â  Â  Â  Â  .answer-section-grid { background: #f0f9ff; border-left: 3px solid #3b82f6; padding: 10px; border-radius: 0 6px 6px 0; margin-bottom: 8px; }
Â  Â  Â  Â  .correction-section-grid { background: #dcfce7; border-left: 3px solid #22c55e; padding: 10px; border-radius: 0 6px 6px 0; margin-bottom: 8px; }
Â  Â  Â  Â  .comment-section-grid { background: #fffbeb; border-left: 3px solid #fbbf24; padding: 10px; border-radius: 0 6px 6px 0; }
Â  Â  Â  Â  .section-label-grid { font-weight: 600; margin-bottom: 6px; font-size: 0.85em; }
Â  Â  Â  Â  .section-content-grid { line-height: 1.5; font-size: 0.85em; }
Â  Â  Â  Â  .answer-section-grid .section-label-grid { color: #1e40af; }
Â  Â  Â  Â  .correction-section-grid .section-label-grid { color: #166534; }
Â  Â  Â  Â  .comment-section-grid .section-label-grid { color: #78350f; }
Â  Â  Â  Â  .badge-M { background: #dcfce7; color: #166534; }
Â  Â  Â  Â  .badge-A { background: #dbeafe; color: #1e40af; }
Â  Â  Â  Â  .badge-I { background: #fef3c7; color: #92400e; }
Â  Â  Â  Â  .badge-NT { background: #e2e8f0; color: #475569; }

Â  Â  Â  Â  /* === PRINT === */
Â  Â  Â  Â  .no-print { }
Â  Â  Â  Â  @media print { body { max-width: 100%; } .no-print { display: none !important; } header { position: static; } }

Â  Â  Â  Â  /* === OBJECTIF SECTION === */
Â  Â  Â  Â  .objectif-section { background: white; border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 2px solid #fbbf24; }
Â  Â  Â  Â  .objectif-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
Â  Â  Â  Â  .objectif-header h3 { font-size: 1em; color: #92400e; margin: 0; }
Â  Â  Â  Â  .objectif-intro { color: #64748b; font-size: 0.85em; margin-bottom: 12px; line-height: 1.4; }
Â  Â  Â  Â  .objectif-actuel { background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
Â  Â  Â  Â  .objectif-actuel-label { font-weight: 700; color: #92400e; font-size: 0.8em; margin-bottom: 6px; }
Â  Â  Â  Â  .objectif-actuel-texte { font-weight: 600; color: #78350f; font-size: 0.95em; margin-bottom: 8px; }
Â  Â  Â  Â  .objectif-statut { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 15px; font-size: 0.75em; font-weight: 600; }
Â  Â  Â  Â  .objectif-statut.en_cours { background: #dbeafe; color: #1e40af; }
Â  Â  Â  Â  .objectif-statut.atteint { background: #dcfce7; color: #166534; }
Â  Â  Â  Â  .objectif-statut.non_atteint { background: #fee2e2; color: #991b1b; }
Â  Â  Â  Â  .objectif-nouveau { background: #f8fafc; border-radius: 10px; padding: 12px; }
Â  Â  Â  Â  .objectif-nouveau-label { font-weight: 600; color: #475569; font-size: 0.85em; margin-bottom: 8px; }
Â  Â  Â  Â  .objectif-select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9em; margin-bottom: 8px; background: white; }
Â  Â  Â  Â  .objectif-params { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px; }
Â  Â  Â  Â  .objectif-params input[type="number"] { width: 70px; padding: 6px; border: 2px solid #e2e8f0; border-radius: 6px; text-align: center; font-weight: 600; }
Â  Â  Â  Â  .objectif-params input[type="text"] { flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; }
Â  Â  Â  Â  .objectif-save-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 700; cursor: pointer; }
Â  Â  Â  Â  .objectif-save-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
Â  Â  Â  Â  .objectif-message { display: none; background: #dcfce7; color: #166534; padding: 10px; border-radius: 6px; margin-top: 8px; text-align: center; font-weight: 600; font-size: 0.9em; }
Â  Â  Â  Â  .objectif-message.visible { display: block; }

Â  Â  Â  Â  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  Â  Â MODAL V2 â€” REFONTE DÃ‰TAIL COPIE Ã‰LÃˆVE
Â  Â  Â  Â  Â  Â â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
Â  Â  Â  Â  .modal-note-banner { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-radius: 12px; margin-bottom: 16px; gap: 12px; }
Â  Â  Â  Â  .modal-note-banner.excellent { background: linear-gradient(135deg, #dcfce7, #bbf7d0); }
Â  Â  Â  Â  .modal-note-banner.good { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
Â  Â  Â  Â  .modal-note-banner.average { background: linear-gradient(135deg, #fef3c7, #fde68a); }
Â  Â  Â  Â  .modal-note-banner.poor { background: linear-gradient(135deg, #fee2e2, #fecaca); }
Â  Â  Â  Â  .modal-note-banner.nn { background: linear-gradient(135deg, #f1f5f9, #e2e8f0); }
Â  Â  Â  Â  .modal-note-big { font-size: 2em; font-weight: 800; line-height: 1; }
Â  Â  Â  Â  .modal-note-banner.excellent .modal-note-big { color: #166534; }
Â  Â  Â  Â  .modal-note-banner.good .modal-note-big { color: #1e40af; }
Â  Â  Â  Â  .modal-note-banner.average .modal-note-big { color: #92400e; }
Â  Â  Â  Â  .modal-note-banner.poor .modal-note-big { color: #991b1b; }
Â  Â  Â  Â  .modal-note-banner.nn .modal-note-big { color: #475569; }
Â  Â  Â  Â  .modal-note-bar { flex: 1; height: 10px; background: rgba(255,255,255,0.5); border-radius: 5px; overflow: hidden; }
Â  Â  Â  Â  .modal-note-bar-fill { height: 100%; border-radius: 5px; transition: width 0.6s ease; }
Â  Â  Â  Â  .modal-note-banner.excellent .modal-note-bar-fill { background: #16a34a; }
Â  Â  Â  Â  .modal-note-banner.good .modal-note-bar-fill { background: #3b82f6; }
Â  Â  Â  Â  .modal-note-banner.average .modal-note-bar-fill { background: #f59e0b; }
Â  Â  Â  Â  .modal-note-banner.poor .modal-note-bar-fill { background: #ef4444; }

Â  Â  Â  Â  .comp-summary { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 14px; margin-bottom: 16px; }
Â  Â  Â  Â  .comp-summary-title { font-weight: 700; font-size: 0.95em; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
Â  Â  Â  Â  .comp-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
Â  Â  Â  Â  .comp-row:last-child { border-bottom: none; }
Â  Â  Â  Â  .comp-name { font-weight: 600; font-size: 0.85em; color: #475569; min-width: 30px; }
Â  Â  Â  Â  .comp-bar-wrap { flex: 1; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
Â  Â  Â  Â  .comp-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
Â  Â  Â  Â  .comp-bar-fill.level-M { background: linear-gradient(90deg, #22c55e, #16a34a); }
Â  Â  Â  Â  .comp-bar-fill.level-A { background: linear-gradient(90deg, #60a5fa, #3b82f6); }
Â  Â  Â  Â  .comp-bar-fill.level-I { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
Â  Â  Â  Â  .comp-bar-fill.level-NT { background: #cbd5e1; }
Â  Â  Â  Â  .comp-points { font-size: 0.8em; font-weight: 700; color: #64748b; min-width: 50px; text-align: right; }
Â  Â  Â  Â  .comp-level-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 28px; padding: 3px 8px; border-radius: 6px; font-size: 0.75em; font-weight: 800; }

Â  Â  Â  Â  .modal-section-header { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 8px; margin-bottom: 10px; font-weight: 700; font-size: 0.9em; }
Â  Â  Â  Â  .modal-section-header.section-errors { background: linear-gradient(135deg, #fef2f2, #fee2e2); color: #991b1b; border-left: 4px solid #ef4444; }
Â  Â  Â  Â  .modal-section-header.section-success { background: linear-gradient(135deg, #f0fdf4, #dcfce7); color: #166534; border-left: 4px solid #22c55e; }
Â  Â  Â  Â  .section-count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }

Â  Â  Â  Â  .question-card-grid.card-error { border: 2px solid #fca5a5; border-left: 5px solid #ef4444; background: #fffbfb; }
Â  Â  Â  Â  .question-card-grid.card-success { border: 1px solid #e2e8f0; border-left: 4px solid #22c55e; opacity: 0.9; }

Â  Â  Â  Â  .question-compact { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: white; border: 1px solid #e2e8f0; border-left: 4px solid #22c55e; border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; gap: 8px; }
Â  Â  Â  Â  .question-compact:active { background: #f8fafc; }
Â  Â  Â  Â  .question-compact .qc-left { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
Â  Â  Â  Â  .question-compact .qc-num { font-weight: 700; color: #64748b; font-size: 0.85em; white-space: nowrap; }
Â  Â  Â  Â  .question-compact .qc-text { font-size: 0.82em; color: #475569; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  Â  Â  Â  .question-compact .qc-badge { flex-shrink: 0; }
Â  Â  Â  Â  .question-compact-detail { display: none; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; margin-top: -6px; margin-bottom: 6px; }
Â  Â  Â  Â  .question-compact-detail.open { display: block; }

Â  Â  Â  Â  .matching-display { display: flex; flex-direction: column; gap: 4px; }
Â  Â  Â  Â  .matching-row { display: flex; align-items: center; gap: 8px; font-size: 0.85em; padding: 4px 8px; background: rgba(255,255,255,0.5); border-radius: 4px; }
Â  Â  Â  Â  .matching-arrow { color: #3b82f6; font-weight: 700; }

Â  Â  Â  Â  .no-blueprint-info { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; text-align: center; color: #92400e; font-size: 0.85em; margin-bottom: 12px; }
Â  Â  </style>
</head>
<body>
Â  Â  <header class="no-print">
Â  Â  Â  Â  <h1>Mes RÃ©sultats PSE</h1>
Â  Â  </header>

Â  Â  Â  Â  <div class="login-screen" id="loginScreen">
Â  Â  Â  Â  <div class="login-icon">ğŸ”</div>
Â  Â  Â  Â  <div class="login-title">AccÃ¨s Ã‰lÃ¨ve</div>
Â  Â  Â  Â  <div class="login-subtitle">Entre ton code personnel</div>
Â  Â  Â  Â  <input type="text" id="codeInput" class="code-input" placeholder="CODE" maxlength="12" autofocus>
Â  Â  Â  Â  <button class="login-btn" onclick="connexion()">Se connecter</button>
Â  Â  Â  Â  <div class="error-message" id="errorMsg">Code incorrect.</div>
Â  Â  Â  Â  <button class="btn-retour" onclick="window.location.href='https://preventionsanteenvironnement.github.io/PSE/'">â¬…ï¸ Retour</button>
Â  Â  </div>

Â  Â  Â  Â  <div class="results-screen" id="resultsScreen">
Â  Â  Â  Â  <main>
Â  Â  Â  Â  Â  Â  <div class="student-banner no-print">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="student-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="student-name" id="studentName">Ã‰lÃ¨ve</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="student-class" id="studentClass">Classe</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="banner-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-home" onclick="window.location.href='https://preventionsanteenvironnement.github.io/PSE/'">ğŸ </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="logout-btn" onclick="deconnexion()">ğŸšª</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-section" id="postureSection">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-title">ğŸŒŸ Ma posture</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pronote-badge" id="pronoteBadge">ğŸ¯ Encouragement Pronote</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-etoiles" id="postureEtoiles">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="etoile-btn empty" data-star="1">â˜†</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="etoile-btn empty" data-star="2">â˜†</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="etoile-btn empty" data-star="3">â˜†</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="etoile-btn empty" data-star="4">â˜†</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="etoile-btn empty" data-star="5">â˜†</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-progress"><div class="posture-progress-bar" id="postureProgressBar" style="width: 0%;"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-message" id="postureMessage">Continue comme Ã§a ! ğŸ†</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-stats">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-stat">ğŸ”¥ SÃ©rie : <strong id="serieActuelle">0</strong></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="posture-stat">ğŸ… Record : <strong id="serieRecord">0</strong></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="humeur-section" id="humeurSection">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="humeur-label">ğŸ˜Š Aujourd'hui :</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="humeur-emojis">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="humeur-btn" onclick="selectHumeur('super', 'ğŸ¤©')" data-humeur="super">ğŸ¤©</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="humeur-btn" onclick="selectHumeur('bien', 'ğŸ˜Š')" data-humeur="bien">ğŸ˜Š</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="humeur-btn" onclick="selectHumeur('normal', 'ğŸ˜')" data-humeur="normal">ğŸ˜</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="humeur-btn" onclick="selectHumeur('bof', 'ğŸ˜”')" data-humeur="bof">ğŸ˜”</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="humeur-btn" onclick="selectHumeur('difficile', 'ğŸ˜¢')" data-humeur="difficile">ğŸ˜¢</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="tabs-container no-print">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tabs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab active" onclick="switchTab('evaluations', this)">ğŸ“Š Ã‰valuations</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="switchTab('suivi', this)">ğŸ¯ En classe</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="switchTab('bilan', this)">ğŸ“‹ Bilan</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="switchTab('cours', this)">ğŸ“š Cours</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="switchTab('bienetre', this)">ğŸŒ± Bien-Ãªtre <span class="tab-badge">BIENTÃ”T</span></button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="tab-content active" id="tabEvaluations">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card"><div class="stat-value" id="statMoyenne">--</div><div class="stat-label">Moyenne</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card"><div class="stat-value" id="statCorriges">0</div><div class="stat-label">CorrigÃ©es</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="evalList"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="tab-content" id="tabSuivi">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="suiviContent"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Chargement...</div></div></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="tab-content" id="tabBilan">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-semaine-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-semaine-titre">ğŸ“… Ma semaine</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-semaine-dates" id="bilanSemaineDates">Semaine du ... au ...</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: #64748b; font-size: 0.85em; margin-bottom: 16px; text-align: center;">Fais le point sur ta semaine ! C'est <strong>ton espace</strong> pour t'auto-Ã©valuer. ğŸ¯</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-form-group"><label><span>ğŸ¯</span> Ma concentration</label><div class="bilan-slider-container"><input type="range" class="bilan-slider" id="bilanConcentration" min="1" max="5" value="3" oninput="updateSliderEmoji('bilanConcentration', 'bilanConcentrationEmoji')"><span class="bilan-slider-value" id="bilanConcentrationEmoji">ğŸ˜</span></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-form-group"><label><span>ğŸ’ª</span> Mon engagement</label><div class="bilan-slider-container"><input type="range" class="bilan-slider" id="bilanEngagement" min="1" max="5" value="3" oninput="updateSliderEmoji('bilanEngagement', 'bilanEngagementEmoji')"><span class="bilan-slider-value" id="bilanEngagementEmoji">ğŸ˜</span></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-form-group"><label><span>â¤ï¸</span> J'ai reconnu mes Ã©motions</label><div class="bilan-slider-container"><input type="range" class="bilan-slider" id="bilanEmotions" min="1" max="5" value="3" oninput="updateSliderEmoji('bilanEmotions', 'bilanEmotionsEmoji')"><span class="bilan-slider-value" id="bilanEmotionsEmoji">ğŸ˜</span></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-form-group"><label><span>ğŸ”¥</span> J'ai gÃ©rÃ© une difficultÃ©</label><div class="bilan-radio-group" id="bilanGestionGroup"><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGestion', 'oui', this)">âœ… Oui</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGestion', 'un_peu', this)">ğŸ¤ Un peu</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGestion', 'non', this)">âŒ Non</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGestion', 'pas_eu', this)">ğŸ¤· Pas eu</button></div><input type="hidden" id="bilanGestion" value=""></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-form-group"><label><span>ğŸ¤</span> Mes relations</label><div class="bilan-slider-container"><input type="range" class="bilan-slider" id="bilanRelations" min="1" max="5" value="3" oninput="updateSliderEmoji('bilanRelations', 'bilanRelationsEmoji')"><span class="bilan-slider-value" id="bilanRelationsEmoji">ğŸ˜</span></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-form-group"><label><span>âš¡</span> Conflit rencontrÃ© / rÃ©solu</label><div class="bilan-radio-group" id="bilanConflitGroup"><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanConflit', 'resolu', this)">âœ… RÃ©solu</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanConflit', 'en_cours', this)">â³ En cours</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanConflit', 'non_resolu', this)">âŒ Non</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanConflit', 'pas_eu', this)">ğŸ¤· Pas eu</button></div><input type="hidden" id="bilanConflit" value=""></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-form-group"><label><span>â­</span> Ma fiertÃ© (optionnel)</label><textarea class="bilan-textarea" id="bilanFierte" placeholder="De quoi es-tu fier(e) ?"></textarea></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-form-group"><label><span>ğŸ“Š</span> Ma semaine en un mot</label><div class="bilan-radio-group" id="bilanGlobalGroup"><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGlobal', 'super', this)">ğŸ¤© Super</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGlobal', 'bien', this)">ğŸ˜Š Bien</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGlobal', 'moyen', this)">ğŸ˜ Moyen</button><button class="bilan-radio-btn" onclick="selectBilanRadio('bilanGlobal', 'difficile', this)">ğŸ˜” Difficile</button></div><input type="hidden" id="bilanGlobal" value=""></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="bilan-submit-btn" onclick="sauvegarderBilan()">âœ… Enregistrer mon bilan</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-message" id="bilanMessage">âœ… Bilan enregistrÃ© ! Bravo ğŸ’ª</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-historique" id="bilanHistorique" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bilan-historique-titre">ğŸ“œ Mes bilans prÃ©cÃ©dents</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="bilanHistoriqueList"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="tab-content" id="tabCours">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="coursContent"><div class="empty-state"><div class="empty-icon">ğŸ“„</div><div class="empty-text">Chargement...</div></div></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="tab-content" id="tabBienetre">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-icon">ğŸŒ±</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-titre">Bien-Ãªtre & SantÃ©</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-description">BientÃ´t disponible ! Tu trouveras ici des ressources pour mieux te connaÃ®tre et dÃ©velopper tes compÃ©tences psychosociales.<br><br><strong>BasÃ© sur SantÃ© Publique France ğŸ‡«ğŸ‡·</strong></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-teaser">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-teaser-card"><div class="bienetre-teaser-icon">â¤ï¸</div><div class="bienetre-teaser-text">Mes Ã©motions</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-teaser-card"><div class="bienetre-teaser-icon">ğŸ’ª</div><div class="bienetre-teaser-text">GÃ©rer le stress</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-teaser-card"><div class="bienetre-teaser-icon">ğŸ¤</div><div class="bienetre-teaser-text">Communiquer</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bienetre-teaser-card"><div class="bienetre-teaser-icon">ğŸ¯</div><div class="bienetre-teaser-text">Me concentrer</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </main>
Â  Â  </div>

Â  Â  Â  Â  <div class="modal-overlay" id="modalDetail">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-title" id="modalTitle">DÃ©tail</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-close" onclick="fermerModal()">Ã—</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-body" id="modalBody"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
Â  Â  Â  Â  import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, collectionGroup, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
Â  Â  Â  Â  Â  Â  authDomain: "devoirs-pse.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "devoirs-pse",
Â  Â  Â  Â  Â  Â  storageBucket: "devoirs-pse.appspot.com",
Â  Â  Â  Â  Â  Â  messagingSenderId: "614730413904",
Â  Â  Â  Â  Â  Â  appId: "1:614730413904:web:a5dd478af5de30f6bede55"
Â  Â  Â  Â  };

Â  Â  Â  Â  // âœ… Init SAFE
Â  Â  Â  Â  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
Â  Â  Â  Â  const db = getFirestore(app);

Â  Â  Â  Â  let currentUserCode = null;
Â  Â  Â  Â  let currentEleveInfo = null;
Â  Â  Â  Â  let allEvaluations = [];
Â  Â  Â  Â  let allSuivis = [];

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // CONNEXION
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  window.connexion = async function() {
Â  Â  Â  Â  Â  Â  const code = document.getElementById('codeInput').value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  if (!code) return;
Â  Â  Â  Â  Â  Â  document.getElementById('errorMsg').classList.remove('visible');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let eleveInfo = null;
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof window.BDD_ELEVES !== 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eleveInfo = window.BDD_ELEVES.find(e => e.userCode === code);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!eleveInfo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('errorMsg').textContent = "Code inconnu.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('errorMsg').classList.add('visible');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  currentUserCode = code;
Â  Â  Â  Â  Â  Â  Â  Â  currentEleveInfo = eleveInfo;
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('pse_user_code', code);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginScreen').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('resultsScreen').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('studentName').textContent = code;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('studentClass').textContent = eleveInfo.classe || "";
Â  Â  Â  Â  Â  Â  Â  Â  await chargerDonnees();
Â  Â  Â  Â  Â  Â  Â  Â  await enregistrerConsultation(code, eleveInfo.classe);
Â  Â  Â  Â  Â  Â  Â  Â  chargerHumeurDuJour();
Â  Â  Â  Â  Â  Â  Â  Â  initBilanSemaine();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erreur connexion:", e);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Erreur: " + e.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  window.deconnexion = function() {
Â  Â  Â  Â  Â  Â  localStorage.removeItem('pse_user_code');
Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  };

Â  Â  Â  Â  async function enregistrerConsultation(code, classe) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  const consultationRef = doc(db, "consultations", code);
Â  Â  Â  Â  Â  Â  Â  Â  const docSnap = await getDoc(consultationRef);
Â  Â  Â  Â  Â  Â  Â  Â  const count = docSnap.exists() ? (docSnap.data().nombreVisites || 0) : 0;
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(consultationRef, { eleveCode: code, classe: classe, derniereConsultation: now.toISOString(), timestamp: serverTimestamp(), nombreVisites: count + 1 }, { merge: true });
Â  Â  Â  Â  Â  Â  } catch (error) { console.error("Erreur consultation:", error); }
Â  Â  Â  Â  }

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // CHARGEMENT DONNÃ‰ES
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  async function chargerDonnees() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const qCopies = query(collectionGroup(db, "copies"), where("eleveCode", "==", currentUserCode));
Â  Â  Â  Â  Â  Â  Â  Â  const snapCopies = await getDocs(qCopies);
Â  Â  Â  Â  Â  Â  Â  Â  const qEvals = query(collectionGroup(db, "evaluations"), where("eleveCode", "==", currentUserCode));
Â  Â  Â  Â  Â  Â  Â  Â  const snapEvals = await getDocs(qEvals);
Â  Â  Â  Â  Â  Â  Â  Â  const evalsMap = new Map();
Â  Â  Â  Â  Â  Â  Â  Â  snapEvals.forEach(doc => { const evalData = doc.data(); evalsMap.set(evalData.devoirId, evalData); });

Â  Â  Â  Â  Â  Â  Â  Â  allEvaluations = [];
Â  Â  Â  Â  Â  Â  Â  Â  snapCopies.forEach(docSnap => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const copie = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const evaluation = evalsMap.get(copie.devoirId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allEvaluations.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: docSnap.id, copie: copie, evaluation: evaluation, estCorrige: !!evaluation,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  devoirId: copie.devoirId, titre: copie.titre || "Devoir",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: copie.createdAtISO || copie.createdAt?.toDate?.() || new Date(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  note: evaluation?.note_finale ?? null, nonNote: evaluation?.nonNote || false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appreciation: evaluation?.appreciation || "", competences: evaluation?.competences || {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  questions: evaluation?.questions || {}, reponses: copie.reponses || {}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  allEvaluations.sort((a, b) => new Date(b.date) - new Date(a.date));
Â  Â  Â  Â  Â  Â  Â  Â  afficherStatistiques();
Â  Â  Â  Â  Â  Â  Â  Â  afficherListeEvaluations();
Â  Â  Â  Â  Â  Â  Â  Â  await chargerSuivi();
Â  Â  Â  Â  Â  Â  } catch (e) { console.error("Erreur chargement:", e); }
Â  Â  Â  Â  }

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // AFFICHAGE Ã‰VALUATIONS
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  function afficherStatistiques() {
Â  Â  Â  Â  Â  Â  const corriges = allEvaluations.filter(e => e.estCorrige);
Â  Â  Â  Â  Â  Â  const notes = corriges.filter(e => e.note !== null && e.note !== "NN" && e.note !== "ABS" && !e.nonNote && !isNaN(e.note)).map(e => parseFloat(e.note));
Â  Â  Â  Â  Â  Â  const moyenne = notes.length > 0 ? (notes.reduce((a, b) => a + b, 0) / notes.length).toFixed(1) : "--";
Â  Â  Â  Â  Â  Â  document.getElementById('statMoyenne').textContent = moyenne + (moyenne !== "--" ? "/20" : "");
Â  Â  Â  Â  Â  Â  document.getElementById('statCorriges').textContent = corriges.length;
Â  Â  Â  Â  }

Â  Â  Â  Â  function afficherListeEvaluations() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('evalList');
Â  Â  Â  Â  Â  Â  if (allEvaluations.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Aucune Ã©valuation</div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  container.innerHTML = allEvaluations.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const dateStr = item.date instanceof Date ? item.date.toLocaleDateString('fr-FR') : typeof item.date === 'string' ? new Date(item.date).toLocaleDateString('fr-FR') : '--';
Â  Â  Â  Â  Â  Â  Â  Â  let statusBadge;
Â  Â  Â  Â  Â  Â  Â  Â  if (item.note === "ABS" || item.absent) statusBadge = '<span class="status-badge status-absent">ğŸš« Absent</span>';
Â  Â  Â  Â  Â  Â  Â  Â  else if (item.note === "NN" || item.nonNote) statusBadge = '<span class="status-badge status-nn">âš ï¸ NN</span>';
Â  Â  Â  Â  Â  Â  Â  Â  else if (item.estCorrige) statusBadge = '<span class="status-badge status-corrected">âœ“ CorrigÃ©</span>';
Â  Â  Â  Â  Â  Â  Â  Â  else statusBadge = '<span class="status-badge status-pending">â³</span>';
Â  Â  Â  Â  Â  Â  Â  Â  let noteClass = 'note-pending', noteText = '--';
Â  Â  Â  Â  Â  Â  Â  Â  if (item.note === "ABS" || item.absent) { noteText = 'ABS'; noteClass = 'note-absent'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (item.note === "NN" || item.nonNote) { noteText = 'NN'; noteClass = 'note-nn'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (item.note !== null && !isNaN(item.note)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  noteText = parseFloat(item.note).toFixed(1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.note >= 16) noteClass = 'note-excellent'; else if (item.note >= 12) noteClass = 'note-good'; else if (item.note >= 10) noteClass = 'note-average'; else noteClass = 'note-poor';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="eval-card"><div class="eval-header"><div><div class="eval-title">${item.titre}</div><div class="eval-meta"><span class="eval-date">ğŸ“… ${dateStr}</span>${statusBadge}</div></div><div class="eval-note ${noteClass}">${noteText}</div></div><button class="btn-view" onclick="ouvrirDetail('${item.id}')" ${!item.estCorrige ? 'disabled' : ''}>ğŸ‘ï¸ ${item.estCorrige ? 'Voir ma copie' : 'En attente...'}</button></div>`;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // SUIVI DE CLASSE
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  async function chargerSuivi() {
Â  Â  Â  Â  Â  Â  if (!currentUserCode) return;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const suiviRef = collection(db, "resultats", currentUserCode, "suivi");
Â  Â  Â  Â  Â  Â  Â  Â  const suiviSnap = await getDocs(suiviRef);
Â  Â  Â  Â  Â  Â  Â  Â  allSuivis = [];
Â  Â  Â  Â  Â  Â  Â  Â  suiviSnap.forEach(doc => { allSuivis.push({ id: doc.id, ...doc.data() }); });
Â  Â  Â  Â  Â  Â  Â  Â  allSuivis.sort((a, b) => { const dateA = a.date + ' ' + (a.heure || '00:00'); const dateB = b.date + ' ' + (b.heure || '00:00'); return dateB.localeCompare(dateA); });
Â  Â  Â  Â  Â  Â  Â  Â  afficherSuivi();
Â  Â  Â  Â  Â  Â  Â  Â  calculerPosture();
Â  Â  Â  Â  Â  Â  } catch (error) { console.error("Erreur suivi:", error); }
Â  Â  Â  Â  }

Â  Â  Â  Â  function afficherSuivi() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('suiviContent');
Â  Â  Â  Â  Â  Â  if (allSuivis.length === 0) { container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Pas encore de suivi</div></div>`; return; }
Â  Â  Â  Â  Â  Â  const seancesPresent = allSuivis.filter(s => !s.absent);
Â  Â  Â  Â  Â  Â  const nbTotal = allSuivis.length, nbPresent = seancesPresent.length;
Â  Â  Â  Â  Â  Â  const tauxPresence = nbTotal > 0 ? Math.round((nbPresent / nbTotal) * 100) : 0;
Â  Â  Â  Â  Â  Â  const moyenne = calculerMoyenneSuivi();
Â  Â  Â  Â  Â  Â  const tendances = calculerTendances();
Â  Â  Â  Â  Â  Â  let moyenneIcon = moyenne >= 15 ? 'â­' : moyenne >= 12 ? 'ğŸ‘' : 'ğŸ“ˆ';
Â  Â  Â  Â  Â  Â  let presenceColor = tauxPresence >= 85 ? '#16a34a' : tauxPresence >= 70 ? '#f59e0b' : '#dc2626';
Â  Â  Â  Â  Â  Â  let html = `<div class="suivi-header"><div class="suivi-stats-row"><div class="suivi-moyenne">${moyenneIcon} ${moyenne}/20</div><div class="suivi-presence" style="color: ${presenceColor};">ğŸ“… ${tauxPresence}%</div></div><div class="suivi-label">Moyenne â€¢ ${nbPresent}/${nbTotal} sÃ©ances</div></div><div class="tendances-grid"><div class="tendance-card"><div class="tendance-icon">ğŸ“</div><div class="tendance-label">Travail</div><div class="tendance-value">${tendances.travail}%</div></div><div class="tendance-card"><div class="tendance-icon">ğŸ—£ï¸</div><div class="tendance-label">Oral</div><div class="tendance-value">${tendances.oral}%</div></div><div class="tendance-card"><div class="tendance-icon">ğŸ§ </div><div class="tendance-label">Attention</div><div class="tendance-value">${tendances.attention}%</div></div><div class="tendance-card"><div class="tendance-icon">ğŸ“</div><div class="tendance-label">MatÃ©riel</div><div class="tendance-value">${tendances.porteVue}%</div></div></div><h4 style="margin-bottom: 10px; color: #1e293b; font-size: 0.95em;">ğŸ“… Historique</h4>`;
Â  Â  Â  Â  Â  Â  allSuivis.forEach((s, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  const dateFormatted = formatDateSuivi(s.date);
Â  Â  Â  Â  Â  Â  Â  Â  if (s.absent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="seance-card seance-absent"><div class="seance-header"><div class="seance-info"><div class="seance-date">${dateFormatted}</div><div class="seance-module">${s.module || ''}</div></div><div class="seance-note"><span class="seance-note-value absent">ABS</span><span class="seance-note-icon">ğŸš«</span></div></div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const noteIcon = getNoteIconSuivi(s.noteSur20), noteClass = getNoteClassSuivi(s.noteSur20);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="seance-card"><div class="seance-header" onclick="toggleSeanceDetail(${idx})"><div class="seance-info"><div class="seance-date">${dateFormatted}</div><div class="seance-module">${s.module || ''}</div></div><div class="seance-note"><span class="seance-note-value ${noteClass}">${s.noteSur20}/20</span><span class="seance-note-icon">${noteIcon}</span></div></div><div class="seance-detail" id="seanceDetail${idx}">${renderSeanceDetail(s)}</div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  container.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderSeanceDetail(s) {
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  const travailMap = { 'tresbien': { label: 'âœ“âœ“ TrÃ¨s bien', cls: 'good' }, 'fait': { label: 'âœ“ Fait', cls: 'good' }, 'partiel': { label: 'âš ï¸ Partiel', cls: 'medium' }, 'insuffisant': { label: 'âŒ Non fait', cls: 'bad' } };
Â  Â  Â  Â  Â  Â  const attentionMap = { 'bonne': { label: 'ğŸ˜Š Bonne', cls: 'good' }, 'moyenne': { label: 'ğŸ˜ Moyenne', cls: 'medium' }, 'insuffisante': { label: 'ğŸ˜• Insuffisante', cls: 'bad' } };
Â  Â  Â  Â  Â  Â  const pvMap = { 'ok': { label: 'âœ… OK', cls: 'good' }, 'oubli': { label: 'âŒ OubliÃ©', cls: 'bad' } };
Â  Â  Â  Â  Â  Â  if (s.travail && travailMap[s.travail]) html += `<div class="detail-row"><span class="detail-label">ğŸ“ Travail</span><span class="detail-value ${travailMap[s.travail].cls}">${travailMap[s.travail].label}</span></div>`;
Â  Â  Â  Â  Â  Â  if (s.attention && attentionMap[s.attention]) html += `<div class="detail-row"><span class="detail-label">ğŸ§  Attention</span><span class="detail-value ${attentionMap[s.attention].cls}">${attentionMap[s.attention].label}</span></div>`;
Â  Â  Â  Â  Â  Â  if (s.porteVue && pvMap[s.porteVue]) html += `<div class="detail-row"><span class="detail-label">ğŸ“ MatÃ©riel</span><span class="detail-value ${pvMap[s.porteVue].cls}">${pvMap[s.porteVue].label}</span></div>`;
Â  Â  Â  Â  Â  Â  if (s.commentaire) html += `<div class="seance-comment">ğŸ’¬ "${s.commentaire}"</div>`;
Â  Â  Â  Â  Â  Â  return html || '<div style="color:#94a3b8;font-size:0.85em;">Pas de dÃ©tails</div>';
Â  Â  Â  Â  }

Â  Â  Â  Â  window.toggleSeanceDetail = function(idx) { const el = document.getElementById('seanceDetail' + idx); if (el) el.classList.toggle('open'); };

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // CALCULS
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  function calculerMoyenneSuivi() {
Â  Â  Â  Â  Â  Â  const seancesAvecNote = allSuivis.filter(s => !s.absent && s.noteSur20 !== null && s.noteSur20 !== undefined);
Â  Â  Â  Â  Â  Â  if (seancesAvecNote.length === 0) return 0;
Â  Â  Â  Â  Â  Â  return Math.round((seancesAvecNote.reduce((acc, s) => acc + (s.noteSur20 || 0), 0) / seancesAvecNote.length) * 10) / 10;
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculerTendances() {
Â  Â  Â  Â  Â  Â  const result = { travail: 0, oral: 0, attention: 0, porteVue: 0 };
Â  Â  Â  Â  Â  Â  const seancesPresent = allSuivis.filter(s => !s.absent);
Â  Â  Â  Â  Â  Â  if (seancesPresent.length === 0) return result;
Â  Â  Â  Â  Â  Â  let travailBon = 0, travailTotal = 0;
Â  Â  Â  Â  Â  Â  seancesPresent.forEach(s => { if (s.travail && s.travail !== 'ne') { travailTotal++; if (s.travail === 'tresbien' || s.travail === 'fait') travailBon++; } });
Â  Â  Â  Â  Â  Â  if (travailTotal > 0) result.travail = Math.round((travailBon / travailTotal) * 100);
Â  Â  Â  Â  Â  Â  let oralTotal = 0, oralCount = 0;
Â  Â  Â  Â  Â  Â  seancesPresent.forEach(s => { if (s.oral !== undefined && s.oral !== null && s.oral !== 'ne') { const val = parseInt(s.oral); if (!isNaN(val)) { oralCount++; oralTotal += val; } } });
Â  Â  Â  Â  Â  Â  if (oralCount > 0) result.oral = Math.round((oralTotal / oralCount / 4) * 100);
Â  Â  Â  Â  Â  Â  let attentionBon = 0, attentionTotal = 0;
Â  Â  Â  Â  Â  Â  seancesPresent.forEach(s => { if (s.attention && s.attention !== 'ne') { attentionTotal++; if (s.attention === 'bonne') attentionBon++; } });
Â  Â  Â  Â  Â  Â  if (attentionTotal > 0) result.attention = Math.round((attentionBon / attentionTotal) * 100);
Â  Â  Â  Â  Â  Â  let pvBon = 0, pvTotal = 0;
Â  Â  Â  Â  Â  Â  seancesPresent.forEach(s => { if (s.porteVue && s.porteVue !== 'ne') { pvTotal++; if (s.porteVue === 'ok') pvBon++; } });
Â  Â  Â  Â  Â  Â  if (pvTotal > 0) result.porteVue = Math.round((pvBon / pvTotal) * 100);
Â  Â  Â  Â  Â  Â  return result;
Â  Â  Â  Â  }

Â  Â  Â  Â  function getNoteIconSuivi(note) { if (note >= 18) return 'ğŸ†'; if (note >= 15) return 'â­'; if (note >= 12) return 'ğŸ‘'; if (note >= 10) return 'ğŸ’ª'; return 'ğŸ“ˆ'; }
Â  Â  Â  Â  function getNoteClassSuivi(note) { if (note >= 18) return 'note-excellent-suivi'; if (note >= 15) return 'note-good-suivi'; if (note >= 12) return 'note-average-suivi'; return 'note-poor-suivi'; }
Â  Â  Â  Â  function formatDateSuivi(dateStr) { if (!dateStr) return '--'; const d = new Date(dateStr); return d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }); }

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // MA POSTURE (Ã‰TOILES)
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  function calculerPosture() {
Â  Â  Â  Â  Â  Â  const section = document.getElementById('postureSection');
Â  Â  Â  Â  Â  Â  if (!section) return;
Â  Â  Â  Â  Â  Â  const suivisTries = [...allSuivis].sort((a, b) => { const dateA = a.date + ' ' + (a.heure || '00:00'); const dateB = b.date + ' ' + (b.heure || '00:00'); return dateA.localeCompare(dateB); });
Â  Â  Â  Â  Â  Â  function estSeanceParfaite(s) { if (s.absent) return false; if (s.bavardage && s.bavardage !== 'aucun') return false; if (s.telephone && s.telephone !== 'ok') return false; if (s.noteSur20 === null || s.noteSur20 === undefined || s.noteSur20 < 12) return false; return true; }
Â  Â  Â  Â  Â  Â  let serieRecord = 0, tempSerie = 0;
Â  Â  Â  Â  Â  Â  for (const s of suivisTries) { if (estSeanceParfaite(s)) { tempSerie++; if (tempSerie > serieRecord) serieRecord = tempSerie; } else { tempSerie = 0; } }
Â  Â  Â  Â  Â  Â  let serieActuelle = 0;
Â  Â  Â  Â  Â  Â  for (let i = suivisTries.length - 1; i >= 0; i--) { if (estSeanceParfaite(suivisTries[i])) serieActuelle++; else break; }
Â  Â  Â  Â  Â  Â  let etoilesHtml = '';
Â  Â  Â  Â  Â  Â  for (let i = 0; i < 5; i++) { etoilesHtml += i < serieActuelle ? `<button class="etoile-btn" data-star="${i+1}">â­</button>` : `<button class="etoile-btn empty" data-star="${i+1}">â˜†</button>`; }
Â  Â  Â  Â  Â  Â  document.getElementById('postureEtoiles').innerHTML = etoilesHtml;
Â  Â  Â  Â  Â  Â  document.getElementById('postureProgressBar').style.width = Math.min(100, (serieActuelle / 5) * 100) + '%';
Â  Â  Â  Â  Â  Â  document.getElementById('serieActuelle').textContent = serieActuelle;
Â  Â  Â  Â  Â  Â  document.getElementById('serieRecord').textContent = serieRecord;
Â  Â  Â  Â  Â  Â  const messageEl = document.getElementById('postureMessage'), badgeEl = document.getElementById('pronoteBadge');
Â  Â  Â  Â  Â  Â  if (serieActuelle >= 5) { section.classList.add('achieved'); messageEl.textContent = 'ğŸ‰ BRAVO ! Objectif atteint !'; badgeEl.innerHTML = 'ğŸ† DÃ‰BLOQUÃ‰ !'; }
Â  Â  Â  Â  Â  Â  else { section.classList.remove('achieved'); const restant = 5 - serieActuelle; messageEl.textContent = serieActuelle === 0 ? 'Commence ta sÃ©rie ! ğŸ†' : serieActuelle === 4 ? 'Plus qu\'une sÃ©ance ! ğŸ†' : `Encore ${restant} sÃ©ance${restant > 1 ? 's' : ''} ! ğŸ†`; }
Â  Â  Â  Â  }

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // MON HUMEUR
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  window.selectHumeur = async function(humeurKey, emoji) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.humeur-btn').forEach(btn => btn.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  document.querySelector(`.humeur-btn[data-humeur="${humeurKey}"]`)?.classList.add('selected');
Â  Â  Â  Â  Â  Â  if (currentUserCode) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, 'resultats', currentUserCode, 'emotions', today), { emotion: humeurKey, emoji: emoji, date: today, timestamp: serverTimestamp() });
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) { console.error('Erreur humeur:', error); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  async function chargerHumeurDuJour() {
Â  Â  Â  Â  Â  Â  if (!currentUserCode) return;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  const humeurSnap = await getDoc(doc(db, 'resultats', currentUserCode, 'emotions', today));
Â  Â  Â  Â  Â  Â  Â  Â  if (humeurSnap.exists()) document.querySelector(`.humeur-btn[data-humeur="${humeurSnap.data().emotion}"]`)?.classList.add('selected');
Â  Â  Â  Â  Â  Â  } catch (error) { console.error('Erreur chargement humeur:', error); }
Â  Â  Â  Â  }

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // BILAN
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  window.updateSliderEmoji = function(sliderId, emojiId) { const emojis = ['ğŸ˜¢', 'ğŸ˜”', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„']; document.getElementById(emojiId).textContent = emojis[parseInt(document.getElementById(sliderId).value) - 1]; };
Â  Â  Â  Â  window.selectBilanRadio = function(inputId, value, btn) { btn.parentElement.querySelectorAll('.bilan-radio-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); document.getElementById(inputId).value = value; };

Â  Â  Â  Â  function getSemaineActuelle() {
Â  Â  Â  Â  Â  Â  const today = new Date(), dayOfWeek = today.getDay();
Â  Â  Â  Â  Â  Â  const monday = new Date(today); monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
Â  Â  Â  Â  Â  Â  const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
Â  Â  Â  Â  Â  Â  const options = { day: 'numeric', month: 'long' };
Â  Â  Â  Â  Â  Â  return { display: `Semaine du ${monday.toLocaleDateString('fr-FR', options)} au ${sunday.toLocaleDateString('fr-FR', options)}`, key: monday.toISOString().split('T')[0] };
Â  Â  Â  Â  }

Â  Â  Â  Â  function initBilanSemaine() { const semaine = getSemaineActuelle(); document.getElementById('bilanSemaineDates').textContent = semaine.display; chargerBilanSemaine(semaine.key); }

Â  Â  Â  Â  async function chargerBilanSemaine(semaineKey) {
Â  Â  Â  Â  Â  Â  if (!currentUserCode) return;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const bilanSnap = await getDoc(doc(db, 'resultats', currentUserCode, 'bilans', semaineKey));
Â  Â  Â  Â  Â  Â  Â  Â  if (bilanSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = bilanSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.concentration) { document.getElementById('bilanConcentration').value = data.concentration; updateSliderEmoji('bilanConcentration', 'bilanConcentrationEmoji'); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.engagement) { document.getElementById('bilanEngagement').value = data.engagement; updateSliderEmoji('bilanEngagement', 'bilanEngagementEmoji'); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.emotions) { document.getElementById('bilanEmotions').value = data.emotions; updateSliderEmoji('bilanEmotions', 'bilanEmotionsEmoji'); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.relations) { document.getElementById('bilanRelations').value = data.relations; updateSliderEmoji('bilanRelations', 'bilanRelationsEmoji'); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.fierte) document.getElementById('bilanFierte').value = data.fierte;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  chargerBilanHistorique();
Â  Â  Â  Â  Â  Â  } catch (error) { console.error('Erreur bilan:', error); }
Â  Â  Â  Â  }

Â  Â  Â  Â  window.sauvegarderBilan = async function() {
Â  Â  Â  Â  Â  Â  if (!currentUserCode) return;
Â  Â  Â  Â  Â  Â  const semaine = getSemaineActuelle();
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, 'resultats', currentUserCode, 'bilans', semaine.key), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  semaine: semaine.key, semaineDisplay: semaine.display,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  concentration: parseInt(document.getElementById('bilanConcentration').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  engagement: parseInt(document.getElementById('bilanEngagement').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  emotions: parseInt(document.getElementById('bilanEmotions').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  relations: parseInt(document.getElementById('bilanRelations').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gestion: document.getElementById('bilanGestion').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conflit: document.getElementById('bilanConflit').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  global: document.getElementById('bilanGlobal').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fierte: document.getElementById('bilanFierte').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('bilanMessage').classList.add('visible');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => document.getElementById('bilanMessage').classList.remove('visible'), 3000);
Â  Â  Â  Â  Â  Â  Â  Â  chargerBilanHistorique();
Â  Â  Â  Â  Â  Â  } catch (error) { console.error('Erreur sauvegarde:', error); alert('Erreur'); }
Â  Â  Â  Â  };

Â  Â  Â  Â  async function chargerBilanHistorique() {
Â  Â  Â  Â  Â  Â  if (!currentUserCode) return;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const bilansSnap = await getDocs(collection(db, 'resultats', currentUserCode, 'bilans'));
Â  Â  Â  Â  Â  Â  Â  Â  const bilans = []; bilansSnap.forEach(doc => bilans.push({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  Â  Â  const semaineActuelle = getSemaineActuelle().key;
Â  Â  Â  Â  Â  Â  Â  Â  const anciensBilans = bilans.filter(b => b.semaine !== semaineActuelle).sort((a, b) => b.semaine.localeCompare(a.semaine)).slice(0, 4);
Â  Â  Â  Â  Â  Â  Â  Â  const historiqueSection = document.getElementById('bilanHistorique'), historiqueEl = document.getElementById('bilanHistoriqueList');
Â  Â  Â  Â  Â  Â  Â  Â  if (anciensBilans.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  historiqueSection.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const globalEmojis = { 'super': 'ğŸ¤©', 'bien': 'ğŸ˜Š', 'moyen': 'ğŸ˜', 'difficile': 'ğŸ˜”' };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  historiqueEl.innerHTML = anciensBilans.map(b => `<div class="bilan-historique-item"><div class="bilan-historique-semaine">${b.semaineDisplay || b.semaine}</div><div class="bilan-historique-resume"><span>${globalEmojis[b.global] || '?'}</span><span>ğŸ¯ ${b.concentration}/5</span><span>ğŸ’ª ${b.engagement}/5</span></div></div>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  } else { historiqueSection.style.display = 'none'; }
Â  Â  Â  Â  Â  Â  } catch (error) { console.error('Erreur historique:', error); }
Â  Â  Â  Â  }

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // COURS
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  function afficherCours() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('coursContent');
Â  Â  Â  Â  Â  Â  const suivisAvecCours = allSuivis.filter(s => s.coursDistrib && s.coursDistrib !== 'aucun');
Â  Â  Â  Â  Â  Â  if (suivisAvecCours.length === 0) { container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“„</div><div class="empty-text">Pas encore de cours</div></div>`; return; }
Â  Â  Â  Â  Â  Â  const parModule = {};
Â  Â  Â  Â  Â  Â  suivisAvecCours.forEach(s => { const moduleKey = s.module || 'Inconnu'; if (!parModule[moduleKey]) parModule[moduleKey] = { module: s.module, moduleTitre: s.moduleTitre, seances: [] }; parModule[moduleKey].seances.push({ type: s.coursDistrib, date: s.date, recu: !(s.absent && s.coursRecu === false) }); });
Â  Â  Â  Â  Â  Â  let coursManquants = 0;
Â  Â  Â  Â  Â  Â  Object.values(parModule).forEach(m => m.seances.forEach(s => { if (!s.recu) coursManquants++; }));
Â  Â  Â  Â  Â  Â  const coursLabels = { 'seance1': 'SÃ©ance 1', 'seance2': 'SÃ©ance 2', 'seance3': 'SÃ©ance 3', 'seance4': 'SÃ©ance 4', 'complet': 'Cours complet' };
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  if (coursManquants > 0) html += `<div class="cours-alerte"><span class="cours-alerte-icon">âš ï¸</span><span class="cours-alerte-text">${coursManquants} cours Ã  rÃ©cupÃ©rer</span></div>`;
Â  Â  Â  Â  Â  Â  Object.values(parModule).forEach(m => {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="cours-module-card"><div class="cours-module-header"><div class="module-code">${m.module || 'Module'}</div><div class="module-titre">${m.moduleTitre || ''}</div></div><div class="cours-seances-list">`;
Â  Â  Â  Â  Â  Â  Â  Â  m.seances.sort((a, b) => a.date.localeCompare(b.date)).forEach(s => { const label = coursLabels[s.type] || s.type; const icon = s.type === 'complet' ? 'ğŸ“š' : 'ğŸ“„'; html += `<div class="cours-seance-row"><div class="cours-seance-info"><span class="cours-seance-icon">${icon}</span><div><div class="cours-seance-nom">${label}</div><div class="cours-seance-date">${formatDateSuivi(s.date)}</div></div></div><span class="cours-seance-status ${s.recu ? 'recu' : 'manquant'}">${s.recu ? 'âœ… ReÃ§u' : 'âŒ Ã€ rÃ©cup'}</span></div>`; });
Â  Â  Â  Â  Â  Â  Â  Â  html += `</div></div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  container.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // MODAL DÃ‰TAIL V2 â€” REFONTE COMPLÃˆTE
Â  Â  Â  Â  // 6 corrections : parsing rÃ©cursif, matching intelligent,
Â  Â  Â  Â  // tableau compÃ©tences, hiÃ©rarchie visuelle, formatage adaptÃ©
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Â  Â  Â  Â  /** Extraire TOUTES les questions, mÃªme imbriquÃ©es dans sections/parts */
Â  Â  Â  Â  function extractAllQuestions(blueprint) {
Â  Â  Â  Â  Â  Â  const questions = [];
Â  Â  Â  Â  Â  Â  if (!blueprint || !blueprint.content) return questions;
Â  Â  Â  Â  Â  Â  function walk(items) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(items)) return;
Â  Â  Â  Â  Â  Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.type === 'question') questions.push(item);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.content) walk(item.content);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.children) walk(item.children);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.items) walk(item.items);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  walk(blueprint.content);
Â  Â  Â  Â  Â  Â  return questions;
Â  Â  Â  Â  }

Â  Â  Â  Â  /** Matching intelligent : essaie qid exact â†’ Q+label â†’ label â†’ suffixes */
Â  Â  Â  Â  function matchReponseEleve(qid, label, reponses) {
Â  Â  Â  Â  Â  Â  if (!reponses) return null;
Â  Â  Â  Â  Â  Â  // 1. Exact
Â  Â  Â  Â  Â  Â  if (reponses[qid] !== undefined) return reponses[qid];
Â  Â  Â  Â  Â  Â  // 2. Q + label
Â  Â  Â  Â  Â  Â  if (label) {
Â  Â  Â  Â  Â  Â  Â  Â  if (reponses['Q' + label] !== undefined) return reponses['Q' + label];
Â  Â  Â  Â  Â  Â  Â  Â  if (reponses[label] !== undefined) return reponses[label];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // 3. Suffixes
Â  Â  Â  Â  Â  Â  for (const suffix of ['_gravite', '_decision', '_matrice', '_trous']) {
Â  Â  Â  Â  Â  Â  Â  Â  if (reponses[qid + suffix] !== undefined) return reponses[qid + suffix];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // 4. Matching partiel (q_0 â†’ q_0_sd, q_0_ed...)
Â  Â  Â  Â  Â  Â  const partials = Object.entries(reponses).filter(([key]) => key.startsWith(qid + '_'));
Â  Â  Â  Â  Â  Â  if (partials.length === 1) return partials[0][1];
Â  Â  Â  Â  Â  Â  if (partials.length > 1) {
Â  Â  Â  Â  Â  Â  Â  Â  return partials.map(([k, v]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sfx = k.replace(qid + '_', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `[${sfx}] ${Array.isArray(v) ? v.join(', ') : v}`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }

Â  Â  Â  Â  /** Formater une rÃ©ponse pour affichage HTML */
Â  Â  Â  Â  function formatReponseDisplay(reponse) {
Â  Â  Â  Â  Â  Â  if (reponse === null || reponse === undefined) return '<span style="color:#94a3b8; font-style:italic;">Non rÃ©pondu</span>';
Â  Â  Â  Â  Â  Â  if (Array.isArray(reponse)) {
Â  Â  Â  Â  Â  Â  Â  Â  const hasArrows = reponse.some(r => typeof r === 'string' && r.includes('â†’'));
Â  Â  Â  Â  Â  Â  Â  Â  if (hasArrows) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return '<div class="matching-display">' + reponse.map(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof r === 'string' && r.includes('â†’')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parts = r.split('â†’').map(p => p.trim());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="matching-row"><span>${parts[0]}</span><span class="matching-arrow">â†’</span><span>${parts.slice(1).join(' â†’ ')}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="matching-row"><span>${r}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('') + '</div>';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return reponse.map(r => `â€¢ ${r}`).join('<br>');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (typeof reponse === 'string') return reponse.replace(/\n/g, '<br>');
Â  Â  Â  Â  Â  Â  return String(reponse);
Â  Â  Â  Â  }

Â  Â  Â  Â  /** AgrÃ©ger les compÃ©tences pour le tableau rÃ©capitulatif */
Â  Â  Â  Â  function aggregateCompetences(bpQuestions, evalQuestions, evalCompetences) {
Â  Â  Â  Â  Â  Â  const compMap = {};
Â  Â  Â  Â  Â  Â  bpQuestions.forEach(bpQ => {
Â  Â  Â  Â  Â  Â  Â  Â  const comp = bpQ.competence;
Â  Â  Â  Â  Â  Â  Â  Â  if (!comp) return;
Â  Â  Â  Â  Â  Â  Â  Â  const evalQ = evalQuestions[bpQ.qid] || {};
Â  Â  Â  Â  Â  Â  Â  Â  const niveau = evalQ.level || 'NT';
Â  Â  Â  Â  Â  Â  Â  Â  const bareme = parseFloat(bpQ.bareme) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const points = parseFloat(evalQ.points) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  if (!compMap[comp]) compMap[comp] = { totalBareme: 0, totalPoints: 0, niveaux: [], questions: [] };
Â  Â  Â  Â  Â  Â  Â  Â  compMap[comp].totalBareme += bareme;
Â  Â  Â  Â  Â  Â  Â  Â  compMap[comp].totalPoints += points;
Â  Â  Â  Â  Â  Â  Â  Â  compMap[comp].niveaux.push(niveau);
Â  Â  Â  Â  Â  Â  Â  Â  compMap[comp].questions.push(bpQ.qid);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (evalCompetences && typeof evalCompetences === 'object') {
Â  Â  Â  Â  Â  Â  Â  Â  Object.entries(evalCompetences).forEach(([comp, data]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!compMap[comp]) compMap[comp] = { totalBareme: 0, totalPoints: 0, niveaux: [], questions: [] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof data === 'object' && data.points !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  compMap[comp].totalPoints = parseFloat(data.points) || compMap[comp].totalPoints;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  compMap[comp].totalBareme = parseFloat(data.bareme) || compMap[comp].totalBareme;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.niveau) compMap[comp].niveauGlobal = data.niveau;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const niveauOrder = { 'M': 3, 'A': 2, 'I': 1, 'NT': 0 };
Â  Â  Â  Â  Â  Â  Object.values(compMap).forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!c.niveauGlobal && c.niveaux.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const avg = c.niveaux.reduce((sum, n) => sum + (niveauOrder[n] || 0), 0) / c.niveaux.length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (avg >= 2.5) c.niveauGlobal = 'M'; else if (avg >= 1.5) c.niveauGlobal = 'A'; else if (avg >= 0.5) c.niveauGlobal = 'I'; else c.niveauGlobal = 'NT';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return compMap;
Â  Â  Â  Â  }

Â  Â  Â  Â  const NIVEAU_CONFIG = {
Â  Â  Â  Â  Â  Â  M: Â { label: 'MaÃ®trisÃ©', Â  short: 'M', Â emoji: 'ğŸŸ¢', css: 'badge-M', Â barPercent: 100 },
Â  Â  Â  Â  Â  Â  A: Â { label: 'Acceptable', Â short: 'A', Â emoji: 'ğŸ”µ', css: 'badge-A', Â barPercent: 66 },
Â  Â  Â  Â  Â  Â  I: Â { label: 'Insuffisant', short: 'I', Â emoji: 'ğŸŸ ', css: 'badge-I', Â barPercent: 33 },
Â  Â  Â  Â  Â  Â  NT: { label: 'Non traitÃ©', Â short: 'NT', emoji: 'âšª', css: 'badge-NT', barPercent: 5 }
Â  Â  Â  Â  };

Â  Â  Â  Â  window.ouvrirDetail = async function(evalId) {
Â  Â  Â  Â  Â  Â  const evaluation = allEvaluations.find(e => e.id === evalId);
Â  Â  Â  Â  Â  Â  if (!evaluation || !evaluation.estCorrige) return;

Â  Â  Â  Â  Â  Â  // Charger le blueprint
Â  Â  Â  Â  Â  Â  let blueprint = null;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const resp = await fetch(`https://preventionsanteenvironnement.github.io/CockpitPSE/${evaluation.devoirId}_blueprint.json?ts=${Date.now()}`, { cache: "no-store" });
Â  Â  Â  Â  Â  Â  Â  Â  if (resp.ok) blueprint = await resp.json();
Â  Â  Â  Â  Â  Â  } catch (e) { console.warn("Blueprint non trouvÃ©:", e); }

Â  Â  Â  Â  Â  Â  // Extraire TOUTES les questions (parsing rÃ©cursif)
Â  Â  Â  Â  Â  Â  const bpQuestions = blueprint ? extractAllQuestions(blueprint) : [];

Â  Â  Â  Â  Â  Â  // PrÃ©parer note
Â  Â  Â  Â  Â  Â  const isNN = evaluation.note === "NN" || evaluation.nonNote;
Â  Â  Â  Â  Â  Â  const isABS = evaluation.note === "ABS";
Â  Â  Â  Â  Â  Â  const hasNote = evaluation.note !== null && !isNaN(evaluation.note) && !isNN && !isABS;
Â  Â  Â  Â  Â  Â  const noteVal = hasNote ? parseFloat(evaluation.note) : null;
Â  Â  Â  Â  Â  Â  const noteDisplay = isNN ? "Non notÃ©" : isABS ? "Absent" : hasNote ? noteVal.toFixed(1) + "/20" : "--";

Â  Â  Â  Â  Â  Â  let noteClass = 'nn';
Â  Â  Â  Â  Â  Â  if (hasNote) { if (noteVal >= 16) noteClass = 'excellent'; else if (noteVal >= 12) noteClass = 'good'; else if (noteVal >= 10) noteClass = 'average'; else noteClass = 'poor'; }

Â  Â  Â  Â  Â  Â  document.getElementById('modalTitle').textContent = evaluation.titre;
Â  Â  Â  Â  Â  Â  let html = '';

Â  Â  Â  Â  Â  Â  // â”€â”€ 1. BANNIÃˆRE NOTE â”€â”€
Â  Â  Â  Â  Â  Â  html += `<div class="modal-note-banner ${noteClass}">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-note-big">${noteDisplay}</div>
Â  Â  Â  Â  Â  Â  Â  Â  ${hasNote ? `<div class="modal-note-bar"><div class="modal-note-bar-fill" style="width:${Math.min(100, (noteVal / 20) * 100)}%"></div></div>` : ''}
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  // â”€â”€ 2. APPRÃ‰CIATION â”€â”€
Â  Â  Â  Â  Â  Â  if (evaluation.appreciation) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="appreciation-block"><div class="appreciation-title">ApprÃ©ciation</div><div class="appreciation-text">${evaluation.appreciation}</div></div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // â”€â”€ 3. COMPÃ‰TENCES â”€â”€
Â  Â  Â  Â  Â  Â  if (bpQuestions.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const compMap = aggregateCompetences(bpQuestions, evaluation.questions || {}, evaluation.competences);
Â  Â  Â  Â  Â  Â  Â  Â  const compEntries = Object.entries(compMap).sort((a, b) => a[0].localeCompare(b[0]));
Â  Â  Â  Â  Â  Â  Â  Â  if (compEntries.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="comp-summary"><div class="comp-summary-title">ğŸ¯ Mes compÃ©tences</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  compEntries.forEach(([comp, data]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const niv = data.niveauGlobal || 'NT';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cfg = NIVEAU_CONFIG[niv] || NIVEAU_CONFIG.NT;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pointsStr = data.totalBareme > 0 ? `${data.totalPoints}/${data.totalBareme}` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="comp-row"><span class="comp-name">${comp}</span><div class="comp-bar-wrap"><div class="comp-bar-fill level-${niv}" style="width:${cfg.barPercent}%"></div></div><span class="comp-points">${pointsStr}</span><span class="comp-level-badge ${cfg.css}">${cfg.emoji} ${cfg.short}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // â”€â”€ 4. QUESTIONS AVEC HIÃ‰RARCHIE â”€â”€
Â  Â  Â  Â  Â  Â  if (bpQuestions.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const questionsAvecEval = bpQuestions.map((bpQ, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const evalQ = (evaluation.questions || {})[bpQ.qid] || {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bpQ, idx, evalQ,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  niveau: evalQ.level || 'NT',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentaire: evalQ.comment || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reponse: matchReponseEleve(bpQ.qid, bpQ.label, evaluation.reponses),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correction: bpQ.reponseAttendue || ''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const erreurs = questionsAvecEval.filter(q => q.niveau === 'I' || q.niveau === 'NT');
Â  Â  Â  Â  Â  Â  Â  Â  const reussites = questionsAvecEval.filter(q => q.niveau === 'M' || q.niveau === 'A');

Â  Â  Â  Â  Â  Â  Â  Â  // SECTION ERREURS (dÃ©veloppÃ©es)
Â  Â  Â  Â  Â  Â  Â  Â  if (erreurs.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="modal-section-header section-errors">âŒ Ã€ revoir <span class="section-count">${erreurs.length}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  erreurs.forEach(q => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cfg = NIVEAU_CONFIG[q.niveau] || NIVEAU_CONFIG.NT;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="question-card-grid card-error">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="question-header-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="question-number-grid">Q${q.bpQ.label || (q.idx + 1)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${q.bpQ.competence ? `<div class="question-comp-grid">${q.bpQ.competence}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="question-level-grid ${cfg.css}">${cfg.emoji} ${cfg.label}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="question-text-grid">${q.bpQ.questionText}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="answer-section-grid"><div class="section-label-grid">âœï¸ Ta rÃ©ponse</div><div class="section-content-grid">${formatReponseDisplay(q.reponse)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${q.correction ? `<div class="correction-section-grid"><div class="section-label-grid">ğŸ¯ Correction</div><div class="section-content-grid">${q.correction.replace(/\n/g, '<br>')}</div></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${q.commentaire ? `<div class="comment-section-grid"><div class="section-label-grid">ğŸ’¬ Commentaire</div><div class="section-content-grid">${q.commentaire}</div></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // SECTION RÃ‰USSITES (compactes, dÃ©pliables)
Â  Â  Â  Â  Â  Â  Â  Â  if (reussites.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="modal-section-header section-success">âœ… Acquis <span class="section-count">${reussites.length}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reussites.forEach((q, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uniqueId = `compact_${evalId}_${i}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cfg = NIVEAU_CONFIG[q.niveau] || NIVEAU_CONFIG.NT;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const shortText = q.bpQ.questionText.length > 50 ? q.bpQ.questionText.substring(0, 50) + '...' : q.bpQ.questionText;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="question-compact" onclick="toggleCompactDetail('${uniqueId}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="qc-left"><span class="qc-num">Q${q.bpQ.label || (q.idx + 1)}</span><span class="qc-text">${shortText}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="qc-badge comp-level-badge ${cfg.css}">${cfg.emoji} ${cfg.short}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="question-compact-detail" id="${uniqueId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="answer-section-grid"><div class="section-label-grid">âœï¸ Ta rÃ©ponse</div><div class="section-content-grid">${formatReponseDisplay(q.reponse)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${q.correction && q.correction.length < 200 ? `<div class="correction-section-grid"><div class="section-label-grid">ğŸ¯ Correction</div><div class="section-content-grid">${q.correction.replace(/\n/g, '<br>')}</div></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${q.commentaire ? `<div class="comment-section-grid"><div class="section-label-grid">ğŸ’¬ Commentaire</div><div class="section-content-grid">${q.commentaire}</div></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (!blueprint) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="no-blueprint-info">ğŸ“„ Le dÃ©tail question par question n'est pas encore disponible pour ce devoir.</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  if (evaluation.competences && Object.keys(evaluation.competences).length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="comp-summary"><div class="comp-summary-title">ğŸ¯ CompÃ©tences Ã©valuÃ©es</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.entries(evaluation.competences).forEach(([comp, data]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const niv = typeof data === 'object' ? (data.niveau || 'NT') : 'NT';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cfg = NIVEAU_CONFIG[niv] || NIVEAU_CONFIG.NT;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="comp-row"><span class="comp-name">${comp}</span><div class="comp-bar-wrap"><div class="comp-bar-fill level-${niv}" style="width:${cfg.barPercent}%"></div></div><span class="comp-level-badge ${cfg.css}">${cfg.emoji} ${cfg.short}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('modalBody').innerHTML = html;
Â  Â  Â  Â  Â  Â  document.getElementById('modalDetail').classList.add('active');
Â  Â  Â  Â  };

Â  Â  Â  Â  window.toggleCompactDetail = function(id) { const el = document.getElementById(id); if (el) el.classList.toggle('open'); };

Â  Â  Â  Â  window.fermerModal = function() { document.getElementById('modalDetail').classList.remove('active'); };

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // ONGLETS
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  window.switchTab = function(tabName, btn) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
Â  Â  Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
Â  Â  Â  Â  Â  Â  if (tabName === 'cours') afficherCours();
Â  Â  Â  Â  };

Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  // INIT
Â  Â  Â  Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  Â  Â  Â  window.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  const savedCode = localStorage.getItem('pse_user_code');
Â  Â  Â  Â  Â  Â  if (savedCode) { document.getElementById('codeInput').value = savedCode; connexion(); }
Â  Â  Â  Â  Â  Â  document.getElementById('codeInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') connexion(); });
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById('modalDetail').addEventListener('click', (e) => { if (e.target.id === 'modalDetail') fermerModal(); });
Â  Â  </script>
</body>
</html>
