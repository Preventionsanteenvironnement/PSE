<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import {
    getFirestore, collection, query, where, getDocs,
    doc, getDoc, setDoc, collectionGroup, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentUserCode = null;
  let currentEleveInfo = null;
  let allEvaluations = [];
  let allSuivis = [];

  function escapeHTML(value) {
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  window.connexion = async function() {
    const code = document.getElementById('codeInput').value.trim().toUpperCase();
    if (!code) return;
    document.getElementById('errorMsg').classList.remove('visible');

    try {
      let eleveInfo = null;
      if (typeof window.BDD_ELEVES !== 'undefined') {
        eleveInfo = window.BDD_ELEVES.find(e => e.userCode === code);
      }
      if (!eleveInfo) {
        document.getElementById('errorMsg').textContent = "Code inconnu.";
        document.getElementById('errorMsg').classList.add('visible');
        return;
      }

      currentUserCode = code;
      currentEleveInfo = eleveInfo;
      localStorage.setItem('pse_user_code', code);

      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('resultsScreen').classList.add('active');
      document.getElementById('studentName').textContent = code;
      document.getElementById('studentClass').textContent = eleveInfo.classe || "";

      await chargerDonnees();
      await enregistrerConsultation(code, eleveInfo.classe);
      chargerHumeurDuJour();
      initBilanSemaine();
    } catch (e) {
      console.error("Erreur connexion:", e);
      alert("Erreur: " + e.message);
    }
  };

  window.deconnexion = function() {
    localStorage.removeItem('pse_user_code');
    location.reload();
  };

  async function enregistrerConsultation(code, classe) {
    try {
      const now = new Date();
      const consultationRef = doc(db, "consultations", code);
      const docSnap = await getDoc(consultationRef);
      const count = docSnap.exists() ? (docSnap.data().nombreVisites || 0) : 0;
      await setDoc(
        consultationRef,
        {
          eleveCode: code,
          classe: classe,
          derniereConsultation: now.toISOString(),
          timestamp: serverTimestamp(),
          nombreVisites: count + 1
        },
        { merge: true }
      );
    } catch (error) {
      console.error("Erreur consultation:", error);
    }
  }

  async function chargerDonnees() {
    try {
      const qCopies = query(collectionGroup(db, "copies"), where("eleveCode", "==", currentUserCode));
      const snapCopies = await getDocs(qCopies);

      const qEvals = query(collectionGroup(db, "evaluations"), where("eleveCode", "==", currentUserCode));
      const snapEvals = await getDocs(qEvals);

      const evalsMap = new Map();
      snapEvals.forEach(d => {
        const evalData = d.data();
        evalsMap.set(evalData.devoirId, evalData);
      });

      allEvaluations = [];
      snapCopies.forEach(docSnap => {
        const copie = docSnap.data();
        const evaluation = evalsMap.get(copie.devoirId);

        allEvaluations.push({
          id: docSnap.id,
          copie: copie,
          evaluation: evaluation,
          estCorrige: !!evaluation,
          devoirId: copie.devoirId,
          titre: copie.titre || "Devoir",
          date: copie.createdAtISO || copie.createdAt?.toDate?.() || new Date(),
          note: evaluation?.note_finale ?? null,
          nonNote: evaluation?.nonNote || false,
          appreciation: evaluation?.appreciation || "",
          competences: evaluation?.competences || {},
          questions: evaluation?.questions || {},
          reponses: copie.reponses || {}
        });
      });

      allEvaluations.sort((a, b) => new Date(b.date) - new Date(a.date));

      afficherStatistiques();
      afficherListeEvaluations();
      await chargerSuivi();
    } catch (e) {
      console.error("Erreur chargement:", e);
    }
  }

  function afficherStatistiques() {
    const corriges = allEvaluations.filter(e => e.estCorrige);
    const notes = corriges
      .filter(e => e.note !== null && e.note !== "NN" && e.note !== "ABS" && !e.nonNote && !isNaN(e.note))
      .map(e => parseFloat(e.note));

    const moyenne = notes.length > 0
      ? (notes.reduce((a, b) => a + b, 0) / notes.length).toFixed(1)
      : "--";

    document.getElementById('statMoyenne').textContent = moyenne + (moyenne !== "--" ? "/20" : "");
    document.getElementById('statCorriges').textContent = corriges.length;
  }

  function afficherListeEvaluations() {
    const container = document.getElementById('evalList');
    if (allEvaluations.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Aucune Ã©valuation</div></div>`;
      return;
    }

    container.innerHTML = allEvaluations.map(item => {
      const dateStr =
        item.date instanceof Date ? item.date.toLocaleDateString('fr-FR') :
        typeof item.date === 'string' ? new Date(item.date).toLocaleDateString('fr-FR') : '--';

      let statusBadge;
      if (item.note === "ABS" || item.absent) statusBadge = '<span class="status-badge status-absent">ğŸš« Absent</span>';
      else if (item.note === "NN" || item.nonNote) statusBadge = '<span class="status-badge status-nn">âš ï¸ NN</span>';
      else if (item.estCorrige) statusBadge = '<span class="status-badge status-corrected">âœ“ CorrigÃ©</span>';
      else statusBadge = '<span class="status-badge status-pending">â³</span>';

      let noteClass = 'note-pending', noteText = '--';
      if (item.note === "ABS" || item.absent) { noteText = 'ABS'; noteClass = 'note-absent'; }
      else if (item.note === "NN" || item.nonNote) { noteText = 'NN'; noteClass = 'note-nn'; }
      else if (item.note !== null && !isNaN(item.note)) {
        noteText = parseFloat(item.note).toFixed(1);
        if (item.note >= 16) noteClass = 'note-excellent';
        else if (item.note >= 12) noteClass = 'note-good';
        else if (item.note >= 10) noteClass = 'note-average';
        else noteClass = 'note-poor';
      }

      return `<div class="eval-card">
        <div class="eval-header">
          <div>
            <div class="eval-title">${escapeHTML(item.titre)}</div>
            <div class="eval-meta"><span class="eval-date">ğŸ“… ${dateStr}</span>${statusBadge}</div>
          </div>
          <div class="eval-note ${noteClass}">${noteText}</div>
        </div>
        <button class="btn-view" onclick="ouvrirDetail('${item.id}')" ${!item.estCorrige ? 'disabled' : ''}>ğŸ‘ï¸ ${item.estCorrige ? 'Voir ma copie' : 'En attente...'}</button>
      </div>`;
    }).join('');
  }

  async function chargerSuivi() {
    if (!currentUserCode) return;
    try {
      const suiviRef = collection(db, "resultats", currentUserCode, "suivi");
      const suiviSnap = await getDocs(suiviRef);
      allSuivis = [];
      suiviSnap.forEach(d => { allSuivis.push({ id: d.id, ...d.data() }); });

      allSuivis.sort((a, b) => {
        const dateA = a.date + ' ' + (a.heure || '00:00');
        const dateB = b.date + ' ' + (b.heure || '00:00');
        return dateB.localeCompare(dateA);
      });

      afficherSuivi();
      calculerPosture();
    } catch (error) {
      console.error("Erreur suivi:", error);
    }
  }

  function afficherSuivi() {
    const container = document.getElementById('suiviContent');
    if (allSuivis.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Pas encore de suivi</div></div>`;
      return;
    }

    const seancesPresent = allSuivis.filter(s => !s.absent);
    const nbTotal = allSuivis.length, nbPresent = seancesPresent.length;
    const tauxPresence = nbTotal > 0 ? Math.round((nbPresent / nbTotal) * 100) : 0;
    const moyenne = calculerMoyenneSuivi();
    const tendances = calculerTendances();

    let moyenneIcon = moyenne >= 15 ? 'â­' : moyenne >= 12 ? 'ğŸ‘' : 'ğŸ“ˆ';
    let presenceColor = tauxPresence >= 85 ? '#16a34a' : tauxPresence >= 70 ? '#f59e0b' : '#dc2626';

    let html = `<div class="suivi-header">
      <div class="suivi-stats-row">
        <div class="suivi-moyenne">${moyenneIcon} ${moyenne}/20</div>
        <div class="suivi-presence" style="color: ${presenceColor};">ğŸ“… ${tauxPresence}%</div>
      </div>
      <div class="suivi-label">Moyenne â€¢ ${nbPresent}/${nbTotal} sÃ©ances</div>
    </div>

    <div class="tendances-grid">
      <div class="tendance-card"><div class="tendance-icon">ğŸ“</div><div class="tendance-label">Travail</div><div class="tendance-value">${tendances.travail}%</div></div>
      <div class="tendance-card"><div class="tendance-icon">ğŸ—£ï¸</div><div class="tendance-label">Oral</div><div class="tendance-value">${tendances.oral}%</div></div>
      <div class="tendance-card"><div class="tendance-icon">ğŸ§ </div><div class="tendance-label">Attention</div><div class="tendance-value">${tendances.attention}%</div></div>
      <div class="tendance-card"><div class="tendance-icon">ğŸ“</div><div class="tendance-label">MatÃ©riel</div><div class="tendance-value">${tendances.porteVue}%</div></div>
    </div>

    <h4 style="margin-bottom: 10px; color: #1e293b; font-size: 0.95em;">ğŸ“… Historique</h4>`;

    allSuivis.forEach((s, idx) => {
      const dateFormatted = formatDateSuivi(s.date);
      if (s.absent) {
        html += `<div class="seance-card seance-absent">
          <div class="seance-header">
            <div class="seance-info">
              <div class="seance-date">${dateFormatted}</div>
              <div class="seance-module">${escapeHTML(s.module || '')}</div>
            </div>
            <div class="seance-note"><span class="seance-note-value absent">ABS</span><span class="seance-note-icon">ğŸš«</span></div>
          </div>
        </div>`;
      } else {
        const noteIcon = getNoteIconSuivi(s.noteSur20), noteClass = getNoteClassSuivi(s.noteSur20);
        html += `<div class="seance-card">
          <div class="seance-header" onclick="toggleSeanceDetail(${idx})">
            <div class="seance-info">
              <div class="seance-date">${dateFormatted}</div>
              <div class="seance-module">${escapeHTML(s.module || '')}</div>
            </div>
            <div class="seance-note">
              <span class="seance-note-value ${noteClass}">${s.noteSur20}/20</span>
              <span class="seance-note-icon">${noteIcon}</span>
            </div>
          </div>
          <div class="seance-detail" id="seanceDetail${idx}">${renderSeanceDetail(s)}</div>
        </div>`;
      }
    });

    container.innerHTML = html;
  }

  function renderSeanceDetail(s) {
    let html = '';
    const travailMap = {
      'tresbien': { label: 'âœ“âœ“ TrÃ¨s bien', cls: 'good' },
      'fait': { label: 'âœ“ Fait', cls: 'good' },
      'partiel': { label: 'âš ï¸ Partiel', cls: 'medium' },
      'insuffisant': { label: 'âŒ Non fait', cls: 'bad' }
    };
    const attentionMap = {
      'bonne': { label: 'ğŸ˜Š Bonne', cls: 'good' },
      'moyenne': { label: 'ğŸ˜ Moyenne', cls: 'medium' },
      'insuffisante': { label: 'ğŸ˜• Insuffisante', cls: 'bad' }
    };
    const pvMap = {
      'ok': { label: 'âœ… OK', cls: 'good' },
      'oubli': { label: 'âŒ OubliÃ©', cls: 'bad' }
    };

    if (s.travail && travailMap[s.travail]) html += `<div class="detail-row"><span class="detail-label">ğŸ“ Travail</span><span class="detail-value ${travailMap[s.travail].cls}">${travailMap[s.travail].label}</span></div>`;
    if (s.attention && attentionMap[s.attention]) html += `<div class="detail-row"><span class="detail-label">ğŸ§  Attention</span><span class="detail-value ${attentionMap[s.attention].cls}">${attentionMap[s.attention].label}</span></div>`;
    if (s.porteVue && pvMap[s.porteVue]) html += `<div class="detail-row"><span class="detail-label">ğŸ“ MatÃ©riel</span><span class="detail-value ${pvMap[s.porteVue].cls}">${pvMap[s.porteVue].label}</span></div>`;
    if (s.commentaire) html += `<div class="seance-comment">ğŸ’¬ ${escapeHTML(s.commentaire)}</div>`;

    return html || '<div style="color:#94a3b8;font-size:0.85em;">Pas de dÃ©tails</div>';
  }

  window.toggleSeanceDetail = function(idx) {
    const el = document.getElementById('seanceDetail' + idx);
    if (el) el.classList.toggle('open');
  };

  function calculerMoyenneSuivi() {
    const seancesAvecNote = allSuivis.filter(s => !s.absent && s.noteSur20 !== null && s.noteSur20 !== undefined);
    if (seancesAvecNote.length === 0) return 0;
    return Math.round((seancesAvecNote.reduce((acc, s) => acc + (s.noteSur20 || 0), 0) / seancesAvecNote.length) * 10) / 10;
  }

  function calculerTendances() {
    const result = { travail: 0, oral: 0, attention: 0, porteVue: 0 };
    const seancesPresent = allSuivis.filter(s => !s.absent);
    if (seancesPresent.length === 0) return result;

    let travailBon = 0, travailTotal = 0;
    seancesPresent.forEach(s => {
      if (s.travail && s.travail !== 'ne') {
        travailTotal++;
        if (s.travail === 'tresbien' || s.travail === 'fait') travailBon++;
      }
    });
    if (travailTotal > 0) result.travail = Math.round((travailBon / travailTotal) * 100);

    let oralTotal = 0, oralCount = 0;
    seancesPresent.forEach(s => {
      if (s.oral !== undefined && s.oral !== null && s.oral !== 'ne') {
        const val = parseInt(s.oral);
        if (!isNaN(val)) { oralCount++; oralTotal += val; }
      }
    });
    if (oralCount > 0) result.oral = Math.round((oralTotal / oralCount / 4) * 100);

    let attentionBon = 0, attentionTotal = 0;
    seancesPresent.forEach(s => {
      if (s.attention && s.attention !== 'ne') {
        attentionTotal++;
        if (s.attention === 'bonne') attentionBon++;
      }
    });
    if (attentionTotal > 0) result.attention = Math.round((attentionBon / attentionTotal) * 100);

    let pvBon = 0, pvTotal = 0;
    seancesPresent.forEach(s => {
      if (s.porteVue && s.porteVue !== 'ne') {
        pvTotal++;
        if (s.porteVue === 'ok') pvBon++;
      }
    });
    if (pvTotal > 0) result.porteVue = Math.round((pvBon / pvTotal) * 100);

    return result;
  }

  function getNoteIconSuivi(note) { if (note >= 18) return 'ğŸ†'; if (note >= 15) return 'â­'; if (note >= 12) return 'ğŸ‘'; if (note >= 10) return 'ğŸ’ª'; return 'ğŸ“ˆ'; }
  function getNoteClassSuivi(note) { if (note >= 18) return 'note-excellent-suivi'; if (note >= 15) return 'note-good-suivi'; if (note >= 12) return 'note-average-suivi'; return 'note-poor-suivi'; }
  function formatDateSuivi(dateStr) { if (!dateStr) return '--'; const d = new Date(dateStr); return d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }); }

  function calculerPosture() {
    const section = document.getElementById('postureSection');
    if (!section) return;

    const suivisTries = [...allSuivis].sort((a, b) => {
      const dateA = a.date + ' ' + (a.heure || '00:00');
      const dateB = b.date + ' ' + (b.heure || '00:00');
      return dateA.localeCompare(dateB);
    });

    function estSeanceParfaite(s) {
      if (s.absent) return false;
      if (s.bavardage && s.bavardage !== 'aucun') return false;
      if (s.telephone && s.telephone !== 'ok') return false;
      if (s.noteSur20 === null || s.noteSur20 === undefined || s.noteSur20 < 12) return false;
      return true;
    }

    let serieRecord = 0, tempSerie = 0;
    for (const s of suivisTries) {
      if (estSeanceParfaite(s)) { tempSerie++; if (tempSerie > serieRecord) serieRecord = tempSerie; }
      else { tempSerie = 0; }
    }

    let serieActuelle = 0;
    for (let i = suivisTries.length - 1; i >= 0; i--) {
      if (estSeanceParfaite(suivisTries[i])) serieActuelle++;
      else break;
    }

    let etoilesHtml = '';
    for (let i = 0; i < 5; i++) {
      etoilesHtml += i < serieActuelle
        ? `<button class="etoile-btn" data-star="${i + 1}">â­</button>`
        : `<button class="etoile-btn empty" data-star="${i + 1}">â˜†</button>`;
    }

    document.getElementById('postureEtoiles').innerHTML = etoilesHtml;
    document.getElementById('postureProgressBar').style.width = Math.min(100, (serieActuelle / 5) * 100) + '%';
    document.getElementById('serieActuelle').textContent = serieActuelle;
    document.getElementById('serieRecord').textContent = serieRecord;

    const messageEl = document.getElementById('postureMessage');
    const badgeEl = document.getElementById('pronoteBadge');

    if (serieActuelle >= 5) {
      section.classList.add('achieved');
      messageEl.textContent = 'ğŸ‰ BRAVO ! Objectif atteint !';
      badgeEl.innerHTML = 'ğŸ† DÃ‰BLOQUÃ‰ !';
    } else {
      section.classList.remove('achieved');
      const restant = 5 - serieActuelle;
      messageEl.textContent = serieActuelle === 0 ? 'Commence ta sÃ©rie ! ğŸ†'
        : serieActuelle === 4 ? 'Plus qu\'une sÃ©ance ! ğŸ†'
        : `Encore ${restant} sÃ©ance${restant > 1 ? 's' : ''} ! ğŸ†`;
    }
  }

  window.selectHumeur = async function(humeurKey, emoji) {
    document.querySelectorAll('.humeur-btn').forEach(btn => btn.classList.remove('selected'));
    document.querySelector(`.humeur-btn[data-humeur="${humeurKey}"]`)?.classList.add('selected');

    if (currentUserCode) {
      try {
        const today = new Date().toISOString().split('T')[0];
        await setDoc(
          doc(db, 'resultats', currentUserCode, 'emotions', today),
          { emotion: humeurKey, emoji: emoji, date: today, timestamp: serverTimestamp() }
        );
      } catch (error) {
        console.error('Erreur humeur:', error);
      }
    }
  };

  async function chargerHumeurDuJour() {
    if (!currentUserCode) return;
    try {
      const today = new Date().toISOString().split('T')[0];
      const humeurSnap = await getDoc(doc(db, 'resultats', currentUserCode, 'emotions', today));
      if (humeurSnap.exists()) {
        document.querySelector(`.humeur-btn[data-humeur="${humeurSnap.data().emotion}"]`)?.classList.add('selected');
      }
    } catch (error) {
      console.error('Erreur chargement humeur:', error);
    }
  }

  window.updateSliderEmoji = function(sliderId, emojiId) {
    const emojis = ['ğŸ˜¢', 'ğŸ˜”', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];
    document.getElementById(emojiId).textContent = emojis[parseInt(document.getElementById(sliderId).value) - 1];
  };

  window.selectBilanRadio = function(inputId, value, btn) {
    btn.parentElement.querySelectorAll('.bilan-radio-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById(inputId).value = value;
  };

  function getSemaineActuelle() {
    const today = new Date(), dayOfWeek = today.getDay();
    const monday = new Date(today); monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
    const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
    const options = { day: 'numeric', month: 'long' };
    return {
      display: `Semaine du ${monday.toLocaleDateString('fr-FR', options)} au ${sunday.toLocaleDateString('fr-FR', options)}`,
      key: monday.toISOString().split('T')[0]
    };
  }

  function initBilanSemaine() {
    const semaine = getSemaineActuelle();
    document.getElementById('bilanSemaineDates').textContent = semaine.display;
    chargerBilanSemaine(semaine.key);
  }

  async function chargerBilanSemaine(semaineKey) {
    if (!currentUserCode) return;
    try {
      const bilanSnap = await getDoc(doc(db, 'resultats', currentUserCode, 'bilans', semaineKey));
      if (bilanSnap.exists()) {
        const data = bilanSnap.data();
        if (data.concentration) { document.getElementById('bilanConcentration').value = data.concentration; updateSliderEmoji('bilanConcentration', 'bilanConcentrationEmoji'); }
        if (data.engagement) { document.getElementById('bilanEngagement').value = data.engagement; updateSliderEmoji('bilanEngagement', 'bilanEngagementEmoji'); }
        if (data.emotions) { document.getElementById('bilanEmotions').value = data.emotions; updateSliderEmoji('bilanEmotions', 'bilanEmotionsEmoji'); }
        if (data.relations) { document.getElementById('bilanRelations').value = data.relations; updateSliderEmoji('bilanRelations', 'bilanRelationsEmoji'); }
        if (data.fierte) document.getElementById('bilanFierte').value = data.fierte;
      }
      chargerBilanHistorique();
    } catch (error) {
      console.error('Erreur bilan:', error);
    }
  }

  window.sauvegarderBilan = async function() {
    if (!currentUserCode) return;
    const semaine = getSemaineActuelle();
    try {
      await setDoc(doc(db, 'resultats', currentUserCode, 'bilans', semaine.key), {
        semaine: semaine.key,
        semaineDisplay: semaine.display,
        concentration: parseInt(document.getElementById('bilanConcentration').value),
        engagement: parseInt(document.getElementById('bilanEngagement').value),
        emotions: parseInt(document.getElementById('bilanEmotions').value),
        relations: parseInt(document.getElementById('bilanRelations').value),
        gestion: document.getElementById('bilanGestion').value,
        conflit: document.getElementById('bilanConflit').value,
        global: document.getElementById('bilanGlobal').value,
        fierte: document.getElementById('bilanFierte').value.trim(),
        timestamp: serverTimestamp()
      });

      document.getElementById('bilanMessage').classList.add('visible');
      setTimeout(() => document.getElementById('bilanMessage').classList.remove('visible'), 3000);
      chargerBilanHistorique();
    } catch (error) {
      console.error('Erreur sauvegarde:', error);
      alert('Erreur');
    }
  };

  async function chargerBilanHistorique() {
    if (!currentUserCode) return;
    try {
      const bilansSnap = await getDocs(collection(db, 'resultats', currentUserCode, 'bilans'));
      const bilans = [];
      bilansSnap.forEach(d => bilans.push({ id: d.id, ...d.data() }));

      const semaineActuelle = getSemaineActuelle().key;
      const anciensBilans = bilans
        .filter(b => b.semaine !== semaineActuelle)
        .sort((a, b) => b.semaine.localeCompare(a.semaine))
        .slice(0, 4);

      const historiqueSection = document.getElementById('bilanHistorique');
      const historiqueEl = document.getElementById('bilanHistoriqueList');

      if (anciensBilans.length > 0) {
        historiqueSection.style.display = 'block';
        const globalEmojis = { 'super': 'ğŸ¤©', 'bien': 'ğŸ˜Š', 'moyen': 'ğŸ˜', 'difficile': 'ğŸ˜”' };
        historiqueEl.innerHTML = anciensBilans.map(b => `
          <div class="bilan-historique-item">
            <div class="bilan-historique-semaine">${escapeHTML(b.semaineDisplay || b.semaine)}</div>
            <div class="bilan-historique-resume">
              <span>${globalEmojis[b.global] || '?'}</span>
              <span>ğŸ¯ ${b.concentration}/5</span>
              <span>ğŸ’ª ${b.engagement}/5</span>
            </div>
          </div>
        `).join('');
      } else {
        historiqueSection.style.display = 'none';
      }
    } catch (error) {
      console.error('Erreur historique:', error);
    }
  }

  function afficherCours() {
    const container = document.getElementById('coursContent');
    const suivisAvecCours = allSuivis.filter(s => s.coursDistrib && s.coursDistrib !== 'aucun');

    if (suivisAvecCours.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“„</div><div class="empty-text">Pas encore de cours</div></div>`;
      return;
    }

    const parModule = {};
    suivisAvecCours.forEach(s => {
      const moduleKey = s.module || 'Inconnu';
      if (!parModule[moduleKey]) parModule[moduleKey] = { module: s.module, moduleTitre: s.moduleTitre, seances: [] };
      parModule[moduleKey].seances.push({
        type: s.coursDistrib,
        date: s.date,
        recu: !(s.absent && s.coursRecu === false)
      });
    });

    let coursManquants = 0;
    Object.values(parModule).forEach(m => m.seances.forEach(s => { if (!s.recu) coursManquants++; }));

    const coursLabels = { 'seance1': 'SÃ©ance 1', 'seance2': 'SÃ©ance 2', 'seance3': 'SÃ©ance 3', 'seance4': 'SÃ©ance 4', 'complet': 'Cours complet' };

    let html = '';
    if (coursManquants > 0) {
      html += `<div class="cours-alerte"><span class="cours-alerte-icon">âš ï¸</span><span class="cours-alerte-text">${coursManquants} cours Ã  rÃ©cupÃ©rer</span></div>`;
    }

    Object.values(parModule).forEach(m => {
      html += `<div class="cours-module-card">
        <div class="cours-module-header">
          <div class="module-code">${escapeHTML(m.module || 'Module')}</div>
          <div class="module-titre">${escapeHTML(m.moduleTitre || '')}</div>
        </div>
        <div class="cours-seances-list">`;

      m.seances
        .sort((a, b) => a.date.localeCompare(b.date))
        .forEach(s => {
          const label = coursLabels[s.type] || s.type;
          const icon = s.type === 'complet' ? 'ğŸ“š' : 'ğŸ“„';
          html += `<div class="cours-seance-row">
            <div class="cours-seance-info">
              <span class="cours-seance-icon">${icon}</span>
              <div>
                <div class="cours-seance-nom">${escapeHTML(label)}</div>
                <div class="cours-seance-date">${formatDateSuivi(s.date)}</div>
              </div>
            </div>
            <span class="cours-seance-status ${s.recu ? 'recu' : 'manquant'}">${s.recu ? 'âœ… ReÃ§u' : 'âŒ Ã€ rÃ©cup'}</span>
          </div>`;
        });

      html += `</div></div>`;
    });

    container.innerHTML = html;
  }

  function extractAllQuestions(blueprint) {
    const questions = [];
    if (!blueprint || !blueprint.content) return questions;

    function walk(items) {
      if (!Array.isArray(items)) return;
      items.forEach(item => {
        if (item.type === 'question') questions.push(item);
        if (item.content) walk(item.content);
        if (item.children) walk(item.children);
        if (item.items) walk(item.items);
      });
    }

    walk(blueprint.content);
    return questions;
  }

  function matchReponseEleve(qid, label, reponses) {
    if (!reponses) return null;
    if (reponses[qid] !== undefined) return reponses[qid];

    if (label) {
      if (reponses['Q' + label] !== undefined) return reponses['Q' + label];
      if (reponses[label] !== undefined) return reponses[label];
    }

    for (const suffix of ['_gravite', '_decision', '_matrice', '_trous']) {
      if (reponses[qid + suffix] !== undefined) return reponses[qid + suffix];
    }

    const partials = Object.entries(reponses).filter(([key]) => key.startsWith(qid + '_'));
    if (partials.length === 1) return partials[0][1];
    if (partials.length > 1) {
      return partials.map(([k, v]) => {
        const sfx = k.replace(qid + '_', '');
        return `[${sfx}] ${Array.isArray(v) ? v.join(', ') : v}`;
      });
    }
    return null;
  }

  function formatReponseDisplay(reponse) {
    if (reponse === null || reponse === undefined) {
      return '<span style="color:#94a3b8; font-style:italic;">Non rÃ©pondu</span>';
    }

    if (Array.isArray(reponse)) {
      const hasArrows = reponse.some(r => typeof r === 'string' && r.includes('â†’'));
      if (hasArrows) {
        return '<div class="matching-display">' + reponse.map(r => {
          if (typeof r === 'string' && r.includes('â†’')) {
            const parts = r.split('â†’').map(p => p.trim());
            const left = escapeHTML(parts[0] ?? '');
            const right = escapeHTML(parts.slice(1).join(' â†’ ') ?? '');
            return `<div class="matching-row"><span>${left}</span><span class="matching-arrow">â†’</span><span>${right}</span></div>`;
          }
          return `<div class="matching-row"><span>${escapeHTML(r)}</span></div>`;
        }).join('') + '</div>';
      }
      return reponse.map(r => `â€¢ ${escapeHTML(r)}`).join('<br>');
    }

    if (typeof reponse === 'string') {
      return escapeHTML(reponse).replace(/\n/g, '<br>');
    }

    return escapeHTML(reponse);
  }

  function aggregateCompetences(bpQuestions, evalQuestions, evalCompetences) {
    const compMap = {};

    bpQuestions.forEach(bpQ => {
      const comp = bpQ.competence;
      if (!comp) return;

      const evalQ = (evalQuestions && typeof evalQuestions === 'object') ? (evalQuestions[bpQ.qid] || {}) : {};
      const niveau = evalQ.level || 'NT';
      const bareme = parseFloat(bpQ.bareme) || 0;
      const points = parseFloat(evalQ.points) || 0;

      if (!compMap[comp]) compMap[comp] = { totalBareme: 0, totalPoints: 0, niveaux: [], questions: [] };
      compMap[comp].totalBareme += bareme;
      compMap[comp].totalPoints += points;
      compMap[comp].niveaux.push(niveau);
      compMap[comp].questions.push(bpQ.qid);
    });

    if (evalCompetences && typeof evalCompetences === 'object') {
      Object.entries(evalCompetences).forEach(([comp, data]) => {
        if (!compMap[comp]) compMap[comp] = { totalBareme: 0, totalPoints: 0, niveaux: [], questions: [] };
        if (typeof data === 'object' && data.points !== undefined) {
          compMap[comp].totalPoints = parseFloat(data.points) || compMap[comp].totalPoints;
          compMap[comp].totalBareme = parseFloat(data.bareme) || compMap[comp].totalBareme;
          if (data.niveau) compMap[comp].niveauGlobal = data.niveau;
        }
      });
    }

    const niveauOrder = { 'M': 3, 'A': 2, 'I': 1, 'NT': 0 };
    Object.values(compMap).forEach(c => {
      if (!c.niveauGlobal && c.niveaux.length > 0) {
        const avg = c.niveaux.reduce((sum, n) => sum + (niveauOrder[n] || 0), 0) / c.niveaux.length;
        if (avg >= 2.5) c.niveauGlobal = 'M';
        else if (avg >= 1.5) c.niveauGlobal = 'A';
        else if (avg >= 0.5) c.niveauGlobal = 'I';
        else c.niveauGlobal = 'NT';
      }
    });

    return compMap;
  }

  const NIVEAU_CONFIG = {
    M:  { label: 'MaÃ®trisÃ©',   short: 'M',  emoji: 'ğŸŸ¢', css: 'badge-M',  barPercent: 100 },
    A:  { label: 'Acceptable', short: 'A',  emoji: 'ğŸ”µ', css: 'badge-A',  barPercent: 66 },
    I:  { label: 'Insuffisant',short: 'I',  emoji: 'ğŸŸ ', css: 'badge-I',  barPercent: 33 },
    NT: { label: 'Non traitÃ©', short: 'NT', emoji: 'âšª', css: 'badge-NT', barPercent: 5 }
  };

  window.ouvrirDetail = async function(evalId) {
    const evaluation = allEvaluations.find(e => e.id === evalId);
    if (!evaluation || !evaluation.estCorrige) return;

    let blueprint = null;
    try {
      const resp = await fetch(`https://preventionsanteenvironnement.github.io/CockpitPSE/${evaluation.devoirId}_blueprint.json?ts=${Date.now()}`, { cache: "no-store" });
      if (resp.ok) blueprint = await resp.json();
    } catch (e) {
      console.warn("Blueprint non trouvÃ©:", e);
    }

    const bpQuestions = blueprint ? extractAllQuestions(blueprint) : [];

    const isNN = evaluation.note === "NN" || evaluation.nonNote;
    const isABS = evaluation.note === "ABS";
    const hasNote = evaluation.note !== null && !isNaN(evaluation.note) && !isNN && !isABS;
    const noteVal = hasNote ? parseFloat(evaluation.note) : null;
    const noteDisplay = isNN ? "Non notÃ©" : isABS ? "Absent" : hasNote ? noteVal.toFixed(1) + "/20" : "--";

    let noteClass = 'nn';
    if (hasNote) {
      if (noteVal >= 16) noteClass = 'excellent';
      else if (noteVal >= 12) noteClass = 'good';
      else if (noteVal >= 10) noteClass = 'average';
      else noteClass = 'poor';
    }

    document.getElementById('modalTitle').textContent = evaluation.titre;
    let html = '';

    html += `<div class="modal-note-banner ${noteClass}">
      <div class="modal-note-big">${escapeHTML(noteDisplay)}</div>
      ${hasNote ? `<div class="modal-note-bar"><div class="modal-note-bar-fill" style="width:${Math.min(100, (noteVal / 20) * 100)}%"></div></div>` : ''}
    </div>`;

    if (evaluation.appreciation) {
      html += `<div class="appreciation-block">
        <div class="appreciation-title">ApprÃ©ciation</div>
        <div class="appreciation-text">${escapeHTML(evaluation.appreciation).replace(/\n/g, '<br>')}</div>
      </div>`;
    }

    if (bpQuestions.length > 0) {
      const compMap = aggregateCompetences(bpQuestions, evaluation.questions || {}, evaluation.competences);
      const compEntries = Object.entries(compMap).sort((a, b) => a[0].localeCompare(b[0]));
      if (compEntries.length > 0) {
        html += `<div class="comp-summary"><div class="comp-summary-title">ğŸ¯ Mes compÃ©tences</div>`;
        compEntries.forEach(([comp, data]) => {
          const niv = data.niveauGlobal || 'NT';
          const cfg = NIVEAU_CONFIG[niv] || NIVEAU_CONFIG.NT;
          const pointsStr = data.totalBareme > 0 ? `${data.totalPoints}/${data.totalBareme}` : '';
          html += `<div class="comp-row">
            <span class="comp-name">${escapeHTML(comp)}</span>
            <div class="comp-bar-wrap"><div class="comp-bar-fill level-${niv}" style="width:${cfg.barPercent}%"></div></div>
            <span class="comp-points">${escapeHTML(pointsStr)}</span>
            <span class="comp-level-badge ${cfg.css}">${cfg.emoji} ${cfg.short}</span>
          </div>`;
        });
        html += `</div>`;
      }
    }

    if (bpQuestions.length > 0) {
      const questionsAvecEval = bpQuestions.map((bpQ, idx) => {
        const evalQ = (evaluation.questions || {})[bpQ.qid] || {};
        return {
          bpQ, idx, evalQ,
          niveau: evalQ.level || 'NT',
          commentaire: evalQ.comment || '',
          reponse: matchReponseEleve(bpQ.qid, bpQ.label, evaluation.reponses),
          correction: bpQ.reponseAttendue || ''
        };
      });

      const erreurs = questionsAvecEval.filter(q => q.niveau === 'I' || q.niveau === 'NT');
      const reussites = questionsAvecEval.filter(q => q.niveau === 'M' || q.niveau === 'A');

      if (erreurs.length > 0) {
        html += `<div class="modal-section-header section-errors">âŒ Ã€ revoir <span class="section-count">${erreurs.length}</span></div>`;
        erreurs.forEach(q => {
          const cfg = NIVEAU_CONFIG[q.niveau] || NIVEAU_CONFIG.NT;
          html += `<div class="question-card-grid card-error">
            <div class="question-header-grid">
              <div class="question-number-grid">Q${escapeHTML(q.bpQ.label || (q.idx + 1))}</div>
              ${q.bpQ.competence ? `<div class="question-comp-grid">${escapeHTML(q.bpQ.competence)}</div>` : ''}
              <div class="question-level-grid ${cfg.css}">${cfg.emoji} ${escapeHTML(cfg.label)}</div>
            </div>
            <div class="question-text-grid">${escapeHTML(q.bpQ.questionText || '')}</div>
            <div class="answer-section-grid"><div class="section-label-grid">âœï¸ Ta rÃ©ponse</div><div class="section-content-grid">${formatReponseDisplay(q.reponse)}</div></div>
            ${q.correction ? `<div class="correction-section-grid"><div class="section-label-grid">ğŸ¯ Correction</div><div class="section-content-grid">${escapeHTML(q.correction).replace(/\n/g, '<br>')}</div></div>` : ''}
            ${q.commentaire ? `<div class="comment-section-grid"><div class="section-label-grid">ğŸ’¬ Commentaire</div><div class="section-content-grid">${escapeHTML(q.commentaire).replace(/\n/g, '<br>')}</div></div>` : ''}
          </div>`;
        });
      }

      if (reussites.length > 0) {
        html += `<div class="modal-section-header section-success">âœ… Acquis <span class="section-count">${reussites.length}</span></div>`;
        reussites.forEach((q, i) => {
          const uniqueId = `compact_${evalId}_${i}`;
          const cfg = NIVEAU_CONFIG[q.niveau] || NIVEAU_CONFIG.NT;
          const qt = q.bpQ.questionText || '';
          const shortText = qt.length > 50 ? qt.substring(0, 50) + '...' : qt;

          html += `<div class="question-compact" onclick="toggleCompactDetail('${uniqueId}')">
            <div class="qc-left">
              <span class="qc-num">Q${escapeHTML(q.bpQ.label || (q.idx + 1))}</span>
              <span class="qc-text">${escapeHTML(shortText)}</span>
            </div>
            <span class="qc-badge comp-level-badge ${cfg.css}">${cfg.emoji} ${cfg.short}</span>
          </div>`;

          html += `<div class="question-compact-detail" id="${uniqueId}">
            <div class="answer-section-grid"><div class="section-label-grid">âœï¸ Ta rÃ©ponse</div><div class="section-content-grid">${formatReponseDisplay(q.reponse)}</div></div>
            ${q.correction && q.correction.length < 200 ? `<div class="correction-section-grid"><div class="section-label-grid">ğŸ¯ Correction</div><div class="section-content-grid">${escapeHTML(q.correction).replace(/\n/g, '<br>')}</div></div>` : ''}
            ${q.commentaire ? `<div class="comment-section-grid"><div class="section-label-grid">ğŸ’¬ Commentaire</div><div class="section-content-grid">${escapeHTML(q.commentaire).replace(/\n/g, '<br>')}</div></div>` : ''}
          </div>`;
        });
      }
    } else if (!blueprint) {
      html += `<div class="no-blueprint-info">ğŸ“„ Le dÃ©tail question par question n'est pas encore disponible pour ce devoir.</div>`;
      if (evaluation.competences && Object.keys(evaluation.competences).length > 0) {
        html += `<div class="comp-summary"><div class="comp-summary-title">ğŸ¯ CompÃ©tences Ã©valuÃ©es</div>`;
        Object.entries(evaluation.competences).forEach(([comp, data]) => {
          const niv = typeof data === 'object' ? (data.niveau || 'NT') : 'NT';
          const cfg = NIVEAU_CONFIG[niv] || NIVEAU_CONFIG.NT;
          html += `<div class="comp-row">
            <span class="comp-name">${escapeHTML(comp)}</span>
            <div class="comp-bar-wrap"><div class="comp-bar-fill level-${niv}" style="width:${cfg.barPercent}%"></div></div>
            <span class="comp-level-badge ${cfg.css}">${cfg.emoji} ${cfg.short}</span>
          </div>`;
        });
        html += `</div>`;
      }
    }

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalDetail').classList.add('active');
  };

  window.toggleCompactDetail = function(id) {
    const el = document.getElementById(id);
    if (el) el.classList.toggle('open');
  };

  window.fermerModal = function() {
    document.getElementById('modalDetail').classList.remove('active');
  };

  window.switchTab = function(tabName, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

    btn.classList.add('active');
    document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');

    if (tabName === 'cours') afficherCours();
  };

  window.addEventListener('DOMContentLoaded', () => {
    const savedCode = localStorage.getItem('pse_user_code');
    if (savedCode) { document.getElementById('codeInput').value = savedCode; connexion(); }
    document.getElementById('codeInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') connexion(); });
  });

  document.getElementById('modalDetail').addEventListener('click', (e) => {
    if (e.target.id === 'modalDetail') fermerModal();
  });
</script>
</body>
</html>
