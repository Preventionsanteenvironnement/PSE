<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suivi de S√©ance - PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data_modules.js"></script>
    <script src="data_eleves.js"></script>
    
    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --primary: #3b82f6;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --border: #e2e8f0;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 100px;
        }
        
        .container { max-width: 500px; margin: 0 auto; }
        
        /* === HEADER === */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 1.4em;
            color: var(--primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .header .date {
            color: var(--muted);
            font-size: 0.85em;
        }
        
        /* === CARDS === */
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        }
        .card-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* === FORM === */
        label.field-label {
            display: block;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            margin-bottom: 15px;
            background: white;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }
        select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* === CHECKBOXES CRIT√àRES === */
        .criteres-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .critere-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .critere-item:has(input:checked) {
            background: #eff6ff;
            border-color: var(--primary);
        }
        .critere-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }
        .critere-item span {
            font-size: 0.9em;
            font-weight: 500;
        }
        
        /* === BOUTONS === */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
        }
        .btn-secondary {
            background: #e2e8f0;
            color: var(--text);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* === √âL√àVE HEADER === */
        .eleve-banner {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .eleve-code {
            font-size: 2.5em;
            font-weight: 800;
            letter-spacing: 2px;
        }
        .eleve-info {
            text-align: right;
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        /* === SECTIONS SAISIE === */
        .section-saisie {
            margin-bottom: 20px;
        }
        .section-saisie h3 {
            font-size: 0.85em;
            color: var(--muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* === OPTIONS BOUTONS === */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .options-grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        .options-grid.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        .options-grid.cols-5 {
            grid-template-columns: repeat(5, 1fr);
        }
        .options-grid.cols-6 {
            grid-template-columns: repeat(6, 1fr);
        }
        
        .opt-btn {
            padding: 16px 8px;
            border: 3px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .opt-btn:active {
            transform: scale(0.95);
        }
        .opt-btn .emoji {
            font-size: 1.6em;
            display: block;
            margin-bottom: 4px;
        }
        .opt-btn .label {
            font-size: 0.7em;
            font-weight: 600;
            color: var(--muted);
        }
        .opt-btn.selected {
            border-color: var(--success);
            background: #f0fdf4;
            transform: scale(1.02);
        }
        .opt-btn.selected .label {
            color: var(--success);
        }
        
        /* Couleurs sp√©cifiques */
        .opt-btn[data-value="tresbien"].selected,
        .opt-btn[data-value="bonne"].selected,
        .opt-btn[data-value="ok"].selected,
        .opt-btn[data-value="a_jour"].selected,
        .opt-btn[data-value="oui"].selected,
        .opt-btn[data-value="4"].selected,
        .opt-btn[data-value="3"].selected { 
            border-color: #16a34a; 
            background: #f0fdf4; 
        }
        .opt-btn[data-value="fait"].selected,
        .opt-btn[data-value="2"].selected { 
            border-color: #22c55e; 
            background: #f0fdf4; 
        }
        .opt-btn[data-value="partiel"].selected,
        .opt-btn[data-value="moyenne"].selected,
        .opt-btn[data-value="parfois"].selected,
        .opt-btn[data-value="incomplet"].selected,
        .opt-btn[data-value="1"].selected { 
            border-color: #f59e0b; 
            background: #fffbeb; 
        }
        .opt-btn[data-value="insuffisant"].selected,
        .opt-btn[data-value="insuffisante"].selected,
        .opt-btn[data-value="oubli"].selected,
        .opt-btn[data-value="pas_a_jour"].selected,
        .opt-btn[data-value="non"].selected,
        .opt-btn[data-value="0"].selected { 
            border-color: #dc2626; 
            background: #fef2f2; 
        }
        .opt-btn[data-value="ne"].selected {
            border-color: #94a3b8;
            background: #f1f5f9;
        }
        .opt-btn[data-value="ne"] .label {
            font-size: 0.65em;
        }
        
        /* === BOUTONS COMPORTEMENT === */
        .opt-btn.good {
            border-color: #bbf7d0;
            background: #f0fdf4;
        }
        .opt-btn.good.selected {
            border-color: #22c55e;
            background: #dcfce7;
            color: #166534;
        }
        .opt-btn.warning {
            border-color: #fde68a;
            background: #fffbeb;
        }
        .opt-btn.warning.selected {
            border-color: #f59e0b;
            background: #fef3c7;
            color: #92400e;
        }
        .opt-btn.danger {
            border-color: #fecaca;
            background: #fef2f2;
        }
        .opt-btn.danger.selected {
            border-color: #ef4444;
            background: #fee2e2;
            color: #dc2626;
        }
        .opt-btn.danger-max {
            border-color: #fca5a5;
            background: #fee2e2;
        }
        .opt-btn.danger-max.selected {
            border-color: #dc2626;
            background: #dc2626;
            color: white;
        }
        
        @media (max-width: 600px) {
            .options-grid.cols-5 {
                grid-template-columns: repeat(3, 1fr);
            }
            .options-grid.cols-6 {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* === NOTE PREVIEW === */
        .note-box {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .note-box .value {
            font-size: 3em;
            font-weight: 800;
            color: var(--success);
        }
        .note-box .label {
            font-size: 0.85em;
            color: var(--muted);
            margin-top: 5px;
        }
        .note-box .note-ajustement {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #e2e8f0;
        }
        .note-box .note-ajustement label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.9em;
            color: var(--muted);
        }
        .note-box .note-ajustement input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
        }
        .note-box .note-ajustement input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.85em;
            margin-top: 8px;
        }
        
        /* === COMMENTAIRES === */
        .comment-section {
            margin-bottom: 20px;
        }
        .comment-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .comment-tag {
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }
        .comment-tag.positif {
            background: #dcfce7;
            color: #166534;
        }
        .comment-tag.encouragement {
            background: #fef3c7;
            color: #92400e;
        }
        .comment-tag.alerte {
            background: #fee2e2;
            color: #991b1b;
        }
        .comment-tag:active {
            transform: scale(0.95);
        }
        
        .comment-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.95em;
            font-family: inherit;
            resize: none;
            min-height: 60px;
        }
        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* === DISTRIBUTION COURS (CHECKBOXES) === */
        .cours-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        .cours-grid.actions {
            grid-template-columns: repeat(3, 1fr);
        }
        .cours-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            color: #475569;
            text-align: center;
        }
        .cours-checkbox:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }
        .cours-checkbox:has(input:checked) {
            border-color: #3b82f6;
            background: #dbeafe;
            color: #1e40af;
        }
        .cours-checkbox.complet:has(input:checked) {
            border-color: #16a34a;
            background: #dcfce7;
            color: #166534;
        }
        .cours-checkbox.action:has(input:checked) {
            border-color: #8b5cf6;
            background: #ede9fe;
            color: #5b21b6;
        }
        .cours-checkbox input[type="checkbox"] {
            display: none;
        }
        .cours-checkbox .icon {
            font-size: 1.3em;
            margin-bottom: 4px;
        }
        
        @media (max-width: 400px) {
            .cours-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* === OBJECTIF === */
        .objectif-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .objectif-box h4 {
            font-size: 0.85em;
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .objectif-precedent {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .objectif-precedent .texte {
            font-weight: 600;
            color: #78350f;
            margin-bottom: 8px;
        }
        .objectif-precedent .validation {
            display: flex;
            gap: 8px;
        }
        .objectif-precedent .validation label {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            background: #f1f5f9;
        }
        .objectif-precedent .validation label:has(input:checked) {
            background: #dcfce7;
            color: #166534;
        }
        .objectif-precedent .validation label.non-atteint:has(input:checked) {
            background: #fee2e2;
            color: #991b1b;
        }
        .objectif-nouveau select {
            width: 100%;
            padding: 10px;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            background: white;
            font-size: 0.9em;
        }
        .objectif-nouveau input[type="text"],
        .objectif-nouveau input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            font-size: 0.9em;
            margin-top: 8px;
        }
        .objectif-nouveau input[type="number"] {
            width: 80px;
            display: inline-block;
        }
        .objectif-duree {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 0.9em;
            color: #92400e;
        }
        
        /* === LISTE √âL√àVES === */
        .eleves-list {
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid var(--border);
            border-radius: 12px;
        }
        .eleve-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .eleve-row:last-child { border-bottom: none; }
        .eleve-row:active { background: #f1f5f9; }
        .eleve-row.current { background: #eff6ff; }
        .eleve-row.done { background: #f0fdf4; }
        .eleve-row .code {
            font-weight: 700;
            font-size: 1.1em;
        }
        .eleve-row .status {
            font-size: 0.9em;
            font-weight: 600;
        }
        .eleve-row .status.done { color: var(--success); }
        .eleve-row .status.pending { color: var(--muted); }
        .eleve-row .status.absent { color: #92400e; }
        .eleve-row.absent { background: #fef3c7; }
        
        /* === ACTIONS === */
        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }
        
        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success);
            color: white;
            padding: 16px 30px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* === √âCRANS === */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* === LOGIN SCREEN === */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }
        .login-icon { font-size: 4em; margin-bottom: 20px; }
        .login-title { font-size: 1.5em; font-weight: 700; margin-bottom: 10px; }
        .login-subtitle { color: var(--muted); margin-bottom: 30px; }
        .btn-google {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            background: linear-gradient(135deg, #4285f4, #3367d6);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            transition: all 0.2s;
        }
        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        .btn-google:active {
            transform: scale(0.98);
        }
        .login-info {
            margin-top: 30px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 12px;
            color: #92400e;
            font-size: 0.85em;
            max-width: 300px;
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 400px) {
            body { padding: 10px; }
            .card { padding: 15px; }
            .eleve-code { font-size: 2em; }
            .opt-btn { padding: 12px 6px; }
            .opt-btn .emoji { font-size: 1.3em; }
            .options-grid { gap: 6px; }
            .note-box .value { font-size: 2.5em; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- √âCRAN 0 : CONNEXION PROF -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="screenLogin" class="screen active">
            <div class="login-screen">
                <div class="login-icon">üîê</div>
                <div class="login-title">Acc√®s Professeur</div>
                <div class="login-subtitle">Connectez-vous pour acc√©der au suivi</div>
                
                <button class="btn-google" onclick="connexionGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#fff"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#fff"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#fff"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#fff"/>
                    </svg>
                    Connexion avec Google
                </button>
                
                <div class="login-info">
                    üîí Seul le professeur peut acc√©der au suivi de classe pour saisir les √©valuations.
                </div>
            </div>
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- √âCRAN 1 : CONFIGURATION -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="screenConfig" class="screen">
            <div class="header">
                <h1>üìã Suivi de S√©ance</h1>
                <div class="date" id="dateJour"></div>
                <div id="authBadge" style="margin-top: 10px; font-size: 0.8em; color: #16a34a; display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
                    <span id="userEmail">--</span>
                    <a href="historique-suivi.html" style="background: #eff6ff; color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 0.85em; text-decoration: none;">üìú Historique</a>
                    <button onclick="deconnexion()" style="background: #fee2e2; color: #991b1b; border: none; padding: 4px 10px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">D√©co</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">‚öôÔ∏è Configuration</div>
                
                <!-- üìÖ DATE DE S√âANCE MODIFIABLE -->
                <label class="field-label">üìÖ Date de la s√©ance</label>
                <input type="date" id="dateSeanceInput" style="width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; font-size: 1em; font-family: inherit; margin-bottom: 15px; background: white;">
                <p style="font-size: 0.8em; color: var(--muted); margin-top: -10px; margin-bottom: 15px;">üí° Vous pouvez noter une s√©ance pass√©e en changeant la date</p>
                
                <label class="field-label">Classe / Groupe</label>
                <select id="selectClasse" onchange="onClasseChange()">
                    <option value="">-- S√©lectionner --</option>
                </select>
                
                <label class="field-label">Module</label>
                <select id="selectModule">
                    <option value="">-- S√©lectionner --</option>
                </select>
                
                <label class="field-label">Comp√©tences travaill√©es (optionnel)</label>
                <div class="criteres-grid" id="competencesGrid" style="margin-bottom: 15px;">
                    <!-- Rempli dynamiquement -->
                </div>
                
                <label class="field-label">Crit√®res √† √©valuer</label>
                <div class="criteres-grid">
                    <label class="critere-item">
                        <input type="checkbox" id="checkTravail" checked>
                        <span>üìù Travail</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkOral" checked>
                        <span>üó£Ô∏è Oral</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkAttention" checked>
                        <span>üß† Attention</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkPorteVue">
                        <span>üìÅ Porte-vue/Cours</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkCoursAJour">
                        <span>üìã Cours √† jour</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkAutonomie">
                        <span>üéØ Autonomie</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkInitiative">
                        <span>üí° Initiative</span>
                    </label>
                    <label class="critere-item">
                        <input type="checkbox" id="checkSecurite">
                        <span>‚ö†Ô∏è S√©curit√©</span>
                    </label>
                </div>
                
                <label class="critere-item" style="margin-bottom: 20px;">
                    <input type="checkbox" id="checkCommentaire">
                    <span>üí¨ Appr√©ciation</span>
                </label>
                
                <label class="field-label">üìÑ Cours distribu√©s aujourd'hui (choix multiple)</label>
                <div class="cours-grid" style="margin-bottom: 20px;">
                    <label class="cours-checkbox">
                        <input type="checkbox" name="coursDefaut" value="seance1">
                        <span class="icon">üìÑ</span>
                        <span>S√©ance 1</span>
                    </label>
                    <label class="cours-checkbox">
                        <input type="checkbox" name="coursDefaut" value="seance2">
                        <span class="icon">üìÑ</span>
                        <span>S√©ance 2</span>
                    </label>
                    <label class="cours-checkbox">
                        <input type="checkbox" name="coursDefaut" value="seance3">
                        <span class="icon">üìÑ</span>
                        <span>S√©ance 3</span>
                    </label>
                    <label class="cours-checkbox">
                        <input type="checkbox" name="coursDefaut" value="seance4">
                        <span class="icon">üìÑ</span>
                        <span>S√©ance 4</span>
                    </label>
                </div>
                <div class="cours-grid actions" style="margin-bottom: 20px;">
                    <label class="cours-checkbox complet">
                        <input type="checkbox" name="coursDefaut" value="complet">
                        <span class="icon">üìö</span>
                        <span>Cours complet</span>
                    </label>
                    <label class="cours-checkbox action">
                        <input type="checkbox" name="coursDefaut" value="correction">
                        <span class="icon">‚úèÔ∏è</span>
                        <span>Correction</span>
                    </label>
                    <label class="cours-checkbox action">
                        <input type="checkbox" name="coursDefaut" value="evaluation">
                        <span class="icon">üìù</span>
                        <span>√âvaluation</span>
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="demarrerSeance()">
                    üöÄ D√©marrer la s√©ance
                </button>
            </div>
        </div>
        
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- √âCRAN 2 : SAISIE -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="screenSaisie" class="screen">
            
            <div class="eleve-banner">
                <div>
                    <div class="eleve-code" id="eleveCode">--</div>
                    <div id="eleveClasse">--</div>
                </div>
                <div class="eleve-info">
                    <div id="eleveHeure">--:--</div>
                    <div id="eleveModule">--</div>
                </div>
            </div>
            
            <!-- BOUTON RETOUR CONFIG -->
            <div style="margin-bottom: 15px; text-align: center;">
                <button onclick="retourConfig()" style="
                    background: linear-gradient(135deg, #6366f1, #4f46e5);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 10px;
                    font-weight: 600;
                    font-size: 0.9em;
                    cursor: pointer;
                    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
                ">‚öôÔ∏è Modifier la configuration (cours, crit√®res...)</button>
            </div>
            
            <!-- OBJECTIF -->
            <div class="objectif-box" id="sectionObjectif" style="display: none;">
                <h4>üéØ Objectif de l'√©l√®ve</h4>
                
                <!-- Objectif fix√© par l'√©l√®ve -->
                <div id="objectifExistant" style="display: none;">
                    <div class="objectif-texte" id="objectifTexte" style="background: white; padding: 12px 15px; border-radius: 8px; margin-bottom: 12px; font-weight: 600; color: #1e293b;">
                        --
                    </div>
                    <div class="validation" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #dcfce7; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="objectifValidation" value="atteint">
                            ‚úÖ Atteint
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #fee2e2; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="objectifValidation" value="non_atteint">
                            ‚ùå Non atteint
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #fef3c7; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="objectifValidation" value="en_cours">
                            ‚è≥ En cours
                        </label>
                    </div>
                </div>
                
                <!-- Pas d'objectif fix√© -->
                <div id="objectifAucun" style="display: none; text-align: center; padding: 15px; color: #64748b; font-style: italic;">
                    <p>Cet √©l√®ve n'a pas fix√© d'objectif pour cette s√©ance.</p>
                </div>
            </div>
            
            <!-- TRAVAIL -->
            <div class="section-saisie" id="sectionTravail">
                <h3>üìù Travail</h3>
                <div class="options-grid cols-5">
                    <div class="opt-btn" data-critere="travail" data-value="tresbien" onclick="selectOption(this)">
                        <span class="emoji">‚úì‚úì</span>
                        <span class="label">Tr√®s bien</span>
                    </div>
                    <div class="opt-btn" data-critere="travail" data-value="fait" onclick="selectOption(this)">
                        <span class="emoji">‚úì</span>
                        <span class="label">Fait</span>
                    </div>
                    <div class="opt-btn" data-critere="travail" data-value="partiel" onclick="selectOption(this)">
                        <span class="emoji">‚ö†Ô∏è</span>
                        <span class="label">Partiel</span>
                    </div>
                    <div class="opt-btn" data-critere="travail" data-value="insuffisant" onclick="selectOption(this)">
                        <span class="emoji">‚ùå</span>
                        <span class="label">Non fait</span>
                    </div>
                    <div class="opt-btn ne-btn" data-critere="travail" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚ûñ</span>
                        <span class="label">NE</span>
                    </div>
                </div>
            </div>
            
            <!-- ORAL (5 niveaux + NE) -->
            <div class="section-saisie" id="sectionOral">
                <h3>üó£Ô∏è Participation orale</h3>
                <div class="options-grid cols-6">
                    <div class="opt-btn" data-critere="oral" data-value="0" onclick="selectOption(this)">
                        <span class="emoji">0</span>
                        <span class="label">Aucune</span>
                    </div>
                    <div class="opt-btn" data-critere="oral" data-value="1" onclick="selectOption(this)">
                        <span class="emoji">1</span>
                        <span class="label">Faible</span>
                    </div>
                    <div class="opt-btn" data-critere="oral" data-value="2" onclick="selectOption(this)">
                        <span class="emoji">2</span>
                        <span class="label">Correcte</span>
                    </div>
                    <div class="opt-btn" data-critere="oral" data-value="3" onclick="selectOption(this)">
                        <span class="emoji">3</span>
                        <span class="label">Bonne</span>
                    </div>
                    <div class="opt-btn" data-critere="oral" data-value="4" onclick="selectOption(this)">
                        <span class="emoji">4</span>
                        <span class="label">Excellente</span>
                    </div>
                    <div class="opt-btn ne-btn" data-critere="oral" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚ûñ</span>
                        <span class="label">NE</span>
                    </div>
                </div>
            </div>
            
            <!-- ATTENTION -->
            <div class="section-saisie" id="sectionAttention">
                <h3>üß† Attention / Concentration</h3>
                <div class="options-grid cols-4">
                    <div class="opt-btn" data-critere="attention" data-value="bonne" onclick="selectOption(this)">
                        <span class="emoji">üòä</span>
                        <span class="label">Bonne</span>
                    </div>
                    <div class="opt-btn" data-critere="attention" data-value="moyenne" onclick="selectOption(this)">
                        <span class="emoji">üòê</span>
                        <span class="label">Moyenne</span>
                    </div>
                    <div class="opt-btn" data-critere="attention" data-value="insuffisante" onclick="selectOption(this)">
                        <span class="emoji">üòï</span>
                        <span class="label">Insuffisante</span>
                    </div>
                    <div class="opt-btn ne-btn" data-critere="attention" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚ûñ</span>
                        <span class="label">NE</span>
                    </div>
                </div>
            </div>
            
            <!-- PORTE-VUE / COURS -->
            <div class="section-saisie" id="sectionPorteVue">
                <h3>üìÅ Porte-vue / Cours</h3>
                <div class="options-grid cols-3">
                    <div class="opt-btn" data-critere="porteVue" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚è∏Ô∏è</span>
                        <span class="label">Non √©valu√©</span>
                    </div>
                    <div class="opt-btn" data-critere="porteVue" data-value="ok" onclick="selectOption(this)">
                        <span class="emoji">‚úÖ</span>
                        <span class="label">OK</span>
                    </div>
                    <div class="opt-btn" data-critere="porteVue" data-value="oubli" onclick="selectOption(this)">
                        <span class="emoji">‚ùå</span>
                        <span class="label">Oubli√©</span>
                    </div>
                </div>
            </div>
            
            <!-- COURS √Ä JOUR -->
            <div class="section-saisie" id="sectionCoursAJour">
                <h3>üìã Cours √† jour</h3>
                <div class="options-grid">
                    <div class="opt-btn" data-critere="coursAJour" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚è∏Ô∏è</span>
                        <span class="label">Non √©valu√©</span>
                    </div>
                    <div class="opt-btn" data-critere="coursAJour" data-value="a_jour" onclick="selectOption(this)">
                        <span class="emoji">‚úÖ</span>
                        <span class="label">√Ä jour</span>
                    </div>
                    <div class="opt-btn" data-critere="coursAJour" data-value="incomplet" onclick="selectOption(this)">
                        <span class="emoji">‚ö†Ô∏è</span>
                        <span class="label">Incomplet</span>
                    </div>
                    <div class="opt-btn" data-critere="coursAJour" data-value="pas_a_jour" onclick="selectOption(this)">
                        <span class="emoji">‚ùå</span>
                        <span class="label">Pas √† jour</span>
                    </div>
                </div>
            </div>
            
            <!-- AUTONOMIE -->
            <div class="section-saisie" id="sectionAutonomie">
                <h3>üéØ Autonomie</h3>
                <div class="options-grid">
                    <div class="opt-btn" data-critere="autonomie" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚è∏Ô∏è</span>
                        <span class="label">Non √©valu√©</span>
                    </div>
                    <div class="opt-btn" data-critere="autonomie" data-value="bonne" onclick="selectOption(this)">
                        <span class="emoji">üòä</span>
                        <span class="label">Bonne</span>
                    </div>
                    <div class="opt-btn" data-critere="autonomie" data-value="moyenne" onclick="selectOption(this)">
                        <span class="emoji">üòê</span>
                        <span class="label">Moyenne</span>
                    </div>
                    <div class="opt-btn" data-critere="autonomie" data-value="insuffisante" onclick="selectOption(this)">
                        <span class="emoji">üòï</span>
                        <span class="label">Insuffisante</span>
                    </div>
                </div>
            </div>
            
            <!-- INITIATIVE -->
            <div class="section-saisie" id="sectionInitiative">
                <h3>üí° Initiative</h3>
                <div class="options-grid">
                    <div class="opt-btn" data-critere="initiative" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚è∏Ô∏è</span>
                        <span class="label">Non √©valu√©</span>
                    </div>
                    <div class="opt-btn" data-critere="initiative" data-value="oui" onclick="selectOption(this)">
                        <span class="emoji">üòä</span>
                        <span class="label">Oui</span>
                    </div>
                    <div class="opt-btn" data-critere="initiative" data-value="parfois" onclick="selectOption(this)">
                        <span class="emoji">üòê</span>
                        <span class="label">Parfois</span>
                    </div>
                    <div class="opt-btn" data-critere="initiative" data-value="non" onclick="selectOption(this)">
                        <span class="emoji">üòï</span>
                        <span class="label">Non</span>
                    </div>
                </div>
            </div>
            
            <!-- S√âCURIT√â -->
            <div class="section-saisie" id="sectionSecurite">
                <h3>‚ö†Ô∏è Respect consignes s√©curit√©</h3>
                <div class="options-grid">
                    <div class="opt-btn" data-critere="securite" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚è∏Ô∏è</span>
                        <span class="label">Non √©valu√©</span>
                    </div>
                    <div class="opt-btn" data-critere="securite" data-value="oui" onclick="selectOption(this)">
                        <span class="emoji">‚úÖ</span>
                        <span class="label">Oui</span>
                    </div>
                    <div class="opt-btn" data-critere="securite" data-value="partiel" onclick="selectOption(this)">
                        <span class="emoji">‚ö†Ô∏è</span>
                        <span class="label">Partiel</span>
                    </div>
                    <div class="opt-btn" data-critere="securite" data-value="non" onclick="selectOption(this)">
                        <span class="emoji">‚ùå</span>
                        <span class="label">Non</span>
                    </div>
                </div>
            </div>
            
            <!-- BAVARDAGE -->
            <div class="section-saisie" id="sectionBavardage">
                <h3>üí¨ Bavardage <span style="font-weight: 400; font-size: 0.75em; color: #dc2626;">(plafonne la note)</span></h3>
                <div class="options-grid cols-6">
                    <div class="opt-btn good" data-critere="bavardage" data-value="aucun" onclick="selectOption(this)">
                        <span class="emoji">üòä</span>
                        <span class="label">Aucun</span>
                    </div>
                    <div class="opt-btn warning" data-critere="bavardage" data-value="rappel1" onclick="selectOption(this)">
                        <span class="emoji">1Ô∏è‚É£</span>
                        <span class="label">Rappel 1</span>
                    </div>
                    <div class="opt-btn warning" data-critere="bavardage" data-value="rappel2" onclick="selectOption(this)">
                        <span class="emoji">2Ô∏è‚É£</span>
                        <span class="label">Rappel 2</span>
                    </div>
                    <div class="opt-btn danger" data-critere="bavardage" data-value="rappel3" onclick="selectOption(this)">
                        <span class="emoji">3Ô∏è‚É£</span>
                        <span class="label">Rappel 3</span>
                    </div>
                    <div class="opt-btn danger-max" data-critere="bavardage" data-value="retenu" onclick="selectOption(this)">
                        <span class="emoji">üö®</span>
                        <span class="label">Retenu</span>
                    </div>
                    <div class="opt-btn ne-btn" data-critere="bavardage" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚ûñ</span>
                        <span class="label">NE</span>
                    </div>
                </div>
            </div>
            
            <!-- T√âL√âPHONE -->
            <div class="section-saisie" id="sectionTelephone">
                <h3>üì± T√©l√©phone <span style="font-weight: 400; font-size: 0.75em; color: #f59e0b;">(malus)</span></h3>
                <div class="options-grid cols-6">
                    <div class="opt-btn good" data-critere="telephone" data-value="ok" onclick="selectOption(this)">
                        <span class="emoji">‚úÖ</span>
                        <span class="label">OK</span>
                    </div>
                    <div class="opt-btn warning" data-critere="telephone" data-value="rappel1" onclick="selectOption(this)">
                        <span class="emoji">1Ô∏è‚É£</span>
                        <span class="label">Rappel 1</span>
                    </div>
                    <div class="opt-btn warning" data-critere="telephone" data-value="rappel2" onclick="selectOption(this)">
                        <span class="emoji">2Ô∏è‚É£</span>
                        <span class="label">Rappel 2</span>
                    </div>
                    <div class="opt-btn danger" data-critere="telephone" data-value="rappel3" onclick="selectOption(this)">
                        <span class="emoji">3Ô∏è‚É£</span>
                        <span class="label">Rappel 3</span>
                    </div>
                    <div class="opt-btn danger-max" data-critere="telephone" data-value="confisque" onclick="selectOption(this)">
                        <span class="emoji">üö´</span>
                        <span class="label">Confisqu√©</span>
                    </div>
                    <div class="opt-btn ne-btn" data-critere="telephone" data-value="ne" onclick="selectOption(this)">
                        <span class="emoji">‚ûñ</span>
                        <span class="label">NE</span>
                    </div>
                </div>
            </div>
            
            <!-- COMMENTAIRE -->
            <div class="section-saisie" id="sectionCommentaire">
                <h3>üí¨ Appr√©ciation</h3>
                <div class="comment-tags" id="commentTags"></div>
                <textarea class="comment-input" id="inputCommentaire" placeholder="Ajouter un commentaire..."></textarea>
            </div>
            
            <!-- DISTRIBUTION COURS (CHECKBOXES) -->
            <div class="section-saisie" id="sectionCours">
                <h3>üìÑ Distribution cours / Actions</h3>
                <div class="cours-grid">
                    <label class="cours-checkbox">
                        <input type="checkbox" name="coursDistrib" value="seance1">
                        <span class="icon">üìÑ</span>
                        <span>S√©ance 1</span>
                    </label>
                    <label class="cours-checkbox">
                        <input type="checkbox" name="coursDistrib" value="seance2">
                        <span class="icon">üìÑ</span>
                        <span>S√©ance 2</span>
                    </label>
                    <label class="cours-checkbox">
                        <input type="checkbox" name="coursDistrib" value="seance3">
                        <span class="icon">üìÑ</span>
                        <span>S√©ance 3</span>
                    </label>
                    <label class="cours-checkbox">
                        <input type="checkbox" name="coursDistrib" value="seance4">
                        <span class="icon">üìÑ</span>
                        <span>S√©ance 4</span>
                    </label>
                </div>
                <div class="cours-grid actions">
                    <label class="cours-checkbox complet">
                        <input type="checkbox" name="coursDistrib" value="complet">
                        <span class="icon">üìö</span>
                        <span>Cours complet</span>
                    </label>
                    <label class="cours-checkbox action">
                        <input type="checkbox" name="coursDistrib" value="correction">
                        <span class="icon">‚úèÔ∏è</span>
                        <span>Correction</span>
                    </label>
                    <label class="cours-checkbox action">
                        <input type="checkbox" name="coursDistrib" value="evaluation">
                        <span class="icon">üìù</span>
                        <span>√âvaluation</span>
                    </label>
                </div>
            </div>
            
            <!-- NOTE -->
            <div class="note-box">
                <div class="label">Note calcul√©e</div>
                <div class="value" id="notePreview">--/20</div>
                <div class="note-ajustement">
                    <label>
                        <input type="checkbox" id="ajusterNote" onchange="toggleAjustement()">
                        ‚úèÔ∏è Ajuster la note manuellement
                    </label>
                    <div id="ajustementFields" style="display: none; margin-top: 10px;">
                        <label style="display: block; margin-bottom: 5px;">
                            Note finale :
                            <input type="number" id="noteFinaleManuelle" min="0" max="20" step="0.5" onchange="updateNoteFinale()">
                            /20
                        </label>
                        <input type="text" id="justificationAjustement" placeholder="Justification (optionnel)...">
                    </div>
                </div>
            </div>
            
            <!-- ACTIONS -->
            <div class="actions-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <button class="btn btn-secondary" onclick="retourConfig()">‚Üê Retour</button>
                <button class="btn btn-absent" onclick="marquerAbsent()" style="background: #fef3c7; color: #92400e; border: 2px solid #fbbf24;">üö´ Absent</button>
                <button class="btn btn-success" onclick="validerSaisie()">‚úì Valider</button>
            </div>
            
            <!-- LISTE √âL√àVES -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">üë• √âl√®ves (<span id="compteurEleves">0</span>)</div>
                <div class="eleves-list" id="listeEleves"></div>
            </div>
            
        </div>
        
    </div>
    
    <!-- TOAST -->
    <div class="toast" id="toast">‚úÖ Enregistr√© !</div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- SCRIPTS -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script type="module">
        console.log("üîÑ Chargement du module Firebase...");
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, serverTimestamp, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        
        console.log("‚úÖ Imports Firebase OK");
        
        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.appspot.com",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONNEXION GOOGLE (optimis√© pour Safari iOS)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.connexionGoogle = async function() {
            try {
                console.log("üîê Tentative connexion popup...");
                const result = await signInWithPopup(auth, googleProvider);
                console.log("‚úÖ Connect√© via popup:", result.user.email);
                afficherEcranConfig();
            } catch (error) {
                console.log("‚ö†Ô∏è Popup √©chou√©e, tentative redirect...", error.code);
                
                if (error.code === 'auth/popup-blocked' || 
                    error.code === 'auth/popup-closed-by-user' ||
                    error.code === 'auth/cancelled-popup-request' ||
                    error.code === 'auth/internal-error') {
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        const eleveCode = urlParams.get('eleve');
                        if (eleveCode) {
                            sessionStorage.setItem('pendingEleve', eleveCode);
                        }
                        await signInWithRedirect(auth, googleProvider);
                    } catch (redirectError) {
                        console.error("‚ùå Erreur redirect:", redirectError);
                        alert("Erreur de connexion. Essayez d'ouvrir le lien dans Safari directement.");
                    }
                } else {
                    console.error("‚ùå Erreur connexion:", error);
                    alert("Erreur de connexion: " + error.message);
                }
            }
        };
        
        console.log("‚úÖ Fonction connexionGoogle d√©finie");
        
        function afficherEcranConfig() {
            document.getElementById('screenLogin').classList.remove('active');
            document.getElementById('screenConfig').classList.add('active');
            
            if (currentUser) {
                document.getElementById('userEmail').textContent = '‚úÖ ' + currentUser.email;
            }
            
            checkQRScan();
            
            const pendingEleve = sessionStorage.getItem('pendingEleve');
            if (pendingEleve) {
                window.pendingEleveFromQR = pendingEleve;
                sessionStorage.removeItem('pendingEleve');
                console.log("üì± √âl√®ve r√©cup√©r√© apr√®s redirect:", pendingEleve);
            }
        }
        
        window.deconnexion = async function() {
            await signOut(auth);
            currentUser = null;
            document.getElementById('screenLogin').classList.add('active');
            document.getElementById('screenConfig').classList.remove('active');
            document.getElementById('screenSaisie').classList.remove('active');
        };
        
        getRedirectResult(auth).then((result) => {
            if (result && result.user) {
                console.log("‚úÖ Connect√© via redirection:", result.user.email);
                afficherEcranConfig();
            }
        }).catch((error) => {
            if (error.code !== 'auth/popup-closed-by-user') {
                console.error("‚ùå Erreur retour redirection:", error);
            }
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VARIABLES GLOBALES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let currentUser = null;
        let seanceConfig = {
            classe: null,
            classesEffectives: [],
            module: null,
            competence: null,
            criteres: { 
                travail: true, oral: true, attention: true, 
                porteVue: false, coursAJour: false,
                autonomie: false, initiative: false, securite: false,
                commentaire: false 
            },
            dateDebut: null
        };
        let currentEleve = null;
        let saisie = { 
            travail: null, oral: null, attention: null, 
            porteVue: null, coursAJour: null,
            autonomie: null, initiative: null, securite: null,
            bavardage: null, telephone: null 
        };
        let elevesSeance = [];
        let objectifPrecedent = null;
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALISATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            // Initialiser le champ de date avec aujourd'hui
            document.getElementById('dateSeanceInput').value = todayStr;
            
            // Afficher la date format√©e
            document.getElementById('dateJour').textContent = now.toLocaleDateString('fr-FR', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
            
            // Mettre √† jour l'affichage quand la date change
            document.getElementById('dateSeanceInput').addEventListener('change', function() {
                const selectedDate = new Date(this.value + 'T12:00:00');
                document.getElementById('dateJour').textContent = selectedDate.toLocaleDateString('fr-FR', {
                    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                });
                // Ajouter un indicateur si ce n'est pas aujourd'hui
                if (this.value !== todayStr) {
                    document.getElementById('dateJour').innerHTML += ' <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 10px;">üìÖ Date modifi√©e</span>';
                }
            });
            
            const select = document.getElementById('selectClasse');
            const liste = window.getListeClassesPourAffichage ? window.getListeClassesPourAffichage() : [];
            liste.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.label;
                select.appendChild(opt);
            });
            
            renderCommentTags();
            
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    console.log("‚úÖ Connect√©:", user.email);
                    afficherEcranConfig();
                } else {
                    console.log("üîí Non connect√©");
                    document.getElementById('screenLogin').classList.add('active');
                    document.getElementById('screenConfig').classList.remove('active');
                    document.getElementById('screenSaisie').classList.remove('active');
                }
            });
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SCAN QR CODE - Mode rapide
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function checkQRScan() {
            const params = new URLSearchParams(window.location.search);
            const eleveCode = params.get('eleve');
            const reprendre = params.get('reprendre');
            
            if (reprendre === 'true') {
                console.log("üîÑ Mode reprendre s√©ance d√©tect√©");
                
                const classe = params.get('classe');
                const module = params.get('module');
                const dateSeance = params.get('date'); // üìÖ R√âCUP√âRER LA DATE ORIGINALE
                const elevesNotesStr = params.get('elevesNotes') || '';
                const elevesNotes = elevesNotesStr ? elevesNotesStr.split(',') : [];
                
                window.elevesDejaNotes = elevesNotes;
                window.dateSeanceOriginale = dateSeance; // üìÖ STOCKER LA DATE ORIGINALE
                
                // üìÖ METTRE √Ä JOUR L'AFFICHAGE DE LA DATE EN HAUT
                if (dateSeance) {
                    // Mettre √† jour le champ de date input
                    document.getElementById('dateSeanceInput').value = dateSeance;
                    
                    const [year, month, day] = dateSeance.split('-');
                    const dateObj = new Date(year, month - 1, day);
                    document.getElementById('dateJour').textContent = dateObj.toLocaleDateString('fr-FR', {
                        weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                    });
                    // Ajouter un indicateur visuel
                    document.getElementById('dateJour').innerHTML += ' <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 10px;">üìã Reprise</span>';
                }
                
                if (classe) {
                    const selectClasse = document.getElementById('selectClasse');
                    selectClasse.value = classe;
                    onClasseChange();
                    
                    setTimeout(() => {
                        if (module) {
                            const selectModule = document.getElementById('selectModule');
                            selectModule.value = module;
                        }
                    }, 100);
                }
                
                showToast("üìã Reprise s√©ance du " + (dateSeance || "?") + " - " + elevesNotes.length + " √©l√®ve(s) d√©j√† not√©(s)", 3000);
                return;
            }
            
            if (!eleveCode) return;
            
            console.log("üì± Scan QR d√©tect√©:", eleveCode);
            
            if (!window.ELEVES_DATA) {
                alert("Donn√©es √©l√®ves non charg√©es !");
                return;
            }
            
            const eleve = window.ELEVES_DATA.find(e => e.code === eleveCode.toUpperCase());
            if (!eleve) {
                alert("√âl√®ve non trouv√©: " + eleveCode);
                return;
            }
            
            console.log("‚úÖ √âl√®ve trouv√©:", eleve);
            
            const selectClasse = document.getElementById('selectClasse');
            selectClasse.value = eleve.classe;
            onClasseChange();
            
            window.pendingEleveFromQR = eleveCode.toUpperCase();
            
            showToast("üì± " + eleve.prenom + " " + eleve.nom + " (" + eleve.classe + ")", 3000);
        }
        
        function showToast(message, duration = 2000) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, duration);
        }
        
        function renderCommentTags() {
            const container = document.getElementById('commentTags');
            if (!window.BANQUE_COMMENTAIRES) return;
            
            let html = '';
            ['positif', 'encouragement', 'alerte'].forEach(cat => {
                (window.BANQUE_COMMENTAIRES[cat] || []).forEach(txt => {
                    html += `<button type="button" class="comment-tag ${cat}" onclick="addComment('${txt.replace(/'/g, "\\'")}')">${txt}</button>`;
                });
            });
            container.innerHTML = html;
        }
        
        window.addComment = function(txt) {
            const input = document.getElementById('inputCommentaire');
            if (input.value) {
                input.value += ' ' + txt;
            } else {
                input.value = txt;
            }
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // OBJECTIF - Gestion
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Fonctions objectif retir√©es - l'√©l√®ve choisit son objectif dans resultats.html
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DISTRIBUTION COURS (CHECKBOXES MULTIPLES)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function getCoursDistrib() {
            const checked = document.querySelectorAll('input[name="coursDistrib"]:checked');
            const values = Array.from(checked).map(cb => cb.value);
            return values.length > 0 ? values : [];
        }
        
        function setCoursDistrib(values) {
            // Reset toutes les checkboxes
            document.querySelectorAll('input[name="coursDistrib"]').forEach(cb => cb.checked = false);
            
            // Cocher celles qui sont dans le tableau
            if (Array.isArray(values)) {
                values.forEach(val => {
                    const cb = document.querySelector(`input[name="coursDistrib"][value="${val}"]`);
                    if (cb) cb.checked = true;
                });
            }
        }
        
        function getCoursDefaut() {
            const checked = document.querySelectorAll('input[name="coursDefaut"]:checked');
            return Array.from(checked).map(cb => cb.value);
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.onClasseChange = function() {
            const classeId = document.getElementById('selectClasse').value;
            const selectModule = document.getElementById('selectModule');
            const competencesGrid = document.getElementById('competencesGrid');
            
            selectModule.innerHTML = '<option value="">-- S√©lectionner --</option>';
            competencesGrid.innerHTML = '';
            
            if (!classeId) return;
            
            const classes = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
            const firstClasse = classes[0];
            
            const modules = window.getModulesForClasse ? window.getModulesForClasse(firstClasse) : [];
            modules.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = `${m.id} - ${m.titre}`;
                selectModule.appendChild(opt);
            });
            
            const competences = window.getCompetencesForClasse ? window.getCompetencesForClasse(firstClasse) : [];
            competencesGrid.innerHTML = competences.map(c => `
                <label class="critere-item">
                    <input type="checkbox" name="competences" value="${c.id}">
                    <span>${c.id}</span>
                </label>
            `).join('');
        };
        
        window.demarrerSeance = function() {
            const classeId = document.getElementById('selectClasse').value;
            const moduleId = document.getElementById('selectModule').value;
            
            const competencesChecked = Array.from(document.querySelectorAll('input[name="competences"]:checked')).map(cb => cb.value);
            const coursDefaut = getCoursDefaut();
            
            if (!classeId) return alert("S√©lectionnez une classe !");
            if (!moduleId) return alert("S√©lectionnez un module !");
            
            const classesEffectives = window.getClassesFromGroupe ? window.getClassesFromGroupe(classeId) : [classeId];
            const modules = window.getModulesForClasse ? window.getModulesForClasse(classesEffectives[0]) : [];
            const moduleObj = modules.find(m => m.id === moduleId);
            
            seanceConfig = {
                classe: classeId,
                classesEffectives: classesEffectives,
                module: moduleId,
                moduleTitre: moduleObj ? moduleObj.titre : moduleId,
                competences: competencesChecked,
                coursDefaut: coursDefaut,
                criteres: {
                    travail: document.getElementById('checkTravail').checked,
                    oral: document.getElementById('checkOral').checked,
                    attention: document.getElementById('checkAttention').checked,
                    porteVue: document.getElementById('checkPorteVue').checked,
                    coursAJour: document.getElementById('checkCoursAJour').checked,
                    autonomie: document.getElementById('checkAutonomie').checked,
                    initiative: document.getElementById('checkInitiative').checked,
                    securite: document.getElementById('checkSecurite').checked,
                    commentaire: document.getElementById('checkCommentaire').checked
                },
                dateDebut: new Date(),
                // üìÖ UTILISER LA DATE DU CHAMP INPUT (ou date originale si reprise)
                date: window.dateSeanceOriginale || document.getElementById('dateSeanceInput').value || new Date().toISOString().split('T')[0]
            };
            
            // Afficher/masquer sections
            document.getElementById('sectionTravail').style.display = seanceConfig.criteres.travail ? 'block' : 'none';
            document.getElementById('sectionOral').style.display = seanceConfig.criteres.oral ? 'block' : 'none';
            document.getElementById('sectionAttention').style.display = seanceConfig.criteres.attention ? 'block' : 'none';
            document.getElementById('sectionPorteVue').style.display = seanceConfig.criteres.porteVue ? 'block' : 'none';
            document.getElementById('sectionCoursAJour').style.display = seanceConfig.criteres.coursAJour ? 'block' : 'none';
            document.getElementById('sectionAutonomie').style.display = seanceConfig.criteres.autonomie ? 'block' : 'none';
            document.getElementById('sectionInitiative').style.display = seanceConfig.criteres.initiative ? 'block' : 'none';
            document.getElementById('sectionSecurite').style.display = seanceConfig.criteres.securite ? 'block' : 'none';
            document.getElementById('sectionCommentaire').style.display = seanceConfig.criteres.commentaire ? 'block' : 'none';
            document.getElementById('sectionObjectif').style.display = 'block'; // Toujours visible
            
            chargerEleves();
            
            document.getElementById('screenConfig').classList.remove('active');
            document.getElementById('screenSaisie').classList.add('active');
            
            if (window.pendingEleveFromQR) {
                const qrEleve = elevesSeance.find(e => e.code === window.pendingEleveFromQR);
                if (qrEleve) {
                    selectionnerEleve(qrEleve.code);
                    showToast("üì± " + qrEleve.code + " s√©lectionn√©", 2000);
                } else if (elevesSeance.length > 0) {
                    selectionnerEleve(elevesSeance[0].code);
                }
                window.pendingEleveFromQR = null;
            } else if (elevesSeance.length > 0) {
                selectionnerEleve(elevesSeance[0].code);
            }
            
            console.log("üöÄ S√©ance d√©marr√©e:", seanceConfig);
        };
        
        function chargerEleves() {
            elevesSeance = [];
            const eleves = window.BDD_ELEVES || [];
            const elevesDejaNotesListe = window.elevesDejaNotes || [];
            
            seanceConfig.classesEffectives.forEach(classe => {
                eleves.filter(e => e.classe === classe).forEach(e => {
                    const dejaNotes = elevesDejaNotesListe.includes(e.userCode);
                    elevesSeance.push({
                        code: e.userCode,
                        classe: e.classe,
                        done: dejaNotes,
                        absent: false,
                        note: dejaNotes ? '‚úì' : null,
                        dejaNotePrecedemment: dejaNotes
                    });
                });
            });
            
            elevesSeance.sort((a, b) => {
                if (a.dejaNotePrecedemment && !b.dejaNotePrecedemment) return 1;
                if (!a.dejaNotePrecedemment && b.dejaNotePrecedemment) return -1;
                return a.code.localeCompare(b.code);
            });
            
            document.getElementById('compteurEleves').textContent = elevesSeance.length;
            renderListeEleves();
        }
        
        function renderListeEleves() {
            const container = document.getElementById('listeEleves');
            container.innerHTML = elevesSeance.map(e => {
                let statusClass = 'pending';
                let statusText = '‚è≥';
                
                if (e.absent) {
                    statusClass = 'absent';
                    statusText = 'üö´ ABS';
                } else if (e.dejaNotePrecedemment && !e.modifieCetteSesssion) {
                    statusClass = 'done';
                    statusText = '‚úÖ d√©j√†';
                } else if (e.done) {
                    statusClass = 'done';
                    statusText = '‚úÖ ' + e.note + '/20';
                }
                
                return `
                <div class="eleve-row ${statusClass} ${currentEleve === e.code ? 'current' : ''}" 
                     onclick="selectionnerEleve('${e.code}')"
                     title="${e.dejaNotePrecedemment ? 'D√©j√† not√© - Cliquer pour modifier' : (e.done || e.absent ? 'Cliquer pour modifier' : 'Cliquer pour √©valuer')}">
                    <span class="code">${e.code}</span>
                    <span class="status ${statusClass}">
                        ${statusText}
                    </span>
                </div>
            `}).join('');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SAISIE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.selectionnerEleve = async function(code) {
            currentEleve = code;
            saisie = { 
                travail: null, oral: null, attention: null, 
                porteVue: null, coursAJour: null,
                autonomie: null, initiative: null, securite: null,
                bavardage: null, telephone: null 
            };
            objectifPrecedent = null;
            
            // Reset boutons
            document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
            
            // Reset commentaire
            document.getElementById('inputCommentaire').value = '';
            
            // Reset ajustement note
            document.getElementById('ajusterNote').checked = false;
            document.getElementById('ajustementFields').style.display = 'none';
            document.getElementById('noteFinaleManuelle').value = '';
            document.getElementById('justificationAjustement').value = '';
            
            // Reset objectif (validation seulement)
            document.querySelectorAll('input[name="objectifValidation"]').forEach(r => r.checked = false);
            
            // Appliquer le cours par d√©faut
            if (seanceConfig.coursDefaut && seanceConfig.coursDefaut.length > 0) {
                setCoursDistrib(seanceConfig.coursDefaut);
            } else {
                setCoursDistrib([]);
            }
            
            // Afficher infos
            const eleveObj = elevesSeance.find(e => e.code === code);
            document.getElementById('eleveCode').textContent = code;
            document.getElementById('eleveClasse').textContent = eleveObj ? eleveObj.classe : seanceConfig.classe;
            document.getElementById('eleveHeure').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('eleveModule').textContent = seanceConfig.module;
            
            // Charger l'objectif pr√©c√©dent de l'√©l√®ve
            await chargerObjectifEleve(code);
            
            // Si √©l√®ve d√©j√† not√© (dans cette s√©ance OU pr√©c√©demment), charger ses donn√©es
            if (eleveObj && (eleveObj.done || eleveObj.dejaNotePrecedemment)) {
                console.log("üìÇ Chargement donn√©es existantes pour", code);
                await chargerDonneesEleve(code);
            }
            
            updateNotePreview();
            renderListeEleves();
        };
        
        async function chargerObjectifEleve(code) {
            try {
                const objectifRef = doc(db, "resultats", code, "objectifs", "current");
                const objectifSnap = await getDoc(objectifRef);
                
                document.getElementById('sectionObjectif').style.display = 'block';
                
                if (objectifSnap.exists()) {
                    objectifPrecedent = objectifSnap.data();
                    document.getElementById('objectifExistant').style.display = 'block';
                    document.getElementById('objectifAucun').style.display = 'none';
                    document.getElementById('objectifTexte').textContent = 'üéØ ' + objectifPrecedent.texte;
                    // Reset les radios
                    document.querySelectorAll('input[name="objectifValidation"]').forEach(r => r.checked = false);
                } else {
                    objectifPrecedent = null;
                    document.getElementById('objectifExistant').style.display = 'none';
                    document.getElementById('objectifAucun').style.display = 'block';
                }
            } catch (error) {
                console.log("Pas d'objectif:", error);
                document.getElementById('objectifExistant').style.display = 'none';
                document.getElementById('objectifAucun').style.display = 'block';
            }
        }
        
        async function chargerDonneesEleve(code) {
            try {
                const dateSeance = seanceConfig.date || new Date().toISOString().split('T')[0];
                const suiviRef = collection(db, "resultats", code, "suivi");
                const suiviSnap = await getDocs(suiviRef);
                
                let donneesTrouvees = null;
                suiviSnap.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.date === dateSeance && data.module === seanceConfig.module) {
                        donneesTrouvees = { id: docSnap.id, ...data };
                    }
                });
                
                if (donneesTrouvees) {
                    console.log("‚úÖ Donn√©es trouv√©es:", donneesTrouvees);
                    preremplirFormulaire(donneesTrouvees);
                } else {
                    console.log("‚ö†Ô∏è Pas de donn√©es trouv√©es pour cette date/module");
                }
            } catch (error) {
                console.error("‚ùå Erreur chargement donn√©es √©l√®ve:", error);
            }
        }
        
        function preremplirFormulaire(data) {
            // Travail
            if (data.travail) {
                const btnTravail = document.querySelector(`.opt-btn[data-critere="travail"][data-value="${data.travail}"]`);
                if (btnTravail) {
                    btnTravail.classList.add('selected');
                    saisie.travail = data.travail;
                }
            }
            
            // Oral
            if (data.oral !== undefined && data.oral !== null) {
                const btnOral = document.querySelector(`.opt-btn[data-critere="oral"][data-value="${data.oral}"]`);
                if (btnOral) {
                    btnOral.classList.add('selected');
                    saisie.oral = data.oral;
                }
            }
            
            // Attention
            if (data.attention) {
                const btnAttention = document.querySelector(`.opt-btn[data-critere="attention"][data-value="${data.attention}"]`);
                if (btnAttention) {
                    btnAttention.classList.add('selected');
                    saisie.attention = data.attention;
                }
            }
            
            // Porte-vue
            if (data.porteVue) {
                const btnPorteVue = document.querySelector(`.opt-btn[data-critere="porteVue"][data-value="${data.porteVue}"]`);
                if (btnPorteVue) {
                    btnPorteVue.classList.add('selected');
                    saisie.porteVue = data.porteVue;
                }
            }
            
            // Cours √† jour
            if (data.coursAJour) {
                const btn = document.querySelector(`.opt-btn[data-critere="coursAJour"][data-value="${data.coursAJour}"]`);
                if (btn) {
                    btn.classList.add('selected');
                    saisie.coursAJour = data.coursAJour;
                }
            }
            
            // Autonomie
            if (data.autonomie) {
                const btn = document.querySelector(`.opt-btn[data-critere="autonomie"][data-value="${data.autonomie}"]`);
                if (btn) {
                    btn.classList.add('selected');
                    saisie.autonomie = data.autonomie;
                }
            }
            
            // Initiative
            if (data.initiative) {
                const btn = document.querySelector(`.opt-btn[data-critere="initiative"][data-value="${data.initiative}"]`);
                if (btn) {
                    btn.classList.add('selected');
                    saisie.initiative = data.initiative;
                }
            }
            
            // S√©curit√©
            if (data.securite) {
                const btn = document.querySelector(`.opt-btn[data-critere="securite"][data-value="${data.securite}"]`);
                if (btn) {
                    btn.classList.add('selected');
                    saisie.securite = data.securite;
                }
            }
            
            // Bavardage
            if (data.bavardage) {
                const btnBavardage = document.querySelector(`.opt-btn[data-critere="bavardage"][data-value="${data.bavardage}"]`);
                if (btnBavardage) {
                    btnBavardage.classList.add('selected');
                    saisie.bavardage = data.bavardage;
                }
            }
            
            // T√©l√©phone
            if (data.telephone) {
                const btnTelephone = document.querySelector(`.opt-btn[data-critere="telephone"][data-value="${data.telephone}"]`);
                if (btnTelephone) {
                    btnTelephone.classList.add('selected');
                    saisie.telephone = data.telephone;
                }
            }
            
            // Commentaire
            if (data.commentaire) {
                document.getElementById('inputCommentaire').value = data.commentaire;
            }
            
            // Cours distribu√© (maintenant array)
            if (data.coursDistrib) {
                if (Array.isArray(data.coursDistrib)) {
                    setCoursDistrib(data.coursDistrib);
                } else {
                    // R√©trocompatibilit√© avec l'ancien format string
                    setCoursDistrib([data.coursDistrib]);
                }
            }
            
            updateNotePreview();
            showToast(`üìã Donn√©es charg√©es - Note: ${data.noteSur20}/20`, 2000);
        }
        
        window.selectOption = function(btn) {
            const critere = btn.dataset.critere;
            const value = btn.dataset.value;
            
            document.querySelectorAll(`.opt-btn[data-critere="${critere}"]`).forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            if (critere === 'oral') {
                saisie[critere] = parseInt(value);
            } else {
                saisie[critere] = value;
            }
            
            updateNotePreview();
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CALCUL DE NOTE AVEC COMPORTEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const PLAFOND_BAVARDAGE = {
            'aucun': 20,
            'rappel1': 14,
            'rappel2': 10,
            'rappel3': 6,
            'retenu': 4
        };
        
        const MALUS_TELEPHONE = {
            'ok': 0,
            'rappel1': 1,
            'rappel2': 2,
            'rappel3': 3,
            'confisque': 5
        };
        
        function calculerNoteAvecComportement(saisieData, criteres) {
            let points = 0;
            let maxPoints = 0;
            
            // Travail (0-4 pts)
            if (criteres?.travail !== false && saisieData.travail) {
                maxPoints += 4;
                if (saisieData.travail === 'tresbien') points += 4;
                else if (saisieData.travail === 'fait') points += 3;
                else if (saisieData.travail === 'partiel') points += 1.5;
                else if (saisieData.travail === 'insuffisant') points += 0;
            }
            
            // Oral (0-4 pts) - maintenant 5 niveaux
            if (criteres?.oral !== false && saisieData.oral !== null && saisieData.oral !== undefined) {
                maxPoints += 4;
                points += parseInt(saisieData.oral) || 0;
            }
            
            // Attention (0-3 pts)
            if (criteres?.attention !== false && saisieData.attention) {
                maxPoints += 3;
                if (saisieData.attention === 'bonne') points += 3;
                else if (saisieData.attention === 'moyenne') points += 1.5;
                else if (saisieData.attention === 'insuffisante') points += 0;
            }
            
            // Porte-vue (0-1 pt) - seulement si √©valu√© (pas "ne")
            if (criteres?.porteVue !== false && saisieData.porteVue && saisieData.porteVue !== 'ne') {
                maxPoints += 1;
                if (saisieData.porteVue === 'ok') points += 1;
            }
            
            // Cours √† jour (0-2 pts) - seulement si √©valu√©
            if (criteres?.coursAJour !== false && saisieData.coursAJour && saisieData.coursAJour !== 'ne') {
                maxPoints += 2;
                if (saisieData.coursAJour === 'a_jour') points += 2;
                else if (saisieData.coursAJour === 'incomplet') points += 1;
            }
            
            // Autonomie (0-2 pts) - seulement si √©valu√©
            if (criteres?.autonomie !== false && saisieData.autonomie && saisieData.autonomie !== 'ne') {
                maxPoints += 2;
                if (saisieData.autonomie === 'bonne') points += 2;
                else if (saisieData.autonomie === 'moyenne') points += 1;
            }
            
            // Initiative (0-2 pts) - seulement si √©valu√©
            if (criteres?.initiative !== false && saisieData.initiative && saisieData.initiative !== 'ne') {
                maxPoints += 2;
                if (saisieData.initiative === 'oui') points += 2;
                else if (saisieData.initiative === 'parfois') points += 1;
            }
            
            // S√©curit√© (0-2 pts) - seulement si √©valu√©
            if (criteres?.securite !== false && saisieData.securite && saisieData.securite !== 'ne') {
                maxPoints += 2;
                if (saisieData.securite === 'oui') points += 2;
                else if (saisieData.securite === 'partiel') points += 1;
            }
            
            // Convertir en note /20
            let noteBase = maxPoints > 0 ? Math.round((points / maxPoints) * 20 * 10) / 10 : 0;
            
            // Appliquer le PLAFOND bavardage (si NE = pas de plafond)
            const bavardage = saisieData.bavardage || 'aucun';
            const plafond = (bavardage === 'ne') ? 20 : (PLAFOND_BAVARDAGE[bavardage] || 20);
            let notePlafonnee = Math.min(noteBase, plafond);
            
            // Appliquer le MALUS t√©l√©phone (si NE = pas de malus)
            const telephone = saisieData.telephone || 'ok';
            const malus = (telephone === 'ne') ? 0 : (MALUS_TELEPHONE[telephone] || 0);
            let noteFinale = Math.max(0, notePlafonnee - malus);
            
            // Bonus objectif atteint (+0.5 si pas de probl√®me bavardage/t√©l√©phone)
            // NE compte comme OK pour le bonus
            let bonusObjectif = 0;
            const objectifValidation = document.querySelector('input[name="objectifValidation"]:checked');
            const bavardageOk = (bavardage === 'aucun' || bavardage === 'ne');
            const telephoneOk = (telephone === 'ok' || telephone === 'ne');
            if (objectifValidation && objectifValidation.value === 'atteint' && bavardageOk && telephoneOk) {
                bonusObjectif = 0.5;
                noteFinale = Math.min(20, noteFinale + bonusObjectif);
            }
            
            // Arrondir √† 0.5
            noteFinale = Math.round(noteFinale * 2) / 2;
            
            return {
                points: points,
                maxPoints: maxPoints,
                noteBase: noteBase,
                plafond: plafond,
                malus: malus,
                bonusObjectif: bonusObjectif,
                noteSur20: noteFinale,
                bavardage: bavardage,
                telephone: telephone
            };
        }
        
        function updateNotePreview() {
            const result = calculerNoteAvecComportement(saisie, seanceConfig.criteres);
            const hasValue = Object.values(saisie).some(v => v !== null);
            
            const noteEl = document.getElementById('notePreview');
            if (!hasValue) {
                noteEl.textContent = '--/20';
                noteEl.style.color = '#22c55e';
                return;
            }
            
            let display = result.noteSur20 + '/20';
            
            if (result.bavardage === 'retenu') {
                noteEl.style.color = '#dc2626';
                display += ' üö®';
            } else if (result.bavardage === 'rappel3') {
                noteEl.style.color = '#dc2626';
                display += ' ‚ö†Ô∏è';
            } else if (result.bavardage === 'rappel2' || result.bavardage === 'rappel1') {
                noteEl.style.color = '#f59e0b';
            } else if (result.malus > 0) {
                noteEl.style.color = '#f59e0b';
            } else if (result.bonusObjectif > 0) {
                noteEl.style.color = '#16a34a';
                display += ' üéØ';
            } else {
                noteEl.style.color = '#22c55e';
            }
            
            noteEl.textContent = display;
            
            // Mettre √† jour le champ de note manuelle si pas encore modifi√©
            if (!document.getElementById('ajusterNote').checked) {
                document.getElementById('noteFinaleManuelle').value = result.noteSur20;
            }
        }
        
        window.toggleAjustement = function() {
            const checked = document.getElementById('ajusterNote').checked;
            document.getElementById('ajustementFields').style.display = checked ? 'block' : 'none';
            
            if (checked) {
                const result = calculerNoteAvecComportement(saisie, seanceConfig.criteres);
                document.getElementById('noteFinaleManuelle').value = result.noteSur20;
            }
        };
        
        window.updateNoteFinale = function() {
            // Rien √† faire, la note sera prise lors de la validation
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VALIDATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.validerSaisie = async function() {
            if (!currentEleve) return alert("Aucun √©l√®ve s√©lectionn√© !");
            
            const hasValue = Object.entries(saisie).some(([k, v]) => seanceConfig.criteres[k] && v !== null);
            if (!hasValue) return alert("Remplissez au moins un crit√®re !");
            
            const result = calculerNoteAvecComportement(saisie, seanceConfig.criteres);
            const commentaire = document.getElementById('inputCommentaire').value.trim();
            const coursDistrib = getCoursDistrib();
            
            // Note finale (ajust√©e ou calcul√©e)
            let noteFinale = result.noteSur20;
            let ajustementManuel = false;
            let justification = '';
            
            if (document.getElementById('ajusterNote').checked) {
                const noteManuelle = parseFloat(document.getElementById('noteFinaleManuelle').value);
                if (!isNaN(noteManuelle) && noteManuelle >= 0 && noteManuelle <= 20) {
                    noteFinale = noteManuelle;
                    ajustementManuel = true;
                    justification = document.getElementById('justificationAjustement').value.trim();
                }
            }
            
            // Objectif - validation uniquement (l'√©l√®ve fixe son objectif, le prof valide)
            const objectifValidation = document.querySelector('input[name="objectifValidation"]:checked');
            
            const data = {
                date: seanceConfig.date, // üìÖ Utiliser la date de la s√©ance (pas forc√©ment aujourd'hui)
                heure: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                classe: seanceConfig.classe,
                module: seanceConfig.module,
                moduleTitre: seanceConfig.moduleTitre,
                competences: seanceConfig.competences,
                // Crit√®res
                travail: saisie.travail,
                oral: saisie.oral,
                attention: saisie.attention,
                porteVue: saisie.porteVue,
                coursAJour: saisie.coursAJour,
                autonomie: saisie.autonomie,
                initiative: saisie.initiative,
                securite: saisie.securite,
                // Comportement
                bavardage: saisie.bavardage || 'aucun',
                telephone: saisie.telephone || 'ok',
                // Commentaire et cours
                commentaire: commentaire || null,
                coursDistrib: coursDistrib,
                // Calcul
                criteresActifs: seanceConfig.criteres,
                points: result.points,
                maxPoints: result.maxPoints,
                noteBase: result.noteBase,
                noteCalculee: result.noteSur20,
                plafond: result.plafond,
                malus: result.malus,
                bonusObjectif: result.bonusObjectif,
                // Note finale
                noteSur20: noteFinale,
                ajustementManuel: ajustementManuel,
                justificationAjustement: justification || null,
                // Objectif (validation par le prof)
                objectifValide: objectifPrecedent ? {
                    texte: objectifPrecedent.texte,
                    statut: objectifValidation ? objectifValidation.value : 'en_cours'
                } : null,
                // Meta
                absent: false,
                createdAt: serverTimestamp(),
                createdBy: currentUser?.email || "anonyme"
            };
            
            try {
                // Enregistrer suivi (ID fixe = date + module, pour permettre la mise √† jour)
                const docId = `${data.date}_${seanceConfig.module}`;
                const docRef = doc(db, "resultats", currentEleve, "suivi", docId);
                
                // üîí V√âRIFICATION DOUBLON : regarder si un enregistrement existe d√©j√†
                const existingSnap = await getDoc(docRef);
                if (existingSnap.exists()) {
                    const existingData = existingSnap.data();
                    const existingNote = existingData.noteSur20;
                    const isCurrentSession = elevesSeance.find(e => e.code === currentEleve)?.done;
                    
                    // Si l'√©l√®ve n'est pas d√©j√† marqu√© "done" dans cette session, c'est un doublon potentiel
                    if (!isCurrentSession) {
                        const confirmation = confirm(
                            `‚ö†Ô∏è ATTENTION : ${currentEleve} a d√©j√† une note pour cette date !\n\n` +
                            `üìÖ Date : ${data.date}\n` +
                            `üìö Module : ${seanceConfig.module}\n` +
                            `üìù Note existante : ${existingNote}/20\n` +
                            `üÜï Nouvelle note : ${noteFinale}/20\n\n` +
                            `Voulez-vous REMPLACER l'ancienne note ?`
                        );
                        
                        if (!confirmation) {
                            showToast("‚ùå Annul√© - Note non modifi√©e", 2000);
                            return;
                        }
                    }
                }
                
                await setDoc(docRef, data);
                
                // Archiver et supprimer l'objectif si valid√© (atteint ou non_atteint)
                if (objectifPrecedent && objectifValidation) {
                    const statut = objectifValidation.value;
                    
                    // Archiver l'objectif
                    const archiveId = `${new Date().toISOString()}_${objectifPrecedent.texte.substring(0, 20)}`;
                    await setDoc(doc(db, "resultats", currentEleve, "objectifs", archiveId), {
                        texte: objectifPrecedent.texte,
                        statut: statut,
                        dateValidation: new Date().toISOString()
                    });
                    
                    // Supprimer l'objectif courant si atteint ou non_atteint (pas si "en_cours")
                    if (statut === 'atteint' || statut === 'non_atteint') {
                        await deleteDoc(doc(db, "resultats", currentEleve, "objectifs", "current"));
                    }
                }
                
                // Mettre √† jour stats
                await updateStats(currentEleve, noteFinale, saisie);
                
                // Marquer fait
                const idx = elevesSeance.findIndex(e => e.code === currentEleve);
                if (idx !== -1) {
                    elevesSeance[idx].done = true;
                    elevesSeance[idx].absent = false;
                    elevesSeance[idx].note = noteFinale;
                }
                renderListeEleves();
                
                // Toast
                let toastMsg = "‚úÖ " + currentEleve + " - " + noteFinale + "/20";
                if (result.bavardage !== 'aucun') toastMsg += " (bavardage)";
                if (result.telephone !== 'ok') toastMsg += " (üì±)";
                if (result.bonusObjectif > 0) toastMsg += " (üéØ+0.5)";
                showToast(toastMsg);
                
                // √âl√®ve suivant
                const next = elevesSeance.find(e => !e.done && !e.absent);
                if (next) {
                    setTimeout(() => selectionnerEleve(next.code), 300);
                }
                
                console.log("‚úÖ Enregistr√©:", data);
                
            } catch (err) {
                console.error("‚ùå Erreur:", err);
                alert("Erreur: " + err.message);
            }
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MARQUER ABSENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.marquerAbsent = async function() {
            if (!currentEleve) return alert("Aucun √©l√®ve s√©lectionn√© !");
            
            const coursDistrib = getCoursDistrib();
            
            const data = {
                date: seanceConfig.date, // üìÖ Utiliser la date de la s√©ance (pas forc√©ment aujourd'hui)
                heure: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                classe: seanceConfig.classe,
                module: seanceConfig.module,
                moduleTitre: seanceConfig.moduleTitre,
                competences: seanceConfig.competences,
                absent: true,
                noteSur20: null,
                coursDistrib: coursDistrib,
                coursRecu: false,
                createdAt: serverTimestamp(),
                createdBy: currentUser?.email || "anonyme"
            };
            
            try {
                const docId = `${data.date}_${seanceConfig.module}`;
                const docRef = doc(db, "resultats", currentEleve, "suivi", docId);
                
                // üîí V√âRIFICATION DOUBLON
                const existingSnap = await getDoc(docRef);
                if (existingSnap.exists()) {
                    const existingData = existingSnap.data();
                    const existingNote = existingData.noteSur20;
                    const wasAbsent = existingData.absent;
                    
                    const confirmation = confirm(
                        `‚ö†Ô∏è ATTENTION : ${currentEleve} a d√©j√† un enregistrement pour cette date !\n\n` +
                        `üìÖ Date : ${data.date}\n` +
                        `üìö Module : ${seanceConfig.module}\n` +
                        `üìù Existant : ${wasAbsent ? 'Absent' : existingNote + '/20'}\n` +
                        `üÜï Nouveau : Absent\n\n` +
                        `Voulez-vous REMPLACER ?`
                    );
                    
                    if (!confirmation) {
                        showToast("‚ùå Annul√©", 2000);
                        return;
                    }
                }
                
                await setDoc(docRef, data);
                
                await updateStatsAbsence(currentEleve);
                
                const idx = elevesSeance.findIndex(e => e.code === currentEleve);
                if (idx !== -1) {
                    elevesSeance[idx].absent = true;
                    elevesSeance[idx].done = false;
                    elevesSeance[idx].note = null;
                }
                renderListeEleves();
                
                showToast("üö´ " + currentEleve + " - Absent");
                
                const next = elevesSeance.find(e => !e.done && !e.absent);
                if (next) {
                    setTimeout(() => selectionnerEleve(next.code), 300);
                }
                
                console.log("üö´ Absence enregistr√©e:", currentEleve);
                
            } catch (err) {
                console.error("‚ùå Erreur:", err);
                alert("Erreur: " + err.message);
            }
        };
        
        async function updateStatsAbsence(eleveCode) {
            try {
                const ref = doc(db, "resultats", eleveCode, "stats", "suivi");
                const snap = await getDoc(ref);
                
                if (snap.exists()) {
                    const current = snap.data();
                    await updateDoc(ref, {
                        nbAbsences: (current.nbAbsences || 0) + 1,
                        lastUpdate: serverTimestamp()
                    });
                } else {
                    await setDoc(ref, {
                        nbSeances: 0,
                        nbAbsences: 1,
                        totalNotes: 0,
                        lastUpdate: serverTimestamp()
                    });
                }
            } catch (err) {
                console.error("Erreur stats absence:", err);
            }
        }
        
        async function updateStats(eleveCode, note, saisieData) {
            try {
                const ref = doc(db, "resultats", eleveCode, "stats", "suivi");
                const snap = await getDoc(ref);
                
                let stats = snap.exists() ? snap.data() : {
                    totalNotes: 0,
                    nombreSeances: 0,
                    moyenne: 0,
                    travail: { tresbien: 0, fait: 0, partiel: 0, insuffisant: 0 },
                    oral: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 },
                    attention: { bonne: 0, moyenne: 0, insuffisante: 0 },
                    porteVue: { ne: 0, ok: 0, oubli: 0 },
                    coursAJour: { ne: 0, a_jour: 0, incomplet: 0, pas_a_jour: 0 },
                    autonomie: { ne: 0, bonne: 0, moyenne: 0, insuffisante: 0 },
                    initiative: { ne: 0, oui: 0, parfois: 0, non: 0 },
                    securite: { ne: 0, oui: 0, partiel: 0, non: 0 }
                };
                
                // Mise √† jour
                stats.totalNotes += note;
                stats.nombreSeances += 1;
                stats.moyenne = Math.round((stats.totalNotes / stats.nombreSeances) * 10) / 10;
                
                // Compteurs d√©taill√©s
                if (saisieData.travail) {
                    if (!stats.travail) stats.travail = {};
                    stats.travail[saisieData.travail] = (stats.travail[saisieData.travail] || 0) + 1;
                }
                if (saisieData.oral !== null && saisieData.oral !== undefined) {
                    if (!stats.oral) stats.oral = {};
                    stats.oral[saisieData.oral] = (stats.oral[saisieData.oral] || 0) + 1;
                }
                if (saisieData.attention) {
                    if (!stats.attention) stats.attention = {};
                    stats.attention[saisieData.attention] = (stats.attention[saisieData.attention] || 0) + 1;
                }
                if (saisieData.porteVue) {
                    if (!stats.porteVue) stats.porteVue = {};
                    stats.porteVue[saisieData.porteVue] = (stats.porteVue[saisieData.porteVue] || 0) + 1;
                }
                if (saisieData.coursAJour) {
                    if (!stats.coursAJour) stats.coursAJour = {};
                    stats.coursAJour[saisieData.coursAJour] = (stats.coursAJour[saisieData.coursAJour] || 0) + 1;
                }
                if (saisieData.autonomie) {
                    if (!stats.autonomie) stats.autonomie = {};
                    stats.autonomie[saisieData.autonomie] = (stats.autonomie[saisieData.autonomie] || 0) + 1;
                }
                if (saisieData.initiative) {
                    if (!stats.initiative) stats.initiative = {};
                    stats.initiative[saisieData.initiative] = (stats.initiative[saisieData.initiative] || 0) + 1;
                }
                if (saisieData.securite) {
                    if (!stats.securite) stats.securite = {};
                    stats.securite[saisieData.securite] = (stats.securite[saisieData.securite] || 0) + 1;
                }
                
                stats.lastUpdate = serverTimestamp();
                
                await setDoc(ref, stats);
                console.log("üìä Stats:", stats);
                
            } catch (err) {
                console.error("‚ùå Stats error:", err);
            }
        }
        
        window.retourConfig = function() {
            if (elevesSeance.some(e => e.done)) {
                if (!confirm("Quitter la s√©ance ? Les donn√©es enregistr√©es sont conserv√©es.")) return;
            }
            document.getElementById('screenSaisie').classList.remove('active');
            document.getElementById('screenConfig').classList.add('active');
        };
        
        console.log("‚úÖ Suivi PSE v3 pr√™t");
    </script>
</body>
</html>
