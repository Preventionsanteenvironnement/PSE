<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes R√©sultats - PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; max-width: 900px; margin: 0 auto; padding: 0; background: #f8f9fa; color: #333; min-height: 100vh; }
        header { background: #fff; padding: 20px; text-align: center; border-bottom: 1px solid #e9ecef; }
        h1 { color: #f59e0b; margin: 0; font-weight: 700; }
        main { padding: 20px; }
        
        .login-screen { background: white; border-radius: 16px; padding: 40px; max-width: 400px; margin: 40px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; }
        .login-icon { font-size: 4em; margin-bottom: 20px; }
        .login-title { font-size: 1.5em; font-weight: 700; margin-bottom: 10px; }
        .code-input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.2em; text-align: center; letter-spacing: 3px; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; }
        .code-input:focus { outline: none; border-color: #f59e0b; }
        .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .error-message { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; margin-top: 15px; display: none; }
        .error-message.visible { display: block; }
        
        .results-screen { display: none; }
        .results-screen.active { display: block; }
        
        .student-banner { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: #78350f; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        .stats-box { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 2em; font-weight: 800; color: #f59e0b; }
        .stat-label { font-size: 0.85em; color: #64748b; }
        
        .eval-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .eval-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
        .eval-title { font-weight: 600; color: #1e293b; }
        .eval-date { font-size: 0.85em; color: #64748b; }
        .eval-note { font-weight: 700; font-size: 1.3em; padding: 5px 15px; border-radius: 8px; }
        .note-green { background: #dcfce7; color: #166534; }
        .note-orange { background: #fef3c7; color: #92400e; }
        .note-red { background: #fee2e2; color: #991b1b; }
        .eval-appreciation { background: #fffbeb; border-left: 3px solid #f59e0b; padding: 10px 15px; margin-top: 10px; border-radius: 0 8px 8px 0; }
        
        .empty-state { text-align: center; padding: 40px; color: #64748b; }
        .empty-icon { font-size: 4em; opacity: 0.5; }
        
        .loader { text-align: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f1f5f9; border-top-color: #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <h1>üìä Mes R√©sultats</h1>
</header>

<main>
    <div class="login-screen" id="loginScreen">
        <div class="login-icon">üîê</div>
        <div class="login-title">Acc√®s √† mes r√©sultats</div>
        <p style="color:#64748b;">Entrez votre code √©l√®ve</p>
        <input type="text" class="code-input" id="codeInput" placeholder="EX: KA47" maxlength="10" autofocus>
        <button class="login-btn" id="loginBtn" onclick="connecter()">Acc√©der</button>
        <div class="error-message" id="errorMessage">‚ùå Code non trouv√©.</div>
    </div>

    <div class="results-screen" id="resultsScreen">
        <div class="student-banner">
            <div>
                <strong id="studentName">--</strong>
                <span id="studentClass" style="opacity:0.8;margin-left:10px;">--</span>
            </div>
            <button class="logout-btn" onclick="deconnecter()">üö™ D√©connexion</button>
        </div>
        
        <div class="stats-box">
            <div class="stat-item">
                <div class="stat-value" id="statMoyenne">--</div>
                <div class="stat-label">Moyenne</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statNbEvals">0</div>
                <div class="stat-label">√âvaluations</div>
            </div>
        </div>
        
        <div id="evaluationsList">
            <div class="loader"><div class="spinner"></div><div>Chargement...</div></div>
        </div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.appspot.com",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentCode = null;
    let evaluationsData = [];

    window.connecter = connecter;
    window.deconnecter = deconnecter;

    document.getElementById('codeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') connecter();
    });

    async function connecter() {
        const codeInput = document.getElementById('codeInput');
        const code = codeInput.value.trim().toUpperCase();
        const errorDiv = document.getElementById('errorMessage');
        const loginBtn = document.getElementById('loginBtn');

        errorDiv.classList.remove('visible');

        if (!code || code.length < 2) {
            errorDiv.textContent = "‚ö†Ô∏è Entrez votre code √©l√®ve.";
            errorDiv.classList.add('visible');
            return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = "Chargement...";

        try {
            // ‚≠ê CHEMIN S√âCURIS√â : resultats/{eleveCode}/evaluations/
            const q = query(collection(db, "resultats", code, "evaluations"), limit(50));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                errorDiv.textContent = "‚ùå Aucune √©valuation trouv√©e pour ce code.";
                errorDiv.classList.add('visible');
                loginBtn.disabled = false;
                loginBtn.textContent = "Acc√©der";
                return;
            }

            evaluationsData = [];
            snapshot.forEach(doc => {
                evaluationsData.push({ id: doc.id, ...doc.data() });
            });

            evaluationsData.sort((a, b) => {
                const dateA = a.createdAtISO ? new Date(a.createdAtISO) : new Date(0);
                const dateB = b.createdAtISO ? new Date(b.createdAtISO) : new Date(0);
                return dateB - dateA;
            });

            currentCode = code;

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('resultsScreen').classList.add('active');

            const firstEval = evaluationsData[0];
            document.getElementById('studentName').textContent = code;
            document.getElementById('studentClass').textContent = firstEval?.classe || "";

            renderEvaluations();
            renderStats();

        } catch (error) {
            console.error("Erreur:", error);
            errorDiv.textContent = "‚ùå Erreur de connexion.";
            errorDiv.classList.add('visible');
        }

        loginBtn.disabled = false;
        loginBtn.textContent = "Acc√©der";
    }

    function deconnecter() {
        currentCode = null;
        evaluationsData = [];
        document.getElementById('resultsScreen').classList.remove('active');
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('codeInput').value = '';
        document.getElementById('errorMessage').classList.remove('visible');
    }

    function renderEvaluations() {
        const container = document.getElementById('evaluationsList');

        if (evaluationsData.length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><p>Aucune √©valuation</p></div>`;
            return;
        }

        let html = '';
        evaluationsData.forEach((evaluation) => {
            const titre = evaluation.titre || evaluation.devoirId || "√âvaluation";
            const date = evaluation.createdAtISO ? new Date(evaluation.createdAtISO).toLocaleDateString('fr-FR') : "Date inconnue";
            const note = evaluation.note_finale;
            let noteClass = note >= 14 ? 'note-green' : note >= 10 ? 'note-orange' : 'note-red';

            html += `
                <div class="eval-card">
                    <div class="eval-header">
                        <div>
                            <div class="eval-title">${titre}</div>
                            <div class="eval-date">üìÖ ${date}</div>
                        </div>
                        <div class="eval-note ${noteClass}">${note.toFixed(1)}/20</div>
                    </div>
                    ${evaluation.appreciation ? `<div class="eval-appreciation"><strong>üí¨ Appr√©ciation:</strong> ${evaluation.appreciation}</div>` : ''}
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function renderStats() {
        let totalNotes = 0, nbNotes = 0;
        evaluationsData.forEach(e => {
            if (e.note_finale !== undefined) {
                totalNotes += e.note_finale;
                nbNotes++;
            }
        });
        const moyenne = nbNotes > 0 ? (totalNotes / nbNotes).toFixed(1) : '--';
        document.getElementById('statMoyenne').textContent = moyenne !== '--' ? moyenne + '/20' : '--';
        document.getElementById('statNbEvals').textContent = nbNotes;
    }

    console.log("‚úÖ Page R√©sultats v4.0");
</script>

</body>
</html>
