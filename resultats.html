<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes R√©sultats - PSE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto', sans-serif;
            max-width: 900px; 
            margin: 0 auto; 
            padding: 0; 
            background-color: #f8f9fa; 
            color: #333; 
            min-height: 100vh;
        }

        header {
            background-color: #fff;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            position: relative;
        }
        
        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }

        h1 { 
            color: #f59e0b; 
            margin: 0; 
            font-weight: 700; 
            font-size: 1.8em;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 0.95em;
            margin-top: 5px;
        }

        main { padding: 20px; }

        /* Login */
        .login-screen {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            margin: 40px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .login-icon { font-size: 4em; margin-bottom: 20px; }
        .login-title { font-size: 1.5em; font-weight: 700; color: #1e293b; margin-bottom: 10px; }
        .login-subtitle { color: #64748b; margin-bottom: 25px; font-size: 0.95em; }
        
        .code-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1.2em;
            text-align: center;
            letter-spacing: 3px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        
        .code-input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        
        .code-input.error {
            border-color: #ef4444;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }
        
        .login-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            display: none;
        }
        
        .error-message.visible { display: block; }

        /* Results */
        .results-screen { display: none; }
        .results-screen.active { display: block; }
        
        .student-banner {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .student-info { display: flex; align-items: center; gap: 10px; }
        .student-avatar {
            width: 45px; height: 45px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em;
        }
        .student-name { font-weight: 700; font-size: 1.1em; }
        .student-class { font-size: 0.9em; opacity: 0.8; }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: #78350f;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.4); }

        /* Cards */
        .evaluations-list { display: flex; flex-direction: column; gap: 12px; }
        
        .eval-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .eval-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .eval-title { font-weight: 600; color: #1e293b; font-size: 1.05em; }
        .eval-date { font-size: 0.85em; color: #64748b; }
        
        .eval-note {
            font-weight: 700;
            font-size: 1.3em;
            padding: 5px 15px;
            border-radius: 8px;
            white-space: nowrap;
        }
        
        .note-green { background: #dcfce7; color: #166534; }
        .note-orange { background: #fef3c7; color: #92400e; }
        .note-red { background: #fee2e2; color: #991b1b; }
        
        .eval-appreciation {
            background: #fffbeb;
            border-left: 3px solid #f59e0b;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 0.95em;
            color: #78350f;
        }
        
        .eval-appreciation-title {
            font-weight: 600;
            font-size: 0.85em;
            color: #92400e;
            margin-bottom: 5px;
        }

        /* Stats */
        .stats-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .stat-item { text-align: center; }
        .stat-value { font-size: 2em; font-weight: 800; color: #f59e0b; }
        .stat-label { font-size: 0.85em; color: #64748b; margin-top: 5px; }

        /* Empty state */
        .empty-state { text-align: center; padding: 40px 20px; color: #64748b; }
        .empty-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
        .empty-title { font-weight: 600; color: #475569; margin-bottom: 5px; }

        /* Loader */
        .loader { text-align: center; padding: 40px; }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f1f5f9;
            border-top-color: #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 600px) {
            .login-screen { margin: 20px; padding: 30px 20px; }
            h1 { font-size: 1.4em; }
            .student-banner { flex-direction: column; text-align: center; }
            .eval-header { flex-direction: column; }
            .back-btn { position: static; transform: none; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="back-btn">‚Üê Retour</a>
        <div>
            <h1>üìä Mes R√©sultats</h1>
            <div class="subtitle">Consultez vos notes et appr√©ciations</div>
        </div>
    </header>

    <main>
        <!-- Login -->
        <div class="login-screen" id="loginScreen">
            <div class="login-icon">üîê</div>
            <div class="login-title">Acc√®s √† mes r√©sultats</div>
            <div class="login-subtitle">Entrez votre code √©l√®ve (8 caract√®res)</div>
            
            <input 
                type="text" 
                class="code-input" 
                id="codeInput" 
                placeholder="EX: KA47M9P2"
                maxlength="12"
                autocomplete="off"
                autofocus
            >
            
            <button class="login-btn" id="loginBtn" onclick="connecter()">
                Acc√©der √† mes r√©sultats
            </button>
            
            <div class="error-message" id="errorMessage">
                ‚ùå Code non trouv√©.
            </div>
        </div>

        <!-- Results -->
        <div class="results-screen" id="resultsScreen">
            
            <div class="student-banner">
                <div class="student-info">
                    <div class="student-avatar">üë§</div>
                    <div>
                        <div class="student-name" id="studentName">--</div>
                        <div class="student-class" id="studentClass">--</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="deconnecter()">üö™ D√©connexion</button>
            </div>
            
            <div class="stats-box">
                <div class="stat-item">
                    <div class="stat-value" id="statMoyenne">--</div>
                    <div class="stat-label">Moyenne</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statNbEvals">0</div>
                    <div class="stat-label">√âvaluations</div>
                </div>
            </div>
            
            <div id="evaluationsList" class="evaluations-list">
                <div class="loader">
                    <div class="spinner"></div>
                    <div>Chargement...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.appspot.com",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentCode = null;
        let evaluationsData = [];

        // Exposer les fonctions
        window.connecter = connecter;
        window.deconnecter = deconnecter;

        // Enter key
        document.getElementById('codeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') connecter();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONNEXION - Lecture depuis resultats/{eleveCode}/evaluations/
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function connecter() {
            const codeInput = document.getElementById('codeInput');
            const code = codeInput.value.trim().toUpperCase();
            const errorDiv = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');

            errorDiv.classList.remove('visible');
            codeInput.classList.remove('error');

            if (!code || code.length < 4) {
                codeInput.classList.add('error');
                errorDiv.textContent = "‚ö†Ô∏è Code trop court (minimum 4 caract√®res).";
                errorDiv.classList.add('visible');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = "Chargement...";

            try {
                // ‚≠ê CHEMIN S√âCURIS√â : resultats/{eleveCode}/evaluations/
                // R√®gle Firestore : allow list: if validCode(eleveCode)
                const q = query(
                    collection(db, "resultats", code, "evaluations"),
                    limit(50)
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    codeInput.classList.add('error');
                    errorDiv.textContent = "‚ùå Aucune √©valuation trouv√©e pour ce code.";
                    errorDiv.classList.add('visible');
                    loginBtn.disabled = false;
                    loginBtn.textContent = "Acc√©der √† mes r√©sultats";
                    return;
                }

                evaluationsData = [];
                snapshot.forEach(doc => {
                    evaluationsData.push({ id: doc.id, ...doc.data() });
                });

                // Trier par date (plus r√©cent d'abord)
                evaluationsData.sort((a, b) => {
                    const dateA = a.createdAtISO ? new Date(a.createdAtISO) : new Date(0);
                    const dateB = b.createdAtISO ? new Date(b.createdAtISO) : new Date(0);
                    return dateB - dateA;
                });

                currentCode = code;

                // Afficher
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('resultsScreen').classList.add('active');

                // Extraire classe du premier r√©sultat
                const firstEval = evaluationsData[0];
                document.getElementById('studentName').textContent = code;
                document.getElementById('studentClass').textContent = firstEval?.classe || "Classe";

                renderEvaluations();
                renderStats();

            } catch (error) {
                console.error("Erreur:", error);
                codeInput.classList.add('error');
                errorDiv.textContent = "‚ùå Erreur de connexion. V√©rifiez votre code.";
                errorDiv.classList.add('visible');
            }

            loginBtn.disabled = false;
            loginBtn.textContent = "Acc√©der √† mes r√©sultats";
        }

        function deconnecter() {
            currentCode = null;
            evaluationsData = [];
            document.getElementById('resultsScreen').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('codeInput').value = '';
            document.getElementById('errorMessage').classList.remove('visible');
        }

        function renderEvaluations() {
            const container = document.getElementById('evaluationsList');

            if (evaluationsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-title">Aucune √©valuation</div>
                        <p>Vos r√©sultats appara√Ætront ici une fois corrig√©s.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            evaluationsData.forEach((evaluation) => {
                const titre = evaluation.titre || evaluation.devoirId || "√âvaluation";
                const date = evaluation.createdAtISO 
                    ? new Date(evaluation.createdAtISO).toLocaleDateString('fr-FR', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    })
                    : "Date inconnue";
                
                const note = evaluation.note_finale;
                let noteClass = 'note-orange';
                if (note >= 14) noteClass = 'note-green';
                else if (note < 10) noteClass = 'note-red';

                html += `
                    <div class="eval-card">
                        <div class="eval-header">
                            <div>
                                <div class="eval-title">${escapeHtml(titre)}</div>
                                <div class="eval-date">üìÖ ${date}</div>
                            </div>
                            <div class="eval-note ${noteClass}">${note.toFixed(1)}/20</div>
                        </div>
                        ${evaluation.appreciation ? `
                            <div class="eval-appreciation">
                                <div class="eval-appreciation-title">üí¨ Appr√©ciation du professeur</div>
                                ${escapeHtml(evaluation.appreciation)}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderStats() {
            let totalNotes = 0;
            let nbNotes = 0;
            
            evaluationsData.forEach(e => {
                if (e.note_finale !== undefined && e.note_finale !== null) {
                    totalNotes += e.note_finale;
                    nbNotes++;
                }
            });
            
            const moyenne = nbNotes > 0 ? (totalNotes / nbNotes).toFixed(1) : '--';

            document.getElementById('statMoyenne').textContent = moyenne !== '--' ? moyenne + '/20' : '--';
            document.getElementById('statNbEvals').textContent = nbNotes;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        console.log("‚úÖ Page R√©sultats v4.0 - Structure s√©curis√©e");
    </script>

</body>
</html>
