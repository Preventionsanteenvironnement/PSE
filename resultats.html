<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Mes R√©sultats PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Charger la liste des √©l√®ves -->
    <script src="data_eleves.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; max-width: 1000px; margin: 0 auto; padding: 0; background: #f8f9fa; color: #333; min-height: 100vh; }
        
        /* === HEADER === */
        header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; text-align: center; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-weight: 700; font-size: 1.8em; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1::before { content: "üìä "; }
        
        main { padding: 20px; }
        
        /* === LOGIN SCREEN === */
        .login-screen { background: white; border-radius: 16px; padding: 40px; max-width: 400px; margin: 40px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; }
        .login-icon { font-size: 4em; margin-bottom: 20px; }
        .login-title { font-size: 1.5em; font-weight: 700; margin-bottom: 10px; color: #1e293b; }
        .login-subtitle { color: #64748b; margin-bottom: 20px; font-size: 0.95em; }
        .code-input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.2em; text-align: center; letter-spacing: 3px; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; transition: border 0.2s; }
        .code-input:focus { outline: none; border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); }
        .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .login-btn:active { transform: translateY(0); }
        .error-message { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; margin-top: 15px; display: none; border-left: 4px solid #dc2626; }
        .error-message.visible { display: block; }
        .btn-retour { background: #e2e8f0; color: #475569; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px; }
        .btn-retour:hover { background: #cbd5e1; }
        
        /* === RESULTS SCREEN === */
        .results-screen { display: none; }
        .results-screen.active { display: block; }
        
        /* === STUDENT BANNER === */
        .student-banner { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 2px 10px rgba(245, 158, 11, 0.2); }
        .student-info { display: flex; align-items: center; gap: 15px; }
        .student-name { font-size: 1.3em; font-weight: 700; }
        .student-class { background: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 8px; font-weight: 600; }
        .banner-actions { display: flex; gap: 10px; }
        .logout-btn, .btn-home { background: rgba(255,255,255,0.3); border: none; color: #78350f; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .logout-btn:hover, .btn-home:hover { background: rgba(255,255,255,0.5); }
        
        /* === STATS GRID === */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-value { font-size: 2em; font-weight: 800; color: #f59e0b; margin-bottom: 5px; }
        .stat-label { font-size: 0.85em; color: #64748b; }
        
        /* === TABS === */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: white; padding: 5px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 12px; text-align: center; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 600; color: #64748b; transition: all 0.2s; }
        .tab.active { background: #f59e0b; color: white; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); }
        .tab:hover:not(.active) { background: #fef3c7; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* === EVAL CARD === */
        .eval-card { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: all 0.2s; position: relative; overflow: hidden; }
        .eval-card::before { content: ""; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: #f59e0b; }
        .eval-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .eval-title { font-weight: 700; font-size: 1.1em; color: #1e293b; }
        .eval-meta { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .eval-date { font-size: 0.85em; color: #64748b; }
        .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 700; }
        .status-corrected { background: #dcfce7; color: #166534; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-nn { background: #fed7aa; color: #c2410c; }
        .status-absent { background: #fee2e2; color: #991b1b; }
        .eval-note { font-weight: 800; font-size: 1.5em; padding: 8px 20px; border-radius: 10px; }
        .note-excellent { background: #dcfce7; color: #166534; }
        .note-good { background: #dbeafe; color: #1e40af; }
        .note-average { background: #fef3c7; color: #92400e; }
        .note-poor { background: #fee2e2; color: #991b1b; }
        .note-pending { background: #e0e7ff; color: #3730a3; }
        .note-nn { background: #fef3c7; color: #b45309; font-weight: bold; }
        .note-absent { background: #fee2e2; color: #dc2626; font-weight: bold; }
        .eval-actions { margin-top: 15px; display: flex; gap: 10px; }
        .btn-view { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-view:hover { background: #2563eb; transform: translateY(-2px); }
        .btn-view:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        
        /* === MODAL === */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .modal-title { font-size: 1.3em; font-weight: 700; }
        .modal-actions { display: flex; gap: 10px; }
        .action-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .action-btn:hover { background: rgba(255,255,255,0.3); }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.3em; font-weight: bold; transition: all 0.2s; }
        .modal-close:hover { background: rgba(255,255,255,0.4); transform: rotate(90deg); }
        .modal-body { padding: 25px; }
        
        /* === APPRECIATION BLOCK === */
        .appreciation-block { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 5px solid #f59e0b; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .appreciation-title { font-weight: 700; color: #78350f; margin-bottom: 10px; font-size: 1.1em; }
        .appreciation-title::before { content: "üí¨ "; }
        .appreciation-text { color: #78350f; line-height: 1.6; font-size: 1em; }
        
        /* === COMPETENCES SUMMARY === */
        .competences-summary { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .competences-title { font-weight: 700; color: #1e293b; margin-bottom: 15px; font-size: 1.1em; }
        .competences-title::before { content: "üéØ "; }
        .comp-list { display: grid; gap: 12px; }
        .comp-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #e2e8f0; }
        .comp-label { font-weight: 600; color: #475569; }
        .comp-result { display: flex; align-items: center; gap: 10px; }
        .comp-badge-large { padding: 6px 15px; border-radius: 20px; font-weight: 700; font-size: 0.9em; }
        .badge-M { background: #dcfce7; color: #166534; border-left-color: #22c55e !important; }
        .badge-A { background: #dbeafe; color: #1e40af; border-left-color: #3b82f6 !important; }
        .badge-I { background: #fef3c7; color: #92400e; border-left-color: #f59e0b !important; }
        .badge-NT { background: #e2e8f0; color: #475569; border-left-color: #94a3b8 !important; }
        .comp-score { font-weight: 700; color: #64748b; font-size: 0.95em; }
        
        /* === QUESTIONS DETAIL === */
        .questions-section { margin-top: 25px; }
        .section-title { font-weight: 700; color: #1e293b; margin-bottom: 20px; font-size: 1.2em; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .section-title::before { content: "üìù "; }
        .question-card { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; transition: all 0.2s; page-break-inside: avoid; }
        .question-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 15px; }
        .question-number { font-weight: 700; font-size: 1.1em; color: #f59e0b; }
        .question-competence { background: #f8fafc; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85em; color: #64748b; }
        .question-text { color: #1e293b; margin-bottom: 15px; line-height: 1.5; font-weight: 500; }
        .answer-section { background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
        .answer-label { font-weight: 600; color: #1e40af; margin-bottom: 8px; font-size: 0.9em; }
        .answer-label::before { content: "‚úçÔ∏è "; }
        .answer-text { color: #0f172a; line-height: 1.5; white-space: pre-wrap; }
        .evaluation-section { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
        .evaluation-label { font-weight: 600; color: #92400e; margin-bottom: 8px; font-size: 0.9em; }
        .evaluation-label::before { content: "üéØ "; }
        .comment-section { background: #fffbeb; border-left: 4px solid #fbbf24; padding: 15px; border-radius: 0 8px 8px 0; }
        .comment-label { font-weight: 600; color: #78350f; margin-bottom: 8px; font-size: 0.9em; }
        .comment-label::before { content: "üí¨ "; }
        .comment-text { color: #78350f; line-height: 1.5; font-style: italic; }
        .no-comment { color: #94a3b8; font-style: italic; }
        
        /* === CORRECTION === */
        .correction-section { background: #dcfce7; border-left: 4px solid #22c55e; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
        .correction-label { font-weight: 600; color: #166534; margin-bottom: 8px; font-size: 0.9em; }
        .correction-label::before { content: "‚úÖ "; }
        .correction-text { color: #166534; line-height: 1.5; white-space: pre-wrap; }
        
        /* === NOUVEAU DESIGN GRILLE === */
        .student-info-banner { background: #f8fafc; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }
        .info-left { color: #64748b; font-size: 0.95em; }
        .info-right .note-finale { color: #166534; font-size: 1.2em; }
        .paste-alert { background: #fef3c7; border: 1px solid #fbbf24; border-left: 4px solid #f59e0b; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; color: #92400e; font-weight: 600; }
        
        .competences-table-section { background: white; border: 2px solid #2c3e50; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
        .section-title { font-weight: 700; color: #2c3e50; margin-bottom: 15px; font-size: 1.2em; text-transform: uppercase; }
        .comp-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em; }
        .comp-table thead { background: #2c3e50; color: white; }
        .comp-table th { padding: 10px; text-align: center; border: 1px solid #999; font-weight: bold; }
        .comp-table td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        .comp-table tbody tr:nth-child(even) { background: #f8f9fa; }
        .note-finale-row { text-align: right; padding: 10px; background: #f8fafc; border-radius: 5px; margin-top: 10px; font-size: 1.1em; }
        
        .question-card-grid { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; }
        .question-header-grid { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .question-number-grid { font-weight: 700; font-size: 1.2em; color: #f59e0b; }
        .question-comp-grid { background: #f0f9ff; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85em; color: #3b82f6; }
        .question-level-grid { padding: 6px 15px; border-radius: 20px; font-weight: 700; font-size: 0.9em; }
        .question-text-grid { color: #1e293b; margin-bottom: 15px; line-height: 1.6; font-weight: 500; }
        
        .answer-section-grid { background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
        .correction-section-grid { background: #dcfce7; border-left: 4px solid #22c55e; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
        .comment-section-grid { background: #fffbeb; border-left: 4px solid #fbbf24; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
        .section-label-grid { font-weight: 600; margin-bottom: 8px; font-size: 0.95em; }
        .section-content-grid { line-height: 1.6; white-space: pre-wrap; }
        .answer-section-grid .section-label-grid { color: #1e40af; }
        .correction-section-grid .section-label-grid { color: #166534; }
        .comment-section-grid .section-label-grid { color: #78350f; }
        .answer-section-grid .section-content-grid { color: #0f172a; }
        .correction-section-grid .section-content-grid { color: #166534; }
        .comment-section-grid .section-content-grid { color: #78350f; font-style: italic; }
        
        @media print {
            .paste-alert { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .comp-table thead { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .comp-table td[style*="background"] { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .question-card-grid { page-break-inside: avoid; }
        }
        
        /* === CHARTS === */
        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chart-title { font-weight: 700; margin-bottom: 15px; color: #1e293b; }
        .chart-container { position: relative; height: 300px; }
        
        /* === PRINT STYLES === */
        @media print {
            @page { size: A4; margin: 15mm; }
            body { background: white; max-width: 100%; }
            header { background: #f59e0b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .modal-header { background: #f59e0b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .appreciation-block { background: #fffbeb !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .question-card { page-break-inside: avoid; border: 1px solid #e2e8f0; }
            .comp-badge-large, .badge-M, .badge-A, .badge-I, .badge-NT { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .answer-section { background: #f0f9ff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .evaluation-section { background: #fef3c7 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .comment-section { background: #fffbeb !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .correction-section { background: #dcfce7 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .modal-content { max-height: none; box-shadow: none; }
            .modal-body { padding: 10px; }
        }
        
        /* === PRINT HEADER === */
        .print-header { display: none; }
        @media print {
            .print-header { 
                display: block !important; 
                background: #f59e0b; 
                color: white; 
                padding: 20px; 
                margin: -15mm -15mm 20px -15mm;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            .print-header-title { font-size: 1.5em; font-weight: 700; margin-bottom: 5px; }
            .print-header-info { font-size: 0.9em; opacity: 0.9; }
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            header { padding: 15px; }
            h1 { font-size: 1.3em; }
            main { padding: 15px; }
            .student-banner { flex-direction: column; text-align: center; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .tabs { flex-wrap: wrap; }
            .modal-content { max-width: 100%; border-radius: 16px 16px 0 0; max-height: 95vh; }
            .question-header { flex-direction: column; align-items: flex-start; }
        }
        
        /* === LOADING === */
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #f59e0b; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* === EMPTY STATE === */
        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
        .empty-text { font-size: 1.1em; font-weight: 600; }
        
        /* === SUIVI DE CLASSE === */
        .suivi-header {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
        }
        .suivi-stats-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        .suivi-moyenne {
            font-size: 2.5em;
            font-weight: 800;
        }
        .suivi-presence {
            font-size: 1.8em;
            font-weight: 700;
            text-align: center;
        }
        .suivi-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 10px;
        }
        .suivi-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .suivi-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .tendances-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .tendance-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .tendance-icon { font-size: 1.5em; margin-bottom: 5px; }
        .tendance-label { font-size: 0.75em; color: #64748b; margin-bottom: 5px; }
        .tendance-value { font-size: 1.2em; font-weight: 700; }
        .tendance-arrow { font-size: 1.1em; margin-left: 5px; }
        .tendance-arrow.up { color: #16a34a; }
        .tendance-arrow.down { color: #dc2626; }
        .tendance-arrow.stable { color: #64748b; }
        .seance-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 5px solid #8b5cf6;
        }
        .seance-card.seance-absent {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .seance-note-value.absent {
            background: #fef3c7;
            color: #92400e;
        }
        .seance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .seance-header:hover { background: #f8fafc; }
        .seance-info { display: flex; flex-direction: column; gap: 3px; }
        .seance-date { font-weight: 700; color: #1e293b; }
        .seance-module { font-size: 0.85em; color: #64748b; }
        .seance-note { display: flex; align-items: center; gap: 8px; }
        .seance-note-value { font-size: 1.3em; font-weight: 800; }
        .seance-note-icon { font-size: 1.5em; }
        .note-excellent-suivi { color: #16a34a; }
        .note-good-suivi { color: #8b5cf6; }
        .note-average-suivi { color: #f59e0b; }
        .note-poor-suivi { color: #dc2626; }
        .seance-detail {
            display: none;
            padding: 15px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }
        .seance-detail.open { display: block; }
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 0.9em;
        }
        .detail-value { font-weight: 600; }
        .detail-value.good { color: #16a34a; }
        .detail-value.medium { color: #f59e0b; }
        .detail-value.bad { color: #dc2626; }
        .seance-comment {
            margin-top: 10px;
            padding: 12px;
            background: #eff6ff;
            border-radius: 8px;
            font-style: italic;
            color: #1e40af;
            border-left: 3px solid #3b82f6;
        }
        .empty-suivi {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        .empty-suivi-icon { font-size: 3em; margin-bottom: 15px; }
        .tab.tab-suivi { background: #8b5cf6; color: white; }
        .tab.tab-suivi:hover { background: #7c3aed; }
        
        /* === ONGLET MES COURS === */
        .cours-module-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .cours-module-header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 15px 20px;
            font-weight: 700;
        }
        .cours-module-header .module-code {
            font-size: 1.1em;
        }
        .cours-module-header .module-titre {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 3px;
        }
        .cours-seances-list {
            padding: 10px 0;
        }
        .cours-seance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        .cours-seance-row:last-child {
            border-bottom: none;
        }
        .cours-seance-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .cours-seance-icon {
            font-size: 1.2em;
        }
        .cours-seance-nom {
            font-weight: 600;
        }
        .cours-seance-date {
            font-size: 0.85em;
            color: #64748b;
        }
        .cours-seance-status {
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
        }
        .cours-seance-status.recu {
            background: #dcfce7;
            color: #166534;
        }
        .cours-seance-status.manquant {
            background: #fee2e2;
            color: #991b1b;
        }
        .cours-alerte {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .cours-alerte-icon {
            font-size: 1.5em;
        }
        .cours-alerte-text {
            font-weight: 600;
            color: #92400e;
        }
    </style>
</head>
<body>
    <header class="no-print">
        <h1>Mes R√©sultats PSE</h1>
    </header>

    <!-- √âCRAN DE CONNEXION -->
    <div class="login-screen" id="loginScreen">
        <div class="login-icon">üîê</div>
        <div class="login-title">Acc√®s √âl√®ve</div>
        <div class="login-subtitle">Entre ton code personnel</div>
        <input type="text" id="codeInput" class="code-input" placeholder="CODE √âL√àVE" maxlength="12" autofocus>
        <button class="login-btn" onclick="connexion()">Se connecter</button>
        <div class="error-message" id="errorMsg">Code incorrect. V√©rifie ton code √©l√®ve.</div>
        <button class="btn-retour" onclick="window.location.href='https://preventionsanteenvironnement.github.io/PSE/'">‚¨ÖÔ∏è Retour au site PSE</button>
    </div>

    <!-- √âCRAN R√âSULTATS -->
    <div class="results-screen" id="resultsScreen">
        <main>
            <!-- Bandeau √©l√®ve -->
            <div class="student-banner no-print">
                <div class="student-info">
                    <span class="student-name" id="studentName">√âl√®ve</span>
                    <span class="student-class" id="studentClass">Classe</span>
                </div>
                <div class="banner-actions">
                    <button class="btn-home" onclick="window.location.href='https://preventionsanteenvironnement.github.io/PSE/'">üè† Site PSE</button>
                    <button class="logout-btn" onclick="deconnexion()">üö™ D√©connexion</button>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statMoyenne">--</div>
                    <div class="stat-label">Moyenne g√©n√©rale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCorriges">0</div>
                    <div class="stat-label">√âvaluations corrig√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAttente">0</div>
                    <div class="stat-label">En attente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statMeilleureComp">--</div>
                    <div class="stat-label">Meilleure comp√©tence</div>
                </div>
            </div>

            <!-- Onglets -->
            <div class="tabs no-print">
                <button class="tab active" onclick="switchTab('evaluations')">üìù √âvaluations</button>
                <button class="tab" onclick="switchTab('suivi')">üìã Mon suivi</button>
                <button class="tab" onclick="switchTab('cours')">üìÑ Mes cours</button>
                <button class="tab" onclick="switchTab('competences')">üéØ Comp√©tences</button>
                <button class="tab" onclick="switchTab('progression')">üìà Progression</button>
                <button class="tab" onclick="ouvrirInfoCompetences()" style="margin-left: auto; background: #0ea5e9; color: white;">‚ÑπÔ∏è Info</button>
            </div>

            <!-- Contenu √âvaluations -->
            <div class="tab-content active" id="tabEvaluations">
                <div id="evalList"></div>
            </div>
            
            <!-- Contenu Suivi de classe -->
            <div class="tab-content" id="tabSuivi">
                <div id="suiviContent">
                    <div class="empty-suivi">
                        <div class="empty-suivi-icon">üìã</div>
                        <p>Chargement du suivi...</p>
                    </div>
                </div>
            </div>
            
            <!-- Contenu Mes Cours -->
            <div class="tab-content" id="tabCours">
                <div id="coursContent">
                    <div class="empty-suivi">
                        <div class="empty-suivi-icon">üìÑ</div>
                        <p>Chargement des cours...</p>
                    </div>
                </div>
            </div>

            <!-- Contenu Comp√©tences -->
            <div class="tab-content" id="tabCompetences">
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-title">üéØ Radar des comp√©tences</div>
                        <div class="chart-container"><canvas id="radarChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">üìä Performance par comp√©tence</div>
                        <div class="chart-container"><canvas id="barChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Contenu Progression -->
            <div class="tab-content" id="tabProgression">
                <div class="chart-card">
                    <div class="chart-title">üìà √âvolution des notes</div>
                    <div class="chart-container"><canvas id="lineChart"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL D√âTAIL COPIE -->
    <div class="modal-overlay" id="modalDetail">
        <div class="modal-content" id="printableArea">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">D√©tail de la copie</div>
                <div class="modal-actions no-print">
                    <button class="action-btn" onclick="imprimerCopie()">üñ®Ô∏è Imprimer</button>
                    <button class="modal-close" onclick="fermerModal()">√ó</button>
                </div>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- MODAL INFO COMP√âTENCES -->
    <div class="modal-overlay" id="modalInfo">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">‚ÑπÔ∏è Comprendre les comp√©tences</div>
                <div class="modal-actions no-print">
                    <button class="modal-close" onclick="fermerInfoModal()">√ó</button>
                </div>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div style="background: #fff7ed; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f97316;">
                    <strong>üìö BAC PRO</strong>
                    <p style="margin-top: 10px; color: #7c2d12; line-height: 1.6;">
                        ‚Ä¢ <strong>C1</strong> - Traiter l'information<br>
                        ‚Ä¢ <strong>C2</strong> - Appliquer une d√©marche d'analyse dans une situation donn√©e<br>
                        ‚Ä¢ <strong>C3</strong> - Expliquer un ph√©nom√®ne physiologique, un enjeu environnemental, une disposition r√©glementaire, en lien avec la d√©marche de pr√©vention<br>
                        ‚Ä¢ <strong>C4</strong> - Proposer une solution pour r√©soudre un probl√®me<br>
                        ‚Ä¢ <strong>C5</strong> - Argumenter un choix<br>
                        ‚Ä¢ <strong>C6</strong> - Communiquer √† l'√©crit et √† l'oral avec une syntaxe claire et un vocabulaire adapt√©
                    </p>
                </div>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                    <strong>üéì CAP</strong>
                    <p style="margin-top: 10px; color: #075985; line-height: 1.6;">
                        ‚Ä¢ <strong>C1</strong> - Traiter une information<br>
                        ‚Ä¢ <strong>C2</strong> - Appliquer une m√©thode d'analyse dans une situation donn√©e<br>
                        ‚Ä¢ <strong>C3</strong> - Mettre en relation un ph√©nom√®ne physiologique, un enjeu environnemental, une disposition r√©glementaire, avec une mesure de pr√©vention<br>
                        ‚Ä¢ <strong>C4</strong> - Proposer une solution pour r√©soudre un probl√®me li√© √† la sant√©, l'environnement ou la consommation<br>
                        ‚Ä¢ <strong>C5</strong> - Argumenter un choix<br>
                        ‚Ä¢ <strong>C6</strong> - Communiquer √† l'√©crit et √† l'oral avec une syntaxe claire et un vocabulaire adapt√©
                    </p>
                </div>
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #64748b;">
                    <strong>üéØ Niveaux d'√©valuation</strong>
                    <p style="margin-top: 10px; color: #475569; line-height: 1.6;">
                        ‚Ä¢ <strong style="color: #dc2626;">NT</strong> (Non Trait√©) - Question non r√©pondue ou r√©ponse totalement erron√©e<br>
                        ‚Ä¢ <strong style="color: #f97316;">I</strong> (Insuffisant) - Comp√©tence en cours d'acquisition<br>
                        ‚Ä¢ <strong style="color: #0ea5e9;">A</strong> (Acceptable) - Comp√©tence partiellement ma√Ætris√©e<br>
                        ‚Ä¢ <strong style="color: #22c55e;">M</strong> (Ma√Ætris√©) - Comp√©tence pleinement ma√Ætris√©e
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, collectionGroup, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.appspot.com",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUserCode = null;
        let allEvaluations = [];
        let radarChart, barChart, lineChart;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONNEXION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.connexion = async function() {
            const code = document.getElementById('codeInput').value.trim().toUpperCase();
            if (!code) return;

            // Cacher l'erreur pr√©c√©dente
            document.getElementById('errorMsg').classList.remove('visible');

            try {
                console.log("üîê Connexion avec code:", code);
                
                // V√©rifier si le code existe dans data_eleves.js
                let eleveExiste = false;
                let eleveInfo = null;
                
                if (typeof window.dataEleves !== 'undefined') {
                    // Chercher dans toutes les classes
                    for (const [classe, eleves] of Object.entries(window.dataEleves)) {
                        const eleve = eleves.find(e => e.code === code);
                        if (eleve) {
                            eleveExiste = true;
                            eleveInfo = { ...eleve, classe: classe };
                            break;
                        }
                    }
                }
                
                if (!eleveExiste) {
                    console.log("‚ùå Code non trouv√© dans data_eleves.js");
                    document.getElementById('errorMsg').textContent = "Code inconnu. V√©rifie ton code ou contacte ton professeur.";
                    document.getElementById('errorMsg').classList.add('visible');
                    return;
                }
                
                console.log("‚úÖ √âl√®ve trouv√©:", eleveInfo);

                currentUserCode = code;
                currentEleveInfo = eleveInfo;
                localStorage.setItem('pse_user_code', code);
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('resultsScreen').classList.add('active');
                
                // Afficher les infos √©l√®ve
                document.getElementById('studentName').textContent = code;
                document.getElementById('studentClass').textContent = eleveInfo.classe || "";
                
                await chargerDonnees();
                
            } catch (e) {
                console.error("‚ùå Erreur connexion:", e);
                alert("Erreur: " + e.message);
            }
        };
        
        let currentEleveInfo = null;

        window.deconnexion = function() {
            localStorage.removeItem('pse_user_code');
            location.reload();
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHARGEMENT DONN√âES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function chargerDonnees() {
            console.log("üìÇ Chargement pour:", currentUserCode);
            
            try {
                // √âTAPE 1 : Charger les COPIES
                const qCopies = query(
                    collectionGroup(db, "copies"),
                    where("eleveCode", "==", currentUserCode)
                );
                const snapCopies = await getDocs(qCopies);
                
                // √âTAPE 2 : Charger les √âVALUATIONS
                const qEvals = query(
                    collectionGroup(db, "evaluations"),
                    where("eleveCode", "==", currentUserCode)
                );
                const snapEvals = await getDocs(qEvals);
                
                // Cr√©er une Map des √©valuations par devoirId
                const evalsMap = new Map();
                snapEvals.forEach(doc => {
                    const evalData = doc.data();
                    evalsMap.set(evalData.devoirId, evalData);
                });
                
                // √âTAPE 3 : FUSIONNER copies + √©valuations
                allEvaluations = [];
                snapCopies.forEach(docSnap => {
                    const copie = docSnap.data();
                    const evaluation = evalsMap.get(copie.devoirId);
                    
                    allEvaluations.push({
                        id: docSnap.id,
                        copie: copie,
                        evaluation: evaluation,
                        estCorrige: !!evaluation,
                        devoirId: copie.devoirId,
                        titre: copie.titre || "Devoir",
                        date: copie.createdAtISO || copie.createdAt?.toDate?.() || new Date(),
                        note: evaluation?.note_finale ?? null,
                        nonNote: evaluation?.nonNote || false,  // ‚≠ê R√©cup√©rer le flag "Non not√©"
                        appreciation: evaluation?.appreciation || "",
                        competences: evaluation?.competences || {},
                        questions: evaluation?.questions || {},
                        reponses: copie.reponses || {}
                    });
                });
                
                // Trier par date d√©croissante
                allEvaluations.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log("‚úÖ Donn√©es charg√©es:", allEvaluations.length, "√©valuations");
                
                // Mettre √† jour l'interface
                afficherInfosEleve();
                afficherStatistiques();
                afficherListeEvaluations();
                creerGraphiques();
                
                // Charger le suivi de classe
                chargerSuivi();
                
            } catch (e) {
                console.error("‚ùå Erreur chargement:", e);
                alert("Erreur: " + e.message);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AFFICHAGE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function afficherInfosEleve() {
            if (allEvaluations.length === 0) return;
            
            const premier = allEvaluations[0];
            const eleve = premier.copie.eleve;
            
            // RGPD : Afficher uniquement le code
            document.getElementById('studentName').textContent = currentUserCode;
            document.getElementById('studentClass').textContent = eleve?.classe || "";
        }

        function afficherStatistiques() {
            const corriges = allEvaluations.filter(e => e.estCorrige);
            const attente = allEvaluations.filter(e => !e.estCorrige);
            
            // Moyenne (exclure les "NN" - non not√©s et "ABS" - absents)
            const notes = corriges
                .filter(e => e.note !== null && e.note !== "NN" && e.note !== "ABS" && !e.nonNote && !e.absent && !isNaN(e.note))
                .map(e => parseFloat(e.note));
            const moyenne = notes.length > 0 ? (notes.reduce((a, b) => a + b, 0) / notes.length).toFixed(1) : "--";
            
            // Meilleure comp√©tence
            const compStats = {};
            corriges.forEach(e => {
                for (const [comp, data] of Object.entries(e.competences)) {
                    if (!compStats[comp]) compStats[comp] = { total: 0, max: 0 };
                    compStats[comp].total += data.pts || 0;
                    compStats[comp].max += data.max || 0;
                }
            });
            
            let meilleureComp = "--";
            let meilleurPct = 0;
            for (const [comp, data] of Object.entries(compStats)) {
                if (data.max > 0) {
                    const pct = (data.total / data.max) * 100;
                    if (pct > meilleurPct) {
                        meilleurPct = pct;
                        meilleureComp = comp;
                    }
                }
            }
            
            document.getElementById('statMoyenne').textContent = moyenne + (moyenne !== "--" ? "/20" : "");
            document.getElementById('statCorriges').textContent = corriges.length;
            document.getElementById('statAttente').textContent = attente.length;
            document.getElementById('statMeilleureComp').textContent = meilleureComp;
        }

        function afficherListeEvaluations() {
            const container = document.getElementById('evalList');
            
            if (allEvaluations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-text">Aucune √©valuation pour le moment</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allEvaluations.map(item => {
                const dateStr = item.date instanceof Date ? item.date.toLocaleDateString('fr-FR') : 
                               typeof item.date === 'string' ? new Date(item.date).toLocaleDateString('fr-FR') : '--';
                
                // ‚≠ê Badge de statut adapt√©
                let statusBadge;
                if (item.note === "ABS" || item.absent) {
                    statusBadge = '<span class="status-badge status-absent">üö´ Absent</span>';
                } else if (item.note === "NN" || item.nonNote) {
                    statusBadge = '<span class="status-badge status-nn">‚ö†Ô∏è Non not√©</span>';
                } else if (item.estCorrige) {
                    statusBadge = '<span class="status-badge status-corrected">‚úì Corrig√©</span>';
                } else {
                    statusBadge = '<span class="status-badge status-pending">‚è≥ En attente</span>';
                }
                
                let noteClass = 'note-pending';
                let noteText = '--';
                // ‚≠ê G√©rer les cas sp√©ciaux
                if (item.note === "ABS" || item.absent) {
                    noteText = 'ABS';
                    noteClass = 'note-absent';
                } else if (item.note === "NN" || item.nonNote) {
                    noteText = 'NN';
                    noteClass = 'note-nn';
                } else if (item.note !== null && !isNaN(item.note)) {
                    noteText = parseFloat(item.note).toFixed(1) + '/20';
                    if (item.note >= 16) noteClass = 'note-excellent';
                    else if (item.note >= 12) noteClass = 'note-good';
                    else if (item.note >= 10) noteClass = 'note-average';
                    else noteClass = 'note-poor';
                }
                
                return `
                    <div class="eval-card">
                        <div class="eval-header">
                            <div>
                                <div class="eval-title">${item.titre}</div>
                                <div class="eval-meta">
                                    <span class="eval-date">üìÖ ${dateStr}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                            <div class="eval-note ${noteClass}">${noteText}</div>
                        </div>
                        <div class="eval-actions">
                            <button class="btn-view" onclick="ouvrirDetail('${item.id}')" ${!item.estCorrige ? 'disabled' : ''}>
                                üëÅÔ∏è ${item.estCorrige ? 'Voir ma copie corrig√©e' : 'Correction en cours...'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MODAL D√âTAIL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.ouvrirDetail = async function(evalId) {
            const evaluation = allEvaluations.find(e => e.id === evalId);
            if (!evaluation || !evaluation.estCorrige) return;
            
            console.log("üìÑ Ouverture d√©tail:", evaluation.devoirId);
            
            // Charger le blueprint depuis CockpitPSE
            let blueprint = null;
            try {
                const resp = await fetch(`https://preventionsanteenvironnement.github.io/CockpitPSE/${evaluation.devoirId}_blueprint.json?ts=${Date.now()}`, { cache: "no-store" });
                if (resp.ok) blueprint = await resp.json();
            } catch (e) {
                console.warn("‚ö†Ô∏è Blueprint non trouv√©:", e);
            }
            
            // Charger le fichier correction depuis CockpitPSE (optionnel)
            let correction = null;
            try {
                const correctionURL = `https://preventionsanteenvironnement.github.io/CockpitPSE/${evaluation.devoirId}_correction.json?ts=${Date.now()}`;
                console.log("üì• Tentative chargement correction:", correctionURL);
                const respCorr = await fetch(correctionURL, { cache: "no-store" });
                if (respCorr.ok) {
                    correction = await respCorr.json();
                    console.log("‚úÖ Fichier correction charg√©:", correction);
                } else {
                    console.warn(`‚ö†Ô∏è Fichier correction non trouv√© (${respCorr.status}):`, correctionURL);
                }
            } catch (e) {
                console.warn("‚ö†Ô∏è Erreur chargement correction:", e);
            }
            
            // Construire le HTML - NOUVEAU DESIGN GRILLE
            // ‚≠ê G√©rer le cas "Non not√©"
            const noteDisplay = (evaluation.note === "NN" || evaluation.nonNote) ? "Non not√©" : 
                               (evaluation.note !== null && !isNaN(evaluation.note)) ? parseFloat(evaluation.note).toFixed(1) + "/20" : "--";
            const modalTitle = `${evaluation.titre} - ${noteDisplay}`;
            document.getElementById('modalTitle').textContent = modalTitle;
            
            let html = '';
            
            // Date format√©e
            const dateStr = evaluation.date instanceof Date ? evaluation.date.toLocaleDateString('fr-FR') : 
                           typeof evaluation.date === 'string' ? new Date(evaluation.date).toLocaleDateString('fr-FR') : '--';
            
            // En-t√™te impression
            html += `
                <div class="print-header">
                    <div class="print-header-title">${evaluation.titre}</div>
                    <div class="print-header-info">Code : ${currentUserCode} | Note : ${noteDisplay} | Date : ${dateStr}</div>
                </div>
            `;
            
            // Bandeau info √©l√®ve (visible √©cran)
            html += `
                <div class="student-info-banner no-print">
                    <div class="info-left">
                        <strong>Code :</strong> ${currentUserCode} | 
                        <strong>Date :</strong> ${dateStr}
                    </div>
                    <div class="info-right">
                        <strong class="note-finale">${noteDisplay}</strong>
                    </div>
                </div>
            `;
            
            // Alerte copier-coller si > 0
            const pasteCount = evaluation.copie?.pasteLog?.external || 0;
            if (pasteCount > 0) {
                html += `
                    <div class="paste-alert">
                        ‚ö†Ô∏è ${pasteCount} copier-coller d√©tect√©${pasteCount > 1 ? 's' : ''} depuis des sources externes
                    </div>
                `;
            }
            
            // Appr√©ciation g√©n√©rale
            if (evaluation.appreciation) {
                html += `
                    <div class="appreciation-block">
                        <div class="appreciation-title">üí¨ Appr√©ciation G√©n√©rale</div>
                        <div class="appreciation-text">${evaluation.appreciation}</div>
                    </div>
                `;
            }
            
            // TABLEAU COMP√âTENCES (style grille cockpit)
            html += `
                <div class="competences-table-section">
                    <div class="section-title">üéØ Comp√©tences √©valu√©es</div>
                    <table class="comp-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">C</th>
                                <th>Questions</th>
                                <th style="width: 100px;">Niveau</th>
                                <th style="width: 80px;">NT</th>
                                <th style="width: 80px;">I</th>
                                <th style="width: 80px;">A</th>
                                <th style="width: 80px;">M</th>
                                <th style="width: 120px;">Pts / Max</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Compter les questions par comp√©tence et niveau
            const compStats = {};
            
            if (blueprint && blueprint.content) {
                blueprint.content.forEach((item, idx) => {
                    if (item.type === 'question') {
                        const comp = item.competence || 'C?';
                        const qNum = item.label || (idx + 1);
                        const qid = item.qid;
                        
                        if (!compStats[comp]) {
                            compStats[comp] = { questions: [], NT: 0, I: 0, A: 0, M: 0, pts: 0, max: 0 };
                        }
                        
                        compStats[comp].questions.push(qNum);
                        
                        // R√©cup√©rer le niveau de cette question
                        const questionEval = evaluation.questions[qid] || {};
                        const niveau = questionEval.level || "NT";
                        compStats[comp][niveau]++;
                        
                        // Points
                        const bareme = item.bareme || 0;
                        compStats[comp].max += bareme;
                        
                        if (niveau === 'M') compStats[comp].pts += bareme;
                        else if (niveau === 'A') compStats[comp].pts += bareme * 0.6;
                        else if (niveau === 'I') compStats[comp].pts += bareme * 0.3;
                    }
                });
            }
            
            // Afficher le tableau
            const compOrder = ['C1', 'C2', 'C3', 'C4', 'C5', 'C6'];
            compOrder.forEach(comp => {
                if (compStats[comp]) {
                    const data = compStats[comp];
                    const questionsStr = data.questions.join(', ');
                    
                    // D√©terminer niveau global
                    let niveauGlobal = 'NT';
                    if (data.M > 0) niveauGlobal = 'M';
                    else if (data.A > 0) niveauGlobal = 'A';
                    else if (data.I > 0) niveauGlobal = 'I';
                    
                    const compColor = {
                        C1: '#95a5a6',
                        C2: '#3498db',
                        C3: '#e74c3c',
                        C4: '#2980b9',
                        C5: '#f39c12',
                        C6: '#27ae60'
                    }[comp] || '#95a5a6';
                    
                    html += `
                        <tr>
                            <td style="background: ${compColor}; color: white; font-weight: bold; text-align: center;">${comp}</td>
                            <td style="text-align: center; font-size: 0.9em;">${questionsStr}</td>
                            <td style="text-align: center;">
                                <span class="badge-${niveauGlobal}" style="padding: 4px 8px; border-radius: 4px; font-weight: bold;">${niveauGlobal}</span>
                            </td>
                            <td style="text-align: center; color: #e74c3c;">‚óè${data.NT}</td>
                            <td style="text-align: center; color: #f39c12;">‚óè${data.I}</td>
                            <td style="text-align: center; color: #3498db;">‚óè${data.A}</td>
                            <td style="text-align: center; color: #27ae60;">‚óè${data.M}</td>
                            <td style="text-align: center; font-weight: bold;">${data.pts.toFixed(1)} / ${data.max}</td>
                        </tr>
                    `;
                }
            });
            
            html += `
                        </tbody>
                    </table>
                    <div class="note-finale-row">
                        <strong>NOTE :</strong> <span style="color: ${(evaluation.note === "NN" || evaluation.nonNote) ? '#b45309' : '#27ae60'}; font-size: 1.3em; font-weight: bold;">${noteDisplay}</span>
                    </div>
                </div>
            `;
            
            // Questions d√©taill√©es
            html += `
                <div class="questions-section">
                    <div class="section-title">üìù D√©tail de l'√©valuation</div>
            `;
            
            if (blueprint && blueprint.content) {
                blueprint.content.forEach((item, idx) => {
                    if (item.type === 'question') {
                        const qid = item.qid;
                        const label = item.label || `Q${idx + 1}`;
                        const questionText = item.questionText || "Question";
                        const competence = item.competence || "";
                        
                        // Chercher la r√©ponse
                        let reponse = evaluation.reponses[qid] || 
                                     evaluation.reponses[label] || 
                                     evaluation.reponses[`Q${label}`] ||
                                     evaluation.reponses[`q_${idx}`] ||
                                     "<i>Non r√©pondu</i>";
                        
                        if (Array.isArray(reponse)) {
                            reponse = reponse.map(r => `‚Ä¢ ${r}`).join('<br>');
                        }
                        
                        // R√©cup√©rer l'√©valuation
                        const questionEval = evaluation.questions[qid] || evaluation.questions[label] || {};
                        const niveau = questionEval.level || "NT";
                        const commentaire = questionEval.comment || "";
                        
                        const niveauLabels = {
                            M: "üü¢ Ma√Ætris√©",
                            A: "üîµ Acceptable",
                            I: "üü† Insuffisant",
                            NT: "‚ö™ Non Trait√©"
                        };
                        
                        // Chercher la correction dans le BLUEPRINT (reponseAttendue)
                        let correctionText = "";
                        if (blueprint && blueprint.content) {
                            const bp = blueprint.content.find(c => c.qid === qid || c.label === label);
                            if (bp && bp.reponseAttendue) {
                                correctionText = bp.reponseAttendue.replace(/\n/g, '<br>');
                            }
                        }
                        
                        html += `
                            <div class="question-card-grid">
                                <div class="question-header-grid">
                                    <div class="question-number-grid">Question ${idx + 1}</div>
                                    ${competence ? `<div class="question-comp-grid">${competence}</div>` : ''}
                                    <div class="question-level-grid badge-${niveau}">${niveauLabels[niveau] || niveau}</div>
                                </div>
                                <div class="question-text-grid">${questionText}</div>
                                
                                <div class="answer-section-grid">
                                    <div class="section-label-grid">‚úçÔ∏è Ta r√©ponse</div>
                                    <div class="section-content-grid">${reponse}</div>
                                </div>
                                
                                ${correctionText ? `
                                    <div class="correction-section-grid">
                                        <div class="section-label-grid">üéØ Correction attendue</div>
                                        <div class="section-content-grid">${correctionText}</div>
                                    </div>
                                ` : ''}
                                
                                ${commentaire ? `
                                    <div class="comment-section-grid">
                                        <div class="section-label-grid">üí¨ Commentaire du professeur</div>
                                        <div class="section-content-grid">${commentaire}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                });
            } else {
                html += `<div class="empty-state"><div class="empty-text">D√©tails non disponibles</div></div>`;
            }
            
            html += `</div>`;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalDetail').classList.add('active');
            
            // ‚≠ê Enregistrer que l'√©l√®ve a lu sa copie
            try {
                const evalRef = doc(db, "resultats", currentUserCode, "evaluations", evaluation.devoirId + "_eval");
                await setDoc(evalRef, {
                    luLe: serverTimestamp(),
                    luParCode: currentUserCode
                }, { merge: true });
                console.log("‚úÖ Lecture enregistr√©e pour", evaluation.devoirId);
            } catch (e) {
                console.warn("‚ö†Ô∏è Impossible d'enregistrer la lecture:", e);
            }
        };

        window.fermerModal = function() {
            document.getElementById('modalDetail').classList.remove('active');
        };

        window.ouvrirInfoCompetences = function() {
            document.getElementById('modalInfo').classList.add('active');
        };

        window.fermerInfoModal = function() {
            document.getElementById('modalInfo').classList.remove('active');
        };

        window.imprimerCopie = function() {
            window.print();
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRAPHIQUES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function creerGraphiques() {
            const corriges = allEvaluations.filter(e => e.estCorrige);
            if (corriges.length === 0) return;
            
            // Donn√©es comp√©tences
            const compData = { C1: 0, C2: 0, C3: 0, C4: 0, C5: 0, C6: 0 };
            const compMax = { C1: 0, C2: 0, C3: 0, C4: 0, C5: 0, C6: 0 };
            
            corriges.forEach(e => {
                for (const [comp, data] of Object.entries(e.competences)) {
                    compData[comp] = (compData[comp] || 0) + (data.pts || 0);
                    compMax[comp] = (compMax[comp] || 0) + (data.max || 0);
                }
            });
            
            const compPct = {};
            for (const comp in compData) {
                compPct[comp] = compMax[comp] > 0 ? Math.round((compData[comp] / compMax[comp]) * 100) : 0;
            }
            
            // Radar Chart
            const ctxRadar = document.getElementById('radarChart');
            if (radarChart) radarChart.destroy();
            radarChart = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: Object.keys(compPct),
                    datasets: [{
                        label: 'Ma√Ætrise (%)',
                        data: Object.values(compPct),
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        pointBackgroundColor: 'rgba(245, 158, 11, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(245, 158, 11, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Bar Chart
            const ctxBar = document.getElementById('barChart');
            if (barChart) barChart.destroy();
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: Object.keys(compPct),
                    datasets: [{
                        label: 'Ma√Ætrise (%)',
                        data: Object.values(compPct),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Line Chart (progression)
            const notes = corriges.map(e => e.note).filter(n => n !== null);
            const dates = corriges.filter(e => e.note !== null).map(e => {
                const d = new Date(e.date);
                return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            });
            
            const ctxLine = document.getElementById('lineChart');
            if (lineChart) lineChart.destroy();
            lineChart = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Note (/20)',
                        data: notes,
                        borderColor: 'rgba(245, 158, 11, 1)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20,
                            ticks: { stepSize: 5 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ONGLETS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            
            // Charger les cours si on clique sur l'onglet Cours
            if (tabName === 'cours') {
                afficherCours();
            }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.addEventListener('DOMContentLoaded', () => {
            const savedCode = localStorage.getItem('pse_user_code');
            if (savedCode) {
                document.getElementById('codeInput').value = savedCode;
                connexion();
            }
            
            document.getElementById('codeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') connexion();
            });
        });

        // Fermer modal en cliquant √† l'ext√©rieur
        document.getElementById('modalDetail').addEventListener('click', (e) => {
            if (e.target.id === 'modalDetail') fermerModal();
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SUIVI DE CLASSE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let allSuivis = [];
        let statsEleve = null;
        
        async function chargerSuivi() {
            if (!currentUserCode) return;
            
            try {
                const suiviRef = collection(db, "resultats", currentUserCode, "suivi");
                const suiviSnap = await getDocs(suiviRef);
                
                allSuivis = [];
                suiviSnap.forEach(doc => {
                    allSuivis.push({ id: doc.id, ...doc.data() });
                });
                
                allSuivis.sort((a, b) => {
                    const dateA = a.date + ' ' + (a.heure || '00:00');
                    const dateB = b.date + ' ' + (b.heure || '00:00');
                    return dateB.localeCompare(dateA);
                });
                
                const statsRef = doc(db, "resultats", currentUserCode, "stats", "suivi");
                const statsSnap = await getDoc(statsRef);
                statsEleve = statsSnap.exists() ? statsSnap.data() : null;
                
                afficherSuivi();
            } catch (error) {
                console.error("Erreur chargement suivi:", error);
            }
        }
        
        function afficherSuivi() {
            const container = document.getElementById('suiviContent');
            
            if (allSuivis.length === 0) {
                container.innerHTML = `
                    <div class="empty-suivi">
                        <div class="empty-suivi-icon">üìã</div>
                        <p>Pas encore de suivi enregistr√©</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Ton suivi de classe appara√Ætra ici.</p>
                    </div>
                `;
                return;
            }
            
            // S√©parer les pr√©sences et les absences
            const seancesPresent = allSuivis.filter(s => !s.absent);
            const seancesAbsent = allSuivis.filter(s => s.absent);
            const nbTotal = allSuivis.length;
            const nbPresent = seancesPresent.length;
            const nbAbsent = seancesAbsent.length;
            const tauxPresence = nbTotal > 0 ? Math.round((nbPresent / nbTotal) * 100) : 0;
            
            // Moyenne sur les s√©ances pr√©sentes uniquement
            const moyenne = calculerMoyenneSuivi();
            const badges = calculerBadges();
            const tendances = calculerTendances();
            
            let moyenneIcon = 'üìà';
            let moyenneClass = 'note-average-suivi';
            if (moyenne >= 18) { moyenneIcon = 'üèÜ'; moyenneClass = 'note-excellent-suivi'; }
            else if (moyenne >= 15) { moyenneIcon = '‚≠ê'; moyenneClass = 'note-good-suivi'; }
            else if (moyenne >= 12) { moyenneIcon = 'üëç'; moyenneClass = 'note-average-suivi'; }
            else if (moyenne >= 10) { moyenneIcon = 'üí™'; moyenneClass = 'note-average-suivi'; }
            else { moyenneIcon = 'üìà'; moyenneClass = 'note-poor-suivi'; }
            
            // Couleur du taux de pr√©sence
            let presenceColor = '#16a34a'; // vert
            if (tauxPresence < 70) presenceColor = '#dc2626'; // rouge
            else if (tauxPresence < 85) presenceColor = '#f59e0b'; // orange
            
            let html = `
                <div class="suivi-header">
                    <div class="suivi-stats-row">
                        <div class="suivi-moyenne">${moyenneIcon} ${moyenne}/20</div>
                        <div class="suivi-presence" style="color: ${presenceColor};">
                            üìÖ ${tauxPresence}%
                            <span style="font-size: 0.7em; display: block;">${nbPresent}/${nbTotal} s√©ances</span>
                        </div>
                    </div>
                    <div class="suivi-label">Moyenne de suivi${nbAbsent > 0 ? ` ‚Ä¢ ${nbAbsent} absence${nbAbsent > 1 ? 's' : ''}` : ''}</div>
                    ${badges.length > 0 ? `
                        <div class="suivi-badges">
                            ${badges.map(b => `<div class="suivi-badge">${b}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="tendances-grid">
                    <div class="tendance-card">
                        <div class="tendance-icon">üìù</div>
                        <div class="tendance-label">Travail</div>
                        <div class="tendance-value">${tendances.travail.pct}%<span class="tendance-arrow ${tendances.travail.dir}">${tendances.travail.arrow}</span></div>
                    </div>
                    <div class="tendance-card">
                        <div class="tendance-icon">üó£Ô∏è</div>
                        <div class="tendance-label">Oral</div>
                        <div class="tendance-value">${tendances.oral.pct}%<span class="tendance-arrow ${tendances.oral.dir}">${tendances.oral.arrow}</span></div>
                    </div>
                    <div class="tendance-card">
                        <div class="tendance-icon">üß†</div>
                        <div class="tendance-label">Attention</div>
                        <div class="tendance-value">${tendances.attention.pct}%<span class="tendance-arrow ${tendances.attention.dir}">${tendances.attention.arrow}</span></div>
                    </div>
                    <div class="tendance-card">
                        <div class="tendance-icon">üìÅ</div>
                        <div class="tendance-label">Mat√©riel</div>
                        <div class="tendance-value">${tendances.porteVue.pct}%<span class="tendance-arrow ${tendances.porteVue.dir}">${tendances.porteVue.arrow}</span></div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: #1e293b;">üìÖ Historique des s√©ances</h3>
            `;
            
            allSuivis.forEach((s, idx) => {
                const dateFormatted = formatDateSuivi(s.date);
                
                if (s.absent) {
                    // Affichage pour une absence
                    html += `
                        <div class="seance-card seance-absent">
                            <div class="seance-header">
                                <div class="seance-info">
                                    <div class="seance-date">üìÖ ${dateFormatted}</div>
                                    <div class="seance-module">${s.module || ''} - ${s.moduleTitre || ''}</div>
                                </div>
                                <div class="seance-note">
                                    <span class="seance-note-value absent">ABS</span>
                                    <span class="seance-note-icon">üö´</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Affichage normal avec note
                    const noteIcon = getNoteIconSuivi(s.noteSur20);
                    const noteClass = getNoteClassSuivi(s.noteSur20);
                    
                    html += `
                        <div class="seance-card">
                            <div class="seance-header" onclick="toggleSeanceDetail(${idx})">
                                <div class="seance-info">
                                    <div class="seance-date">üìÖ ${dateFormatted} √† ${s.heure || '--:--'}</div>
                                    <div class="seance-module">${s.module || ''} - ${s.moduleTitre || ''}</div>
                                </div>
                                <div class="seance-note">
                                    <span class="seance-note-value ${noteClass}">${s.noteSur20}/20</span>
                                    <span class="seance-note-icon">${noteIcon}</span>
                                </div>
                            </div>
                            <div class="seance-detail" id="seanceDetail${idx}">
                                ${renderSeanceDetail(s)}
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }
        
        function renderSeanceDetail(s) {
            let html = '';
            
            if (s.travail) {
                const info = getTravailInfo(s.travail);
                html += `<div class="detail-row"><span class="detail-label">üìù Travail</span><span class="detail-value ${info.cls}">${info.label}</span></div>`;
            }
            if (s.oral !== undefined && s.oral !== null) {
                const info = getOralInfo(s.oral);
                html += `<div class="detail-row"><span class="detail-label">üó£Ô∏è Oral</span><span class="detail-value ${info.cls}">${info.label}</span></div>`;
            }
            if (s.attention) {
                const info = getAttentionInfo(s.attention);
                html += `<div class="detail-row"><span class="detail-label">üß† Attention</span><span class="detail-value ${info.cls}">${info.label}</span></div>`;
            }
            if (s.porteVue) {
                const info = getPorteVueInfo(s.porteVue);
                html += `<div class="detail-row"><span class="detail-label">üìÅ Porte-vue</span><span class="detail-value ${info.cls}">${info.label}</span></div>`;
            }
            if (s.competences && s.competences.length > 0) {
                html += `<div class="detail-row"><span class="detail-label">üéØ Comp√©tences</span><span class="detail-value">${s.competences.join(', ')}</span></div>`;
            }
            
            // Distribution cours
            if (s.coursDistrib && s.coursDistrib !== 'aucun') {
                const coursLabels = {
                    'seance1': 'S√©ance 1',
                    'seance2': 'S√©ance 2',
                    'seance3': 'S√©ance 3',
                    'seance4': 'S√©ance 4',
                    'complet': 'üìö Cours complet'
                };
                const coursLabel = coursLabels[s.coursDistrib] || s.coursDistrib;
                
                if (s.absent && s.coursRecu === false) {
                    html += `<div class="detail-row"><span class="detail-label">üìÑ Cours</span><span class="detail-value" style="color: #dc2626;">‚ùå ${coursLabel} - Non re√ßu (absent)</span></div>`;
                } else {
                    html += `<div class="detail-row"><span class="detail-label">üìÑ Cours</span><span class="detail-value" style="color: #16a34a;">‚úÖ ${coursLabel} - Re√ßu</span></div>`;
                }
            }
            
            if (s.commentaire) {
                html += `<div class="seance-comment">üí¨ "${s.commentaire}"</div>`;
            }
            return html;
        }
        
        window.toggleSeanceDetail = function(idx) {
            const el = document.getElementById('seanceDetail' + idx);
            el.classList.toggle('open');
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ONGLET MES COURS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function afficherCours() {
            const container = document.getElementById('coursContent');
            
            // Filtrer les suivis qui ont une distribution de cours
            const suivisAvecCours = allSuivis.filter(s => s.coursDistrib && s.coursDistrib !== 'aucun');
            
            if (suivisAvecCours.length === 0) {
                container.innerHTML = `
                    <div class="empty-suivi">
                        <div class="empty-suivi-icon">üìÑ</div>
                        <p>Pas encore de cours distribu√©</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Les cours que tu recevras appara√Ætront ici.</p>
                    </div>
                `;
                return;
            }
            
            // Regrouper par module
            const parModule = {};
            suivisAvecCours.forEach(s => {
                const moduleKey = s.module || 'Inconnu';
                if (!parModule[moduleKey]) {
                    parModule[moduleKey] = {
                        module: s.module,
                        moduleTitre: s.moduleTitre,
                        seances: []
                    };
                }
                parModule[moduleKey].seances.push({
                    type: s.coursDistrib,
                    date: s.date,
                    recu: !(s.absent && s.coursRecu === false)
                });
            });
            
            // Compter les cours manquants
            let coursManquants = 0;
            Object.values(parModule).forEach(m => {
                m.seances.forEach(s => {
                    if (!s.recu) coursManquants++;
                });
            });
            
            // Construire le HTML
            let html = '';
            
            // Alerte si cours manquants
            if (coursManquants > 0) {
                html += `
                    <div class="cours-alerte">
                        <span class="cours-alerte-icon">‚ö†Ô∏è</span>
                        <span class="cours-alerte-text">${coursManquants} cours √† r√©cup√©rer (absence)</span>
                    </div>
                `;
            }
            
            // Labels pour les types de cours
            const coursLabels = {
                'seance1': 'S√©ance 1',
                'seance2': 'S√©ance 2',
                'seance3': 'S√©ance 3',
                'seance4': 'S√©ance 4',
                'complet': 'Cours complet'
            };
            
            // Afficher chaque module
            Object.values(parModule).forEach(m => {
                html += `
                    <div class="cours-module-card">
                        <div class="cours-module-header">
                            <div class="module-code">${m.module || 'Module'}</div>
                            <div class="module-titre">${m.moduleTitre || ''}</div>
                        </div>
                        <div class="cours-seances-list">
                `;
                
                // Trier les s√©ances par date
                m.seances.sort((a, b) => a.date.localeCompare(b.date));
                
                m.seances.forEach(s => {
                    const label = coursLabels[s.type] || s.type;
                    const icon = s.type === 'complet' ? 'üìö' : 'üìÑ';
                    const dateFormatted = formatDateSuivi(s.date);
                    
                    html += `
                        <div class="cours-seance-row">
                            <div class="cours-seance-info">
                                <span class="cours-seance-icon">${icon}</span>
                                <div>
                                    <div class="cours-seance-nom">${label}</div>
                                    <div class="cours-seance-date">${dateFormatted}</div>
                                </div>
                            </div>
                            <span class="cours-seance-status ${s.recu ? 'recu' : 'manquant'}">
                                ${s.recu ? '‚úÖ Re√ßu' : '‚ùå √Ä r√©cup√©rer'}
                            </span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function calculerMoyenneSuivi() {
            // Exclure les absences du calcul de la moyenne
            const seancesAvecNote = allSuivis.filter(s => !s.absent && s.noteSur20 !== null && s.noteSur20 !== undefined);
            if (seancesAvecNote.length === 0) return 0;
            const sum = seancesAvecNote.reduce((acc, s) => acc + (s.noteSur20 || 0), 0);
            return Math.round((sum / seancesAvecNote.length) * 10) / 10;
        }
        
        function calculerBadges() {
            const badges = [];
            if (allSuivis.length === 0) return badges;
            
            let serie = 0;
            for (const s of allSuivis) {
                if (s.travail === 'tresbien' || s.travail === 'fait') serie++;
                else break;
            }
            if (serie >= 3) badges.push('üî• ' + serie + ' s√©ances au top !');
            
            const meilleureNote = Math.max(...allSuivis.map(s => s.noteSur20 || 0));
            if (meilleureNote >= 18) badges.push('üèÜ Excellent !');
            
            if (allSuivis.length >= 3) {
                const recent = allSuivis.slice(0, 3).reduce((a, s) => a + (s.noteSur20 || 0), 0) / 3;
                const ancien = allSuivis.slice(-3).reduce((a, s) => a + (s.noteSur20 || 0), 0) / 3;
                if (recent > ancien + 2) badges.push('üìà En progression !');
            }
            
            return badges;
        }
        
        function calculerTendances() {
            const result = {
                travail: { pct: 0, arrow: '‚Üí', dir: 'stable' },
                oral: { pct: 0, arrow: '‚Üí', dir: 'stable' },
                attention: { pct: 0, arrow: '‚Üí', dir: 'stable' },
                porteVue: { pct: 0, arrow: '‚Üí', dir: 'stable' }
            };
            
            if (!statsEleve) return result;
            
            const totalTravail = (statsEleve.travail?.tresbien || 0) + (statsEleve.travail?.fait || 0) + 
                                 (statsEleve.travail?.partiel || 0) + (statsEleve.travail?.insuffisant || 0);
            if (totalTravail > 0) {
                const bon = (statsEleve.travail?.tresbien || 0) + (statsEleve.travail?.fait || 0);
                result.travail.pct = Math.round((bon / totalTravail) * 100);
            }
            
            const totalOral = (statsEleve.oral?.[0] || 0) + (statsEleve.oral?.[1] || 0) + (statsEleve.oral?.[2] || 0);
            if (totalOral > 0) {
                const bon = (statsEleve.oral?.[1] || 0) + (statsEleve.oral?.[2] || 0) * 2;
                result.oral.pct = Math.round((bon / (totalOral * 2)) * 100);
            }
            
            const totalAtt = (statsEleve.attention?.bonne || 0) + (statsEleve.attention?.moyenne || 0) + 
                             (statsEleve.attention?.insuffisante || 0);
            if (totalAtt > 0) {
                result.attention.pct = Math.round(((statsEleve.attention?.bonne || 0) / totalAtt) * 100);
            }
            
            const totalPV = (statsEleve.porteVue?.ok || 0) + (statsEleve.porteVue?.oubli || 0);
            if (totalPV > 0) {
                result.porteVue.pct = Math.round(((statsEleve.porteVue?.ok || 0) / totalPV) * 100);
            }
            
            return result;
        }
        
        function getNoteIconSuivi(note) {
            if (note >= 18) return 'üèÜ';
            if (note >= 15) return '‚≠ê';
            if (note >= 12) return 'üëç';
            if (note >= 10) return 'üí™';
            return 'üìà';
        }
        
        function getNoteClassSuivi(note) {
            if (note >= 18) return 'note-excellent-suivi';
            if (note >= 15) return 'note-good-suivi';
            if (note >= 12) return 'note-average-suivi';
            return 'note-poor-suivi';
        }
        
        function getTravailInfo(val) {
            const map = {
                'tresbien': { label: '‚úì‚úì Tr√®s bien', cls: 'good' },
                'fait': { label: '‚úì Fait', cls: 'good' },
                'partiel': { label: '‚ö†Ô∏è Partiel', cls: 'medium' },
                'insuffisant': { label: '‚ùå Non fait', cls: 'bad' }
            };
            return map[val] || { label: val, cls: '' };
        }
        
        function getOralInfo(val) {
            const map = {
                2: { label: '2 - Tr√®s bien', cls: 'good' },
                1: { label: '1 - Bien', cls: 'medium' },
                0: { label: '0 - Aucune', cls: 'bad' }
            };
            return map[val] || { label: val, cls: '' };
        }
        
        function getAttentionInfo(val) {
            const map = {
                'bonne': { label: 'üòä Bonne', cls: 'good' },
                'moyenne': { label: 'üòê Moyenne', cls: 'medium' },
                'insuffisante': { label: 'üòï Insuffisante', cls: 'bad' }
            };
            return map[val] || { label: val, cls: '' };
        }
        
        function getPorteVueInfo(val) {
            const map = {
                'ok': { label: '‚úÖ OK', cls: 'good' },
                'oubli': { label: '‚ùå Oubli√©', cls: 'bad' }
            };
            return map[val] || { label: val, cls: '' };
        }
        
        function formatDateSuivi(dateStr) {
            if (!dateStr) return '--';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
        }
    </script>
</body>
</html>
