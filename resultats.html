<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Mes R√©sultats PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; max-width: 1000px; margin: 0 auto; padding: 0; background: #f8f9fa; color: #333; min-height: 100vh; }
        
        /* === HEADER === */
        header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; text-align: center; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-weight: 700; font-size: 1.8em; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1::before { content: "üìä "; }
        
        main { padding: 20px; }
        
        /* === LOGIN SCREEN === */
        .login-screen { background: white; border-radius: 16px; padding: 40px; max-width: 400px; margin: 40px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; }
        .login-icon { font-size: 4em; margin-bottom: 20px; }
        .login-title { font-size: 1.5em; font-weight: 700; margin-bottom: 10px; color: #1e293b; }
        .login-subtitle { color: #64748b; margin-bottom: 20px; font-size: 0.95em; }
        .code-input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.2em; text-align: center; letter-spacing: 3px; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; transition: border 0.2s; }
        .code-input:focus { outline: none; border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); }
        .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .login-btn:active { transform: translateY(0); }
        .error-message { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; margin-top: 15px; display: none; border-left: 4px solid #dc2626; }
        .error-message.visible { display: block; }
        .btn-retour { background: #e2e8f0; color: #475569; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px; }
        .btn-retour:hover { background: #cbd5e1; }
        
        /* === RESULTS SCREEN === */
        .results-screen { display: none; }
        .results-screen.active { display: block; }
        
        /* === STUDENT BANNER === */
        .student-banner { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 2px 10px rgba(245, 158, 11, 0.2); }
        .student-info { display: flex; align-items: center; gap: 15px; }
        .student-name { font-size: 1.3em; font-weight: 700; }
        .student-class { background: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 8px; font-weight: 600; }
        .banner-actions { display: flex; gap: 10px; }
        .logout-btn, .btn-home { background: rgba(255,255,255,0.3); border: none; color: #78350f; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .logout-btn:hover, .btn-home:hover { background: rgba(255,255,255,0.5); }
        
        /* === STATS GRID === */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-value { font-size: 2em; font-weight: 800; color: #f59e0b; margin-bottom: 5px; }
        .stat-label { font-size: 0.85em; color: #64748b; }
        
        /* === TABS === */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: white; padding: 5px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 12px; text-align: center; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 600; color: #64748b; transition: all 0.2s; }
        .tab.active { background: #f59e0b; color: white; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); }
        .tab:hover:not(.active) { background: #fef3c7; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* === EVAL CARD === */
        .eval-card { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: all 0.2s; position: relative; overflow: hidden; }
        .eval-card::before { content: ""; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: #f59e0b; }
        .eval-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .eval-title { font-weight: 700; font-size: 1.1em; color: #1e293b; }
        .eval-meta { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .eval-date { font-size: 0.85em; color: #64748b; }
        .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 700; }
        .status-corrected { background: #dcfce7; color: #166534; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .eval-note { font-weight: 800; font-size: 1.5em; padding: 8px 20px; border-radius: 10px; }
        .note-excellent { background: #dcfce7; color: #166534; }
        .note-good { background: #dbeafe; color: #1e40af; }
        .note-average { background: #fef3c7; color: #92400e; }
        .note-poor { background: #fee2e2; color: #991b1b; }
        .note-pending { background: #e0e7ff; color: #3730a3; }
        .eval-actions { margin-top: 15px; display: flex; gap: 10px; }
        .btn-view { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-view:hover { background: #2563eb; transform: translateY(-2px); }
        .btn-view:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        
        /* === MODAL === */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .modal-title { font-size: 1.3em; font-weight: 700; }
        .modal-actions { display: flex; gap: 10px; }
        .action-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .action-btn:hover { background: rgba(255,255,255,0.3); }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.3em; font-weight: bold; transition: all 0.2s; }
        .modal-close:hover { background: rgba(255,255,255,0.4); transform: rotate(90deg); }
        .modal-body { padding: 25px; }
        
        /* === APPRECIATION BLOCK === */
        .appreciation-block { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 5px solid #f59e0b; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .appreciation-title { font-weight: 700; color: #78350f; margin-bottom: 10px; font-size: 1.1em; }
        .appreciation-title::before { content: "üí¨ "; }
        .appreciation-text { color: #78350f; line-height: 1.6; font-size: 1em; }
        
        /* === COMPETENCES SUMMARY === */
        .competences-summary { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .competences-title { font-weight: 700; color: #1e293b; margin-bottom: 15px; font-size: 1.1em; }
        .competences-title::before { content: "üéØ "; }
        .comp-list { display: grid; gap: 12px; }
        .comp-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #e2e8f0; }
        .comp-label { font-weight: 600; color: #475569; }
        .comp-result { display: flex; align-items: center; gap: 10px; }
        .comp-badge-large { padding: 6px 15px; border-radius: 20px; font-weight: 700; font-size: 0.9em; }
        .badge-M { background: #dcfce7; color: #166534; border-left-color: #22c55e !important; }
        .badge-A { background: #dbeafe; color: #1e40af; border-left-color: #3b82f6 !important; }
        .badge-I { background: #fef3c7; color: #92400e; border-left-color: #f59e0b !important; }
        .badge-NT { background: #e2e8f0; color: #475569; border-left-color: #94a3b8 !important; }
        .comp-score { font-weight: 700; color: #64748b; font-size: 0.95em; }
        
        /* === QUESTIONS DETAIL === */
        .questions-section { margin-top: 25px; }
        .section-title { font-weight: 700; color: #1e293b; margin-bottom: 20px; font-size: 1.2em; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .section-title::before { content: "üìù "; }
        .question-card { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; transition: all 0.2s; page-break-inside: avoid; }
        .question-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 15px; }
        .question-number { font-weight: 700; font-size: 1.1em; color: #f59e0b; }
        .question-competence { background: #f8fafc; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85em; color: #64748b; }
        .question-text { color: #1e293b; margin-bottom: 15px; line-height: 1.5; font-weight: 500; }
        .answer-section { background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
        .answer-label { font-weight: 600; color: #1e40af; margin-bottom: 8px; font-size: 0.9em; }
        .answer-label::before { content: "‚úçÔ∏è "; }
        .answer-text { color: #0f172a; line-height: 1.5; white-space: pre-wrap; }
        .evaluation-section { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
        .evaluation-label { font-weight: 600; color: #92400e; margin-bottom: 8px; font-size: 0.9em; }
        .evaluation-label::before { content: "üéØ "; }
        .comment-section { background: #fffbeb; border-left: 4px solid #fbbf24; padding: 15px; border-radius: 0 8px 8px 0; }
        .comment-label { font-weight: 600; color: #78350f; margin-bottom: 8px; font-size: 0.9em; }
        .comment-label::before { content: "üí¨ "; }
        .comment-text { color: #78350f; line-height: 1.5; font-style: italic; }
        .no-comment { color: #94a3b8; font-style: italic; }
        
        /* === CHARTS === */
        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chart-title { font-weight: 700; margin-bottom: 15px; color: #1e293b; }
        .chart-container { position: relative; height: 300px; }
        
        /* === PRINT STYLES === */
        @media print {
            @page { size: A4; margin: 15mm; }
            body { background: white; max-width: 100%; }
            header { background: #f59e0b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .modal-header { background: #f59e0b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .appreciation-block { background: #fffbeb !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .question-card { page-break-inside: avoid; border: 1px solid #e2e8f0; }
            .comp-badge-large, .badge-M, .badge-A, .badge-I, .badge-NT { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .answer-section { background: #f0f9ff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .evaluation-section { background: #fef3c7 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .comment-section { background: #fffbeb !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .modal-content { max-height: none; box-shadow: none; }
            .modal-body { padding: 10px; }
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            header { padding: 15px; }
            h1 { font-size: 1.3em; }
            main { padding: 15px; }
            .student-banner { flex-direction: column; text-align: center; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .tabs { flex-wrap: wrap; }
            .modal-content { max-width: 100%; border-radius: 16px 16px 0 0; max-height: 95vh; }
            .question-header { flex-direction: column; align-items: flex-start; }
        }
        
        /* === LOADING === */
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #f59e0b; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* === EMPTY STATE === */
        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
        .empty-text { font-size: 1.1em; font-weight: 600; }
    </style>
</head>
<body>
    <header class="no-print">
        <h1>Mes R√©sultats PSE</h1>
    </header>

    <!-- √âCRAN DE CONNEXION -->
    <div class="login-screen" id="loginScreen">
        <div class="login-icon">üîê</div>
        <div class="login-title">Acc√®s √âl√®ve</div>
        <div class="login-subtitle">Entre ton code personnel</div>
        <input type="text" id="codeInput" class="code-input" placeholder="CODE √âL√àVE" maxlength="12" autofocus>
        <button class="login-btn" onclick="connexion()">Se connecter</button>
        <div class="error-message" id="errorMsg">Code incorrect. V√©rifie ton code √©l√®ve.</div>
        <button class="btn-retour" onclick="window.location.href='https://preventionsanteenvironnement.github.io/PSE/'">‚¨ÖÔ∏è Retour au site PSE</button>
    </div>

    <!-- √âCRAN R√âSULTATS -->
    <div class="results-screen" id="resultsScreen">
        <main>
            <!-- Bandeau √©l√®ve -->
            <div class="student-banner no-print">
                <div class="student-info">
                    <span class="student-name" id="studentName">√âl√®ve</span>
                    <span class="student-class" id="studentClass">Classe</span>
                </div>
                <div class="banner-actions">
                    <button class="btn-home" onclick="window.location.href='https://preventionsanteenvironnement.github.io/PSE/'">üè† Site PSE</button>
                    <button class="logout-btn" onclick="deconnexion()">üö™ D√©connexion</button>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statMoyenne">--</div>
                    <div class="stat-label">Moyenne g√©n√©rale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCorriges">0</div>
                    <div class="stat-label">√âvaluations corrig√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAttente">0</div>
                    <div class="stat-label">En attente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statMeilleureComp">--</div>
                    <div class="stat-label">Meilleure comp√©tence</div>
                </div>
            </div>

            <!-- Onglets -->
            <div class="tabs no-print">
                <button class="tab active" onclick="switchTab('evaluations')">üìù Mes √©valuations</button>
                <button class="tab" onclick="switchTab('competences')">üéØ Comp√©tences</button>
                <button class="tab" onclick="switchTab('progression')">üìà Progression</button>
            </div>

            <!-- Contenu √âvaluations -->
            <div class="tab-content active" id="tabEvaluations">
                <div id="evalList"></div>
            </div>

            <!-- Contenu Comp√©tences -->
            <div class="tab-content" id="tabCompetences">
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-title">üéØ Radar des comp√©tences</div>
                        <div class="chart-container"><canvas id="radarChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">üìä Performance par comp√©tence</div>
                        <div class="chart-container"><canvas id="barChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Contenu Progression -->
            <div class="tab-content" id="tabProgression">
                <div class="chart-card">
                    <div class="chart-title">üìà √âvolution des notes</div>
                    <div class="chart-container"><canvas id="lineChart"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL D√âTAIL COPIE -->
    <div class="modal-overlay" id="modalDetail">
        <div class="modal-content" id="printableArea">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">D√©tail de la copie</div>
                <div class="modal-actions no-print">
                    <button class="action-btn" onclick="imprimerCopie()">üñ®Ô∏è Imprimer</button>
                    <button class="modal-close" onclick="fermerModal()">√ó</button>
                </div>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.appspot.com",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUserCode = null;
        let allEvaluations = [];
        let radarChart, barChart, lineChart;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONNEXION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.connexion = async function() {
            const code = document.getElementById('codeInput').value.trim().toUpperCase();
            if (!code) return;

            try {
                console.log("üîê Connexion avec code:", code);
                
                // Chercher des copies avec ce code √©l√®ve
                const qCopies = query(collectionGroup(db, "copies"), where("eleveCode", "==", code));
                const snapCopies = await getDocs(qCopies);
                
                if (snapCopies.empty) {
                    document.getElementById('errorMsg').textContent = "Aucune √©valuation trouv√©e pour ce code. V√©rifie ton code ou contacte ton professeur.";
                    document.getElementById('errorMsg').classList.add('visible');
                    return;
                }

                currentUserCode = code;
                localStorage.setItem('pse_user_code', code);
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('resultsScreen').classList.add('active');
                
                await chargerDonnees();
                
            } catch (e) {
                console.error("‚ùå Erreur connexion:", e);
                alert("Erreur: " + e.message);
            }
        };

        window.deconnexion = function() {
            localStorage.removeItem('pse_user_code');
            location.reload();
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHARGEMENT DONN√âES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function chargerDonnees() {
            console.log("üìÇ Chargement pour:", currentUserCode);
            
            try {
                // √âTAPE 1 : Charger les COPIES
                const qCopies = query(
                    collectionGroup(db, "copies"),
                    where("eleveCode", "==", currentUserCode)
                );
                const snapCopies = await getDocs(qCopies);
                
                // √âTAPE 2 : Charger les √âVALUATIONS
                const qEvals = query(
                    collectionGroup(db, "evaluations"),
                    where("eleveCode", "==", currentUserCode)
                );
                const snapEvals = await getDocs(qEvals);
                
                // Cr√©er une Map des √©valuations par devoirId
                const evalsMap = new Map();
                snapEvals.forEach(doc => {
                    const evalData = doc.data();
                    evalsMap.set(evalData.devoirId, evalData);
                });
                
                // √âTAPE 3 : FUSIONNER copies + √©valuations
                allEvaluations = [];
                snapCopies.forEach(docSnap => {
                    const copie = docSnap.data();
                    const evaluation = evalsMap.get(copie.devoirId);
                    
                    allEvaluations.push({
                        id: docSnap.id,
                        copie: copie,
                        evaluation: evaluation,
                        estCorrige: !!evaluation,
                        devoirId: copie.devoirId,
                        titre: copie.titre || "Devoir",
                        date: copie.createdAtISO || copie.createdAt?.toDate?.() || new Date(),
                        note: evaluation?.note_finale ?? null,
                        appreciation: evaluation?.appreciation || "",
                        competences: evaluation?.competences || {},
                        questions: evaluation?.questions || {},
                        reponses: copie.reponses || {}
                    });
                });
                
                // Trier par date d√©croissante
                allEvaluations.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log("‚úÖ Donn√©es charg√©es:", allEvaluations.length, "√©valuations");
                
                // Mettre √† jour l'interface
                afficherInfosEleve();
                afficherStatistiques();
                afficherListeEvaluations();
                creerGraphiques();
                
            } catch (e) {
                console.error("‚ùå Erreur chargement:", e);
                alert("Erreur: " + e.message);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AFFICHAGE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function afficherInfosEleve() {
            if (allEvaluations.length === 0) return;
            
            const premier = allEvaluations[0];
            const eleve = premier.copie.eleve;
            
            const nom = eleve?.nom || currentUserCode;
            const prenom = eleve?.prenom || "";
            const classe = eleve?.classe || "?";
            
            document.getElementById('studentName').textContent = `${prenom} ${nom}`.trim() || currentUserCode;
            document.getElementById('studentClass').textContent = classe;
        }

        function afficherStatistiques() {
            const corriges = allEvaluations.filter(e => e.estCorrige);
            const attente = allEvaluations.filter(e => !e.estCorrige);
            
            // Moyenne
            const notes = corriges.filter(e => e.note !== null).map(e => e.note);
            const moyenne = notes.length > 0 ? (notes.reduce((a, b) => a + b, 0) / notes.length).toFixed(1) : "--";
            
            // Meilleure comp√©tence
            const compStats = {};
            corriges.forEach(e => {
                for (const [comp, data] of Object.entries(e.competences)) {
                    if (!compStats[comp]) compStats[comp] = { total: 0, max: 0 };
                    compStats[comp].total += data.pts || 0;
                    compStats[comp].max += data.max || 0;
                }
            });
            
            let meilleureComp = "--";
            let meilleurPct = 0;
            for (const [comp, data] of Object.entries(compStats)) {
                if (data.max > 0) {
                    const pct = (data.total / data.max) * 100;
                    if (pct > meilleurPct) {
                        meilleurPct = pct;
                        meilleureComp = comp;
                    }
                }
            }
            
            document.getElementById('statMoyenne').textContent = moyenne + (moyenne !== "--" ? "/20" : "");
            document.getElementById('statCorriges').textContent = corriges.length;
            document.getElementById('statAttente').textContent = attente.length;
            document.getElementById('statMeilleureComp').textContent = meilleureComp;
        }

        function afficherListeEvaluations() {
            const container = document.getElementById('evalList');
            
            if (allEvaluations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-text">Aucune √©valuation pour le moment</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allEvaluations.map(item => {
                const dateStr = item.date instanceof Date ? item.date.toLocaleDateString('fr-FR') : 
                               typeof item.date === 'string' ? new Date(item.date).toLocaleDateString('fr-FR') : '--';
                
                const statusBadge = item.estCorrige ? 
                    '<span class="status-badge status-corrected">‚úì Corrig√©</span>' :
                    '<span class="status-badge status-pending">‚è≥ En attente</span>';
                
                let noteClass = 'note-pending';
                let noteText = '--';
                if (item.note !== null) {
                    noteText = item.note.toFixed(1) + '/20';
                    if (item.note >= 16) noteClass = 'note-excellent';
                    else if (item.note >= 12) noteClass = 'note-good';
                    else if (item.note >= 10) noteClass = 'note-average';
                    else noteClass = 'note-poor';
                }
                
                return `
                    <div class="eval-card">
                        <div class="eval-header">
                            <div>
                                <div class="eval-title">${item.titre}</div>
                                <div class="eval-meta">
                                    <span class="eval-date">üìÖ ${dateStr}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                            <div class="eval-note ${noteClass}">${noteText}</div>
                        </div>
                        <div class="eval-actions">
                            <button class="btn-view" onclick="ouvrirDetail('${item.id}')" ${!item.estCorrige ? 'disabled' : ''}>
                                üëÅÔ∏è ${item.estCorrige ? 'Voir ma copie corrig√©e' : 'Correction en cours...'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MODAL D√âTAIL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.ouvrirDetail = async function(evalId) {
            const evaluation = allEvaluations.find(e => e.id === evalId);
            if (!evaluation || !evaluation.estCorrige) return;
            
            console.log("üìÑ Ouverture d√©tail:", evaluation.devoirId);
            
            // Charger le blueprint
            let blueprint = null;
            try {
                const resp = await fetch(`${evaluation.devoirId}_blueprint.json?ts=${Date.now()}`, { cache: "no-store" });
                if (resp.ok) blueprint = await resp.json();
            } catch (e) {
                console.warn("‚ö†Ô∏è Blueprint non trouv√©:", e);
            }
            
            // Construire le HTML
            const modalTitle = `${evaluation.titre} - ${evaluation.note.toFixed(1)}/20`;
            document.getElementById('modalTitle').textContent = modalTitle;
            
            let html = '';
            
            // Appr√©ciation g√©n√©rale
            if (evaluation.appreciation) {
                html += `
                    <div class="appreciation-block">
                        <div class="appreciation-title">Appr√©ciation g√©n√©rale du professeur</div>
                        <div class="appreciation-text">${evaluation.appreciation}</div>
                    </div>
                `;
            }
            
            // Comp√©tences
            if (Object.keys(evaluation.competences).length > 0) {
                html += `
                    <div class="competences-summary">
                        <div class="competences-title">R√©sum√© de tes comp√©tences</div>
                        <div class="comp-list">
                `;
                
                const compLabels = {
                    C1: "Mobiliser des connaissances",
                    C2: "Analyser la situation",
                    C3: "Identifier les dangers",
                    C4: "Proposer des mesures de pr√©vention",
                    C5: "Justifier ses choix",
                    C6: "Communication professionnelle"
                };
                
                for (const [comp, data] of Object.entries(evaluation.competences)) {
                    const pts = data.pts || 0;
                    const max = data.max || 0;
                    const pct = max > 0 ? Math.round((pts / max) * 100) : 0;
                    
                    // D√©terminer le niveau global
                    let niveau = "NT";
                    if (pct >= 80) niveau = "M";
                    else if (pct >= 60) niveau = "A";
                    else if (pct > 0) niveau = "I";
                    
                    html += `
                        <div class="comp-item badge-${niveau}">
                            <div class="comp-label">${comp} - ${compLabels[comp] || comp}</div>
                            <div class="comp-result">
                                <span class="comp-badge-large badge-${niveau}">${niveau}</span>
                                <span class="comp-score">${pts}/${max}</span>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Questions d√©taill√©es
            html += `
                <div class="questions-section">
                    <div class="section-title">D√©tail de ta copie</div>
            `;
            
            // Extraire les questions du blueprint
            let questions = [];
            if (blueprint) {
                if (Array.isArray(blueprint.questions)) {
                    questions = blueprint.questions;
                } else if (Array.isArray(blueprint.content)) {
                    questions = blueprint.content.filter(item => item.type === "question");
                }
            }
            
            if (questions.length > 0) {
                questions.forEach((q, idx) => {
                    const qid = q.qid || q.id || `q_${idx}`;
                    const label = q.label || `Q${idx + 1}`;
                    const questionText = q.questionText || "Question";
                    const competence = q.competence || "";
                    
                    // Chercher la r√©ponse avec plusieurs cl√©s possibles
                    let reponse = evaluation.reponses[qid] || 
                                 evaluation.reponses[label] || 
                                 evaluation.reponses[`Q${label}`] ||
                                 evaluation.reponses[`q_${idx}`] ||
                                 "<i>Non r√©pondu</i>";
                    
                    if (Array.isArray(reponse)) {
                        reponse = reponse.join(' ‚Ä¢ ');
                    }
                    
                    // R√©cup√©rer l'√©valuation de cette question
                    const questionEval = evaluation.questions[qid] || evaluation.questions[label] || {};
                    const niveau = questionEval.level || "NT";
                    const commentaire = questionEval.comment || "";
                    
                    const niveauLabels = {
                        M: "üü¢ Ma√Ætris√©",
                        A: "üîµ Acceptable",
                        I: "üü† Insuffisant",
                        NT: "‚ö™ Non Trait√©"
                    };
                    
                    html += `
                        <div class="question-card">
                            <div class="question-header">
                                <div class="question-number">Question ${idx + 1}</div>
                                ${competence ? `<div class="question-competence">${competence}</div>` : ''}
                            </div>
                            <div class="question-text">${questionText}</div>
                            
                            <div class="answer-section">
                                <div class="answer-label">Ta r√©ponse</div>
                                <div class="answer-text">${reponse}</div>
                            </div>
                            
                            <div class="evaluation-section">
                                <div class="evaluation-label">√âvaluation</div>
                                <div class="answer-text"><strong>${niveauLabels[niveau] || niveau}</strong></div>
                            </div>
                            
                            ${commentaire ? `
                                <div class="comment-section">
                                    <div class="comment-label">Commentaire du professeur</div>
                                    <div class="comment-text">${commentaire}</div>
                                </div>
                            ` : '<div class="no-comment">Pas de commentaire</div>'}
                        </div>
                    `;
                });
            } else {
                html += `<div class="empty-state"><div class="empty-text">D√©tails non disponibles</div></div>`;
            }
            
            html += `</div>`;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalDetail').classList.add('active');
        };

        window.fermerModal = function() {
            document.getElementById('modalDetail').classList.remove('active');
        };

        window.imprimerCopie = function() {
            window.print();
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRAPHIQUES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function creerGraphiques() {
            const corriges = allEvaluations.filter(e => e.estCorrige);
            if (corriges.length === 0) return;
            
            // Donn√©es comp√©tences
            const compData = { C1: 0, C2: 0, C3: 0, C4: 0, C5: 0, C6: 0 };
            const compMax = { C1: 0, C2: 0, C3: 0, C4: 0, C5: 0, C6: 0 };
            
            corriges.forEach(e => {
                for (const [comp, data] of Object.entries(e.competences)) {
                    compData[comp] = (compData[comp] || 0) + (data.pts || 0);
                    compMax[comp] = (compMax[comp] || 0) + (data.max || 0);
                }
            });
            
            const compPct = {};
            for (const comp in compData) {
                compPct[comp] = compMax[comp] > 0 ? Math.round((compData[comp] / compMax[comp]) * 100) : 0;
            }
            
            // Radar Chart
            const ctxRadar = document.getElementById('radarChart');
            if (radarChart) radarChart.destroy();
            radarChart = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: Object.keys(compPct),
                    datasets: [{
                        label: 'Ma√Ætrise (%)',
                        data: Object.values(compPct),
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        pointBackgroundColor: 'rgba(245, 158, 11, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(245, 158, 11, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Bar Chart
            const ctxBar = document.getElementById('barChart');
            if (barChart) barChart.destroy();
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: Object.keys(compPct),
                    datasets: [{
                        label: 'Ma√Ætrise (%)',
                        data: Object.values(compPct),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Line Chart (progression)
            const notes = corriges.map(e => e.note).filter(n => n !== null);
            const dates = corriges.filter(e => e.note !== null).map(e => {
                const d = new Date(e.date);
                return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            });
            
            const ctxLine = document.getElementById('lineChart');
            if (lineChart) lineChart.destroy();
            lineChart = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Note (/20)',
                        data: notes,
                        borderColor: 'rgba(245, 158, 11, 1)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20,
                            ticks: { stepSize: 5 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ONGLETS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.addEventListener('DOMContentLoaded', () => {
            const savedCode = localStorage.getItem('pse_user_code');
            if (savedCode) {
                document.getElementById('codeInput').value = savedCode;
                connexion();
            }
            
            document.getElementById('codeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') connexion();
            });
        });

        // Fermer modal en cliquant √† l'ext√©rieur
        document.getElementById('modalDetail').addEventListener('click', (e) => {
            if (e.target.id === 'modalDetail') fermerModal();
        });
    </script>
</body>
</html>
