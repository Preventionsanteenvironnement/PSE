<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes R√©sultats PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* === √âCRAN CONNEXION === */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fbbf24 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            text-align: center;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-muted);
            margin-bottom: 32px;
            font-size: 0.95rem;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            text-align: center;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-msg {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.9rem;
            display: none;
        }

        /* === √âCRAN R√âSULTATS === */
        .results-screen {
            display: none;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .user-info h1 {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .user-info p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-header {
            padding: 10px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: var(--primary);
        }

        /* Dashboard grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        .widget {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
        }

        .widget-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
        }

        .chart-container {
            height: 280px;
            position: relative;
        }

        /* Liste √©valuations */
        .eval-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .eval-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eval-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateX(4px);
        }

        .eval-status {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .eval-status.corrected {
            background: #dcfce7;
        }

        .eval-status.pending {
            background: #fef3c7;
        }

        .eval-info {
            flex: 1;
            min-width: 0;
        }

        .eval-title {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .eval-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .eval-note {
            text-align: right;
        }

        .note-value {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .note-value.good { color: var(--success); }
        .note-value.average { color: var(--warning); }
        .note-value.low { color: var(--danger); }

        .note-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        /* Modale d√©tail */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-card {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .close-modal {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 24px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .detail-item {
            background: var(--bg);
            padding: 16px;
            border-radius: 10px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .question-item {
            background: var(--bg);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .question-num {
            font-weight: 700;
            color: var(--primary);
        }

        .question-score {
            font-weight: 700;
        }

        .question-reponse {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .question-commentaire {
            font-size: 0.85rem;
            color: var(--text);
            padding: 10px;
            background: #fef3c7;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        /* Print styles */
        @media print {
            .header-actions, .btn-header, .close-modal { display: none !important; }
            .header { position: relative; }
            .modal-overlay { display: block !important; position: relative; background: none; }
            .modal-card { box-shadow: none; max-height: none; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .login-card { padding: 24px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 1.5rem; }
            .eval-card { flex-direction: column; text-align: center; }
            .eval-note { text-align: center; }
            .detail-grid { grid-template-columns: 1fr; }
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- √âCRAN CONNEXION -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">üìä</div>
            <h2 class="login-title">Mes R√©sultats</h2>
            <p class="login-subtitle">Entre ton code √©l√®ve pour acc√©der √† tes notes et √©valuations</p>
            
            <div class="input-group">
                <label>Code √©l√®ve</label>
                <input type="text" id="codeInput" placeholder="ABC123" maxlength="10" autocomplete="off">
            </div>
            
            <button class="login-btn" id="loginBtn" onclick="connexion()">
                Voir mes r√©sultats ‚Üí
            </button>
            
            <div class="error-msg" id="errorMsg"></div>
        </div>
    </div>

    <!-- √âCRAN R√âSULTATS -->
    <div class="results-screen" id="resultsScreen">
        <header class="header">
            <div class="header-content">
                <div class="user-info">
                    <h1 id="userName">Bienvenue</h1>
                    <p id="userClass">Classe</p>
                </div>
                <div class="header-actions">
                    <button class="btn-header" onclick="window.print()">
                        üñ®Ô∏è Imprimer
                    </button>
                    <button class="btn-header" onclick="partagerResultats()">
                        üì§ Partager
                    </button>
                    <button class="btn-header" onclick="deconnexion()">
                        üö™ Quitter
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card highlight">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="statMoyenne">--</div>
                    <div class="stat-label">Moyenne g√©n√©rale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-value" id="statNbEvals">0</div>
                    <div class="stat-label">√âvaluations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="statEnAttente">0</div>
                    <div class="stat-label">En attente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="statMeilleure">--</div>
                    <div class="stat-label">Meilleure note</div>
                </div>
            </div>

            <!-- Graphiques -->
            <div class="dashboard-grid">
                <div class="widget">
                    <h3 class="widget-title">üìä Radar des comp√©tences</h3>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
                <div class="widget">
                    <h3 class="widget-title">üìà Progression</h3>
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Liste √©valuations -->
            <div class="widget">
                <h3 class="widget-title">üìã Mes √©valuations</h3>
                <div class="eval-list" id="evalList">
                    <div class="loading">
                        <div class="spinner"></div>
                        Chargement...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALE D√âTAIL -->
    <div class="modal-overlay" id="modalDetail">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="modalTitle">D√©tail de l'√©valuation</h2>
                <button class="close-modal" onclick="fermerModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { 
            getFirestore, collection, query, where, getDocs, getDoc, doc, limit, orderBy 
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.appspot.com",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let currentUser = null;
        let allEvaluations = [];
        let allCopies = [];
        let radarChart = null;
        let progressChart = null;

        // Connexion
        window.connexion = async function() {
            const code = document.getElementById('codeInput').value.trim().toUpperCase();
            const errorEl = document.getElementById('errorMsg');
            const btn = document.getElementById('loginBtn');
            
            if (!code || code.length < 3) {
                errorEl.textContent = "Entre un code valide (minimum 3 caract√®res)";
                errorEl.style.display = 'block';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = "Chargement...";
            errorEl.style.display = 'none';
            
            try {
                // 1. Chercher l'√©l√®ve dans l'annuaire
                const annuaireRef = doc(db, "annuaire", code);
                const annuaireSnap = await getDoc(annuaireRef);
                
                if (annuaireSnap.exists()) {
                    const userData = annuaireSnap.data();
                    currentUser = {
                        code: code,
                        prenom: userData.prenom || code,
                        nom: userData.nom || "",
                        classe: userData.classe || "Classe"
                    };
                } else {
                    // Si pas dans l'annuaire, v√©rifier s'il y a des donn√©es
                    currentUser = {
                        code: code,
                        prenom: code,
                        nom: "",
                        classe: "√âl√®ve"
                    };
                }
                
                // 2. Charger les r√©sultats
                await chargerResultats(code);
                
                // 3. Afficher l'√©cran r√©sultats
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('resultsScreen').style.display = 'block';
                document.getElementById('userName').textContent = 
                    currentUser.prenom + (currentUser.nom ? " " + currentUser.nom : "");
                document.getElementById('userClass').textContent = currentUser.classe;
                
                // Sauvegarder le code
                localStorage.setItem('pse_user_code', code);
                
            } catch (error) {
                console.error("Erreur:", error);
                errorEl.textContent = "Erreur de connexion. V√©rifie ton code.";
                errorEl.style.display = 'block';
            }
            
            btn.disabled = false;
            btn.textContent = "Voir mes r√©sultats ‚Üí";
        };

        // Charger r√©sultats
        async function chargerResultats(code) {
            allEvaluations = [];
            allCopies = [];
            
            try {
                // 1. Charger les √©valuations (copies corrig√©es)
                const evalRef = collection(db, "resultats", code, "evaluations");
                const evalSnap = await getDocs(query(evalRef, limit(50)));
                
                evalSnap.forEach(docSnap => {
                    const data = docSnap.data();
                    allEvaluations.push({
                        id: docSnap.id,
                        ...data,
                        type: 'evaluation'
                    });
                });
                
                // 2. Charger les copies en attente
                const copiesRef = collection(db, "resultats", code, "copies");
                const copiesSnap = await getDocs(query(copiesRef, limit(50)));
                
                copiesSnap.forEach(docSnap => {
                    const data = docSnap.data();
                    // V√©rifier si pas d√©j√† dans evaluations
                    const hasEval = allEvaluations.some(e => 
                        e.devoirId === data.devoirId || e.id === docSnap.id + "_eval"
                    );
                    if (!hasEval) {
                        allCopies.push({
                            id: docSnap.id,
                            ...data,
                            type: 'copie'
                        });
                    }
                });
                
            } catch (error) {
                console.error("Erreur chargement:", error);
            }
            
            // Mettre √† jour l'affichage
            afficherStats();
            afficherEvaluations();
            dessinerGraphiques();
        }

        // Afficher statistiques
        function afficherStats() {
            let totalNotes = 0;
            let nbNotes = 0;
            let meilleureNote = 0;
            
            allEvaluations.forEach(ev => {
                const note = ev.note_finale ?? ev.note ?? ev.resultat_auto?.score;
                if (note !== undefined && note !== null && !isNaN(note)) {
                    totalNotes += parseFloat(note);
                    nbNotes++;
                    if (parseFloat(note) > meilleureNote) {
                        meilleureNote = parseFloat(note);
                    }
                }
            });
            
            const moyenne = nbNotes > 0 ? (totalNotes / nbNotes).toFixed(1) : "--";
            
            document.getElementById('statMoyenne').textContent = moyenne !== "--" ? moyenne + "/20" : "--";
            document.getElementById('statNbEvals').textContent = nbNotes;
            document.getElementById('statEnAttente').textContent = allCopies.length;
            document.getElementById('statMeilleure').textContent = meilleureNote > 0 ? meilleureNote + "/20" : "--";
        }

        // Afficher liste √©valuations
        function afficherEvaluations() {
            const container = document.getElementById('evalList');
            
            // Combiner et trier
            const allItems = [...allEvaluations, ...allCopies].sort((a, b) => {
                const dateA = a.createdAt?.toDate?.() || new Date(a.date || a.createdAtISO || 0);
                const dateB = b.createdAt?.toDate?.() || new Date(b.date || b.createdAtISO || 0);
                return dateB - dateA;
            });
            
            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>Aucune √©valuation pour le moment</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            allItems.forEach((item, index) => {
                const isEval = item.type === 'evaluation';
                const note = item.note_finale ?? item.note ?? item.resultat_auto?.score ?? item.note_auto;
                const titre = item.titre || item.devoirId || "√âvaluation";
                
                let dateStr = "-";
                if (item.createdAt?.toDate) {
                    dateStr = item.createdAt.toDate().toLocaleDateString('fr-FR');
                } else if (item.date) {
                    dateStr = new Date(item.date).toLocaleDateString('fr-FR');
                } else if (item.createdAtISO) {
                    dateStr = new Date(item.createdAtISO).toLocaleDateString('fr-FR');
                }
                
                let noteClass = '';
                let noteStr = '--';
                if (note !== undefined && note !== null && !isNaN(note)) {
                    const noteVal = parseFloat(note);
                    noteStr = noteVal.toFixed(1);
                    if (noteVal >= 14) noteClass = 'good';
                    else if (noteVal >= 10) noteClass = 'average';
                    else noteClass = 'low';
                }
                
                html += `
                    <div class="eval-card" onclick="ouvrirDetail(${index})">
                        <div class="eval-status ${isEval ? 'corrected' : 'pending'}">
                            ${isEval ? '‚úÖ' : '‚è≥'}
                        </div>
                        <div class="eval-info">
                            <div class="eval-title">${titre}</div>
                            <div class="eval-meta">
                                ${dateStr} ‚Ä¢ 
                                <span class="badge ${isEval ? 'badge-success' : 'badge-warning'}">
                                    ${isEval ? 'Corrig√©' : 'En attente'}
                                </span>
                            </div>
                        </div>
                        <div class="eval-note">
                            <div class="note-value ${noteClass}">${noteStr}</div>
                            <div class="note-label">/20</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Stocker pour acc√®s dans ouvrirDetail
            window.allItems = allItems;
        }

        // Dessiner graphiques
        function dessinerGraphiques() {
            dessinerRadar();
            dessinerProgression();
        }

        function dessinerRadar() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            // Calculer moyennes par comp√©tence
            let sums = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};
            let counts = {C1:0, C2:0, C3:0, C4:0, C5:0, C6:0};
            
            allEvaluations.forEach(ev => {
                const comp = ev.competences || ev.resultat_auto?.competences || {};
                for (let key in comp) {
                    const k = key.substring(0, 2).toUpperCase();
                    if (sums[k] !== undefined && comp[key] !== null) {
                        sums[k] += parseFloat(comp[key]) || 0;
                        counts[k]++;
                    }
                }
            });
            
            const data = [
                counts.C1 ? sums.C1/counts.C1 : 0,
                counts.C2 ? sums.C2/counts.C2 : 0,
                counts.C3 ? sums.C3/counts.C3 : 0,
                counts.C4 ? sums.C4/counts.C4 : 0,
                counts.C5 ? sums.C5/counts.C5 : 0,
                counts.C6 ? sums.C6/counts.C6 : 0
            ];
            
            if (radarChart) radarChart.destroy();
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['C1 Traiter', 'C2 Analyser', 'C3 Expliquer', 'C4 Proposer', 'C5 Argumenter', 'C6 Communiquer'],
                    datasets: [{
                        label: 'Mes comp√©tences',
                        data: data,
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        pointBackgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 3,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function dessinerProgression() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            // Trier par date et extraire notes
            const sorted = [...allEvaluations]
                .filter(ev => {
                    const note = ev.note_finale ?? ev.note ?? ev.resultat_auto?.score;
                    return note !== undefined && note !== null && !isNaN(note);
                })
                .sort((a, b) => {
                    const dateA = a.createdAt?.toDate?.() || new Date(a.date || a.createdAtISO || 0);
                    const dateB = b.createdAt?.toDate?.() || new Date(b.date || b.createdAtISO || 0);
                    return dateA - dateB;
                });
            
            const labels = sorted.map((ev, i) => {
                const titre = ev.titre || ev.devoirId || `Eval ${i+1}`;
                return titre.substring(0, 15);
            });
            
            const notes = sorted.map(ev => {
                const note = ev.note_finale ?? ev.note ?? ev.resultat_auto?.score;
                return parseFloat(note);
            });
            
            if (progressChart) progressChart.destroy();
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.length ? labels : ['Aucune donn√©e'],
                    datasets: [{
                        label: 'Notes',
                        data: notes.length ? notes : [0],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 6,
                        pointBackgroundColor: '#10b981'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Ouvrir d√©tail
        window.ouvrirDetail = function(index) {
            const item = window.allItems[index];
            if (!item) return;
            
            const isEval = item.type === 'evaluation';
            const titre = item.titre || item.devoirId || "√âvaluation";
            const note = item.note_finale ?? item.note ?? item.resultat_auto?.score ?? '--';
            const appreciation = item.appreciation || item.commentaire_general || "";
            
            document.getElementById('modalTitle').textContent = titre;
            
            let html = '';
            
            // Infos g√©n√©rales
            html += `
                <div class="detail-section">
                    <h3>üìã Informations</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Note</div>
                            <div class="detail-value" style="color: ${parseFloat(note) >= 10 ? '#10b981' : '#ef4444'};">
                                ${note !== '--' ? note + '/20' : 'En attente'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Statut</div>
                            <div class="detail-value">${isEval ? '‚úÖ Corrig√©' : '‚è≥ En attente'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Appr√©ciation
            if (appreciation) {
                html += `
                    <div class="detail-section">
                        <h3>üí¨ Appr√©ciation</h3>
                        <div class="question-commentaire">${appreciation}</div>
                    </div>
                `;
            }
            
            // Comp√©tences
            const comp = item.competences || item.resultat_auto?.competences || {};
            if (Object.keys(comp).length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>üéØ Comp√©tences √©valu√©es</h3>
                        <div class="detail-grid">
                `;
                for (let key in comp) {
                    const val = comp[key];
                    html += `
                        <div class="detail-item">
                            <div class="detail-label">${key}</div>
                            <div class="detail-value">${val !== null ? val + '/3' : '-'}</div>
                        </div>
                    `;
                }
                html += `</div></div>`;
            }
            
            // D√©tail questions
            const corrections = item.corrections || item.resultat_auto?.corrections || {};
            if (Object.keys(corrections).length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>üìù D√©tail par question</h3>
                `;
                for (let qNum in corrections) {
                    const q = corrections[qNum];
                    const reponse = item.reponses?.[qNum] || '-';
                    html += `
                        <div class="question-item">
                            <div class="question-header">
                                <span class="question-num">Question ${qNum}</span>
                                <span class="question-score">${q.points ?? '-'} pts</span>
                            </div>
                            <div class="question-reponse">
                                <strong>Ma r√©ponse:</strong> ${reponse}
                            </div>
                            ${q.commentaire ? `<div class="question-commentaire">${q.commentaire}</div>` : ''}
                        </div>
                    `;
                }
                html += `</div>`;
            }
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalDetail').classList.add('active');
        };

        // Fermer modale
        window.fermerModal = function() {
            document.getElementById('modalDetail').classList.remove('active');
        };

        // Fermer en cliquant dehors
        document.getElementById('modalDetail').addEventListener('click', function(e) {
            if (e.target === this) fermerModal();
        });

        // Partager
        window.partagerResultats = function() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: 'Mes r√©sultats PSE',
                    text: `Mes r√©sultats en PSE - Moyenne: ${document.getElementById('statMoyenne').textContent}`,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Lien copi√© dans le presse-papier !');
                });
            }
        };

        // D√©connexion
        window.deconnexion = function() {
            localStorage.removeItem('pse_user_code');
            currentUser = null;
            allEvaluations = [];
            allCopies = [];
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('codeInput').value = '';
        };

        // Auto-connexion si code sauvegard√©
        window.addEventListener('DOMContentLoaded', () => {
            const savedCode = localStorage.getItem('pse_user_code');
            if (savedCode) {
                document.getElementById('codeInput').value = savedCode;
                connexion();
            }
            
            // Enter pour se connecter
            document.getElementById('codeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') connexion();
            });
        });
    </script>
</body>
</html>
