<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>La Tour du Sommeil - Ã‰cran Prof</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #0f2027; background: linear-gradient(to right, #2c5364, #203a43, #0f2027); font-family: sans-serif; }
        #score-panel { position: absolute; top: 20px; left: 20px; color: white; font-size: 24px; z-index: 100; pointer-events: none; }
        #reset-btn { position: absolute; top: 20px; right: 20px; padding: 10px 20px; background: #e74c3c; color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; z-index: 100; }
        h1 { text-align: center; color: white; margin-top: 10px; pointer-events: none; }
    </style>
</head>
<body>

    <h1>ğŸŒ™ La Tour du Sommeil ğŸ’¤</h1>
    <div id="score-panel">Blocs posÃ©s : <span id="bloc-count">0</span></div>
    <button id="reset-btn" onclick="resetGame()">ğŸ—‘ï¸ TOUT EFFACER</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // VOTRE CONFIGURATION FIREBASE (La bonne !)
        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.firebasestorage.app",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55",
            measurementId: "G-7R9N0JL6GG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const collectionName = "tetris_sommeil";

        // --- MOTEUR PHYSIQUE (Matter.js) ---
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite;

        const engine = Engine.create();
        const world = engine.world;
        const width = window.innerWidth;
        const height = window.innerHeight;

        const render = Render.create({
            element: document.body,
            engine: engine,
            options: { width: width, height: height, wireframes: false, background: 'transparent' }
        });

        // CrÃ©ation du sol et des murs invisibles
        const ground = Bodies.rectangle(width / 2, height, width, 60, { isStatic: true, render: { fillStyle: '#222' } });
        const wallLeft = Bodies.rectangle(0, height / 2, 50, height, { isStatic: true, render: { visible: false } });
        const wallRight = Bodies.rectangle(width, height / 2, 50, height, { isStatic: true, render: { visible: false } });
        
        Composite.add(world, [ground, wallLeft, wallRight]);
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // --- ECOUTE FIREBASE (Temps RÃ©el) ---
        let count = 0;
        // On Ã©coute les ajouts rÃ©cents
        const q = query(collection(db, collectionName), orderBy("timestamp", "asc"));

        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    // On vÃ©rifie que c'est un bloc rÃ©cent (pour Ã©viter de recharger tout l'historique au refresh)
                    // (Ici on simplifie : on charge tout ce qui est dans la base)
                    ajouterBloc(data.color, data.user);
                }
            });
        });

        function ajouterBloc(color, userName) {
            count++;
            document.getElementById("bloc-count").innerText = count;

            // Position alÃ©atoire en haut
            const x = Math.random() * (width - 100) + 50;
            const size = 50 + Math.random() * 30; // Taille variable

            const box = Bodies.rectangle(x, -50, size, size, {
                restitution: 0.5, // Rebondit un peu
                render: { fillStyle: color, strokeStyle: 'white', lineWidth: 2 }
            });
            Composite.add(world, box);
        }

        // --- GESTION PROF ---
        window.resetGame = async function() {
            if(confirm("Voulez-vous dÃ©truire la tour et recommencer ?")) {
                const qSnap = await getDocs(collection(db, collectionName));
                qSnap.forEach((doc) => deleteDoc(doc.ref));
                location.reload(); // On recharge la page pour nettoyer l'Ã©cran
            }
        }
    </script>
</body>
</html>
