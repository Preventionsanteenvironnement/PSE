<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuage de Mots - Classe</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f0f2f5; margin: 0; padding: 20px; }
        
        /* Zone de saisie (√âl√®ve) */
        .input-zone { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto 30px auto; }
        
        /* Consignes */
        h1 { color: #333; margin-bottom: 10px; }
        .instructions { color: #555; font-size: 0.95em; margin-bottom: 20px; line-height: 1.4; }
        .warning { color: #d9534f; font-weight: bold; font-size: 0.85em; display: block; margin-top: 5px; }

        input[type="text"] { width: 70%; padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: #007bff; }
        
        button.send { padding: 12px 25px; font-size: 18px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-left: 10px; }
        button.send:hover { background-color: #0056b3; }

        /* Le Nuage (Affichage) */
        #cloud-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 1000px; margin: 0 auto; min-height: 200px; }
        
        /* Style des √©tiquettes (Tags) */
        .word-tag { 
            background-color: white; 
            padding: 10px 20px; 
            border-radius: 25px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            font-size: 20px; 
            animation: popIn 0.5s ease; 
            color: #333; 
            cursor: default;
        }
        
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Zone Prof (Administration) */
        #admin-section { margin-top: 60px; padding-top: 20px; border-top: 1px solid #ddd; color: #aaa; font-size: 0.8em; }
        .hidden { display: none !important; }
        
        #reset-btn { background-color: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; box-shadow: 0 3px 0 #a71d2a; }
        #reset-btn:active { transform: translateY(3px); box-shadow: none; }
        
        #loading-auth { font-style: italic; color: #ccc; }
    </style>
</head>
<body>

    <h1>Vos id√©es en direct üí¨</h1>

    <div class="input-zone">
        <p class="instructions">
            En lien avec le sujet du cours, proposez un mot ou une courte expression.
            <span class="warning">‚ö†Ô∏è Restez respectueux, votre r√©ponse s'affiche au tableau.</span>
        </p>
        
        <input type="text" id="wordInput" placeholder="√âcrivez votre mot ici..." autocomplete="off">
        <button class="send" onclick="envoyerMot()">Envoyer</button>
    </div>

    <div id="cloud-container">
        </div>

    <div id="admin-section">
        <span id="loading-auth">V√©rification...</span>

        <div id="login-container" class="hidden">
            <span id="login-link" style="cursor:pointer; text-decoration:underline;">Acc√®s Professeur</span>
            <div id="login-form" class="hidden">
                <br>
                <input type="email" id="email" placeholder="Email" style="font-size:14px; width:150px; padding:5px;">
                <input type="password" id="password" placeholder="Mot de passe" style="font-size:14px; width:150px; padding:5px;">
                <button onclick="connexionProf()" style="padding:5px 10px; cursor:pointer;">OK</button>
            </div>
        </div>

        <div id="admin-controls" class="hidden">
            <p>‚úÖ <b>Mode Professeur Actif</b></p>
            <button id="reset-btn" onclick="toutEffacer()">üóëÔ∏è VIDER LE NUAGE (Nouveau sujet)</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURATION CORRIG√âE (D'apr√®s votre capture d'√©cran) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.firebasestorage.app",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55",
            measurementId: "G-7R9N0JL6GG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Nom de la collection unique pour le nuage g√©n√©rique
        const collectionName = "reponses_live"; 

        // --- 1. AFFICHAGE DES MOTS (Temps r√©el) ---
        // On trie par date pour voir les nouveaux arriver
        const q = query(collection(db, collectionName), orderBy("timestamp", "asc"));
        
        onSnapshot(q, (snapshot) => {
            const container = document.getElementById("cloud-container");
            container.innerHTML = ""; 
            
            snapshot.forEach((doc) => {
                const mot = doc.data().texte;
                const tag = document.createElement("div");
                tag.className = "word-tag";
                
                // Palette de couleurs douces et vari√©es (Pas que du rouge/tomate)
                const colors = ['#FFDDC1', '#C7CEEA', '#B5EAD7', '#E2F0CB', '#FFDAC1', '#FF9AA2', '#D5AAFF', '#85E3FF'];
                tag.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                tag.textContent = mot;
                container.appendChild(tag);
            });
        });

        // --- 2. ENVOI (√âL√àVE) ---
        window.envoyerMot = async function() {
            const input = document.getElementById("wordInput");
            const texte = input.value.trim(); // On enl√®ve les espaces inutiles
            
            // S√©curit√© basique : on emp√™che les messages vides ou trop longs
            if (texte.length > 0 && texte.length < 50) {
                try {
                    await addDoc(collection(db, collectionName), {
                        texte: texte,
                        timestamp: Date.now()
                    });
                    input.value = ""; 
                } catch (e) {
                    console.error(e);
                    alert("Erreur d'envoi. V√©rifiez la connexion.");
                }
            } else if (texte.length >= 50) {
                alert("Essayez de faire plus court !");
            }
        }
        
        // Permettre d'envoyer avec la touche "Entr√©e"
        document.getElementById("wordInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                window.envoyerMot();
            }
        });

        // --- 3. GESTION PROFESSEUR (Code Intelligent) ---
        
        // Garder la connexion active
        setPersistence(auth, browserLocalPersistence).catch(console.error);

        // D√©tection auto
        onAuthStateChanged(auth, (user) => {
            document.getElementById("loading-auth").classList.add("hidden");
            if (user) {
                // Connect√© -> Affiche le bouton Reset
                document.getElementById("login-container").classList.add("hidden");
                document.getElementById("admin-controls").classList.remove("hidden");
            } else {
                // Pas connect√© -> Affiche le lien discret
                document.getElementById("login-container").classList.remove("hidden");
                document.getElementById("admin-controls").classList.add("hidden");
            }
        });

        window.connexionProf = function() {
            const email = document.getElementById("email").value;
            const pass = document.getElementById("password").value;
            signInWithEmailAndPassword(auth, email, pass)
                .catch((error) => alert("Erreur : " + error.message));
        }

        document.getElementById("login-link").addEventListener("click", () => {
            document.getElementById("login-form").classList.toggle("hidden");
        });

        window.toutEffacer = async function() {
            if (confirm("Voulez-vous effacer tous les mots pour commencer un nouveau sujet ?")) {
                const qDocs = query(collection(db, collectionName));
                const querySnapshot = await getDocs(qDocs);
                querySnapshot.forEach((docSnap) => deleteDoc(docSnap.ref));
            }
        }
    </script>
</body>
</html>
