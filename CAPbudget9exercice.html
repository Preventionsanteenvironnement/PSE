<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module D2 : Le Budget d'Amanda</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="annuaire.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --error: #dc2626; --bg: #f1f5f9; }

        /* ‚úÖ Robustesse mobile + anti-d√©bordement */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { max-width: 100%; overflow-x: hidden; }
        img, svg, canvas { max-width: 100%; height: auto; }
        .container { overflow-x: hidden; position: relative; }
        .draggable-item { max-width: 100%; word-break: break-word; overflow-wrap: anywhere; touch-action: manipulation; }
        input, button { max-width: 100%; }
        input[type="number"] { font-variant-numeric: tabular-nums; }
        .drop-zone { min-width: 0; }
        .syn-row { gap: 10px; }
        .syn-row .val { text-align: right; }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; padding: 15px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 1100px; width: 100%; }
        
        /* Bouton retour */
        .btn-retour {
          position: absolute;
          top: 15px;
          left: 15px;
          background: white;
          border: 2px solid #cbd5e1;
          padding: 8px 15px;
          border-radius: 8px;
          font-size: 0.9rem;
          font-weight: 600;
          color: #475569;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 5px;
          transition: 0.2s;
          text-decoration: none;
          -webkit-tap-highlight-color: transparent;
          z-index: 10;
        }
        .btn-retour:hover {
          border-color: var(--primary);
          color: var(--primary);
          background: #eff6ff;
        }

        /* Page d'introduction */
        #page-intro {
          background: white;
          padding: 50px 20px 30px 20px;
          border-radius: 15px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          text-align: center;
          margin: 0 auto;
        }
        #page-intro h1 {
          color: var(--primary);
          font-size: 1.8rem;
          margin-bottom: 10px;
        }
        #page-intro h2 {
          color: #475569;
          font-size: 1.3rem;
          font-weight: 600;
          margin: 15px 0;
        }
        #page-intro .objectif {
          background: #eff6ff;
          border-left: 5px solid var(--primary);
          padding: 20px;
          border-radius: 8px;
          margin: 30px 0;
          text-align: left;
        }
        #page-intro .objectif strong {
          display: block;
          margin-bottom: 10px;
          color: var(--primary);
        }
        #btn-demarrer {
          margin-top: 30px;
          padding: 18px 40px;
          background: var(--primary);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 1.2rem;
          font-weight: 700;
          cursor: pointer;
          -webkit-tap-highlight-color: transparent;
          touch-action: manipulation;
          transition: 0.2s;
        }
        #btn-demarrer:hover {
          background: #1d4ed8;
        }

        /* Contenu de l'exercice */
        #contenu-exercice {
          display: none;
        }

        header { background: #2563eb; color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .obj-box { background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px; font-size: 0.9rem; margin-top: 10px; }
        .context-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; line-height: 1.6; overflow-wrap:anywhere; }
        #item-bank { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; background: #fff; padding: 15px; border-radius: 12px; border: 2px dashed #cbd5e1; margin-bottom: 20px; min-height: 80px; }
        .draggable-item { padding: 12px 15px; background: white; border: 2px solid #64748b; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; user-select: none; -webkit-tap-highlight-color: transparent; }
        .draggable-item.selected { border-color: #2563eb; background: #eff6ff; transform: scale(1.05); }

        .correct-info { display:none; font-size: .85rem; color: var(--error); margin-top: 6px; font-weight: 900; }

        .budget-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; width: 100%; }
        .column { background: white; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; min-height: 400px; border-top: 8px solid #ccc; min-width:0; }
        #col-recettes { border-top-color: #28a745; }
        #col-fixes { border-top-color: #007bff; }
        #col-courantes { border-top-color: #ffc107; }
        #col-occas { border-top-color: #dc3545; }
        .drop-zone { flex-grow: 1; padding: 10px; border-radius: 8px; background: #f8fafc; min-height: 150px; cursor: pointer; overflow:auto; }
        .sub-zone { background: #e2f3e5; margin-bottom: 10px; border-radius: 8px; padding: 10px; min-height: 80px; overflow:auto; }
        .calc-zone { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; text-align: center; }
        input[type="number"] { width: 100px; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center; font-weight: 800; }
        .btn-valider { background: #1e293b; color: white; border: none; padding: 20px; border-radius: 12px; font-size: 1.2rem; font-weight: 800; cursor: pointer; margin-top: 30px; width: 100%; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .btn-valider[disabled]{opacity:.75;cursor:not-allowed;}
        #result-zone { display: none; width: 100%; background: white; padding: 25px; border-radius: 20px; border: 4px solid #2563eb; margin-top: 30px; text-align: center; }
        .synthesis-card { background: #eff6ff; border: 2px solid #2563eb; padding: 15px; border-radius: 12px; margin: 20px 0; text-align: left; }
        .syn-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; flex-wrap: wrap; }
        .status-options { display: flex; justify-content: space-around; margin-top: 15px; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #cbd5e1; gap:10px; flex-wrap:wrap; }
        .chart-box { height: 260px; margin-top: 12px; }
        .chart-box canvas { max-width: 100% !important; height: 100% !important; display:block; }

        @media (max-width: 520px) {
            body { padding: 10px; }
            .btn-retour { top: 10px; left: 10px; font-size: 0.85rem; padding: 6px 12px; }
            #page-intro { padding: 40px 15px 20px 15px; }
            #page-intro h1 { font-size: 1.5rem; }
            #page-intro h2 { font-size: 1.1rem; }
            header { padding: 16px; }
            .context-box { padding: 16px; }
            #item-bank { padding: 12px; }
            .draggable-item { width: 100%; text-align: left; }
            .budget-container { grid-template-columns: 1fr; }
            .column { min-height: 320px; }
            input[type="number"] { width: 110px; }
            .status-options { justify-content: flex-start; }
            .btn-valider { padding: 16px; font-size: 1.05rem; }
        }

        @media (max-width: 360px) {
            .syn-row { flex-direction: column; align-items: flex-start; }
            .syn-row .val { width: 100%; text-align: left; }
            input[type="number"] { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Bouton retour (toujours visible) -->
    <a href="javascript:history.back()" class="btn-retour">
      <span>‚Üê</span>
      <span>Retour aux exercices</span>
    </a>

    <!-- Page d'introduction -->
    <div id="page-intro">
      <h1>PSE ‚Äì Th√©matique D</h1>
      <h2>L'individu consommateur averti</h2>
      <h2>Module D2 ‚Äì Le budget</h2>
      
      <div class="objectif">
        <strong>Objectif g√©n√©ral</strong>
        <p>Je dois √™tre capable de g√©rer mon budget et de prendre les bonnes d√©cisions face aux propositions de cr√©dit afin d'adopter une attitude responsable et d'√©viter le surendettement.</p>
      </div>

      <button id="btn-demarrer" type="button">D√©marrer l'exercice</button>
    </div>

    <!-- Contenu de l'exercice (masqu√© initialement) -->
    <div id="contenu-exercice">
      <header>
          <h1 style="margin:0;">Module D2 : Le Budget d'Amanda</h1>
          <div class="obj-box">Objectif : Identifier l'√©tat d'un budget apr√®s calcul du solde.</div>
      </header>

      <!-- TRACKER DE VISITE RETIR√â conform√©ment aux instructions -->

      <div class="context-box">
          <strong>Situation :</strong> Amanda est infirmi√®re. Elle per√ßoit un <b>salaire de 2 450,00 ‚Ç¨</b> et une <b>prime d'activit√© de 113,14 ‚Ç¨</b>. <br><br>
          Ses op√©rations : Loyer (753,33 ‚Ç¨), Assurance (82,40 ‚Ç¨), Internet/Mobile (45,00 ‚Ç¨), Cr√©dit auto (210,00 ‚Ç¨), Courses alimentaires (520,27 ‚Ç¨), Essence (165,00 ‚Ç¨), Hygi√®ne (44,00 ‚Ç¨), Sortie restaurant (120,00 ‚Ç¨), Habillement (350,00 ‚Ç¨) et Coiffeur (270,00 ‚Ç¨).
      </div>

      <p style="font-weight:bold;">1. Cliquez sur une √©tiquette, puis cliquez sur sa cat√©gorie :</p>
      <div id="item-bank"></div>

      <div class="budget-container">
          <div class="column" id="col-recettes">
              <h3>Recettes</h3>
              <div class="drop-zone sub-zone" data-category="recette-travail"><h4>Travail</h4></div>
              <div class="drop-zone sub-zone" data-category="recette-social"><h4>Social</h4></div>
              <div class="calc-zone">Total : <input type="number" step="0.01" inputmode="decimal" id="in-recettes"> ‚Ç¨</div>
          </div>
          <div class="column" id="col-fixes">
              <h3>Fixes (Incompressibles)</h3>
              <div class="drop-zone" data-category="fixe"></div>
              <div class="calc-zone">Total : <input type="number" step="0.01" inputmode="decimal" id="in-fixes"> ‚Ç¨</div>
          </div>
          <div class="column" id="col-courantes">
              <h3>Courantes</h3>
              <div class="drop-zone" data-category="courante"></div>
              <div class="calc-zone">Total : <input type="number" step="0.01" inputmode="decimal" id="in-courantes"> ‚Ç¨</div>
          </div>
          <div class="column" id="col-occas">
              <h3>Occas. (Exceptionnelles)</h3>
              <div class="drop-zone" data-category="occas"></div>
              <div class="calc-zone">Total : <input type="number" step="0.01" inputmode="decimal" id="in-occas"> ‚Ç¨</div>
          </div>
      </div>

      <div class="context-box" style="margin-top: 20px;">
          <span style="font-weight: bold;">2. Calcul du Solde et √âtat du budget :</span>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; flex-wrap: wrap; gap: 10px;">
              <span>Quel est le solde final d'Amanda ?</span>
              <input type="number" step="0.01" inputmode="decimal" id="in-solde" style="width: 120px; padding: 10px; border: 2px solid var(--primary); border-radius: 8px;">
          </div>
          <div class="status-options">
              <label><input type="radio" name="status" value="excedentaire"> Exc√©dentaire</label>
              <label><input type="radio" name="status" value="equilibre"> √âquilibr√©</label>
              <label><input type="radio" name="status" value="deficitaire"> D√©ficitaire</label>
          </div>
      </div>

      <button class="btn-valider" id="btn-analyser" onclick="analyser()">V√âRIFIER MES R√âPONSES</button>

      <div id="result-zone">
          <h2 id="final-score">Score : -- / 20</h2>
          <div class="synthesis-card">
              <div class="syn-row" id="syn-rec"><span>Total Recettes :</span> <span class="val">--</span></div>
              <div class="syn-row" id="syn-dep"><span>Total D√©penses :</span> <span class="val">--</span></div>
              <hr><div class="syn-row" id="syn-sol" style="color:#2563eb"><span>SOLDE FINAL :</span> <span class="val">--</span></div>
              <div class="syn-row" id="syn-status"><span>√âTAT DU BUDGET :</span> <span class="val">--</span></div>
          </div>
          <div class="chart-box"><canvas id="barChart"></canvas></div>
          <button class="btn-valider" style="background: #64748b;" onclick="location.reload()">üîÑ RECOMMENCER</button>
      </div>
    </div>
</div>

<script>
    // Gestion page d'intro
    document.getElementById("btn-demarrer").addEventListener("click", function() {
      document.getElementById("page-intro").style.display = "none";
      document.getElementById("contenu-exercice").style.display = "block";
    });

    const items = [
        { id: 1,  name: "Salaire",              val: 2450.00, cat: "recette-travail", label: "Recettes (Travail)" },
        { id: 2,  name: "Prime d'activit√©",     val:  113.14, cat: "recette-social",  label: "Recettes (Social)"  },
        { id: 3,  name: "Loyer",               val:  753.33, cat: "fixe",            label: "D√©penses Fixes"     },
        { id: 4,  name: "Assurance",           val:   82.40, cat: "fixe",            label: "D√©penses Fixes"     },
        { id: 5,  name: "Internet/Mobile",     val:   45.00, cat: "fixe",            label: "D√©penses Fixes"     },
        { id: 6,  name: "Cr√©dit auto",         val:  210.00, cat: "fixe",            label: "D√©penses Fixes"     },
        { id: 7,  name: "Courses alimentaires",val:  520.27, cat: "courante",        label: "D√©penses Courantes" },
        { id: 8,  name: "Essence",             val:  165.00, cat: "courante",        label: "D√©penses Courantes" },
        { id: 9,  name: "Hygi√®ne",             val:   44.00, cat: "courante",        label: "D√©penses Courantes" },
        { id: 10, name: "Restaurant",          val:  120.00, cat: "occas",           label: "D√©penses Occasionnelles" },
        { id: 11, name: "Habillement",         val:  350.00, cat: "occas",           label: "D√©penses Occasionnelles" },
        { id: 12, name: "Coiffeur",            val:  270.00, cat: "occas",           label: "D√©penses Occasionnelles" }
    ];

    function round2(n){ return Math.round((Number(n) + Number.EPSILON) * 100) / 100; }
    function parseEuro(v){
        if(v === null || v === undefined) return 0;
        const s = String(v).replace(/\s/g,"").replace(",",".").replace(/[^\d.\-]/g,"");
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : 0;
    }
    function formatEuro(n){ return round2(n).toFixed(2); }
    function closeEnough(a,b,eps=0.01){ return Math.abs(round2(a) - round2(b)) < eps; }

    function computeExpected(){
        const sum = (pred) => round2(items.filter(pred).reduce((acc,it)=>acc+it.val,0));
        const recettes  = sum(it => it.cat.startsWith("recette"));
        const fixes     = sum(it => it.cat === "fixe");
        const courantes = sum(it => it.cat === "courante");
        const occas     = sum(it => it.cat === "occas");
        const depenses  = round2(fixes + courantes + occas);
        const solde     = round2(recettes - depenses);

        const TOL_EQ = 5.00; // budget "√©quilibr√©" si solde tr√®s proche de 0
        let status = "equilibre";
        if (solde > TOL_EQ) status = "excedentaire";
        else if (solde < -TOL_EQ) status = "deficitaire";
        return {recettes, fixes, courantes, occas, depenses, solde, status};
    }

    let selectedItem = null;
    const bank = document.getElementById("item-bank");

    items.slice().sort(() => Math.random() - 0.5).forEach(item => {
        let el = document.createElement("div");
        el.className = "draggable-item";
        el.id = "i-" + item.id;
        el.innerHTML = `${item.name} (${formatEuro(item.val)}‚Ç¨)<div class="correct-info" id="info-${item.id}">Doit √™tre dans : ${item.label}</div>`;
        el.onclick = (e) => {
            e.stopPropagation();
            if(selectedItem) selectedItem.classList.remove('selected');
            selectedItem = el;
            el.classList.add('selected');
        };
        bank.appendChild(el);
    });

    document.querySelectorAll('.drop-zone, #item-bank').forEach(zone => {
        zone.onclick = () => {
            if(selectedItem) {
                zone.appendChild(selectedItem);
                selectedItem.classList.remove('selected');
                selectedItem = null;
            }
        };
    });

    function getIdentity(){
        const code = localStorage.getItem("codeEleve") || localStorage.getItem("userCode") || "ANONYME";
        let classe = localStorage.getItem("userClasse") || "AUTRE";
        try{
            if((!classe || classe === "AUTRE") && typeof ANNUAIRE !== "undefined" && ANNUAIRE && ANNUAIRE[code]) {
                classe = ANNUAIRE[code];
            }
        }catch(e){}
        return {code, classe};
    }

    async function safeSendFirebase(note, total){
        try{
            if(typeof firebase === "undefined" || !firebase || typeof firebase.firestore !== "function") return;
            const cfg = (typeof firebaseConfig !== "undefined" && firebaseConfig) ? firebaseConfig : (window.firebaseConfig || null);
            if(!cfg) return;
            if(!firebase.apps.length) firebase.initializeApp(cfg);
            const db = firebase.firestore();
            const {code, classe} = getIdentity();

            await db.collection("resultats_exercices").add({
                eleve: code,
                classe: classe,
                exercice: "Module D2 - Budget Amanda",
                note: note,
                total: total,
                competences: { C1: note, C2: note },
                timestamp: (firebase.firestore && firebase.firestore.FieldValue && firebase.firestore.FieldValue.serverTimestamp)
                    ? firebase.firestore.FieldValue.serverTimestamp()
                    : new Date()
            });
        }catch(e){}
    }

    let chartInstance = null;

    async function analyser() {
        const btn = document.getElementById("btn-analyser");
        if (btn && btn.disabled) return;
        if (btn) { btn.disabled = true; btn.style.opacity = "0.75"; btn.style.cursor = "not-allowed"; }

        const expected = computeExpected();

        let score = 0;
        let ok = 0;

        items.forEach(item => {
            let el = document.getElementById("i-" + item.id);
            let info = document.getElementById("info-" + item.id);
            let parentCat = (el && el.parentElement && el.parentElement.dataset) ? el.parentElement.dataset.category : "";

            if (parentCat === item.cat) {
                score += 1;
                ok++;
                if(el) el.style.borderColor = "#16a34a";
                if(info) info.style.display = "none";
            } else {
                if(el) el.style.borderColor = "#dc2626";
                if(info) info.style.display = "block";
            }
        });

        const inR = parseEuro(document.getElementById("in-recettes").value);
        const inF = parseEuro(document.getElementById("in-fixes").value);
        const inC = parseEuro(document.getElementById("in-courantes").value);
        const inO = parseEuro(document.getElementById("in-occas").value);
        const inSolde = parseEuro(document.getElementById("in-solde").value);
        const inStatus = document.querySelector('input[name="status"]:checked')?.value;

        const totalD = round2(inF + inC + inO);

        if (closeEnough(inR, expected.recettes)) score += 2;
        if (closeEnough(inF, expected.fixes)) score += 1.5;
        if (closeEnough(inC, expected.courantes)) score += 1.5;
        if (closeEnough(inO, expected.occas)) score += 1.5;
        if (closeEnough(inSolde, expected.solde)) score += 1;
        if (inStatus === expected.status) score += 0.5;

        const finalScore = Math.round(Math.min(20, Math.max(0, score)));

        document.getElementById("result-zone").style.display = "block";
        document.getElementById("final-score").innerText = `Score : ${finalScore} / 20`;

        document.querySelector("#syn-rec .val").innerHTML = `${formatEuro(inR)}‚Ç¨ ${closeEnough(inR, expected.recettes) ? '‚úÖ' : '‚ùå'}`;
        document.querySelector("#syn-dep .val").innerHTML = `${formatEuro(totalD)}‚Ç¨ ${closeEnough(totalD, expected.depenses) ? '‚úÖ' : '‚ùå'}`;
        document.querySelector("#syn-sol .val").innerHTML = `${formatEuro(inSolde)}‚Ç¨ ${closeEnough(inSolde, expected.solde) ? '‚úÖ' : '‚ùå'}`;
        document.querySelector("#syn-status .val").innerHTML =
            `${inStatus === expected.status ? (expected.status === "equilibre" ? "√âquilibr√© ‚úÖ" : expected.status === "excedentaire" ? "Exc√©dentaire ‚úÖ" : "D√©ficitaire ‚úÖ") : "Erreur ‚ùå"}`;

        // Graphique simple (classement / calculs / statut)
        try{
            const canvas = document.getElementById("barChart");
            const canDraw = (typeof Chart !== "undefined") && canvas && canvas.getContext;
            if(canDraw){
                const pcClassement = (ok/items.length) * 100;
                const pcCalculs = (
                    (closeEnough(inR, expected.recettes)?1:0) +
                    (closeEnough(inF, expected.fixes)?1:0) +
                    (closeEnough(inC, expected.courantes)?1:0) +
                    (closeEnough(inO, expected.occas)?1:0) +
                    (closeEnough(inSolde, expected.solde)?1:0)
                ) / 5 * 100;
                const pcStatus = (inStatus === expected.status ? 100 : 0);

                if(chartInstance){ chartInstance.destroy(); chartInstance = null; }
                chartInstance = new Chart(canvas, {
                    type: "bar",
                    data: {
                        labels: ["Classement", "Calculs", "√âtat"],
                        datasets: [{ label: "% de r√©ussite", data: [pcClassement, pcCalculs, pcStatus], borderRadius: 10 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }catch(e){}

        window.scrollTo({ top: document.getElementById("result-zone").offsetTop, behavior: 'smooth' });

        await safeSendFirebase(finalScore, 20);
    }
</script>
</body>
</html>
