<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module D2 : Le Budget de Michel</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="annuaire.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --primary:#2563eb; --success:#16a34a; --error:#dc2626; --bg:#f1f5f9; }
    * { box-sizing:border-box; }
    html, body { width:100%; max-width:100%; overflow-x:hidden; margin:0; padding:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: #333;
      padding: 15px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .container{ max-width:1100px; width:100%; }
    header{ background:#2563eb; color:#fff; padding:20px; border-radius:15px; text-align:center; margin-bottom:20px; }
    .obj-box{ background:rgba(255,255,255,0.15); padding:10px; border-radius:8px; font-size:0.95rem; margin-top:10px; font-weight:700; }
    .context-box{ background:#fff; padding:20px; border-radius:15px; box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:20px; line-height:1.6; overflow-wrap:anywhere; }
    #alert{
      display:none;
      margin: 0 0 14px 0;
      padding: 12px 14px;
      border-radius: 12px;
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
      font-weight:900;
      overflow-wrap:anywhere;
    }

    #item-bank{
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
      background:#fff; padding:15px; border-radius:12px; border:2px dashed #cbd5e1;
      margin-bottom:20px; min-height:80px; width:100%;
    }
    .draggable-item{
      padding:12px 15px; background:#fff; border:2px solid #64748b; border-radius:10px;
      cursor:pointer; font-weight:900; transition:0.2s; user-select:none;
      max-width:100%; overflow-wrap:anywhere; word-break:break-word;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .draggable-item.selected{ border-color:#2563eb; background:#eff6ff; transform:scale(1.03); }
    .correct-info{ display:none; margin-top:6px; font-size:0.85rem; font-weight:900; color:var(--error); }

    .budget-container{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:15px; width:100%;
    }
    .column{
      background:#fff; border-radius:12px; padding:15px;
      display:flex; flex-direction:column; min-height:400px;
      border-top:8px solid #ccc; width:100%; min-width:0;
    }
    #col-recettes{ border-top-color:#28a745; }
    #col-fixes{ border-top-color:#007bff; }
    #col-courantes{ border-top-color:#ffc107; }
    #col-occas{ border-top-color:#dc3545; }

    .drop-zone{
      flex-grow:1; padding:10px; border-radius:8px; background:#f8fafc;
      min-height:150px; cursor:pointer; width:100%; min-width:0; overflow:auto;
    }
    .sub-zone{
      background:#e2f3e5; margin-bottom:10px; border-radius:8px; padding:10px; min-height:80px;
    }
    .sub-zone h4{ margin:0 0 8px 0; font-size:0.85rem; text-transform:uppercase; color:#166534; }
    .calc-zone{ margin-top:15px; padding-top:10px; border-top:1px solid #eee; text-align:center; font-weight:800; }

    input[type="number"]{
      width:110px; max-width:100%;
      padding:8px; border:2px solid #cbd5e1; border-radius:8px; text-align:center; font-weight:900;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }

    .btn-valider{
      background:#1e293b; color:#fff; border:none; padding:20px; border-radius:12px;
      font-size:1.2rem; font-weight:900; cursor:pointer; margin-top:18px; width:100%;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .btn-valider[disabled]{ opacity:0.75; cursor:not-allowed; }

    #result-zone{
      display:none; width:100%; background:#fff; padding:25px; border-radius:20px;
      border:4px solid #2563eb; margin-top:30px; text-align:center;
    }
    .synthesis-card{
      background:#eff6ff; border:2px solid #2563eb; padding:15px; border-radius:12px;
      margin:20px 0; text-align:left; width:100%;
    }
    .syn-row{ display:flex; justify-content:space-between; gap:10px; margin-bottom:8px; font-weight:900; flex-wrap:wrap; }
    .syn-row .val{ overflow-wrap:anywhere; }

    .status-options{
      display:flex; justify-content:space-around; margin-top:15px; padding:10px;
      background:#fff; border-radius:10px; border:1px solid #cbd5e1; gap:10px; flex-wrap:wrap;
      font-weight:900;
    }
    .status-options label{ white-space:nowrap; }

    @media (max-width: 520px){
      body{ padding:10px; }
      header{ padding:16px; border-radius:12px; }
      .context-box{ padding:14px; border-radius:12px; }
      #item-bank{ padding:12px; }
      .draggable-item{ padding:12px 12px; width:100%; }
      .budget-container{ grid-template-columns:1fr; }
      .column{ min-height:320px; padding:12px; }
      .btn-valider{ padding:18px; font-size:1.1rem; }
      input[type="number"]{ width:100%; max-width:180px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1 style="margin:0;">Module D2 : Le Budget de Michel</h1>
      <div class="obj-box">Objectif : Identifier un budget d√©ficitaire apr√®s calcul du solde</div>
    </header>

    <div id="alert"></div>

    <div class="context-box">
      <strong>Situation :</strong> Michel est artisan peintre. Ce mois-ci, son activit√© lui rapporte <b>1 650,00 ‚Ç¨</b>.
      Il per√ßoit aussi une <b>prime d'activit√© de 112,45 ‚Ç¨</b>.
      <br><br>
      Ses op√©rations : Loyer et charges atelier (725,50 ‚Ç¨), Assurance professionnelle (94,20 ‚Ç¨), Abonnement t√©l√©phone (35,00 ‚Ç¨),
      Courses alimentaires (430,45 ‚Ç¨), Carburant utilitaire (215,00 ‚Ç¨), Hygi√®ne (36,00 ‚Ç¨),
      R√©paration outillage (180,00 ‚Ç¨) et un nouveau blouson de travail (200,00 ‚Ç¨).
    </div>

    <p style="font-weight:900; margin:0 0 10px 0;">1. Clique sur une √©tiquette, puis clique sur sa cat√©gorie</p>
    <div id="item-bank"></div>

    <div class="budget-container">
      <div class="column" id="col-recettes">
        <h3 style="margin:0 0 12px 0;">Recettes</h3>
        <div class="drop-zone sub-zone" data-category="recette-travail"><h4>Travail</h4></div>
        <div class="drop-zone sub-zone" data-category="recette-social"><h4>Social</h4></div>
        <div class="calc-zone">Total : <input type="number" step="0.01" id="in-recettes"> ‚Ç¨</div>
      </div>

      <div class="column" id="col-fixes">
        <h3 style="margin:0 0 12px 0;">Fixes (Incompressibles)</h3>
        <div class="drop-zone" data-category="fixe"></div>
        <div class="calc-zone">Total : <input type="number" step="0.01" id="in-fixes"> ‚Ç¨</div>
      </div>

      <div class="column" id="col-courantes">
        <h3 style="margin:0 0 12px 0;">Courantes</h3>
        <div class="drop-zone" data-category="courante"></div>
        <div class="calc-zone">Total : <input type="number" step="0.01" id="in-courantes"> ‚Ç¨</div>
      </div>

      <div class="column" id="col-occas">
        <h3 style="margin:0 0 12px 0;">Occas. (Exceptionnelles)</h3>
        <div class="drop-zone" data-category="occas"></div>
        <div class="calc-zone">Total : <input type="number" step="0.01" id="in-occas"> ‚Ç¨</div>
      </div>
    </div>

    <div class="context-box" style="margin-top: 20px;">
      <span style="font-weight:900;">2. Calcul du Solde et √âtat du budget</span>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; flex-wrap:wrap; gap:10px;">
        <span style="font-weight:800;">Quel est le solde final de Michel</span>
        <input type="number" step="0.01" id="in-solde" style="width:140px; padding:10px; border:2px solid var(--primary); border-radius:10px; max-width:100%; font-weight:900;">
      </div>

      <div class="status-options" role="group" aria-label="√âtat du budget">
        <label><input type="radio" name="status" value="excedentaire"> Exc√©dentaire</label>
        <label><input type="radio" name="status" value="equilibre"> √âquilibr√©</label>
        <label><input type="radio" name="status" value="deficitaire"> D√©ficitaire</label>
      </div>
    </div>

    <button class="btn-valider" id="btn-analyser" type="button" onclick="analyser()">V√âRIFIER MES R√âPONSES</button>

    <div id="result-zone">
      <h2 id="final-score" style="margin:0; font-size:2rem;">Score : -- / 20</h2>

      <div class="synthesis-card">
        <div class="syn-row" id="syn-rec"><span>Total Recettes :</span> <span class="val">--</span></div>
        <div class="syn-row" id="syn-dep"><span>Total D√©penses :</span> <span class="val">--</span></div>
        <hr>
        <div class="syn-row" id="syn-sol" style="color:#dc2626;"><span>SOLDE FINAL :</span> <span class="val">--</span></div>
        <div class="syn-row" id="syn-status"><span>√âTAT DU BUDGET :</span> <span class="val">--</span></div>
      </div>

      <button class="btn-valider" style="background:#64748b;" type="button" onclick="location.reload()">üîÑ RECOMMENCER</button>
    </div>
  </div>

  <script>
    window.PSE_CODE_REQUIRED = true;

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    (function initFirebaseOnce(){
      try {
        if (typeof firebase !== "undefined" && firebaseConfig) {
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          window.db = firebase.firestore();
        } else {
          window.db = null;
        }
      } catch(e) {
        window.db = null;
      }
    })();

    (function traceVisite(){
      try {
        if (typeof enregistrerVisite === "function") {
          enregistrerVisite("Exercice Michel - Budget");
        }
      } catch(e) {}
    })();

    function showAlert(msg){
      const a = document.getElementById("alert");
      a.style.display = "block";
      a.textContent = msg;
      a.scrollIntoView({ behavior:"smooth", block:"center" });
    }
    function hideAlert(){
      const a = document.getElementById("alert");
      a.style.display = "none";
      a.textContent = "";
    }

    function normalizeToNumber(str){
      if (str === null || str === undefined) return 0;
      const s = String(str).replace(/\s/g, "").replace(",", ".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function readNumber(id){
      const el = document.getElementById(id);
      return normalizeToNumber(el ? el.value : 0);
    }

    function almostEqual(a,b,eps=0.01){
      return Math.abs(a-b) < eps;
    }

    function getIdentity(){
      const code = localStorage.getItem("userCode") || localStorage.getItem("codeEleve") || "ANONYME";
      const classe =
        localStorage.getItem("userClasse") ||
        ((typeof ANNUAIRE !== "undefined" && ANNUAIRE && ANNUAIRE[code]) ? ANNUAIRE[code] : "AUTRE");
      return { code, classe };
    }

    const items = [
      { id: 1, name: "Revenu artisan", val: 1650.00, cat: "recette-travail", label: "Recettes (Travail)" },
      { id: 2, name: "Prime d'activit√©", val: 112.45, cat: "recette-social", label: "Recettes (Social)" },
      { id: 3, name: "Loyer + charges atelier", val: 725.50, cat: "fixe", label: "D√©penses Fixes" },
      { id: 4, name: "Assurance professionnelle", val: 94.20, cat: "fixe", label: "D√©penses Fixes" },
      { id: 5, name: "Abonnement t√©l√©phone", val: 35.00, cat: "fixe", label: "D√©penses Fixes" },
      { id: 6, name: "Courses alimentaires", val: 430.45, cat: "courante", label: "D√©penses Courantes" },
      { id: 7, name: "Carburant utilitaire", val: 215.00, cat: "courante", label: "D√©penses Courantes" },
      { id: 8, name: "Hygi√®ne", val: 36.00, cat: "courante", label: "D√©penses Courantes" },
      { id: 9, name: "R√©paration outillage", val: 180.00, cat: "occas", label: "D√©penses Occasionnelles" },
      { id: 10, name: "Blouson de travail", val: 200.00, cat: "occas", label: "D√©penses Occasionnelles" }
    ];

    let selectedItem = null;
    const bank = document.getElementById("item-bank");

    items.sort(() => Math.random() - 0.5).forEach(item => {
      const el = document.createElement("div");
      el.className = "draggable-item";
      el.id = "i-" + item.id;
      el.innerHTML = `${item.name} (${item.val.toFixed(2)}‚Ç¨)
        <div class="correct-info" id="info-${item.id}">Doit √™tre dans : ${item.label}</div>`;
      el.addEventListener("click", (e) => {
        e.stopPropagation();
        if (selectedItem) selectedItem.classList.remove("selected");
        selectedItem = el;
        el.classList.add("selected");
      });
      bank.appendChild(el);
    });

    document.querySelectorAll(".drop-zone, #item-bank").forEach(zone => {
      zone.addEventListener("click", () => {
        if (selectedItem) {
          zone.appendChild(selectedItem);
          selectedItem.classList.remove("selected");
          selectedItem = null;
        }
      });
    });

    async function analyser(){
      hideAlert();

      const btn = document.getElementById("btn-analyser");
      if (btn && btn.disabled) return;

      const inStatus = document.querySelector('input[name="status"]:checked')?.value;
      if (!inStatus){
        showAlert("Choisis l‚Äô√©tat du budget avant de valider");
        return;
      }

      if (btn) { btn.disabled = true; }

      let score = 0;

      // 10 points : classement (1 point par √©tiquette)
      items.forEach(item => {
        const el = document.getElementById("i-" + item.id);
        const info = document.getElementById("info-" + item.id);
        const parentCat = (el && el.parentElement && el.parentElement.dataset) ? el.parentElement.dataset.category : "";
        if (parentCat === item.cat) {
          score += 1;
          el.style.borderColor = "#28a745";
          if (info) info.style.display = "none";
        } else {
          el.style.borderColor = "#dc3545";
          if (info) info.style.display = "block";
        }
      });

      const inR = readNumber("in-recettes");
      const inF = readNumber("in-fixes");
      const inC = readNumber("in-courantes");
      const inO = readNumber("in-occas");
      const inSolde = readNumber("in-solde");

      const totalD = Number((inF + inC + inO).toFixed(2));

      // Valeurs attendues
      const R_OK = 1762.45;
      const F_OK = 854.70;
      const C_OK = 681.45;
      const O_OK = 380.00;
      const D_OK = 1916.15;
      const SOLDE_OK = -153.70;
      const STATUS_OK = "deficitaire";

      // 10 points : calculs (2+2+2+2+1+1)
      if (almostEqual(inR, R_OK)) score += 2;
      if (almostEqual(inF, F_OK)) score += 2;
      if (almostEqual(inC, C_OK)) score += 2;
      if (almostEqual(inO, O_OK)) score += 2;
      if (almostEqual(inSolde, SOLDE_OK)) score += 1;
      if (inStatus === STATUS_OK) score += 1;

      const finalScore = Math.max(0, Math.min(20, Math.round(score)));

      document.getElementById("result-zone").style.display = "block";
      document.getElementById("final-score").innerText = `Score : ${finalScore} / 20`;

      document.querySelector("#syn-rec .val").innerHTML = `${inR.toFixed(2)}‚Ç¨ ${almostEqual(inR, R_OK) ? "‚úÖ" : "‚ùå"}`;
      document.querySelector("#syn-dep .val").innerHTML = `${totalD.toFixed(2)}‚Ç¨ ${almostEqual(totalD, D_OK) ? "‚úÖ" : "‚ùå"}`;
      document.querySelector("#syn-sol .val").innerHTML = `${inSolde.toFixed(2)}‚Ç¨ ${almostEqual(inSolde, SOLDE_OK) ? "‚úÖ" : "‚ùå"}`;
      document.querySelector("#syn-status .val").innerHTML = `${inStatus === STATUS_OK ? "D√©ficitaire ‚úÖ" : "Erreur ‚ùå"}`;

      window.scrollTo({ top: document.getElementById("result-zone").offsetTop, behavior: "smooth" });

      // Envoi Firebase
      try {
        const { code, classe } = getIdentity();
        if (window.db && typeof firebase !== "undefined") {
          const sentKey = "sent_budget_michel_" + code;
          if (!sessionStorage.getItem(sentKey)) {
            await db.collection("resultats_exercices").add({
              eleve: code,
              classe: classe,
              exercice: "Module D2 - Budget Michel",
              note: finalScore,
              total: 20,
              competences: { C1: finalScore, C2: finalScore },
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            sessionStorage.setItem(sentKey, "1");
          }
        }
      } catch(e) {
        console.error("Erreur lors de l'envoi Firebase : ", e);
      }
    }
  </script>
</body>
</html>
