<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module D2 : Le Budget de Michel</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="annuaire.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --primary:#2563eb; --success:#16a34a; --error:#dc2626; --bg:#f1f5f9; --gold:#fbbf24; }
    * { box-sizing:border-box; }
    html, body { width:100%; max-width:100%; overflow-x:hidden; margin:0; padding:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: #333;
      padding: 15px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .container{ max-width:1100px; width:100%; }
    header{ background:#2563eb; color:#fff; padding:20px; border-radius:15px; text-align:center; margin-bottom:20px; }
    .obj-box{ background:rgba(255,255,255,0.15); padding:10px; border-radius:8px; font-size:0.95rem; margin-top:10px; font-weight:700; }
    .context-box{ background:#fff; padding:20px; border-radius:15px; box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:20px; line-height:1.6; overflow-wrap:anywhere; }
    #alert{
      display:none;
      margin: 0 0 14px 0;
      padding: 12px 14px;
      border-radius: 12px;
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
      font-weight:900;
      overflow-wrap:anywhere;
    }

    /* CALCULATRICE */
    .calc-toggle{
      position:fixed; bottom:20px; right:20px; z-index:1000;
      background:var(--gold); color:#0f172a; border:none;
      width:60px; height:60px; border-radius:50%; font-size:1.8rem;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);
      transition:transform 0.2s; display:flex; align-items:center; justify-content:center;
    }
    .calc-toggle:hover{ transform:scale(1.1); }
    .calc-toggle:active{ transform:scale(0.95); }

    .calculator{
      position:fixed; bottom:90px; right:20px; z-index:999;
      background:#1e293b; border:3px solid var(--gold); border-radius:20px;
      padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.5);
      display:none; width:280px;
    }
    .calculator.visible{ display:block; animation:slideIn 0.3s; }
    @keyframes slideIn{ from{ opacity:0; transform:translateY(20px); } to{ opacity:1; transform:translateY(0); } }

    .calc-header{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;
    }
    .calc-header h3{ margin:0; color:var(--gold); font-size:1.1rem; }
    .calc-close{
      background:transparent; border:none; color:#94a3b8; font-size:1.5rem;
      cursor:pointer; padding:0; width:30px; height:30px;
    }
    .calc-close:hover{ color:var(--error); }

    .calc-display{
      background:#0f172a; color:#0f0; font-family:'Courier New',monospace;
      padding:15px; border-radius:10px; font-size:1.5rem; text-align:right;
      margin-bottom:15px; border:2px solid #334155; min-height:50px;
      word-break:break-all;
    }

    .calc-buttons{
      display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;
    }
    .calc-btn{
      background:#334155; color:#e2e8f0; border:none; padding:15px;
      border-radius:10px; font-size:1.1rem; font-weight:700; cursor:pointer;
      transition:0.15s;
    }
    .calc-btn:hover{ background:#475569; }
    .calc-btn:active{ transform:scale(0.95); }
    .calc-btn.operator{ background:#3b82f6; color:white; }
    .calc-btn.equals{ background:var(--success); color:white; grid-column:span 2; }
    .calc-btn.clear{ background:var(--error); color:white; }
    .calc-btn.zero{ grid-column:span 2; }

    #item-bank{
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
      background:#fff; padding:15px; border-radius:12px; border:2px dashed #cbd5e1;
      margin-bottom:20px; min-height:80px; width:100%;
    }
    .draggable-item{
      padding:12px 15px; background:#fff; border:2px solid #64748b; border-radius:10px;
      cursor:pointer; font-weight:900; transition:0.2s; user-select:none;
      max-width:100%; overflow-wrap:anywhere; word-break:break-word;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .draggable-item.selected{ border-color:#2563eb; background:#eff6ff; transform:scale(1.03); }
    .correct-info{ display:none; margin-top:6px; font-size:0.85rem; font-weight:900; color:var(--error); }

    .budget-container{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:15px; width:100%;
    }
    .column{
      background:#fff; border-radius:12px; padding:15px;
      display:flex; flex-direction:column; min-height:400px;
      border-top:8px solid #ccc; width:100%; min-width:0;
    }
    #col-recettes{ border-top-color:#28a745; }
    #col-fixes{ border-top-color:#007bff; }
    #col-courantes{ border-top-color:#ffc107; }
    #col-occas{ border-top-color:#dc3545; }

    .drop-zone{
      flex-grow:1; padding:10px; border-radius:8px; background:#f8fafc;
      min-height:150px; cursor:pointer; width:100%; min-width:0; overflow:auto;
    }
    .sub-zone{
      background:#e2f3e5; margin-bottom:10px; border-radius:8px; padding:10px; min-height:80px;
    }
    .sub-zone h4{ margin:0 0 8px 0; font-size:0.85rem; text-transform:uppercase; color:#166534; }
    .calc-zone{ margin-top:15px; padding-top:10px; border-top:1px solid #eee; text-align:center; font-weight:800; }

    input[type="text"]{
      width:110px; max-width:100%;
      padding:8px; border:2px solid #cbd5e1; border-radius:8px; text-align:center; font-weight:900;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }

    .btn-valider{
      background:#1e293b; color:#fff; border:none; padding:20px; border-radius:12px;
      font-size:1.2rem; font-weight:900; cursor:pointer; margin-top:18px; width:100%;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .btn-valider[disabled]{ opacity:0.75; cursor:not-allowed; }

    #result-zone{
      display:none; width:100%; background:#fff; padding:25px; border-radius:20px;
      border:4px solid #2563eb; margin-top:30px; text-align:center;
    }
    .synthesis-card{
      background:#eff6ff; border:2px solid #2563eb; padding:15px; border-radius:12px;
      margin:20px 0; text-align:left; width:100%;
    }
    .syn-row{ display:flex; justify-content:space-between; gap:10px; margin-bottom:8px; font-weight:900; flex-wrap:wrap; }
    .syn-row .val{ overflow-wrap:anywhere; }

    .status-options{
      display:flex; justify-content:space-around; margin-top:15px; padding:10px;
      background:#fff; border-radius:10px; border:1px solid #cbd5e1; gap:10px; flex-wrap:wrap;
      font-weight:900;
    }
    .status-options label{ white-space:nowrap; }

    @media (max-width: 600px){
      body{ padding:10px; }
      header{ padding:16px; border-radius:12px; }
      .context-box{ padding:14px; border-radius:12px; }
      #item-bank{ padding:12px; }
      .draggable-item{ padding:12px 12px; width:100%; }
      .budget-container{ grid-template-columns:1fr; }
      .column{ min-height:320px; padding:12px; }
      .btn-valider{ padding:18px; font-size:1.1rem; }
      input[type="text"]{ width:100%; max-width:180px; }
      .calc-toggle{ bottom:15px; right:15px; width:55px; height:55px; font-size:1.6rem; }
      .calculator{ bottom:80px; right:15px; width:260px; padding:15px; }
      .calc-btn{ padding:12px; font-size:1rem; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1 style="margin:0;">Module D2 : Le Budget de Michel</h1>
      <div class="obj-box">Objectif : Identifier un budget d√©ficitaire apr√®s calcul du solde</div>
    </header>

    <div id="alert"></div>

    <div class="context-box">
      <strong>Situation :</strong> Michel est artisan peintre. Ce mois-ci, son activit√© lui rapporte <b>1 650,00 ‚Ç¨</b>.
      Il per√ßoit aussi une <b>prime d'activit√© de 112,45 ‚Ç¨</b>.
      <br><br>
      Ses op√©rations : Loyer et charges atelier (725,50 ‚Ç¨), Assurance professionnelle (94,20 ‚Ç¨), Abonnement t√©l√©phone (35,00 ‚Ç¨),
      Courses alimentaires (430,45 ‚Ç¨), Carburant utilitaire (215,00 ‚Ç¨), Hygi√®ne (36,00 ‚Ç¨),
      R√©paration outillage (180,00 ‚Ç¨) et un nouveau blouson de travail (200,00 ‚Ç¨).
    </div>

    <p style="font-weight:900; margin:0 0 10px 0;">1. Clique sur une √©tiquette, puis clique sur sa cat√©gorie</p>
    <div id="item-bank"></div>

    <div class="budget-container">
      <div class="column" id="col-recettes">
        <h3 style="margin:0 0 12px 0;">Recettes</h3>
        <div class="drop-zone sub-zone" data-category="recette-travail"><h4>Travail</h4></div>
        <div class="drop-zone sub-zone" data-category="recette-social"><h4>Social</h4></div>
        <div class="calc-zone">Total : <input type="text" inputmode="decimal" id="in-recettes" placeholder="1762,45"> ‚Ç¨</div>
      </div>

      <div class="column" id="col-fixes">
        <h3 style="margin:0 0 12px 0;">Fixes (Incompressibles)</h3>
        <div class="drop-zone" data-category="fixe"></div>
        <div class="calc-zone">Total : <input type="text" inputmode="decimal" id="in-fixes" placeholder="854,70"> ‚Ç¨</div>
      </div>

      <div class="column" id="col-courantes">
        <h3 style="margin:0 0 12px 0;">Courantes</h3>
        <div class="drop-zone" data-category="courante"></div>
        <div class="calc-zone">Total : <input type="text" inputmode="decimal" id="in-courantes" placeholder="681,45"> ‚Ç¨</div>
      </div>

      <div class="column" id="col-occas">
        <h3 style="margin:0 0 12px 0;">Occas. (Exceptionnelles)</h3>
        <div class="drop-zone" data-category="occas"></div>
        <div class="calc-zone">Total : <input type="text" inputmode="decimal" id="in-occas" placeholder="380,00"> ‚Ç¨</div>
      </div>
    </div>

    <div class="context-box" style="margin-top: 20px;">
      <span style="font-weight:900;">2. Calcul du Solde et √âtat du budget</span>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; flex-wrap:wrap; gap:10px;">
        <span style="font-weight:800;">Quel est le solde final de Michel ?</span>
        <input type="text" inputmode="decimal" id="in-solde" style="width:140px; padding:10px; border:2px solid var(--primary); border-radius:10px; max-width:100%; font-weight:900;" placeholder="-153,70">
      </div>

      <div class="status-options" role="group" aria-label="√âtat du budget">
        <label><input type="radio" name="status" value="excedentaire"> Exc√©dentaire</label>
        <label><input type="radio" name="status" value="equilibre"> √âquilibr√©</label>
        <label><input type="radio" name="status" value="deficitaire"> D√©ficitaire</label>
      </div>
    </div>

    <button class="btn-valider" id="btn-analyser" type="button" onclick="analyser()">V√âRIFIER MES R√âPONSES</button>

    <div id="result-zone">
      <h2 id="final-score" style="margin:0; font-size:2rem;">Score : -- / 20</h2>

      <div class="synthesis-card">
        <div class="syn-row" id="syn-rec"><span>Total Recettes :</span> <span class="val">--</span></div>
        <div class="syn-row" id="syn-dep"><span>Total D√©penses :</span> <span class="val">--</span></div>
        <hr>
        <div class="syn-row" id="syn-sol" style="color:#dc2626;"><span>SOLDE FINAL :</span> <span class="val">--</span></div>
        <div class="syn-row" id="syn-status"><span>√âTAT DU BUDGET :</span> <span class="val">--</span></div>
      </div>

      <button class="btn-valider" style="background:#64748b;" type="button" onclick="location.reload()">üîÑ RECOMMENCER</button>
    </div>
  </div>

  <!-- CALCULATRICE -->
  <button class="calc-toggle" id="calc-toggle" aria-label="Ouvrir la calculatrice">üßÆ</button>
  
  <div class="calculator" id="calculator">
    <div class="calc-header">
      <h3>Calculatrice</h3>
      <button class="calc-close" id="calc-close" aria-label="Fermer">√ó</button>
    </div>
    <div class="calc-display" id="calc-display">0</div>
    <div class="calc-buttons">
      <button class="calc-btn clear" data-action="clear">C</button>
      <button class="calc-btn operator" data-action="backspace">‚Üê</button>
      <button class="calc-btn operator" data-action="divide">√∑</button>
      <button class="calc-btn operator" data-action="multiply">√ó</button>
      
      <button class="calc-btn" data-number="7">7</button>
      <button class="calc-btn" data-number="8">8</button>
      <button class="calc-btn" data-number="9">9</button>
      <button class="calc-btn operator" data-action="subtract">‚àí</button>
      
      <button class="calc-btn" data-number="4">4</button>
      <button class="calc-btn" data-number="5">5</button>
      <button class="calc-btn" data-number="6">6</button>
      <button class="calc-btn operator" data-action="add">+</button>
      
      <button class="calc-btn" data-number="1">1</button>
      <button class="calc-btn" data-number="2">2</button>
      <button class="calc-btn" data-number="3">3</button>
      <button class="calc-btn equals" data-action="equals">=</button>
      
      <button class="calc-btn zero" data-number="0">0</button>
      <button class="calc-btn" data-action="decimal">,</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    (function initFirebaseOnce(){
      try {
        if (typeof firebase !== "undefined" && firebaseConfig) {
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          window.db = firebase.firestore();
        } else {
          window.db = null;
        }
      } catch(e) {
        window.db = null;
      }
    })();

    (function traceVisite(){
      try {
        if (typeof enregistrerVisite === "function") {
          enregistrerVisite("Exercice Michel - Budget");
        }
      } catch(e) {}
    })();

    // CALCULATRICE
    const calcToggle = document.getElementById("calc-toggle");
    const calculator = document.getElementById("calculator");
    const calcClose = document.getElementById("calc-close");
    const calcDisplay = document.getElementById("calc-display");

    let calcValue = "0";
    let calcOperator = null;
    let calcPrevValue = null;
    let calcWaitingForOperand = false;

    function updateCalcDisplay(){
      calcDisplay.textContent = calcValue.replace(".", ",");
    }

    function calcClear(){
      calcValue = "0";
      calcOperator = null;
      calcPrevValue = null;
      calcWaitingForOperand = false;
      updateCalcDisplay();
    }

    function calcBackspace(){
      if(calcValue.length > 1){
        calcValue = calcValue.slice(0, -1);
      } else {
        calcValue = "0";
      }
      updateCalcDisplay();
    }

    function calcInputNumber(num){
      if(calcWaitingForOperand){
        calcValue = String(num);
        calcWaitingForOperand = false;
      } else {
        calcValue = calcValue === "0" ? String(num) : calcValue + num;
      }
      updateCalcDisplay();
    }

    function calcInputDecimal(){
      if(calcWaitingForOperand){
        calcValue = "0.";
        calcWaitingForOperand = false;
      } else if(calcValue.indexOf(".") === -1){
        calcValue += ".";
      }
      updateCalcDisplay();
    }

    function calcPerformOperation(nextOperator){
      const inputValue = parseFloat(calcValue);

      if(calcPrevValue === null){
        calcPrevValue = inputValue;
      } else if(calcOperator){
        const result = calcCalculate(calcPrevValue, inputValue, calcOperator);
        calcValue = String(result);
        calcPrevValue = result;
      }

      calcWaitingForOperand = true;
      calcOperator = nextOperator;
      updateCalcDisplay();
    }

    function calcCalculate(prev, current, op){
      switch(op){
        case "+": return prev + current;
        case "-": return prev - current;
        case "*": return prev * current;
        case "/": return current !== 0 ? prev / current : 0;
        default: return current;
      }
    }

    function calcEquals(){
      const inputValue = parseFloat(calcValue);
      if(calcPrevValue !== null && calcOperator){
        const result = calcCalculate(calcPrevValue, inputValue, calcOperator);
        calcValue = String(Math.round(result * 100) / 100);
        calcOperator = null;
        calcPrevValue = null;
        calcWaitingForOperand = true;
        updateCalcDisplay();
      }
    }

    calcToggle.addEventListener("click", ()=>{
      calculator.classList.toggle("visible");
    });

    calcClose.addEventListener("click", ()=>{
      calculator.classList.remove("visible");
    });

    document.querySelectorAll(".calc-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const action = btn.dataset.action;
        const number = btn.dataset.number;

        if(number !== undefined){
          calcInputNumber(number);
        } else if(action === "clear"){
          calcClear();
        } else if(action === "backspace"){
          calcBackspace();
        } else if(action === "decimal"){
          calcInputDecimal();
        } else if(action === "add"){
          calcPerformOperation("+");
        } else if(action === "subtract"){
          calcPerformOperation("-");
        } else if(action === "multiply"){
          calcPerformOperation("*");
        } else if(action === "divide"){
          calcPerformOperation("/");
        } else if(action === "equals"){
          calcEquals();
        }
      });
    });

    // Support clavier pour la calculatrice
    document.addEventListener("keydown", (e)=>{
      if(!calculator.classList.contains("visible")) return;

      if(e.key >= "0" && e.key <= "9"){
        calcInputNumber(e.key);
      } else if(e.key === "," || e.key === "."){
        calcInputDecimal();
      } else if(e.key === "+"){
        calcPerformOperation("+");
      } else if(e.key === "-"){
        calcPerformOperation("-");
      } else if(e.key === "*"){
        calcPerformOperation("*");
      } else if(e.key === "/"){
        e.preventDefault();
        calcPerformOperation("/");
      } else if(e.key === "Enter" || e.key === "="){
        calcEquals();
      } else if(e.key === "Escape"){
        calculator.classList.remove("visible");
      } else if(e.key === "Backspace"){
        calcBackspace();
      } else if(e.key === "c" || e.key === "C"){
        calcClear();
      }
    });

    function showAlert(msg){
      const a = document.getElementById("alert");
      a.style.display = "block";
      a.textContent = msg;
      a.scrollIntoView({ behavior:"smooth", block:"center" });
    }
    function hideAlert(){
      const a = document.getElementById("alert");
      a.style.display = "none";
      a.textContent = "";
    }

    function normalizeToNumber(str){
      if (str === null || str === undefined || str === "") return null;
      const s = String(str).replace(/\s/g, "").replace(/‚Ç¨/g, "").replace(",", ".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : null;
    }

    function readNumber(id){
      const el = document.getElementById(id);
      return normalizeToNumber(el ? el.value : null);
    }

    function almostEqual(a, b, eps=0.03){
      if(a === null || b === null) return false;
      return Math.abs(a - b) < eps;
    }

    function getIdentity(){
      const code = localStorage.getItem("userCode") || localStorage.getItem("codeEleve") || "ANONYME";
      const classe =
        localStorage.getItem("userClasse") ||
        ((typeof ANNUAIRE !== "undefined" && ANNUAIRE && ANNUAIRE[code]) ? ANNUAIRE[code] : "AUTRE");
      return { code, classe };
    }

    const items = [
      { id: 1, name: "Revenu artisan", val: 1650.00, cat: "recette-travail", label: "Recettes (Travail)" },
      { id: 2, name: "Prime d'activit√©", val: 112.45, cat: "recette-social", label: "Recettes (Social)" },
      { id: 3, name: "Loyer + charges atelier", val: 725.50, cat: "fixe", label: "D√©penses Fixes" },
      { id: 4, name: "Assurance professionnelle", val: 94.20, cat: "fixe", label: "D√©penses Fixes" },
      { id: 5, name: "Abonnement t√©l√©phone", val: 35.00, cat: "fixe", label: "D√©penses Fixes" },
      { id: 6, name: "Courses alimentaires", val: 430.45, cat: "courante", label: "D√©penses Courantes" },
      { id: 7, name: "Carburant utilitaire", val: 215.00, cat: "courante", label: "D√©penses Courantes" },
      { id: 8, name: "Hygi√®ne", val: 36.00, cat: "courante", label: "D√©penses Courantes" },
      { id: 9, name: "R√©paration outillage", val: 180.00, cat: "occas", label: "D√©penses Occasionnelles" },
      { id: 10, name: "Blouson de travail", val: 200.00, cat: "occas", label: "D√©penses Occasionnelles" }
    ];

    let selectedItem = null;
    const bank = document.getElementById("item-bank");

    items.sort(() => Math.random() - 0.5).forEach(item => {
      const el = document.createElement("div");
      el.className = "draggable-item";
      el.id = "i-" + item.id;
      el.innerHTML = `${item.name} (${item.val.toFixed(2)}‚Ç¨)
        <div class="correct-info" id="info-${item.id}">Doit √™tre dans : ${item.label}</div>`;
      el.addEventListener("click", (e) => {
        e.stopPropagation();
        if (selectedItem) selectedItem.classList.remove("selected");
        selectedItem = el;
        el.classList.add("selected");
      });
      bank.appendChild(el);
    });

    document.querySelectorAll(".drop-zone, #item-bank").forEach(zone => {
      zone.addEventListener("click", () => {
        if (selectedItem) {
          zone.appendChild(selectedItem);
          selectedItem.classList.remove("selected");
          selectedItem = null;
        }
      });
    });

    async function analyser(){
      hideAlert();

      const btn = document.getElementById("btn-analyser");
      if (btn && btn.disabled) return;

      const inStatus = document.querySelector('input[name="status"]:checked')?.value;
      if (!inStatus){
        showAlert("‚ö†Ô∏è Choisis l'√©tat du budget avant de valider");
        return;
      }

      // V√©rifier que tous les champs sont remplis
      const inR = readNumber("in-recettes");
      const inF = readNumber("in-fixes");
      const inC = readNumber("in-courantes");
      const inO = readNumber("in-occas");
      const inSolde = readNumber("in-solde");

      if(inR === null || inF === null || inC === null || inO === null || inSolde === null){
        showAlert("‚ö†Ô∏è Remplis tous les montants avant de valider");
        return;
      }

      if (btn) { btn.disabled = true; }

      let score = 0;

      // 10 points : classement (1 point par √©tiquette)
      items.forEach(item => {
        const el = document.getElementById("i-" + item.id);
        const info = document.getElementById("info-" + item.id);
        const parentCat = (el && el.parentElement && el.parentElement.dataset) ? el.parentElement.dataset.category : "";
        if (parentCat === item.cat) {
          score += 1;
          el.style.borderColor = "#28a745";
          if (info) info.style.display = "none";
        } else {
          el.style.borderColor = "#dc3545";
          if (info) info.style.display = "block";
        }
      });

      const totalD = Number((inF + inC + inO).toFixed(2));

      // Valeurs attendues
      const R_OK = 1762.45;
      const F_OK = 854.70;
      const C_OK = 681.45;
      const O_OK = 380.00;
      const D_OK = 1916.15;
      const SOLDE_OK = -153.70;
      const STATUS_OK = "deficitaire";

      // 10 points : calculs (2+2+2+2+1+1)
      if (almostEqual(inR, R_OK)) score += 2;
      if (almostEqual(inF, F_OK)) score += 2;
      if (almostEqual(inC, C_OK)) score += 2;
      if (almostEqual(inO, O_OK)) score += 2;
      if (almostEqual(inSolde, SOLDE_OK)) score += 1;
      if (inStatus === STATUS_OK) score += 1;

      const finalScore = Math.max(0, Math.min(20, Math.round(score)));

      document.getElementById("result-zone").style.display = "block";
      document.getElementById("final-score").innerText = `Score : ${finalScore} / 20`;

      document.querySelector("#syn-rec .val").innerHTML = `${inR.toFixed(2)}‚Ç¨ ${almostEqual(inR, R_OK) ? "‚úÖ" : "‚ùå"}`;
      document.querySelector("#syn-dep .val").innerHTML = `${totalD.toFixed(2)}‚Ç¨ ${almostEqual(totalD, D_OK) ? "‚úÖ" : "‚ùå"}`;
      document.querySelector("#syn-sol .val").innerHTML = `${inSolde.toFixed(2)}‚Ç¨ ${almostEqual(inSolde, SOLDE_OK) ? "‚úÖ" : "‚ùå"}`;
      document.querySelector("#syn-status .val").innerHTML = `${inStatus === STATUS_OK ? "D√©ficitaire ‚úÖ" : "Erreur ‚ùå"}`;

      window.scrollTo({ top: document.getElementById("result-zone").offsetTop, behavior: "smooth" });

      // Envoi Firebase
      try {
        const { code, classe } = getIdentity();
        if (window.db && typeof firebase !== "undefined") {
          const sentKey = "sent_budget_michel_" + code;
          if (!sessionStorage.getItem(sentKey)) {
            await db.collection("resultats_exercices").add({
              eleve: code,
              classe: classe,
              exercice: "Module D2 - Budget Michel",
              note: finalScore,
              total: 20,
              competences: { C1: finalScore, C2: finalScore },
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            sessionStorage.setItem(sentKey, "1");
          }
        }
      } catch(e) {
        console.error("Erreur lors de l'envoi Firebase : ", e);
      }

      setTimeout(()=>{
        if(btn) btn.disabled = false;
      }, 500);
    }
  </script>
</body>
</html>
