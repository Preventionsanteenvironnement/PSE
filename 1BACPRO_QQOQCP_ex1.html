<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover"/>
<title>QQOQCP – Entraînement Bac Pro (Version Finale)</title>
<style>
  :root{
    --bg:#0f172a; --text:#f1f5f9; --muted:#94a3b8;
    --line:rgba(255,255,255,.12);
    --c1:#8b5cf6; --c2:#3b82f6; --c3:#06b6d4; --c4:#10b981; --c5:#f59e0b; --err:#ef4444;
    --shadow:0 12px 30px rgba(0,0,0,.45); --radius:20px;
    --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
  body{
    margin:0; font-family:var(--font-ui); color:var(--text);
    background:var(--bg); padding:16px; padding-bottom:120px;
    background-image:
      radial-gradient(at 0% 0%, rgba(139,92,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 0%, rgba(59,130,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 100%, rgba(16,185,129,0.1) 0px, transparent 50%);
    background-attachment: fixed;
    overflow-x:hidden;
  }

  .wrap{max-width:1200px; margin:0 auto; display:grid; gap:20px}

  /* Page 0 */
  #introOverlay{
    position:fixed; inset:0;
    background: rgba(11, 18, 32, 0.88);
    backdrop-filter: blur(10px);
    z-index:2000;
    display:flex; align-items:center; justify-content:center;
    padding: max(18px, env(safe-area-inset-top)) 18px max(18px, env(safe-area-inset-bottom)) 18px;
  }
  .intro-card{
    width:100%; max-width:520px;
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.92), rgba(15, 23, 42, 0.96));
    border:1px solid rgba(255,255,255,0.16);
    border-radius:24px;
    padding:22px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.55);
    text-align:center;
  }
  .intro-kicker{ font-weight:900; letter-spacing:.2px; }
  .intro-title{
    margin:10px 0 12px 0;
    font-size:1.35rem;
    background:linear-gradient(90deg, #fff, #cbd5e1);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .intro-obj{
    margin:0;
    color:var(--text);
    line-height:1.55;
    font-size:1rem;
  }
  .intro-obj b{ color:#fff; }
  .intro-comp{
    margin-top:12px;
    display:inline-flex; align-items:center; justify-content:center;
    padding:8px 14px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.05);
    font-weight:900;
  }

  .btn{
    border:none; padding:12px 20px; border-radius:12px; font-weight:800; cursor:pointer;
    font-family:inherit; transition:all 0.2s; display:inline-flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-primary{ background:linear-gradient(135deg, var(--c2), var(--c1)); color:white; width:100%; }
  .btn-primary:active{ transform:scale(0.99); }
  .btn-success{ background:linear-gradient(135deg, var(--c4), #059669); color:#022c22; }
  .btn-danger{ background:rgba(239,68,68,0.2); border:1px solid var(--err); color:#fca5a5; }

  /* Navigation */
  .topbar{
    position:sticky;
    top: max(10px, env(safe-area-inset-top));
    z-index: 20;
    display:flex;
    gap:10px;
    justify-content:space-between;
    align-items:center;
  }
  .topbar .navgroup{ display:flex; gap:10px; flex-wrap:wrap; }
  .navbtn{
    padding:10px 12px;
    border-radius:14px;
    background: rgba(15, 23, 42, 0.8);
    border:1px solid var(--line);
    color:var(--text);
    font-weight:900;
    cursor:pointer;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .navbtn:active{ transform:scale(0.98); }
  .navbtn[hidden]{ display:none !important; }

  .header{ display:flex; flex-wrap:wrap; gap:16px; align-items:stretch; }
  .hero{
    flex:2 1 500px; border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(255,255,255,.03); backdrop-filter:blur(10px);
    padding:20px; box-shadow:var(--shadow); position:relative; overflow:hidden;
  }
  .hero h1{margin:0 0 8px 0; font-size:1.5rem; background:linear-gradient(90deg, #fff, #cbd5e1); -webkit-background-clip:text; -webkit-text-fill-color: transparent;}
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
  .chip{
    padding:6px 12px; border-radius:99px; font-size:0.8rem; font-weight:700;
    border:1px solid var(--line); background:rgba(255,255,255,.05); display:flex; align-items:center; gap:6px;
  }
  .top-actions{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;
  }
  .a11y{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
  .btn-a11y{
    padding:6px 10px; font-size:0.85rem; border-radius:10px;
    background:rgba(255,255,255,.08); color:var(--text); border:1px solid var(--line);
    cursor:pointer; font-weight:900;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-a11y:active{ transform:scale(0.98); }

  .help-line{
    margin-top:12px;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color: var(--muted);
    line-height:1.45;
    font-weight:800;
  }

  .hud{
    flex:1 1 300px; border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(15,23,42,.6); padding:16px; display:flex; flex-direction:column; gap:12px;
    justify-content:center;
  }
  .hud-row{display:flex; justify-content:space-between; align-items:center; font-weight:700; font-size:0.9rem}
  .progress-track{ height:8px; background:rgba(255,255,255,.1); border-radius:99px; overflow:hidden; }
  .progress-fill{
    height:100%; width:0%; background:linear-gradient(90deg, var(--c1), var(--c3));
    transition:width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .main-grid{ display:grid; grid-template-columns:1fr; gap:20px; }

  .card{
    border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(30,41,59,.6); padding:20px; box-shadow:var(--shadow);
    transition: transform 0.2s, border-color 0.2s;
  }

  textarea{
    background:rgba(0,0,0,.3); border:1px solid var(--line); color:white;
    padding:12px 16px; border-radius:12px; outline:none; font-family:inherit; font-weight:500;
    width: 100%; min-height: 110px; resize: vertical; font-size: 1rem; line-height: 1.5;
    transition:0.2s;
  }
  textarea:focus{ border-color:var(--c3); box-shadow:0 0 0 3px rgba(6,182,212,.2); }

  .stepper{display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap}
  .step{ width:30px; height:6px; border-radius:4px; background:rgba(255,255,255,.1); transition:0.3s; }
  .step.active{ background:var(--c3); box-shadow:0 0 10px var(--c3); }
  .step.done{ background:var(--c4); }

  .q-tag{
    display:inline-flex; align-items:center; gap:8px; padding:6px 12px;
    border-radius:99px; background:rgba(6,182,212,.1); color:var(--c3);
    font-weight:900; font-size:0.8rem; margin-bottom:12px; border:1px solid rgba(6,182,212,.2);
  }

  .situation-box{
    background:rgba(0,0,0,.2); border-radius:16px; padding:16px; border:1px solid var(--line);
    margin-bottom:16px; display:grid; gap:16px;
  }
  @media(min-width:600px){ .situation-box{grid-template-columns: 2fr 1fr;} }

  .sit-text{
    line-height:1.6;
    font-size:0.95rem;
    white-space: pre-line;
    text-align: justify;
  }

  .sit-img{
    width:100%; height:200px; object-fit:cover; border-radius:12px;
    border:1px solid var(--line); background:#000;
  }

  .prompt{
    font-size:1.1rem; font-weight:800; margin-bottom:16px; display:flex; gap:12px; align-items:start;
    background:rgba(255,255,255,.03); padding:16px; border-radius:16px; border-left:4px solid var(--c5);
  }

  .correction-box {
    margin-top:20px; padding:20px; border-radius:16px; background:rgba(16,185,129,0.05);
    border:1px solid rgba(16,185,129,0.3); display:none; animation: slideDown 0.4s ease;
  }
  .model-answer { font-weight:800; color:#6ee7b7; margin-bottom:10px; font-size:1.05rem; }
  .keywords-list { font-size:0.9rem; color:var(--muted); margin-bottom:16px; }
  .redac-tip{
    background:rgba(245,158,11,0.1); border-left:3px solid var(--c5); padding:10px;
    font-size:0.85rem; color:#fcd34d; margin-bottom:20px; border-radius:8px;
  }
  .eval-buttons { display:flex; gap:12px; flex-wrap:wrap; }

  .memo-card {
    background: rgba(15, 23, 42, 0.8); border:1px solid var(--line); border-radius:16px;
    padding:16px; margin-bottom:20px;
  }
  .memo-title {
    margin:0 0 12px 0; font-size:1.1rem; color:var(--text); text-align:center;
    border-bottom:1px solid var(--line); padding-bottom:8px;
  }
  .memo-list { display:grid; gap:8px; }
  .memo-row {
    display:flex; align-items:baseline; gap:10px; font-size:0.9rem;
    padding:8px; background:rgba(255,255,255,0.03); border-radius:8px;
  }
  .tag-q {
    padding:4px 8px; border-radius:6px; font-weight:900; color:white; font-size:0.8rem;
    min-width:70px; text-align:center; display:inline-block; box-shadow:0 2px 4px rgba(0,0,0,0.3);
  }

  @keyframes slideDown{ from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
  .pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes pop { 0%{transform:scale(0.9)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }

  #confetti{ position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }
  #finalScreen{ text-align:center; padding:40px 20px; display:none; }
  .big-score{ font-size:3rem; font-weight:900; margin:10px 0; background:linear-gradient(to right, var(--c4), var(--c3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

  @media (max-width:420px){
    body{ padding:12px; padding-bottom:120px; }
    .hero, .card{ padding:16px; }
  }
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div id="introOverlay">
  <div class="intro-card">
    <div class="intro-kicker">PSE</div>
    <div class="intro-title">QQOQCP – Entraînement Bac Pro (Version Finale)</div>
    <p class="intro-obj"><b>Objectif :</b> être capable de rédiger une réponse avec la méthode QQOQCP.</p>
    <div class="intro-comp">compétence 2</div>
    <button class="btn btn-primary" id="startBtn" type="button">Démarrer</button>
  </div>
</div>

<div class="wrap">

  <div class="topbar">
    <div class="navgroup">
      <button class="navbtn" type="button" id="btnBack">Retour</button>
      <button class="navbtn" type="button" id="btnTop">Haut</button>
    </div>
    <button class="navbtn" type="button" id="btnHome" hidden>Sommaire</button>
  </div>

  <div class="header">
    <div class="hero">
      <div class="top-actions">
        <div>
          <h1>QQOQCP – Entraînement Bac Pro</h1>
          <p style="color:var(--muted); margin:0">Analyse & Rédaction : Construire ses réponses</p>
        </div>
        <div class="a11y">
          <button class="btn-a11y" type="button" onclick="changeSize(-1)">A-</button>
          <button class="btn-a11y" type="button" onclick="changeSize(1)">A+</button>
        </div>
      </div>
      <div class="chips">
        <span class="chip" style="color:var(--c1)">● Méthodologie</span>
        <span class="chip" style="color:var(--c2)">● Compétence C2</span>
        <span class="chip" style="color:var(--c4)">● Auto-Évaluation</span>
      </div>
      <div class="help-line" id="helpLine">Lis le texte, puis répond avec une phrase complète.</div>
    </div>

    <div class="hud">
      <div class="hud-row">
        <span>Progression</span>
        <span id="txtProg">0 / 7</span>
      </div>
      <div class="progress-track"><div id="bar" class="progress-fill"></div></div>
      <div class="hud-row" style="margin-top:10px">
        <span style="color:var(--muted)">Score</span>
        <span id="txtScore" style="color:#fff; font-size:1.2rem">0</span>
      </div>
    </div>
  </div>

  <div class="main-grid" id="gameGrid" style="display:none">

    <div>

      <div class="card" id="qCard">
        <div class="stepper" id="stepper"></div>

        <div id="gameContent">
          <div class="q-tag" id="qTag">Tag</div>
          <h2 id="qTitle" style="margin:0 0 16px 0; font-size:1.4rem">Titre Question</h2>

          <div class="situation-box">
            <div class="sit-text" id="qText">Texte situation...</div>
            <img id="qImg" class="sit-img" src="" alt="Situation" onerror="this.style.display='none'">
          </div>

          <div class="prompt">
            <span style="color:var(--c5)">?</span>
            <span id="qPrompt">La question...</span>
          </div>

          <div id="inputZone">
            <textarea id="userAnswer" placeholder="Rédige ta réponse ici... (Fais une phrase complète)"></textarea>
            <div style="margin-top:16px; display:flex; justify-content:flex-end; flex-wrap:wrap; gap:10px">
              <button class="btn btn-primary" id="btnCheck" type="button">Vérifier ma réponse</button>
            </div>
          </div>

          <div id="correctionZone" class="correction-box">
            <div style="font-size:0.8rem; text-transform:uppercase; color:var(--muted); margin-bottom:4px">Réponse attendue</div>
            <div class="model-answer" id="modelAns">...</div>
            <div class="keywords-list" id="keywords">...</div>
            <div class="redac-tip" id="redacTip">...</div>

            <div style="border-top:1px solid rgba(255,255,255,0.1); margin-top:16px; padding-top:16px">
              <p style="margin:0 0 10px 0; font-weight:800">Ta réponse correspond-elle (sens et mots-clés) ?</p>
              <div class="eval-buttons">
                <button class="btn btn-success" id="btnYes" type="button">Oui</button>
                <button class="btn btn-danger" id="btnNo" type="button">Non</button>
              </div>
            </div>
          </div>

        </div>

        <div id="finalScreen">
          <h2>Session terminée</h2>
          <div class="big-score" id="finalScoreVal">0/7</div>
          <p id="finalMsg" style="color:var(--muted); margin-bottom:30px">Analyse...</p>
          <button class="btn btn-primary" type="button" onclick="location.reload()">Rejouer</button>
        </div>

      </div>

    </div>

    <div>
      <div class="memo-card">
        <h3 class="memo-title">Mémo QQOQCP</h3>
        <div class="memo-list">
          <div class="memo-row">
            <span class="tag-q" style="background:#dc2626">Quoi ?</span>
            <span>Nature du problème</span>
          </div>
          <div class="memo-row">
            <span class="tag-q" style="background:#ea580c">Qui ?</span>
            <span>Personnes concernées</span>
          </div>
          <div class="memo-row">
            <span class="tag-q" style="background:#b91c1c">Où ?</span>
            <span>Lieu du problème</span>
          </div>
          <div class="memo-row">
            <span class="tag-q" style="background:#7c3aed">Quand ?</span>
            <span>Moment / Durée</span>
          </div>
          <div class="memo-row">
            <span class="tag-q" style="background:#2563eb">Comment ?</span>
            <span>Cause / Manière</span>
          </div>
          <div class="memo-row">
            <span class="tag-q" style="background:#16a34a">Pourquoi ?</span>
            <span>Conséquence / Enjeu</span>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<script>
const HOME_URL = ""; // si vide, on cache le bouton Sommaire

let currentSize = 16;
function changeSize(delta) {
  currentSize += delta;
  if (currentSize < 12) currentSize = 12;
  if (currentSize > 24) currentSize = 24;
  document.documentElement.style.fontSize = currentSize + "px";
  const h1 = document.querySelector("h1");
  if(h1) h1.style.fontSize = (2 * (currentSize/16)) + "rem";
  try { localStorage.setItem("ui_font_size_px", String(currentSize)); } catch(e){}
}
(function restoreFont(){
  try{
    const v = parseInt(localStorage.getItem("ui_font_size_px") || "", 10);
    if(!isNaN(v)) { currentSize = v; changeSize(0); }
  }catch(e){}
})();

const QUESTIONS = [
  {
    title: "Situation 1 : Accident de Léa",
    tag: "Le Problème",
    text: `Léa, titulaire d’un bac pro Métiers du commerce et de la vente, travaille dans un hypermarché employant 135 salariés. À 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est située au sous-sol et accessible par un escalier interne en colimaçon. Lorsque Léa descend l’escalier, elle heurte des cartons stockés sur les deux dernières marches, perd l’équilibre et chute. Avant l’arrivée des secours, Léa est prise en charge par le SST. Suite à cet accident du travail, elle présente une double fracture du tibia qui nécessite un arrêt de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "Formulez le problème posé dans la situation.",
    model: "C'est un accident du travail (chute) avec une double fracture du tibia.",
    keys: "Mots-clés : accident du travail, chute, fracture du tibia.",
    tip: "Conseil : Commence par un groupe nominal : Un accident..., Une chute..."
  },
  {
    title: "Situation 1 : Accident de Léa",
    tag: "Comment ?",
    text: `Léa, titulaire d’un bac pro Métiers du commerce et de la vente, travaille dans un hypermarché employant 135 salariés. À 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est située au sous-sol et accessible par un escalier interne en colimaçon. Lorsque Léa descend l’escalier, elle heurte des cartons stockés sur les deux dernières marches, perd l’équilibre et chute. Avant l’arrivée des secours, Léa est prise en charge par le SST. Suite à cet accident du travail, elle présente une double fracture du tibia qui nécessite un arrêt de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "De quelle manière cela s'est-il passé ?",
    model: "En descendant l'escalier, elle heurte des cartons sur les dernières marches, perd l'équilibre et chute.",
    keys: "Mots-clés : descendant, heurte, cartons, perd l'équilibre, chute.",
    tip: "Conseil : Décris l'action précise qui provoque l'accident."
  },
  {
    title: "Situation 1 : Accident de Léa",
    tag: "Quand ?",
    text: `Léa, titulaire d’un bac pro Métiers du commerce et de la vente, travaille dans un hypermarché employant 135 salariés. À 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est située au sous-sol et accessible par un escalier interne en colimaçon. Lorsque Léa descend l’escalier, elle heurte des cartons stockés sur les deux dernières marches, perd l’équilibre et chute. Avant l’arrivée des secours, Léa est prise en charge par le SST. Suite à cet accident du travail, elle présente une double fracture du tibia qui nécessite un arrêt de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "Quand cela s'est-il passé (date et heure) ?",
    model: "Le 4 novembre à 10 heures.",
    keys: "Mots-clés : 4 novembre, 10 heures.",
    tip: "Conseil : Donne la date ET l'heure."
  },
  {
    title: "Situation 2 : Le Stress",
    tag: "Qui ?",
    text: `Selon une étude [...], plus de la moitié des Français (60 %) ont éprouvé une augmentation de leur niveau de stress au cours des six derniers mois. Un chiffre qui est encore plus important chez les femmes (68 %), mais aussi chez les jeunes de moins de 35 ans (66 %). Parmi ces derniers, la tranche d’âge des 18-24 ans est d’ailleurs la plus exposée au stress (70 %). La situation sanitaire, mais aussi leur inquiétude face à leur avenir et celui de leurs enfants, ont été les principaux facteurs de ce sentiment d’anxiété. Une anxiété qui va souvent de pair avec une baisse de la qualité du sommeil.`,
    img: "situation-stress.jpg",
    prompt: "Quelles sont les personnes concernées (en général) ?",
    model: "Plus de la moitié des Français (60 %) sont concernés.",
    keys: "Mots-clés : Français, 60 %.",
    tip: "Conseil : Cite le pourcentage global."
  },
  {
    title: "Situation 2 : Le Stress",
    tag: "Quoi / Causes",
    text: `Selon une étude [...], plus de la moitié des Français (60 %) ont éprouvé une augmentation de leur niveau de stress au cours des six derniers mois. Un chiffre qui est encore plus important chez les femmes (68 %), mais aussi chez les jeunes de moins de 35 ans (66 %). Parmi ces derniers, la tranche d’âge des 18-24 ans est d’ailleurs la plus exposée au stress (70 %). La situation sanitaire, mais aussi leur inquiétude face à leur avenir et celui de leurs enfants, ont été les principaux facteurs de ce sentiment d’anxiété. Une anxiété qui va souvent de pair avec une baisse de la qualité du sommeil.`,
    img: "situation-stress.jpg",
    prompt: "Quelles sont les causes du problème ?",
    model: "La situation sanitaire et l'inquiétude face à l'avenir (et celui des enfants).",
    keys: "Mots-clés : situation sanitaire, inquiétude, avenir.",
    tip: "Conseil : Donne les deux causes principales."
  },
  {
    title: "Situation 3 : Le Bruit",
    tag: "Où ?",
    text: `Près de 70 % des Français se déclarent gênés par le bruit, en particulier dans les villes où il constitue l’une des principales sources de plaintes des habitants. De simple désagrément, il peut devenir une réelle source de stress constituant alors un problème de santé portant atteinte à la qualité de vie.
Le coût social du bruit en France a même été évalué par l’ADEME à près de 147 milliards d’euros par an !
L’organisme humain ne s’habitue pas au bruit. Si nous connaissons depuis longtemps les effets des niveaux sonores élevés sur le système auditif, nous savons maintenant que même des bruits de faible intensité peuvent nuire au bien-être des individus et avoir des répercussions sur leur santé.`,
    img: "situation-bruit.jpg",
    prompt: "Où le problème se pose-t-il principalement ?",
    model: "En particulier dans les villes.",
    keys: "Mots-clés : villes.",
    tip: "Conseil : Repère le lieu dès la première phrase."
  },
  {
    title: "Situation 3 : Le Bruit",
    tag: "Pourquoi ?",
    text: `Près de 70 % des Français se déclarent gênés par le bruit, en particulier dans les villes où il constitue l’une des principales sources de plaintes des habitants. De simple désagrément, il peut devenir une réelle source de stress constituant alors un problème de santé portant atteinte à la qualité de vie.
Le coût social du bruit en France a même été évalué par l’ADEME à près de 147 milliards d’euros par an !
L’organisme humain ne s’habitue pas au bruit. Si nous connaissons depuis longtemps les effets des niveaux sonores élevés sur le système auditif, nous savons maintenant que même des bruits de faible intensité peuvent nuire au bien-être des individus et avoir des répercussions sur leur santé.`,
    img: "situation-bruit.jpg",
    prompt: "Pourquoi faut-il régler ce problème (conséquences) ?",
    model: "Le bruit provoque du stress, nuit à la santé et à la qualité de vie, et a un coût social très élevé.",
    keys: "Mots-clés : stress, santé, qualité de vie, coût social.",
    tip: "Conseil : Donne au moins une conséquence santé et une conséquence économique."
  }
];

let state = { idx: 0, score: 0 };
const $ = (id) => document.getElementById(id);

function setHelp(msg){
  const el = $("helpLine");
  if(el) el.textContent = msg;
}

function initNav(){
  const homeBtn = $("btnHome");
  if(HOME_URL && HOME_URL.trim() !== ""){
    homeBtn.hidden = false;
    homeBtn.addEventListener("click", ()=>{ window.location.href = HOME_URL; });
  }else{
    homeBtn.hidden = true;
  }

  $("btnBack").addEventListener("click", ()=>{
    if(history.length > 1) history.back();
    else window.scrollTo({ top: 0, behavior: "smooth" });
  });

  $("btnTop").addEventListener("click", ()=>{
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
}

function startGame(){
  $("introOverlay").style.display = "none";
  $("gameGrid").style.display = "grid";
  state.idx = 0;
  state.score = 0;
  $("finalScreen").style.display = "none";
  $("gameContent").style.display = "block";
  setHelp("Lis le texte, puis répond avec une phrase complète.");
  loadQuestion();
  window.scrollTo({ top: 0, behavior: "instant" });
}

function loadQuestion(){
  if(state.idx >= QUESTIONS.length){ showFinal(); return; }
  const q = QUESTIONS[state.idx];

  $("qTitle").textContent = q.title;
  $("qTag").textContent = q.tag;
  $("qText").textContent = q.text;
  $("qImg").style.display = "block";
  $("qImg").src = q.img;
  $("qPrompt").textContent = q.prompt;

  $("userAnswer").value = "";
  $("userAnswer").disabled = false;

  $("inputZone").style.display = "block";
  $("correctionZone").style.display = "none";
  $("btnCheck").style.display = "inline-flex";

  $("qCard").classList.remove("pop");

  updateHUD();
  setHelp("Cherche les informations dans le texte.");
}

function checkAnswer(){
  const userTxt = $("userAnswer").value.trim();
  if(userTxt.length < 5){
    setHelp("Réponse trop courte. Fais une phrase.");
    return;
  }

  const q = QUESTIONS[state.idx];
  $("userAnswer").disabled = true;
  $("btnCheck").style.display = "none";

  $("modelAns").textContent = q.model;
  $("keywords").textContent = q.keys;
  $("redacTip").textContent = q.tip;

  $("correctionZone").style.display = "block";
  setHelp("Compare avec la réponse attendue puis auto-évalue-toi.");
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function selfEval(isCorrect){
  if(isCorrect){
    state.score++;
    setHelp("OK. Continue.");
    $("qCard").classList.add("pop");
    setTimeout(()=>$("qCard").classList.remove("pop"), 500);
  } else {
    setHelp("OK. Relis le texte et repère les mots-clés.");
  }

  state.idx++;
  loadQuestion();
}

function updateHUD(){
  $("txtScore").textContent = state.score;
  $("txtProg").textContent = `${state.idx}/${QUESTIONS.length}`;
  $("bar").style.width = `${(state.idx / QUESTIONS.length)*100}%`;

  const st = $("stepper");
  st.innerHTML = "";
  for(let i=0; i<QUESTIONS.length; i++){
    st.innerHTML += `<div class="step ${i===state.idx ? "active" : (i<state.idx ? "done" : "")}"></div>`;
  }
}

function showFinal(){
  $("gameContent").style.display = "none";
  $("finalScreen").style.display = "block";
  $("finalScoreVal").textContent = `${state.score} / ${QUESTIONS.length}`;

  const pct = state.score / QUESTIONS.length;
  const msg = pct > 0.8 ? "Excellent. Continue comme ça." : "Bon entraînement. Sois plus précis avec les infos du texte.";
  $("finalMsg").textContent = msg;

  setHelp("Session terminée.");
  if(pct > 0.8) launchConfetti();
}

function launchConfetti(){
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d", { alpha:true });
  const resize = ()=>{ canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
  resize();

  const pieces = [];
  for(let i=0; i<100; i++){
    pieces.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height - canvas.height,
      color: `hsl(${Math.random()*360}, 100%, 50%)`,
      size: Math.random()*8+4,
      speed: Math.random()*3+2,
      drift: (Math.random()-0.5)*1.2
    });
  }

  const start = Date.now();
  let rafId = 0;

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p => {
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, p.size, p.size);
      p.y += p.speed;
      p.x += p.drift;
      if(p.y > canvas.height + 10) p.y = -10;
      if(p.x < -10) p.x = canvas.width + 10;
      if(p.x > canvas.width + 10) p.x = -10;
    });
    if(Date.now() - start < 5000){
      rafId = requestAnimationFrame(draw);
    } else {
      cancelAnimationFrame(rafId);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      window.removeEventListener("resize", resize);
    }
  }
  window.addEventListener("resize", resize, { passive:true });
  draw();
}

$("startBtn").addEventListener("click", startGame);
$("btnCheck").addEventListener("click", checkAnswer);
$("btnYes").addEventListener("click", ()=>selfEval(true));
$("btnNo").addEventListener("click", ()=>selfEval(false));

initNav();
updateHUD();
setHelp("Lis le texte, puis répond avec une phrase complète.");
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentDocId = null;
  let startTime = Date.now();

  function getIdentity() { return localStorage.getItem("cockpit_student_id"); }

  async function demarrerVisite() {
    try {
      let userCode = getIdentity() || "ANONYME";
      let userClass = localStorage.getItem("cockpit_student_class") || "VISITEUR";
      const pageName = document.title || window.location.pathname.split("/").pop();
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);

      const ref = await addDoc(collection(db, "statistiques_usage"), {
        page: pageName,
        userCode: userCode,
        classe: userClass,
        device: isMobile ? "Mobile" : "Desktop",
        action: "Consultation",
        duree: 0,
        timestamp: serverTimestamp(),
        date: new Date().toISOString()
      });

      currentDocId = ref.id;

      setInterval(async () => {
        if (currentDocId && document.visibilityState === "visible") {
          try {
            await updateDoc(doc(db, "statistiques_usage", currentDocId), {
              duree: Math.floor((Date.now() - startTime) / 1000)
            });
          } catch (e) {}
        }
      }, 10000);

    } catch (e) { console.warn("Erreur Tracker", e); }
  }

  demarrerVisite();
</script>

</body>
</html>
