<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flashcards RPS</title>
  <style>
    :root {
      --primary: #6366f1; --bg: #f3f4f6; --text: #1f2937;
      --card-bg: #ffffff; --radius: 20px;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background-color: var(--bg); color: var(--text);
      margin: 0; padding: 15px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh;
    }
    .container { width: 100%; max-width: 500px; margin: 0 auto; }

    /* --- CHOIX DU MODE (DESIGN VISUEL) --- */
    .choice-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;
    }
    .choice-card {
      background: white; border-radius: var(--radius); padding: 25px 15px;
      text-align: center; cursor: pointer; transition: transform 0.2s, border-color 0.2s;
      border: 3px solid transparent; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .choice-card:hover { transform: translateY(-3px); }
    .choice-card.selected { border-color: var(--primary); background: #eef2ff; }
    
    .icon { font-size: 3rem; display: block; margin-bottom: 10px; }
    .label { font-weight: 800; font-size: 1.1rem; color: var(--text); display: block; }
    .sub { font-size: 0.8rem; color: #6b7280; font-weight: 500; }

    /* --- INPUTS CACH√âS --- */
    #login-form {
      display: none; background: white; padding: 20px; border-radius: var(--radius);
      margin-top: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); animation: slideUp 0.3s;
    }
    @keyframes slideUp { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

    input, select {
      width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid #e5e7eb;
      border-radius: 12px; font-size: 1rem; box-sizing: border-box; background: #f9fafb;
    }
    input:focus, select:focus { border-color: var(--primary); outline: none; background: white; }

    /* --- BUTTONS & GAME UI --- */
    .btn {
      width: 100%; padding: 16px; border: none; border-radius: 50px;
      font-size: 1.1rem; font-weight: 800; cursor: pointer; color: white;
      background: var(--primary); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
      transition: 0.2s;
    }
    .btn:active { transform: scale(0.98); }

    .screen { display: none; }
    .screen.active { display: block; }

    /* FLASHCARD STYLE */
    .flashcard-container { perspective: 1000px; height: 380px; margin-bottom: 20px; cursor: pointer; }
    .flashcard {
      width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
      transition: transform 0.6s; border-radius: var(--radius); box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .flashcard.flipped { transform: rotateY(180deg); }
    .card-face {
      position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 20px; box-sizing: border-box; background: white; border-radius: var(--radius); text-align: center;
    }
    .card-back { background: #fff; transform: rotateY(180deg); border: 2px solid var(--primary); }
    .card-front h2 { color: var(--primary); font-size: 1.4rem; }
    
    .eval-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; opacity: 0; pointer-events: none; transition: 0.3s; }
    .eval-btns.visible { opacity: 1; pointer-events: auto; }
    .btn-fail { background: #fee2e2; color: #991b1b; box-shadow: none; }
    .btn-success { background: #dcfce7; color: #166534; box-shadow: none; }

    /* PROGRESS */
    .progress-bar-bg { height: 6px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
    .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
    
    /* RESULT */
    .score-circle {
      width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 50%;
      background: #eef2ff; color: var(--primary); font-size: 2.5rem; font-weight: 800;
      display: flex; align-items: center; justify-content: center; border: 4px solid var(--primary);
    }
  </style>
</head>
<body>

<div class="container">

  <div id="screen-welcome" class="screen active">
    <h1 style="text-align:center; margin-bottom:5px;">üóÇÔ∏è Flashcards RPS</h1>
    <p style="text-align:center; color:#6b7280; margin-top:0;">Choisis ton mode :</p>

    <div class="choice-grid">
      <div class="choice-card" onclick="startGuest()">
        <span class="icon">üëª</span>
        <span class="label">INVIT√â</span>
        <span class="sub">Juste s'entra√Æner</span>
      </div>

      <div class="choice-card" onclick="showLogin(this)">
        <span class="icon">üéì</span>
        <span class="label">√âL√àVE</span>
        <span class="sub">Sauvegarder</span>
      </div>
    </div>

    <div id="login-form">
      <input type="text" id="student-id" placeholder="Ton Code (ex: B43)">
      <select id="student-class">
        <option value="">Ta Classe...</option>
        <option value="2BACPRO_GATL1">2BACPRO_GATL1</option><option value="2BACPRO_GATL2">2BACPRO_GATL2</option>
        <option value="1BACPRO_AGO1">1BACPRO_AGO1</option><option value="1BACPRO_AGO2">1BACPRO_AGO2</option>
        <option value="TBACPRO_AGO1">TBACPRO_AGO1</option><option value="TBACPRO_AGO2">TBACPRO_AGO2</option>
        <option value="2_MELEC">2_MELEC</option><option value="1_MELEC">1_MELEC</option><option value="T_MELEC">T_MELEC</option>
        <option value="CAP_PSR1">CAP_PSR1</option><option value="CAP_PSR2">CAP_PSR2</option>
        <option value="CAP_VAN1">CAP_VAN1</option><option value="CAP_VAN2">CAP_VAN2</option>
        <option value="CAP_CAN1">CAP_CAN1</option><option value="CAP_CAN2">CAP_CAN2</option>
        <option value="CAP_HORT1">CAP_HORT1</option><option value="CAP_HORT2">CAP_HORT2</option>
        <option value="CAP_JP1">CAP_JP1</option><option value="CAP_JP2">CAP_JP2</option>
        <option value="Autre">Autre</option>
      </select>
      <button class="btn" onclick="startStudent()">C'est parti üöÄ</button>
    </div>
  </div>

  <div id="screen-game" class="screen">
    <div class="progress-bar-bg"><div id="progress-fill" class="progress-bar-fill"></div></div>
    
    <div class="flashcard-container" onclick="flipCard()">
      <div class="flashcard" id="active-card">
        <div class="card-face card-front">
          <h2 id="q-text">...</h2>
          <div style="font-size:0.8rem; color:#9ca3af; margin-top:15px;">(Tape pour voir la r√©ponse)</div>
        </div>
        <div class="card-face card-back">
          <p id="a-text" style="font-size:1.1rem; line-height:1.5;">...</p>
        </div>
      </div>
    </div>

    <div class="eval-btns" id="eval-btns">
      <button class="btn btn-fail" onclick="rateCard(0)">‚ùå Pas su</button>
      <button class="btn btn-success" onclick="rateCard(1)">‚úÖ Su</button>
    </div>
  </div>

  <div id="screen-result" class="screen" style="text-align:center;">
    <div style="background:white; padding:30px; border-radius:20px; box-shadow:0 10px 25px rgba(0,0,0,0.05);">
      <h2>Termin√© !</h2>
      <div id="loading-txt" style="display:none; color:#6366f1; font-weight:bold; margin-bottom:15px;">Sauvegarde...</div>
      
      <div id="result-content">
        <button class="btn" onclick="showScore()">Voir mon score</button>
      </div>

      <div id="final-score-box" style="display:none; margin-top:20px;">
        <div class="score-circle" id="score-display">--</div>
        <div id="msg-display" style="color:#4b5563; margin-bottom:20px;"></div>
        <button class="btn" style="background:transparent; color:#6b7280;" onclick="location.reload()">Rejouer ‚Ü∫</button>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- VARIABLES ---
  const cardsData = [
    { q: "C'est quoi un RPS ?", a: "Risque Psycho-Social : danger sant√© mentale/physique.", comp: "C1_Traiter_Info" },
    { q: "Le Burn-out ?", a: "√âpuisement par surcharge de travail.", comp: "C1_Traiter_Info" },
    { q: "Le Bore-out ?", a: "√âpuisement par l'ennui.", comp: "C1_Traiter_Info" },
    { q: "Le Brown-out ?", a: "Perte de sens au travail.", comp: "C1_Traiter_Info" },
    { q: "D√©finition Stress", a: "D√©s√©quilibre contraintes / ressources.", comp: "C2_Analyse" },
    { q: "Violence Interne", a: "Entre coll√®gues (harc√®lement, conflit).", comp: "C2_Analyse" },
    { q: "Violence Externe", a: "Agression par public (clients, √©l√®ves).", comp: "C2_Analyse" },
    { q: "Harc√®lement Moral", a: "Actes r√©p√©t√©s d√©gradant conditions.", comp: "C3_Expliquer" },
    { q: "Harc√®lement Sexuel", a: "Propos/comportements sexuels impos√©s.", comp: "C3_Expliquer" },
    { q: "Charge mentale", a: "Devoir penser √† tout, tout le temps.", comp: "C2_Analyse" },
    { q: "Lien TMS / RPS", a: "Stress contracte muscles = TMS.", comp: "C3_Expliquer" },
    { q: "Conflit de valeurs", a: "Faire chose qu'on d√©sapprouve.", comp: "C2_Analyse" },
    { q: "Ins√©curit√© emploi", a: "Peur de perdre son poste.", comp: "C1_Traiter_Info" },
    { q: "Exigence √©motionnelle", a: "Cacher ses √©motions (sourire forc√©).", comp: "C2_Analyse" },
    { q: "Manque d'autonomie", a: "Pas de d√©cision sur son travail.", comp: "C2_Analyse" },
    { q: "Rapports d√©grad√©s", a: "Mauvaise ambiance, pas de soutien.", comp: "C2_Analyse" },
    { q: "R√¥le M√©decin Travail", a: "Surveille sant√©, conseille employeur.", comp: "C1_Traiter_Info" },
    { q: "R√¥le CSE", a: "Repr√©sentants personnel, alerte.", comp: "C1_Traiter_Info" },
    { q: "Le DUERP", a: "Document Unique : liste tous risques.", comp: "C3_Expliquer" },
    { q: "Exemple Pr√©vention", a: "Adapter charge, former managers.", comp: "C4_Solution" }
  ];

  let studentData = { id: "Anonyme", classe: "" };
  let isAnonymous = true;
  let currentIndex = 0;
  let score = 0;
  let isFlipped = false;
  let startTime = null;
  let competencesScores = { "C1_Traiter_Info": {t:0,r:0}, "C2_Analyse": {t:0,r:0}, "C3_Expliquer": {t:0,r:0}, "C4_Solution": {t:0,r:0} };

  // --- MOUCHARD (TOUJOURS ACTIF) ---
  try { addDoc(collection(db, "statistiques_usage"), { date: new Date(), page: "Flashcards RPS", action: "Ouverture", device: navigator.userAgent }); } catch(e){}

  // --- LOGIQUE UI ---
  window.startGuest = () => {
    isAnonymous = true;
    startGame();
  };

  window.showLogin = (el) => {
    // Effet visuel de s√©lection
    document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('login-form').style.display = 'block';
  };

  window.startStudent = () => {
    const id = document.getElementById('student-id').value.trim();
    const cl = document.getElementById('student-class').value;
    if(!id || !cl) { alert("Merci de mettre un Code et une Classe pour le mode √âl√®ve !"); return; }
    
    isAnonymous = false;
    studentData = { id: id, classe: cl };
    startGame();
  };

  function startGame() {
    document.getElementById('screen-welcome').classList.remove('active');
    document.getElementById('screen-game').classList.add('active');
    startTime = new Date();
    cardsData.sort(() => Math.random() - 0.5); // M√©lange
    loadCard(0);
  }

  function loadCard(i) {
    const cardEl = document.getElementById('active-card');
    cardEl.classList.remove('flipped');
    isFlipped = false;
    document.getElementById('eval-btns').classList.remove('visible');
    
    setTimeout(() => {
      document.getElementById('q-text').innerText = cardsData[i].q;
      document.getElementById('a-text').innerText = cardsData[i].a;
      document.getElementById('progress-fill').style.width = `${(i / cardsData.length) * 100}%`;
    }, 200);
  }

  window.flipCard = () => {
    if(isFlipped) return;
    document.getElementById('active-card').classList.add('flipped');
    isFlipped = true;
    setTimeout(() => document.getElementById('eval-btns').classList.add('visible'), 300);
  };

  window.rateCard = (pt) => {
    score += pt;
    // Comp√©tences
    const comp = cardsData[currentIndex].comp;
    if(competencesScores[comp]) { competencesScores[comp].t++; if(pt===1) competencesScores[comp].r++; }

    currentIndex++;
    if(currentIndex < cardsData.length) loadCard(currentIndex);
    else {
      document.getElementById('screen-game').classList.remove('active');
      document.getElementById('screen-result').classList.add('active');
    }
  };

  window.showScore = async () => {
    // UI Updates
    document.getElementById('result-content').style.display = 'none';
    document.getElementById('final-score-box').style.display = 'block';
    document.getElementById('score-display').innerText = `${score}/${cardsData.length}`;
    
    const msg = score >= 15 ? "Excellent ! üí™" : (score >= 10 ? "Bien jou√© ! üëç" : "√Ä revoir un peu üßê");
    document.getElementById('msg-display').innerText = msg;

    // ENVOI SI √âL√àVE
    if(!isAnonymous) {
      const loading = document.getElementById('loading-txt');
      loading.style.display = 'block';
      
      const duration = Math.floor((new Date() - startTime)/1000);
      const note20 = Math.round((score/cardsData.length)*20);
      
      let finalComp = {};
      for(const [k,v] of Object.entries(competencesScores)) {
        if(v.t > 0) {
          let r = v.r/v.t;
          finalComp[k] = r < 0.25 ? 0 : (r < 0.5 ? 1 : (r < 0.8 ? 2 : 3));
        } else finalComp[k] = null;
      }

      try {
        await addDoc(collection(db, "evaluations_competences"), {
          date: new Date(), identifiant: studentData.id, classe: studentData.classe,
          exercice_titre: "Flashcards RPS", note_finale: note20, temps_secondes: duration,
          competences: finalComp
        });
        loading.innerText = "‚úÖ Progression sauvegard√©e !";
        loading.style.color = "#16a34a";
      } catch(e) {
        loading.innerText = "Erreur sauvegarde (mais ton score est bon !)";
        loading.style.color = "orange";
      }
    } else {
      document.getElementById('msg-display').innerHTML += "<br><small>(Mode invit√© : non enregistr√©)</small>";
    }
  };
</script>

</body>
</html>
