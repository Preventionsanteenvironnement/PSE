<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Module C9 : Flashcards RPS (20 cartes)</title>
  <style>
    :root {
      --primary: #6366f1;
      --secondary: #eef2ff;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #1f2937;
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --radius: 16px;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    /* --- √âCRANS --- */
    .screen { display: none; animation: fadeIn 0.4s ease-out; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- HEADER --- */
    .header-card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      margin-bottom: 20px;
    }
    h1 { color: var(--primary); margin: 0 0 10px 0; font-size: 1.5rem; }
    
    .input-group { text-align: left; margin-bottom: 15px; }
    label { display: block; font-weight: 600; margin-bottom: 5px; color: #374151; font-size: 0.9rem; }
    input, select {
      width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1rem;
      box-sizing: border-box; transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--primary); outline: none; }

    /* --- FLASHCARD --- */
    .flashcard-container {
      perspective: 1000px;
      height: 350px;
      position: relative;
      margin-bottom: 20px;
      cursor: pointer;
    }
    .flashcard {
      width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
      transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
      border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .flashcard.flipped { transform: rotateY(180deg); }
    
    .card-face {
      position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 20px; box-sizing: border-box; border-radius: var(--radius); text-align: center;
      background: white; border: 2px solid var(--secondary);
    }
    .card-front { background: #ffffff; }
    .card-front h2 { color: var(--primary); font-size: 1.3rem; }
    .card-front .hint { font-size: 0.8rem; color: #9ca3af; margin-top: 15px; font-style: italic; }
    
    .card-back { background: #fdfeff; transform: rotateY(180deg); border-color: var(--primary); }
    .card-back p { color: #1f2937; font-size: 1.1rem; line-height: 1.6; }

    /* --- BOUTONS --- */
    .btn {
      width: 100%; padding: 15px; border: none; border-radius: 50px;
      font-size: 1.1rem; font-weight: bold; cursor: pointer;
      transition: transform 0.2s; margin-top: 10px;
    }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); }
    .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); }
    
    .eval-btns {
      display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .eval-btns.visible { opacity: 1; pointer-events: auto; }
    .btn-fail { background: #fee2e2; color: #991b1b; }
    .btn-success { background: #dcfce7; color: #166534; }

    /* --- PROGRESS --- */
    .progress-bar-bg {
      flex-grow: 1; height: 8px; background: #e5e7eb; border-radius: 4px; margin: 0 10px; overflow: hidden;
    }
    .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
    .progress-wrapper { display:flex; align-items:center; justify-content:space-between; margin-bottom:15px; font-weight:bold; color:#6b7280; }

    /* --- RESULTATS --- */
    .result-card { background: var(--card-bg); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; }
    .score-circle {
      width: 120px; height: 120px; border-radius: 50%; background: var(--secondary); color: var(--primary);
      display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold;
      margin: 0 auto 20px auto; border: 5px solid var(--primary);
    }
    .error-msg { color: var(--danger); display: none; margin-top: 10px; font-weight: bold;}

    /* Audio */
    .btn-audio {
      background: none; border: 2px solid #e5e7eb; border-radius: 50%; width: 30px; height: 30px;
      display: inline-flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); margin-left: 8px;
    }
  </style>
</head>
<body>

<div class="container">

  <div id="screen-welcome" class="screen active">
    <div class="header-card">
      <h1>üóÇÔ∏è Flashcards : RPS</h1>
      <p>20 cartes pour ma√Ætriser les risques psychosociaux.</p>
      
      <div style="background:#e0e7ff; padding:15px; border-radius:12px; margin-bottom:20px; text-align:left; font-size:0.95rem;">
        <strong>Consigne :</strong> Lis la question, retourne la carte, et indique honn√™tement si tu connaissais la r√©ponse.
      </div>

      <div class="input-group">
        <label>Identifiant √©l√®ve (ex: B43) :</label>
        <input type="text" id="student-id" placeholder="Ton code √©l√®ve...">
      </div>

      <div class="input-group">
        <label>Classe :</label>
        <select id="student-class">
          <option value="">-- Choisis ta classe --</option>
          <option value="2BACPRO_GATL1">2BACPRO_GATL1</option><option value="2BACPRO_GATL2">2BACPRO_GATL2</option>
          <option value="1BACPRO_AGO1">1BACPRO_AGO1</option><option value="1BACPRO_AGO2">1BACPRO_AGO2</option>
          <option value="TBACPRO_AGO1">TBACPRO_AGO1</option><option value="TBACPRO_AGO2">TBACPRO_AGO2</option>
          <option value="2_MELEC">2_MELEC</option><option value="1_MELEC">1_MELEC</option><option value="T_MELEC">T_MELEC</option>
          <option value="CAP_PSR1">CAP_PSR1</option><option value="CAP_PSR2">CAP_PSR2</option>
          <option value="CAP_VAN1">CAP_VAN1</option><option value="CAP_VAN2">CAP_VAN2</option>
          <option value="CAP_CAN1">CAP_CAN1</option><option value="CAP_CAN2">CAP_CAN2</option>
          <option value="CAP_HORT1">CAP_HORT1</option><option value="CAP_HORT2">CAP_HORT2</option>
          <option value="CAP_JP1">CAP_JP1</option><option value="CAP_JP2">CAP_JP2</option>
          <option value="Autre">Autre</option>
        </select>
      </div>

      <div id="start-error" class="error-msg"></div>
      <button class="btn btn-primary" onclick="startModule()">Commencer</button>
    </div>
  </div>

  <div id="screen-game" class="screen">
    <div class="progress-wrapper">
      <span id="current-index">1 / 20</span>
      <div class="progress-bar-bg"><div id="progress-fill" class="progress-bar-fill"></div></div>
    </div>

    <div class="flashcard-container" onclick="flipCard()">
      <div class="flashcard" id="active-card">
        <div class="card-face card-front">
          <h2>...</h2>
          <div class="hint">(Tape pour retourner)</div>
        </div>
        <div class="card-face card-back">
          <p>...</p>
        </div>
      </div>
    </div>

    <div class="eval-btns" id="eval-btns">
      <button class="btn btn-fail" onclick="rateCard(0)">‚ùå Pas su</button>
      <button class="btn btn-success" onclick="rateCard(1)">‚úÖ Je savais</button>
    </div>
  </div>

  <div id="screen-result" class="screen">
    <div class="result-card">
      <h2>Bilan de m√©morisation</h2>
      <p>Voici ton r√©sultat d'auto-√©valuation.</p>
      
      <button id="btn-reveal" class="btn btn-primary" onclick="revealAndSend()">VOIR MON R√âSULTAT</button>

      <div id="score-zone" style="display:none; margin-top:20px; animation: fadeIn 0.5s;">
        <div class="score-circle" id="final-score-display">--</div>
        <div id="feedback-text" style="margin-bottom:25px; color:#4b5563;"></div>
        <button class="btn" style="background:transparent; color:#6b7280; font-size:0.9rem;" onclick="location.reload()">Recommencer l'entra√Ænement</button>
      </div>
      
      <div id="validation-error" class="error-msg"></div>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- MOUCHARD STATS (Le nouveau capteur de visite) ---
  function trackVisit() {
      try {
          addDoc(collection(db, "statistiques_usage"), {
              date: new Date(),
              page: "Flashcards RPS",
              action: "Ouverture Exercice",
              device: navigator.userAgent
          });
          console.log("Visite track√©e.");
      } catch(e) { console.log("Erreur tracker", e); }
  }
  // On lance le tracking tout de suite
  trackVisit();


  // 20 Cartes RPS avec COMP√âTENCES (C1, C2, C3, C4...)
  const cardsData = [
    { q: "C'est quoi un RPS ?", a: "Risque Psycho-Social : danger sant√© mentale/physique.", comp: "C1_Traiter_Info" },
    { q: "Qu'est-ce que le Burn-out ?", a: "√âpuisement professionnel par surcharge.", comp: "C1_Traiter_Info" },
    { q: "Qu'est-ce que le Bore-out ?", a: "√âpuisement par l'ennui.", comp: "C1_Traiter_Info" },
    { q: "Qu'est-ce que le Brown-out ?", a: "Perte de sens au travail.", comp: "C1_Traiter_Info" },
    { q: "D√©finition du Stress", a: "D√©s√©quilibre contraintes / ressources.", comp: "C2_Analyse" },
    { q: "Violence Interne", a: "Violence entre coll√®gues (harc√®lement).", comp: "C2_Analyse" },
    { q: "Violence Externe", a: "Agression par public (clients, √©l√®ves).", comp: "C2_Analyse" },
    { q: "Harc√®lement Moral", a: "Actes r√©p√©t√©s d√©gradant conditions.", comp: "C3_Expliquer" },
    { q: "Harc√®lement Sexuel", a: "Propos/comportements sexuels impos√©s.", comp: "C3_Expliquer" },
    { q: "Charge mentale", a: "Devoir penser √† tout, tout le temps.", comp: "C2_Analyse" },
    { q: "Lien TMS et RPS", a: "Stress contracte muscles = TMS.", comp: "C3_Expliquer" },
    { q: "Conflit de valeurs", a: "Faire chose qu'on d√©sapprouve.", comp: "C2_Analyse" },
    { q: "Ins√©curit√© de l'emploi", a: "Peur de perdre son poste.", comp: "C1_Traiter_Info" },
    { q: "Exigence √©motionnelle", a: "Cacher ses √©motions (sourire forc√©).", comp: "C2_Analyse" },
    { q: "Manque d'autonomie", a: "Pas de d√©cision sur son travail.", comp: "C2_Analyse" },
    { q: "Rapports sociaux d√©grad√©s", a: "Mauvaise ambiance, pas de soutien.", comp: "C2_Analyse" },
    { q: "R√¥le du M√©decin du Travail", a: "Surveille sant√©, conseille employeur.", comp: "C1_Traiter_Info" },
    { q: "R√¥le du CSE", a: "Repr√©sentants personnel, alerte.", comp: "C1_Traiter_Info" },
    { q: "Le DUERP", a: "Document Unique : liste tous risques.", comp: "C3_Expliquer" },
    { q: "Exemple de Pr√©vention", a: "Adapter charge, former managers.", comp: "C4_Solution" }
  ];

  let currentCardIndex = 0;
  let score = 0;
  let studentData = { id: "", classe: "" };
  let isFlipped = false;
  
  // Variables Moteur (Temps + Comp√©tences)
  let startTime = null;
  let competencesScores = {
      "C1_Traiter_Info": { total: 0, reussi: 0 },
      "C2_Analyse": { total: 0, reussi: 0 },
      "C3_Expliquer": { total: 0, reussi: 0 },
      "C4_Solution": { total: 0, reussi: 0 }
  };

  // Audio simple
  window.speak = (text) => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'fr-FR';
      window.speechSynthesis.speak(msg);
    }
  };

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // 1. D√©marrage (CHRONO D√âMARRE ICI)
  window.startModule = () => {
    const idInput = document.getElementById('student-id').value.trim();
    const classInput = document.getElementById('student-class').value;
    if (!idInput || !classInput) {
      document.getElementById('start-error').style.display = 'block';
      document.getElementById('start-error').innerText = "‚ö†Ô∏è Identifiant et Classe obligatoires.";
      return;
    }
    studentData = { id: idInput, classe: classInput };
    
    // START CHRONO
    startTime = new Date();

    currentCardIndex = 0;
    score = 0;
    // Shuffle
    cardsData.sort(() => Math.random() - 0.5);
    loadCard(0);
    showScreen('screen-game');
  };

  // 2. Afficher Carte
  function loadCard(index) {
    const cardEl = document.getElementById('active-card');
    const frontEl = cardEl.querySelector('.card-front');
    const backEl = cardEl.querySelector('.card-back');
    
    cardEl.classList.remove('flipped');
    isFlipped = false;
    document.getElementById('eval-btns').classList.remove('visible');

    setTimeout(() => {
      frontEl.innerHTML = `<h2>${cardsData[index].q}</h2>
        <button class="btn-audio" onclick="event.stopPropagation(); speak('${cardsData[index].q.replace(/'/g, "\\'")}')">üîà</button>
        <div class="hint">(Tape pour retourner)</div>`;
      backEl.innerHTML = `<p>${cardsData[index].a}</p>`;
      
      document.getElementById('current-index').textContent = `${index + 1} / ${cardsData.length}`;
      document.getElementById('progress-fill').style.width = `${(index / cardsData.length) * 100}%`;
    }, 200);
  }

  // 3. Retourner
  window.flipCard = () => {
    if (isFlipped) return;
    document.getElementById('active-card').classList.add('flipped');
    isFlipped = true;
    setTimeout(() => document.getElementById('eval-btns').classList.add('visible'), 300);
  };

  // 4. Voter (CALCUL COMP√âTENCES)
  window.rateCard = (pt) => {
    score += pt;
    
    // Moteur Comp√©tences
    const currentComp = cardsData[currentCardIndex].comp;
    if(competencesScores[currentComp]) {
        competencesScores[currentComp].total++;
        if(pt === 1) competencesScores[currentComp].reussi++;
    }

    currentCardIndex++;
    if (currentCardIndex < cardsData.length) loadCard(currentCardIndex);
    else {
      document.getElementById('progress-fill').style.width = '100%';
      showScreen('screen-result');
    }
  };

  // 5. ENVOI RICHE (Temps + D√©tail)
  window.revealAndSend = async () => {
    const btn = document.getElementById('btn-reveal');
    const scoreZone = document.getElementById('score-zone');
    const scoreDisplay = document.getElementById('final-score-display');
    const fbText = document.getElementById('feedback-text');

    btn.style.display = 'none';
    scoreZone.style.display = 'block';
    scoreDisplay.textContent = `${score}/${cardsData.length}`;

    if (score === cardsData.length) fbText.innerHTML = "Perfect ! üèÜ";
    else if (score >= 15) fbText.innerHTML = "Excellent travail ! üí™";
    else if (score >= 10) fbText.innerHTML = "Bien, continue tes efforts. üôÇ";
    else fbText.innerHTML = "√Ä retravailler pour m√©moriser les d√©finitions. üöÄ";

    // STOP CHRONO
    const endTime = new Date();
    const durationMs = endTime - startTime;
    const durationSeconds = Math.floor(durationMs / 1000);

    // Calcul Note sur 20
    const note20 = Math.round((score / cardsData.length) * 20);

    // Calcul Niveaux Comp√©tences (0 √† 3)
    let finalCompetences = {};
    for (const [key, val] of Object.entries(competencesScores)) {
        if(val.total === 0) {
            finalCompetences[key] = null;
        } else {
            const ratio = val.reussi / val.total;
            if(ratio < 0.25) finalCompetences[key] = 0;      // Rouge
            else if(ratio < 0.5) finalCompetences[key] = 1;  // Orange
            else if(ratio < 0.8) finalCompetences[key] = 2;  // Vert
            else finalCompetences[key] = 3;                  // Bleu (Expert)
        }
    }

    try {
      await addDoc(collection(db, "evaluations_competences"), {
        date: new Date(), // Date serveur
        identifiant: studentData.id,
        classe: studentData.classe,
        exercice_titre: "Flashcards RPS (20 cartes)",
        note_finale: note20,
        temps_secondes: durationSeconds, // Le temps pass√© !
        competences: finalCompetences,   // Le d√©tail C1, C2...
        details_bruts: competencesScores // Pour debug si besoin
      });
      console.log("Envoi complet (Temps + Comp√©tences) r√©ussi.");
    } catch (e) {
      console.error("Erreur envoi:", e);
    }
  };
</script>

</body>
</html>
