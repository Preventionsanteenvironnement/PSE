<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercices en ligne ‚Äî PSE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8; color: #1e293b; min-height: 100vh;
        }
        .screen { min-height: 100vh; padding: 20px; max-width: 800px; margin: 0 auto; }
        .screen-hidden { display: none !important; }

        /* === HEADER === */
        .exo-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; padding: 20px 24px; border-radius: 16px;
            margin-bottom: 24px; text-align: center;
        }
        .exo-header h1 { font-size: 1.5rem; font-weight: 800; }
        .exo-header p { opacity: 0.85; font-size: 0.9rem; margin-top: 4px; }
        .back-home {
            display: inline-flex; align-items: center; gap: 6px; color: white; text-decoration: none;
            font-size: 0.85rem; opacity: 0.8; margin-bottom: 10px;
        }
        .back-home:hover { opacity: 1; }

        /* === LEVEL BUTTONS === */
        .level-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .level-btn {
            padding: 18px 16px; background: white; border: 2px solid #e2e8f0;
            border-radius: 14px; cursor: pointer; font-weight: 700; font-size: 1rem;
            text-align: center; transition: 0.2s; color: #1e293b;
        }
        .level-btn:hover { border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(59,130,246,0.15); }
        .level-btn.active { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
        .level-btn-trans { font-size: 0.9rem; padding: 14px 12px; }
        .level-btn-trans:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .level-btn-trans.active { background: #fffbeb; }

        /* === MODULE LIST === */
        .module-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .module-btn {
            padding: 14px 16px; background: white; border: 2px solid #e2e8f0;
            border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
            text-align: left; transition: 0.2s; color: #1e293b;
        }
        .module-btn:hover { border-color: #3b82f6; }
        .module-btn.active { border-color: #3b82f6; background: #eff6ff; }
        .module-btn .mod-id { color: #3b82f6; font-weight: 800; }
        .theme-label {
            font-size: 0.75rem; color: #64748b; text-transform: uppercase;
            letter-spacing: 1px; font-weight: 700; margin: 16px 0 8px; padding-left: 4px;
        }

        /* === EXERCISE LIST === */
        .exo-card {
            background: white; border-radius: 14px; padding: 16px 20px;
            margin-bottom: 10px; cursor: pointer; transition: 0.2s;
            border: 2px solid #e2e8f0; display: flex; align-items: center; gap: 14px;
        }
        .exo-card:hover { border-color: #3b82f6; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .exo-icon { font-size: 1.8rem; flex-shrink: 0; }
        .exo-info { flex: 1; }
        .exo-info h3 { font-size: 1rem; font-weight: 700; margin-bottom: 3px; }
        .exo-info .exo-meta { font-size: 0.8rem; color: #64748b; display: flex; gap: 8px; flex-wrap: wrap; }
        .exo-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 0.7rem; font-weight: 700;
        }
        .badge-facile { background: #dcfce7; color: #166534; }
        .badge-moyen { background: #fef3c7; color: #92400e; }
        .badge-difficile { background: #fee2e2; color: #991b1b; }
        .badge-type { background: #dbeafe; color: #1e40af; }
        .empty-msg { text-align: center; padding: 40px 20px; color: #94a3b8; font-size: 1rem; }

        /* === BREADCRUMB === */
        .breadcrumb { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; font-size: 0.85rem; }
        .breadcrumb a { color: #3b82f6; text-decoration: none; cursor: pointer; font-weight: 600; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep { color: #94a3b8; }
        .breadcrumb .current { color: #64748b; font-weight: 600; }

        /* === EXERCISE PLAY SCREEN === */
        .play-header {
            background: white; border-radius: 14px; padding: 16px 20px;
            margin-bottom: 16px; display: flex; align-items: center; gap: 14px;
            border: 1px solid #e2e8f0;
        }
        .play-header .back-btn {
            background: #e2e8f0; border: none; border-radius: 10px; width: 40px; height: 40px;
            font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: #475569; transition: 0.2s; flex-shrink: 0;
        }
        .play-header .back-btn:hover { background: #cbd5e1; }
        .play-header h2 { font-size: 1.05rem; font-weight: 700; }
        .play-header .play-badge { margin-left: auto; }

        .consigne-box {
            background: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px 16px;
            border-radius: 0 10px 10px 0; margin-bottom: 16px; font-size: 0.95rem; color: #1e40af; font-weight: 600;
        }

        .game-zone {
            background: white; border-radius: 16px; padding: 24px;
            border: 1px solid #e2e8f0; min-height: 200px; margin-bottom: 16px;
        }

        .btn-validate {
            width: 100%; padding: 16px; background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white; border: none; border-radius: 14px; font-size: 1.1rem;
            font-weight: 800; cursor: pointer; transition: 0.2s; letter-spacing: 0.5px;
        }
        .btn-validate:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(34,197,94,0.3); }
        .btn-validate:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* === RESULTS === */
        .results-box {
            background: white; border-radius: 16px; padding: 30px; text-align: center;
            border: 1px solid #e2e8f0; margin-bottom: 16px;
        }
        .score-big { font-size: 3.5rem; font-weight: 900; margin: 10px 0; }
        .score-ok { color: #22c55e; }
        .score-mid { color: #f59e0b; }
        .score-low { color: #ef4444; }
        .score-label { font-size: 1rem; color: #64748b; margin-bottom: 16px; }
        .results-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 16px; }
        .btn-retry {
            padding: 12px 28px; background: #3b82f6; color: white; border: none;
            border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .btn-retry:hover { opacity: 0.85; }
        .btn-back-list {
            padding: 12px 28px; background: #e2e8f0; color: #475569; border: none;
            border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .btn-back-list:hover { background: #cbd5e1; }

        /* === CORRECTION DETAIL === */
        .correction-list { text-align: left; margin-top: 20px; }
        .corr-item {
            padding: 12px 16px; border-radius: 10px; margin-bottom: 8px;
            font-size: 0.9rem; display: flex; align-items: flex-start; gap: 10px;
        }
        .corr-ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .corr-ko { background: #fef2f2; border: 1px solid #fecaca; }
        .corr-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 1px; }
        .corr-text { flex: 1; }
        .corr-text .expected { color: #16a34a; font-weight: 600; }

        /* ========================================== */
        /* GAME-SPECIFIC STYLES                      */
        /* ========================================== */

        /* --- Texte a trous --- */
        .tt-texte { font-size: 1.05rem; line-height: 2; }
        .tt-texte .tt-input {
            display: inline-block; border: none; border-bottom: 2px solid #3b82f6;
            background: #eff6ff; padding: 2px 8px; font-size: 1rem; font-family: inherit;
            color: #1e293b; min-width: 90px; outline: none; border-radius: 4px 4px 0 0;
            text-align: center;
        }
        .tt-texte .tt-input:focus { border-bottom-color: #2563eb; background: #dbeafe; }
        .tt-texte .tt-input.correct { border-bottom-color: #22c55e; background: #f0fdf4; color: #166534; }
        .tt-texte .tt-input.wrong { border-bottom-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .tt-hint { font-size: 0.75rem; color: #94a3b8; font-style: italic; }

        /* --- Relier --- */
        .relier-container { display: flex; gap: 60px; justify-content: center; align-items: flex-start; position: relative; }
        .relier-col { display: flex; flex-direction: column; gap: 10px; min-width: 120px; }
        .relier-item {
            padding: 12px 16px; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
            text-align: center; transition: 0.2s; user-select: none;
        }
        .relier-item:hover { border-color: #3b82f6; }
        .relier-item.selected { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
        .relier-item.matched { border-color: #94a3b8; background: #f1f5f9; color: #64748b; opacity: 0.7; cursor: default; }
        .relier-item.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .relier-item.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .relier-pairs-display { margin-top: 16px; display: flex; flex-direction: column; gap: 6px; }
        .relier-pair-tag {
            display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px;
            background: #eff6ff; border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: #1e40af;
        }
        .relier-pair-tag .remove-pair { cursor: pointer; color: #94a3b8; margin-left: 4px; }
        .relier-pair-tag .remove-pair:hover { color: #ef4444; }
        .relier-pair-tag.correct { background: #f0fdf4; color: #166534; }
        .relier-pair-tag.wrong { background: #fef2f2; color: #991b1b; text-decoration: line-through; }

        /* --- Ordre --- */
        .ordre-list { display: flex; flex-direction: column; gap: 8px; }
        .ordre-item {
            display: flex; align-items: center; gap: 10px; padding: 14px 16px;
            background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px;
            font-weight: 600; font-size: 0.95rem; transition: 0.2s;
        }
        .ordre-item .ordre-num { color: #94a3b8; font-weight: 800; min-width: 28px; }
        .ordre-item .ordre-text { flex: 1; }
        .ordre-item .ordre-arrows { display: flex; gap: 4px; }
        .ordre-item .ordre-arrows button {
            width: 34px; height: 34px; border: 1px solid #e2e8f0; border-radius: 8px;
            background: white; cursor: pointer; font-size: 1rem; display: flex;
            align-items: center; justify-content: center; color: #64748b; transition: 0.2s;
        }
        .ordre-item .ordre-arrows button:hover { background: #eff6ff; color: #3b82f6; border-color: #3b82f6; }
        .ordre-item.correct { border-color: #22c55e; background: #f0fdf4; }
        .ordre-item.wrong { border-color: #ef4444; background: #fef2f2; }

        /* --- Intrus --- */
        .intrus-serie { margin-bottom: 20px; }
        .intrus-serie h4 { font-size: 0.85rem; color: #64748b; margin-bottom: 8px; }
        .intrus-items { display: flex; flex-wrap: wrap; gap: 10px; }
        .intrus-item {
            padding: 12px 20px; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 0.95rem;
            transition: 0.2s; user-select: none;
        }
        .intrus-item:hover { border-color: #3b82f6; }
        .intrus-item.selected { border-color: #f59e0b; background: #fef3c7; color: #92400e; }
        .intrus-item.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .intrus-item.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .intrus-explication { font-size: 0.85rem; color: #64748b; margin-top: 6px; display: none; font-style: italic; }

        /* --- Pendu --- */
        .pendu-zone { text-align: center; }
        .pendu-mot { font-size: 2rem; font-weight: 900; letter-spacing: 8px; margin: 20px 0; font-family: monospace; }
        .pendu-indice { font-size: 0.9rem; color: #64748b; margin-bottom: 16px; font-style: italic; }
        .pendu-clavier { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; max-width: 500px; margin: 0 auto 20px; }
        .pendu-key {
            width: 40px; height: 40px; border: 2px solid #e2e8f0; border-radius: 8px;
            background: white; cursor: pointer; font-weight: 700; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .pendu-key:hover { border-color: #3b82f6; background: #eff6ff; }
        .pendu-key.used-ok { background: #f0fdf4; border-color: #22c55e; color: #166534; cursor: default; }
        .pendu-key.used-ko { background: #fef2f2; border-color: #ef4444; color: #991b1b; cursor: default; opacity: 0.5; }
        .pendu-svg { margin: 0 auto 16px; display: block; }
        .pendu-erreurs { font-size: 0.85rem; color: #ef4444; font-weight: 700; }
        .pendu-nav { display: flex; justify-content: center; gap: 10px; margin-top: 16px; }
        .pendu-nav button {
            padding: 10px 20px; border: none; border-radius: 10px; font-weight: 700;
            cursor: pointer; font-size: 0.9rem; transition: 0.2s;
        }
        .pendu-next { background: #3b82f6; color: white; }
        .pendu-next:hover { opacity: 0.85; }
        .pendu-status { font-size: 0.85rem; color: #64748b; margin-bottom: 10px; }

        /* --- Mots croises --- */
        .mc-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .mc-grid-wrap { flex: 1; min-width: 280px; overflow-x: auto; }
        .mc-grid { border-collapse: collapse; margin: 0 auto; }
        .mc-grid td {
            width: 36px; height: 36px; border: 2px solid #1e293b; text-align: center;
            font-weight: 700; font-size: 1rem; text-transform: uppercase; position: relative;
        }
        .mc-grid td.mc-empty { background: #1e293b; border-color: #1e293b; }
        .mc-grid td input {
            width: 100%; height: 100%; border: none; text-align: center; font-weight: 700;
            font-size: 1rem; text-transform: uppercase; background: transparent; outline: none;
            font-family: inherit; color: #1e293b;
        }
        .mc-grid td input:focus { background: #dbeafe; }
        .mc-grid td .mc-num {
            position: absolute; top: 1px; left: 2px; font-size: 0.55rem; color: #3b82f6;
            font-weight: 800; line-height: 1;
        }
        .mc-grid td.correct { background: #f0fdf4; }
        .mc-grid td.wrong { background: #fef2f2; }
        .mc-defs { flex: 1; min-width: 200px; }
        .mc-defs h4 { font-size: 0.85rem; color: #3b82f6; font-weight: 700; margin: 10px 0 6px; }
        .mc-defs ol { padding-left: 20px; font-size: 0.85rem; line-height: 1.8; color: #475569; }

        /* --- Swipe V/F --- */
        .swipe-zone { text-align: center; }
        .swipe-card {
            background: white; border: 2px solid #e2e8f0; border-radius: 20px;
            padding: 40px 24px; max-width: 500px; margin: 0 auto 20px;
            font-size: 1.15rem; font-weight: 600; line-height: 1.5;
            transition: transform 0.3s, opacity 0.3s; position: relative;
        }
        .swipe-card.slide-left { transform: translateX(-120%); opacity: 0; }
        .swipe-card.slide-right { transform: translateX(120%); opacity: 0; }
        .swipe-btns { display: flex; gap: 16px; justify-content: center; margin-bottom: 16px; }
        .swipe-btn {
            padding: 14px 32px; border: none; border-radius: 14px; font-weight: 800;
            font-size: 1.1rem; cursor: pointer; transition: 0.2s; min-width: 120px;
        }
        .swipe-btn.btn-faux { background: #fee2e2; color: #991b1b; }
        .swipe-btn.btn-faux:hover { background: #fecaca; }
        .swipe-btn.btn-vrai { background: #dcfce7; color: #166534; }
        .swipe-btn.btn-vrai:hover { background: #bbf7d0; }
        .swipe-feedback {
            font-weight: 700; font-size: 1rem; margin-bottom: 12px; min-height: 24px;
        }
        .swipe-progress { font-size: 0.85rem; color: #94a3b8; }

        /* --- QCM Image --- */
        .qcm-img-zone {}
        .qcm-img-q { margin-bottom: 24px; }
        .qcm-img-q img { max-width: 100%; max-height: 300px; border-radius: 12px; margin-bottom: 12px; object-fit: contain; display: block; }
        .qcm-img-q .q-text { font-weight: 700; font-size: 1.05rem; margin-bottom: 10px; }
        .qcm-img-choices { display: flex; flex-direction: column; gap: 8px; }
        .qcm-img-choice {
            padding: 12px 16px; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.95rem;
            transition: 0.2s;
        }
        .qcm-img-choice:hover { border-color: #3b82f6; }
        .qcm-img-choice.selected { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
        .qcm-img-choice.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .qcm-img-choice.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .qcm-img-expl { font-size: 0.85rem; color: #64748b; margin-top: 6px; display: none; font-style: italic; }
        .qcm-img-placeholder { padding: 30px; background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 12px; text-align: center; color: #94a3b8; font-size: 0.9rem; margin-bottom: 12px; }

        /* --- Tableau --- */
        .tableau-zone { overflow-x: auto; }
        .tableau-zone table { width: 100%; border-collapse: collapse; }
        .tableau-zone th {
            background: #1e293b; color: white; padding: 10px 14px; font-size: 0.85rem;
            font-weight: 700; text-align: left;
        }
        .tableau-zone td { padding: 8px 12px; border: 1px solid #e2e8f0; font-size: 0.9rem; }
        .tableau-zone td input {
            width: 100%; border: none; border-bottom: 2px solid #3b82f6; background: #eff6ff;
            padding: 6px 8px; font-size: 0.9rem; font-family: inherit; outline: none;
            border-radius: 4px 4px 0 0; color: #1e293b;
        }
        .tableau-zone td input:focus { background: #dbeafe; }
        .tableau-zone td.correct { background: #f0fdf4; }
        .tableau-zone td.wrong { background: #fef2f2; }

        /* --- Etude de cas --- */
        .ec-scenario {
            background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px 20px;
            border-radius: 0 12px 12px 0; margin-bottom: 20px; font-size: 0.95rem;
            line-height: 1.6; color: #78350f;
        }
        .ec-question { margin-bottom: 16px; }
        .ec-question .ec-q-text { font-weight: 700; margin-bottom: 8px; }
        .ec-question .ec-q-num { color: #3b82f6; font-weight: 800; }
        .ec-qcm-choices { display: flex; flex-direction: column; gap: 6px; }
        .ec-qcm-choice {
            padding: 10px 14px; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s;
        }
        .ec-qcm-choice:hover { border-color: #3b82f6; }
        .ec-qcm-choice.selected { border-color: #3b82f6; background: #eff6ff; }
        .ec-qcm-choice.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .ec-qcm-choice.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .ec-text-input {
            width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 0.9rem; font-family: inherit; outline: none; resize: vertical; min-height: 60px;
        }
        .ec-text-input:focus { border-color: #3b82f6; }
        .ec-expected { font-size: 0.85rem; color: #16a34a; margin-top: 4px; display: none; font-style: italic; }

        /* === PREVENTION (Mesures de prevention) === */
        .prev-situation {
            background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px 20px;
            border-radius: 8px; margin-bottom: 12px; font-size: 0.95rem; line-height: 1.6; color: #1e3a5f;
        }
        .prev-situation-label { font-weight: 800; color: #2563eb; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .prev-danger-box {
            background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px 16px;
            border-radius: 8px; margin-bottom: 16px; font-size: 0.95rem; color: #991b1b;
        }
        .prev-danger-label { font-weight: 800; color: #ef4444; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .prev-instruction { font-weight: 700; color: #475569; margin-bottom: 16px; font-size: 0.95rem; text-align: center; }
        .prev-hierarchy-label {
            text-align: center; font-size: 0.75rem; color: #94a3b8; margin-bottom: 12px;
            font-weight: 600; letter-spacing: 0.5px;
        }
        .prev-levels { display: flex; flex-direction: column; gap: 10px; }
        .prev-level {
            background: white; border: 2px solid #e2e8f0; border-radius: 12px;
            padding: 14px 16px; display: flex; align-items: center; gap: 14px;
            transition: border-color 0.3s, background 0.3s;
        }
        .prev-level-num {
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-weight: 900;
            font-size: 0.95rem; flex-shrink: 0; color: white;
        }
        .prev-level-num.n1 { background: #22c55e; }
        .prev-level-num.n2 { background: #3b82f6; }
        .prev-level-num.n3 { background: #f59e0b; }
        .prev-level-num.n4 { background: #f97316; }
        .prev-level-num.n5 { background: #ef4444; }
        .prev-level-content { flex: 1; }
        .prev-level-label { font-weight: 700; font-size: 0.8rem; color: #475569; margin-bottom: 6px; }
        .prev-level select {
            width: 100%; padding: 8px 10px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 0.85rem; color: #1e293b; background: #f8fafc; cursor: pointer;
        }
        .prev-level select:focus { border-color: #3b82f6; outline: none; }
        .prev-level.correct { background: #f0fdf4; border-color: #22c55e; }
        .prev-level.correct select { border-color: #22c55e; background: #f0fdf4; }
        .prev-level.wrong { background: #fef2f2; border-color: #ef4444; }
        .prev-level.wrong select { border-color: #ef4444; background: #fef2f2; }
        .prev-correction { font-size: 0.8rem; color: #166534; margin-top: 6px; font-weight: 600; }
        .prev-efficacy-arrow {
            text-align: center; color: #94a3b8; font-size: 0.75rem; font-weight: 700;
            padding: 2px 0; letter-spacing: 1px;
        }

        /* === RESPONSIVE === */
        @media (max-width: 600px) {
            .screen { padding: 12px; }
            .exo-header h1 { font-size: 1.2rem; }
            .level-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .module-grid { grid-template-columns: 1fr; }
            .relier-container { flex-direction: column; gap: 20px; align-items: center; }
            .pendu-mot { font-size: 1.5rem; letter-spacing: 5px; }
            .pendu-key { width: 34px; height: 34px; font-size: 0.85rem; }
            .swipe-card { padding: 24px 16px; font-size: 1rem; }
            .mc-container { flex-direction: column; }
            .mc-grid td { width: 30px; height: 30px; font-size: 0.85rem; }
            .score-big { font-size: 2.5rem; }
            .results-actions { flex-direction: column; }
            .results-actions button { width: 100%; }
            .pad-chain { flex-direction: column; }
            .pad-arrow { transform: rotate(90deg); }
            .pad-step { min-width: unset; }
        }

        /* === PAD === */
        .pad-situation {
            background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px 20px;
            border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6; color: #1e3a5f;
        }
        .pad-situation-label { font-weight: 800; color: #2563eb; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .pad-instruction { font-weight: 700; color: #475569; margin-bottom: 16px; font-size: 0.95rem; text-align: center; }
        .pad-chain {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 24px; flex-wrap: nowrap;
        }
        .pad-arrow { color: #94a3b8; font-size: 1.5rem; font-weight: 900; flex-shrink: 0; }
        .pad-step {
            background: white; border: 2px solid #e2e8f0; border-radius: 12px;
            padding: 12px; text-align: center; min-width: 150px; flex: 1;
            transition: border-color 0.3s, background 0.3s;
        }
        .pad-step-label {
            font-weight: 800; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;
            color: #64748b; margin-bottom: 8px;
        }
        .pad-step select {
            width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 0.85rem; color: #1e293b; background: #f8fafc; cursor: pointer;
        }
        .pad-step select:focus { border-color: #3b82f6; outline: none; }
        .pad-step.correct { background: #f0fdf4; border-color: #22c55e; }
        .pad-step.correct select { border-color: #22c55e; background: #f0fdf4; }
        .pad-step.wrong { background: #fef2f2; border-color: #ef4444; }
        .pad-step.wrong select { border-color: #ef4444; background: #fef2f2; }
        .pad-correction { font-size: 0.8rem; color: #166534; margin-top: 6px; font-weight: 600; }

        /* === ESTIMATION DU RISQUE === */
        .est-situation { background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #e2e8f0; }
        .est-situation-label { font-size: 0.7rem; color: #2563eb; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px; }
        .est-danger-box { background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 10px 14px; margin-bottom: 8px; }
        .est-danger-label { font-size: 0.65rem; color: #dc2626; text-transform: uppercase; font-weight: 700; }
        .est-dommage-box { background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px; padding: 10px 14px; margin-bottom: 16px; }
        .est-dommage-label { font-size: 0.65rem; color: #ea580c; text-transform: uppercase; font-weight: 700; }
        .est-instruction { text-align: center; font-weight: 700; color: #334155; margin-bottom: 16px; font-size: 0.95rem; }
        .est-steps { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
        .est-step { display: flex; align-items: center; gap: 12px; border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px; background: #fff; transition: all 0.3s; }
        .est-step-num { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #fff; font-size: 0.9rem; flex-shrink: 0; }
        .est-step-num.n1 { background: #ef4444; }
        .est-step-num.n2 { background: #f59e0b; }
        .est-step-num.n3 { background: #3b82f6; }
        .est-step-content { flex: 1; }
        .est-step-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: #475569; margin-bottom: 4px; }
        .est-step select { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.9rem; background: #f8fafc; }
        .est-step.correct { background: #f0fdf4; border-color: #22c55e; }
        .est-step.correct select { border-color: #22c55e; background: #f0fdf4; }
        .est-step.wrong { background: #fef2f2; border-color: #ef4444; }
        .est-step.wrong select { border-color: #ef4444; background: #fef2f2; }
        .est-step-correction { font-size: 0.8rem; color: #166534; margin-top: 4px; font-weight: 600; display: none; }
        .est-proba-display { text-align: center; background: #f1f5f9; border-radius: 10px; padding: 14px; margin-bottom: 16px; border: 2px dashed #94a3b8; }
        .est-proba-display.visible { border-style: solid; border-color: #8b5cf6; background: #f5f3ff; }
        .est-proba-num { font-size: 1.8rem; font-weight: 900; color: #8b5cf6; }
        .est-proba-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        .est-matrix-section { margin-bottom: 16px; }
        .est-matrix-title { text-align: center; font-size: 0.75rem; color: #475569; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; }
        .est-matrix { display: grid; grid-template-columns: auto repeat(4, 1fr); gap: 3px; max-width: 360px; margin: 0 auto; }
        .est-matrix-header { font-size: 0.65rem; color: #64748b; font-weight: 700; text-align: center; padding: 4px 2px; }
        .est-matrix-ylabel { font-size: 0.65rem; color: #64748b; font-weight: 700; text-align: right; padding: 4px 6px 4px 0; display: flex; align-items: center; justify-content: flex-end; }
        .est-matrix-cell { padding: 10px 4px; text-align: center; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: 700; transition: all 0.2s; user-select: none; border: 2px solid transparent; }
        .est-matrix-cell.zone-green { background: rgba(34,197,94,0.15); color: #166534; }
        .est-matrix-cell.zone-red { background: rgba(239,68,68,0.15); color: #991b1b; }
        .est-matrix-cell:hover { transform: scale(1.05); opacity: 0.85; }
        .est-matrix-cell.selected { border: 3px solid #1e40af; transform: scale(1.08); box-shadow: 0 0 8px rgba(30,64,175,0.4); }
        .est-matrix-cell.correct-cell { border: 3px solid #22c55e !important; background: #22c55e !important; color: #fff !important; }
        .est-matrix-cell.wrong-cell { border: 3px solid #ef4444 !important; background: #ef4444 !important; color: #fff !important; }
        .est-matrix-cell.show-correct { border: 3px solid #22c55e !important; animation: pulse-green 1s infinite; }
        @keyframes pulse-green { 0%,100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 50% { box-shadow: 0 0 0 8px rgba(34,197,94,0); } }
        .est-priorite-section { text-align: center; margin-bottom: 12px; }
        .est-priorite-section label { font-size: 0.75rem; color: #475569; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 8px; }
        .est-prio-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .est-prio-btn { padding: 10px 18px; border-radius: 8px; border: 2px solid #cbd5e1; background: #fff; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.2s; }
        .est-prio-btn.active { border-color: #1e40af; background: #eff6ff; color: #1e40af; }
        .est-prio-btn.correct-prio { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .est-prio-btn.wrong-prio { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .est-feedback { background: #fffbeb; border: 1px solid #fde68a; border-radius: 10px; padding: 12px; margin-top: 12px; font-size: 0.85rem; display: none; }
        .est-feedback.visible { display: block; }
        @media (max-width: 480px) {
            .est-matrix { max-width: 100%; }
            .est-matrix-cell { padding: 8px 2px; font-size: 0.6rem; }
            .est-step { flex-direction: column; align-items: stretch; }
            .est-step-num { width: 28px; height: 28px; font-size: 0.75rem; }
        }

        /* === DUERP (Document Unique) === */
        .duerp-header { background: #1e293b; color: #fff; padding: 16px 20px; border-radius: 12px 12px 0 0; margin-bottom: 0; }
        .duerp-header-title { font-size: 1.1rem; font-weight: 800; letter-spacing: 0.3px; }
        .duerp-header-sub { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
        .duerp-unite { display: inline-block; background: #3b82f6; color: #fff; font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 20px; margin-bottom: 10px; }
        .duerp-situation { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; margin-bottom: 16px; line-height: 1.6; font-size: 0.92rem; color: #334155; }
        .duerp-situation-label { font-size: 0.7rem; color: #2563eb; text-transform: uppercase; font-weight: 700; margin-bottom: 6px; letter-spacing: 0.5px; }
        .duerp-section { margin-bottom: 16px; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
        .duerp-section-title { padding: 10px 16px; font-weight: 700; font-size: 0.85rem; color: #fff; }
        .duerp-section-title.danger { background: #dc2626; }
        .duerp-section-title.dommage { background: #ea580c; }
        .duerp-section-title.estimation { background: #7c3aed; }
        .duerp-section-title.mesure { background: #059669; }
        .duerp-section-body { padding: 12px 16px; }
        .duerp-qcm-choices { display: flex; flex-direction: column; gap: 8px; }
        .duerp-qcm-choice { padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; background: #fff; user-select: none; }
        .duerp-qcm-choice:hover { border-color: #93c5fd; background: #f0f9ff; }
        .duerp-qcm-choice.selected { border-color: #2563eb; background: #eff6ff; color: #1e40af; font-weight: 600; }
        .duerp-qcm-choice.correct { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .duerp-qcm-choice.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .duerp-qcm-choice.show-correct { border-color: #22c55e !important; background: #dcfce7 !important; color: #166534 !important; font-weight: 700; }
        .duerp-estimation { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
        .duerp-est-field { flex: 1; min-width: 140px; }
        .duerp-est-field label { display: block; font-size: 0.7rem; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 4px; }
        .duerp-est-field select { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.85rem; background: #f8fafc; }
        .duerp-est-field select.correct { border-color: #22c55e; background: #f0fdf4; }
        .duerp-est-field select.wrong { border-color: #ef4444; background: #fef2f2; }
        .duerp-est-btns { display: flex; gap: 8px; }
        .duerp-est-btn { flex: 1; padding: 8px 10px; border-radius: 6px; border: 2px solid #cbd5e1; background: #fff; cursor: pointer; font-size: 0.8rem; font-weight: 600; text-align: center; transition: all 0.2s; user-select: none; }
        .duerp-est-btn:hover { border-color: #93c5fd; }
        .duerp-est-btn.active { border-color: #2563eb; background: #eff6ff; color: #1e40af; }
        .duerp-est-btn.correct { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .duerp-est-btn.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .duerp-est-btn.show-correct { border-color: #22c55e !important; background: #dcfce7 !important; }
        .duerp-proba-display { text-align: center; background: #f1f5f9; border-radius: 8px; padding: 10px; margin-top: 8px; border: 2px dashed #94a3b8; }
        .duerp-proba-display.visible { border-style: solid; border-color: #8b5cf6; background: #f5f3ff; }
        .duerp-proba-num { font-size: 1.5rem; font-weight: 900; color: #8b5cf6; }
        .duerp-proba-label { font-size: 0.7rem; color: #64748b; }
        .duerp-prio-display { text-align: center; padding: 8px 14px; border-radius: 8px; font-weight: 800; font-size: 0.85rem; margin-top: 8px; }
        .duerp-prio-display.prioritaire { background: rgba(239,68,68,0.12); color: #dc2626; border: 1px solid #fecaca; }
        .duerp-prio-display.non_prioritaire { background: rgba(34,197,94,0.12); color: #16a34a; border: 1px solid #bbf7d0; }
        .duerp-prio-display.empty { background: #f1f5f9; color: #94a3b8; border: 1px dashed #cbd5e1; }
        .duerp-est-correction { font-size: 0.78rem; color: #166534; margin-top: 4px; font-weight: 600; display: none; }
        .duerp-feedback { background: #fffbeb; border: 1px solid #fde68a; border-radius: 10px; padding: 12px; margin-top: 12px; font-size: 0.85rem; display: none; }
        .duerp-feedback.visible { display: block; }
        .duerp-row-separator { border: none; border-top: 2px dashed #cbd5e1; margin: 20px 0; }
        .duerp-mission { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-top: 16px; }
        .duerp-mission-title { font-weight: 800; font-size: 0.95rem; color: #1e293b; margin-bottom: 10px; }
        .duerp-mission-consigne { font-size: 0.88rem; color: #475569; margin-bottom: 12px; line-height: 1.5; }
        .duerp-mission-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: #fff; user-select: none; }
        .duerp-mission-row:hover { border-color: #93c5fd; background: #f0f9ff; }
        .duerp-mission-row.checked { border-color: #2563eb; background: #eff6ff; }
        .duerp-mission-row.correct { border-color: #22c55e !important; background: #f0fdf4 !important; }
        .duerp-mission-row.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; }
        .duerp-mission-row.show-correct { border-color: #22c55e !important; background: #dcfce7 !important; }
        .duerp-mission-cb { width: 20px; height: 20px; border-radius: 4px; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.85rem; color: transparent; transition: all 0.2s; }
        .duerp-mission-row.checked .duerp-mission-cb { border-color: #2563eb; background: #2563eb; color: #fff; }
        .duerp-mission-info { flex: 1; font-size: 0.85rem; color: #334155; }
        .duerp-mission-info strong { color: #1e293b; }
        @media (max-width: 480px) {
            .duerp-estimation { flex-direction: column; }
            .duerp-est-field { min-width: 100%; }
            .duerp-header-title { font-size: 0.95rem; }
            .duerp-mission-row { flex-direction: row; }
        }

        /* ===== QCM CLASSIQUE ===== */
        .qcm-c-question { font-size: 1.1rem; font-weight: 600; color: #1e293b; margin-bottom: 16px; line-height: 1.5; }
        .qcm-c-multi-hint { font-size: 0.8rem; color: #64748b; margin-bottom: 12px; font-style: italic; }
        .qcm-c-choices { display: flex; flex-direction: column; gap: 10px; }
        .qcm-c-choice { padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: all 0.2s; background: #fff; color: #334155; }
        .qcm-c-choice:hover { border-color: #3b82f6; background: #eff6ff; }
        .qcm-c-choice.selected { border-color: #3b82f6; background: #dbeafe; color: #1e40af; font-weight: 600; }
        .qcm-c-choice.correct { border-color: #22c55e !important; background: #dcfce7 !important; color: #166534 !important; }
        .qcm-c-choice.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .qcm-c-choice.show-correct { border-color: #22c55e !important; background: #f0fdf4 !important; }
        .qcm-c-explication { margin-top: 16px; padding: 12px 16px; background: #fefce8; border-left: 4px solid #eab308; border-radius: 8px; font-size: 0.9rem; color: #854d0e; }

        /* ===== QUIZ CHRONO ===== */
        .chrono-container { text-align: center; }
        .chrono-progress { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .chrono-dot { width: 14px; height: 14px; border-radius: 50%; background: #e2e8f0; transition: all 0.3s; }
        .chrono-dot.current { background: #3b82f6; transform: scale(1.3); }
        .chrono-dot.done-ok { background: #22c55e; }
        .chrono-dot.done-ko { background: #ef4444; }
        .chrono-timer-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; margin-bottom: 16px; overflow: hidden; }
        .chrono-timer-fill { height: 100%; background: #3b82f6; border-radius: 4px; transition: width 0.25s linear; }
        .chrono-timer-fill.danger { background: #ef4444; }
        .chrono-counter { font-size: 0.85rem; color: #64748b; margin-bottom: 8px; }
        .chrono-question-text { font-size: 1.15rem; font-weight: 700; color: #1e293b; margin-bottom: 20px; line-height: 1.5; }
        .chrono-choices { display: flex; flex-direction: column; gap: 10px; max-width: 500px; margin: 0 auto; }
        .chrono-choice { padding: 16px 20px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; font-size: 1.05rem; transition: all 0.2s; background: #fff; color: #334155; text-align: left; }
        .chrono-choice:hover { border-color: #3b82f6; background: #eff6ff; }
        .chrono-choice.selected-ok { border-color: #22c55e; background: #dcfce7; color: #166534; }
        .chrono-choice.selected-ko { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .chrono-choice.show-correct { border-color: #22c55e; background: #f0fdf4; }

        /* ===== CATEGORISER ===== */
        .cat-consigne { font-size: 0.95rem; color: #64748b; margin-bottom: 16px; }
        .cat-pool { display: flex; flex-wrap: wrap; gap: 10px; padding: 16px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 12px; margin-bottom: 20px; min-height: 50px; justify-content: center; }
        .cat-item { padding: 10px 16px; background: #fff; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; font-size: 0.95rem; color: #334155; transition: all 0.2s; user-select: none; }
        .cat-item:hover { border-color: #3b82f6; }
        .cat-item.selected { border-color: #3b82f6; background: #dbeafe; color: #1e40af; font-weight: 600; transform: scale(1.05); }
        .cat-item.placed { opacity: 0.4; pointer-events: none; }
        .cat-zones { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .cat-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 12px; min-height: 100px; cursor: pointer; transition: all 0.2s; }
        .cat-zone:hover { border-color: #3b82f6; background: #f0f9ff; }
        .cat-zone.highlight { border-color: #3b82f6; background: #eff6ff; }
        .cat-zone-title { font-weight: 700; color: #1e293b; margin-bottom: 10px; text-align: center; font-size: 0.95rem; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
        .cat-placed { display: inline-flex; align-items: center; padding: 8px 12px; background: #e0e7ff; border-radius: 8px; margin: 4px; font-size: 0.85rem; color: #3730a3; cursor: pointer; transition: all 0.2s; }
        .cat-placed:hover { background: #c7d2fe; }
        .cat-placed.correct { background: #dcfce7 !important; color: #166534 !important; }
        .cat-placed.wrong { background: #fef2f2 !important; color: #991b1b !important; text-decoration: line-through; }

        /* ===== MEMORY ===== */
        .mem-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 600px; margin: 0 auto; }
        .mem-card { aspect-ratio: 1; min-height: 80px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; padding: 8px; font-size: 0.85rem; transition: all 0.3s; user-select: none; background: #fff; position: relative; overflow: hidden; }
        .mem-card .mem-back { font-size: 1.8rem; color: #94a3b8; }
        .mem-card .mem-face { display: none; color: #1e293b; font-weight: 600; word-break: break-word; line-height: 1.2; padding: 4px; }
        .mem-card.flipped { border-color: #3b82f6; background: #eff6ff; }
        .mem-card.flipped .mem-back { display: none; }
        .mem-card.flipped .mem-face { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .mem-card.matched { border-color: #22c55e; background: #dcfce7; pointer-events: none; }
        .mem-card.matched .mem-face { color: #166534; }
        .mem-attempts { text-align: center; margin-top: 16px; font-size: 0.9rem; color: #64748b; }
        @media (max-width: 480px) {
            .mem-board { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 350px) {
            .mem-board { grid-template-columns: repeat(2, 1fr); }
        }

        /* ===== SCENARIO ===== */
        .scen-container { max-width: 600px; margin: 0 auto; }
        .scen-progress { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .scen-dot { width: 14px; height: 14px; border-radius: 50%; background: #e2e8f0; transition: all 0.3s; }
        .scen-dot.done-ok { background: #22c55e; }
        .scen-dot.done-ko { background: #ef4444; }
        .scen-dot.current { background: #3b82f6; transform: scale(1.3); }
        .scen-texte { font-size: 1.05rem; color: #1e293b; line-height: 1.6; margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid #3b82f6; }
        .scen-choices { display: flex; flex-direction: column; gap: 10px; }
        .scen-choice { padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: all 0.2s; background: #fff; color: #334155; text-align: left; }
        .scen-choice:hover { border-color: #3b82f6; background: #eff6ff; }
        .scen-choice.selected-correct { border-color: #22c55e; background: #dcfce7; color: #166534; }
        .scen-choice.selected-wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .scen-feedback { margin-top: 12px; padding: 12px 16px; background: #fefce8; border-left: 4px solid #eab308; border-radius: 8px; font-size: 0.9rem; color: #854d0e; }
        .scen-end { text-align: center; padding: 30px; background: #f0fdf4; border-radius: 16px; border: 2px solid #22c55e; }
        .scen-end h3 { color: #166534; margin-bottom: 8px; }
    </style>
</head>
</head>
<body>

<!-- ============================== -->
<!-- SCREEN 1 : SELECTION           -->
<!-- ============================== -->
<div class="screen" id="screen-select">
    <a href="index.html" class="back-home">‚Üê Retour au site PSE</a>
    <div class="exo-header">
        <h1>Exercices en ligne</h1>
        <p>Choisis ton niveau, ton module, et entraine-toi !</p>
    </div>

    <!-- Niveau -->
    <div id="zone-niveaux">
        <div class="theme-label">Choisis ton niveau</div>
        <div class="level-grid" id="level-grid"></div>
        <div class="theme-label" style="color:#f59e0b; margin-top:8px;">Competences transversales</div>
        <div class="level-grid" id="transversal-grid"></div>
    </div>

    <!-- Modules -->
    <div id="zone-modules" style="display:none;">
        <div id="modules-container"></div>
    </div>

    <!-- Transversal exercises list -->
    <div id="zone-transversal" style="display:none;">
        <div class="theme-label" id="transversal-label" style="color:#f59e0b;">Exercices transversaux</div>
        <div id="transversal-list"></div>
    </div>

    <!-- Exercices -->
    <div id="zone-exercices" style="display:none;">
        <div class="theme-label" id="exercices-label">Exercices disponibles</div>
        <div id="exercices-list"></div>
    </div>
</div>

<!-- ============================== -->
<!-- SCREEN 2 : PLAY                -->
<!-- ============================== -->
<div class="screen screen-hidden" id="screen-play">
    <div class="play-header">
        <button class="back-btn" onclick="backToList()">‚Üê</button>
        <div>
            <h2 id="play-title">...</h2>
        </div>
        <div class="play-badge" id="play-badge"></div>
    </div>
    <div class="consigne-box" id="play-consigne"></div>
    <div class="game-zone" id="game-zone"></div>
    <button class="btn-validate" id="btn-validate" onclick="validateExercice()">Valider mes reponses</button>
    <div id="zone-results" style="display:none; margin-top:20px;"></div>
</div>

<script>
// =====================================================================
// DATA
// =====================================================================
const NIVEAUX = [
    { key: 'CAP', label: 'CAP' },
    { key: 'BAC_PRO_2NDE', label: '2nde Bac Pro' },
    { key: 'BAC_PRO_1ERE', label: '1ere Bac Pro' },
    { key: 'BAC_PRO_TERM', label: 'Terminale Bac Pro' }
];

const TYPE_ICONS = {
    texte_trous: 'üìù', relier: 'üîó', ordre: 'üìã', intrus: 'üîç', pendu: 'üéØ',
    mots_croises: '‚úèÔ∏è', swipe_vf: 'üëÜ', qcm_image: 'üñºÔ∏è', tableau: 'üìä', etude_cas: 'üìñ', pad: '‚ö†Ô∏è', prevention: 'üõ°Ô∏è', estimation_risque: 'üìä', duerp_ligne: 'üìã', duerp_mini: 'üìã',
    qcm_classique: 'üéØ', quiz_chrono: '‚è±Ô∏è', categoriser: 'üìÇ', memory: 'üÉè', scenario: 'üé¨'
};
const TYPE_LABELS = {
    texte_trous: 'Texte a trous', relier: 'Relier', ordre: 'Ordre', intrus: 'Intrus',
    pendu: 'Pendu', mots_croises: 'Mots croises', swipe_vf: 'Vrai/Faux',
    qcm_image: 'QCM Image', tableau: 'Tableau', etude_cas: 'Etude de cas', pad: 'PAD', prevention: 'Prevention', estimation_risque: 'Estimation du risque', duerp_ligne: 'DUERP', duerp_mini: 'Mini DUERP',
    qcm_classique: 'QCM Classique', quiz_chrono: 'Quiz Chrono', categoriser: 'Categoriser', memory: 'Memory', scenario: 'Scenario'
};
const TRANSVERSAL_TYPES = ['pad', 'prevention', 'estimation_risque', 'duerp_ligne', 'duerp_mini'];

let allExercices = [];
let currentNiveau = null;
let currentModuleId = null;
let currentExo = null;
let corrected = false;
</script>

<script>
// === MODULES PSE (copie locale pour GitHub Pages) ===
window.MODULES_PSE = {
    "CAP": [
        { id: "MA1", titre: "Le systeme de sante", theme: "A" },
        { id: "MA2", titre: "Le sommeil, un rythme biologique", theme: "A" },
        { id: "MA3", titre: "L'activite physique", theme: "A" },
        { id: "MA4", titre: "Les addictions", theme: "A" },
        { id: "MA5", titre: "La sexualite - La contraception", theme: "A" },
        { id: "MA6", titre: "Prevenir les IST", theme: "A" },
        { id: "MA7", titre: "L'alimentation adaptee a son activite", theme: "A" },
        { id: "MB1", titre: "Les ressources en eau", theme: "B" },
        { id: "MB2", titre: "Le risque majeur", theme: "B" },
        { id: "MB3", titre: "Les ressources en energie", theme: "B" },
        { id: "MB4", titre: "Le bruit au quotidien", theme: "B" },
        { id: "MC1", titre: "Les differents contrats de travail", theme: "C" },
        { id: "MC2", titre: "Les enjeux de la sante et securite au travail", theme: "C" },
        { id: "MC3", titre: "La demarche de prevention (activite)", theme: "C" },
        { id: "MC4", titre: "La demarche de prevention (risque specifique)", theme: "C" },
        { id: "MC5", titre: "Les risques lies a l'activite physique", theme: "C" },
        { id: "MC6", titre: "Les acteurs et organismes de prevention", theme: "C" },
        { id: "MC7", titre: "Le suivi medical et la vaccination", theme: "C" },
        { id: "MD1", titre: "L'assurance", theme: "D" },
        { id: "MD2", titre: "Le budget", theme: "D" },
        { id: "MD3", titre: "Les achats", theme: "D" }
    ],
    "BAC_PRO_2NDE": [
        { id: "A1", titre: "Le systeme de sante", theme: "A" },
        { id: "A2", titre: "Les rythmes biologiques - Le sommeil", theme: "A" },
        { id: "A3", titre: "L'activite physique", theme: "A" },
        { id: "A4", titre: "Les addictions", theme: "A" },
        { id: "A5", titre: "La sexualite - La contraception", theme: "A" },
        { id: "B1", titre: "L'alimentation ecoresponsable", theme: "B" },
        { id: "B2", titre: "Les risques majeurs", theme: "B" },
        { id: "C1", titre: "Les enjeux de la sante et securite au travail", theme: "C" },
        { id: "C2", titre: "Les notions de base en prevention", theme: "C" }
    ],
    "BAC_PRO_1ERE": [
        { id: "A6", titre: "Les infections sexuellement transmissibles", theme: "A" },
        { id: "A7", titre: "Les pratiques alimentaires", theme: "A" },
        { id: "A8", titre: "Le stress au quotidien", theme: "A" },
        { id: "B3", titre: "Le bruit au quotidien", theme: "B" },
        { id: "B4", titre: "L'eau et le developpement durable", theme: "B" },
        { id: "C3", titre: "Les acteurs de prevention", theme: "C" },
        { id: "C4", titre: "L'assistance et le secours en milieu professionnel", theme: "C" },
        { id: "C5", titre: "L'analyse des risques professionnels", theme: "C" },
        { id: "C6", titre: "L'analyse d'un risque specifique", theme: "C" }
    ],
    "BAC_PRO_TERM": [
        { id: "A9", titre: "La securite alimentaire", theme: "A" },
        { id: "B5", titre: "Les ressources en energie et developpement durable", theme: "B" },
        { id: "C7", titre: "Le suivi de la sante au travail", theme: "C" },
        { id: "C8", titre: "Declaration et reparation des AT/MP", theme: "C" },
        { id: "C9", titre: "Les risques psychosociaux", theme: "C" },
        { id: "C10", titre: "Les risques lies a l'activite physique", theme: "C" },
        { id: "C11", titre: "L'analyse d'une situation de travail", theme: "C" },
        { id: "C12", titre: "L'egalite de traitement au travail", theme: "C" }
    ]
};
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Load all published exercises
async function loadExercices() {
    const q = query(collection(db, "exercices_banque"), where("publie", "==", true));
    const snap = await getDocs(q);
    allExercices = [];
    snap.forEach(d => allExercices.push({ id: d.id, ...d.data() }));
    console.log("‚úÖ Exercices charges:", allExercices.length, allExercices.map(e => ({titre: e.titre, niveau: e.niveau, moduleId: e.moduleId})));
    renderNiveaux();
}

window.loadExercices = loadExercices;
loadExercices();
</script>

<script>
// =====================================================================
// SCREEN 1 : NAVIGATION
// =====================================================================

function renderNiveaux() {
    const grid = document.getElementById('level-grid');
    grid.innerHTML = '';
    NIVEAUX.forEach(n => {
        const count = allExercices.filter(e => e.niveau === n.key).length;
        const btn = document.createElement('div');
        btn.className = 'level-btn';
        btn.innerHTML = n.label + (count > 0 ? ' <span style="font-size:0.75rem; color:#94a3b8;">(' + count + ')</span>' : '');
        btn.onclick = () => selectNiveau(n.key, btn);
        if (count === 0) { btn.style.opacity = '0.4'; btn.style.cursor = 'default'; btn.onclick = null; }
        grid.appendChild(btn);
    });

    // Transversal buttons
    const transGrid = document.getElementById('transversal-grid');
    if (!transGrid) return;
    transGrid.innerHTML = '';
    const TRANSVERSAL_BTNS = [
        { type: 'pad', label: '‚ö†Ô∏è PAD', color: '#f59e0b' },
        { type: 'estimation_risque', label: 'üìä Estimation du risque', color: '#8b5cf6' },
        { type: 'prevention', label: 'üõ°Ô∏è Mesures de prevention', color: '#22c55e' },
        { type: 'duerp_ligne', label: 'üìã DUERP Ligne', color: '#1e293b' },
        { type: 'duerp_mini', label: 'üìã DUERP Mini', color: '#1e293b' }
    ];
    TRANSVERSAL_BTNS.forEach(t => {
        const count = allExercices.filter(e => TRANSVERSAL_TYPES.includes(e.type) && e.type === t.type).length;
        const btn = document.createElement('div');
        btn.className = 'level-btn level-btn-trans';
        btn.style.borderColor = t.color;
        btn.style.color = t.color;
        btn.innerHTML = t.label + (count > 0 ? ' <span style="font-size:0.75rem; opacity:0.7;">(' + count + ')</span>' : '');
        btn.onclick = () => selectTransversal(t.type, btn);
        if (count === 0) { btn.style.opacity = '0.4'; btn.style.cursor = 'default'; btn.onclick = null; }
        transGrid.appendChild(btn);
    });
}

function selectNiveau(niveauKey, btnEl) {
    currentNiveau = niveauKey;
    currentModuleId = null;
    document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
    document.getElementById('zone-modules').style.display = '';
    document.getElementById('zone-exercices').style.display = 'none';
    document.getElementById('zone-transversal').style.display = 'none';
    renderModules(niveauKey);
    setTimeout(() => { document.getElementById('zone-modules').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

function selectTransversal(type, btnEl) {
    currentNiveau = null;
    currentModuleId = null;
    document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
    document.getElementById('zone-modules').style.display = 'none';
    document.getElementById('zone-exercices').style.display = 'none';
    // Show transversal exercises zone
    document.getElementById('zone-transversal').style.display = '';
    renderTransversal(type);
    setTimeout(() => { document.getElementById('zone-transversal').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

function renderModules(niveauKey) {
    const container = document.getElementById('modules-container');
    container.innerHTML = '<div class="theme-label">Choisis ton module</div>';
    const modules = window.MODULES_PSE[niveauKey] || [];
    const exosForNiveau = allExercices.filter(e => e.niveau === niveauKey);
    let currentTheme = '';
    let grid = null;

    modules.forEach(m => {
        if (m.parent) return;
        if (m.theme !== currentTheme) {
            currentTheme = m.theme;
            // Nouvelle grille pour chaque theme
            grid = document.createElement('div');
            grid.className = 'module-grid';
            const label = document.createElement('div');
            label.className = 'theme-label';
            const themeNames = { A: 'Sante', B: 'Environnement', C: 'Travail', D: 'Consommation' };
            label.textContent = 'Theme ' + m.theme + ' ‚Äî ' + (themeNames[m.theme] || '');
            container.appendChild(label);
            container.appendChild(grid);
        }
        const count = exosForNiveau.filter(e => e.moduleId === m.id).length;
        const btn = document.createElement('div');
        btn.className = 'module-btn';
        btn.innerHTML = '<span class="mod-id">' + m.id + '</span> ' + m.titre +
            (count > 0 ? ' <span style="font-size:0.75rem; color:#94a3b8;">(' + count + ')</span>' : '');
        btn.onclick = () => selectModule(m.id, btn);
        if (count === 0) { btn.style.opacity = '0.4'; btn.style.cursor = 'default'; btn.onclick = null; }
        grid.appendChild(btn);
    });
}

function renderTransversal(type) {
    const container = document.getElementById('transversal-list');
    if (!container) return;
    container.innerHTML = '';
    var transExos = allExercices.filter(e => e.type === type);
    var label = document.getElementById('transversal-label');
    var typeNames = { pad: '‚ö†Ô∏è PAD ‚Äî Analyse des risques', prevention: 'üõ°Ô∏è Mesures de prevention', estimation_risque: 'üìä Estimation du risque', duerp_ligne: 'üìã DUERP ‚Äî Ligne', duerp_mini: 'üìã DUERP ‚Äî Mini' };
    if (label) label.textContent = (typeNames[type] || type) + ' ‚Äî ' + transExos.length + ' exercice' + (transExos.length > 1 ? 's' : '');
    if (transExos.length === 0) {
        container.innerHTML = '<div class="empty-msg">Aucun exercice de ce type pour le moment.</div>';
        return;
    }
    transExos.forEach(ex => {
        const card = document.createElement('div');
        card.className = 'exo-card';
        card.innerHTML = '<div class="exo-icon">' + (TYPE_ICONS[ex.type] || 'üìå') + '</div>' +
            '<div class="exo-info"><h3>' + (ex.titre || 'Sans titre') + '</h3>' +
            '<div class="exo-meta">' +
            '<span class="exo-badge badge-type">' + (TYPE_LABELS[ex.type] || ex.type) + '</span>' +
            (ex.difficulte ? '<span class="exo-badge badge-' + ex.difficulte + '">' + ex.difficulte + '</span>' : '') +
            '</div></div>';
        card.onclick = () => startExercice(ex);
        container.appendChild(card);
    });
}

function selectModule(moduleId, btnEl) {
    currentModuleId = moduleId;
    document.querySelectorAll('.module-btn').forEach(b => b.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
    document.getElementById('zone-exercices').style.display = '';
    renderExercicesList();
    setTimeout(() => { document.getElementById('zone-exercices').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

function renderExercicesList() {
    const list = document.getElementById('exercices-list');
    list.innerHTML = '';
    const isAll = currentModuleId === '__ALL__';
    const exos = isAll
        ? allExercices.filter(e => e.niveau === currentNiveau && !TRANSVERSAL_TYPES.includes(e.type))
        : allExercices.filter(e => e.niveau === currentNiveau && e.moduleId === currentModuleId && !TRANSVERSAL_TYPES.includes(e.type));
    const label = document.getElementById('exercices-label');
    label.textContent = (isAll ? 'Tous les exercices ‚Äî ' : '') + exos.length + ' exercice' + (exos.length > 1 ? 's' : '') + ' disponible' + (exos.length > 1 ? 's' : '');

    if (exos.length === 0) {
        list.innerHTML = '<div class="empty-msg">Aucun exercice ' + (isAll ? 'pour ce niveau' : 'pour ce module') + '.</div>';
        return;
    }
    // Trouver les noms de modules pour affichage
    const modulesMap = {};
    Object.values(window.MODULES_PSE || {}).forEach(arr => arr.forEach(m => { modulesMap[m.id] = m.id + ' ‚Äî ' + m.titre; }));

    exos.forEach(ex => {
        const card = document.createElement('div');
        card.className = 'exo-card';
        const moduleLabel = isAll && ex.moduleId ? '<span class="exo-badge" style="background:#e0e7ff; color:#3730a3;">' + (modulesMap[ex.moduleId] || ex.moduleId) + '</span>' : '';
        card.innerHTML = '<div class="exo-icon">' + (TYPE_ICONS[ex.type] || 'üìÑ') + '</div>' +
            '<div class="exo-info"><h3>' + (ex.titre || 'Sans titre') + '</h3>' +
            '<div class="exo-meta">' +
            '<span class="exo-badge badge-type">' + (TYPE_LABELS[ex.type] || ex.type) + '</span>' +
            (ex.difficulte ? '<span class="exo-badge badge-' + ex.difficulte + '">' + ex.difficulte + '</span>' : '') +
            moduleLabel +
            '</div></div>';
        card.onclick = () => startExercice(ex);
        list.appendChild(card);
    });
}

// =====================================================================
// SCREEN 2 : PLAY
// =====================================================================

function showScreen(name) {
    document.getElementById('screen-select').classList.toggle('screen-hidden', name !== 'select');
    document.getElementById('screen-play').classList.toggle('screen-hidden', name !== 'play');
}

function backToList() {
    showScreen('select');
    currentExo = null;
    corrected = false;
}

function startExercice(ex) {
    currentExo = ex;
    corrected = false;
    document.getElementById('play-title').textContent = ex.titre || 'Exercice';
    document.getElementById('play-badge').innerHTML = '<span class="exo-badge badge-type">' + (TYPE_LABELS[ex.type] || '') + '</span>';
    document.getElementById('play-consigne').textContent = (ex.contenu && ex.contenu.consigne) || '';
    document.getElementById('btn-validate').style.display = '';
    document.getElementById('btn-validate').disabled = false;
    document.getElementById('zone-results').style.display = 'none';
    document.getElementById('zone-results').innerHTML = '';

    const zone = document.getElementById('game-zone');
    zone.innerHTML = '';

    // Render based on type
    const renderers = {
        texte_trous: renderTexteTrous,
        relier: renderRelier,
        ordre: renderOrdre,
        intrus: renderIntrus,
        pendu: renderPendu,
        mots_croises: renderMotsCroises,
        swipe_vf: renderSwipeVF,
        qcm_image: renderQcmImage,
        tableau: renderTableau,
        etude_cas: renderEtudeCas,
        pad: renderPad,
        prevention: renderPrevention,
        estimation_risque: renderEstimation,
        duerp_ligne: renderDuerpLigne,
        duerp_mini: renderDuerpMini,
        qcm_classique: renderQcmClassique,
        quiz_chrono: renderQuizChrono,
        categoriser: renderCategoriser,
        memory: renderMemory,
        scenario: renderScenario
    };

    const renderer = renderers[ex.type];
    if (renderer) renderer(zone, ex.contenu);
    else zone.innerHTML = '<div class="empty-msg">Type d\'exercice non supporte.</div>';

    // Auto-validating types: hide Valider button
    if (ex.type === 'pendu' || ex.type === 'swipe_vf' || ex.type === 'quiz_chrono' || ex.type === 'memory' || ex.type === 'scenario') {
        document.getElementById('btn-validate').style.display = 'none';
    }

    showScreen('play');
    window.scrollTo(0, 0);
}

// =====================================================================
// NORMALIZE TEXT (accent + case insensitive)
// =====================================================================
function norm(t) {
    return (t || '').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

// =====================================================================
// RENDERERS
// =====================================================================

// --- 1. TEXTE A TROUS ---
function renderTexteTrous(zone, c) {
    const texte = c.texte || '';
    const parts = texte.split(/(\{\{[^}]+\}\})/g);
    let idx = 0;
    let html = '<div class="tt-texte">';
    parts.forEach(part => {
        const m = part.match(/^\{\{(.+)\}\}$/);
        if (m) {
            const answer = m[1];
            const hint = c.indice ? ' <span class="tt-hint">(' + answer.split('').sort(() => Math.random() - 0.5).join('') + ')</span>' : '';
            html += '<input type="text" class="tt-input" data-answer="' + answer.replace(/"/g, '&quot;') + '" data-idx="' + idx + '" autocomplete="off">' + hint;
            idx++;
        } else {
            html += part;
        }
    });
    html += '</div>';
    zone.innerHTML = html;
}

// --- 2. RELIER ---
var relierState = { selected: null, pairs: [], correctPairs: [] };

function renderRelier(zone, c) {
    const paires = c.paires || [];
    relierState = { selected: null, pairs: [], correctPairs: paires };
    const shuffledLeft = paires.map((p, i) => ({ text: p.gauche, idx: i }));
    const shuffledRight = paires.map((p, i) => ({ text: p.droite, idx: i }));
    shuffledRight.sort(() => Math.random() - 0.5);

    let html = '<div class="relier-container">';
    html += '<div class="relier-col" id="rel-col-left">';
    shuffledLeft.forEach(item => {
        html += '<div class="relier-item" data-side="left" data-idx="' + item.idx + '" onclick="relierClick(this)">' + item.text + '</div>';
    });
    html += '</div>';
    html += '<div class="relier-col" id="rel-col-right">';
    shuffledRight.forEach(item => {
        html += '<div class="relier-item" data-side="right" data-idx="' + item.idx + '" onclick="relierClick(this)">' + item.text + '</div>';
    });
    html += '</div></div>';
    html += '<div class="relier-pairs-display" id="relier-pairs-display"></div>';
    zone.innerHTML = html;
}

function relierClick(el) {
    if (corrected || el.classList.contains('matched')) return;
    const side = el.dataset.side;
    if (relierState.selected && relierState.selected.dataset.side === side) {
        relierState.selected.classList.remove('selected');
        if (relierState.selected === el) { relierState.selected = null; return; }
    }
    if (relierState.selected && relierState.selected.dataset.side !== side) {
        const leftEl = side === 'left' ? el : relierState.selected;
        const rightEl = side === 'right' ? el : relierState.selected;
        relierState.pairs.push({ leftIdx: parseInt(leftEl.dataset.idx), rightIdx: parseInt(rightEl.dataset.idx), leftText: leftEl.textContent, rightText: rightEl.textContent });
        leftEl.classList.remove('selected');
        leftEl.classList.add('matched');
        rightEl.classList.add('matched');
        relierState.selected = null;
        renderRelierPairs();
    } else {
        if (relierState.selected) relierState.selected.classList.remove('selected');
        el.classList.add('selected');
        relierState.selected = el;
    }
}

function renderRelierPairs() {
    const display = document.getElementById('relier-pairs-display');
    display.innerHTML = '';
    relierState.pairs.forEach((p, i) => {
        const tag = document.createElement('div');
        tag.className = 'relier-pair-tag';
        tag.innerHTML = p.leftText + ' ‚Üî ' + p.rightText + ' <span class="remove-pair" onclick="removeRelierPair(' + i + ')">&times;</span>';
        display.appendChild(tag);
    });
}

function removeRelierPair(i) {
    if (corrected) return;
    const pair = relierState.pairs.splice(i, 1)[0];
    // Unmatch items
    document.querySelectorAll('.relier-item').forEach(el => {
        const idx = parseInt(el.dataset.idx);
        const side = el.dataset.side;
        if ((side === 'left' && idx === pair.leftIdx) || (side === 'right' && idx === pair.rightIdx)) {
            el.classList.remove('matched');
        }
    });
    renderRelierPairs();
}

// --- 3. ORDRE ---
function renderOrdre(zone, c) {
    const items = [...(c.items || [])];
    const shuffled = items.map((text, correctIdx) => ({ text, correctIdx }));
    shuffled.sort(() => Math.random() - 0.5);
    zone.dataset.correctOrder = JSON.stringify(items);

    let html = '<div class="ordre-list" id="ordre-list">';
    shuffled.forEach((item, i) => {
        html += '<div class="ordre-item" data-correct="' + item.correctIdx + '">' +
            '<span class="ordre-num">' + (i + 1) + '.</span>' +
            '<span class="ordre-text">' + item.text + '</span>' +
            '<div class="ordre-arrows">' +
            '<button onclick="ordreMove(this,-1)">‚ñ≤</button>' +
            '<button onclick="ordreMove(this,1)">‚ñº</button>' +
            '</div></div>';
    });
    html += '</div>';
    zone.innerHTML = html;
}

function ordreMove(btn, dir) {
    if (corrected) return;
    const item = btn.closest('.ordre-item');
    const list = item.parentElement;
    const items = [...list.children];
    const idx = items.indexOf(item);
    const newIdx = idx + dir;
    if (newIdx < 0 || newIdx >= items.length) return;
    if (dir === -1) list.insertBefore(item, items[newIdx]);
    else list.insertBefore(items[newIdx], item);
    [...list.children].forEach((it, i) => { it.querySelector('.ordre-num').textContent = (i + 1) + '.'; });
}

// --- 4. INTRUS ---
function renderIntrus(zone, c) {
    const series = c.series || [];
    let html = '';
    series.forEach((s, si) => {
        const safeIntrus = Math.min(Math.max(parseInt(s.intrus) || 0, 0), s.items.length - 1);
        html += '<div class="intrus-serie" data-intrus="' + safeIntrus + '" data-serie="' + si + '">';
        html += '<h4>Serie ' + (si + 1) + '</h4>';
        html += '<div class="intrus-items">';
        s.items.forEach((item, ii) => {
            html += '<div class="intrus-item" data-item-idx="' + ii + '" data-serie="' + si + '" onclick="intrusClick(this)">' + item + '</div>';
        });
        html += '</div>';
        html += '<div class="intrus-explication" id="intrus-expl-' + si + '">' + (s.explication || '') + '</div>';
        html += '</div>';
    });
    zone.innerHTML = html;
}

function intrusClick(el) {
    if (corrected) return;
    const serie = el.dataset.serie;
    document.querySelectorAll('.intrus-item[data-serie="' + serie + '"]').forEach(it => it.classList.remove('selected'));
    el.classList.add('selected');
}

// --- 5. PENDU ---
var penduState = {};

function renderPendu(zone, c) {
    const mots = c.mots || [];
    penduState = { mots, current: 0, errors: 0, maxErrors: 8, found: [], results: [] };
    zone.innerHTML = '<div class="pendu-zone" id="pendu-zone"></div>';
    renderPenduMot();
}

function renderPenduMot() {
    const z = document.getElementById('pendu-zone');
    const s = penduState;
    if (s.current >= s.mots.length) { finishPendu(); return; }
    const motObj = s.mots[s.current];
    const mot = motObj.mot.toUpperCase();
    s.errors = 0;
    s.found = [];
    const display = mot.split('').map(() => '_').join(' ');

    let html = '<div class="pendu-status">Mot ' + (s.current + 1) + ' / ' + s.mots.length + '</div>';
    html += renderPenduSvg(0);
    html += '<div class="pendu-mot" id="pendu-display">' + display + '</div>';
    html += '<div class="pendu-indice">Indice : ' + (motObj.indice || '‚Äî') + '</div>';
    html += '<div class="pendu-erreurs" id="pendu-erreurs"></div>';
    html += '<div class="pendu-clavier" id="pendu-clavier">';
    'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(l => {
        html += '<div class="pendu-key" data-letter="' + l + '" onclick="penduGuess(\'' + l + '\', this)">' + l + '</div>';
    });
    html += '</div>';
    html += '<div class="pendu-nav" id="pendu-nav" style="display:none;"><button class="pendu-next" onclick="penduNext()">Mot suivant ‚Üí</button></div>';
    z.innerHTML = html;
}

function renderPenduSvg(errors) {
    const parts = [
        '<line x1="20" y1="140" x2="80" y2="140" stroke="#1e293b" stroke-width="3"/>',  // base
        '<line x1="50" y1="140" x2="50" y2="20" stroke="#1e293b" stroke-width="3"/>',    // poteau
        '<line x1="50" y1="20" x2="110" y2="20" stroke="#1e293b" stroke-width="3"/>',    // traverse
        '<line x1="110" y1="20" x2="110" y2="40" stroke="#1e293b" stroke-width="3"/>',   // corde
        '<circle cx="110" cy="52" r="12" stroke="#1e293b" stroke-width="3" fill="none"/>', // tete
        '<line x1="110" y1="64" x2="110" y2="100" stroke="#1e293b" stroke-width="3"/>',   // corps
        '<line x1="110" y1="75" x2="90" y2="90" stroke="#1e293b" stroke-width="3"/><line x1="110" y1="75" x2="130" y2="90" stroke="#1e293b" stroke-width="3"/>', // bras
        '<line x1="110" y1="100" x2="90" y2="125" stroke="#1e293b" stroke-width="3"/><line x1="110" y1="100" x2="130" y2="125" stroke="#1e293b" stroke-width="3"/>'  // jambes
    ];
    let svg = '<svg class="pendu-svg" width="150" height="150" viewBox="0 0 150 150">';
    for (let i = 0; i < Math.min(errors, parts.length); i++) svg += parts[i];
    svg += '</svg>';
    return svg;
}

function penduGuess(letter, keyEl) {
    const s = penduState;
    if (keyEl.classList.contains('used-ok') || keyEl.classList.contains('used-ko')) return;
    const mot = s.mots[s.current].mot.toUpperCase();
    if (mot.includes(letter)) {
        keyEl.classList.add('used-ok');
        s.found.push(letter);
    } else {
        keyEl.classList.add('used-ko');
        s.errors++;
    }
    // Update display
    const display = mot.split('').map(l => s.found.includes(l) ? l : '_').join(' ');
    document.getElementById('pendu-display').textContent = display;
    document.getElementById('pendu-erreurs').textContent = s.errors > 0 ? s.errors + ' / ' + s.maxErrors + ' erreurs' : '';

    // Update SVG
    const svgContainer = document.querySelector('.pendu-svg');
    if (svgContainer) svgContainer.outerHTML = renderPenduSvg(s.errors);

    // Check win/lose
    const won = mot.split('').every(l => s.found.includes(l));
    const lost = s.errors >= s.maxErrors;
    if (won || lost) {
        s.results.push({ mot: mot, won, errors: s.errors });
        // Disable keyboard
        document.querySelectorAll('.pendu-key').forEach(k => { if (!k.classList.contains('used-ok') && !k.classList.contains('used-ko')) { k.style.opacity = '0.3'; k.style.cursor = 'default'; k.onclick = null; } });
        if (lost) document.getElementById('pendu-display').textContent = mot.split('').join(' ');
        document.getElementById('pendu-nav').style.display = '';
    }
}

function penduNext() {
    penduState.current++;
    renderPenduMot();
}

function finishPendu() {
    const s = penduState;
    const correct = s.results.filter(r => r.won).length;
    const total = s.results.length;
    showResults(correct, total, s.results.map(r => ({
        ok: r.won,
        label: r.mot,
        detail: r.won ? 'Trouve !' : 'Non trouve (' + r.errors + ' erreurs)'
    })));
}

// --- 6. MOTS CROISES ---
function renderMotsCroises(zone, c) {
    const mots = (c.mots || []).filter(m => m.mot && m.mot.trim());
    if (mots.length === 0) { zone.innerHTML = '<div class="empty-msg">Aucun mot.</div>'; return; }

    // Generate grid
    const grid = generateCrosswordGrid(mots);
    let html = '<div class="mc-container">';
    html += '<div class="mc-grid-wrap"><table class="mc-grid" id="mc-grid">';
    for (let r = 0; r < grid.rows; r++) {
        html += '<tr>';
        for (let col = 0; col < grid.cols; col++) {
            const cell = grid.cells[r + ',' + col];
            if (cell) {
                const numHtml = cell.num ? '<span class="mc-num">' + cell.num + '</span>' : '';
                html += '<td>' + numHtml + '<input type="text" maxlength="1" data-r="' + r + '" data-c="' + col + '" data-answer="' + cell.letter + '" autocomplete="off" oninput="mcAutoMove(this)"></td>';
            } else {
                html += '<td class="mc-empty"></td>';
            }
        }
        html += '</tr>';
    }
    html += '</table></div>';

    // Definitions
    html += '<div class="mc-defs">';
    if (grid.horizontal.length > 0) {
        html += '<h4>Horizontal ‚Üí</h4><ol>';
        grid.horizontal.forEach(w => { html += '<li value="' + w.num + '">' + w.definition + '</li>'; });
        html += '</ol>';
    }
    if (grid.vertical.length > 0) {
        html += '<h4>Vertical ‚Üì</h4><ol>';
        grid.vertical.forEach(w => { html += '<li value="' + w.num + '">' + w.definition + '</li>'; });
        html += '</ol>';
    }
    html += '</div></div>';
    zone.innerHTML = html;
}

function mcAutoMove(inp) {
    if (inp.value.length === 1) {
        // Move to next input in same row
        const td = inp.closest('td');
        const nextTd = td.nextElementSibling;
        if (nextTd && nextTd.querySelector('input')) {
            nextTd.querySelector('input').focus();
        }
    }
}

function generateCrosswordGrid(mots) {
    // Simple crossword placement algorithm
    mots.sort((a, b) => b.mot.length - a.mot.length);
    const placed = [];
    const cells = {};
    let minR = 0, maxR = 0, minC = 0, maxC = 0;
    let numCounter = 1;
    const horizontal = [];
    const vertical = [];

    // Place first word horizontally at origin
    const first = mots[0];
    const firstMot = first.mot.toUpperCase();
    for (let i = 0; i < firstMot.length; i++) {
        cells['0,' + i] = { letter: firstMot[i], num: i === 0 ? numCounter : null };
    }
    horizontal.push({ num: numCounter, definition: first.definition, mot: firstMot });
    numCounter++;
    placed.push({ mot: firstMot, r: 0, c: 0, dir: 'h', definition: first.definition });
    maxC = firstMot.length - 1;

    // Try to place remaining words
    for (let mi = 1; mi < mots.length; mi++) {
        const word = mots[mi].mot.toUpperCase();
        let bestPlacement = null;

        for (let pi = 0; pi < placed.length; pi++) {
            const pw = placed[pi];
            for (let pwi = 0; pwi < pw.mot.length; pwi++) {
                for (let wi = 0; wi < word.length; wi++) {
                    if (word[wi] !== pw.mot[pwi]) continue;
                    // Try perpendicular placement
                    const newDir = pw.dir === 'h' ? 'v' : 'h';
                    let startR, startC;
                    if (pw.dir === 'h') {
                        startR = pw.r - wi;
                        startC = pw.c + pwi;
                    } else {
                        startR = pw.r + pwi;
                        startC = pw.c - wi;
                    }
                    // Check if placement is valid
                    let valid = true;
                    for (let k = 0; k < word.length; k++) {
                        const r = newDir === 'h' ? startR : startR + k;
                        const c = newDir === 'h' ? startC + k : startC;
                        const existing = cells[r + ',' + c];
                        if (existing) {
                            if (existing.letter !== word[k]) { valid = false; break; }
                        } else {
                            // Check adjacent cells (avoid parallel words touching)
                            if (newDir === 'h') {
                                if (cells[(r - 1) + ',' + c] && !(k === wi && pw.dir === 'v')) { valid = false; break; }
                                if (cells[(r + 1) + ',' + c] && !(k === wi && pw.dir === 'v')) { valid = false; break; }
                            } else {
                                if (cells[r + ',' + (c - 1)] && !(k === wi && pw.dir === 'h')) { valid = false; break; }
                                if (cells[r + ',' + (c + 1)] && !(k === wi && pw.dir === 'h')) { valid = false; break; }
                            }
                        }
                    }
                    // Check before and after
                    if (valid) {
                        const beforeR = newDir === 'h' ? startR : startR - 1;
                        const beforeC = newDir === 'h' ? startC - 1 : startC;
                        const afterR = newDir === 'h' ? startR : startR + word.length;
                        const afterC = newDir === 'h' ? startC + word.length : startC;
                        if (cells[beforeR + ',' + beforeC]) valid = false;
                        if (cells[afterR + ',' + afterC]) valid = false;
                    }
                    if (valid && !bestPlacement) {
                        bestPlacement = { r: startR, c: startC, dir: newDir, intersect: wi };
                    }
                }
            }
        }

        if (bestPlacement) {
            const { r, c, dir } = bestPlacement;
            for (let k = 0; k < word.length; k++) {
                const cr = dir === 'h' ? r : r + k;
                const cc = dir === 'h' ? c + k : c;
                if (!cells[cr + ',' + cc]) {
                    cells[cr + ',' + cc] = { letter: word[k], num: k === 0 ? numCounter : null };
                } else if (k === 0 && !cells[cr + ',' + cc].num) {
                    cells[cr + ',' + cc].num = numCounter;
                }
                minR = Math.min(minR, cr); maxR = Math.max(maxR, cr);
                minC = Math.min(minC, cc); maxC = Math.max(maxC, cc);
            }
            if (dir === 'h') horizontal.push({ num: numCounter, definition: mots[mi].definition, mot: word });
            else vertical.push({ num: numCounter, definition: mots[mi].definition, mot: word });
            numCounter++;
            placed.push({ mot: word, r, c, dir, definition: mots[mi].definition });
        }
    }

    // Normalize coordinates to start at 0,0
    const normalizedCells = {};
    Object.keys(cells).forEach(key => {
        const [r, c] = key.split(',').map(Number);
        normalizedCells[(r - minR) + ',' + (c - minC)] = cells[key];
    });

    return {
        cells: normalizedCells,
        rows: maxR - minR + 1,
        cols: maxC - minC + 1,
        horizontal: horizontal.sort((a, b) => a.num - b.num),
        vertical: vertical.sort((a, b) => a.num - b.num)
    };
}

// --- 7. SWIPE VRAI/FAUX ---
var swipeState = {};

function renderSwipeVF(zone, c) {
    const affs = c.affirmations || [];
    swipeState = { affirmations: affs, current: 0, results: [] };
    zone.innerHTML = '<div class="swipe-zone" id="swipe-zone"></div>';
    renderSwipeCard();
}

function renderSwipeCard() {
    const z = document.getElementById('swipe-zone');
    const s = swipeState;
    if (s.current >= s.affirmations.length) { finishSwipe(); return; }
    const aff = s.affirmations[s.current];
    z.innerHTML = '<div class="swipe-progress">' + (s.current + 1) + ' / ' + s.affirmations.length + '</div>' +
        '<div class="swipe-card" id="swipe-card">' + aff.texte + '</div>' +
        '<div class="swipe-feedback" id="swipe-feedback"></div>' +
        '<div class="swipe-btns">' +
        '<button class="swipe-btn btn-faux" onclick="swipeAnswer(false)">Faux</button>' +
        '<button class="swipe-btn btn-vrai" onclick="swipeAnswer(true)">Vrai</button>' +
        '</div>';
}

function swipeAnswer(answer) {
    const s = swipeState;
    const aff = s.affirmations[s.current];
    const ok = answer === aff.reponse;
    s.results.push({ ok, texte: aff.texte, expected: aff.reponse, given: answer, explication: aff.explication });

    const card = document.getElementById('swipe-card');
    card.classList.add(answer ? 'slide-right' : 'slide-left');
    const fb = document.getElementById('swipe-feedback');
    fb.innerHTML = ok
        ? '<span style="color:#22c55e;">‚úì Correct !</span>'
        : '<span style="color:#ef4444;">‚úó ' + (aff.explication || ('La reponse etait ' + (aff.reponse ? 'Vrai' : 'Faux'))) + '</span>';

    setTimeout(() => { s.current++; renderSwipeCard(); }, 1500);
}

function finishSwipe() {
    const s = swipeState;
    const correct = s.results.filter(r => r.ok).length;
    showResults(correct, s.results.length, s.results.map(r => ({
        ok: r.ok,
        label: r.texte,
        detail: r.ok ? 'Correct' : (r.explication || 'Reponse : ' + (r.expected ? 'Vrai' : 'Faux'))
    })));
}

// --- 8. QCM IMAGE ---
function renderQcmImage(zone, c) {
    const questions = c.questions || [];
    let html = '<div class="qcm-img-zone">';
    questions.forEach((q, qi) => {
        html += '<div class="qcm-img-q" data-correct="' + q.correct + '" data-qi="' + qi + '">';
        if (q.image) html += '<img src="' + q.image + '" alt="Image" onerror="this.style.display=\'none\'">';
        else html += '<div class="qcm-img-placeholder">üì∑ Image non disponible</div>';
        html += '<div class="q-text">' + (qi + 1) + '. ' + q.question + '</div>';
        html += '<div class="qcm-img-choices">';
        (q.choix || []).forEach((ch, ci) => {
            html += '<div class="qcm-img-choice" data-qi="' + qi + '" data-ci="' + ci + '" onclick="qcmImgSelect(this)">' + ch + '</div>';
        });
        html += '</div>';
        html += '<div class="qcm-img-expl" id="qcm-expl-' + qi + '">' + (q.explication || '') + '</div>';
        html += '</div>';
    });
    html += '</div>';
    zone.innerHTML = html;
}

function qcmImgSelect(el) {
    if (corrected) return;
    const qi = el.dataset.qi;
    document.querySelectorAll('.qcm-img-choice[data-qi="' + qi + '"]').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
}

// --- 9. TABLEAU ---
function renderTableau(zone, c) {
    const colonnes = c.colonnes || [];
    const lignes = c.lignes || [];
    let html = '<div class="tableau-zone"><table>';
    html += '<thead><tr>';
    colonnes.forEach(col => { html += '<th>' + col + '</th>'; });
    html += '</tr></thead><tbody>';
    lignes.forEach((ligne, li) => {
        html += '<tr>';
        (ligne.cellules || []).forEach((cell, ci) => {
            const m = cell.match(/^\{\{(.+)\}\}$/);
            if (m) {
                html += '<td><input type="text" data-answer="' + m[1].replace(/"/g, '&quot;') + '" data-row="' + li + '" data-col="' + ci + '" autocomplete="off"></td>';
            } else {
                html += '<td>' + cell + '</td>';
            }
        });
        html += '</tr>';
    });
    html += '</tbody></table></div>';
    zone.innerHTML = html;
}

// --- 10. ETUDE DE CAS ---
function renderEtudeCas(zone, c) {
    let html = '<div class="ec-scenario">' + (c.scenario || '') + '</div>';
    const questions = c.questions || [];
    questions.forEach((q, qi) => {
        html += '<div class="ec-question" data-qi="' + qi + '" data-type="' + q.type + '">';
        html += '<div class="ec-q-text"><span class="ec-q-num">Q' + (qi + 1) + '.</span> ' + q.question + '</div>';
        if (q.type === 'qcm') {
            html += '<div class="ec-qcm-choices">';
            (q.choix || []).forEach((ch, ci) => {
                html += '<div class="ec-qcm-choice" data-qi="' + qi + '" data-ci="' + ci + '" data-correct="' + q.correct + '" onclick="ecQcmSelect(this)">' + ch + '</div>';
            });
            html += '</div>';
        } else {
            html += '<textarea class="ec-text-input" data-qi="' + qi + '" placeholder="Votre reponse..."></textarea>';
            html += '<div class="ec-expected" id="ec-exp-' + qi + '">Reponse attendue : ' + (q.reponse || '') + '</div>';
        }
        html += '</div>';
    });
    zone.innerHTML = html;
}

function ecQcmSelect(el) {
    if (corrected) return;
    const qi = el.dataset.qi;
    document.querySelectorAll('.ec-qcm-choice[data-qi="' + qi + '"]').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
}

// --- 11. PAD (Processus d'Apparition du Dommage) ---
function shuffleArray(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function renderPad(zone, c) {
    // Build options for each PAD step (correct answer + 3 distractors, shuffled)
    function buildOptions(correct, distracteurs, fieldId) {
        const options = shuffleArray([correct, ...(distracteurs || [])]);
        let html = '<select id="' + fieldId + '" class="pad-select">';
        html += '<option value="">-- Choisissez --</option>';
        options.forEach(opt => {
            html += '<option value="' + opt.replace(/"/g, '&quot;') + '">' + opt + '</option>';
        });
        html += '</select>';
        return html;
    }

    let html = '';

    // Situation
    html += '<div class="pad-situation">';
    html += '<div class="pad-situation-label">üìã Situation professionnelle</div>';
    html += c.situation;
    html += '</div>';

    // Instruction
    html += '<div class="pad-instruction">Completez le processus d\'apparition du dommage :</div>';

    // PAD Chain: 4 steps with arrows
    html += '<div class="pad-chain">';

    // Step 1: Danger
    html += '<div class="pad-step" id="pad-step-danger">';
    html += '<div class="pad-step-label">‚ö†Ô∏è Danger</div>';
    html += buildOptions(c.danger, c.distracteurs_danger, 'pad-sel-danger');
    html += '<div class="pad-correction" style="display:none;"></div>';
    html += '</div>';

    html += '<div class="pad-arrow">‚Üí</div>';

    // Step 2: Situation dangereuse
    html += '<div class="pad-step" id="pad-step-sitdang">';
    html += '<div class="pad-step-label">üî∂ Situation dangereuse</div>';
    html += buildOptions(c.situation_dangereuse, c.distracteurs_situation_dangereuse, 'pad-sel-sitdang');
    html += '<div class="pad-correction" style="display:none;"></div>';
    html += '</div>';

    html += '<div class="pad-arrow">‚Üí</div>';

    // Step 3: Evenement declencheur
    html += '<div class="pad-step" id="pad-step-event">';
    html += '<div class="pad-step-label">‚ö° Evenement declencheur</div>';
    html += buildOptions(c.evenement_declencheur, c.distracteurs_evenement_declencheur, 'pad-sel-event');
    html += '<div class="pad-correction" style="display:none;"></div>';
    html += '</div>';

    html += '<div class="pad-arrow">‚Üí</div>';

    // Step 4: Dommage
    html += '<div class="pad-step" id="pad-step-dommage">';
    html += '<div class="pad-step-label">ü©π Dommage</div>';
    html += buildOptions(c.dommage, c.distracteurs_dommage, 'pad-sel-dommage');
    html += '<div class="pad-correction" style="display:none;"></div>';
    html += '</div>';

    html += '</div>'; // end pad-chain

    zone.innerHTML = html;
}

// --- 12. PREVENTION (Mesures de prevention) ---
function renderPrevention(zone, c) {
    const niveaux = c.niveaux || [];
    const niveauIcons = { supprimer: '1', reduire: '2', collective: '3', individuelle: '4', formation: '5' };
    const niveauColors = { supprimer: 'n1', reduire: 'n2', collective: 'n3', individuelle: 'n4', formation: 'n5' };

    let html = '';

    // Situation
    html += '<div class="prev-situation">';
    html += '<div class="prev-situation-label">üìã Situation professionnelle</div>';
    html += c.situation;
    html += '</div>';

    // Danger identifie
    html += '<div class="prev-danger-box">';
    html += '<div class="prev-danger-label">‚ö†Ô∏è Danger identifie</div>';
    html += c.danger;
    html += '</div>';

    // Instruction
    html += '<div class="prev-instruction">Pour chaque niveau de prevention, choisis la mesure adaptee a cette situation :</div>';
    html += '<div class="prev-hierarchy-label">‚¨ÜÔ∏è LE PLUS EFFICACE ‚¨ÜÔ∏è</div>';

    // 5 levels
    html += '<div class="prev-levels">';
    niveaux.forEach((n, i) => {
        const options = shuffleArray([n.bonne_reponse, ...(n.distracteurs || [])]);
        html += '<div class="prev-level" id="prev-level-' + n.niveau + '">';
        html += '<div class="prev-level-num ' + (niveauColors[n.niveau] || '') + '">' + (niveauIcons[n.niveau] || (i+1)) + '</div>';
        html += '<div class="prev-level-content">';
        html += '<div class="prev-level-label">' + n.label + '</div>';
        html += '<select id="prev-sel-' + n.niveau + '">';
        html += '<option value="">-- Choisissez --</option>';
        options.forEach(opt => {
            html += '<option value="' + opt.replace(/"/g, '&quot;') + '">' + opt + '</option>';
        });
        html += '</select>';
        html += '<div class="prev-correction" style="display:none;"></div>';
        html += '</div></div>';
        if (i < niveaux.length - 1) {
            html += '<div class="prev-efficacy-arrow">‚ñº</div>';
        }
    });
    html += '</div>';
    html += '<div class="prev-hierarchy-label" style="margin-top:8px;">‚¨áÔ∏è LE MOINS EFFICACE ‚¨áÔ∏è</div>';

    zone.innerHTML = html;
}

// =====================================================================
// ESTIMATION DU RISQUE
// =====================================================================

function calcProba(expo, decl) {
    if (expo === 'rare_courte' && decl === 'faible') return 1;
    if (expo === 'rare_courte' && decl === 'eleve') return 2;
    if (expo === 'frequente_longue' && decl === 'faible') return 3;
    if (expo === 'frequente_longue' && decl === 'eleve') return 4;
    return 0;
}
var PROBA_LABELS = { 1: 'Tres improbable', 2: 'Improbable', 3: 'Probable', 4: 'Tres probable' };
var GRAVITE_LABELS = { 1: 'Faible (sans arret)', 2: 'Moyenne (avec arret)', 3: 'Grave (sequelles)', 4: 'Tres grave (mortel)' };

function renderEstimation(zone, c) {
    var html = '';

    // Situation
    html += '<div class="est-situation">';
    html += '<div class="est-situation-label">üìã Situation professionnelle</div>';
    html += '<div>' + (c.situation || '') + '</div>';
    html += '</div>';

    // Danger + Dommage
    html += '<div class="est-danger-box">';
    html += '<div class="est-danger-label">‚ö†Ô∏è Danger identifie</div>';
    html += '<div style="font-weight:600;">' + (c.danger || '') + '</div>';
    html += '</div>';
    html += '<div class="est-dommage-box">';
    html += '<div class="est-dommage-label">ü©π Dommage possible</div>';
    html += '<div style="font-weight:600;">' + (c.dommage || '') + '</div>';
    html += '</div>';

    // Instruction
    html += '<div class="est-instruction">Estimez le risque en completant les etapes ci-dessous :</div>';

    // Steps
    html += '<div class="est-steps">';

    // Step 1: Gravite
    html += '<div class="est-step" id="est-step-gravite">';
    html += '<div class="est-step-num n1">1</div>';
    html += '<div class="est-step-content">';
    html += '<div class="est-step-label">Gravite du dommage</div>';
    html += '<select id="est-sel-gravite"><option value="">‚Äî Choisir ‚Äî</option>';
    html += '<option value="1">1 ‚Äî Faible (AT/MP sans arret)</option>';
    html += '<option value="2">2 ‚Äî Moyenne (AT/MP avec arret)</option>';
    html += '<option value="3">3 ‚Äî Grave (incapacite permanente)</option>';
    html += '<option value="4">4 ‚Äî Tres grave (mortel)</option>';
    html += '</select>';
    html += '<div class="est-step-correction" id="est-corr-gravite"></div>';
    html += '</div></div>';

    // Step 2: Exposition
    html += '<div class="est-step" id="est-step-exposition">';
    html += '<div class="est-step-num n2">2</div>';
    html += '<div class="est-step-content">';
    html += '<div class="est-step-label">Frequence / duree d\'exposition au danger</div>';
    html += '<select id="est-sel-exposition" onchange="updateEstProba()"><option value="">‚Äî Choisir ‚Äî</option>';
    html += '<option value="rare_courte">Rare et/ou courte duree</option>';
    html += '<option value="frequente_longue">Frequente et/ou longue duree</option>';
    html += '</select>';
    html += '<div class="est-step-correction" id="est-corr-exposition"></div>';
    html += '</div></div>';

    // Step 3: Declencheur
    html += '<div class="est-step" id="est-step-declencheur">';
    html += '<div class="est-step-num n3">3</div>';
    html += '<div class="est-step-content">';
    html += '<div class="est-step-label">Probabilite d\'apparition de l\'evenement declencheur</div>';
    html += '<select id="est-sel-declencheur" onchange="updateEstProba()"><option value="">‚Äî Choisir ‚Äî</option>';
    html += '<option value="faible">Faible</option>';
    html += '<option value="eleve">Elevee</option>';
    html += '</select>';
    html += '<div class="est-step-correction" id="est-corr-declencheur"></div>';
    html += '</div></div>';

    html += '</div>';

    // Probabilite display
    html += '<div class="est-proba-display" id="est-proba-display">';
    html += '<div class="est-proba-label">Probabilite d\'occurrence du dommage</div>';
    html += '<div class="est-proba-num" id="est-proba-num">?</div>';
    html += '<div id="est-proba-text" style="font-size:0.8rem; color:#64748b;">Choisissez exposition + declencheur</div>';
    html += '</div>';

    // Matrice 4x4
    html += '<div class="est-matrix-section">';
    html += '<div class="est-matrix-title">Cliquez sur la case correspondant au croisement gravite √ó probabilite</div>';
    html += '<div class="est-matrix">';
    // Header row
    html += '<div class="est-matrix-header"></div>';
    html += '<div class="est-matrix-header">1<br><span style="font-size:0.5rem;">T.improbable</span></div>';
    html += '<div class="est-matrix-header">2<br><span style="font-size:0.5rem;">Improbable</span></div>';
    html += '<div class="est-matrix-header">3<br><span style="font-size:0.5rem;">Probable</span></div>';
    html += '<div class="est-matrix-header">4<br><span style="font-size:0.5rem;">T.probable</span></div>';
    // Rows (from 4 down to 1)
    for (var g = 4; g >= 1; g--) {
        var glabels = { 4: 'T.grave', 3: 'Grave', 2: 'Moyen', 1: 'Faible' };
        html += '<div class="est-matrix-ylabel">' + g + '<br><span style="font-size:0.5rem;">' + glabels[g] + '</span></div>';
        for (var p = 1; p <= 4; p++) {
            var isPrio = (g + p) >= 5;
            html += '<div class="est-matrix-cell ' + (isPrio ? 'zone-red' : 'zone-green') + '" id="est-cell-' + g + '-' + p + '" onclick="selectEstCell(this)">';
            html += isPrio ? 'P' : 'NP';
            html += '</div>';
        }
    }
    html += '</div>';
    html += '<div style="text-align:center; margin-top:6px; font-size:0.65rem; color:#64748b;">';
    html += '<span style="display:inline-block; width:12px; height:12px; background:rgba(34,197,94,0.15); border-radius:3px; margin-right:3px; vertical-align:middle;"></span> NP = Non prioritaire &nbsp;&nbsp;';
    html += '<span style="display:inline-block; width:12px; height:12px; background:rgba(239,68,68,0.15); border-radius:3px; margin-right:3px; vertical-align:middle;"></span> P = Prioritaire';
    html += '</div>';
    html += '</div>';

    // Priorite
    html += '<div class="est-priorite-section">';
    html += '<label>La reduction du risque est-elle prioritaire ?</label>';
    html += '<div class="est-prio-btns">';
    html += '<div class="est-prio-btn" id="est-prio-prioritaire" onclick="selectEstPrio(this, \'prioritaire\')">‚úÖ PRIORITAIRE</div>';
    html += '<div class="est-prio-btn" id="est-prio-non_prioritaire" onclick="selectEstPrio(this, \'non_prioritaire\')">‚ûñ NON PRIORITAIRE</div>';
    html += '</div>';
    html += '<input type="hidden" id="est-priorite-val" value="">';
    html += '</div>';

    // Feedback zone
    html += '<div class="est-feedback" id="est-feedback"></div>';

    zone.innerHTML = html;
}

// Estimation: update probability display in real time
function updateEstProba() {
    var expo = document.getElementById('est-sel-exposition').value;
    var decl = document.getElementById('est-sel-declencheur').value;
    var display = document.getElementById('est-proba-display');
    var numEl = document.getElementById('est-proba-num');
    var textEl = document.getElementById('est-proba-text');
    if (expo && decl) {
        var p = calcProba(expo, decl);
        numEl.textContent = p;
        textEl.textContent = PROBA_LABELS[p];
        display.classList.add('visible');
    } else {
        numEl.textContent = '?';
        textEl.textContent = 'Choisissez exposition + declencheur';
        display.classList.remove('visible');
    }
}

// Estimation: select matrix cell
function selectEstCell(el) {
    document.querySelectorAll('.est-matrix-cell').forEach(function(c) { c.classList.remove('selected'); });
    el.classList.add('selected');
}

// Estimation: select priority
function selectEstPrio(el, val) {
    document.querySelectorAll('.est-prio-btn').forEach(function(b) { b.classList.remove('active'); });
    el.classList.add('active');
    document.getElementById('est-priorite-val').value = val;
}

// =====================================================================
// DUERP (Document Unique d'Evaluation des Risques Professionnels)
// =====================================================================

// --- DUERP Helper functions ---

function selectDuerpChoice(el, group) {
    if (corrected) return;
    document.querySelectorAll('.duerp-qcm-choice[data-group="' + group + '"]').forEach(function(c) { c.classList.remove('selected'); });
    el.classList.add('selected');
}

function selectDuerpExpo(el, val, prefix) {
    if (corrected) return;
    document.querySelectorAll('.duerp-est-btn[data-field="' + prefix + '-expo"]').forEach(function(b) { b.classList.remove('active'); });
    el.classList.add('active');
    el.closest('.duerp-section-body').querySelector('.duerp-expo-val').value = val;
    updateDuerpProba(prefix);
}

function selectDuerpDecl(el, val, prefix) {
    if (corrected) return;
    document.querySelectorAll('.duerp-est-btn[data-field="' + prefix + '-decl"]').forEach(function(b) { b.classList.remove('active'); });
    el.classList.add('active');
    el.closest('.duerp-section-body').querySelector('.duerp-decl-val').value = val;
    updateDuerpProba(prefix);
}

function updateDuerpProba(prefix) {
    var expoInput = document.getElementById(prefix + '-expo-val');
    var declInput = document.getElementById(prefix + '-decl-val');
    var gravSel = document.getElementById(prefix + '-sel-gravite');
    var probaDiv = document.getElementById(prefix + '-proba-display');
    var probaNum = document.getElementById(prefix + '-proba-num');
    var probaText = document.getElementById(prefix + '-proba-text');
    var prioDiv = document.getElementById(prefix + '-prio-display');
    if (!expoInput || !declInput) return;
    var expo = expoInput.value;
    var decl = declInput.value;
    var grav = gravSel ? (parseInt(gravSel.value) || 0) : 0;
    if (expo && decl) {
        var p = calcProba(expo, decl);
        probaNum.textContent = p;
        probaText.textContent = PROBA_LABELS[p];
        probaDiv.classList.add('visible');
        if (grav > 0) {
            var isPrio = (grav + p) >= 5;
            prioDiv.textContent = isPrio ? 'üî¥ PRIORITAIRE' : 'üü¢ NON PRIORITAIRE';
            prioDiv.className = 'duerp-prio-display ' + (isPrio ? 'prioritaire' : 'non_prioritaire');
        } else {
            prioDiv.textContent = 'Choisissez la gravite';
            prioDiv.className = 'duerp-prio-display empty';
        }
    } else {
        probaNum.textContent = '?';
        probaText.textContent = 'Choisissez exposition + declencheur';
        probaDiv.classList.remove('visible');
        prioDiv.textContent = 'En attente...';
        prioDiv.className = 'duerp-prio-display empty';
    }
}

function toggleDuerpMission(el) {
    if (corrected) return;
    el.classList.toggle('checked');
    var cb = el.querySelector('.duerp-mission-cb');
    cb.textContent = el.classList.contains('checked') ? '‚úì' : '';
}

// --- Build estimation block HTML (shared between duerp_ligne and duerp_mini) ---
function buildDuerpEstimationHTML(prefix) {
    var html = '';
    html += '<div class="duerp-estimation">';
    // Gravite
    html += '<div class="duerp-est-field">';
    html += '<label>Gravite</label>';
    html += '<select id="' + prefix + '-sel-gravite" onchange="updateDuerpProba(\'' + prefix + '\')">';
    html += '<option value="">‚Äî Choisir ‚Äî</option>';
    html += '<option value="1">1 ‚Äî Faible (sans arret)</option>';
    html += '<option value="2">2 ‚Äî Moyenne (avec arret)</option>';
    html += '<option value="3">3 ‚Äî Grave (sequelles)</option>';
    html += '<option value="4">4 ‚Äî Tres grave (mortel)</option>';
    html += '</select>';
    html += '<div class="duerp-est-correction" id="' + prefix + '-corr-gravite"></div>';
    html += '</div>';
    // Exposition
    html += '<div class="duerp-est-field">';
    html += '<label>Exposition</label>';
    html += '<div class="duerp-est-btns">';
    html += '<div class="duerp-est-btn" data-field="' + prefix + '-expo" data-val="rare_courte" onclick="selectDuerpExpo(this,\'rare_courte\',\'' + prefix + '\')">Rare / courte</div>';
    html += '<div class="duerp-est-btn" data-field="' + prefix + '-expo" data-val="frequente_longue" onclick="selectDuerpExpo(this,\'frequente_longue\',\'' + prefix + '\')">Frequente / longue</div>';
    html += '</div>';
    html += '<input type="hidden" class="duerp-expo-val" id="' + prefix + '-expo-val" value="">';
    html += '<div class="duerp-est-correction" id="' + prefix + '-corr-expo"></div>';
    html += '</div>';
    // Declencheur
    html += '<div class="duerp-est-field">';
    html += '<label>Declencheur</label>';
    html += '<div class="duerp-est-btns">';
    html += '<div class="duerp-est-btn" data-field="' + prefix + '-decl" data-val="faible" onclick="selectDuerpDecl(this,\'faible\',\'' + prefix + '\')">Faible</div>';
    html += '<div class="duerp-est-btn" data-field="' + prefix + '-decl" data-val="eleve" onclick="selectDuerpDecl(this,\'eleve\',\'' + prefix + '\')">Eleve</div>';
    html += '</div>';
    html += '<input type="hidden" class="duerp-decl-val" id="' + prefix + '-decl-val" value="">';
    html += '<div class="duerp-est-correction" id="' + prefix + '-corr-decl"></div>';
    html += '</div>';
    html += '</div>';
    // Proba display
    html += '<div class="duerp-proba-display" id="' + prefix + '-proba-display">';
    html += '<div class="duerp-proba-label">Probabilite</div>';
    html += '<div class="duerp-proba-num" id="' + prefix + '-proba-num">?</div>';
    html += '<div id="' + prefix + '-proba-text" style="font-size:0.75rem; color:#64748b;">Choisissez exposition + declencheur</div>';
    html += '</div>';
    // Priorite display
    html += '<div class="duerp-prio-display empty" id="' + prefix + '-prio-display">En attente...</div>';
    return html;
}

// --- renderDuerpLigne ---
function renderDuerpLigne(zone, c) {
    var html = '';

    // Header
    html += '<div class="duerp-header">';
    html += '<div class="duerp-header-title">üìã DOCUMENT UNIQUE ‚Äî Ligne de risque</div>';
    html += '<div class="duerp-header-sub">' + (c.titre || '') + '</div>';
    html += '</div>';

    html += '<div style="padding: 16px;">';

    // Unite de travail
    html += '<div class="duerp-unite">üè¢ ' + (c.unite_travail || '') + '</div>';

    // Situation
    html += '<div class="duerp-situation">';
    html += '<div class="duerp-situation-label">üìã Situation professionnelle</div>';
    html += '<div>' + (c.situation || '') + '</div>';
    html += '</div>';

    // Section DANGER
    var dangers = shuffleArray(c.choix.danger);
    html += '<div class="duerp-section">';
    html += '<div class="duerp-section-title danger">‚ö†Ô∏è Identifier le danger</div>';
    html += '<div class="duerp-section-body">';
    html += '<div class="duerp-qcm-choices">';
    dangers.forEach(function(d) {
        html += '<div class="duerp-qcm-choice" data-group="duerp-danger" data-val="' + d.replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'duerp-danger\')">' + d + '</div>';
    });
    html += '</div></div></div>';

    // Section DOMMAGE
    var dommages = shuffleArray(c.choix.dommage);
    html += '<div class="duerp-section">';
    html += '<div class="duerp-section-title dommage">ü©π Identifier le dommage</div>';
    html += '<div class="duerp-section-body">';
    html += '<div class="duerp-qcm-choices">';
    dommages.forEach(function(d) {
        html += '<div class="duerp-qcm-choice" data-group="duerp-dommage" data-val="' + d.replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'duerp-dommage\')">' + d + '</div>';
    });
    html += '</div></div></div>';

    // Section ESTIMATION
    html += '<div class="duerp-section">';
    html += '<div class="duerp-section-title estimation">üìä Estimer le risque</div>';
    html += '<div class="duerp-section-body">';
    html += buildDuerpEstimationHTML('duerp');
    html += '</div></div>';

    // Section MESURE (optional)
    if (c.choix && c.choix.mesure_principale) {
        var mesures = shuffleArray(c.choix.mesure_principale);
        html += '<div class="duerp-section">';
        html += '<div class="duerp-section-title mesure">üõ°Ô∏è Mesure de prevention principale</div>';
        html += '<div class="duerp-section-body">';
        html += '<div class="duerp-qcm-choices">';
        mesures.forEach(function(m) {
            html += '<div class="duerp-qcm-choice" data-group="duerp-mesure" data-val="' + m.replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'duerp-mesure\')">' + m + '</div>';
        });
        html += '</div></div></div>';
    }

    // Feedback zone
    html += '<div class="duerp-feedback" id="duerp-feedback"></div>';

    html += '</div>';
    zone.innerHTML = html;
}

// --- renderDuerpMini ---
function renderDuerpMini(zone, c) {
    var html = '';

    // Header
    html += '<div class="duerp-header">';
    html += '<div class="duerp-header-title">üìã DOCUMENT UNIQUE ‚Äî Mini DUERP</div>';
    html += '<div class="duerp-header-sub">' + (c.titre || '') + ' ‚Äî ' + (c.entreprise || '') + '</div>';
    html += '</div>';

    html += '<div style="padding: 16px;">';

    // 4 lignes
    c.lignes.forEach(function(ligne, idx) {
        var n = idx + 1;
        var prefix = 'duerp-L' + n;

        if (idx > 0) {
            html += '<hr class="duerp-row-separator">';
        }

        html += '<div class="duerp-mini-ligne" data-ligne="' + n + '">';

        // Unite
        html += '<div class="duerp-unite">üè¢ Ligne ' + n + ' ‚Äî ' + (ligne.unite_travail || '') + '</div>';

        // Situation
        html += '<div class="duerp-situation">';
        html += '<div class="duerp-situation-label">üìã Situation</div>';
        html += '<div>' + (ligne.situation || '') + '</div>';
        html += '</div>';

        // Danger QCM
        var dangers = shuffleArray(ligne.choix.danger);
        html += '<div class="duerp-section">';
        html += '<div class="duerp-section-title danger">‚ö†Ô∏è Danger</div>';
        html += '<div class="duerp-section-body">';
        html += '<div class="duerp-qcm-choices">';
        dangers.forEach(function(d) {
            html += '<div class="duerp-qcm-choice" data-group="' + prefix + '-danger" data-val="' + d.replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'' + prefix + '-danger\')">' + d + '</div>';
        });
        html += '</div></div></div>';

        // Dommage QCM
        var dommages = shuffleArray(ligne.choix.dommage);
        html += '<div class="duerp-section">';
        html += '<div class="duerp-section-title dommage">ü©π Dommage</div>';
        html += '<div class="duerp-section-body">';
        html += '<div class="duerp-qcm-choices">';
        dommages.forEach(function(d) {
            html += '<div class="duerp-qcm-choice" data-group="' + prefix + '-dommage" data-val="' + d.replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'' + prefix + '-dommage\')">' + d + '</div>';
        });
        html += '</div></div></div>';

        // Estimation
        html += '<div class="duerp-section">';
        html += '<div class="duerp-section-title estimation">üìä Estimation</div>';
        html += '<div class="duerp-section-body">';
        html += buildDuerpEstimationHTML(prefix);
        html += '</div></div>';

        html += '</div>';
    });

    // Mission finale
    html += '<div class="duerp-mission" id="duerp-mission">';
    html += '<div class="duerp-mission-title">üéØ Mission finale</div>';
    html += '<div class="duerp-mission-consigne">' + (c.mission_finale ? c.mission_finale.consigne : 'Cochez les lignes dont le risque est PRIORITAIRE selon vos estimations.') + '</div>';

    c.lignes.forEach(function(ligne, idx) {
        var n = idx + 1;
        html += '<div class="duerp-mission-row" data-mission-ligne="' + n + '" onclick="toggleDuerpMission(this)">';
        html += '<div class="duerp-mission-cb"></div>';
        html += '<div class="duerp-mission-info"><strong>Ligne ' + n + '</strong> ‚Äî ' + (ligne.unite_travail || '') + '</div>';
        html += '</div>';
    });

    html += '</div>';

    // Feedback
    html += '<div class="duerp-feedback" id="duerp-feedback"></div>';

    html += '</div>';
    zone.innerHTML = html;
}

// =====================================================================
// QCM CLASSIQUE RENDERER
// =====================================================================
function renderQcmClassique(zone, c) {
    const choix = [...(c.choix || [])];
    // Shuffle choices
    for (let i = choix.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [choix[i], choix[j]] = [choix[j], choix[i]]; }
    let html = '<div class="qcm-c-question">' + (c.question || '') + '</div>';
    if (c.multiple) html += '<div class="qcm-c-multi-hint">Plusieurs reponses possibles ‚Äî cochez toutes les bonnes reponses</div>';
    html += '<div class="qcm-c-choices">';
    choix.forEach(ch => {
        html += '<div class="qcm-c-choice" data-id="' + ch.id + '" onclick="selectQcmC(this, ' + !!c.multiple + ')">' + ch.texte + '</div>';
    });
    html += '</div>';
    if (c.explication) html += '<div class="qcm-c-explication" style="display:none;" id="qcmc-explication">' + c.explication + '</div>';
    zone.innerHTML = html;
}
function selectQcmC(el, isMultiple) {
    if (corrected) return;
    if (isMultiple) {
        el.classList.toggle('selected');
    } else {
        el.parentElement.querySelectorAll('.qcm-c-choice').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }
}

// =====================================================================
// QUIZ CHRONO RENDERER
// =====================================================================
let chronoState = null;
function renderQuizChrono(zone, c) {
    const questions = c.questions || [];
    // Shuffle choices per question
    questions.forEach(q => {
        const ch = [...(q.choix || [])];
        for (let i = ch.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [ch[i], ch[j]] = [ch[j], ch[i]]; }
        q._shuffled = ch;
    });
    chronoState = { questions, temps: c.temps_par_question || 15, current: 0, score: 0, answers: [], timer: null, startTime: 0 };
    let html = '<div class="chrono-container">';
    html += '<div class="chrono-progress" id="chrono-progress">';
    questions.forEach((_, i) => { html += '<div class="chrono-dot" id="chrono-dot-' + i + '"></div>'; });
    html += '</div>';
    html += '<div class="chrono-timer-bar"><div class="chrono-timer-fill" id="chrono-timer-fill"></div></div>';
    html += '<div class="chrono-counter" id="chrono-counter"></div>';
    html += '<div class="chrono-question-text" id="chrono-question"></div>';
    html += '<div class="chrono-choices" id="chrono-choices"></div>';
    html += '</div>';
    zone.innerHTML = html;
    showChronoQuestion(0);
}
function showChronoQuestion(idx) {
    const s = chronoState;
    if (idx >= s.questions.length) { finishChrono(); return; }
    s.current = idx;
    const q = s.questions[idx];
    document.getElementById('chrono-counter').textContent = 'Question ' + (idx + 1) + ' / ' + s.questions.length;
    document.getElementById('chrono-question').textContent = q.question;
    // Progress dots
    s.questions.forEach((_, i) => {
        const dot = document.getElementById('chrono-dot-' + i);
        dot.className = 'chrono-dot';
        if (i < idx) dot.classList.add(s.answers[i] ? 'done-ok' : 'done-ko');
        else if (i === idx) dot.classList.add('current');
    });
    // Choices
    let choicesHtml = '';
    q._shuffled.forEach(ch => {
        choicesHtml += '<div class="chrono-choice" data-id="' + ch.id + '" onclick="answerChrono(\'' + ch.id + '\')">' + ch.texte + '</div>';
    });
    document.getElementById('chrono-choices').innerHTML = choicesHtml;
    // Timer
    s.startTime = Date.now();
    const fill = document.getElementById('chrono-timer-fill');
    fill.style.width = '100%';
    fill.classList.remove('danger');
    if (s.timer) clearInterval(s.timer);
    s.timer = setInterval(function() {
        const elapsed = (Date.now() - s.startTime) / 1000;
        const remaining = Math.max(0, s.temps - elapsed);
        const pct = (remaining / s.temps) * 100;
        fill.style.width = pct + '%';
        if (remaining < 3) fill.classList.add('danger');
        if (remaining <= 0) {
            clearInterval(s.timer);
            s.answers.push(false);
            // Show correct answer briefly
            const correctId = s.questions[s.current].reponse;
            document.querySelectorAll('.chrono-choice').forEach(el => {
                el.style.pointerEvents = 'none';
                if (el.dataset.id === correctId) el.classList.add('show-correct');
            });
            setTimeout(() => showChronoQuestion(s.current + 1), 800);
        }
    }, 250);
}
function answerChrono(chosenId) {
    const s = chronoState;
    if (s.timer) clearInterval(s.timer);
    const q = s.questions[s.current];
    const isCorrect = chosenId === q.reponse;
    s.answers.push(isCorrect);
    if (isCorrect) s.score++;
    // Visual feedback
    document.querySelectorAll('.chrono-choice').forEach(el => {
        el.style.pointerEvents = 'none';
        if (el.dataset.id === chosenId) el.classList.add(isCorrect ? 'selected-ok' : 'selected-ko');
        if (el.dataset.id === q.reponse && !isCorrect) el.classList.add('show-correct');
    });
    setTimeout(() => showChronoQuestion(s.current + 1), 800);
}
function finishChrono() {
    const s = chronoState;
    if (s.timer) clearInterval(s.timer);
    // Update last dot
    const lastIdx = s.questions.length - 1;
    const lastDot = document.getElementById('chrono-dot-' + lastIdx);
    if (lastDot) { lastDot.className = 'chrono-dot ' + (s.answers[lastIdx] ? 'done-ok' : 'done-ko'); }
    const details = s.questions.map((q, i) => ({
        label: q.question.substring(0, 60),
        ok: s.answers[i] || false
    }));
    showResults(s.score, s.questions.length, details);
}

// =====================================================================
// CATEGORISER RENDERER
// =====================================================================
let catState = null;
function renderCategoriser(zone, c) {
    const items = [...(c.items || [])];
    // Shuffle items
    for (let i = items.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [items[i], items[j]] = [items[j], items[i]]; }
    catState = { selectedItem: null, placements: {}, items: c.items || [], categories: c.categories || [] };
    let html = '';
    if (c.consigne) html += '<div class="cat-consigne">' + c.consigne + '</div>';
    html += '<div class="cat-pool" id="cat-pool">';
    items.forEach(it => {
        html += '<div class="cat-item" data-id="' + it.id + '" onclick="selectCatItem(this)">' + it.label + '</div>';
    });
    html += '</div>';
    html += '<div class="cat-zones" id="cat-zones">';
    (c.categories || []).forEach(cat => {
        html += '<div class="cat-zone" data-cat="' + cat + '" onclick="placeCatItem(this)">';
        html += '<div class="cat-zone-title">' + cat + '</div>';
        html += '<div class="cat-zone-items"></div>';
        html += '</div>';
    });
    html += '</div>';
    zone.innerHTML = html;
}
function selectCatItem(el) {
    if (corrected) return;
    const pool = document.getElementById('cat-pool');
    pool.querySelectorAll('.cat-item').forEach(i => i.classList.remove('selected'));
    el.classList.add('selected');
    catState.selectedItem = el.dataset.id;
    // Highlight zones
    document.querySelectorAll('.cat-zone').forEach(z => z.classList.add('highlight'));
}
function placeCatItem(zoneEl) {
    if (corrected || !catState.selectedItem) return;
    const itemId = catState.selectedItem;
    const category = zoneEl.dataset.cat;
    const item = catState.items.find(i => i.id === itemId);
    if (!item) return;
    // Place item
    catState.placements[itemId] = category;
    const itemsContainer = zoneEl.querySelector('.cat-zone-items');
    const placed = document.createElement('div');
    placed.className = 'cat-placed';
    placed.dataset.id = itemId;
    placed.textContent = item.label;
    placed.onclick = function(e) {
        e.stopPropagation();
        if (corrected) return;
        // Remove from zone, restore to pool
        delete catState.placements[itemId];
        placed.remove();
        const poolItem = document.querySelector('.cat-pool .cat-item[data-id="' + itemId + '"]');
        if (poolItem) { poolItem.classList.remove('placed'); }
    };
    itemsContainer.appendChild(placed);
    // Mark pool item as placed
    const poolItem = document.querySelector('.cat-pool .cat-item[data-id="' + itemId + '"]');
    if (poolItem) { poolItem.classList.remove('selected'); poolItem.classList.add('placed'); }
    catState.selectedItem = null;
    document.querySelectorAll('.cat-zone').forEach(z => z.classList.remove('highlight'));
}

// =====================================================================
// MEMORY RENDERER
// =====================================================================
let memState = null;
function renderMemory(zone, c) {
    const cartes = c.cartes || [];
    // Create 2 cards per pair (one for face a, one for face b)
    const cards = [];
    cartes.forEach(p => {
        cards.push({ pairId: p.id, text: p.a, cardId: p.id + '_a' });
        cards.push({ pairId: p.id, text: p.b, cardId: p.id + '_b' });
    });
    // Shuffle
    for (let i = cards.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [cards[i], cards[j]] = [cards[j], cards[i]]; }
    memState = { cards, flipped: [], matched: new Set(), attempts: 0, nbPairs: cartes.length, busy: false };
    let html = '<div class="mem-board" id="mem-board">';
    cards.forEach((card, i) => {
        // Auto-resize text
        const len = card.text.length;
        const fontSize = len > 30 ? '0.65rem' : len > 20 ? '0.75rem' : '0.85rem';
        html += '<div class="mem-card" data-idx="' + i + '" onclick="flipMemCard(this)">';
        html += '<div class="mem-back">?</div>';
        html += '<div class="mem-face" style="font-size:' + fontSize + ';">' + card.text + '</div>';
        html += '</div>';
    });
    html += '</div>';
    html += '<div class="mem-attempts" id="mem-attempts">Tentatives : 0</div>';
    zone.innerHTML = html;
}
function flipMemCard(el) {
    const s = memState;
    if (s.busy || corrected) return;
    const idx = parseInt(el.dataset.idx);
    if (el.classList.contains('flipped') || el.classList.contains('matched')) return;
    el.classList.add('flipped');
    s.flipped.push(idx);
    if (s.flipped.length === 2) {
        s.attempts++;
        document.getElementById('mem-attempts').textContent = 'Tentatives : ' + s.attempts;
        const [i1, i2] = s.flipped;
        const c1 = s.cards[i1], c2 = s.cards[i2];
        if (c1.pairId === c2.pairId) {
            // Match!
            s.matched.add(c1.pairId);
            document.querySelector('.mem-card[data-idx="' + i1 + '"]').classList.add('matched');
            document.querySelector('.mem-card[data-idx="' + i2 + '"]').classList.add('matched');
            s.flipped = [];
            if (s.matched.size === s.nbPairs) {
                setTimeout(finishMemory, 500);
            }
        } else {
            // No match ‚Äî flip back after 1s
            s.busy = true;
            setTimeout(function() {
                document.querySelector('.mem-card[data-idx="' + i1 + '"]').classList.remove('flipped');
                document.querySelector('.mem-card[data-idx="' + i2 + '"]').classList.remove('flipped');
                s.flipped = [];
                s.busy = false;
            }, 1000);
        }
    }
}
function finishMemory() {
    const s = memState;
    const erreurs = Math.max(0, s.attempts - s.nbPairs);
    const penalite = Math.floor(erreurs / 2);
    const score = Math.max(0, s.nbPairs - penalite);
    const details = [{ label: s.nbPairs + ' paires trouvees en ' + s.attempts + ' tentatives', ok: erreurs === 0 }];
    showResults(score, s.nbPairs, details);
}

// =====================================================================
// SCENARIO RENDERER
// =====================================================================
let scenState = null;
function renderScenario(zone, c) {
    const etapes = c.etapes || [];
    scenState = { etapes, history: [], score: 0, totalChoices: 0, steps: 0, maxSteps: 30 };
    let html = '<div class="scen-container">';
    html += '<div class="scen-progress" id="scen-progress"></div>';
    html += '<div class="scen-texte" id="scen-texte"></div>';
    html += '<div class="scen-choices" id="scen-choices"></div>';
    html += '<div class="scen-feedback" id="scen-feedback" style="display:none;"></div>';
    html += '</div>';
    zone.innerHTML = html;
    showScenEtape('debut');
}
function showScenEtape(etapeId) {
    const s = scenState;
    s.steps++;
    if (s.steps > s.maxSteps) {
        document.getElementById('scen-texte').textContent = 'Erreur : scenario en boucle (plus de 30 etapes parcourues).';
        document.getElementById('scen-choices').innerHTML = '';
        document.getElementById('scen-feedback').style.display = 'none';
        const details = s.history.map(h => ({ label: h.label, ok: h.correct }));
        showResults(s.score, s.totalChoices, details);
        return;
    }
    const etape = s.etapes.find(e => e.id === etapeId);
    if (!etape) {
        document.getElementById('scen-texte').textContent = 'Erreur : etape "' + etapeId + '" introuvable.';
        document.getElementById('scen-choices').innerHTML = '';
        return;
    }
    document.getElementById('scen-texte').innerHTML = etape.texte;
    document.getElementById('scen-feedback').style.display = 'none';
    // Update progress dots
    let dotsHtml = '';
    s.history.forEach(h => {
        dotsHtml += '<div class="scen-dot ' + (h.correct ? 'done-ok' : 'done-ko') + '"></div>';
    });
    dotsHtml += '<div class="scen-dot current"></div>';
    document.getElementById('scen-progress').innerHTML = dotsHtml;
    // Choices or end
    if (!etape.choix || etape.choix.length === 0) {
        // Safety net: if this is a "bad" step with no choices, auto-inject a retry button
        if (etapeId.startsWith('bad') && s.history.length > 0) {
            // Find the step that led here (last correct step, or the step before the wrong choice)
            let retourId = 'debut';
            for (let i = s.history.length - 1; i >= 0; i--) {
                if (s.history[i].fromEtape) { retourId = s.history[i].fromEtape; break; }
            }
            // Fallback: find which step points to this bad step
            if (retourId === 'debut') {
                for (const et of s.etapes) {
                    if (et.choix && et.choix.some(ch => ch.suite === etapeId)) {
                        retourId = et.id;
                        break;
                    }
                }
            }
            document.getElementById('scen-choices').innerHTML = '<div class="scen-choice" data-idx="0" data-etape="' + etapeId + '" onclick="showScenEtape(\'' + retourId + '\')">\u21a9 Reessayer</div>';
            return;
        }
        // Real end of scenario
        document.getElementById('scen-choices').innerHTML = '<div class="scen-end"><h3>Fin du scenario</h3><p>' + etape.texte + '</p></div>';
        document.getElementById('scen-texte').style.display = 'none';
        const details = s.history.map(h => ({ label: h.label, ok: h.correct }));
        finishScenario(details);
        return;
    }
    let choicesHtml = '';
    etape.choix.forEach((ch, i) => {
        choicesHtml += '<div class="scen-choice" data-idx="' + i + '" data-etape="' + etapeId + '" onclick="answerScenario(this)">' + ch.label + '</div>';
    });
    document.getElementById('scen-choices').innerHTML = choicesHtml;
}
function answerScenario(el) {
    const s = scenState;
    if (corrected) return;
    const etapeId = el.dataset.etape;
    const idx = parseInt(el.dataset.idx);
    const etape = s.etapes.find(e => e.id === etapeId);
    if (!etape) return;
    const choix = etape.choix[idx];
    if (!choix) return;
    s.totalChoices++;
    const isCorrect = !!choix.correct;
    if (isCorrect) s.score++;
    s.history.push({ label: choix.label.substring(0, 60), correct: isCorrect, fromEtape: etapeId });
    // Visual feedback
    el.classList.add(isCorrect ? 'selected-correct' : 'selected-wrong');
    document.querySelectorAll('.scen-choice').forEach(c => { c.style.pointerEvents = 'none'; });
    if (!isCorrect && choix.feedback) {
        document.getElementById('scen-feedback').textContent = choix.feedback;
        document.getElementById('scen-feedback').style.display = 'block';
    }
    setTimeout(() => {
        showScenEtape(choix.suite);
    }, isCorrect ? 600 : 2000);
}
function finishScenario(details) {
    const s = scenState;
    showResults(s.score, s.totalChoices, details);
}

// =====================================================================
// VALIDATION
// =====================================================================

function validateExercice() {
    if (!currentExo || corrected) return;
    corrected = true;
    const type = currentExo.type;
    let correct = 0, total = 0, details = [];

    if (type === 'texte_trous') {
        document.querySelectorAll('.tt-input').forEach(inp => {
            const expected = inp.dataset.answer;
            const given = inp.value.trim();
            total++;
            const ok = norm(given) === norm(expected);
            if (ok) { correct++; inp.classList.add('correct'); }
            else { inp.classList.add('wrong'); }
            inp.readOnly = true;
            details.push({ ok, label: expected, detail: ok ? 'Correct' : 'Reponse donnee : "' + given + '"' });
        });
    }

    else if (type === 'relier') {
        const pairs = relierState.pairs;
        total = relierState.correctPairs.length;
        pairs.forEach(p => {
            const ok = p.leftIdx === p.rightIdx;
            if (ok) correct++;
            details.push({ ok, label: p.leftText + ' ‚Üî ' + p.rightText, detail: ok ? 'Correct' : 'Mauvaise association' });
        });
        // Mark un-paired
        for (let i = pairs.length; i < total; i++) {
            details.push({ ok: false, label: relierState.correctPairs[i].gauche + ' ‚Üî ' + relierState.correctPairs[i].droite, detail: 'Non associe' });
        }
        // Color pair tags
        document.querySelectorAll('.relier-pair-tag').forEach((tag, i) => {
            tag.classList.add(pairs[i] && pairs[i].leftIdx === pairs[i].rightIdx ? 'correct' : 'wrong');
            tag.querySelector('.remove-pair').style.display = 'none';
        });
    }

    else if (type === 'ordre') {
        const list = document.getElementById('ordre-list');
        const items = [...list.children];
        total = items.length;
        items.forEach((item, i) => {
            const correctIdx = parseInt(item.dataset.correct);
            const ok = correctIdx === i;
            if (ok) { correct++; item.classList.add('correct'); }
            else item.classList.add('wrong');
            details.push({ ok, label: item.querySelector('.ordre-text').textContent, detail: ok ? 'Bonne position' : 'Position attendue : ' + (correctIdx + 1) });
        });
        // Disable arrows
        list.querySelectorAll('button').forEach(b => { b.disabled = true; b.style.opacity = '0.3'; });
    }

    else if (type === 'intrus') {
        document.querySelectorAll('.intrus-serie').forEach(serie => {
            const correctIntrus = parseInt(serie.dataset.intrus);
            const selected = serie.querySelector('.intrus-item.selected');
            const selectedIdx = selected ? parseInt(selected.dataset.itemIdx) : -1;
            total++;
            const ok = selectedIdx === correctIntrus;
            if (ok) correct++;
            // Show correct/wrong
            serie.querySelectorAll('.intrus-item').forEach(it => {
                const idx = parseInt(it.dataset.itemIdx);
                if (idx === correctIntrus) it.classList.add('correct');
                else if (it.classList.contains('selected') && !ok) it.classList.add('wrong');
            });
            serie.querySelector('.intrus-explication').style.display = '';
            const items = [...serie.querySelectorAll('.intrus-item')].map(it => it.textContent);
            details.push({ ok, label: 'Serie : ' + items.join(', '), detail: ok ? 'Correct' : 'L\'intrus etait : ' + (items[correctIntrus] || '?') });
        });
    }

    else if (type === 'mots_croises') {
        document.querySelectorAll('#mc-grid input').forEach(inp => {
            const expected = inp.dataset.answer;
            const given = inp.value.trim().toUpperCase();
            total++;
            const ok = given === expected;
            if (ok) { correct++; inp.closest('td').classList.add('correct'); }
            else inp.closest('td').classList.add('wrong');
            inp.readOnly = true;
        });
        details.push({ ok: correct === total, label: correct + '/' + total + ' lettres correctes', detail: '' });
    }

    else if (type === 'qcm_image') {
        document.querySelectorAll('.qcm-img-q').forEach(qBlock => {
            const correctIdx = parseInt(qBlock.dataset.correct);
            const qi = qBlock.dataset.qi;
            const selected = qBlock.querySelector('.qcm-img-choice.selected');
            const selectedIdx = selected ? parseInt(selected.dataset.ci) : -1;
            total++;
            const ok = selectedIdx === correctIdx;
            if (ok) correct++;
            qBlock.querySelectorAll('.qcm-img-choice').forEach(ch => {
                const ci = parseInt(ch.dataset.ci);
                if (ci === correctIdx) ch.classList.add('correct');
                else if (ch.classList.contains('selected') && !ok) ch.classList.add('wrong');
            });
            const expl = document.getElementById('qcm-expl-' + qi);
            if (expl) expl.style.display = '';
            details.push({ ok, label: qBlock.querySelector('.q-text').textContent, detail: ok ? 'Correct' : (expl ? expl.textContent : '') });
        });
    }

    else if (type === 'tableau') {
        document.querySelectorAll('.tableau-zone input').forEach(inp => {
            const expected = inp.dataset.answer;
            const given = inp.value.trim();
            total++;
            const ok = norm(given) === norm(expected);
            if (ok) { correct++; inp.closest('td').classList.add('correct'); }
            else inp.closest('td').classList.add('wrong');
            inp.readOnly = true;
            details.push({ ok, label: expected, detail: ok ? 'Correct' : 'Reponse : "' + given + '"' });
        });
    }

    else if (type === 'etude_cas') {
        document.querySelectorAll('.ec-question').forEach(qBlock => {
            const qi = qBlock.dataset.qi;
            const qType = qBlock.dataset.type;
            total++;
            if (qType === 'qcm') {
                const correctIdx = parseInt(qBlock.querySelector('.ec-qcm-choice').dataset.correct);
                const selected = qBlock.querySelector('.ec-qcm-choice.selected');
                const selectedIdx = selected ? parseInt(selected.dataset.ci) : -1;
                const ok = selectedIdx === correctIdx;
                if (ok) correct++;
                qBlock.querySelectorAll('.ec-qcm-choice').forEach(ch => {
                    const ci = parseInt(ch.dataset.ci);
                    if (ci === correctIdx) ch.classList.add('correct');
                    else if (ch.classList.contains('selected') && !ok) ch.classList.add('wrong');
                });
                details.push({ ok, label: qBlock.querySelector('.ec-q-text').textContent, detail: ok ? 'Correct' : '' });
            } else {
                // Texte libre ‚Äî show expected
                const expEl = document.getElementById('ec-exp-' + qi);
                if (expEl) expEl.style.display = '';
                const textarea = qBlock.querySelector('.ec-text-input');
                const hasAnswer = textarea && textarea.value.trim().length > 0;
                if (hasAnswer) correct++;
                details.push({ ok: hasAnswer, label: qBlock.querySelector('.ec-q-text').textContent, detail: hasAnswer ? 'Reponse fournie (verifiez avec la correction)' : 'Aucune reponse' });
            }
        });
    }

    else if (type === 'pad') {
        const c = currentExo.contenu;
        // 4 PAD steps only ‚Äî score /4
        const steps = [
            { id: 'danger', label: 'Danger', answer: c.danger },
            { id: 'sitdang', label: 'Situation dangereuse', answer: c.situation_dangereuse },
            { id: 'event', label: 'Evenement declencheur', answer: c.evenement_declencheur },
            { id: 'dommage', label: 'Dommage', answer: c.dommage }
        ];
        steps.forEach(step => {
            const sel = document.getElementById('pad-sel-' + step.id);
            const stepEl = document.getElementById('pad-step-' + step.id);
            const given = sel ? sel.value : '';
            total++;
            const ok = given === step.answer;
            if (ok) { correct++; stepEl.classList.add('correct'); }
            else {
                stepEl.classList.add('wrong');
                const corr = stepEl.querySelector('.pad-correction');
                if (corr) { corr.textContent = '‚úì ' + step.answer; corr.style.display = ''; }
            }
            if (sel) sel.disabled = true;
            details.push({ ok, label: step.label, detail: ok ? 'Correct' : 'Reponse : "' + given + '"' });
        });
    }

    else if (type === 'prevention') {
        const c = currentExo.contenu;
        const niveaux = c.niveaux || [];
        niveaux.forEach(n => {
            const sel = document.getElementById('prev-sel-' + n.niveau);
            const levelEl = document.getElementById('prev-level-' + n.niveau);
            const given = sel ? sel.value : '';
            total++;
            const ok = given === n.bonne_reponse;
            if (ok) { correct++; levelEl.classList.add('correct'); }
            else {
                levelEl.classList.add('wrong');
                const corr = levelEl.querySelector('.prev-correction');
                if (corr) { corr.textContent = '‚úì ' + n.bonne_reponse; corr.style.display = ''; }
            }
            if (sel) sel.disabled = true;
            details.push({ ok, label: n.label, detail: ok ? 'Correct' : 'Reponse : "' + given + '"' });
        });
    }

    // === ESTIMATION DU RISQUE ===
    else if (type === 'estimation_risque') {
        const c = currentExo.contenu;
        const probaAttendue = calcProba(c.exposition, c.declencheur);
        const feedbackMsgs = [];

        // 1. Gravite (1 pt)
        const gravSel = document.getElementById('est-sel-gravite');
        const gravStep = document.getElementById('est-step-gravite');
        const gravGiven = parseInt(gravSel.value) || 0;
        const gravOk = gravGiven === c.gravite;
        total++;
        if (gravOk) { correct++; gravStep.classList.add('correct'); }
        else {
            gravStep.classList.add('wrong');
            const corr = document.getElementById('est-corr-gravite');
            corr.textContent = '‚úì ' + c.gravite + ' ‚Äî ' + GRAVITE_LABELS[c.gravite];
            corr.style.display = '';
        }
        gravSel.disabled = true;
        details.push({ ok: gravOk, label: 'Gravite', detail: gravOk ? 'Correct' : 'Attendu : ' + c.gravite });

        // 2. Exposition (1 pt)
        const expoSel = document.getElementById('est-sel-exposition');
        const expoStep = document.getElementById('est-step-exposition');
        const expoOk = expoSel.value === c.exposition;
        total++;
        if (expoOk) { correct++; expoStep.classList.add('correct'); }
        else {
            expoStep.classList.add('wrong');
            const corr = document.getElementById('est-corr-exposition');
            corr.textContent = '‚úì ' + (c.exposition === 'rare_courte' ? 'Rare et/ou courte duree' : 'Frequente et/ou longue duree');
            corr.style.display = '';
            feedbackMsgs.push('‚ö†Ô∏è Revoir la frequence/duree d\'exposition dans la situation');
        }
        expoSel.disabled = true;
        details.push({ ok: expoOk, label: 'Exposition', detail: expoOk ? 'Correct' : 'Attendu : ' + c.exposition });

        // 3. Declencheur (1 pt)
        const declSel = document.getElementById('est-sel-declencheur');
        const declStep = document.getElementById('est-step-declencheur');
        const declOk = declSel.value === c.declencheur;
        total++;
        if (declOk) { correct++; declStep.classList.add('correct'); }
        else {
            declStep.classList.add('wrong');
            const corr = document.getElementById('est-corr-declencheur');
            corr.textContent = '‚úì ' + (c.declencheur === 'faible' ? 'Faible' : 'Elevee');
            corr.style.display = '';
            feedbackMsgs.push('‚ö†Ô∏è Revoir la probabilite de l\'evenement declencheur');
        }
        declSel.disabled = true;
        details.push({ ok: declOk, label: 'Declencheur', detail: declOk ? 'Correct' : 'Attendu : ' + c.declencheur });

        // Show correct probability
        var probaDisplay = document.getElementById('est-proba-display');
        var probaNum = document.getElementById('est-proba-num');
        var probaText = document.getElementById('est-proba-text');
        probaNum.textContent = probaAttendue;
        probaText.textContent = PROBA_LABELS[probaAttendue] + (expoOk && declOk ? ' ‚úÖ' : ' (corrige)');
        probaDisplay.classList.add('visible');

        // 4. Matrice (1 pt)
        const bonneCase = 'est-cell-' + c.gravite + '-' + probaAttendue;
        const caseSelectionnee = document.querySelector('.est-matrix-cell.selected');
        const matriceOk = caseSelectionnee && caseSelectionnee.id === bonneCase;
        total++;
        if (matriceOk) { correct++; caseSelectionnee.classList.add('correct-cell'); }
        else {
            if (caseSelectionnee) caseSelectionnee.classList.add('wrong-cell');
            document.getElementById(bonneCase).classList.add('show-correct');
        }
        document.querySelectorAll('.est-matrix-cell').forEach(function(c) { c.onclick = null; c.style.cursor = 'default'; });
        details.push({ ok: matriceOk, label: 'Case matrice', detail: matriceOk ? 'Correct' : 'Mauvaise case' });

        // 5. Priorite (1 pt)
        const prioVal = document.getElementById('est-priorite-val').value;
        const prioOk = prioVal === c.priorite;
        total++;
        if (prioOk) {
            correct++;
            var prioBtn = document.getElementById('est-prio-' + prioVal);
            if (prioBtn) prioBtn.classList.add('correct-prio');
        } else {
            var wrongBtn = document.getElementById('est-prio-' + prioVal);
            if (wrongBtn) wrongBtn.classList.add('wrong-prio');
            var correctBtn = document.getElementById('est-prio-' + c.priorite);
            if (correctBtn) correctBtn.classList.add('correct-prio');
        }
        document.querySelectorAll('.est-prio-btn').forEach(function(b) { b.onclick = null; b.style.cursor = 'default'; });
        details.push({ ok: prioOk, label: 'Priorite', detail: prioOk ? 'Correct' : 'Attendu : ' + c.priorite });

        // Feedback intelligent
        if (feedbackMsgs.length > 0 || !matriceOk || !prioOk) {
            var fb = document.getElementById('est-feedback');
            var msgs = [];
            if (feedbackMsgs.length > 0) msgs = msgs.concat(feedbackMsgs);
            if (!expoOk && !declOk) {
                msgs = ['‚ö†Ô∏è L\'exposition ET le declencheur sont mal evalues ‚Üí la probabilite est fausse'];
            }
            msgs.push('üìå Rappel : Probabilite = Exposition √ó Declencheur');
            msgs.push('üìå La probabilite ne se devine pas, elle se deduit des indices dans la situation');
            fb.innerHTML = msgs.join('<br>');
            fb.classList.add('visible');
        }
    }

    // === DUERP LIGNE ===
    else if (type === 'duerp_ligne') {
        const c = currentExo.contenu;
        const att = c.attendus;
        const feedbackMsgs = [];

        // 1. Danger (1 pt)
        total++;
        const dangerSel = document.querySelector('.duerp-qcm-choice[data-group="duerp-danger"].selected');
        const dangerVal = dangerSel ? dangerSel.getAttribute('data-val') : '';
        const dangerOk = dangerVal === att.danger;
        if (dangerOk) correct++;
        document.querySelectorAll('.duerp-qcm-choice[data-group="duerp-danger"]').forEach(function(el) {
            el.onclick = null; el.style.cursor = 'default';
            if (el.getAttribute('data-val') === att.danger) el.classList.add(dangerOk ? 'correct' : 'show-correct');
            else if (el.classList.contains('selected')) el.classList.add('wrong');
        });
        if (!dangerOk) feedbackMsgs.push('‚ö†Ô∏è Le danger identifie n\'est pas le bon. Relisez la situation pour reperer la source du risque.');
        details.push({ ok: dangerOk, label: 'Danger', detail: dangerOk ? 'Correct' : 'Attendu : ' + att.danger });

        // 2. Dommage (1 pt)
        total++;
        const dommageSel = document.querySelector('.duerp-qcm-choice[data-group="duerp-dommage"].selected');
        const dommageVal = dommageSel ? dommageSel.getAttribute('data-val') : '';
        const dommageOk = dommageVal === att.dommage;
        if (dommageOk) correct++;
        document.querySelectorAll('.duerp-qcm-choice[data-group="duerp-dommage"]').forEach(function(el) {
            el.onclick = null; el.style.cursor = 'default';
            if (el.getAttribute('data-val') === att.dommage) el.classList.add(dommageOk ? 'correct' : 'show-correct');
            else if (el.classList.contains('selected')) el.classList.add('wrong');
        });
        if (!dommageOk) feedbackMsgs.push('‚ö†Ô∏è Le dommage n\'est pas le bon. Quel prejudice physique ou psychique peut subir le salarie ?');
        details.push({ ok: dommageOk, label: 'Dommage', detail: dommageOk ? 'Correct' : 'Attendu : ' + att.dommage });

        // 3. Gravite (1 pt)
        total++;
        const gravSel = document.getElementById('duerp-sel-gravite');
        const gravGiven = parseInt(gravSel.value) || 0;
        const gravOk = gravGiven === att.gravite;
        if (gravOk) { correct++; gravSel.classList.add('correct'); }
        else {
            gravSel.classList.add('wrong');
            var corrG = document.getElementById('duerp-corr-gravite');
            corrG.textContent = '‚úì ' + att.gravite + ' ‚Äî ' + GRAVITE_LABELS[att.gravite];
            corrG.style.display = '';
        }
        gravSel.disabled = true;
        details.push({ ok: gravOk, label: 'Gravite', detail: gravOk ? 'Correct' : 'Attendu : ' + att.gravite });

        // 4. Exposition (1 pt)
        total++;
        const expoVal = document.getElementById('duerp-expo-val').value;
        const expoOk = expoVal === att.exposition;
        if (expoOk) correct++;
        document.querySelectorAll('.duerp-est-btn[data-field="duerp-expo"]').forEach(function(b) {
            b.onclick = null; b.style.cursor = 'default';
            if (b.getAttribute('data-val') === att.exposition) b.classList.add(expoOk ? 'correct' : 'show-correct');
            else if (b.classList.contains('active')) b.classList.add('wrong');
        });
        if (!expoOk) feedbackMsgs.push('‚ö†Ô∏è Revoir la frequence/duree d\'exposition dans la situation');
        var corrE = document.getElementById('duerp-corr-expo');
        if (!expoOk) { corrE.textContent = '‚úì ' + (att.exposition === 'rare_courte' ? 'Rare / courte' : 'Frequente / longue'); corrE.style.display = ''; }
        details.push({ ok: expoOk, label: 'Exposition', detail: expoOk ? 'Correct' : 'Attendu : ' + att.exposition });

        // 5. Declencheur (1 pt)
        total++;
        const declVal = document.getElementById('duerp-decl-val').value;
        const declOk = declVal === att.declencheur;
        if (declOk) correct++;
        document.querySelectorAll('.duerp-est-btn[data-field="duerp-decl"]').forEach(function(b) {
            b.onclick = null; b.style.cursor = 'default';
            if (b.getAttribute('data-val') === att.declencheur) b.classList.add(declOk ? 'correct' : 'show-correct');
            else if (b.classList.contains('active')) b.classList.add('wrong');
        });
        if (!declOk) feedbackMsgs.push('‚ö†Ô∏è Revoir la probabilite de l\'evenement declencheur');
        var corrD = document.getElementById('duerp-corr-decl');
        if (!declOk) { corrD.textContent = '‚úì ' + (att.declencheur === 'faible' ? 'Faible' : 'Eleve'); corrD.style.display = ''; }
        details.push({ ok: declOk, label: 'Declencheur', detail: declOk ? 'Correct' : 'Attendu : ' + att.declencheur });

        // Show correct proba + prio
        const probaAttendue = calcProba(att.exposition, att.declencheur);
        var probaDiv = document.getElementById('duerp-proba-display');
        var probaNum = document.getElementById('duerp-proba-num');
        var probaText = document.getElementById('duerp-proba-text');
        probaNum.textContent = probaAttendue;
        probaText.textContent = PROBA_LABELS[probaAttendue] + (expoOk && declOk ? ' ‚úÖ' : ' (corrige)');
        probaDiv.classList.add('visible');
        var isPrio = (att.gravite + probaAttendue) >= 5;
        var prioDiv = document.getElementById('duerp-prio-display');
        prioDiv.textContent = isPrio ? 'üî¥ PRIORITAIRE' : 'üü¢ NON PRIORITAIRE';
        prioDiv.className = 'duerp-prio-display ' + (isPrio ? 'prioritaire' : 'non_prioritaire');

        // 6. Mesure (1 pt, if present)
        if (c.choix && c.choix.mesure_principale && att.mesure_principale) {
            total++;
            const mesureSel = document.querySelector('.duerp-qcm-choice[data-group="duerp-mesure"].selected');
            const mesureVal = mesureSel ? mesureSel.getAttribute('data-val') : '';
            const mesureOk = mesureVal === att.mesure_principale;
            if (mesureOk) correct++;
            document.querySelectorAll('.duerp-qcm-choice[data-group="duerp-mesure"]').forEach(function(el) {
                el.onclick = null; el.style.cursor = 'default';
                if (el.getAttribute('data-val') === att.mesure_principale) el.classList.add(mesureOk ? 'correct' : 'show-correct');
                else if (el.classList.contains('selected')) el.classList.add('wrong');
            });
            if (!mesureOk) feedbackMsgs.push('‚ö†Ô∏è La mesure de prevention choisie n\'est pas la plus adaptee');
            details.push({ ok: mesureOk, label: 'Mesure', detail: mesureOk ? 'Correct' : 'Attendu : ' + att.mesure_principale });
        }

        // Feedback
        if (feedbackMsgs.length > 0) {
            var fb = document.getElementById('duerp-feedback');
            if (!expoOk && !declOk) feedbackMsgs.push('üìå L\'exposition ET le declencheur sont mal evalues ‚Üí la probabilite est fausse');
            feedbackMsgs.push('üìå Rappel : Probabilite = Exposition √ó Declencheur');
            fb.innerHTML = feedbackMsgs.join('<br>');
            fb.classList.add('visible');
        }
    }

    // === DUERP MINI ===
    else if (type === 'duerp_mini') {
        const c = currentExo.contenu;
        const feedbackMsgs = [];

        // Score each line (5 pts each = 20 pts)
        c.lignes.forEach(function(ligne, idx) {
            var n = idx + 1;
            var prefix = 'duerp-L' + n;
            var att = ligne.attendus;

            // Danger (1 pt)
            total++;
            var dSel = document.querySelector('.duerp-qcm-choice[data-group="' + prefix + '-danger"].selected');
            var dVal = dSel ? dSel.getAttribute('data-val') : '';
            var dOk = dVal === att.danger;
            if (dOk) correct++;
            document.querySelectorAll('.duerp-qcm-choice[data-group="' + prefix + '-danger"]').forEach(function(el) {
                el.onclick = null; el.style.cursor = 'default';
                if (el.getAttribute('data-val') === att.danger) el.classList.add(dOk ? 'correct' : 'show-correct');
                else if (el.classList.contains('selected')) el.classList.add('wrong');
            });
            details.push({ ok: dOk, label: 'L' + n + ' Danger', detail: dOk ? 'Correct' : 'Attendu : ' + att.danger });

            // Dommage (1 pt)
            total++;
            var dmSel = document.querySelector('.duerp-qcm-choice[data-group="' + prefix + '-dommage"].selected');
            var dmVal = dmSel ? dmSel.getAttribute('data-val') : '';
            var dmOk = dmVal === att.dommage;
            if (dmOk) correct++;
            document.querySelectorAll('.duerp-qcm-choice[data-group="' + prefix + '-dommage"]').forEach(function(el) {
                el.onclick = null; el.style.cursor = 'default';
                if (el.getAttribute('data-val') === att.dommage) el.classList.add(dmOk ? 'correct' : 'show-correct');
                else if (el.classList.contains('selected')) el.classList.add('wrong');
            });
            details.push({ ok: dmOk, label: 'L' + n + ' Dommage', detail: dmOk ? 'Correct' : 'Attendu : ' + att.dommage });

            // Gravite (1 pt)
            total++;
            var gSel = document.getElementById(prefix + '-sel-gravite');
            var gVal = parseInt(gSel.value) || 0;
            var gOk = gVal === att.gravite;
            if (gOk) { correct++; gSel.classList.add('correct'); }
            else {
                gSel.classList.add('wrong');
                var cG = document.getElementById(prefix + '-corr-gravite');
                cG.textContent = '‚úì ' + att.gravite + ' ‚Äî ' + GRAVITE_LABELS[att.gravite];
                cG.style.display = '';
            }
            gSel.disabled = true;
            details.push({ ok: gOk, label: 'L' + n + ' Gravite', detail: gOk ? 'Correct' : 'Attendu : ' + att.gravite });

            // Exposition (1 pt)
            total++;
            var eVal = document.getElementById(prefix + '-expo-val').value;
            var eOk = eVal === att.exposition;
            if (eOk) correct++;
            document.querySelectorAll('.duerp-est-btn[data-field="' + prefix + '-expo"]').forEach(function(b) {
                b.onclick = null; b.style.cursor = 'default';
                if (b.getAttribute('data-val') === att.exposition) b.classList.add(eOk ? 'correct' : 'show-correct');
                else if (b.classList.contains('active')) b.classList.add('wrong');
            });
            var cE = document.getElementById(prefix + '-corr-expo');
            if (!eOk) { cE.textContent = '‚úì ' + (att.exposition === 'rare_courte' ? 'Rare / courte' : 'Frequente / longue'); cE.style.display = ''; }
            details.push({ ok: eOk, label: 'L' + n + ' Exposition', detail: eOk ? 'Correct' : 'Attendu : ' + att.exposition });

            // Declencheur (1 pt)
            total++;
            var dcVal = document.getElementById(prefix + '-decl-val').value;
            var dcOk = dcVal === att.declencheur;
            if (dcOk) correct++;
            document.querySelectorAll('.duerp-est-btn[data-field="' + prefix + '-decl"]').forEach(function(b) {
                b.onclick = null; b.style.cursor = 'default';
                if (b.getAttribute('data-val') === att.declencheur) b.classList.add(dcOk ? 'correct' : 'show-correct');
                else if (b.classList.contains('active')) b.classList.add('wrong');
            });
            var cD = document.getElementById(prefix + '-corr-decl');
            if (!dcOk) { cD.textContent = '‚úì ' + (att.declencheur === 'faible' ? 'Faible' : 'Eleve'); cD.style.display = ''; }
            details.push({ ok: dcOk, label: 'L' + n + ' Declencheur', detail: dcOk ? 'Correct' : 'Attendu : ' + att.declencheur });

            // Show correct proba + prio for this line
            var probaAtt = calcProba(att.exposition, att.declencheur);
            var pDiv = document.getElementById(prefix + '-proba-display');
            var pNum = document.getElementById(prefix + '-proba-num');
            var pText = document.getElementById(prefix + '-proba-text');
            pNum.textContent = probaAtt;
            pText.textContent = PROBA_LABELS[probaAtt] + (eOk && dcOk ? ' ‚úÖ' : ' (corrige)');
            pDiv.classList.add('visible');
            var linePrio = (att.gravite + probaAtt) >= 5;
            var lpDiv = document.getElementById(prefix + '-prio-display');
            lpDiv.textContent = linePrio ? 'üî¥ PRIORITAIRE' : 'üü¢ NON PRIORITAIRE';
            lpDiv.className = 'duerp-prio-display ' + (linePrio ? 'prioritaire' : 'non_prioritaire');
        });

        // Mission finale ‚Äî scored from ATTENDUS (not student answers)
        var nbPrio = c.mission_finale ? (c.mission_finale.nb_prioritaires || 0) : 0;
        // Calculate which lines are truly priority from attendus
        var lignePrioAttendue = [];
        c.lignes.forEach(function(ligne, idx) {
            var att = ligne.attendus;
            var probaAtt = calcProba(att.exposition, att.declencheur);
            lignePrioAttendue.push((att.gravite + probaAtt) >= 5);
        });

        // Score mission: 1 pt per correct selection, 0 otherwise, NO negative
        document.querySelectorAll('.duerp-mission-row').forEach(function(row) {
            var ligneIdx = parseInt(row.getAttribute('data-mission-ligne')) - 1;
            var isChecked = row.classList.contains('checked');
            var shouldBeChecked = lignePrioAttendue[ligneIdx];
            total++;
            row.onclick = null; row.style.cursor = 'default';
            if (isChecked === shouldBeChecked) {
                correct++;
                row.classList.add('correct');
                details.push({ ok: true, label: 'Mission L' + (ligneIdx + 1), detail: 'Correct' });
            } else {
                if (shouldBeChecked) {
                    row.classList.add('show-correct');
                    details.push({ ok: false, label: 'Mission L' + (ligneIdx + 1), detail: 'Devait etre coche (prioritaire)' });
                } else {
                    row.classList.add('wrong');
                    details.push({ ok: false, label: 'Mission L' + (ligneIdx + 1), detail: 'Ne devait pas etre coche (non prioritaire)' });
                }
            }
        });

        // Feedback
        var fb = document.getElementById('duerp-feedback');
        var nbLignesOk = 0;
        c.lignes.forEach(function(ligne, idx) {
            var att = ligne.attendus;
            var prefix = 'duerp-L' + (idx + 1);
            var dSel2 = document.querySelector('.duerp-qcm-choice[data-group="' + prefix + '-danger"].selected');
            var dmSel2 = document.querySelector('.duerp-qcm-choice[data-group="' + prefix + '-dommage"].selected');
            var gSel2 = document.getElementById(prefix + '-sel-gravite');
            var eVal2 = document.getElementById(prefix + '-expo-val').value;
            var dcVal2 = document.getElementById(prefix + '-decl-val').value;
            var allOk = (dSel2 && dSel2.getAttribute('data-val') === att.danger) &&
                        (dmSel2 && dmSel2.getAttribute('data-val') === att.dommage) &&
                        (parseInt(gSel2.value) === att.gravite) &&
                        (eVal2 === att.exposition) && (dcVal2 === att.declencheur);
            if (allOk) nbLignesOk++;
        });
        var msgs = [];
        if (nbLignesOk < c.lignes.length) {
            msgs.push('üìå ' + nbLignesOk + '/' + c.lignes.length + ' lignes de risque correctement evaluees');
            msgs.push('üìå Rappel : Probabilite = Exposition √ó Declencheur');
            msgs.push('üìå Le risque est PRIORITAIRE lorsque Gravite + Probabilite ‚â• 5');
        }
        if (msgs.length > 0) {
            fb.innerHTML = msgs.join('<br>');
            fb.classList.add('visible');
        }
    }

    // QCM Classique validation
    else if (type === 'qcm_classique') {
        const c = currentExo.contenu;
        const isMultiple = !!c.multiple;
        const repIds = Array.isArray(c.reponse) ? c.reponse : [c.reponse];
        const choices = document.querySelectorAll('.qcm-c-choice');
        if (isMultiple) {
            // Multiple: score = nb correct selections + nb correct non-selections
            total = c.choix.length;
            choices.forEach(el => {
                const id = el.dataset.id;
                const isSelected = el.classList.contains('selected');
                const shouldBeSelected = repIds.includes(id);
                if (isSelected && shouldBeSelected) { correct++; el.classList.add('correct'); }
                else if (isSelected && !shouldBeSelected) { el.classList.add('wrong'); }
                else if (!isSelected && shouldBeSelected) { el.classList.add('show-correct'); }
                else { correct++; } // correctly not selected
                el.style.pointerEvents = 'none';
            });
        } else {
            total = 1;
            const selected = document.querySelector('.qcm-c-choice.selected');
            choices.forEach(el => {
                el.style.pointerEvents = 'none';
                if (repIds.includes(el.dataset.id)) {
                    if (el.classList.contains('selected')) { correct = 1; el.classList.add('correct'); }
                    else { el.classList.add('show-correct'); }
                } else if (el.classList.contains('selected')) {
                    el.classList.add('wrong');
                }
            });
            details.push({ label: c.question.substring(0, 60), ok: correct === 1 });
        }
        // Show explication
        const explEl = document.getElementById('qcmc-explication');
        if (explEl) explEl.style.display = 'block';
    }

    // Categoriser validation
    else if (type === 'categoriser') {
        const c = currentExo.contenu;
        total = (c.items || []).length;
        (c.items || []).forEach(item => {
            const placement = catState.placements[item.id];
            const ok = placement === item.categorie;
            if (ok) correct++;
            details.push({ label: item.label, ok: ok });
            // Visual feedback on placed items
            const placedEl = document.querySelector('.cat-placed[data-id="' + item.id + '"]');
            if (placedEl) { placedEl.classList.add(ok ? 'correct' : 'wrong'); }
            // If not placed, mark as wrong in pool
            if (!placement) {
                const poolItem = document.querySelector('.cat-pool .cat-item[data-id="' + item.id + '"]');
                if (poolItem) poolItem.style.border = '2px solid #ef4444';
            }
        });
        // Disable all interactions
        document.querySelectorAll('.cat-item').forEach(el => { el.style.pointerEvents = 'none'; });
        document.querySelectorAll('.cat-zone').forEach(el => { el.onclick = null; });
        document.querySelectorAll('.cat-placed').forEach(el => { el.onclick = null; });
    }

    document.getElementById('btn-validate').disabled = true;
    showResults(correct, total, details);
}

// =====================================================================
// RESULTS
// =====================================================================

function showResults(correct, total, details) {
    corrected = true;
    const pct = total > 0 ? Math.round(correct / total * 100) : 0;
    const colorClass = pct >= 70 ? 'score-ok' : pct >= 40 ? 'score-mid' : 'score-low';
    const msgs = pct >= 80 ? 'Excellent !' : pct >= 60 ? 'Bien joue !' : pct >= 40 ? 'Pas mal, continue !' : 'Courage, tu peux faire mieux !';

    let html = '<div class="results-box">';
    html += '<div style="font-size:2rem;">üèÜ</div>';
    html += '<div class="score-big ' + colorClass + '">' + pct + '%</div>';
    html += '<div class="score-label">' + correct + ' / ' + total + ' ‚Äî ' + msgs + '</div>';
    html += '<div class="results-actions">';
    html += '<button class="btn-retry" onclick="retryExercice()">üîÑ Refaire</button>';
    html += '<button class="btn-back-list" onclick="backToList()">‚Üê Retour</button>';
    html += '</div></div>';

    // Correction details
    if (details && details.length > 0) {
        html += '<div class="correction-list">';
        details.forEach(d => {
            html += '<div class="corr-item ' + (d.ok ? 'corr-ok' : 'corr-ko') + '">';
            html += '<span class="corr-icon">' + (d.ok ? '‚úì' : '‚úó') + '</span>';
            html += '<div class="corr-text"><strong>' + d.label + '</strong>';
            if (d.detail) html += '<br><span style="font-size:0.8rem; color:#64748b;">' + d.detail + '</span>';
            html += '</div></div>';
        });
        html += '</div>';
    }

    const resultsZone = document.getElementById('zone-results');
    resultsZone.innerHTML = html;
    resultsZone.style.display = '';
    resultsZone.scrollIntoView({ behavior: 'smooth' });
}

function retryExercice() {
    if (currentExo) startExercice(currentExo);
}
</script>
</body>
</html>
