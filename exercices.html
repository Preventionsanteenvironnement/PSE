<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercices en ligne â€” PSE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8; color: #1e293b; min-height: 100vh;
        }
        .screen { min-height: 100vh; padding: 20px; max-width: 800px; margin: 0 auto; }
        .screen-hidden { display: none !important; }

        /* === HEADER === */
        .exo-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; padding: 20px 24px; border-radius: 16px;
            margin-bottom: 24px; text-align: center;
        }
        .exo-header h1 { font-size: 1.5rem; font-weight: 800; }
        .exo-header p { opacity: 0.85; font-size: 0.9rem; margin-top: 4px; }
        .back-home {
            display: inline-flex; align-items: center; gap: 6px; color: white; text-decoration: none;
            font-size: 0.85rem; opacity: 0.8; margin-bottom: 10px;
        }
        .back-home:hover { opacity: 1; }

        /* === LEVEL BUTTONS === */
        .level-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .level-btn {
            padding: 18px 16px; background: white; border: 2px solid #e2e8f0;
            border-radius: 14px; cursor: pointer; font-weight: 700; font-size: 1rem;
            text-align: center; transition: 0.2s; color: #1e293b;
        }
        .level-btn:hover { border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(59,130,246,0.15); }
        .level-btn.active { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
        .level-btn-trans { font-size: 0.9rem; padding: 14px 12px; }
        .level-btn-trans:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .level-btn-trans.active { background: #fffbeb; }

        /* === MODULE LIST === */
        .module-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .module-btn {
            padding: 14px 16px; background: white; border: 2px solid #e2e8f0;
            border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
            text-align: left; transition: 0.2s; color: #1e293b;
        }
        .module-btn:hover { border-color: #3b82f6; }
        .module-btn.active { border-color: #3b82f6; background: #eff6ff; }
        .module-btn .mod-id { color: #3b82f6; font-weight: 800; }
        .theme-label {
            font-size: 0.75rem; color: #64748b; text-transform: uppercase;
            letter-spacing: 1px; font-weight: 700; margin: 16px 0 8px; padding-left: 4px;
        }

        /* === EXERCISE LIST === */
        .exo-card {
            background: white; border-radius: 14px; padding: 16px 20px;
            margin-bottom: 10px; cursor: pointer; transition: 0.2s;
            border: 2px solid #e2e8f0; display: flex; align-items: center; gap: 14px;
        }
        .exo-card:hover { border-color: #3b82f6; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .exo-icon { font-size: 1.8rem; flex-shrink: 0; }
        .exo-info { flex: 1; }
        .exo-info h3 { font-size: 1rem; font-weight: 700; margin-bottom: 3px; }
        .exo-info .exo-meta { font-size: 0.8rem; color: #64748b; display: flex; gap: 8px; flex-wrap: wrap; }
        .exo-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 0.7rem; font-weight: 700;
        }
        .badge-facile { background: #dcfce7; color: #166534; }
        .badge-moyen { background: #fef3c7; color: #92400e; }
        .badge-difficile { background: #fee2e2; color: #991b1b; }
        .badge-type { background: #dbeafe; color: #1e40af; }
        .empty-msg { text-align: center; padding: 40px 20px; color: #94a3b8; font-size: 1rem; }

        /* === BREADCRUMB === */
        .breadcrumb { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; font-size: 0.85rem; }
        .breadcrumb a { color: #3b82f6; text-decoration: none; cursor: pointer; font-weight: 600; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep { color: #94a3b8; }
        .breadcrumb .current { color: #64748b; font-weight: 600; }

        /* === EXERCISE PLAY SCREEN === */
        .play-header {
            background: white; border-radius: 14px; padding: 16px 20px;
            margin-bottom: 16px; display: flex; align-items: center; gap: 14px;
            border: 1px solid #e2e8f0;
        }
        .play-header .back-btn {
            background: #e2e8f0; border: none; border-radius: 10px; width: 40px; height: 40px;
            font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: #475569; transition: 0.2s; flex-shrink: 0;
        }
        .play-header .back-btn:hover { background: #cbd5e1; }
        .play-header h2 { font-size: 1.05rem; font-weight: 700; }
        .play-header .play-badge { margin-left: auto; }

        .consigne-box {
            background: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px 16px;
            border-radius: 0 10px 10px 0; margin-bottom: 16px; font-size: 0.95rem; color: #1e40af; font-weight: 600;
        }

        .game-zone {
            background: white; border-radius: 16px; padding: 24px;
            border: 1px solid #e2e8f0; min-height: 200px; margin-bottom: 16px;
        }

        .btn-validate {
            width: 100%; padding: 16px; background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white; border: none; border-radius: 14px; font-size: 1.1rem;
            font-weight: 800; cursor: pointer; transition: 0.2s; letter-spacing: 0.5px;
        }
        .btn-validate:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(34,197,94,0.3); }
        .btn-validate:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* === RESULTS === */
        .results-box {
            background: white; border-radius: 16px; padding: 30px; text-align: center;
            border: 1px solid #e2e8f0; margin-bottom: 16px;
        }
        .score-big { font-size: 3.5rem; font-weight: 900; margin: 10px 0; }
        .score-ok { color: #22c55e; }
        .score-mid { color: #f59e0b; }
        .score-low { color: #ef4444; }
        .score-label { font-size: 1rem; color: #64748b; margin-bottom: 16px; }
        .results-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 16px; }
        .btn-retry {
            padding: 12px 28px; background: #3b82f6; color: white; border: none;
            border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .btn-retry:hover { opacity: 0.85; }
        .btn-back-list {
            padding: 12px 28px; background: #e2e8f0; color: #475569; border: none;
            border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .btn-back-list:hover { background: #cbd5e1; }

        /* === CORRECTION DETAIL === */
        .correction-list { text-align: left; margin-top: 20px; }
        .corr-item {
            padding: 12px 16px; border-radius: 10px; margin-bottom: 8px;
            font-size: 0.9rem; display: flex; align-items: flex-start; gap: 10px;
        }
        .corr-ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .corr-ko { background: #fef2f2; border: 1px solid #fecaca; }
        .corr-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 1px; }
        .corr-text { flex: 1; }
        .corr-text .expected { color: #16a34a; font-weight: 600; }

        /* ========================================== */
        /* GAME-SPECIFIC STYLES                      */
        /* ========================================== */

        /* --- Texte a trous --- */
        .tt-texte { font-size: 1.05rem; line-height: 2; }
        .tt-texte .tt-input {
            display: inline-block; border: none; border-bottom: 2px solid #3b82f6;
            background: #eff6ff; padding: 2px 8px; font-size: 1rem; font-family: inherit;
            color: #1e293b; min-width: 90px; outline: none; border-radius: 4px 4px 0 0;
            text-align: center;
        }
        .tt-texte .tt-input:focus { border-bottom-color: #2563eb; background: #dbeafe; }
        .tt-texte .tt-input.correct { border-bottom-color: #22c55e; background: #f0fdf4; color: #166534; }
        .tt-texte .tt-input.wrong { border-bottom-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .tt-texte .tt-select {
            display: inline-block; border: 2px solid #3b82f6; background: #eff6ff;
            padding: 2px 8px; font-size: 1rem; font-family: inherit; color: #1e293b;
            min-width: 120px; outline: none; border-radius: 8px; text-align: center; height: 34px;
        }
        .tt-texte .tt-select:focus { border-color: #2563eb; background: #dbeafe; }
        .tt-texte .tt-select.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .tt-texte .tt-select.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .tt-hint { font-size: 0.75rem; color: #94a3b8; font-style: italic; }

        /* --- Relier --- */
        .relier-container { display: flex; gap: 60px; justify-content: center; align-items: flex-start; position: relative; }
        .relier-col { display: flex; flex-direction: column; gap: 10px; min-width: 120px; }
        .relier-item {
            padding: 12px 16px; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
            text-align: center; transition: 0.2s; user-select: none;
        }
        .relier-item:hover { border-color: #3b82f6; }
        .relier-item.selected { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
        .relier-item.matched { cursor: default; }
        .relier-item.correct { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .relier-item.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        /* Couleurs par paire (20 couleurs maximalement distinctes) */
        .relier-item.pair-0 { border-color: #dc2626; background: #fef2f2; color: #991b1b; }
        .relier-item.pair-1 { border-color: #2563eb; background: #eff6ff; color: #1e3a8a; }
        .relier-item.pair-2 { border-color: #16a34a; background: #f0fdf4; color: #14532d; }
        .relier-item.pair-3 { border-color: #ea580c; background: #fff7ed; color: #9a3412; }
        .relier-item.pair-4 { border-color: #7c3aed; background: #f5f3ff; color: #4c1d95; }
        .relier-item.pair-5 { border-color: #db2777; background: #fdf2f8; color: #831843; }
        .relier-item.pair-6 { border-color: #0891b2; background: #ecfeff; color: #164e63; }
        .relier-item.pair-7 { border-color: #ca8a04; background: #fefce8; color: #713f12; }
        .relier-item.pair-8 { border-color: #4338ca; background: #eef2ff; color: #312e81; }
        .relier-item.pair-9 { border-color: #65a30d; background: #f7fee7; color: #365314; }
        .relier-item.pair-10 { border-color: #be123c; background: #fff1f2; color: #881337; }
        .relier-item.pair-11 { border-color: #0284c7; background: #f0f9ff; color: #075985; }
        .relier-item.pair-12 { border-color: #a16207; background: #fefce8; color: #713f12; }
        .relier-item.pair-13 { border-color: #a21caf; background: #fdf4ff; color: #701a75; }
        .relier-item.pair-14 { border-color: #059669; background: #ecfdf5; color: #064e3b; }
        .relier-item.pair-15 { border-color: #e11d48; background: #fff1f3; color: #9f1239; }
        .relier-item.pair-16 { border-color: #1e40af; background: #e8eeff; color: #172554; }
        .relier-item.pair-17 { border-color: #4d7c0f; background: #f5fcd8; color: #365314; }
        .relier-item.pair-18 { border-color: #6b21a8; background: #faf5ff; color: #3b0764; }
        .relier-item.pair-19 { border-color: #475569; background: #f1f5f9; color: #1e293b; }
        .relier-pairs-display { margin-top: 16px; display: flex; flex-direction: column; gap: 6px; }
        .relier-pair-tag {
            display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px;
            border-radius: 8px; font-size: 0.85rem; font-weight: 600; border: 2px solid transparent;
        }
        /* Couleurs tags par paire (20 couleurs) */
        .relier-pair-tag.pair-0 { background: #fef2f2; color: #991b1b; border-color: #dc2626; }
        .relier-pair-tag.pair-1 { background: #eff6ff; color: #1e3a8a; border-color: #2563eb; }
        .relier-pair-tag.pair-2 { background: #f0fdf4; color: #14532d; border-color: #16a34a; }
        .relier-pair-tag.pair-3 { background: #fff7ed; color: #9a3412; border-color: #ea580c; }
        .relier-pair-tag.pair-4 { background: #f5f3ff; color: #4c1d95; border-color: #7c3aed; }
        .relier-pair-tag.pair-5 { background: #fdf2f8; color: #831843; border-color: #db2777; }
        .relier-pair-tag.pair-6 { background: #ecfeff; color: #164e63; border-color: #0891b2; }
        .relier-pair-tag.pair-7 { background: #fefce8; color: #713f12; border-color: #ca8a04; }
        .relier-pair-tag.pair-8 { background: #eef2ff; color: #312e81; border-color: #4338ca; }
        .relier-pair-tag.pair-9 { background: #f7fee7; color: #365314; border-color: #65a30d; }
        .relier-pair-tag.pair-10 { background: #fff1f2; color: #881337; border-color: #be123c; }
        .relier-pair-tag.pair-11 { background: #f0f9ff; color: #075985; border-color: #0284c7; }
        .relier-pair-tag.pair-12 { background: #fefce8; color: #713f12; border-color: #a16207; }
        .relier-pair-tag.pair-13 { background: #fdf4ff; color: #701a75; border-color: #a21caf; }
        .relier-pair-tag.pair-14 { background: #ecfdf5; color: #064e3b; border-color: #059669; }
        .relier-pair-tag.pair-15 { background: #fff1f3; color: #9f1239; border-color: #e11d48; }
        .relier-pair-tag.pair-16 { background: #e8eeff; color: #172554; border-color: #1e40af; }
        .relier-pair-tag.pair-17 { background: #f5fcd8; color: #365314; border-color: #4d7c0f; }
        .relier-pair-tag.pair-18 { background: #faf5ff; color: #3b0764; border-color: #6b21a8; }
        .relier-pair-tag.pair-19 { background: #f1f5f9; color: #1e293b; border-color: #475569; }
        .relier-pair-tag .remove-pair { cursor: pointer; opacity: 0.5; margin-left: 4px; }
        .relier-pair-tag .remove-pair:hover { opacity: 1; }
        .relier-pair-tag.correct { background: #f0fdf4 !important; color: #166534 !important; border-color: #22c55e !important; }
        .relier-pair-tag.wrong { background: #fef2f2 !important; color: #991b1b !important; border-color: #ef4444 !important; text-decoration: line-through; }

        /* --- Ordre --- */
        .ordre-list { display: flex; flex-direction: column; gap: 8px; }
        .ordre-item {
            display: flex; align-items: center; gap: 10px; padding: 14px 16px;
            background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px;
            font-weight: 600; font-size: 0.95rem; transition: 0.2s;
        }
        .ordre-item .ordre-num { color: #94a3b8; font-weight: 800; min-width: 28px; }
        .ordre-item .ordre-text { flex: 1; }
        .ordre-item .ordre-select {
            width: 86px; height: 48px; border: 3px solid #3b82f6; border-radius: 14px;
            background: #fff; color: #0f172a; font-size: 1.8rem; font-weight: 800;
            line-height: 1; padding: 0 8px; margin-right: 6px;
        }
        .ordre-item .ordre-select:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .ordre-item.correct { border-color: #22c55e; background: #f0fdf4; }
        .ordre-item.wrong { border-color: #ef4444; background: #fef2f2; }
        .ordre-actions { margin-top: 10px; }
        .ordre-remelanger {
            border: 1px solid #cbd5e1; background: #f8fafc; color: #475569;
            border-radius: 12px; padding: 10px 16px; font-weight: 700; font-size: 1rem; cursor: pointer;
        }
        .ordre-remelanger:hover { border-color: #93c5fd; color: #2563eb; background: #eff6ff; }

        /* --- Intrus --- */
        .intrus-serie { margin-bottom: 20px; }
        .intrus-serie h4 { font-size: 0.85rem; color: #64748b; margin-bottom: 8px; }
        .intrus-items { display: flex; flex-wrap: wrap; gap: 10px; }
        .intrus-item {
            padding: 12px 20px; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 0.95rem;
            transition: 0.2s; user-select: none;
        }
        .intrus-item:hover { border-color: #3b82f6; }
        .intrus-item.selected { border-color: #f59e0b; background: #fef3c7; color: #92400e; }
        .intrus-item.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .intrus-item.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .intrus-explication { font-size: 0.85rem; color: #64748b; margin-top: 6px; display: none; font-style: italic; }

        /* --- Pendu --- */
        .pendu-zone { text-align: center; }
        .pendu-mot { font-size: 2rem; font-weight: 900; letter-spacing: 8px; margin: 20px 0; font-family: monospace; }
        .pendu-indice { font-size: 0.9rem; color: #64748b; margin-bottom: 16px; font-style: italic; }
        .pendu-clavier { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; max-width: 500px; margin: 0 auto 20px; }
        .pendu-key {
            width: 40px; height: 40px; border: 2px solid #e2e8f0; border-radius: 8px;
            background: white; cursor: pointer; font-weight: 700; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .pendu-key:hover { border-color: #3b82f6; background: #eff6ff; }
        .pendu-key.used-ok { background: #f0fdf4; border-color: #22c55e; color: #166534; cursor: default; }
        .pendu-key.used-ko { background: #fef2f2; border-color: #ef4444; color: #991b1b; cursor: default; opacity: 0.5; }
        .pendu-svg { margin: 0 auto 16px; display: block; }
        .pendu-erreurs { font-size: 0.85rem; color: #ef4444; font-weight: 700; }
        .pendu-nav { display: flex; justify-content: center; gap: 10px; margin-top: 16px; }
        .pendu-nav button {
            padding: 10px 20px; border: none; border-radius: 10px; font-weight: 700;
            cursor: pointer; font-size: 0.9rem; transition: 0.2s;
        }
        .pendu-next { background: #3b82f6; color: white; }
        .pendu-next:hover { opacity: 0.85; }
        .pendu-status { font-size: 0.85rem; color: #64748b; margin-bottom: 10px; }

        /* --- Mots croises --- */
        .mc-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .mc-grid-wrap { flex: 1; min-width: 280px; overflow-x: auto; }
        .mc-grid { border-collapse: collapse; margin: 0 auto; }
        .mc-grid td {
            width: 36px; height: 36px; border: 2px solid #1e293b; text-align: center;
            font-weight: 700; font-size: 1rem; text-transform: uppercase; position: relative;
        }
        .mc-grid td.mc-empty { background: #1e293b; border-color: #1e293b; }
        .mc-grid td input {
            width: 100%; height: 100%; border: none; text-align: center; font-weight: 700;
            font-size: 1rem; text-transform: uppercase; background: transparent; outline: none;
            font-family: inherit; color: #1e293b;
        }
        .mc-grid td input:focus { background: #dbeafe; }
        .mc-grid td .mc-num {
            position: absolute; top: 1px; left: 2px; font-size: 0.55rem; color: #3b82f6;
            font-weight: 800; line-height: 1;
        }
        .mc-grid td.correct { background: #f0fdf4; }
        .mc-grid td.wrong { background: #fef2f2; }
        .mc-defs { flex: 1; min-width: 200px; }
        .mc-defs h4 { font-size: 0.85rem; color: #3b82f6; font-weight: 700; margin: 10px 0 6px; }
        .mc-defs ol { padding-left: 20px; font-size: 0.85rem; line-height: 1.8; color: #475569; }

        /* --- Swipe V/F --- */
        .swipe-zone { text-align: center; }
        .swipe-card {
            background: white; border: 2px solid #e2e8f0; border-radius: 20px;
            padding: 40px 24px; max-width: 500px; margin: 0 auto 20px;
            font-size: 1.15rem; font-weight: 600; line-height: 1.5;
            transition: transform 0.3s, opacity 0.3s; position: relative;
        }
        .swipe-card.slide-left { transform: translateX(-120%); opacity: 0; }
        .swipe-card.slide-right { transform: translateX(120%); opacity: 0; }
        .swipe-btns { display: flex; gap: 16px; justify-content: center; margin-bottom: 16px; }
        .swipe-btn {
            padding: 14px 32px; border: none; border-radius: 14px; font-weight: 800;
            font-size: 1.1rem; cursor: pointer; transition: 0.2s; min-width: 120px;
        }
        .swipe-btn.btn-faux { background: #fee2e2; color: #991b1b; }
        .swipe-btn.btn-faux:hover { background: #fecaca; }
        .swipe-btn.btn-vrai { background: #dcfce7; color: #166534; }
        .swipe-btn.btn-vrai:hover { background: #bbf7d0; }
        .swipe-feedback {
            font-weight: 700; font-size: 1rem; margin-bottom: 12px; min-height: 24px;
        }
        .swipe-expl {
            margin-top: 8px; font-weight: 500; font-size: 0.92rem; color: #475569; line-height: 1.45;
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 12px;
            text-align: left;
        }
        .swipe-next-wrap { display: flex; justify-content: center; margin-bottom: 14px; }
        .swipe-btn.swipe-next { background: #dbeafe; color: #1d4ed8; }
        .swipe-btn.swipe-next:hover { background: #bfdbfe; }
        .swipe-progress { font-size: 0.85rem; color: #94a3b8; }

        /* --- QCM Image --- */
        .qcm-img-zone {}
        .qcm-img-q { margin-bottom: 24px; }
        .qcm-img-q img { max-width: 100%; max-height: 300px; border-radius: 12px; margin-bottom: 12px; object-fit: contain; display: block; }
        .qcm-img-q .q-text { font-weight: 700; font-size: 1.05rem; margin-bottom: 10px; }
        .qcm-img-choices { display: flex; flex-direction: column; gap: 8px; }
        .qcm-img-choice {
            padding: 12px 16px; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.95rem;
            transition: 0.2s;
        }
        .qcm-img-choice:hover { border-color: #3b82f6; }
        .qcm-img-choice.selected { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
        .qcm-img-choice.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .qcm-img-choice.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .qcm-img-expl { font-size: 0.85rem; color: #64748b; margin-top: 6px; display: none; font-style: italic; }
        .qcm-img-placeholder { padding: 30px; background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 12px; text-align: center; color: #94a3b8; font-size: 0.9rem; margin-bottom: 12px; }

        /* --- Tableau --- */
        .tableau-zone { overflow-x: auto; }
        .tableau-zone table { width: 100%; border-collapse: collapse; }
        .tableau-zone th {
            background: #1e293b; color: white; padding: 10px 14px; font-size: 0.85rem;
            font-weight: 700; text-align: left;
        }
        .tableau-zone td { padding: 8px 12px; border: 1px solid #e2e8f0; font-size: 0.9rem; }
        .tableau-zone td input {
            width: 100%; border: none; border-bottom: 2px solid #3b82f6; background: #eff6ff;
            padding: 6px 8px; font-size: 0.9rem; font-family: inherit; outline: none;
            border-radius: 4px 4px 0 0; color: #1e293b;
        }
        .tableau-zone td input:focus { background: #dbeafe; }
        .tableau-zone td.correct { background: #f0fdf4; }
        .tableau-zone td.wrong { background: #fef2f2; }

        /* --- Tableau selection (croix multiples) --- */
        .ts-wrap { display: block; }
        .ts-table { width: 100%; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .ts-grid {
            display: grid;
            gap: 0;
            align-items: stretch;
            grid-template-columns: minmax(170px, 2fr) repeat(var(--ts-cols, 3), minmax(100px, 1fr));
        }
        .ts-head {
            background: #1e293b; color: #fff; font-size: 0.82rem; font-weight: 800;
            padding: 10px 8px; border-right: 1px solid rgba(255,255,255,0.15);
            text-align: center;
        }
        .ts-head:first-child { text-align: left; padding-left: 12px; }
        .ts-row-label {
            background: #f8fafc; border-top: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0;
            padding: 10px 12px; font-weight: 700; color: #0f172a; font-size: 0.9rem;
        }
        .ts-cell {
            border: none; border-top: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0;
            background: #fff; min-height: 52px; cursor: pointer;
            font-size: 1.4rem; font-weight: 900; color: #cbd5e1; transition: 0.15s;
            display: flex; align-items: center; justify-content: center;
        }
        .ts-cell:hover { background: #f8fafc; color: #64748b; }
        .ts-cell.selected { background: #eff6ff; color: #2563eb; }
        .ts-cell.correct { background: #f0fdf4; color: #16a34a; }
        .ts-cell.wrong { background: #fef2f2; color: #dc2626; }
        .ts-cell.missed { background: #fefce8; color: #ca8a04; }
        .ts-mobile-list { display: none; }
        .ts-mobile-row {
            border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; margin-bottom: 10px; background: #fff;
        }
        .ts-mobile-label { font-weight: 800; color: #0f172a; font-size: 0.95rem; margin-bottom: 8px; }
        .ts-mobile-cells { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .ts-mobile-cell {
            border: 2px solid #cbd5e1; border-radius: 10px; background: #fff; color: #334155;
            padding: 10px; font-size: 0.88rem; font-weight: 700; text-align: left; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .ts-mobile-cell .mark { width: 20px; text-align: center; font-size: 1.1rem; color: #94a3b8; }
        .ts-mobile-cell.selected { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; }
        .ts-mobile-cell.selected .mark { color: #2563eb; }
        .ts-mobile-cell.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .ts-mobile-cell.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .ts-mobile-cell.missed { border-color: #f59e0b; background: #fffbeb; color: #92400e; }

        /* --- Etude de cas --- */
        .ec-scenario {
            background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px 20px;
            border-radius: 0 12px 12px 0; margin-bottom: 20px; font-size: 0.95rem;
            line-height: 1.6; color: #78350f;
        }
        .ec-question { margin-bottom: 16px; }
        .ec-question .ec-q-text { font-weight: 700; margin-bottom: 8px; }
        .ec-question .ec-q-num { color: #3b82f6; font-weight: 800; }
        .ec-qcm-choices { display: flex; flex-direction: column; gap: 6px; }
        .ec-qcm-choice {
            padding: 10px 14px; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s;
        }
        .ec-qcm-choice:hover { border-color: #3b82f6; }
        .ec-qcm-choice.selected { border-color: #3b82f6; background: #eff6ff; }
        .ec-qcm-choice.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .ec-qcm-choice.wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .ec-text-input {
            width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 0.9rem; font-family: inherit; outline: none; resize: vertical; min-height: 60px;
        }
        .ec-text-input:focus { border-color: #3b82f6; }
        .ec-expected { font-size: 0.85rem; color: #16a34a; margin-top: 4px; display: none; font-style: italic; }

        /* === PREVENTION (Mesures de prevention) === */
        .prev-situation {
            background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px 20px;
            border-radius: 8px; margin-bottom: 12px; font-size: 0.95rem; line-height: 1.6; color: #1e3a5f;
        }
        .prev-situation-label { font-weight: 800; color: #2563eb; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .prev-danger-box {
            background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px 16px;
            border-radius: 8px; margin-bottom: 16px; font-size: 0.95rem; color: #991b1b;
        }
        .prev-danger-label { font-weight: 800; color: #ef4444; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .prev-instruction { font-weight: 700; color: #475569; margin-bottom: 16px; font-size: 0.95rem; text-align: center; }
        .prev-hierarchy-label {
            text-align: center; font-size: 0.75rem; color: #94a3b8; margin-bottom: 12px;
            font-weight: 600; letter-spacing: 0.5px;
        }
        .prev-levels { display: flex; flex-direction: column; gap: 10px; }
        .prev-level {
            background: white; border: 2px solid #e2e8f0; border-radius: 12px;
            padding: 14px 16px; display: flex; align-items: center; gap: 14px;
            transition: border-color 0.3s, background 0.3s;
        }
        .prev-level-num {
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-weight: 900;
            font-size: 0.95rem; flex-shrink: 0; color: white;
        }
        .prev-level-num.n1 { background: #22c55e; }
        .prev-level-num.n2 { background: #3b82f6; }
        .prev-level-num.n3 { background: #f59e0b; }
        .prev-level-num.n4 { background: #f97316; }
        .prev-level-num.n5 { background: #ef4444; }
        .prev-level-content { flex: 1; }
        .prev-level-label { font-weight: 700; font-size: 0.8rem; color: #475569; margin-bottom: 6px; }
        .prev-level select {
            width: 100%; padding: 8px 10px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 0.85rem; color: #1e293b; background: #f8fafc; cursor: pointer;
        }
        .prev-level select:focus { border-color: #3b82f6; outline: none; }
        .prev-level.correct { background: #f0fdf4; border-color: #22c55e; }
        .prev-level.correct select { border-color: #22c55e; background: #f0fdf4; }
        .prev-level.wrong { background: #fef2f2; border-color: #ef4444; }
        .prev-level.wrong select { border-color: #ef4444; background: #fef2f2; }
        .prev-correction { font-size: 0.8rem; color: #166534; margin-top: 6px; font-weight: 600; }
        .prev-efficacy-arrow {
            text-align: center; color: #94a3b8; font-size: 0.75rem; font-weight: 700;
            padding: 2px 0; letter-spacing: 1px;
        }

        /* === PICTOGRAMMES === */
        .picto-quiz-img { width: 180px; height: 180px; object-fit: contain; border-radius: 12px; border: 3px solid #e2e8f0; background: #fff; display: block; margin: 0 auto 20px; }
        .picto-choices { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 500px; margin: 0 auto; }
        .picto-choice {
            padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; background: #f8fafc;
            cursor: pointer; font-weight: 600; font-size: 0.9rem; text-align: center; transition: 0.2s; user-select: none;
        }
        .picto-choice:hover { border-color: #3b82f6; background: #eff6ff; }
        .picto-choice.selected { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
        .picto-choice.correct { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .picto-choice.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .picto-choice-img { width: 90px; height: 90px; object-fit: contain; border-radius: 8px; border: 2px solid #e2e8f0; background: #fff; display: block; margin: 0 auto 8px; }
        .picto-progress { text-align: center; color: #64748b; font-size: 0.85rem; margin-bottom: 12px; font-weight: 600; }
        .picto-progress-bar { height: 4px; background: #e2e8f0; border-radius: 4px; margin-bottom: 16px; }
        .picto-progress-fill { height: 100%; background: #3b82f6; border-radius: 4px; transition: width 0.3s; }
        .picto-cat-label { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; margin-bottom: 10px; }
        .picto-cat-obligation { background: #dbeafe; color: #1e40af; }
        .picto-cat-interdiction { background: #fee2e2; color: #991b1b; }
        .picto-cat-danger { background: #fef3c7; color: #92400e; }
        .picto-cat-incendie { background: #fee2e2; color: #b91c1c; }
        .picto-cat-secours { background: #dcfce7; color: #166534; }
        .picto-cat-sgh { background: #fde68a; color: #92400e; }
        /* Picto Memory */
        .picto-mem-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 600px; margin: 0 auto; }
        .picto-mem-card {
            aspect-ratio: 1; border-radius: 12px; border: 2px solid #e2e8f0; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.3s; background: #1e293b; overflow: hidden;
        }
        .picto-mem-card .mem-back { font-size: 2rem; color: #94a3b8; }
        .picto-mem-card .mem-face { display: none; padding: 6px; text-align: center; width: 100%; height: 100%; }
        .picto-mem-card .mem-face img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .picto-mem-card .mem-face-text { font-size: 0.7rem; font-weight: 700; color: #1e293b; padding: 8px; display: flex; align-items: center; justify-content: center; height: 100%; }
        .picto-mem-card.flipped, .picto-mem-card.matched { background: #fff; }
        .picto-mem-card.flipped .mem-back, .picto-mem-card.matched .mem-back { display: none; }
        .picto-mem-card.flipped .mem-face, .picto-mem-card.matched .mem-face { display: flex; align-items: center; justify-content: center; }
        .picto-mem-card.matched { border-color: #22c55e; }
        /* Picto Speed */
        .picto-speed-timer { text-align: center; font-size: 2rem; font-weight: 900; color: #3b82f6; margin-bottom: 16px; }
        .picto-speed-timer.urgent { color: #ef4444; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .picto-speed-score { text-align: center; font-size: 1.2rem; font-weight: 700; color: #475569; margin-bottom: 16px; }
        /* Picto Categoriser */
        .picto-cat-container { display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; }
        .picto-cat-zone {
            flex: 1; min-width: 140px; max-width: 200px; background: #f8fafc; border: 2px dashed #cbd5e1;
            border-radius: 12px; padding: 12px; min-height: 150px; text-align: center;
        }
        .picto-cat-zone-title { font-weight: 800; font-size: 0.85rem; margin-bottom: 10px; padding: 6px; border-radius: 6px; }
        .picto-cat-items { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 16px; }
        .picto-drag-item {
            width: 70px; height: 70px; border-radius: 8px; border: 2px solid #e2e8f0; background: #fff;
            cursor: grab; overflow: hidden; transition: 0.2s;
        }
        .picto-drag-item img { width: 100%; height: 100%; object-fit: contain; }
        .picto-drag-item.correct { border-color: #22c55e; }
        .picto-drag-item.wrong { border-color: #ef4444; }
        /* Escape Game */
        .escape-container { max-width: 600px; margin: 0 auto; }
        .escape-title { text-align: center; font-size: 1.3rem; font-weight: 900; color: #1e293b; margin-bottom: 20px; }
        .escape-progress { display: flex; justify-content: center; gap: 12px; margin-bottom: 24px; }
        .escape-step { display: flex; flex-direction: column; align-items: center; gap: 4px; opacity: 0.4; transition: 0.3s; }
        .escape-step.active { opacity: 1; transform: scale(1.15); }
        .escape-step.done { opacity: 1; }
        .escape-lock { font-size: 1.5rem; }
        .escape-step-num { font-size: 0.75rem; font-weight: 700; color: #64748b; }
        .escape-ep-header { text-align: center; margin-bottom: 20px; }
        .escape-ep-title { font-size: 1.1rem; font-weight: 800; color: #7c3aed; margin-bottom: 6px; }
        .escape-ep-desc { font-size: 0.9rem; color: #64748b; }
        .escape-unlock-msg { text-align: center; padding: 40px 20px; animation: escapeUnlock 0.5s ease; }
        @keyframes escapeUnlock {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* === ANALYSE DE COPIE === */
        .analyse-copie-container { max-width: 700px; margin: 0 auto; }
        .ac-contexte { background: #f8fafc; border-left: 4px solid #6366f1; padding: 14px 18px; margin-bottom: 20px; border-radius: 8px; font-size: 0.95rem; color: #334155; line-height: 1.5; }
        .ac-progress { text-align: center; font-weight: 700; color: #6366f1; margin-bottom: 16px; font-size: 1rem; }
        .ac-progress-bar { display: flex; gap: 6px; justify-content: center; margin-bottom: 20px; }
        .ac-progress-dot { width: 12px; height: 12px; border-radius: 50%; background: #e2e8f0; transition: 0.3s; }
        .ac-progress-dot.active { background: #6366f1; transform: scale(1.2); }
        .ac-progress-dot.done { background: #22c55e; }
        .ac-item { background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .ac-exam-question { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px 16px; margin-bottom: 12px; font-size: 0.9rem; color: #1e40af; }
        .ac-exam-question strong { display: block; margin-bottom: 4px; color: #1e3a8a; font-size: 0.8rem; }
        .ac-response-eleve { background: #fefce8; border: 1px solid #fde68a; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-style: italic; color: #713f12; line-height: 1.5; white-space: pre-wrap; }
        .ac-response-eleve strong { display: block; margin-bottom: 4px; font-style: normal; color: #92400e; font-size: 0.8rem; }
        .ac-section { margin-bottom: 16px; }
        .ac-section-title { font-weight: 700; color: #334155; margin-bottom: 8px; font-size: 0.9rem; }
        .ac-qcu { display: flex; flex-wrap: wrap; gap: 8px; }
        .ac-choice { padding: 8px 16px; border: 2px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #475569; transition: 0.2s; user-select: none; }
        .ac-choice:hover { border-color: #6366f1; color: #6366f1; }
        .ac-choice.selected { background: #6366f1; color: #fff; border-color: #6366f1; }
        .ac-choice.correct { background: #22c55e !important; color: #fff !important; border-color: #22c55e !important; }
        .ac-choice.wrong { background: #ef4444 !important; color: #fff !important; border-color: #ef4444 !important; }
        .ac-choice.show-correct { border-color: #22c55e !important; color: #22c55e !important; font-weight: 800; }
        .ac-textarea { width: 100%; min-height: 60px; border: 2px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 0.9rem; font-family: inherit; resize: vertical; }
        .ac-textarea.correct { border-color: #22c55e; background: #f0fdf4; }
        .ac-textarea.wrong { border-color: #ef4444; background: #fef2f2; }
        .ac-correction-hint { font-size: 0.8rem; color: #16a34a; margin-top: 4px; display: none; }
        .ac-c6-grid { border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .ac-c6-row { display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #e2e8f0; }
        .ac-c6-row:last-child { border-bottom: none; }
        .ac-c6-label { flex: 1; font-size: 0.85rem; color: #334155; }
        .ac-c6-btns { display: flex; gap: 6px; }
        .ac-c6-btn { width: 36px; height: 36px; border: 2px solid #cbd5e1; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.9rem; background: #fff; color: #475569; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .ac-c6-btn:hover { border-color: #6366f1; }
        .ac-c6-btn.active { background: #6366f1; color: #fff; border-color: #6366f1; }
        .ac-c6-btn.correct { background: #22c55e !important; color: #fff !important; border-color: #22c55e !important; }
        .ac-c6-btn.wrong { background: #ef4444 !important; color: #fff !important; border-color: #ef4444 !important; }
        .ac-c6-btn.show-correct { border-color: #22c55e !important; color: #22c55e !important; }
        .ac-c6-btn.partial { background: #f59e0b !important; color: #fff !important; border-color: #f59e0b !important; }
        .ac-c6-row.correct { background: #f0fdf4; }
        .ac-c6-row.wrong { background: #fef2f2; }
        .ac-c6-row.partial { background: #fffbeb; }
        .ac-conditional { display: none; }
        .ac-conditional.visible { display: block; }
        .ac-nav { display: flex; justify-content: center; gap: 12px; margin-top: 20px; }
        .ac-nav button { padding: 10px 24px; border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: 0.2s; }
        .ac-btn-prev { background: #e2e8f0; color: #475569; }
        .ac-btn-prev:hover { background: #cbd5e1; }
        .ac-btn-next { background: #6366f1; color: #fff; }
        .ac-btn-next:hover { background: #4f46e5; }

        /* === EXPLICATIONS PEDAGOGIQUES === */
        .ac-expl-resume { background: #f5f3ff; border-left: 3px solid #8b5cf6; padding: 8px 12px; margin: 8px 0; font-size: 0.88rem; color: #6d28d9; font-style: italic; border-radius: 0 6px 6px 0; }
        .ac-explications { background: #faf5ff; border: 1px solid #c4b5fd; border-radius: 8px; margin: 10px 0 4px; }
        .ac-explications summary { cursor: pointer; padding: 10px 14px; font-weight: 700; font-size: 0.9rem; color: #7c3aed; user-select: none; }
        .ac-explications summary:hover { background: #f3e8ff; border-radius: 8px; }
        .ac-expl-body { padding: 4px 14px 14px; }
        .ac-expl-block { margin-bottom: 10px; }
        .ac-expl-label { font-weight: 700; font-size: 0.82rem; color: #7c3aed; margin-bottom: 2px; }
        .ac-expl-text { font-size: 0.85rem; color: #334155; line-height: 1.5; margin-bottom: 4px; }
        .ac-expl-list { margin: 4px 0 4px 18px; font-size: 0.84rem; color: #475569; }
        .ac-expl-list li { margin-bottom: 2px; }
        .ac-expl-c6-feedback { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
        .ac-expl-c6-item { background: #ede9fe; border-radius: 6px; padding: 6px 10px; font-size: 0.82rem; }
        .ac-expl-c6-item strong { color: #6d28d9; }
        .ac-justification-modele { background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px; padding: 8px 12px; margin: 6px 0; font-size: 0.85rem; color: #166534; }
        .ac-v2-intro { background: #fff; border: 2px solid #e2e8f0; border-radius: 14px; padding: 16px; }
        .ac-v2-intro h3 { margin: 0 0 8px; color: #1f2937; font-size: 1.2rem; }
        .ac-v2-intro p { margin: 0 0 10px; color: #475569; }
        .ac-v2-subtitle { font-weight: 700; color: #334155; margin: 10px 0 6px; }
        .ac-v2-intro ol { margin: 0 0 8px 18px; color: #475569; }
        .ac-v2-comp-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .ac-v2-comp-card { border: 1px solid #dbeafe; background: #eff6ff; border-radius: 8px; padding: 8px; font-size: 0.85rem; color: #1e3a8a; }
        .ac-v2-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .ac-v2-btn-main { border: none; background: #2563eb; color: #fff; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer; }
        .ac-v2-btn-main:hover { background: #1d4ed8; }
        .ac-v2-corr { margin-top: 12px; border: 1px solid #c7d2fe; background: #eef2ff; border-radius: 10px; padding: 12px; }
        .ac-v2-corr-title { font-weight: 800; color: #4338ca; margin-bottom: 8px; }
        .ac-v2-corr-resume { background: #ddd6fe; color: #5b21b6; border-radius: 8px; padding: 8px; margin-bottom: 8px; font-weight: 600; }
        .ac-v2-corr-block { margin-bottom: 8px; color: #334155; font-size: 0.9rem; }
        .ac-v2-pending { margin-top: 8px; padding: 8px 10px; border-left: 3px solid #94a3b8; border-radius: 0 8px 8px 0; background: #f8fafc; color: #64748b; font-size: 0.85rem; }
        .ac-v2-example { border-left: 3px solid #94a3b8; padding: 6px 8px; margin-top: 4px; border-radius: 0 6px 6px 0; background: #f8fafc; }
        .ac-v2-example.good { border-left-color: #22c55e; background: #f0fdf4; color: #166534; }
        .ac-v2-example.bad { border-left-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .ac-v2-ul { margin: 6px 0 0 18px; }
        .ac-v2-final-title { font-size: 1.1rem; font-weight: 800; color: #1f2937; margin-bottom: 8px; }
        .ac-v2-c6-row { border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; margin-bottom: 8px; background: #fff; }
        .ac-v2-c6-left { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
        .ac-v2-c6-btns { display: flex; gap: 8px; }
        .ac-v2-info-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #93c5fd; background: #eff6ff; color: #1d4ed8; font-weight: 700; cursor: pointer; }
        .ac-v2-c6-help { margin-top: 8px; background: #f8fafc; border-radius: 8px; padding: 8px; font-size: 0.85rem; color: #475569; }
        .ac-v2-score-preview { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 10px; padding: 10px; margin-top: 10px; color: #334155; font-weight: 600; display: grid; gap: 4px; }
        .ac-v2-final-box { background: #eef2ff; border: 1px solid #c7d2fe; color: #312e81; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
        .ac-v2-final-note { font-size: 1.1rem; font-weight: 800; margin-top: 4px; }
        @media (max-width: 600px) {
            .ac-expl-c6-feedback { grid-template-columns: 1fr; }
            .ac-v2-actions { flex-direction: column; }
            .ac-v2-btn-main, .ac-v2-actions button { width: 100%; }
            .ac-v2-c6-btns { justify-content: space-between; }
        }

        /* === RESPONSIVE === */
        @media (max-width: 600px) {
            .screen { padding: 12px; }
            .exo-header h1 { font-size: 1.2rem; }
            .level-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .module-grid { grid-template-columns: 1fr; }
            .relier-container { flex-direction: column; gap: 20px; align-items: center; }
            .pendu-mot { font-size: 1.5rem; letter-spacing: 5px; }
            .pendu-key { width: 34px; height: 34px; font-size: 0.85rem; }
            .swipe-card { padding: 24px 16px; font-size: 1rem; }
            .mc-container { flex-direction: column; }
            .mc-grid td { width: 30px; height: 30px; font-size: 0.85rem; }
            .score-big { font-size: 2.5rem; }
            .results-actions { flex-direction: column; }
            .results-actions button { width: 100%; }
            .pad-chain { flex-direction: column; }
            .pad-arrow { transform: rotate(90deg); }
            .pad-step { min-width: unset; }
            .picto-quiz-img { width: 140px; height: 140px; }
            .picto-choices { grid-template-columns: 1fr; }
            .picto-mem-board { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .picto-cat-container { flex-direction: column; align-items: stretch; }
            .picto-cat-zone { max-width: 100%; }
            .ac-qcu { flex-direction: column; }
            .ac-choice { text-align: center; }
            .ac-nav { flex-direction: column; }
            .ac-nav button { width: 100%; }
            .ts-table { display: none; }
            .ts-mobile-list { display: block; }
        }

        /* === PAD === */
        .pad-situation {
            background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px 20px;
            border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6; color: #1e3a5f;
        }
        .pad-situation-label { font-weight: 800; color: #2563eb; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .pad-instruction { font-weight: 700; color: #475569; margin-bottom: 16px; font-size: 0.95rem; text-align: center; }
        .pad-chain {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 24px; flex-wrap: nowrap;
        }
        .pad-arrow { color: #94a3b8; font-size: 1.5rem; font-weight: 900; flex-shrink: 0; }
        .pad-step {
            background: white; border: 2px solid #e2e8f0; border-radius: 12px;
            padding: 12px; text-align: center; min-width: 150px; flex: 1;
            transition: border-color 0.3s, background 0.3s;
        }
        .pad-step-label {
            font-weight: 800; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;
            color: #64748b; margin-bottom: 8px;
        }
        .pad-step select {
            width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 0.85rem; color: #1e293b; background: #f8fafc; cursor: pointer;
        }
        .pad-step select:focus { border-color: #3b82f6; outline: none; }
        .pad-step.correct { background: #f0fdf4; border-color: #22c55e; }
        .pad-step.correct select { border-color: #22c55e; background: #f0fdf4; }
        .pad-step.wrong { background: #fef2f2; border-color: #ef4444; }
        .pad-step.wrong select { border-color: #ef4444; background: #fef2f2; }
        .pad-correction { font-size: 0.8rem; color: #166534; margin-top: 6px; font-weight: 600; }

        /* === ESTIMATION DU RISQUE === */
        .est-situation { background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #e2e8f0; }
        .est-situation-label { font-size: 0.7rem; color: #2563eb; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px; }
        .est-danger-box { background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 10px 14px; margin-bottom: 8px; }
        .est-danger-label { font-size: 0.65rem; color: #dc2626; text-transform: uppercase; font-weight: 700; }
        .est-dommage-box { background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px; padding: 10px 14px; margin-bottom: 16px; }
        .est-dommage-label { font-size: 0.65rem; color: #ea580c; text-transform: uppercase; font-weight: 700; }
        .est-instruction { text-align: center; font-weight: 700; color: #334155; margin-bottom: 16px; font-size: 0.95rem; }
        .est-steps { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
        .est-step { display: flex; align-items: center; gap: 12px; border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px; background: #fff; transition: all 0.3s; }
        .est-step-num { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #fff; font-size: 0.9rem; flex-shrink: 0; }
        .est-step-num.n1 { background: #ef4444; }
        .est-step-num.n2 { background: #f59e0b; }
        .est-step-num.n3 { background: #3b82f6; }
        .est-step-content { flex: 1; }
        .est-step-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: #475569; margin-bottom: 4px; }
        .est-step select { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.9rem; background: #f8fafc; }
        .est-step.correct { background: #f0fdf4; border-color: #22c55e; }
        .est-step.correct select { border-color: #22c55e; background: #f0fdf4; }
        .est-step.wrong { background: #fef2f2; border-color: #ef4444; }
        .est-step.wrong select { border-color: #ef4444; background: #fef2f2; }
        .est-step-correction { font-size: 0.8rem; color: #166534; margin-top: 4px; font-weight: 600; display: none; }
        .est-proba-display { text-align: center; background: #f1f5f9; border-radius: 10px; padding: 14px; margin-bottom: 16px; border: 2px dashed #94a3b8; }
        .est-proba-display.visible { border-style: solid; border-color: #8b5cf6; background: #f5f3ff; }
        .est-proba-num { font-size: 1.8rem; font-weight: 900; color: #8b5cf6; }
        .est-proba-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        .est-matrix-section { margin-bottom: 16px; }
        .est-matrix-title { text-align: center; font-size: 0.75rem; color: #475569; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; }
        .est-matrix { display: grid; grid-template-columns: auto repeat(4, 1fr); gap: 3px; max-width: 360px; margin: 0 auto; }
        .est-matrix-header { font-size: 0.65rem; color: #64748b; font-weight: 700; text-align: center; padding: 4px 2px; }
        .est-matrix-ylabel { font-size: 0.65rem; color: #64748b; font-weight: 700; text-align: right; padding: 4px 6px 4px 0; display: flex; align-items: center; justify-content: flex-end; }
        .est-matrix-cell { padding: 10px 4px; text-align: center; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: 700; transition: all 0.2s; user-select: none; border: 2px solid transparent; }
        .est-matrix-cell.zone-green { background: rgba(34,197,94,0.15); color: #166534; }
        .est-matrix-cell.zone-red { background: rgba(239,68,68,0.15); color: #991b1b; }
        .est-matrix-cell:hover { transform: scale(1.05); opacity: 0.85; }
        .est-matrix-cell.selected { border: 3px solid #1e40af; transform: scale(1.08); box-shadow: 0 0 8px rgba(30,64,175,0.4); }
        .est-matrix-cell.correct-cell { border: 3px solid #22c55e !important; background: #22c55e !important; color: #fff !important; }
        .est-matrix-cell.wrong-cell { border: 3px solid #ef4444 !important; background: #ef4444 !important; color: #fff !important; }
        .est-matrix-cell.show-correct { border: 3px solid #22c55e !important; animation: pulse-green 1s infinite; }
        @keyframes pulse-green { 0%,100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 50% { box-shadow: 0 0 0 8px rgba(34,197,94,0); } }
        .est-priorite-section { text-align: center; margin-bottom: 12px; }
        .est-priorite-section label { font-size: 0.75rem; color: #475569; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 8px; }
        .est-prio-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .est-prio-btn { padding: 10px 18px; border-radius: 8px; border: 2px solid #cbd5e1; background: #fff; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.2s; }
        .est-prio-btn.active { border-color: #1e40af; background: #eff6ff; color: #1e40af; }
        .est-prio-btn.correct-prio { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .est-prio-btn.wrong-prio { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .est-feedback { background: #fffbeb; border: 1px solid #fde68a; border-radius: 10px; padding: 12px; margin-top: 12px; font-size: 0.85rem; display: none; }
        .est-feedback.visible { display: block; }
        @media (max-width: 480px) {
            .est-matrix { max-width: 100%; }
            .est-matrix-cell { padding: 8px 2px; font-size: 0.6rem; }
            .est-step { flex-direction: column; align-items: stretch; }
            .est-step-num { width: 28px; height: 28px; font-size: 0.75rem; }
        }

        /* === DUERP (Document Unique) === */
        .duerp-header { background: #1e293b; color: #fff; padding: 16px 20px; border-radius: 12px 12px 0 0; margin-bottom: 0; }
        .duerp-header-title { font-size: 1.1rem; font-weight: 800; letter-spacing: 0.3px; }
        .duerp-header-sub { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
        .duerp-unite { display: inline-block; background: #3b82f6; color: #fff; font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 20px; margin-bottom: 10px; }
        .duerp-situation { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; margin-bottom: 16px; line-height: 1.6; font-size: 0.92rem; color: #334155; }
        .duerp-situation-label { font-size: 0.7rem; color: #2563eb; text-transform: uppercase; font-weight: 700; margin-bottom: 6px; letter-spacing: 0.5px; }
        .duerp-section { margin-bottom: 16px; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
        .duerp-section-title { padding: 10px 16px; font-weight: 700; font-size: 0.85rem; color: #fff; }
        .duerp-section-title.danger { background: #dc2626; }
        .duerp-section-title.dommage { background: #ea580c; }
        .duerp-section-title.estimation { background: #7c3aed; }
        .duerp-section-title.mesure { background: #059669; }
        .duerp-section-body { padding: 12px 16px; }
        .duerp-qcm-choices { display: flex; flex-direction: column; gap: 8px; }
        .duerp-qcm-choice { padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; background: #fff; user-select: none; }
        .duerp-qcm-choice:hover { border-color: #93c5fd; background: #f0f9ff; }
        .duerp-qcm-choice.selected { border-color: #2563eb; background: #eff6ff; color: #1e40af; font-weight: 600; }
        .duerp-qcm-choice.correct { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .duerp-qcm-choice.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .duerp-qcm-choice.show-correct { border-color: #22c55e !important; background: #dcfce7 !important; color: #166534 !important; font-weight: 700; }
        .duerp-estimation { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
        .duerp-est-field { flex: 1; min-width: 140px; }
        .duerp-est-field label { display: block; font-size: 0.7rem; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 4px; }
        .duerp-est-field select { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.85rem; background: #f8fafc; }
        .duerp-est-field select.correct { border-color: #22c55e; background: #f0fdf4; }
        .duerp-est-field select.wrong { border-color: #ef4444; background: #fef2f2; }
        .duerp-est-btns { display: flex; gap: 8px; }
        .duerp-est-btn { flex: 1; padding: 8px 10px; border-radius: 6px; border: 2px solid #cbd5e1; background: #fff; cursor: pointer; font-size: 0.8rem; font-weight: 600; text-align: center; transition: all 0.2s; user-select: none; }
        .duerp-est-btn:hover { border-color: #93c5fd; }
        .duerp-est-btn.active { border-color: #2563eb; background: #eff6ff; color: #1e40af; }
        .duerp-est-btn.correct { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .duerp-est-btn.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .duerp-est-btn.show-correct { border-color: #22c55e !important; background: #dcfce7 !important; }
        .duerp-proba-display { text-align: center; background: #f1f5f9; border-radius: 8px; padding: 10px; margin-top: 8px; border: 2px dashed #94a3b8; }
        .duerp-proba-display.visible { border-style: solid; border-color: #8b5cf6; background: #f5f3ff; }
        .duerp-proba-num { font-size: 1.5rem; font-weight: 900; color: #8b5cf6; }
        .duerp-proba-label { font-size: 0.7rem; color: #64748b; }
        .duerp-prio-display { text-align: center; padding: 8px 14px; border-radius: 8px; font-weight: 800; font-size: 0.85rem; margin-top: 8px; }
        .duerp-prio-display.prioritaire { background: rgba(239,68,68,0.12); color: #dc2626; border: 1px solid #fecaca; }
        .duerp-prio-display.non_prioritaire { background: rgba(34,197,94,0.12); color: #16a34a; border: 1px solid #bbf7d0; }
        .duerp-prio-display.empty { background: #f1f5f9; color: #94a3b8; border: 1px dashed #cbd5e1; }
        .duerp-est-correction { font-size: 0.78rem; color: #166534; margin-top: 4px; font-weight: 600; display: none; }
        .duerp-feedback { background: #fffbeb; border: 1px solid #fde68a; border-radius: 10px; padding: 12px; margin-top: 12px; font-size: 0.85rem; display: none; }
        .duerp-feedback.visible { display: block; }
        .duerp-row-separator { border: none; border-top: 2px dashed #cbd5e1; margin: 20px 0; }
        .duerp-mission { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-top: 16px; }
        .duerp-mission-title { font-weight: 800; font-size: 0.95rem; color: #1e293b; margin-bottom: 10px; }
        .duerp-mission-consigne { font-size: 0.88rem; color: #475569; margin-bottom: 12px; line-height: 1.5; }
        .duerp-mission-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: #fff; user-select: none; }
        .duerp-mission-row:hover { border-color: #93c5fd; background: #f0f9ff; }
        .duerp-mission-row.checked { border-color: #2563eb; background: #eff6ff; }
        .duerp-mission-row.correct { border-color: #22c55e !important; background: #f0fdf4 !important; }
        .duerp-mission-row.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; }
        .duerp-mission-row.show-correct { border-color: #22c55e !important; background: #dcfce7 !important; }
        .duerp-mission-cb { width: 20px; height: 20px; border-radius: 4px; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.85rem; color: transparent; transition: all 0.2s; }
        .duerp-mission-row.checked .duerp-mission-cb { border-color: #2563eb; background: #2563eb; color: #fff; }
        .duerp-mission-info { flex: 1; font-size: 0.85rem; color: #334155; }
        .duerp-mission-info strong { color: #1e293b; }
        @media (max-width: 480px) {
            .duerp-estimation { flex-direction: column; }
            .duerp-est-field { min-width: 100%; }
            .duerp-header-title { font-size: 0.95rem; }
            .duerp-mission-row { flex-direction: row; }
        }

        /* ===== DUERP MISSION DIRECTEUR ===== */
        .dm-header { background: linear-gradient(135deg, #0f172a, #1e293b); color: #fff; padding: 20px; border-radius: 12px 12px 0 0; }
        .dm-header-title { font-size: 1.15rem; font-weight: 800; letter-spacing: 0.3px; }
        .dm-header-sub { font-size: 0.8rem; color: #94a3b8; margin-top: 6px; }
        .dm-entreprise { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .dm-entreprise-tag { background: rgba(255,255,255,0.1); padding: 3px 10px; border-radius: 12px; font-size: 0.7rem; color: #cbd5e1; }
        .dm-body { padding: 16px; }
        .dm-rappels { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
        .dm-rappels summary { font-size: 0.9rem; font-weight: 800; color: #0369a1; cursor: pointer; }
        .dm-rappel-item { font-size: 0.82rem; color: #334155; margin-bottom: 8px; line-height: 1.6; }
        .dm-rappel-label { font-weight: 700; color: #0c4a6e; display: block; margin-bottom: 2px; font-size: 0.75rem; text-transform: uppercase; }
        .dm-rappel-list { margin: 4px 0 8px 16px; padding: 0; }
        .dm-rappel-list li { font-size: 0.8rem; color: #334155; margin-bottom: 2px; }
        .dm-section { margin-bottom: 20px; }
        .dm-section-title { font-size: 0.95rem; font-weight: 800; color: #1e293b; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
        .dm-global-q { background: #fefce8; border: 1px solid #fde68a; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
        .dm-q-consigne { font-size: 0.9rem; font-weight: 600; color: #1e293b; margin-bottom: 10px; line-height: 1.5; }
        .dm-q-hint { font-size: 0.75rem; color: #64748b; margin-bottom: 8px; font-style: italic; }
        .dm-qcm-choices { display: flex; flex-direction: column; gap: 6px; }
        .dm-qcm-choice { padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.88rem; transition: all 0.2s; background: #fff; user-select: none; }
        .dm-qcm-choice:hover { border-color: #93c5fd; background: #f0f9ff; }
        .dm-qcm-choice.selected { border-color: #2563eb; background: #eff6ff; color: #1e40af; font-weight: 600; }
        .dm-qcm-choice.correct { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534 !important; }
        .dm-qcm-choice.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .dm-qcm-choice.show-correct { border-color: #22c55e !important; background: #dcfce7 !important; color: #166534 !important; font-weight: 700; }
        .dm-ordre-list { display: flex; flex-direction: column; gap: 8px; }
        .dm-ordre-item { display: flex; align-items: center; gap: 10px; }
        .dm-ordre-select { padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.85rem; background: #f8fafc; width: 50px; text-align: center; }
        .dm-ordre-select.correct { border-color: #22c55e; background: #f0fdf4; }
        .dm-ordre-select.wrong { border-color: #ef4444; background: #fef2f2; }
        .dm-ordre-text { font-size: 0.88rem; color: #334155; }
        .dm-situation-block { margin-bottom: 20px; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .dm-situation-header { background: #1e293b; color: #fff; padding: 12px 16px; font-weight: 700; font-size: 0.9rem; }
        .dm-situation-body { padding: 16px; }
        .dm-situation-text { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; margin-bottom: 16px; line-height: 1.6; font-size: 0.92rem; color: #334155; }
        .dm-situation-text-label { font-size: 0.7rem; color: #2563eb; text-transform: uppercase; font-weight: 700; margin-bottom: 6px; letter-spacing: 0.5px; }
        .dm-sub-section { margin-bottom: 14px; }
        .dm-sub-title { padding: 8px 14px; font-weight: 700; font-size: 0.8rem; color: #fff; border-radius: 8px 8px 0 0; }
        .dm-sub-title.dangers { background: #dc2626; }
        .dm-sub-title.mesures { background: #059669; }
        .dm-sub-body { padding: 10px 14px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; }
        .dm-explication { display: none; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 12px; margin-top: 8px; font-size: 0.82rem; color: #166534; line-height: 1.5; }
        .dm-explication.visible { display: block; }
        .dm-correction { display: none; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 10px; margin-top: 6px; font-size: 0.8rem; color: #1e40af; font-weight: 600; }
        .dm-correction.visible { display: block; }
        .dm-bilan { display: none; background: #fefce8; border: 1px solid #fde68a; border-radius: 8px; padding: 12px; margin-top: 10px; font-size: 0.82rem; color: #854d0e; line-height: 1.5; }
        .dm-bilan.visible { display: block; }
        .dm-mission { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-top: 16px; }
        .dm-mission-title { font-weight: 800; font-size: 0.95rem; color: #1e293b; margin-bottom: 10px; }
        .dm-mission-consigne { font-size: 0.88rem; color: #475569; margin-bottom: 12px; line-height: 1.5; }
        .dm-feedback { background: #fffbeb; border: 1px solid #fde68a; border-radius: 10px; padding: 12px; margin-top: 12px; font-size: 0.85rem; display: none; }
        .dm-feedback.visible { display: block; }
        @media (max-width: 480px) {
            .dm-header-title { font-size: 0.95rem; }
            .dm-entreprise { flex-direction: column; }
        }

        /* ===== QCM CLASSIQUE ===== */
        .qcm-c-question { font-size: 1.1rem; font-weight: 600; color: #1e293b; margin-bottom: 16px; line-height: 1.5; }
        .qcm-c-multi-hint { font-size: 0.8rem; color: #64748b; margin-bottom: 12px; font-style: italic; }
        .qcm-c-choices { display: flex; flex-direction: column; gap: 10px; }
        .qcm-c-choice { padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: all 0.2s; background: #fff; color: #334155; }
        .qcm-c-choice:hover { border-color: #3b82f6; background: #eff6ff; }
        .qcm-c-choice.selected { border-color: #3b82f6; background: #dbeafe; color: #1e40af; font-weight: 600; }
        .qcm-c-choice.correct { border-color: #22c55e !important; background: #dcfce7 !important; color: #166534 !important; }
        .qcm-c-choice.wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b !important; }
        .qcm-c-choice.show-correct { border-color: #22c55e !important; background: #f0fdf4 !important; }
        .qcm-c-explication { margin-top: 16px; padding: 12px 16px; background: #fefce8; border-left: 4px solid #eab308; border-radius: 8px; font-size: 0.9rem; color: #854d0e; }

        /* ===== QUIZ CHRONO ===== */
        .chrono-container { text-align: center; }
        .chrono-progress { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .chrono-dot { width: 14px; height: 14px; border-radius: 50%; background: #e2e8f0; transition: all 0.3s; }
        .chrono-dot.current { background: #3b82f6; transform: scale(1.3); }
        .chrono-dot.done-ok { background: #22c55e; }
        .chrono-dot.done-ko { background: #ef4444; }
        .chrono-timer-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; margin-bottom: 16px; overflow: hidden; }
        .chrono-timer-fill { height: 100%; background: #3b82f6; border-radius: 4px; transition: width 0.25s linear; }
        .chrono-timer-fill.danger { background: #ef4444; }
        .chrono-counter { font-size: 0.85rem; color: #64748b; margin-bottom: 8px; }
        .chrono-question-text { font-size: 1.15rem; font-weight: 700; color: #1e293b; margin-bottom: 20px; line-height: 1.5; }
        .chrono-choices { display: flex; flex-direction: column; gap: 10px; max-width: 500px; margin: 0 auto; }
        .chrono-choice { padding: 16px 20px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; font-size: 1.05rem; transition: all 0.2s; background: #fff; color: #334155; text-align: left; }
        .chrono-choice:hover { border-color: #3b82f6; background: #eff6ff; }
        .chrono-choice.selected-ok { border-color: #22c55e; background: #dcfce7; color: #166534; }
        .chrono-choice.selected-ko { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .chrono-choice.show-correct { border-color: #22c55e; background: #f0fdf4; }

        /* ===== CATEGORISER ===== */
        .cat-consigne { font-size: 0.95rem; color: #64748b; margin-bottom: 16px; }
        .cat-pool { display: flex; flex-wrap: wrap; gap: 10px; padding: 16px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 12px; margin-bottom: 20px; min-height: 50px; justify-content: center; }
        .cat-item { padding: 10px 16px; background: #fff; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; font-size: 0.95rem; color: #334155; transition: all 0.2s; user-select: none; }
        .cat-item:hover { border-color: #3b82f6; }
        .cat-item.selected { border-color: #3b82f6; background: #dbeafe; color: #1e40af; font-weight: 600; transform: scale(1.05); }
        .cat-item.placed { opacity: 0.4; pointer-events: none; }
        .cat-zones { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .cat-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 12px; min-height: 100px; cursor: pointer; transition: all 0.2s; }
        .cat-zone:hover { border-color: #3b82f6; background: #f0f9ff; }
        .cat-zone.highlight { border-color: #3b82f6; background: #eff6ff; }
        .cat-zone-title { font-weight: 700; color: #1e293b; margin-bottom: 10px; text-align: center; font-size: 0.95rem; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
        .cat-placed { display: inline-flex; align-items: center; padding: 8px 12px; background: #e0e7ff; border-radius: 8px; margin: 4px; font-size: 0.85rem; color: #3730a3; cursor: pointer; transition: all 0.2s; }
        .cat-placed:hover { background: #c7d2fe; }
        .cat-placed.correct { background: #dcfce7 !important; color: #166534 !important; }
        .cat-placed.wrong { background: #fef2f2 !important; color: #991b1b !important; text-decoration: line-through; }

        /* ===== MEMORY ===== */
        .mem-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 600px; margin: 0 auto; }
        .mem-card { aspect-ratio: 1; min-height: 80px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; padding: 8px; font-size: 0.85rem; transition: all 0.3s; user-select: none; background: #fff; position: relative; overflow: hidden; }
        .mem-card .mem-back { font-size: 1.8rem; color: #94a3b8; }
        .mem-card .mem-face { display: none; color: #1e293b; font-weight: 600; word-break: break-word; line-height: 1.2; padding: 4px; }
        .mem-card.flipped { border-color: #3b82f6; background: #eff6ff; }
        .mem-card.flipped .mem-back { display: none; }
        .mem-card.flipped .mem-face { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .mem-card.matched { border-color: #22c55e; background: #dcfce7; pointer-events: none; }
        .mem-card.matched .mem-face { color: #166534; }
        .mem-attempts { text-align: center; margin-top: 16px; font-size: 0.9rem; color: #64748b; }
        @media (max-width: 480px) {
            .mem-board { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 350px) {
            .mem-board { grid-template-columns: repeat(2, 1fr); }
        }

        /* ===== SCENARIO ===== */
        .scen-container { max-width: 600px; margin: 0 auto; }
        .scen-progress { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .scen-dot { width: 14px; height: 14px; border-radius: 50%; background: #e2e8f0; transition: all 0.3s; }
        .scen-dot.done-ok { background: #22c55e; }
        .scen-dot.done-ko { background: #ef4444; }
        .scen-dot.current { background: #3b82f6; transform: scale(1.3); }
        .scen-texte { font-size: 1.05rem; color: #1e293b; line-height: 1.6; margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid #3b82f6; }
        .scen-choices { display: flex; flex-direction: column; gap: 10px; }
        .scen-choice { padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: all 0.2s; background: #fff; color: #334155; text-align: left; }
        .scen-choice:hover { border-color: #3b82f6; background: #eff6ff; }
        .scen-choice.selected-correct { border-color: #22c55e; background: #dcfce7; color: #166534; }
        .scen-choice.selected-wrong { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .scen-feedback { margin-top: 12px; padding: 12px 16px; background: #fefce8; border-left: 4px solid #eab308; border-radius: 8px; font-size: 0.9rem; color: #854d0e; }
        .scen-end { text-align: center; padding: 30px; background: #f0fdf4; border-radius: 16px; border: 2px solid #22c55e; }
        .scen-end h3 { color: #166534; margin-bottom: 8px; }
    </style>
</head>
</head>
<body>

<!-- ============================== -->
<!-- SCREEN 1 : SELECTION           -->
<!-- ============================== -->
<div class="screen" id="screen-select">
    <a href="index.html" class="back-home">â† Retour au site PSE</a>
    <div class="exo-header">
        <h1>Exercices en ligne</h1>
        <p>Choisis ton niveau, ton module, et entraine-toi !</p>
    </div>

    <!-- Niveau -->
    <div id="zone-niveaux">
        <div class="theme-label">Choisis ton niveau</div>
        <div class="level-grid" id="level-grid"></div>
        <div class="theme-label" style="color:#f59e0b; margin-top:8px;">Demarche transversale</div>
        <div class="level-grid" id="transversal-grid"></div>
        <div class="theme-label" style="color:#6366f1; margin-top:8px;">Developper ses competences en PSE</div>
        <div class="level-grid" id="competences-grid"></div>
    </div>

    <!-- Modules -->
    <div id="zone-modules" style="display:none;">
        <div id="modules-container"></div>
    </div>

    <!-- Transversal exercises list -->
    <div id="zone-transversal" style="display:none;">
        <div class="theme-label" id="transversal-label" style="color:#f59e0b;">Exercices transversaux</div>
        <div id="transversal-list"></div>
    </div>

    <!-- Competences exercises list -->
    <div id="zone-competences" style="display:none;">
        <div class="theme-label" id="competences-label" style="color:#6366f1;">Competences</div>
        <div id="competences-list"></div>
    </div>

    <!-- Exercices -->
    <div id="zone-exercices" style="display:none;">
        <div class="theme-label" id="exercices-label">Exercices disponibles</div>
        <div id="exercices-list"></div>
    </div>
</div>

<!-- ============================== -->
<!-- SCREEN 2 : PLAY                -->
<!-- ============================== -->
<div class="screen screen-hidden" id="screen-play">
    <div class="play-header">
        <button class="back-btn" onclick="backToList()">â†</button>
        <div>
            <h2 id="play-title">...</h2>
        </div>
        <div class="play-badge" id="play-badge"></div>
    </div>
    <div class="consigne-box" id="play-consigne"></div>
    <div class="game-zone" id="game-zone"></div>
    <button class="btn-validate" id="btn-validate" onclick="validateExercice()">Valider mes reponses</button>
    <div id="zone-results" style="display:none; margin-top:20px;"></div>
</div>

<script>
// =====================================================================
// DATA
// =====================================================================
const NIVEAUX = [
    { key: 'CAP', label: 'CAP' },
    { key: 'BAC_PRO_2NDE', label: '2nde Bac Pro' },
    { key: 'BAC_PRO_1ERE', label: '1ere Bac Pro' },
    { key: 'BAC_PRO_TERM', label: 'Terminale Bac Pro' }
];

const TYPE_ICONS = {
    texte_trous: 'ðŸ“', relier: 'ðŸ”—', ordre: 'ðŸ“‹', hierarchiser: 'â†•ï¸', intrus: 'ðŸ”', pendu: 'ðŸŽ¯',
    mots_croises: 'âœï¸', swipe_vf: 'ðŸ‘†', qcm_image: 'ðŸ–¼ï¸', tableau: 'ðŸ“Š', tableau_selection: 'âœ…', etude_cas: 'ðŸ“–', pad: 'âš ï¸', prevention: 'ðŸ›¡ï¸', estimation_risque: 'ðŸ“Š', duerp_ligne: 'ðŸ“‹', duerp_mini: 'ðŸ“‹', duer_mission_directeur: 'ðŸ“‹',
    qcm_classique: 'ðŸŽ¯', qcm_series_multi: 'ðŸ§ ', quiz_chrono: 'â±ï¸', categoriser: 'ðŸ“‚', memory: 'ðŸƒ', scenario: 'ðŸŽ¬', pictogramme: 'âš ï¸',
    analyse_copie: 'ðŸ“'
};
const TYPE_LABELS = {
    texte_trous: 'Texte a trous', relier: 'Relier', ordre: 'Ordre', hierarchiser: 'Hierarchiser', intrus: 'Intrus',
    pendu: 'Pendu', mots_croises: 'Mots croises', swipe_vf: 'Vrai/Faux',
    qcm_image: 'QCM Image', tableau: 'Tableau', tableau_selection: 'Tableau selection', etude_cas: 'Etude de cas', pad: 'PAD', prevention: 'Prevention', estimation_risque: 'Estimation du risque', duerp_ligne: 'Mission DUERP 1 risque', duerp_mini: 'Mission DUERP 4 risques', duer_mission_directeur: 'Mission DUERP Directeur',
    qcm_classique: 'QCM Classique', qcm_series_multi: 'QCM Serie', quiz_chrono: 'Quiz Chrono', categoriser: 'Categoriser', memory: 'Memory', scenario: 'Scenario', pictogramme: 'Pictogrammes',
    analyse_copie: 'Analyse de copie'
};
const TRANSVERSAL_TYPES = ['pad', 'prevention', 'estimation_risque', 'duerp_ligne', 'duerp_mini', 'duer_mission_directeur', 'pictogramme'];
const AUTO_COMPETENCES_TYPES = ['analyse_copie'];

function isCompetencesExercice(e) {
    return e.categorie === 'competences' || AUTO_COMPETENCES_TYPES.includes(e.type);
}

let allExercices = [];
let currentNiveau = null;
let currentModuleId = null;
let currentExo = null;
let corrected = false;
</script>

<script>
// === MODULES PSE (copie locale pour GitHub Pages) ===
window.MODULES_PSE = {
    "CAP": [
        { id: "MA1", titre: "Le systeme de sante", theme: "A" },
        { id: "MA2", titre: "Le sommeil, un rythme biologique", theme: "A" },
        { id: "MA3", titre: "L'activite physique", theme: "A" },
        { id: "MA4", titre: "Les addictions", theme: "A" },
        { id: "MA5", titre: "La sexualite - La contraception", theme: "A" },
        { id: "MA6", titre: "Prevenir les IST", theme: "A" },
        { id: "MA7", titre: "L'alimentation adaptee a son activite", theme: "A" },
        { id: "MB1", titre: "Les ressources en eau", theme: "B" },
        { id: "MB2", titre: "Le risque majeur", theme: "B" },
        { id: "MB3", titre: "Les ressources en energie", theme: "B" },
        { id: "MB4", titre: "Le bruit au quotidien", theme: "B" },
        { id: "MC1", titre: "Les differents contrats de travail", theme: "C" },
        { id: "MC2", titre: "Les enjeux de la sante et securite au travail", theme: "C" },
        { id: "MC3", titre: "La demarche de prevention (activite)", theme: "C" },
        { id: "MC4", titre: "La demarche de prevention (risque specifique)", theme: "C" },
        { id: "MC5", titre: "Les risques lies a l'activite physique", theme: "C" },
        { id: "MC6", titre: "Les acteurs et organismes de prevention", theme: "C" },
        { id: "MC7", titre: "Le suivi medical et la vaccination", theme: "C" },
        { id: "MD1", titre: "L'assurance", theme: "D" },
        { id: "MD2", titre: "Le budget", theme: "D" },
        { id: "MD3", titre: "Les achats", theme: "D" },
        { id: "CDO", titre: "Chef d'oeuvre", theme: "E" }
    ],
    "BAC_PRO_2NDE": [
        { id: "A1", titre: "Le systeme de sante", theme: "A" },
        { id: "A2", titre: "Les rythmes biologiques - Le sommeil", theme: "A" },
        { id: "A3", titre: "L'activite physique", theme: "A" },
        { id: "A4", titre: "Les addictions", theme: "A" },
        { id: "A5", titre: "La sexualite - La contraception", theme: "A" },
        { id: "B1", titre: "L'alimentation ecoresponsable", theme: "B" },
        { id: "B2", titre: "Les risques majeurs", theme: "B" },
        { id: "C1", titre: "Les enjeux de la sante et securite au travail", theme: "C" },
        { id: "C2", titre: "Les notions de base en prevention", theme: "C" }
    ],
    "BAC_PRO_1ERE": [
        { id: "A6", titre: "Les infections sexuellement transmissibles", theme: "A" },
        { id: "A7", titre: "Les pratiques alimentaires", theme: "A" },
        { id: "A8", titre: "Le stress au quotidien", theme: "A" },
        { id: "B3", titre: "Le bruit au quotidien", theme: "B" },
        { id: "B4", titre: "L'eau et le developpement durable", theme: "B" },
        { id: "C3", titre: "Les acteurs de prevention", theme: "C" },
        { id: "C4", titre: "L'assistance et le secours en milieu professionnel", theme: "C" },
        { id: "C5", titre: "L'analyse des risques professionnels", theme: "C" },
        { id: "C6", titre: "L'analyse d'un risque specifique", theme: "C" }
    ],
    "BAC_PRO_TERM": [
        { id: "A9", titre: "La securite alimentaire", theme: "A" },
        { id: "B5", titre: "Les ressources en energie et developpement durable", theme: "B" },
        { id: "C7", titre: "Le suivi de la sante au travail", theme: "C" },
        { id: "C8", titre: "Declaration et reparation des AT/MP", theme: "C" },
        { id: "C9", titre: "Les risques psychosociaux", theme: "C" },
        { id: "C10", titre: "Les risques lies a l'activite physique", theme: "C" },
        { id: "C11", titre: "L'analyse d'une situation de travail", theme: "C" },
        { id: "C12", titre: "L'egalite de traitement au travail", theme: "C" }
    ]
};
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Load all published exercises
async function loadExercices() {
    const q = query(collection(db, "exercices_banque"), where("publie", "==", true));
    const snap = await getDocs(q);
    allExercices = [];
    snap.forEach(d => allExercices.push({ id: d.id, ...d.data() }));
    console.log("âœ… Exercices charges:", allExercices.length, allExercices.map(e => ({titre: e.titre, niveau: e.niveau, moduleId: e.moduleId})));
    renderNiveaux();
}

window.loadExercices = loadExercices;
loadExercices();

// === GESTION HISTORIQUE NAVIGATEUR (bouton retour) ===
history.replaceState({ screen: 'select' }, '', 'exercices.html');
window.addEventListener('popstate', function(e) {
    if (e.state && e.state.screen === 'play') {
        showScreen('play');
    } else {
        // Si on est en mode play, revenir a select au lieu de quitter la page
        if (!document.getElementById('screen-play').classList.contains('screen-hidden')) {
            showScreen('select');
            currentExo = null;
            corrected = false;
        }
    }
});
</script>

<script>
// =====================================================================
// SCREEN 1 : NAVIGATION
// =====================================================================

function renderNiveaux() {
    const grid = document.getElementById('level-grid');
    grid.innerHTML = '';
    NIVEAUX.forEach(n => {
        const count = allExercices.filter(e => e.niveau === n.key).length;
        const btn = document.createElement('div');
        btn.className = 'level-btn';
        btn.innerHTML = n.label + (count > 0 ? ' <span style="font-size:0.75rem; color:#94a3b8;">(' + count + ')</span>' : '');
        btn.onclick = () => selectNiveau(n.key, btn);
        if (count === 0) { btn.style.opacity = '0.4'; btn.style.cursor = 'default'; btn.onclick = null; }
        grid.appendChild(btn);
    });

    // Transversal buttons
    const transGrid = document.getElementById('transversal-grid');
    if (!transGrid) return;
    transGrid.innerHTML = '';
    const TRANSVERSAL_BTNS = [
        { type: 'pad', label: 'âš ï¸ PAD', color: '#f59e0b' },
        { type: 'estimation_risque', label: 'ðŸ“Š Estimation du risque', color: '#8b5cf6' },
        { type: 'prevention', label: 'ðŸ›¡ï¸ Mesures de prevention', color: '#22c55e' },
        { type: 'duerp_ligne', label: 'ðŸ“‹ Mission DUERP 1 risque', color: '#1e293b' },
        { type: 'duerp_mini', label: 'ðŸ“‹ Mission DUERP 4 risques', color: '#1e293b' },
        { type: 'duer_mission_directeur', label: 'ðŸ“‹ Mission DUERP Directeur', color: '#0f172a' },
        { type: 'pictogramme', label: 'âš ï¸ Pictogrammes', color: '#b45309' }
    ];
    TRANSVERSAL_BTNS.forEach(t => {
        const count = allExercices.filter(e => TRANSVERSAL_TYPES.includes(e.type) && e.type === t.type).length;
        const btn = document.createElement('div');
        btn.className = 'level-btn level-btn-trans';
        btn.style.borderColor = t.color;
        btn.style.color = t.color;
        btn.innerHTML = t.label + (count > 0 ? ' <span style="font-size:0.75rem; opacity:0.7;">(' + count + ')</span>' : '');
        btn.onclick = () => selectTransversal(t.type, btn);
        if (count === 0) { btn.style.opacity = '0.4'; btn.style.cursor = 'default'; btn.onclick = null; }
        transGrid.appendChild(btn);
    });

    // Competences buttons
    const compGrid = document.getElementById('competences-grid');
    if (compGrid) {
        compGrid.innerHTML = '';
        const count = allExercices.filter(e => isCompetencesExercice(e)).length;
        const btn = document.createElement('div');
        btn.className = 'level-btn level-btn-trans';
        btn.style.borderColor = '#6366f1';
        btn.style.color = '#6366f1';
        btn.innerHTML = 'ðŸ“ Competences' + (count > 0 ? ' <span style="font-size:0.75rem; opacity:0.7;">(' + count + ')</span>' : '');
        btn.onclick = () => selectCompetences(btn);
        if (count === 0) { btn.style.opacity = '0.4'; btn.style.cursor = 'default'; btn.onclick = null; }
        compGrid.appendChild(btn);
    }
}

function selectNiveau(niveauKey, btnEl) {
    currentNiveau = niveauKey;
    currentModuleId = null;
    document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
    document.getElementById('zone-modules').style.display = '';
    document.getElementById('zone-exercices').style.display = 'none';
    document.getElementById('zone-transversal').style.display = 'none';
    document.getElementById('zone-competences').style.display = 'none';
    renderModules(niveauKey);
    setTimeout(() => { document.getElementById('zone-modules').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

function selectTransversal(type, btnEl) {
    currentNiveau = null;
    currentModuleId = null;
    document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
    document.getElementById('zone-modules').style.display = 'none';
    document.getElementById('zone-exercices').style.display = 'none';
    document.getElementById('zone-competences').style.display = 'none';
    // Show transversal exercises zone
    document.getElementById('zone-transversal').style.display = '';
    renderTransversal(type);
    setTimeout(() => { document.getElementById('zone-transversal').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

function renderModules(niveauKey) {
    const container = document.getElementById('modules-container');
    container.innerHTML = '<div class="theme-label">Choisis ton module</div>';
    const modules = window.MODULES_PSE[niveauKey] || [];
    const exosForNiveau = allExercices.filter(e => e.niveau === niveauKey);
    let currentTheme = '';
    let grid = null;

    modules.forEach(m => {
        if (m.parent) return;
        if (m.theme !== currentTheme) {
            currentTheme = m.theme;
            // Nouvelle grille pour chaque theme
            grid = document.createElement('div');
            grid.className = 'module-grid';
            const label = document.createElement('div');
            label.className = 'theme-label';
            const themeNames = { A: 'Sante', B: 'Environnement', C: 'Travail', D: 'Consommation', E: "Chef d'oeuvre" };
            label.textContent = 'Theme ' + m.theme + ' â€” ' + (themeNames[m.theme] || '');
            container.appendChild(label);
            container.appendChild(grid);
        }
        const count = exosForNiveau.filter(e => e.moduleId === m.id).length;
        const btn = document.createElement('div');
        btn.className = 'module-btn';
        btn.innerHTML = '<span class="mod-id">' + m.id + '</span> ' + m.titre +
            (count > 0 ? ' <span style="font-size:0.75rem; color:#94a3b8;">(' + count + ')</span>' : '');
        btn.onclick = () => selectModule(m.id, btn);
        if (count === 0) { btn.style.opacity = '0.4'; btn.style.cursor = 'default'; btn.onclick = null; }
        grid.appendChild(btn);
    });
}

function renderTransversal(type) {
    const container = document.getElementById('transversal-list');
    if (!container) return;
    container.innerHTML = '';
    var transExos = allExercices.filter(e => e.type === type);
    var label = document.getElementById('transversal-label');
    var typeNames = { pad: 'âš ï¸ PAD â€” Analyse des risques', prevention: 'ðŸ›¡ï¸ Mesures de prevention', estimation_risque: 'ðŸ“Š Estimation du risque', duerp_ligne: 'ðŸ“‹ Mission DUERP â€” 1 risque', duerp_mini: 'ðŸ“‹ Mission DUERP â€” 4 risques', duer_mission_directeur: 'ðŸ“‹ Mission DUERP â€” Directeur', pictogramme: 'âš ï¸ Pictogrammes â€” Securite' };
    if (label) label.textContent = (typeNames[type] || type) + ' â€” ' + transExos.length + ' exercice' + (transExos.length > 1 ? 's' : '');
    if (transExos.length === 0) {
        container.innerHTML = '<div class="empty-msg">Aucun exercice de ce type pour le moment.</div>';
        return;
    }
    transExos.forEach(ex => {
        const card = document.createElement('div');
        card.className = 'exo-card';
        card.innerHTML = '<div class="exo-icon">' + (TYPE_ICONS[ex.type] || 'ðŸ“Œ') + '</div>' +
            '<div class="exo-info"><h3>' + (ex.titre || 'Sans titre') + '</h3>' +
            '<div class="exo-meta">' +
            '<span class="exo-badge badge-type">' + (TYPE_LABELS[ex.type] || ex.type) + '</span>' +
            (ex.difficulte ? '<span class="exo-badge badge-' + ex.difficulte + '">' + ex.difficulte + '</span>' : '') +
            '</div></div>';
        card.onclick = () => startExercice(ex);
        container.appendChild(card);
    });
}

function selectCompetences(btnEl) {
    currentNiveau = null;
    currentModuleId = null;
    document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
    document.getElementById('zone-modules').style.display = 'none';
    document.getElementById('zone-exercices').style.display = 'none';
    document.getElementById('zone-transversal').style.display = 'none';
    document.getElementById('zone-competences').style.display = '';
    renderCompetences();
    setTimeout(() => { document.getElementById('zone-competences').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

function renderCompetences() {
    const container = document.getElementById('competences-list');
    if (!container) return;
    container.innerHTML = '';
    var exos = allExercices.filter(e => isCompetencesExercice(e));
    var label = document.getElementById('competences-label');
    if (label) label.textContent = 'ðŸ“ Competences PSE â€” ' + exos.length + ' exercice' + (exos.length > 1 ? 's' : '');
    if (exos.length === 0) {
        container.innerHTML = '<div class="empty-msg">Aucun exercice de competences pour le moment.</div>';
        return;
    }
    exos.forEach(ex => {
        const card = document.createElement('div');
        card.className = 'exo-card';
        card.innerHTML = '<div class="exo-icon">' + (TYPE_ICONS[ex.type] || 'ðŸ“') + '</div>' +
            '<div class="exo-info"><h3>' + (ex.titre || 'Sans titre') + '</h3>' +
            '<div class="exo-meta"><span class="exo-badge badge-type">' + (TYPE_LABELS[ex.type] || ex.type) + '</span>' +
            (ex.difficulte ? '<span class="exo-badge badge-' + ex.difficulte + '">' + ex.difficulte + '</span>' : '') +
            '</div></div>';
        card.onclick = () => startExercice(ex);
        container.appendChild(card);
    });
}

function selectModule(moduleId, btnEl) {
    currentModuleId = moduleId;
    document.querySelectorAll('.module-btn').forEach(b => b.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
    document.getElementById('zone-exercices').style.display = '';
    renderExercicesList();
    setTimeout(() => { document.getElementById('zone-exercices').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

function renderExercicesList() {
    const list = document.getElementById('exercices-list');
    list.innerHTML = '';
    const isAll = currentModuleId === '__ALL__';
    const exos = isAll
        ? allExercices.filter(e => e.niveau === currentNiveau && !TRANSVERSAL_TYPES.includes(e.type) && !isCompetencesExercice(e))
        : allExercices.filter(e => e.niveau === currentNiveau && e.moduleId === currentModuleId && !TRANSVERSAL_TYPES.includes(e.type) && !isCompetencesExercice(e));
    const label = document.getElementById('exercices-label');
    label.textContent = (isAll ? 'Tous les exercices â€” ' : '') + exos.length + ' exercice' + (exos.length > 1 ? 's' : '') + ' disponible' + (exos.length > 1 ? 's' : '');

    if (exos.length === 0) {
        list.innerHTML = '<div class="empty-msg">Aucun exercice ' + (isAll ? 'pour ce niveau' : 'pour ce module') + '.</div>';
        return;
    }
    // Trouver les noms de modules pour affichage
    const modulesMap = {};
    Object.values(window.MODULES_PSE || {}).forEach(arr => arr.forEach(m => { modulesMap[m.id] = m.id + ' â€” ' + m.titre; }));

    exos.forEach(ex => {
        const card = document.createElement('div');
        card.className = 'exo-card';
        const moduleLabel = isAll && ex.moduleId ? '<span class="exo-badge" style="background:#e0e7ff; color:#3730a3;">' + (modulesMap[ex.moduleId] || ex.moduleId) + '</span>' : '';
        card.innerHTML = '<div class="exo-icon">' + (TYPE_ICONS[ex.type] || 'ðŸ“„') + '</div>' +
            '<div class="exo-info"><h3>' + (ex.titre || 'Sans titre') + '</h3>' +
            '<div class="exo-meta">' +
            '<span class="exo-badge badge-type">' + (TYPE_LABELS[ex.type] || ex.type) + '</span>' +
            (ex.difficulte ? '<span class="exo-badge badge-' + ex.difficulte + '">' + ex.difficulte + '</span>' : '') +
            moduleLabel +
            '</div></div>';
        card.onclick = () => startExercice(ex);
        list.appendChild(card);
    });
}

// =====================================================================
// SCREEN 2 : PLAY
// =====================================================================

function showScreen(name) {
    document.getElementById('screen-select').classList.toggle('screen-hidden', name !== 'select');
    document.getElementById('screen-play').classList.toggle('screen-hidden', name !== 'play');
}

function backToList(fromPopstate) {
    showScreen('select');
    currentExo = null;
    corrected = false;
    if (!fromPopstate) history.pushState({ screen: 'select' }, '', 'exercices.html');
}

function startExercice(ex) {
    console.log('ðŸ” DEBUG startExercice:', ex.titre, ex.type, 'contenu:', JSON.stringify(ex.contenu));
    currentExo = ex;
    corrected = false;
    document.getElementById('play-title').textContent = ex.titre || 'Exercice';
    document.getElementById('play-badge').innerHTML = '<span class="exo-badge badge-type">' + (TYPE_LABELS[ex.type] || '') + '</span>';
    document.getElementById('play-consigne').textContent = (ex.contenu && ex.contenu.consigne) || '';
    document.getElementById('btn-validate').style.display = '';
    document.getElementById('btn-validate').disabled = false;
    document.getElementById('zone-results').style.display = 'none';
    document.getElementById('zone-results').innerHTML = '';

    const zone = document.getElementById('game-zone');
    zone.innerHTML = '';

    // Render based on type
    const renderers = {
        texte_trous: renderTexteTrous,
        relier: renderRelier,
        ordre: renderOrdre,
        hierarchiser: renderOrdre,
        intrus: renderIntrus,
        pendu: renderPendu,
        mots_croises: renderMotsCroises,
        swipe_vf: renderSwipeVF,
        qcm_image: renderQcmImage,
        tableau: renderTableau,
        tableau_selection: renderTableauSelection,
        etude_cas: renderEtudeCas,
        pad: renderPad,
        prevention: renderPrevention,
        estimation_risque: renderEstimation,
        duerp_ligne: renderDuerpLigne,
        duerp_mini: renderDuerpMini,
        duer_mission_directeur: renderDuerMissionDirecteur,
        qcm_classique: renderQcmClassique,
        qcm_series_multi: renderQcmSeriesMulti,
        quiz_chrono: renderQuizChrono,
        categoriser: renderCategoriser,
        memory: renderMemory,
        scenario: renderScenario,
        pictogramme: renderPictogramme,
        analyse_copie: renderAnalyseCopie
    };

    const renderer = renderers[ex.type];
    if (renderer) renderer(zone, ex.contenu);
    else zone.innerHTML = '<div class="empty-msg">Type d\'exercice non supporte.</div>';

    // Auto-validating types: hide Valider button
    if (ex.type === 'pendu' || ex.type === 'swipe_vf' || ex.type === 'quiz_chrono' || ex.type === 'memory' || ex.type === 'scenario' || (ex.type === 'pictogramme' && (ex.contenu.mode === 'memory' || ex.contenu.mode === 'speed' || ex.contenu.mode === 'quiz_image' || ex.contenu.mode === 'nom_vers_image' || ex.contenu.mode === 'escape_game'))) {
        document.getElementById('btn-validate').style.display = 'none';
    }

    showScreen('play');
    history.pushState({ screen: 'play' }, '', 'exercices.html#play');
    window.scrollTo(0, 0);
}

// =====================================================================
// NORMALIZE TEXT (accent + case insensitive)
// =====================================================================
function norm(t) {
    return (t || '').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

// =====================================================================
// RENDERERS
// =====================================================================

// --- 1. TEXTE A TROUS ---
function renderTexteTrous(zone, c) {
    console.log('ðŸ” DEBUG renderTexteTrous contenu:', JSON.stringify(c));
    // Robustesse : chercher le texte dans plusieurs emplacements possibles
    var texte = '';
    if (c && typeof c === 'object') {
        texte = c.texte || c.text || c.texte_complet || '';
    } else if (typeof c === 'string') {
        texte = c;
    }
    // Si toujours vide, chercher dans currentExo au cas ou la structure est plate
    if (!texte && currentExo) {
        texte = currentExo.texte || currentExo.text || '';
    }
    if (!texte) {
        zone.innerHTML = '<div style="padding:20px;color:#ef4444;font-weight:600;text-align:center;">' +
            'âš ï¸ Erreur : le texte de cet exercice est vide.<br>' +
            '<span style="font-size:0.85rem;color:#64748b;font-weight:400;">Verifiez dans l\'editeur que le champ "Texte" contient du texte avec des {{mots}} entre doubles accolades.</span>' +
            '<br><button onclick="console.log(JSON.stringify(currentExo,null,2));alert(\'Donnees copiees dans la console (F12)\')" style="margin-top:12px;padding:6px 14px;border-radius:6px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;font-size:0.85rem;">ðŸ” Voir les donnees brutes</button>' +
            '</div>';
        return;
    }
    const parts = texte.split(/(\{\{[^}]+\}\})/g);
    const mode = c.mode || 'input';
    const answers = [];
    parts.forEach(part => {
        const m = part.match(/^\{\{(.+)\}\}$/);
        if (m) answers.push(m[1]);
    });
    const optionPool = [...new Set(answers)];
    let idx = 0;
    let html = '<div class="tt-texte">';
    parts.forEach(part => {
        const m = part.match(/^\{\{(.+)\}\}$/);
        if (m) {
            const answer = m[1];
            if (mode === 'dropdown') {
                const shuffled = [...optionPool].sort(() => Math.random() - 0.5);
                let opts = '<option value="">...</option>';
                shuffled.forEach(opt => {
                    opts += '<option value="' + opt.replace(/"/g, '&quot;') + '">' + opt + '</option>';
                });
                html += '<select class="tt-select" data-answer="' + answer.replace(/"/g, '&quot;') + '" data-idx="' + idx + '">' + opts + '</select>';
            } else {
                const hint = c.indice ? ' <span class="tt-hint">(' + answer.split('').sort(() => Math.random() - 0.5).join('') + ')</span>' : '';
                html += '<input type="text" class="tt-input" data-answer="' + answer.replace(/"/g, '&quot;') + '" data-idx="' + idx + '" autocomplete="off">' + hint;
            }
            idx++;
        } else {
            html += part;
        }
    });
    html += '</div>';
    zone.innerHTML = html;
}

// --- 2. RELIER ---
var relierState = { selected: null, pairs: [], correctPairs: [] };

function renderRelier(zone, c) {
    const paires = c.paires || [];
    relierState = { selected: null, pairs: [], correctPairs: paires };
    const shuffledLeft = paires.map((p, i) => ({ text: p.gauche, idx: i }));
    const shuffledRight = paires.map((p, i) => ({ text: p.droite, idx: i }));
    shuffledRight.sort(() => Math.random() - 0.5);

    let html = '<div class="relier-container">';
    html += '<div class="relier-col" id="rel-col-left">';
    shuffledLeft.forEach(item => {
        html += '<div class="relier-item" data-side="left" data-idx="' + item.idx + '" onclick="relierClick(this)">' + item.text + '</div>';
    });
    html += '</div>';
    html += '<div class="relier-col" id="rel-col-right">';
    shuffledRight.forEach(item => {
        html += '<div class="relier-item" data-side="right" data-idx="' + item.idx + '" onclick="relierClick(this)">' + item.text + '</div>';
    });
    html += '</div></div>';
    html += '<div class="relier-pairs-display" id="relier-pairs-display"></div>';
    zone.innerHTML = html;
}

function relierClick(el) {
    if (corrected || el.classList.contains('matched')) return;
    const side = el.dataset.side;
    if (relierState.selected && relierState.selected.dataset.side === side) {
        relierState.selected.classList.remove('selected');
        if (relierState.selected === el) { relierState.selected = null; return; }
    }
    if (relierState.selected && relierState.selected.dataset.side !== side) {
        const leftEl = side === 'left' ? el : relierState.selected;
        const rightEl = side === 'right' ? el : relierState.selected;
        const pairIndex = relierState.pairs.length;
        var colorClass = 'pair-' + (pairIndex % 20);
        relierState.pairs.push({ leftIdx: parseInt(leftEl.dataset.idx), rightIdx: parseInt(rightEl.dataset.idx), leftText: leftEl.textContent, rightText: rightEl.textContent, colorClass: colorClass });
        leftEl.classList.remove('selected');
        leftEl.classList.add('matched', colorClass);
        rightEl.classList.add('matched', colorClass);
        relierState.selected = null;
        renderRelierPairs();
    } else {
        if (relierState.selected) relierState.selected.classList.remove('selected');
        el.classList.add('selected');
        relierState.selected = el;
    }
}

function renderRelierPairs() {
    const display = document.getElementById('relier-pairs-display');
    display.innerHTML = '';
    relierState.pairs.forEach((p, i) => {
        const tag = document.createElement('div');
        tag.className = 'relier-pair-tag ' + p.colorClass;
        tag.innerHTML = p.leftText + ' â†” ' + p.rightText + ' <span class="remove-pair" onclick="removeRelierPair(' + i + ')">&times;</span>';
        display.appendChild(tag);
    });
}

function removeRelierPair(i) {
    if (corrected) return;
    const pair = relierState.pairs.splice(i, 1)[0];
    // Unmatch items and remove color
    document.querySelectorAll('.relier-item').forEach(el => {
        const idx = parseInt(el.dataset.idx);
        const side = el.dataset.side;
        if ((side === 'left' && idx === pair.leftIdx) || (side === 'right' && idx === pair.rightIdx)) {
            el.classList.remove('matched');
            for (var c = 0; c < 20; c++) el.classList.remove('pair-' + c);
        }
    });
    // Reassign color classes after removal
    relierState.pairs.forEach((p, j) => {
        p.colorClass = 'pair-' + (j % 20);
        document.querySelectorAll('.relier-item').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            const side = el.dataset.side;
            if ((side === 'left' && idx === p.leftIdx) || (side === 'right' && idx === p.rightIdx)) {
                for (var c = 0; c < 20; c++) el.classList.remove('pair-' + c);
                el.classList.add(p.colorClass);
            }
        });
    });
    renderRelierPairs();
}

// --- 3. ORDRE ---
function renderOrdre(zone, c) {
    const items = [...(c.items || [])];
    const shuffled = items.map((text, correctIdx) => ({ text, correctIdx })).sort(() => Math.random() - 0.5);
    const n = shuffled.length;
    let html = '<div class="ordre-list" id="ordre-list">';
    shuffled.forEach((item, i) => {
        let opts = '';
        for (let k = 1; k <= n; k++) {
            opts += '<option value="' + k + '"' + (k === (i + 1) ? ' selected' : '') + '>' + k + '</option>';
        }
        html += '<div class="ordre-item" data-correct="' + item.correctIdx + '">' +
            '<select class="ordre-select" onchange="ordreSelectChanged(this)">' + opts + '</select>' +
            '<span class="ordre-text">' + item.text + '</span>' +
            '</div>';
    });
    html += '</div>';
    html += '<div class="ordre-actions"><button type="button" class="ordre-remelanger" onclick="ordreRemelanger()">ðŸ”„ Remelanger</button></div>';
    zone.innerHTML = html;
}

function ordreSelectChanged(sel) {
    if (corrected) return;
    const row = sel.closest('.ordre-item');
    if (!row) return;
    const list = row.parentElement;
    if (!list) return;
    const rows = [...list.children];
    const n = rows.length;
    const targetPos = Math.max(1, Math.min(n, parseInt(sel.value, 10) || 1));
    const targetIdx = targetPos - 1;

    // Repositionner la ligne au rang choisi
    list.removeChild(row);
    const remaining = [...list.children];
    if (targetIdx >= remaining.length) list.appendChild(row);
    else list.insertBefore(row, remaining[targetIdx]);

    // Re-synchroniser les selects avec l'ordre visuel actuel
    [...list.children].forEach((it, i) => {
        const s = it.querySelector('.ordre-select');
        if (s) s.value = String(i + 1);
        it.style.borderColor = '#e2e8f0';
    });
    row.style.borderColor = '#3b82f6';
}

function ordreRemelanger() {
    if (corrected || !currentExo || !currentExo.contenu) return;
    const zone = document.getElementById('game-zone');
    renderOrdre(zone, currentExo.contenu);
}

// --- 4. INTRUS ---
function renderIntrus(zone, c) {
    const series = c.series || [];
    let html = '';
    series.forEach((s, si) => {
        const safeIntrus = Math.min(Math.max(parseInt(s.intrus) || 0, 0), s.items.length - 1);
        html += '<div class="intrus-serie" data-intrus="' + safeIntrus + '" data-serie="' + si + '">';
        html += '<h4>Serie ' + (si + 1) + '</h4>';
        html += '<div class="intrus-items">';
        s.items.forEach((item, ii) => {
            html += '<div class="intrus-item" data-item-idx="' + ii + '" data-serie="' + si + '" onclick="intrusClick(this)">' + item + '</div>';
        });
        html += '</div>';
        html += '<div class="intrus-explication" id="intrus-expl-' + si + '">' + (s.explication || '') + '</div>';
        html += '</div>';
    });
    zone.innerHTML = html;
}

function intrusClick(el) {
    if (corrected) return;
    const serie = el.dataset.serie;
    document.querySelectorAll('.intrus-item[data-serie="' + serie + '"]').forEach(it => it.classList.remove('selected'));
    el.classList.add('selected');
}

// --- 5. PENDU ---
var penduState = {};

function renderPendu(zone, c) {
    const mots = c.mots || [];
    penduState = { mots, current: 0, errors: 0, maxErrors: 8, found: [], results: [] };
    zone.innerHTML = '<div class="pendu-zone" id="pendu-zone"></div>';
    renderPenduMot();
}

function renderPenduMot() {
    const z = document.getElementById('pendu-zone');
    const s = penduState;
    if (s.current >= s.mots.length) { finishPendu(); return; }
    const motObj = s.mots[s.current];
    if (!motObj || !motObj.mot) { finishPendu(); return; }
    const mot = motObj.mot.toUpperCase();
    s.errors = 0;
    s.found = [];
    const display = mot.split('').map(() => '_').join(' ');

    let html = '<div class="pendu-status">Mot ' + (s.current + 1) + ' / ' + s.mots.length + '</div>';
    html += renderPenduSvg(0);
    html += '<div class="pendu-mot" id="pendu-display">' + display + '</div>';
    html += '<div class="pendu-indice">Indice : ' + (motObj.indice || 'â€”') + '</div>';
    html += '<div class="pendu-erreurs" id="pendu-erreurs"></div>';
    html += '<div class="pendu-clavier" id="pendu-clavier">';
    'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(l => {
        html += '<div class="pendu-key" data-letter="' + l + '" onclick="penduGuess(\'' + l + '\', this)">' + l + '</div>';
    });
    html += '</div>';
    html += '<div class="pendu-nav" id="pendu-nav" style="display:none;"><button class="pendu-next" onclick="penduNext()">Mot suivant â†’</button></div>';
    z.innerHTML = html;
}

function renderPenduSvg(errors) {
    const parts = [
        '<line x1="20" y1="140" x2="80" y2="140" stroke="#1e293b" stroke-width="3"/>',  // base
        '<line x1="50" y1="140" x2="50" y2="20" stroke="#1e293b" stroke-width="3"/>',    // poteau
        '<line x1="50" y1="20" x2="110" y2="20" stroke="#1e293b" stroke-width="3"/>',    // traverse
        '<line x1="110" y1="20" x2="110" y2="40" stroke="#1e293b" stroke-width="3"/>',   // corde
        '<circle cx="110" cy="52" r="12" stroke="#1e293b" stroke-width="3" fill="none"/>', // tete
        '<line x1="110" y1="64" x2="110" y2="100" stroke="#1e293b" stroke-width="3"/>',   // corps
        '<line x1="110" y1="75" x2="90" y2="90" stroke="#1e293b" stroke-width="3"/><line x1="110" y1="75" x2="130" y2="90" stroke="#1e293b" stroke-width="3"/>', // bras
        '<line x1="110" y1="100" x2="90" y2="125" stroke="#1e293b" stroke-width="3"/><line x1="110" y1="100" x2="130" y2="125" stroke="#1e293b" stroke-width="3"/>'  // jambes
    ];
    let svg = '<svg class="pendu-svg" width="150" height="150" viewBox="0 0 150 150">';
    for (let i = 0; i < Math.min(errors, parts.length); i++) svg += parts[i];
    svg += '</svg>';
    return svg;
}

function penduGuess(letter, keyEl) {
    const s = penduState;
    if (keyEl.classList.contains('used-ok') || keyEl.classList.contains('used-ko')) return;
    if (!s.mots[s.current] || !s.mots[s.current].mot) return;
    const mot = s.mots[s.current].mot.toUpperCase();
    if (mot.includes(letter)) {
        keyEl.classList.add('used-ok');
        s.found.push(letter);
    } else {
        keyEl.classList.add('used-ko');
        s.errors++;
    }
    // Update display
    const display = mot.split('').map(l => s.found.includes(l) ? l : '_').join(' ');
    document.getElementById('pendu-display').textContent = display;
    document.getElementById('pendu-erreurs').textContent = s.errors > 0 ? s.errors + ' / ' + s.maxErrors + ' erreurs' : '';

    // Update SVG
    const svgContainer = document.querySelector('.pendu-svg');
    if (svgContainer) svgContainer.outerHTML = renderPenduSvg(s.errors);

    // Check win/lose
    const won = mot.split('').every(l => s.found.includes(l));
    const lost = s.errors >= s.maxErrors;
    if (won || lost) {
        s.results.push({
            mot: mot,
            won,
            errors: s.errors,
            explication: (s.mots[s.current] && s.mots[s.current].explication) ? s.mots[s.current].explication : ''
        });
        // Disable keyboard
        document.querySelectorAll('.pendu-key').forEach(k => { if (!k.classList.contains('used-ok') && !k.classList.contains('used-ko')) { k.style.opacity = '0.3'; k.style.cursor = 'default'; k.onclick = null; } });
        if (lost) document.getElementById('pendu-display').textContent = mot.split('').join(' ');
        document.getElementById('pendu-nav').style.display = '';
    }
}

function penduNext() {
    penduState.current++;
    renderPenduMot();
}

function finishPendu() {
    const s = penduState;
    const correct = s.results.filter(r => r.won).length;
    const total = s.results.length;
    showResults(correct, total, s.results.map(r => ({
        ok: r.won,
        label: r.mot,
        detail: r.won ? 'Trouve !' : 'Non trouve (' + r.errors + ' erreurs)',
        explication: r.explication || ''
    })));
}

// --- 6. MOTS CROISES ---
function renderMotsCroises(zone, c) {
    const mots = (c.mots || []).filter(m => m.mot && m.mot.trim());
    if (mots.length === 0) { zone.innerHTML = '<div class="empty-msg">Aucun mot.</div>'; return; }

    // Generate grid
    const grid = generateCrosswordGrid(mots);
    let html = '<div class="mc-container">';
    html += '<div class="mc-grid-wrap"><table class="mc-grid" id="mc-grid">';
    for (let r = 0; r < grid.rows; r++) {
        html += '<tr>';
        for (let col = 0; col < grid.cols; col++) {
            const cell = grid.cells[r + ',' + col];
            if (cell) {
                const numHtml = cell.num ? '<span class="mc-num">' + cell.num + '</span>' : '';
                html += '<td>' + numHtml + '<input type="text" maxlength="1" data-r="' + r + '" data-c="' + col + '" data-answer="' + cell.letter + '" autocomplete="off" oninput="mcAutoMove(this)"></td>';
            } else {
                html += '<td class="mc-empty"></td>';
            }
        }
        html += '</tr>';
    }
    html += '</table></div>';

    // Definitions
    html += '<div class="mc-defs">';
    if (grid.horizontal.length > 0) {
        html += '<h4>Horizontal â†’</h4><ol>';
        grid.horizontal.forEach(w => { html += '<li value="' + w.num + '">' + w.definition + '</li>'; });
        html += '</ol>';
    }
    if (grid.vertical.length > 0) {
        html += '<h4>Vertical â†“</h4><ol>';
        grid.vertical.forEach(w => { html += '<li value="' + w.num + '">' + w.definition + '</li>'; });
        html += '</ol>';
    }
    html += '</div></div>';
    zone.innerHTML = html;
}

function mcAutoMove(inp) {
    if (inp.value.length === 1) {
        // Move to next input in same row
        const td = inp.closest('td');
        const nextTd = td.nextElementSibling;
        if (nextTd && nextTd.querySelector('input')) {
            nextTd.querySelector('input').focus();
        }
    }
}

function generateCrosswordGrid(mots) {
    // Simple crossword placement algorithm
    mots.sort((a, b) => b.mot.length - a.mot.length);
    const placed = [];
    const cells = {};
    let minR = 0, maxR = 0, minC = 0, maxC = 0;
    let numCounter = 1;
    const horizontal = [];
    const vertical = [];

    // Place first word horizontally at origin
    const first = mots[0];
    const firstMot = first.mot.toUpperCase();
    for (let i = 0; i < firstMot.length; i++) {
        cells['0,' + i] = { letter: firstMot[i], num: i === 0 ? numCounter : null };
    }
    horizontal.push({ num: numCounter, definition: first.definition, mot: firstMot });
    numCounter++;
    placed.push({ mot: firstMot, r: 0, c: 0, dir: 'h', definition: first.definition });
    maxC = firstMot.length - 1;

    // Try to place remaining words
    for (let mi = 1; mi < mots.length; mi++) {
        const word = mots[mi].mot.toUpperCase();
        let bestPlacement = null;

        for (let pi = 0; pi < placed.length; pi++) {
            const pw = placed[pi];
            for (let pwi = 0; pwi < pw.mot.length; pwi++) {
                for (let wi = 0; wi < word.length; wi++) {
                    if (word[wi] !== pw.mot[pwi]) continue;
                    // Try perpendicular placement
                    const newDir = pw.dir === 'h' ? 'v' : 'h';
                    let startR, startC;
                    if (pw.dir === 'h') {
                        startR = pw.r - wi;
                        startC = pw.c + pwi;
                    } else {
                        startR = pw.r + pwi;
                        startC = pw.c - wi;
                    }
                    // Check if placement is valid
                    let valid = true;
                    for (let k = 0; k < word.length; k++) {
                        const r = newDir === 'h' ? startR : startR + k;
                        const c = newDir === 'h' ? startC + k : startC;
                        const existing = cells[r + ',' + c];
                        if (existing) {
                            if (existing.letter !== word[k]) { valid = false; break; }
                        } else {
                            // Check adjacent cells (avoid parallel words touching)
                            if (newDir === 'h') {
                                if (cells[(r - 1) + ',' + c] && !(k === wi && pw.dir === 'v')) { valid = false; break; }
                                if (cells[(r + 1) + ',' + c] && !(k === wi && pw.dir === 'v')) { valid = false; break; }
                            } else {
                                if (cells[r + ',' + (c - 1)] && !(k === wi && pw.dir === 'h')) { valid = false; break; }
                                if (cells[r + ',' + (c + 1)] && !(k === wi && pw.dir === 'h')) { valid = false; break; }
                            }
                        }
                    }
                    // Check before and after
                    if (valid) {
                        const beforeR = newDir === 'h' ? startR : startR - 1;
                        const beforeC = newDir === 'h' ? startC - 1 : startC;
                        const afterR = newDir === 'h' ? startR : startR + word.length;
                        const afterC = newDir === 'h' ? startC + word.length : startC;
                        if (cells[beforeR + ',' + beforeC]) valid = false;
                        if (cells[afterR + ',' + afterC]) valid = false;
                    }
                    if (valid && !bestPlacement) {
                        bestPlacement = { r: startR, c: startC, dir: newDir, intersect: wi };
                    }
                }
            }
        }

        if (bestPlacement) {
            const { r, c, dir } = bestPlacement;
            for (let k = 0; k < word.length; k++) {
                const cr = dir === 'h' ? r : r + k;
                const cc = dir === 'h' ? c + k : c;
                if (!cells[cr + ',' + cc]) {
                    cells[cr + ',' + cc] = { letter: word[k], num: k === 0 ? numCounter : null };
                } else if (k === 0 && !cells[cr + ',' + cc].num) {
                    cells[cr + ',' + cc].num = numCounter;
                }
                minR = Math.min(minR, cr); maxR = Math.max(maxR, cr);
                minC = Math.min(minC, cc); maxC = Math.max(maxC, cc);
            }
            if (dir === 'h') horizontal.push({ num: numCounter, definition: mots[mi].definition, mot: word });
            else vertical.push({ num: numCounter, definition: mots[mi].definition, mot: word });
            numCounter++;
            placed.push({ mot: word, r, c, dir, definition: mots[mi].definition });
        }
    }

    // Normalize coordinates to start at 0,0
    const normalizedCells = {};
    Object.keys(cells).forEach(key => {
        const [r, c] = key.split(',').map(Number);
        normalizedCells[(r - minR) + ',' + (c - minC)] = cells[key];
    });

    return {
        cells: normalizedCells,
        rows: maxR - minR + 1,
        cols: maxC - minC + 1,
        horizontal: horizontal.sort((a, b) => a.num - b.num),
        vertical: vertical.sort((a, b) => a.num - b.num)
    };
}

// --- 7. SWIPE VRAI/FAUX ---
var swipeState = {};

function renderSwipeVF(zone, c) {
    const affs = c.affirmations || [];
    swipeState = { affirmations: affs, current: 0, results: [], answered: false };
    zone.innerHTML = '<div class="swipe-zone" id="swipe-zone"></div>';
    renderSwipeCard();
}

function renderSwipeCard() {
    const z = document.getElementById('swipe-zone');
    const s = swipeState;
    if (s.current >= s.affirmations.length) { finishSwipe(); return; }
    s.answered = false;
    const aff = s.affirmations[s.current];
    z.innerHTML = '<div class="swipe-progress">' + (s.current + 1) + ' / ' + s.affirmations.length + '</div>' +
        '<div class="swipe-card" id="swipe-card">' + aff.texte + '</div>' +
        '<div class="swipe-feedback" id="swipe-feedback"></div>' +
        '<div class="swipe-btns">' +
        '<button class="swipe-btn btn-faux" onclick="swipeAnswer(false)">Faux</button>' +
        '<button class="swipe-btn btn-vrai" onclick="swipeAnswer(true)">Vrai</button>' +
        '</div>' +
        '<div class="swipe-next-wrap" id="swipe-next-wrap" style="display:none;">' +
        '<button class="swipe-btn swipe-next" onclick="swipeNext()">Suivant</button>' +
        '</div>';
}

function swipeAnswer(answer) {
    const s = swipeState;
    if (s.answered) return;
    const aff = s.affirmations[s.current];
    // Normaliser reponse : string â†’ boolean (certaines IA generent "vrai"/"faux" au lieu de true/false)
    var expected = aff.reponse;
    if (typeof expected === 'string') expected = (expected.toLowerCase() === 'true' || expected.toLowerCase() === 'vrai' || expected.toLowerCase() === 'oui');
    const ok = answer === expected;
    s.answered = true;
    s.results.push({ ok, texte: aff.texte, expected: expected, given: answer, explication: aff.explication });

    const fb = document.getElementById('swipe-feedback');
    const expl = (aff.explication && String(aff.explication).trim())
        ? aff.explication
        : ('La bonne reponse etait : ' + (expected ? 'Vrai' : 'Faux'));
    fb.innerHTML = (ok
        ? '<span style="color:#22c55e;">âœ“ Correct !</span>'
        : '<span style="color:#ef4444;">âœ— Incorrect.</span>')
        + '<div class="swipe-expl">ðŸ’¡ ' + expl + '</div>';

    document.querySelectorAll('.swipe-btns .swipe-btn').forEach(function(btn) {
        btn.disabled = true;
        btn.style.opacity = '0.55';
        btn.style.cursor = 'not-allowed';
    });
    const nextWrap = document.getElementById('swipe-next-wrap');
    if (nextWrap) nextWrap.style.display = '';
}

function swipeNext() {
    const s = swipeState;
    if (!s.answered) return;
    s.current++;
    renderSwipeCard();
}

function finishSwipe() {
    const s = swipeState;
    const correct = s.results.filter(r => r.ok).length;
    showResults(correct, s.results.length, s.results.map(r => ({
        ok: r.ok,
        label: r.texte,
        detail: r.explication || (r.ok ? 'Correct' : ('Reponse : ' + (r.expected ? 'Vrai' : 'Faux')))
    })));
}

// --- 8. QCM IMAGE ---
function renderQcmImage(zone, c) {
    const questions = c.questions || [];
    let html = '<div class="qcm-img-zone">';
    questions.forEach((q, qi) => {
        html += '<div class="qcm-img-q" data-correct="' + q.correct + '" data-qi="' + qi + '">';
        if (q.image) html += '<img src="' + q.image + '" alt="Image" onerror="this.style.display=\'none\'">';
        else html += '<div class="qcm-img-placeholder">ðŸ“· Image non disponible</div>';
        html += '<div class="q-text">' + (qi + 1) + '. ' + q.question + '</div>';
        html += '<div class="qcm-img-choices">';
        (q.choix || []).forEach((ch, ci) => {
            var choixText = (ch && typeof ch === 'object') ? (ch.texte || ch.label || ch.text || '') : (ch || '');
            html += '<div class="qcm-img-choice" data-qi="' + qi + '" data-ci="' + ci + '" onclick="qcmImgSelect(this)">' + choixText + '</div>';
        });
        html += '</div>';
        html += '<div class="qcm-img-expl" id="qcm-expl-' + qi + '">' + (q.explication || '') + '</div>';
        html += '</div>';
    });
    html += '</div>';
    zone.innerHTML = html;
}

function qcmImgSelect(el) {
    if (corrected) return;
    const qi = el.dataset.qi;
    document.querySelectorAll('.qcm-img-choice[data-qi="' + qi + '"]').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
}

// --- 9b. TABLEAU SELECTION (CROIX MULTIPLES) ---
var tableauSelectionState = { rows: [], cols: [], selected: {} };

function renderTableauSelection(zone, c) {
    const rawCols = c.colonnes || [];
    const cols = rawCols.map((col, idx) => {
        if (typeof col === 'string') return { id: 'c' + (idx + 1), label: col };
        return { id: col.id || ('c' + (idx + 1)), label: col.label || col.id || ('Colonne ' + (idx + 1)) };
    });
    const rows = (c.lignes || []).map((r, idx) => ({
        id: r.id || ('l' + (idx + 1)),
        label: r.label || ('Ligne ' + (idx + 1)),
        bonnes: Array.isArray(r.bonnes) ? r.bonnes : [],
        explication: r.explication || ''
    }));
    tableauSelectionState = { rows, cols, selected: {} };

    let html = '<div class="ts-wrap">';
    html += '<div class="ts-table"><div class="ts-grid" style="--ts-cols:' + cols.length + ';">';
    html += '<div class="ts-head"></div>';
    cols.forEach(col => { html += '<div class="ts-head">' + col.label + '</div>'; });
    rows.forEach(row => {
        html += '<div class="ts-row-label">' + row.label + '</div>';
        cols.forEach(col => {
            html += '<button class="ts-cell" type="button" data-ts-row="' + row.id + '" data-ts-col="' + col.id + '" aria-pressed="false" onclick="toggleTableauSelectionCell(this)">â—‹</button>';
        });
    });
    html += '</div></div>';

    html += '<div class="ts-mobile-list">';
    rows.forEach(row => {
        html += '<div class="ts-mobile-row">';
        html += '<div class="ts-mobile-label">' + row.label + '</div>';
        html += '<div class="ts-mobile-cells">';
        cols.forEach(col => {
            html += '<button class="ts-mobile-cell" type="button" data-ts-row="' + row.id + '" data-ts-col="' + col.id + '" aria-pressed="false" onclick="toggleTableauSelectionCell(this)">';
            html += '<span class="mark">â—‹</span><span>' + col.label + '</span></button>';
        });
        html += '</div></div>';
    });
    html += '</div></div>';

    zone.innerHTML = html;
}

function toggleTableauSelectionCell(el) {
    if (corrected) return;
    const rowId = el.dataset.tsRow;
    const colId = el.dataset.tsCol;
    if (!tableauSelectionState.selected[rowId]) tableauSelectionState.selected[rowId] = {};
    const next = !tableauSelectionState.selected[rowId][colId];
    tableauSelectionState.selected[rowId][colId] = next;
    syncTableauSelectionCell(rowId, colId, next);
}

function syncTableauSelectionCell(rowId, colId, selected) {
    document.querySelectorAll('[data-ts-row="' + rowId + '"][data-ts-col="' + colId + '"]').forEach(btn => {
        btn.classList.toggle('selected', selected);
        btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
        if (btn.classList.contains('ts-cell')) {
            btn.textContent = selected ? 'âœ–' : 'â—‹';
        } else {
            const mark = btn.querySelector('.mark');
            if (mark) mark.textContent = selected ? 'âœ–' : 'â—‹';
        }
    });
}

// --- 9. TABLEAU ---
function renderTableau(zone, c) {
    const colonnes = c.colonnes || [];
    const lignes = c.lignes || [];
    let html = '<div class="tableau-zone"><table>';
    html += '<thead><tr>';
    colonnes.forEach(col => { html += '<th>' + col + '</th>'; });
    html += '</tr></thead><tbody>';
    lignes.forEach((ligne, li) => {
        html += '<tr>';
        (ligne.cellules || []).forEach((cell, ci) => {
            const m = cell.match(/^\{\{(.+)\}\}$/);
            if (m) {
                html += '<td><input type="text" data-answer="' + m[1].replace(/"/g, '&quot;') + '" data-row="' + li + '" data-col="' + ci + '" autocomplete="off"></td>';
            } else {
                html += '<td>' + cell + '</td>';
            }
        });
        html += '</tr>';
    });
    html += '</tbody></table></div>';
    zone.innerHTML = html;
}

// --- 10. ETUDE DE CAS ---
function renderEtudeCas(zone, c) {
    let html = '<div class="ec-scenario">' + (c.scenario || '') + '</div>';
    const questions = c.questions || [];
    questions.forEach((q, qi) => {
        html += '<div class="ec-question" data-qi="' + qi + '" data-type="' + q.type + '">';
        html += '<div class="ec-q-text"><span class="ec-q-num">Q' + (qi + 1) + '.</span> ' + q.question + '</div>';
        if (q.type === 'qcm') {
            html += '<div class="ec-qcm-choices">';
            (q.choix || []).forEach((ch, ci) => {
                html += '<div class="ec-qcm-choice" data-qi="' + qi + '" data-ci="' + ci + '" data-correct="' + q.correct + '" onclick="ecQcmSelect(this)">' + ch + '</div>';
            });
            html += '</div>';
        } else {
            html += '<textarea class="ec-text-input" data-qi="' + qi + '" placeholder="Votre reponse..."></textarea>';
            html += '<div class="ec-expected" id="ec-exp-' + qi + '">Reponse attendue : ' + (q.reponse || '') + '</div>';
        }
        html += '</div>';
    });
    zone.innerHTML = html;
}

function ecQcmSelect(el) {
    if (corrected) return;
    const qi = el.dataset.qi;
    document.querySelectorAll('.ec-qcm-choice[data-qi="' + qi + '"]').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
}

// --- 11. PAD (Processus d'Apparition du Dommage) ---
function shuffleArray(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function renderPad(zone, c) {
    // Build options for each PAD step (correct answer + 3 distractors, shuffled)
    function buildOptions(correct, distracteurs, fieldId) {
        var dist = distracteurs || [];
        if (typeof dist === 'string') dist = dist.split(/[|,]/).map(function(s){return s.trim();}).filter(Boolean);
        const options = shuffleArray([(correct || ''), ...dist]);
        let html = '<select id="' + fieldId + '" class="pad-select">';
        html += '<option value="">-- Choisissez --</option>';
        options.forEach(opt => {
            html += '<option value="' + (opt || '').toString().replace(/"/g, '&quot;') + '">' + (opt || '') + '</option>';
        });
        html += '</select>';
        return html;
    }

    let html = '';

    // Situation
    html += '<div class="pad-situation">';
    html += '<div class="pad-situation-label">ðŸ“‹ Situation professionnelle</div>';
    html += (c.situation || '');
    html += '</div>';

    // Instruction
    html += '<div class="pad-instruction">Completez le processus d\'apparition du dommage :</div>';

    // PAD Chain: 4 steps with arrows
    html += '<div class="pad-chain">';

    // Step 1: Danger
    html += '<div class="pad-step" id="pad-step-danger">';
    html += '<div class="pad-step-label">âš ï¸ Danger</div>';
    html += buildOptions(c.danger, c.distracteurs_danger, 'pad-sel-danger');
    html += '<div class="pad-correction" style="display:none;"></div>';
    html += '</div>';

    html += '<div class="pad-arrow">â†’</div>';

    // Step 2: Situation dangereuse
    html += '<div class="pad-step" id="pad-step-sitdang">';
    html += '<div class="pad-step-label">ðŸ”¶ Situation dangereuse</div>';
    html += buildOptions(c.situation_dangereuse, c.distracteurs_situation_dangereuse, 'pad-sel-sitdang');
    html += '<div class="pad-correction" style="display:none;"></div>';
    html += '</div>';

    html += '<div class="pad-arrow">â†’</div>';

    // Step 3: Evenement declencheur
    html += '<div class="pad-step" id="pad-step-event">';
    html += '<div class="pad-step-label">âš¡ Evenement declencheur</div>';
    html += buildOptions(c.evenement_declencheur, c.distracteurs_evenement_declencheur, 'pad-sel-event');
    html += '<div class="pad-correction" style="display:none;"></div>';
    html += '</div>';

    html += '<div class="pad-arrow">â†’</div>';

    // Step 4: Dommage
    html += '<div class="pad-step" id="pad-step-dommage">';
    html += '<div class="pad-step-label">ðŸ©¹ Dommage</div>';
    html += buildOptions(c.dommage, c.distracteurs_dommage, 'pad-sel-dommage');
    html += '<div class="pad-correction" style="display:none;"></div>';
    html += '</div>';

    html += '</div>'; // end pad-chain

    zone.innerHTML = html;
}

// --- 12. PREVENTION (Mesures de prevention) ---
function renderPrevention(zone, c) {
    const niveaux = c.niveaux || [];
    const niveauIcons = { supprimer: '1', reduire: '2', collective: '3', individuelle: '4', formation: '5' };
    const niveauColors = { supprimer: 'n1', reduire: 'n2', collective: 'n3', individuelle: 'n4', formation: 'n5' };

    let html = '';

    // Situation
    html += '<div class="prev-situation">';
    html += '<div class="prev-situation-label">ðŸ“‹ Situation professionnelle</div>';
    html += (c.situation || '');
    html += '</div>';

    // Danger identifie
    html += '<div class="prev-danger-box">';
    html += '<div class="prev-danger-label">âš ï¸ Danger identifie</div>';
    html += (c.danger || '');
    html += '</div>';

    // Instruction
    html += '<div class="prev-instruction">Pour chaque niveau de prevention, choisis la mesure adaptee a cette situation :</div>';
    html += '<div class="prev-hierarchy-label">â¬†ï¸ LE PLUS EFFICACE â¬†ï¸</div>';

    // 5 levels
    html += '<div class="prev-levels">';
    niveaux.forEach((n, i) => {
        var prevDist = n.distracteurs || [];
        if (typeof prevDist === 'string') prevDist = prevDist.split(/[|,]/).map(function(s){return s.trim();}).filter(Boolean);
        const options = shuffleArray([(n.bonne_reponse || ''), ...prevDist]);
        html += '<div class="prev-level" id="prev-level-' + n.niveau + '">';
        html += '<div class="prev-level-num ' + (niveauColors[n.niveau] || '') + '">' + (niveauIcons[n.niveau] || (i+1)) + '</div>';
        html += '<div class="prev-level-content">';
        html += '<div class="prev-level-label">' + n.label + '</div>';
        html += '<select id="prev-sel-' + n.niveau + '">';
        html += '<option value="">-- Choisissez --</option>';
        options.forEach(opt => {
            var optTxt = (opt == null) ? '' : String(opt);
            html += '<option value="' + optTxt.replace(/"/g, '&quot;') + '">' + optTxt + '</option>';
        });
        html += '</select>';
        html += '<div class="prev-correction" style="display:none;"></div>';
        html += '</div></div>';
        if (i < niveaux.length - 1) {
            html += '<div class="prev-efficacy-arrow">â–¼</div>';
        }
    });
    html += '</div>';
    html += '<div class="prev-hierarchy-label" style="margin-top:8px;">â¬‡ï¸ LE MOINS EFFICACE â¬‡ï¸</div>';

    zone.innerHTML = html;
}

// =====================================================================
// ESTIMATION DU RISQUE
// =====================================================================

function calcProba(expo, decl) {
    if (expo === 'rare_courte' && decl === 'faible') return 1;
    if (expo === 'rare_courte' && decl === 'eleve') return 2;
    if (expo === 'frequente_longue' && decl === 'faible') return 3;
    if (expo === 'frequente_longue' && decl === 'eleve') return 4;
    return 0;
}
var PROBA_LABELS = { 1: 'Tres improbable', 2: 'Improbable', 3: 'Probable', 4: 'Tres probable' };
var GRAVITE_LABELS = { 1: 'Faible (sans arret)', 2: 'Moyenne (avec arret)', 3: 'Grave (sequelles)', 4: 'Tres grave (mortel)' };

function renderEstimation(zone, c) {
    var html = '';

    // Situation
    html += '<div class="est-situation">';
    html += '<div class="est-situation-label">ðŸ“‹ Situation professionnelle</div>';
    html += '<div>' + (c.situation || '') + '</div>';
    html += '</div>';

    // Danger + Dommage
    html += '<div class="est-danger-box">';
    html += '<div class="est-danger-label">âš ï¸ Danger identifie</div>';
    html += '<div style="font-weight:600;">' + (c.danger || '') + '</div>';
    html += '</div>';
    html += '<div class="est-dommage-box">';
    html += '<div class="est-dommage-label">ðŸ©¹ Dommage possible</div>';
    html += '<div style="font-weight:600;">' + (c.dommage || '') + '</div>';
    html += '</div>';

    // Instruction
    html += '<div class="est-instruction">Estimez le risque en completant les etapes ci-dessous :</div>';

    // Steps
    html += '<div class="est-steps">';

    // Step 1: Gravite
    html += '<div class="est-step" id="est-step-gravite">';
    html += '<div class="est-step-num n1">1</div>';
    html += '<div class="est-step-content">';
    html += '<div class="est-step-label">Gravite du dommage</div>';
    html += '<select id="est-sel-gravite"><option value="">â€” Choisir â€”</option>';
    html += '<option value="1">1 â€” Faible (AT/MP sans arret)</option>';
    html += '<option value="2">2 â€” Moyenne (AT/MP avec arret)</option>';
    html += '<option value="3">3 â€” Grave (incapacite permanente)</option>';
    html += '<option value="4">4 â€” Tres grave (mortel)</option>';
    html += '</select>';
    html += '<div class="est-step-correction" id="est-corr-gravite"></div>';
    html += '</div></div>';

    // Step 2: Exposition
    html += '<div class="est-step" id="est-step-exposition">';
    html += '<div class="est-step-num n2">2</div>';
    html += '<div class="est-step-content">';
    html += '<div class="est-step-label">Frequence / duree d\'exposition au danger</div>';
    html += '<select id="est-sel-exposition" onchange="updateEstProba()"><option value="">â€” Choisir â€”</option>';
    html += '<option value="rare_courte">Rare et/ou courte duree</option>';
    html += '<option value="frequente_longue">Frequente et/ou longue duree</option>';
    html += '</select>';
    html += '<div class="est-step-correction" id="est-corr-exposition"></div>';
    html += '</div></div>';

    // Step 3: Declencheur
    html += '<div class="est-step" id="est-step-declencheur">';
    html += '<div class="est-step-num n3">3</div>';
    html += '<div class="est-step-content">';
    html += '<div class="est-step-label">Probabilite d\'apparition de l\'evenement declencheur</div>';
    html += '<select id="est-sel-declencheur" onchange="updateEstProba()"><option value="">â€” Choisir â€”</option>';
    html += '<option value="faible">Faible</option>';
    html += '<option value="eleve">Elevee</option>';
    html += '</select>';
    html += '<div class="est-step-correction" id="est-corr-declencheur"></div>';
    html += '</div></div>';

    html += '</div>';

    // Probabilite display
    html += '<div class="est-proba-display" id="est-proba-display">';
    html += '<div class="est-proba-label">Probabilite d\'occurrence du dommage</div>';
    html += '<div class="est-proba-num" id="est-proba-num">?</div>';
    html += '<div id="est-proba-text" style="font-size:0.8rem; color:#64748b;">Choisissez exposition + declencheur</div>';
    html += '</div>';

    // Matrice 4x4
    html += '<div class="est-matrix-section">';
    html += '<div class="est-matrix-title">Cliquez sur la case correspondant au croisement gravite Ã— probabilite</div>';
    html += '<div class="est-matrix">';
    // Header row
    html += '<div class="est-matrix-header"></div>';
    html += '<div class="est-matrix-header">1<br><span style="font-size:0.5rem;">T.improbable</span></div>';
    html += '<div class="est-matrix-header">2<br><span style="font-size:0.5rem;">Improbable</span></div>';
    html += '<div class="est-matrix-header">3<br><span style="font-size:0.5rem;">Probable</span></div>';
    html += '<div class="est-matrix-header">4<br><span style="font-size:0.5rem;">T.probable</span></div>';
    // Rows (from 4 down to 1)
    for (var g = 4; g >= 1; g--) {
        var glabels = { 4: 'T.grave', 3: 'Grave', 2: 'Moyen', 1: 'Faible' };
        html += '<div class="est-matrix-ylabel">' + g + '<br><span style="font-size:0.5rem;">' + glabels[g] + '</span></div>';
        for (var p = 1; p <= 4; p++) {
            var isPrio = (g + p) >= 5;
            html += '<div class="est-matrix-cell ' + (isPrio ? 'zone-red' : 'zone-green') + '" id="est-cell-' + g + '-' + p + '" onclick="selectEstCell(this)">';
            html += isPrio ? 'P' : 'NP';
            html += '</div>';
        }
    }
    html += '</div>';
    html += '<div style="text-align:center; margin-top:6px; font-size:0.65rem; color:#64748b;">';
    html += '<span style="display:inline-block; width:12px; height:12px; background:rgba(34,197,94,0.15); border-radius:3px; margin-right:3px; vertical-align:middle;"></span> NP = Non prioritaire &nbsp;&nbsp;';
    html += '<span style="display:inline-block; width:12px; height:12px; background:rgba(239,68,68,0.15); border-radius:3px; margin-right:3px; vertical-align:middle;"></span> P = Prioritaire';
    html += '</div>';
    html += '</div>';

    // Priorite
    html += '<div class="est-priorite-section">';
    html += '<label>La reduction du risque est-elle prioritaire ?</label>';
    html += '<div class="est-prio-btns">';
    html += '<div class="est-prio-btn" id="est-prio-prioritaire" onclick="selectEstPrio(this, \'prioritaire\')">âœ… PRIORITAIRE</div>';
    html += '<div class="est-prio-btn" id="est-prio-non_prioritaire" onclick="selectEstPrio(this, \'non_prioritaire\')">âž– NON PRIORITAIRE</div>';
    html += '</div>';
    html += '<input type="hidden" id="est-priorite-val" value="">';
    html += '</div>';

    // Feedback zone
    html += '<div class="est-feedback" id="est-feedback"></div>';

    zone.innerHTML = html;
}

// Estimation: update probability display in real time
function updateEstProba() {
    var expo = document.getElementById('est-sel-exposition').value;
    var decl = document.getElementById('est-sel-declencheur').value;
    var display = document.getElementById('est-proba-display');
    var numEl = document.getElementById('est-proba-num');
    var textEl = document.getElementById('est-proba-text');
    if (expo && decl) {
        var p = calcProba(expo, decl);
        numEl.textContent = p;
        textEl.textContent = PROBA_LABELS[p];
        display.classList.add('visible');
    } else {
        numEl.textContent = '?';
        textEl.textContent = 'Choisissez exposition + declencheur';
        display.classList.remove('visible');
    }
}

// Estimation: select matrix cell
function selectEstCell(el) {
    document.querySelectorAll('.est-matrix-cell').forEach(function(c) { c.classList.remove('selected'); });
    el.classList.add('selected');
}

// Estimation: select priority
function selectEstPrio(el, val) {
    document.querySelectorAll('.est-prio-btn').forEach(function(b) { b.classList.remove('active'); });
    el.classList.add('active');
    document.getElementById('est-priorite-val').value = val;
}

// =====================================================================
// DUERP (Document Unique d'Evaluation des Risques Professionnels)
// =====================================================================

// --- DUERP Helper functions ---

function selectDuerpChoice(el, group) {
    if (corrected) return;
    document.querySelectorAll('.duerp-qcm-choice[data-group="' + group + '"]').forEach(function(c) { c.classList.remove('selected'); });
    el.classList.add('selected');
}

function selectDuerpExpo(el, val, prefix) {
    if (corrected) return;
    document.querySelectorAll('.duerp-est-btn[data-field="' + prefix + '-expo"]').forEach(function(b) { b.classList.remove('active'); });
    el.classList.add('active');
    el.closest('.duerp-section-body').querySelector('.duerp-expo-val').value = val;
    updateDuerpProba(prefix);
}

function selectDuerpDecl(el, val, prefix) {
    if (corrected) return;
    document.querySelectorAll('.duerp-est-btn[data-field="' + prefix + '-decl"]').forEach(function(b) { b.classList.remove('active'); });
    el.classList.add('active');
    el.closest('.duerp-section-body').querySelector('.duerp-decl-val').value = val;
    updateDuerpProba(prefix);
}

function updateDuerpProba(prefix) {
    var expoInput = document.getElementById(prefix + '-expo-val');
    var declInput = document.getElementById(prefix + '-decl-val');
    var gravSel = document.getElementById(prefix + '-sel-gravite');
    var probaDiv = document.getElementById(prefix + '-proba-display');
    var probaNum = document.getElementById(prefix + '-proba-num');
    var probaText = document.getElementById(prefix + '-proba-text');
    var prioDiv = document.getElementById(prefix + '-prio-display');
    if (!expoInput || !declInput) return;
    var expo = expoInput.value;
    var decl = declInput.value;
    var grav = gravSel ? (parseInt(gravSel.value) || 0) : 0;
    if (expo && decl) {
        var p = calcProba(expo, decl);
        probaNum.textContent = p;
        probaText.textContent = PROBA_LABELS[p];
        probaDiv.classList.add('visible');
        if (grav > 0) {
            var isPrio = (grav + p) >= 5;
            prioDiv.textContent = isPrio ? 'ðŸ”´ PRIORITAIRE' : 'ðŸŸ¢ NON PRIORITAIRE';
            prioDiv.className = 'duerp-prio-display ' + (isPrio ? 'prioritaire' : 'non_prioritaire');
        } else {
            prioDiv.textContent = 'Choisissez la gravite';
            prioDiv.className = 'duerp-prio-display empty';
        }
    } else {
        probaNum.textContent = '?';
        probaText.textContent = 'Choisissez exposition + declencheur';
        probaDiv.classList.remove('visible');
        prioDiv.textContent = 'En attente...';
        prioDiv.className = 'duerp-prio-display empty';
    }
}

function toggleDuerpMission(el) {
    if (corrected) return;
    el.classList.toggle('checked');
    var cb = el.querySelector('.duerp-mission-cb');
    cb.textContent = el.classList.contains('checked') ? 'âœ“' : '';
}

// --- Build estimation block HTML (shared between duerp_ligne and duerp_mini) ---
function buildDuerpEstimationHTML(prefix) {
    var html = '';
    html += '<div class="duerp-estimation">';
    // Gravite
    html += '<div class="duerp-est-field">';
    html += '<label>Gravite</label>';
    html += '<select id="' + prefix + '-sel-gravite" onchange="updateDuerpProba(\'' + prefix + '\')">';
    html += '<option value="">â€” Choisir â€”</option>';
    html += '<option value="1">1 â€” Faible (sans arret)</option>';
    html += '<option value="2">2 â€” Moyenne (avec arret)</option>';
    html += '<option value="3">3 â€” Grave (sequelles)</option>';
    html += '<option value="4">4 â€” Tres grave (mortel)</option>';
    html += '</select>';
    html += '<div class="duerp-est-correction" id="' + prefix + '-corr-gravite"></div>';
    html += '</div>';
    // Exposition
    html += '<div class="duerp-est-field">';
    html += '<label>Exposition</label>';
    html += '<div class="duerp-est-btns">';
    html += '<div class="duerp-est-btn" data-field="' + prefix + '-expo" data-val="rare_courte" onclick="selectDuerpExpo(this,\'rare_courte\',\'' + prefix + '\')">Rare / courte</div>';
    html += '<div class="duerp-est-btn" data-field="' + prefix + '-expo" data-val="frequente_longue" onclick="selectDuerpExpo(this,\'frequente_longue\',\'' + prefix + '\')">Frequente / longue</div>';
    html += '</div>';
    html += '<input type="hidden" class="duerp-expo-val" id="' + prefix + '-expo-val" value="">';
    html += '<div class="duerp-est-correction" id="' + prefix + '-corr-expo"></div>';
    html += '</div>';
    // Declencheur
    html += '<div class="duerp-est-field">';
    html += '<label>Declencheur</label>';
    html += '<div class="duerp-est-btns">';
    html += '<div class="duerp-est-btn" data-field="' + prefix + '-decl" data-val="faible" onclick="selectDuerpDecl(this,\'faible\',\'' + prefix + '\')">Faible</div>';
    html += '<div class="duerp-est-btn" data-field="' + prefix + '-decl" data-val="eleve" onclick="selectDuerpDecl(this,\'eleve\',\'' + prefix + '\')">Eleve</div>';
    html += '</div>';
    html += '<input type="hidden" class="duerp-decl-val" id="' + prefix + '-decl-val" value="">';
    html += '<div class="duerp-est-correction" id="' + prefix + '-corr-decl"></div>';
    html += '</div>';
    html += '</div>';
    // Proba display
    html += '<div class="duerp-proba-display" id="' + prefix + '-proba-display">';
    html += '<div class="duerp-proba-label">Probabilite</div>';
    html += '<div class="duerp-proba-num" id="' + prefix + '-proba-num">?</div>';
    html += '<div id="' + prefix + '-proba-text" style="font-size:0.75rem; color:#64748b;">Choisissez exposition + declencheur</div>';
    html += '</div>';
    // Priorite display
    html += '<div class="duerp-prio-display empty" id="' + prefix + '-prio-display">En attente...</div>';
    return html;
}

// --- renderDuerpLigne ---
function renderDuerpLigne(zone, c) {
    var html = '';

    // Header
    html += '<div class="duerp-header">';
    html += '<div class="duerp-header-title">ðŸ“‹ Mission DUERP â€” 1 risque</div>';
    html += '<div class="duerp-header-sub">' + (c.titre || '') + '</div>';
    html += '</div>';

    html += '<div style="padding: 16px;">';

    // Unite de travail
    html += '<div class="duerp-unite">ðŸ¢ ' + (c.unite_travail || '') + '</div>';

    // Situation
    html += '<div class="duerp-situation">';
    html += '<div class="duerp-situation-label">ðŸ“‹ Situation professionnelle</div>';
    html += '<div>' + (c.situation || '') + '</div>';
    html += '</div>';

    // Section DANGER
    var choix = c.choix || {};
    var dangers = shuffleArray(choix.danger || []);
    html += '<div class="duerp-section">';
    html += '<div class="duerp-section-title danger">âš ï¸ Identifier le danger</div>';
    html += '<div class="duerp-section-body">';
    html += '<div class="duerp-qcm-choices">';
    dangers.forEach(function(d) {
        html += '<div class="duerp-qcm-choice" data-group="duerp-danger" data-val="' + (d || '').toString().replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'duerp-danger\')">' + (d || '') + '</div>';
    });
    html += '</div></div></div>';

    // Section DOMMAGE
    var dommages = shuffleArray(choix.dommage || []);
    html += '<div class="duerp-section">';
    html += '<div class="duerp-section-title dommage">ðŸ©¹ Identifier le dommage</div>';
    html += '<div class="duerp-section-body">';
    html += '<div class="duerp-qcm-choices">';
    dommages.forEach(function(d) {
        html += '<div class="duerp-qcm-choice" data-group="duerp-dommage" data-val="' + (d || '').toString().replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'duerp-dommage\')">' + (d || '') + '</div>';
    });
    html += '</div></div></div>';

    // Section ESTIMATION
    html += '<div class="duerp-section">';
    html += '<div class="duerp-section-title estimation">ðŸ“Š Estimer le risque</div>';
    html += '<div class="duerp-section-body">';
    html += buildDuerpEstimationHTML('duerp');
    html += '</div></div>';

    // Section MESURE (optional)
    if (c.choix && c.choix.mesure_principale) {
        var mesures = shuffleArray(c.choix.mesure_principale);
        html += '<div class="duerp-section">';
        html += '<div class="duerp-section-title mesure">ðŸ›¡ï¸ Mesure de prevention principale</div>';
        html += '<div class="duerp-section-body">';
        html += '<div class="duerp-qcm-choices">';
        mesures.forEach(function(m) {
            html += '<div class="duerp-qcm-choice" data-group="duerp-mesure" data-val="' + m.replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'duerp-mesure\')">' + m + '</div>';
        });
        html += '</div></div></div>';
    }

    // Feedback zone
    html += '<div class="duerp-feedback" id="duerp-feedback"></div>';

    html += '</div>';
    zone.innerHTML = html;
}

// --- renderDuerpMini ---
function renderDuerpMini(zone, c) {
    var html = '';

    // Header
    html += '<div class="duerp-header">';
    html += '<div class="duerp-header-title">ðŸ“‹ Mission DUERP â€” 4 risques</div>';
    html += '<div class="duerp-header-sub">' + (c.titre || '') + ' â€” ' + (c.entreprise || '') + '</div>';
    html += '</div>';

    html += '<div style="padding: 16px;">';

    // 4 lignes
    (c.lignes || []).forEach(function(ligne, idx) {
        var n = idx + 1;
        var prefix = 'duerp-L' + n;
        var lChoix = ligne.choix || {};

        if (idx > 0) {
            html += '<hr class="duerp-row-separator">';
        }

        html += '<div class="duerp-mini-ligne" data-ligne="' + n + '">';

        // Unite
        html += '<div class="duerp-unite">ðŸ¢ Ligne ' + n + ' â€” ' + (ligne.unite_travail || '') + '</div>';

        // Situation
        html += '<div class="duerp-situation">';
        html += '<div class="duerp-situation-label">ðŸ“‹ Situation</div>';
        html += '<div>' + (ligne.situation || '') + '</div>';
        html += '</div>';

        // Danger QCM
        var dangers = shuffleArray(lChoix.danger || []);
        html += '<div class="duerp-section">';
        html += '<div class="duerp-section-title danger">âš ï¸ Danger</div>';
        html += '<div class="duerp-section-body">';
        html += '<div class="duerp-qcm-choices">';
        dangers.forEach(function(d) {
            html += '<div class="duerp-qcm-choice" data-group="' + prefix + '-danger" data-val="' + d.replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'' + prefix + '-danger\')">' + d + '</div>';
        });
        html += '</div></div></div>';

        // Dommage QCM
        var dommages = shuffleArray(lChoix.dommage || []);
        html += '<div class="duerp-section">';
        html += '<div class="duerp-section-title dommage">ðŸ©¹ Dommage</div>';
        html += '<div class="duerp-section-body">';
        html += '<div class="duerp-qcm-choices">';
        dommages.forEach(function(d) {
            html += '<div class="duerp-qcm-choice" data-group="' + prefix + '-dommage" data-val="' + d.replace(/"/g, '&quot;') + '" onclick="selectDuerpChoice(this,\'' + prefix + '-dommage\')">' + d + '</div>';
        });
        html += '</div></div></div>';

        // Estimation
        html += '<div class="duerp-section">';
        html += '<div class="duerp-section-title estimation">ðŸ“Š Estimation</div>';
        html += '<div class="duerp-section-body">';
        html += buildDuerpEstimationHTML(prefix);
        html += '</div></div>';

        html += '</div>';
    });

    // Mission finale
    html += '<div class="duerp-mission" id="duerp-mission">';
    html += '<div class="duerp-mission-title">ðŸŽ¯ Mission finale</div>';
    html += '<div class="duerp-mission-consigne">' + (c.mission_finale ? c.mission_finale.consigne : 'Cochez les lignes dont le risque est PRIORITAIRE selon vos estimations.') + '</div>';

    c.lignes.forEach(function(ligne, idx) {
        var n = idx + 1;
        html += '<div class="duerp-mission-row" data-mission-ligne="' + n + '" onclick="toggleDuerpMission(this)">';
        html += '<div class="duerp-mission-cb"></div>';
        html += '<div class="duerp-mission-info"><strong>Ligne ' + n + '</strong> â€” ' + (ligne.unite_travail || '') + '</div>';
        html += '</div>';
    });

    html += '</div>';

    // Feedback
    html += '<div class="duerp-feedback" id="duerp-feedback"></div>';

    html += '</div>';
    zone.innerHTML = html;
}

// =====================================================================
// DUERP MISSION DIRECTEUR RENDERER
// =====================================================================

function selectDmChoice(el, groupId) {
    if (corrected) return;
    el.classList.toggle('selected');
}

function toggleDmMission(el) {
    if (corrected) return;
    el.classList.toggle('checked');
    var cb = el.querySelector('.duerp-mission-cb');
    if (cb) cb.textContent = el.classList.contains('checked') ? 'âœ“' : '';
}

function renderDuerMissionDirecteur(zone, c) {
    var html = '';
    var ent = c.entreprise || {};

    // Header
    html += '<div class="dm-header">';
    html += '<div class="dm-header-title">ðŸ“‹ DUERP â€” Mission Directeur</div>';
    html += '<div class="dm-header-sub">' + (c.titre || '') + '</div>';
    html += '<div class="dm-entreprise">';
    if (ent.nom) html += '<span class="dm-entreprise-tag">ðŸ¢ ' + ent.nom + '</span>';
    if (ent.secteur) html += '<span class="dm-entreprise-tag">ðŸ“Œ ' + ent.secteur + '</span>';
    if (ent.effectif) html += '<span class="dm-entreprise-tag">ðŸ‘¥ ' + ent.effectif + ' salaries</span>';
    html += '</div>';
    if (ent.description) html += '<div style="font-size:0.8rem; color:#94a3b8; margin-top:8px;">' + ent.description + '</div>';
    html += '</div>';

    html += '<div class="dm-body">';

    // Rappels
    var rappels = c.rappels || {};
    html += '<div class="dm-rappels">';
    html += '<details open><summary>ðŸ“– Rappels DUERP</summary>';
    html += '<div style="margin-top:10px;">';
    if (rappels.definition) {
        html += '<div class="dm-rappel-item"><span class="dm-rappel-label">Definition</span>' + rappels.definition + '</div>';
    }
    if (Array.isArray(rappels.acteurs) && rappels.acteurs.length > 0) {
        html += '<div class="dm-rappel-item"><span class="dm-rappel-label">Acteurs de la prevention</span>';
        html += '<ul class="dm-rappel-list">';
        rappels.acteurs.forEach(function(a) { html += '<li>' + a + '</li>'; });
        html += '</ul></div>';
    }
    if (Array.isArray(rappels.cycle) && rappels.cycle.length > 0) {
        html += '<div class="dm-rappel-item"><span class="dm-rappel-label">Cycle de la demarche</span>';
        html += '<ol class="dm-rappel-list">';
        rappels.cycle.forEach(function(e) { html += '<li>' + e + '</li>'; });
        html += '</ol></div>';
    }
    if (rappels.mise_a_jour) {
        html += '<div class="dm-rappel-item"><span class="dm-rappel-label">Mise a jour</span>' + rappels.mise_a_jour + '</div>';
    }
    if (Array.isArray(rappels.hierarchie_prevention) && rappels.hierarchie_prevention.length > 0) {
        html += '<div class="dm-rappel-item"><span class="dm-rappel-label">Hierarchie des mesures de prevention</span>';
        html += '<ol class="dm-rappel-list">';
        rappels.hierarchie_prevention.forEach(function(h) { html += '<li>' + h + '</li>'; });
        html += '</ol></div>';
    }
    if (rappels.regle_priorisation) {
        html += '<div class="dm-rappel-item"><span class="dm-rappel-label">Regle de priorisation</span><strong>' + rappels.regle_priorisation + '</strong></div>';
    }
    html += '</div></details></div>';

    // Questions globales
    var questions = c.questions || [];
    if (questions.length > 0) {
        html += '<div class="dm-section">';
        html += '<div class="dm-section-title">ðŸ“ Questions globales</div>';
        questions.forEach(function(q, qi) {
            html += '<div class="dm-global-q">';
            html += '<div class="dm-q-consigne">' + (q.consigne || '') + '</div>';

            if (q.type === 'qcm_multi') {
                html += '<div class="dm-q-hint">Plusieurs reponses possibles â€” cochez toutes les bonnes reponses</div>';
                var choix = shuffleArray([...(q.choix || [])]);
                html += '<div class="dm-qcm-choices">';
                choix.forEach(function(ch) {
                    html += '<div class="dm-qcm-choice" data-group="dm-gq-' + qi + '" data-id="' + ch.id + '" onclick="selectDmChoice(this,\'dm-gq-' + qi + '\')">' + ch.texte + '</div>';
                });
                html += '</div>';
            } else if (q.type === 'ordonner') {
                html += '<div class="dm-q-hint">Attribuez le bon numero a chaque element (1 = le plus important)</div>';
                var elems = q.elements || [];
                var shuffled = elems.map(function(text, correctIdx) { return { text: text, correctIdx: correctIdx }; }).sort(function() { return Math.random() - 0.5; });
                html += '<div class="dm-ordre-list">';
                shuffled.forEach(function(item, i) {
                    var opts = '';
                    for (var k = 1; k <= elems.length; k++) {
                        opts += '<option value="' + k + '"' + (k === (i + 1) ? ' selected' : '') + '>' + k + '</option>';
                    }
                    html += '<div class="dm-ordre-item" data-correct="' + item.correctIdx + '">';
                    html += '<select class="dm-ordre-select dm-ordre-q' + qi + '">' + opts + '</select>';
                    html += '<span class="dm-ordre-text">' + item.text + '</span>';
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '<div class="dm-correction" id="dm-gq-corr-' + qi + '"></div>';
            html += '<div class="dm-explication" id="dm-gq-expl-' + qi + '">' + (q.explication || '') + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }

    // Situations
    var situations = c.situations || [];
    if (situations.length > 0) {
        html += '<div class="dm-section">';
        html += '<div class="dm-section-title">ðŸ­ Situations professionnelles</div>';
        situations.forEach(function(sit, si) {
            html += '<div class="dm-situation-block">';
            html += '<div class="dm-situation-header">' + (sit.id || ('S' + (si + 1))) + ' â€” ' + (sit.unite_travail || '') + '</div>';
            html += '<div class="dm-situation-body">';

            // Situation text
            html += '<div class="dm-situation-text">';
            html += '<div class="dm-situation-text-label">ðŸ“‹ Situation</div>';
            html += '<div>' + (sit.situation || '') + '</div>';
            html += '</div>';

            // Questions de la situation
            var sitQs = sit.questions || [];
            sitQs.forEach(function(sq, sqi) {
                var isQ1 = sqi === 0;
                html += '<div class="dm-sub-section">';
                html += '<div class="dm-sub-title ' + (isQ1 ? 'dangers' : 'mesures') + '">' + (isQ1 ? 'âš ï¸' : 'ðŸ›¡ï¸') + ' ' + (sq.consigne || '') + '</div>';
                html += '<div class="dm-sub-body">';
                html += '<div class="dm-q-hint">Plusieurs reponses possibles â€” cochez toutes les bonnes reponses</div>';
                var sqChoix = shuffleArray([...(sq.choix || [])]);
                html += '<div class="dm-qcm-choices">';
                sqChoix.forEach(function(ch) {
                    html += '<div class="dm-qcm-choice" data-group="dm-s' + si + 'q' + sqi + '" data-id="' + ch.id + '" onclick="selectDmChoice(this,\'dm-s' + si + 'q' + sqi + '\')">' + ch.texte + '</div>';
                });
                html += '</div>';
                html += '<div class="dm-correction" id="dm-s' + si + 'q' + sqi + '-corr"></div>';
                html += '<div class="dm-explication" id="dm-s' + si + 'q' + sqi + '-expl">' + (sq.explication || '') + '</div>';
                html += '</div></div>';
            });

            // Bilan (hidden until correction)
            if (sit.bilan) {
                html += '<div class="dm-bilan" id="dm-bilan-' + si + '">ðŸ“Œ <strong>Bilan :</strong> ' + sit.bilan + '</div>';
            }

            html += '</div></div>';
        });
        html += '</div>';
    }

    // Mission finale
    var mf = c.mission_finale || {};
    html += '<div class="dm-mission">';
    html += '<div class="dm-mission-title">ðŸŽ¯ Mission finale</div>';
    html += '<div class="dm-mission-consigne">' + (mf.consigne || '') + '</div>';
    var mfChoix = mf.choix || [];
    mfChoix.forEach(function(ch) {
        html += '<div class="duerp-mission-row" data-mission-id="' + ch.id + '" onclick="toggleDmMission(this)">';
        html += '<div class="duerp-mission-cb"></div>';
        html += '<div class="duerp-mission-info"><strong>' + ch.texte + '</strong></div>';
        html += '</div>';
    });
    html += '<div class="dm-correction" id="dm-mission-corr"></div>';
    html += '<div class="dm-explication" id="dm-mission-expl">' + (mf.explication || '') + '</div>';
    html += '</div>';

    // Feedback global
    html += '<div class="dm-feedback" id="dm-feedback"></div>';

    html += '</div>';
    zone.innerHTML = html;
}

// =====================================================================
// QCM CLASSIQUE RENDERER
// =====================================================================
function renderQcmClassique(zone, c) {
    const choix = [...(c.choix || [])];
    // Shuffle choices
    for (let i = choix.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [choix[i], choix[j]] = [choix[j], choix[i]]; }
    let html = '<div class="qcm-c-question">' + (c.question || '') + '</div>';
    if (c.multiple) html += '<div class="qcm-c-multi-hint">Plusieurs reponses possibles â€” cochez toutes les bonnes reponses</div>';
    html += '<div class="qcm-c-choices">';
    choix.forEach(ch => {
        html += '<div class="qcm-c-choice" data-id="' + ch.id + '" onclick="selectQcmC(this, ' + !!c.multiple + ')">' + ch.texte + '</div>';
    });
    html += '</div>';
    if (c.explication) html += '<div class="qcm-c-explication" style="display:none;" id="qcmc-explication">' + c.explication + '</div>';
    zone.innerHTML = html;
}
function selectQcmC(el, isMultiple) {
    if (corrected) return;
    if (isMultiple) {
        el.classList.toggle('selected');
    } else {
        el.parentElement.querySelectorAll('.qcm-c-choice').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }
}

// =====================================================================
// QCM SERIE MULTI RENDERER
// =====================================================================
function renderQcmSeriesMulti(zone, c) {
    const questions = c.questions || [];
    let html = '';
    questions.forEach((q, qi) => {
        const choix = [...(q.choix || [])];
        for (let i = choix.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [choix[i], choix[j]] = [choix[j], choix[i]];
        }
        const isMultiple = !!q.multiple || Array.isArray(q.reponse);
        html += '<div class="qcm-series-card" style="margin-bottom:20px; padding:16px; border:1px solid #e2e8f0; border-radius:12px; background:#fff;">';
        html += '<div style="font-size:0.85rem; color:#3b82f6; font-weight:700; margin-bottom:8px;">Question ' + (qi + 1) + '</div>';
        html += '<div class="qcm-c-question">' + (q.question || '') + '</div>';
        if (isMultiple) html += '<div class="qcm-c-multi-hint">Plusieurs reponses possibles â€” cochez toutes les bonnes reponses</div>';
        html += '<div class="qcm-c-choices">';
        choix.forEach(ch => {
            html += '<div class="qcm-c-choice qcms-choice" data-qindex="' + qi + '" data-id="' + ch.id + '" onclick="selectQcmSeries(this, ' + isMultiple + ')">' + ch.texte + '</div>';
        });
        html += '</div>';
        if (q.explication) html += '<div class="qcm-c-explication" style="display:none;" id="qcms-explication-' + qi + '">' + q.explication + '</div>';
        html += '</div>';
    });
    zone.innerHTML = html || '<div class="empty-msg">Aucune question.</div>';
}

function selectQcmSeries(el, isMultiple) {
    if (corrected) return;
    if (isMultiple) {
        el.classList.toggle('selected');
    } else {
        const qindex = el.getAttribute('data-qindex');
        document.querySelectorAll('.qcms-choice[data-qindex="' + qindex + '"]').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }
}

// =====================================================================
// QUIZ CHRONO RENDERER
// =====================================================================
let chronoState = null;
function renderQuizChrono(zone, c) {
    const questions = c.questions || [];
    // Shuffle choices per question
    questions.forEach(q => {
        const ch = [...(q.choix || [])];
        for (let i = ch.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [ch[i], ch[j]] = [ch[j], ch[i]]; }
        q._shuffled = ch;
    });
    chronoState = { questions, temps: c.temps_par_question || 15, current: 0, score: 0, answers: [], timer: null, startTime: 0 };
    let html = '<div class="chrono-container">';
    html += '<div class="chrono-progress" id="chrono-progress">';
    questions.forEach((_, i) => { html += '<div class="chrono-dot" id="chrono-dot-' + i + '"></div>'; });
    html += '</div>';
    html += '<div class="chrono-timer-bar"><div class="chrono-timer-fill" id="chrono-timer-fill"></div></div>';
    html += '<div class="chrono-counter" id="chrono-counter"></div>';
    html += '<div class="chrono-question-text" id="chrono-question"></div>';
    html += '<div class="chrono-choices" id="chrono-choices"></div>';
    html += '</div>';
    zone.innerHTML = html;
    showChronoQuestion(0);
}
function showChronoQuestion(idx) {
    const s = chronoState;
    if (idx >= s.questions.length) { finishChrono(); return; }
    s.current = idx;
    const q = s.questions[idx];
    document.getElementById('chrono-counter').textContent = 'Question ' + (idx + 1) + ' / ' + s.questions.length;
    document.getElementById('chrono-question').textContent = q.question;
    // Progress dots
    s.questions.forEach((_, i) => {
        const dot = document.getElementById('chrono-dot-' + i);
        dot.className = 'chrono-dot';
        if (i < idx) dot.classList.add(s.answers[i] ? 'done-ok' : 'done-ko');
        else if (i === idx) dot.classList.add('current');
    });
    // Choices
    let choicesHtml = '';
    q._shuffled.forEach(ch => {
        choicesHtml += '<div class="chrono-choice" data-id="' + ch.id + '" onclick="answerChrono(\'' + ch.id + '\')">' + ch.texte + '</div>';
    });
    document.getElementById('chrono-choices').innerHTML = choicesHtml;
    // Timer
    s.startTime = Date.now();
    const fill = document.getElementById('chrono-timer-fill');
    fill.style.width = '100%';
    fill.classList.remove('danger');
    if (s.timer) clearInterval(s.timer);
    s.timer = setInterval(function() {
        const elapsed = (Date.now() - s.startTime) / 1000;
        const remaining = Math.max(0, s.temps - elapsed);
        const pct = (remaining / s.temps) * 100;
        fill.style.width = pct + '%';
        if (remaining < 3) fill.classList.add('danger');
        if (remaining <= 0) {
            clearInterval(s.timer);
            s.answers.push(false);
            // Show correct answer briefly
            const correctId = String(s.questions[s.current].reponse || '');
            document.querySelectorAll('.chrono-choice').forEach(el => {
                el.style.pointerEvents = 'none';
                if (el.dataset.id === correctId) el.classList.add('show-correct');
            });
            setTimeout(() => showChronoQuestion(s.current + 1), 800);
        }
    }, 250);
}
function answerChrono(chosenId) {
    const s = chronoState;
    if (s.timer) clearInterval(s.timer);
    const q = s.questions[s.current];
    const isCorrect = String(chosenId) === String(q.reponse);
    s.answers.push(isCorrect);
    if (isCorrect) s.score++;
    // Visual feedback
    document.querySelectorAll('.chrono-choice').forEach(el => {
        el.style.pointerEvents = 'none';
        if (el.dataset.id === chosenId) el.classList.add(isCorrect ? 'selected-ok' : 'selected-ko');
        if (el.dataset.id === String(q.reponse) && !isCorrect) el.classList.add('show-correct');
    });
    setTimeout(() => showChronoQuestion(s.current + 1), 800);
}
function finishChrono() {
    const s = chronoState;
    if (s.timer) clearInterval(s.timer);
    // Update last dot
    const lastIdx = s.questions.length - 1;
    const lastDot = document.getElementById('chrono-dot-' + lastIdx);
    if (lastDot) { lastDot.className = 'chrono-dot ' + (s.answers[lastIdx] ? 'done-ok' : 'done-ko'); }
    const details = s.questions.map((q, i) => ({
        label: q.question.substring(0, 60),
        ok: s.answers[i] || false,
        explication: q.explication || ''
    }));
    showResults(s.score, s.questions.length, details);
}

// =====================================================================
// CATEGORISER RENDERER
// =====================================================================
let catState = null;
function renderCategoriser(zone, c) {
    const items = [...(c.items || [])];
    // Shuffle items
    for (let i = items.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [items[i], items[j]] = [items[j], items[i]]; }
    catState = { selectedItem: null, placements: {}, items: c.items || [], categories: c.categories || [] };
    let html = '';
    if (c.consigne) html += '<div class="cat-consigne">' + c.consigne + '</div>';
    html += '<div class="cat-pool" id="cat-pool">';
    items.forEach(it => {
        html += '<div class="cat-item" data-id="' + it.id + '" onclick="selectCatItem(this)">' + it.label + '</div>';
    });
    html += '</div>';
    html += '<div class="cat-zones" id="cat-zones">';
    (c.categories || []).forEach(cat => {
        html += '<div class="cat-zone" data-cat="' + cat + '" onclick="placeCatItem(this)">';
        html += '<div class="cat-zone-title">' + cat + '</div>';
        html += '<div class="cat-zone-items"></div>';
        html += '</div>';
    });
    html += '</div>';
    zone.innerHTML = html;
}
function selectCatItem(el) {
    if (corrected) return;
    const pool = document.getElementById('cat-pool');
    pool.querySelectorAll('.cat-item').forEach(i => i.classList.remove('selected'));
    el.classList.add('selected');
    catState.selectedItem = el.dataset.id;
    // Highlight zones
    document.querySelectorAll('.cat-zone').forEach(z => z.classList.add('highlight'));
}
function placeCatItem(zoneEl) {
    if (corrected || !catState.selectedItem) return;
    const itemId = catState.selectedItem;
    const category = zoneEl.dataset.cat;
    const item = catState.items.find(i => i.id === itemId);
    if (!item) return;
    // Place item
    catState.placements[itemId] = category;
    const itemsContainer = zoneEl.querySelector('.cat-zone-items');
    const placed = document.createElement('div');
    placed.className = 'cat-placed';
    placed.dataset.id = itemId;
    placed.textContent = item.label;
    placed.onclick = function(e) {
        e.stopPropagation();
        if (corrected) return;
        // Remove from zone, restore to pool
        delete catState.placements[itemId];
        placed.remove();
        const poolItem = document.querySelector('.cat-pool .cat-item[data-id="' + itemId + '"]');
        if (poolItem) { poolItem.classList.remove('placed'); }
    };
    itemsContainer.appendChild(placed);
    // Mark pool item as placed
    const poolItem = document.querySelector('.cat-pool .cat-item[data-id="' + itemId + '"]');
    if (poolItem) { poolItem.classList.remove('selected'); poolItem.classList.add('placed'); }
    catState.selectedItem = null;
    document.querySelectorAll('.cat-zone').forEach(z => z.classList.remove('highlight'));
}

// =====================================================================
// MEMORY RENDERER
// =====================================================================
let memState = null;
function renderMemory(zone, c) {
    const cartes = c.cartes || [];
    // Create 2 cards per pair (one for face a, one for face b)
    const cards = [];
    cartes.forEach(p => {
        cards.push({ pairId: p.id, text: p.a, cardId: p.id + '_a' });
        cards.push({ pairId: p.id, text: p.b, cardId: p.id + '_b' });
    });
    // Shuffle
    for (let i = cards.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [cards[i], cards[j]] = [cards[j], cards[i]]; }
    memState = { cards, flipped: [], matched: new Set(), attempts: 0, nbPairs: cartes.length, busy: false };
    let html = '<div class="mem-board" id="mem-board">';
    cards.forEach((card, i) => {
        // Auto-resize text
        const len = card.text.length;
        const fontSize = len > 30 ? '0.65rem' : len > 20 ? '0.75rem' : '0.85rem';
        html += '<div class="mem-card" data-idx="' + i + '" onclick="flipMemCard(this)">';
        html += '<div class="mem-back">?</div>';
        html += '<div class="mem-face" style="font-size:' + fontSize + ';">' + card.text + '</div>';
        html += '</div>';
    });
    html += '</div>';
    html += '<div class="mem-attempts" id="mem-attempts">Tentatives : 0</div>';
    zone.innerHTML = html;
}
function flipMemCard(el) {
    const s = memState;
    if (s.busy || corrected) return;
    const idx = parseInt(el.dataset.idx);
    if (el.classList.contains('flipped') || el.classList.contains('matched')) return;
    el.classList.add('flipped');
    s.flipped.push(idx);
    if (s.flipped.length === 2) {
        s.attempts++;
        document.getElementById('mem-attempts').textContent = 'Tentatives : ' + s.attempts;
        const [i1, i2] = s.flipped;
        const c1 = s.cards[i1], c2 = s.cards[i2];
        if (c1.pairId === c2.pairId) {
            // Match!
            s.matched.add(c1.pairId);
            document.querySelector('.mem-card[data-idx="' + i1 + '"]').classList.add('matched');
            document.querySelector('.mem-card[data-idx="' + i2 + '"]').classList.add('matched');
            s.flipped = [];
            if (s.matched.size === s.nbPairs) {
                setTimeout(finishMemory, 500);
            }
        } else {
            // No match â€” flip back after 1s
            s.busy = true;
            setTimeout(function() {
                document.querySelector('.mem-card[data-idx="' + i1 + '"]').classList.remove('flipped');
                document.querySelector('.mem-card[data-idx="' + i2 + '"]').classList.remove('flipped');
                s.flipped = [];
                s.busy = false;
            }, 1000);
        }
    }
}
function finishMemory() {
    const s = memState;
    const erreurs = Math.max(0, s.attempts - s.nbPairs);
    const penalite = Math.floor(erreurs / 2);
    const score = Math.max(0, s.nbPairs - penalite);
    const details = [{ label: s.nbPairs + ' paires trouvees en ' + s.attempts + ' tentatives', ok: erreurs === 0 }];
    showResults(score, s.nbPairs, details);
}

// =====================================================================
// SCENARIO RENDERER
// =====================================================================
let scenState = null;
function renderScenario(zone, c) {
    const etapes = c.etapes || [];
    scenState = { etapes, history: [], score: 0, totalChoices: 0, steps: 0, maxSteps: 30 };
    let html = '<div class="scen-container">';
    html += '<div class="scen-progress" id="scen-progress"></div>';
    html += '<div class="scen-texte" id="scen-texte"></div>';
    html += '<div class="scen-choices" id="scen-choices"></div>';
    html += '<div class="scen-feedback" id="scen-feedback" style="display:none;"></div>';
    html += '</div>';
    zone.innerHTML = html;
    showScenEtape('debut');
}
function showScenEtape(etapeId) {
    const s = scenState;
    s.steps++;
    if (s.steps > s.maxSteps) {
        document.getElementById('scen-texte').textContent = 'Erreur : scenario en boucle (plus de 30 etapes parcourues).';
        document.getElementById('scen-choices').innerHTML = '';
        document.getElementById('scen-feedback').style.display = 'none';
        const details = s.history.map(h => ({ label: h.label, ok: h.correct, detail: h.detail || '' }));
        showResults(s.score, s.totalChoices, details);
        return;
    }
    const etape = s.etapes.find(e => e.id === etapeId);
    if (!etape) {
        document.getElementById('scen-texte').textContent = 'Erreur : etape "' + etapeId + '" introuvable.';
        document.getElementById('scen-choices').innerHTML = '';
        return;
    }
    document.getElementById('scen-texte').innerHTML = etape.texte;
    document.getElementById('scen-feedback').style.display = 'none';
    // Update progress dots
    let dotsHtml = '';
    s.history.forEach(h => {
        dotsHtml += '<div class="scen-dot ' + (h.correct ? 'done-ok' : 'done-ko') + '"></div>';
    });
    dotsHtml += '<div class="scen-dot current"></div>';
    document.getElementById('scen-progress').innerHTML = dotsHtml;
    // Choices or end
    if (!etape.choix || etape.choix.length === 0) {
        // Safety net: if this is a "bad" step with no choices, auto-inject a retry button
        if (etapeId.startsWith('bad') && s.history.length > 0) {
            // Find the step that led here (last correct step, or the step before the wrong choice)
            let retourId = 'debut';
            for (let i = s.history.length - 1; i >= 0; i--) {
                if (s.history[i].fromEtape) { retourId = s.history[i].fromEtape; break; }
            }
            // Fallback: find which step points to this bad step
            if (retourId === 'debut') {
                for (const et of s.etapes) {
                    if (et.choix && et.choix.some(ch => ch.suite === etapeId)) {
                        retourId = et.id;
                        break;
                    }
                }
            }
            document.getElementById('scen-choices').innerHTML = '<div class="scen-choice" data-idx="0" data-etape="' + etapeId + '" onclick="showScenEtape(\'' + retourId + '\')">\u21a9 Reessayer</div>';
            return;
        }
        // Real end of scenario
        document.getElementById('scen-choices').innerHTML = '<div class="scen-end"><h3>Fin du scenario</h3><p>' + etape.texte + '</p></div>';
        document.getElementById('scen-texte').style.display = 'none';
        const details = s.history.map(h => ({ label: h.label, ok: h.correct, detail: h.detail || '' }));
        finishScenario(details);
        return;
    }
    let choicesHtml = '';
    etape.choix.forEach((ch, i) => {
        choicesHtml += '<div class="scen-choice" data-idx="' + i + '" data-etape="' + etapeId + '" onclick="answerScenario(this)">' + ch.label + '</div>';
    });
    document.getElementById('scen-choices').innerHTML = choicesHtml;
}
function answerScenario(el) {
    const s = scenState;
    if (corrected) return;
    const etapeId = el.dataset.etape;
    const idx = parseInt(el.dataset.idx);
    const etape = s.etapes.find(e => e.id === etapeId);
    if (!etape) return;
    const choix = etape.choix[idx];
    if (!choix) return;
    s.totalChoices++;
    const isCorrect = !!choix.correct;
    if (isCorrect) s.score++;
    s.history.push({
        label: choix.label.substring(0, 60),
        correct: isCorrect,
        fromEtape: etapeId,
        detail: (!isCorrect && choix.feedback) ? choix.feedback : ''
    });
    // Visual feedback
    el.classList.add(isCorrect ? 'selected-correct' : 'selected-wrong');
    document.querySelectorAll('.scen-choice').forEach(c => { c.style.pointerEvents = 'none'; });
    if (!isCorrect && choix.feedback) {
        document.getElementById('scen-feedback').textContent = choix.feedback;
        document.getElementById('scen-feedback').style.display = 'block';
    }
    setTimeout(() => {
        showScenEtape(choix.suite);
    }, isCorrect ? 600 : 2000);
}
function finishScenario(details) {
    const s = scenState;
    showResults(s.score, s.totalChoices, details);
}

// =====================================================================
// VALIDATION
// =====================================================================

function validateExercice() {
    if (!currentExo || corrected) return;
    corrected = true;
    const type = currentExo.type;
    let correct = 0, total = 0, details = [];

    if (type === 'texte_trous') {
        document.querySelectorAll('.tt-input, .tt-select').forEach(inp => {
            const expected = inp.dataset.answer;
            const given = (inp.value || '').trim();
            total++;
            const ok = norm(given) === norm(expected);
            if (ok) { correct++; inp.classList.add('correct'); }
            else { inp.classList.add('wrong'); }
            if (inp.tagName === 'SELECT') inp.disabled = true;
            else inp.readOnly = true;
            details.push({ ok, label: expected, detail: ok ? 'Correct' : 'Reponse donnee : "' + given + '"' });
        });
    }

    else if (type === 'relier') {
        const pairs = relierState.pairs;
        total = relierState.correctPairs.length;
        pairs.forEach(p => {
            const ok = p.leftIdx === p.rightIdx;
            if (ok) correct++;
            details.push({ ok, label: p.leftText + ' â†” ' + p.rightText, detail: ok ? 'Correct' : 'Mauvaise association' });
        });
        // Mark un-paired
        for (let i = pairs.length; i < total; i++) {
            details.push({ ok: false, label: relierState.correctPairs[i].gauche + ' â†” ' + relierState.correctPairs[i].droite, detail: 'Non associe' });
        }
        // Replace pair colors with correct/wrong on items
        document.querySelectorAll('.relier-item.matched').forEach(el => {
            for (var c = 0; c < 20; c++) el.classList.remove('pair-' + c);
            var idx = parseInt(el.dataset.idx);
            var side = el.dataset.side;
            var pairFound = pairs.find(function(p) {
                return (side === 'left' && p.leftIdx === idx) || (side === 'right' && p.rightIdx === idx);
            });
            if (pairFound) {
                el.classList.add(pairFound.leftIdx === pairFound.rightIdx ? 'correct' : 'wrong');
            }
        });
        // Color pair tags
        document.querySelectorAll('.relier-pair-tag').forEach((tag, i) => {
            for (var c = 0; c < 20; c++) tag.classList.remove('pair-' + c);
            tag.classList.add(pairs[i] && pairs[i].leftIdx === pairs[i].rightIdx ? 'correct' : 'wrong');
            tag.querySelector('.remove-pair').style.display = 'none';
        });
    }

    else if (type === 'ordre' || type === 'hierarchiser') {
        const list = document.getElementById('ordre-list');
        const items = [...list.children];
        total = items.length;
        items.forEach((item) => {
            const correctIdx = parseInt(item.dataset.correct);
            const sel = item.querySelector('.ordre-select');
            const selectedPos = sel ? (parseInt(sel.value, 10) - 1) : -1;
            const ok = correctIdx === selectedPos;
            if (ok) { correct++; item.classList.add('correct'); }
            else item.classList.add('wrong');
            details.push({ ok, label: item.querySelector('.ordre-text').textContent, detail: ok ? 'Bonne position' : 'Position attendue : ' + (correctIdx + 1) });
        });
        // Disable selectors + remelanger
        list.querySelectorAll('select').forEach(s => { s.disabled = true; s.style.opacity = '0.7'; });
        const remelangerBtn = document.querySelector('.ordre-remelanger');
        if (remelangerBtn) { remelangerBtn.disabled = true; remelangerBtn.style.opacity = '0.5'; remelangerBtn.style.cursor = 'not-allowed'; }
    }

    else if (type === 'intrus') {
        document.querySelectorAll('.intrus-serie').forEach(serie => {
            const correctIntrus = parseInt(serie.dataset.intrus);
            const selected = serie.querySelector('.intrus-item.selected');
            const selectedIdx = selected ? parseInt(selected.dataset.itemIdx) : -1;
            total++;
            const ok = selectedIdx === correctIntrus;
            if (ok) correct++;
            // Show correct/wrong
            serie.querySelectorAll('.intrus-item').forEach(it => {
                const idx = parseInt(it.dataset.itemIdx);
                if (idx === correctIntrus) it.classList.add('correct');
                else if (it.classList.contains('selected') && !ok) it.classList.add('wrong');
            });
            serie.querySelector('.intrus-explication').style.display = '';
            const items = [...serie.querySelectorAll('.intrus-item')].map(it => it.textContent);
            details.push({ ok, label: 'Serie : ' + items.join(', '), detail: ok ? 'Correct' : 'L\'intrus etait : ' + (items[correctIntrus] || '?') });
        });
    }

    else if (type === 'mots_croises') {
        document.querySelectorAll('#mc-grid input').forEach(inp => {
            const expected = inp.dataset.answer;
            const given = inp.value.trim().toUpperCase();
            total++;
            const ok = given === expected;
            if (ok) { correct++; inp.closest('td').classList.add('correct'); }
            else inp.closest('td').classList.add('wrong');
            inp.readOnly = true;
        });
        details.push({ ok: correct === total, label: correct + '/' + total + ' lettres correctes', detail: '' });
        const mcMots = (currentExo && currentExo.contenu && Array.isArray(currentExo.contenu.mots)) ? currentExo.contenu.mots : [];
        mcMots.forEach(function(m) {
            if (m && m.explication && String(m.explication).trim()) {
                details.push({
                    ok: true,
                    label: (m.mot || 'Mot'),
                    explication: String(m.explication).trim()
                });
            }
        });
    }

    else if (type === 'qcm_image') {
        document.querySelectorAll('.qcm-img-q').forEach(qBlock => {
            const correctIdx = parseInt(qBlock.dataset.correct);
            const qi = qBlock.dataset.qi;
            const selected = qBlock.querySelector('.qcm-img-choice.selected');
            const selectedIdx = selected ? parseInt(selected.dataset.ci) : -1;
            total++;
            const ok = selectedIdx === correctIdx;
            if (ok) correct++;
            qBlock.querySelectorAll('.qcm-img-choice').forEach(ch => {
                const ci = parseInt(ch.dataset.ci);
                if (ci === correctIdx) ch.classList.add('correct');
                else if (ch.classList.contains('selected') && !ok) ch.classList.add('wrong');
            });
            const expl = document.getElementById('qcm-expl-' + qi);
            if (expl) expl.style.display = '';
            details.push({ ok, label: qBlock.querySelector('.q-text').textContent, detail: ok ? 'Correct' : (expl ? expl.textContent : '') });
        });
    }

    else if (type === 'tableau_selection') {
        const c = currentExo.contenu || {};
        const cols = (c.colonnes || []).map((col, idx) => (typeof col === 'string' ? { id: 'c' + (idx + 1), label: col } : { id: col.id || ('c' + (idx + 1)), label: col.label || col.id || ('Colonne ' + (idx + 1)) }));
        const colLabel = {};
        cols.forEach(col => { colLabel[col.id] = col.label; });
        const rows = (c.lignes || []).map((r, idx) => ({ id: r.id || ('l' + (idx + 1)), label: r.label || ('Ligne ' + (idx + 1)), bonnes: Array.isArray(r.bonnes) ? r.bonnes : [], explication: r.explication || '' }));
        const rules = c.regles || {};
        const exactParLigne = (rules.exactParLigne != null && rules.exactParLigne !== '') ? parseInt(rules.exactParLigne, 10) : null;
        const minParLigne = (rules.minParLigne != null) ? parseInt(rules.minParLigne, 10) : 0;
        const maxParLigne = (rules.maxParLigne != null) ? parseInt(rules.maxParLigne, 10) : 99;
        const penalite = (rules.penaliteErreur != null) ? parseFloat(rules.penaliteErreur) : 0.5;

        rows.forEach(row => {
            const selectedIds = Object.keys(tableauSelectionState.selected[row.id] || {}).filter(k => !!tableauSelectionState.selected[row.id][k]);
            const selectedSet = new Set(selectedIds);
            const bonnesSet = new Set(row.bonnes || []);
            const tp = selectedIds.filter(id => bonnesSet.has(id)).length;
            const fp = selectedIds.filter(id => !bonnesSet.has(id)).length;
            const fn = (row.bonnes || []).filter(id => !selectedSet.has(id)).length;

            const countOk = (exactParLigne != null && !isNaN(exactParLigne))
                ? (selectedIds.length === exactParLigne)
                : (selectedIds.length >= (isNaN(minParLigne) ? 0 : minParLigne) && selectedIds.length <= (isNaN(maxParLigne) ? 99 : maxParLigne));

            const lineOk = (fp === 0 && fn === 0 && countOk);
            const lineMax = Math.max((row.bonnes || []).length, 1);
            const lineScore = Math.max(0, tp - (isNaN(penalite) ? 0.5 : penalite) * fp);

            total += lineMax;
            correct += lineScore;

            const expectedTxt = (row.bonnes || []).map(id => colLabel[id] || id).join(' | ');
            const selectedTxt = selectedIds.map(id => colLabel[id] || id).join(' | ');
            const detail = lineOk
                ? 'Ligne correcte.'
                : ('Attendu : ' + (expectedTxt || 'â€”') + ' â€¢ Selectionne : ' + (selectedTxt || 'â€”') + (row.explication ? ' â€¢ ' + row.explication : ''));
            details.push({ ok: lineOk, label: row.label, detail: detail });

            cols.forEach(col => {
                const isGood = bonnesSet.has(col.id);
                const isSel = selectedSet.has(col.id);
                document.querySelectorAll('[data-ts-row="' + row.id + '"][data-ts-col="' + col.id + '"]').forEach(btn => {
                    btn.disabled = true;
                    btn.style.cursor = 'default';
                    btn.classList.remove('selected');
                    if (isGood && isSel) btn.classList.add('correct');
                    else if (!isGood && isSel) btn.classList.add('wrong');
                    else if (isGood && !isSel) btn.classList.add('missed');
                    if (btn.classList.contains('ts-cell')) {
                        btn.textContent = isGood && isSel ? 'âœ“' : (!isGood && isSel ? 'âœ–' : (isGood && !isSel ? 'â€¢' : 'â—‹'));
                    } else {
                        const mark = btn.querySelector('.mark');
                        if (mark) mark.textContent = isGood && isSel ? 'âœ“' : (!isGood && isSel ? 'âœ–' : (isGood && !isSel ? 'â€¢' : 'â—‹'));
                    }
                });
            });
        });
    }

    else if (type === 'tableau') {
        document.querySelectorAll('.tableau-zone input').forEach(inp => {
            const expected = inp.dataset.answer;
            const given = inp.value.trim();
            total++;
            const ok = norm(given) === norm(expected);
            if (ok) { correct++; inp.closest('td').classList.add('correct'); }
            else inp.closest('td').classList.add('wrong');
            inp.readOnly = true;
            details.push({ ok, label: expected, detail: ok ? 'Correct' : 'Reponse : "' + given + '"' });
        });
    }

    else if (type === 'etude_cas') {
        document.querySelectorAll('.ec-question').forEach(qBlock => {
            const qi = qBlock.dataset.qi;
            const qType = qBlock.dataset.type;
            const qData = (currentExo && currentExo.contenu && Array.isArray(currentExo.contenu.questions))
                ? currentExo.contenu.questions[parseInt(qi, 10)]
                : null;
            const qExplication = (qData && qData.explication) ? String(qData.explication) : '';
            total++;
            if (qType === 'qcm') {
                const correctIdx = parseInt(qBlock.querySelector('.ec-qcm-choice').dataset.correct);
                const selected = qBlock.querySelector('.ec-qcm-choice.selected');
                const selectedIdx = selected ? parseInt(selected.dataset.ci) : -1;
                const ok = selectedIdx === correctIdx;
                if (ok) correct++;
                qBlock.querySelectorAll('.ec-qcm-choice').forEach(ch => {
                    const ci = parseInt(ch.dataset.ci);
                    if (ci === correctIdx) ch.classList.add('correct');
                    else if (ch.classList.contains('selected') && !ok) ch.classList.add('wrong');
                });
                details.push({
                    ok,
                    label: qBlock.querySelector('.ec-q-text').textContent,
                    detail: ok ? 'Correct' : '',
                    explication: qExplication
                });
            } else {
                // Texte libre â€” show expected
                const expEl = document.getElementById('ec-exp-' + qi);
                if (expEl) expEl.style.display = '';
                const textarea = qBlock.querySelector('.ec-text-input');
                const hasAnswer = textarea && textarea.value.trim().length > 0;
                if (hasAnswer) correct++;
                details.push({
                    ok: hasAnswer,
                    label: qBlock.querySelector('.ec-q-text').textContent,
                    detail: hasAnswer ? 'Reponse fournie (verifiez avec la correction)' : 'Aucune reponse',
                    explication: qExplication
                });
            }
        });
    }

    else if (type === 'pad') {
        const c = currentExo.contenu;
        // 4 PAD steps only â€” score /4
        const steps = [
            { id: 'danger', label: 'Danger', answer: c.danger },
            { id: 'sitdang', label: 'Situation dangereuse', answer: c.situation_dangereuse },
            { id: 'event', label: 'Evenement declencheur', answer: c.evenement_declencheur },
            { id: 'dommage', label: 'Dommage', answer: c.dommage }
        ];
        steps.forEach(step => {
            const sel = document.getElementById('pad-sel-' + step.id);
            const stepEl = document.getElementById('pad-step-' + step.id);
            const given = sel ? sel.value : '';
            total++;
            const ok = given === step.answer;
            if (ok) { correct++; stepEl.classList.add('correct'); }
            else {
                stepEl.classList.add('wrong');
                const corr = stepEl.querySelector('.pad-correction');
                if (corr) { corr.textContent = 'âœ“ ' + step.answer; corr.style.display = ''; }
            }
            if (sel) sel.disabled = true;
            details.push({ ok, label: step.label, detail: ok ? 'Correct' : 'Reponse : "' + given + '"' });
        });
    }

    else if (type === 'prevention') {
        const c = currentExo.contenu;
        const niveaux = c.niveaux || [];
        niveaux.forEach(n => {
            const sel = document.getElementById('prev-sel-' + n.niveau);
            const levelEl = document.getElementById('prev-level-' + n.niveau);
            const given = sel ? sel.value : '';
            total++;
            const ok = given === n.bonne_reponse;
            if (ok) { correct++; levelEl.classList.add('correct'); }
            else {
                levelEl.classList.add('wrong');
                const corr = levelEl.querySelector('.prev-correction');
                if (corr) { corr.textContent = 'âœ“ ' + n.bonne_reponse; corr.style.display = ''; }
            }
            if (sel) sel.disabled = true;
            details.push({ ok, label: n.label, detail: ok ? 'Correct' : 'Reponse : "' + given + '"' });
        });
    }

    // === ESTIMATION DU RISQUE ===
    else if (type === 'estimation_risque') {
        const c = currentExo.contenu || {};
        const probaAttendue = calcProba(c.exposition || '', c.declencheur || '');
        const feedbackMsgs = [];

        // 1. Gravite (1 pt)
        const gravSel = document.getElementById('est-sel-gravite');
        const gravStep = document.getElementById('est-step-gravite');
        const gravGiven = parseInt(gravSel.value) || 0;
        const gravOk = gravGiven === (c.gravite || 0);
        total++;
        if (gravOk) { correct++; gravStep.classList.add('correct'); }
        else {
            gravStep.classList.add('wrong');
            const corr = document.getElementById('est-corr-gravite');
            corr.textContent = 'âœ“ ' + c.gravite + ' â€” ' + GRAVITE_LABELS[c.gravite];
            corr.style.display = '';
        }
        gravSel.disabled = true;
        details.push({ ok: gravOk, label: 'Gravite', detail: gravOk ? 'Correct' : 'Attendu : ' + c.gravite });

        // 2. Exposition (1 pt)
        const expoSel = document.getElementById('est-sel-exposition');
        const expoStep = document.getElementById('est-step-exposition');
        const expoOk = expoSel.value === c.exposition;
        total++;
        if (expoOk) { correct++; expoStep.classList.add('correct'); }
        else {
            expoStep.classList.add('wrong');
            const corr = document.getElementById('est-corr-exposition');
            corr.textContent = 'âœ“ ' + (c.exposition === 'rare_courte' ? 'Rare et/ou courte duree' : 'Frequente et/ou longue duree');
            corr.style.display = '';
            feedbackMsgs.push('âš ï¸ Revoir la frequence/duree d\'exposition dans la situation');
        }
        expoSel.disabled = true;
        details.push({ ok: expoOk, label: 'Exposition', detail: expoOk ? 'Correct' : 'Attendu : ' + c.exposition });

        // 3. Declencheur (1 pt)
        const declSel = document.getElementById('est-sel-declencheur');
        const declStep = document.getElementById('est-step-declencheur');
        const declOk = declSel.value === c.declencheur;
        total++;
        if (declOk) { correct++; declStep.classList.add('correct'); }
        else {
            declStep.classList.add('wrong');
            const corr = document.getElementById('est-corr-declencheur');
            corr.textContent = 'âœ“ ' + (c.declencheur === 'faible' ? 'Faible' : 'Elevee');
            corr.style.display = '';
            feedbackMsgs.push('âš ï¸ Revoir la probabilite de l\'evenement declencheur');
        }
        declSel.disabled = true;
        details.push({ ok: declOk, label: 'Declencheur', detail: declOk ? 'Correct' : 'Attendu : ' + c.declencheur });

        // Show correct probability
        var probaDisplay = document.getElementById('est-proba-display');
        var probaNum = document.getElementById('est-proba-num');
        var probaText = document.getElementById('est-proba-text');
        probaNum.textContent = probaAttendue;
        probaText.textContent = PROBA_LABELS[probaAttendue] + (expoOk && declOk ? ' âœ…' : ' (corrige)');
        probaDisplay.classList.add('visible');

        // 4. Matrice (1 pt)
        const bonneCase = 'est-cell-' + c.gravite + '-' + probaAttendue;
        const caseSelectionnee = document.querySelector('.est-matrix-cell.selected');
        const matriceOk = caseSelectionnee && caseSelectionnee.id === bonneCase;
        total++;
        if (matriceOk) { correct++; caseSelectionnee.classList.add('correct-cell'); }
        else {
            if (caseSelectionnee) caseSelectionnee.classList.add('wrong-cell');
            var bonneCaseEl = document.getElementById(bonneCase);
            if (bonneCaseEl) bonneCaseEl.classList.add('show-correct');
        }
        document.querySelectorAll('.est-matrix-cell').forEach(function(c) { c.onclick = null; c.style.cursor = 'default'; });
        details.push({ ok: matriceOk, label: 'Case matrice', detail: matriceOk ? 'Correct' : 'Mauvaise case' });

        // 5. Priorite (1 pt)
        const prioVal = document.getElementById('est-priorite-val').value;
        const prioOk = prioVal === c.priorite;
        total++;
        if (prioOk) {
            correct++;
            var prioBtn = document.getElementById('est-prio-' + prioVal);
            if (prioBtn) prioBtn.classList.add('correct-prio');
        } else {
            var wrongBtn = document.getElementById('est-prio-' + prioVal);
            if (wrongBtn) wrongBtn.classList.add('wrong-prio');
            var correctBtn = document.getElementById('est-prio-' + c.priorite);
            if (correctBtn) correctBtn.classList.add('correct-prio');
        }
        document.querySelectorAll('.est-prio-btn').forEach(function(b) { b.onclick = null; b.style.cursor = 'default'; });
        details.push({ ok: prioOk, label: 'Priorite', detail: prioOk ? 'Correct' : 'Attendu : ' + c.priorite });

        // Feedback intelligent
        if (feedbackMsgs.length > 0 || !matriceOk || !prioOk) {
            var fb = document.getElementById('est-feedback');
            var msgs = [];
            if (feedbackMsgs.length > 0) msgs = msgs.concat(feedbackMsgs);
            if (!expoOk && !declOk) {
                msgs = ['âš ï¸ L\'exposition ET le declencheur sont mal evalues â†’ la probabilite est fausse'];
            }
            msgs.push('ðŸ“Œ Rappel : Probabilite = Exposition Ã— Declencheur');
            msgs.push('ðŸ“Œ La probabilite ne se devine pas, elle se deduit des indices dans la situation');
            fb.innerHTML = msgs.join('<br>');
            fb.classList.add('visible');
        }
    }

    // === DUERP LIGNE ===
    else if (type === 'duerp_ligne') {
        const c = currentExo.contenu;
        const att = c.attendus || {};
        const feedbackMsgs = [];

        // 1. Danger (1 pt)
        total++;
        const dangerSel = document.querySelector('.duerp-qcm-choice[data-group="duerp-danger"].selected');
        const dangerVal = dangerSel ? dangerSel.getAttribute('data-val') : '';
        const dangerOk = dangerVal === att.danger;
        if (dangerOk) correct++;
        document.querySelectorAll('.duerp-qcm-choice[data-group="duerp-danger"]').forEach(function(el) {
            el.onclick = null; el.style.cursor = 'default';
            if (el.getAttribute('data-val') === att.danger) el.classList.add(dangerOk ? 'correct' : 'show-correct');
            else if (el.classList.contains('selected')) el.classList.add('wrong');
        });
        if (!dangerOk) feedbackMsgs.push('âš ï¸ Le danger identifie n\'est pas le bon. Relisez la situation pour reperer la source du risque.');
        details.push({ ok: dangerOk, label: 'Danger', detail: dangerOk ? 'Correct' : 'Attendu : ' + att.danger });

        // 2. Dommage (1 pt)
        total++;
        const dommageSel = document.querySelector('.duerp-qcm-choice[data-group="duerp-dommage"].selected');
        const dommageVal = dommageSel ? dommageSel.getAttribute('data-val') : '';
        const dommageOk = dommageVal === att.dommage;
        if (dommageOk) correct++;
        document.querySelectorAll('.duerp-qcm-choice[data-group="duerp-dommage"]').forEach(function(el) {
            el.onclick = null; el.style.cursor = 'default';
            if (el.getAttribute('data-val') === att.dommage) el.classList.add(dommageOk ? 'correct' : 'show-correct');
            else if (el.classList.contains('selected')) el.classList.add('wrong');
        });
        if (!dommageOk) feedbackMsgs.push('âš ï¸ Le dommage n\'est pas le bon. Quel prejudice physique ou psychique peut subir le salarie ?');
        details.push({ ok: dommageOk, label: 'Dommage', detail: dommageOk ? 'Correct' : 'Attendu : ' + att.dommage });

        // 3. Gravite (1 pt)
        total++;
        const gravSel = document.getElementById('duerp-sel-gravite');
        const gravGiven = parseInt(gravSel.value) || 0;
        const gravOk = gravGiven === att.gravite;
        if (gravOk) { correct++; gravSel.classList.add('correct'); }
        else {
            gravSel.classList.add('wrong');
            var corrG = document.getElementById('duerp-corr-gravite');
            corrG.textContent = 'âœ“ ' + att.gravite + ' â€” ' + GRAVITE_LABELS[att.gravite];
            corrG.style.display = '';
        }
        gravSel.disabled = true;
        details.push({ ok: gravOk, label: 'Gravite', detail: gravOk ? 'Correct' : 'Attendu : ' + att.gravite });

        // 4. Exposition (1 pt)
        total++;
        const expoVal = document.getElementById('duerp-expo-val').value;
        const expoOk = expoVal === att.exposition;
        if (expoOk) correct++;
        document.querySelectorAll('.duerp-est-btn[data-field="duerp-expo"]').forEach(function(b) {
            b.onclick = null; b.style.cursor = 'default';
            if (b.getAttribute('data-val') === att.exposition) b.classList.add(expoOk ? 'correct' : 'show-correct');
            else if (b.classList.contains('active')) b.classList.add('wrong');
        });
        if (!expoOk) feedbackMsgs.push('âš ï¸ Revoir la frequence/duree d\'exposition dans la situation');
        var corrE = document.getElementById('duerp-corr-expo');
        if (!expoOk) { corrE.textContent = 'âœ“ ' + (att.exposition === 'rare_courte' ? 'Rare / courte' : 'Frequente / longue'); corrE.style.display = ''; }
        details.push({ ok: expoOk, label: 'Exposition', detail: expoOk ? 'Correct' : 'Attendu : ' + att.exposition });

        // 5. Declencheur (1 pt)
        total++;
        const declVal = document.getElementById('duerp-decl-val').value;
        const declOk = declVal === att.declencheur;
        if (declOk) correct++;
        document.querySelectorAll('.duerp-est-btn[data-field="duerp-decl"]').forEach(function(b) {
            b.onclick = null; b.style.cursor = 'default';
            if (b.getAttribute('data-val') === att.declencheur) b.classList.add(declOk ? 'correct' : 'show-correct');
            else if (b.classList.contains('active')) b.classList.add('wrong');
        });
        if (!declOk) feedbackMsgs.push('âš ï¸ Revoir la probabilite de l\'evenement declencheur');
        var corrD = document.getElementById('duerp-corr-decl');
        if (!declOk) { corrD.textContent = 'âœ“ ' + (att.declencheur === 'faible' ? 'Faible' : 'Eleve'); corrD.style.display = ''; }
        details.push({ ok: declOk, label: 'Declencheur', detail: declOk ? 'Correct' : 'Attendu : ' + att.declencheur });

        // Show correct proba + prio
        const probaAttendue = calcProba(att.exposition, att.declencheur);
        var probaDiv = document.getElementById('duerp-proba-display');
        var probaNum = document.getElementById('duerp-proba-num');
        var probaText = document.getElementById('duerp-proba-text');
        probaNum.textContent = probaAttendue;
        probaText.textContent = PROBA_LABELS[probaAttendue] + (expoOk && declOk ? ' âœ…' : ' (corrige)');
        probaDiv.classList.add('visible');
        var isPrio = (att.gravite + probaAttendue) >= 5;
        var prioDiv = document.getElementById('duerp-prio-display');
        prioDiv.textContent = isPrio ? 'ðŸ”´ PRIORITAIRE' : 'ðŸŸ¢ NON PRIORITAIRE';
        prioDiv.className = 'duerp-prio-display ' + (isPrio ? 'prioritaire' : 'non_prioritaire');

        // 6. Mesure (1 pt, if present)
        if (c.choix && c.choix.mesure_principale && att.mesure_principale) {
            total++;
            const mesureSel = document.querySelector('.duerp-qcm-choice[data-group="duerp-mesure"].selected');
            const mesureVal = mesureSel ? mesureSel.getAttribute('data-val') : '';
            const mesureOk = mesureVal === att.mesure_principale;
            if (mesureOk) correct++;
            document.querySelectorAll('.duerp-qcm-choice[data-group="duerp-mesure"]').forEach(function(el) {
                el.onclick = null; el.style.cursor = 'default';
                if (el.getAttribute('data-val') === att.mesure_principale) el.classList.add(mesureOk ? 'correct' : 'show-correct');
                else if (el.classList.contains('selected')) el.classList.add('wrong');
            });
            if (!mesureOk) feedbackMsgs.push('âš ï¸ La mesure de prevention choisie n\'est pas la plus adaptee');
            details.push({ ok: mesureOk, label: 'Mesure', detail: mesureOk ? 'Correct' : 'Attendu : ' + att.mesure_principale });
        }

        // Feedback
        if (feedbackMsgs.length > 0) {
            var fb = document.getElementById('duerp-feedback');
            if (!expoOk && !declOk) feedbackMsgs.push('ðŸ“Œ L\'exposition ET le declencheur sont mal evalues â†’ la probabilite est fausse');
            feedbackMsgs.push('ðŸ“Œ Rappel : Probabilite = Exposition Ã— Declencheur');
            fb.innerHTML = feedbackMsgs.join('<br>');
            fb.classList.add('visible');
        }
    }

    // === DUERP MINI ===
    else if (type === 'duerp_mini') {
        const c = currentExo.contenu;
        const feedbackMsgs = [];

        // Score each line (5 pts each = 20 pts)
        (c.lignes || []).forEach(function(ligne, idx) {
            var n = idx + 1;
            var prefix = 'duerp-L' + n;
            var att = ligne.attendus || {};

            // Danger (1 pt)
            total++;
            var dSel = document.querySelector('.duerp-qcm-choice[data-group="' + prefix + '-danger"].selected');
            var dVal = dSel ? dSel.getAttribute('data-val') : '';
            var dOk = dVal === att.danger;
            if (dOk) correct++;
            document.querySelectorAll('.duerp-qcm-choice[data-group="' + prefix + '-danger"]').forEach(function(el) {
                el.onclick = null; el.style.cursor = 'default';
                if (el.getAttribute('data-val') === att.danger) el.classList.add(dOk ? 'correct' : 'show-correct');
                else if (el.classList.contains('selected')) el.classList.add('wrong');
            });
            details.push({ ok: dOk, label: 'L' + n + ' Danger', detail: dOk ? 'Correct' : 'Attendu : ' + att.danger });

            // Dommage (1 pt)
            total++;
            var dmSel = document.querySelector('.duerp-qcm-choice[data-group="' + prefix + '-dommage"].selected');
            var dmVal = dmSel ? dmSel.getAttribute('data-val') : '';
            var dmOk = dmVal === att.dommage;
            if (dmOk) correct++;
            document.querySelectorAll('.duerp-qcm-choice[data-group="' + prefix + '-dommage"]').forEach(function(el) {
                el.onclick = null; el.style.cursor = 'default';
                if (el.getAttribute('data-val') === att.dommage) el.classList.add(dmOk ? 'correct' : 'show-correct');
                else if (el.classList.contains('selected')) el.classList.add('wrong');
            });
            details.push({ ok: dmOk, label: 'L' + n + ' Dommage', detail: dmOk ? 'Correct' : 'Attendu : ' + att.dommage });

            // Gravite (1 pt)
            total++;
            var gSel = document.getElementById(prefix + '-sel-gravite');
            var gVal = parseInt(gSel.value) || 0;
            var gOk = gVal === att.gravite;
            if (gOk) { correct++; gSel.classList.add('correct'); }
            else {
                gSel.classList.add('wrong');
                var cG = document.getElementById(prefix + '-corr-gravite');
                cG.textContent = 'âœ“ ' + att.gravite + ' â€” ' + GRAVITE_LABELS[att.gravite];
                cG.style.display = '';
            }
            gSel.disabled = true;
            details.push({ ok: gOk, label: 'L' + n + ' Gravite', detail: gOk ? 'Correct' : 'Attendu : ' + att.gravite });

            // Exposition (1 pt)
            total++;
            var eVal = document.getElementById(prefix + '-expo-val').value;
            var eOk = eVal === att.exposition;
            if (eOk) correct++;
            document.querySelectorAll('.duerp-est-btn[data-field="' + prefix + '-expo"]').forEach(function(b) {
                b.onclick = null; b.style.cursor = 'default';
                if (b.getAttribute('data-val') === att.exposition) b.classList.add(eOk ? 'correct' : 'show-correct');
                else if (b.classList.contains('active')) b.classList.add('wrong');
            });
            var cE = document.getElementById(prefix + '-corr-expo');
            if (!eOk) { cE.textContent = 'âœ“ ' + (att.exposition === 'rare_courte' ? 'Rare / courte' : 'Frequente / longue'); cE.style.display = ''; }
            details.push({ ok: eOk, label: 'L' + n + ' Exposition', detail: eOk ? 'Correct' : 'Attendu : ' + att.exposition });

            // Declencheur (1 pt)
            total++;
            var dcVal = document.getElementById(prefix + '-decl-val').value;
            var dcOk = dcVal === att.declencheur;
            if (dcOk) correct++;
            document.querySelectorAll('.duerp-est-btn[data-field="' + prefix + '-decl"]').forEach(function(b) {
                b.onclick = null; b.style.cursor = 'default';
                if (b.getAttribute('data-val') === att.declencheur) b.classList.add(dcOk ? 'correct' : 'show-correct');
                else if (b.classList.contains('active')) b.classList.add('wrong');
            });
            var cD = document.getElementById(prefix + '-corr-decl');
            if (!dcOk) { cD.textContent = 'âœ“ ' + (att.declencheur === 'faible' ? 'Faible' : 'Eleve'); cD.style.display = ''; }
            details.push({ ok: dcOk, label: 'L' + n + ' Declencheur', detail: dcOk ? 'Correct' : 'Attendu : ' + att.declencheur });

            // Show correct proba + prio for this line
            var probaAtt = calcProba(att.exposition, att.declencheur);
            var pDiv = document.getElementById(prefix + '-proba-display');
            var pNum = document.getElementById(prefix + '-proba-num');
            var pText = document.getElementById(prefix + '-proba-text');
            pNum.textContent = probaAtt;
            pText.textContent = PROBA_LABELS[probaAtt] + (eOk && dcOk ? ' âœ…' : ' (corrige)');
            pDiv.classList.add('visible');
            var linePrio = (att.gravite + probaAtt) >= 5;
            var lpDiv = document.getElementById(prefix + '-prio-display');
            lpDiv.textContent = linePrio ? 'ðŸ”´ PRIORITAIRE' : 'ðŸŸ¢ NON PRIORITAIRE';
            lpDiv.className = 'duerp-prio-display ' + (linePrio ? 'prioritaire' : 'non_prioritaire');
        });

        // Mission finale â€” scored from ATTENDUS (not student answers)
        var nbPrio = c.mission_finale ? (c.mission_finale.nb_prioritaires || 0) : 0;
        // Calculate which lines are truly priority from attendus
        var lignePrioAttendue = [];
        (c.lignes || []).forEach(function(ligne, idx) {
            var att = ligne.attendus || {};
            var probaAtt = calcProba(att.exposition, att.declencheur);
            lignePrioAttendue.push(((att.gravite || 0) + probaAtt) >= 5);
        });

        // Score mission: 1 pt per correct selection, 0 otherwise, NO negative
        document.querySelectorAll('.duerp-mission-row').forEach(function(row) {
            var ligneIdx = parseInt(row.getAttribute('data-mission-ligne')) - 1;
            var isChecked = row.classList.contains('checked');
            var shouldBeChecked = lignePrioAttendue[ligneIdx];
            total++;
            row.onclick = null; row.style.cursor = 'default';
            if (isChecked === shouldBeChecked) {
                correct++;
                row.classList.add('correct');
                details.push({ ok: true, label: 'Mission L' + (ligneIdx + 1), detail: 'Correct' });
            } else {
                if (shouldBeChecked) {
                    row.classList.add('show-correct');
                    details.push({ ok: false, label: 'Mission L' + (ligneIdx + 1), detail: 'Devait etre coche (prioritaire)' });
                } else {
                    row.classList.add('wrong');
                    details.push({ ok: false, label: 'Mission L' + (ligneIdx + 1), detail: 'Ne devait pas etre coche (non prioritaire)' });
                }
            }
        });

        // Feedback
        var fb = document.getElementById('duerp-feedback');
        var nbLignesOk = 0;
        (c.lignes || []).forEach(function(ligne, idx) {
            var att = ligne.attendus || {};
            var prefix = 'duerp-L' + (idx + 1);
            var dSel2 = document.querySelector('.duerp-qcm-choice[data-group="' + prefix + '-danger"].selected');
            var dmSel2 = document.querySelector('.duerp-qcm-choice[data-group="' + prefix + '-dommage"].selected');
            var gSel2 = document.getElementById(prefix + '-sel-gravite');
            var eVal2 = document.getElementById(prefix + '-expo-val').value;
            var dcVal2 = document.getElementById(prefix + '-decl-val').value;
            var allOk = (dSel2 && dSel2.getAttribute('data-val') === att.danger) &&
                        (dmSel2 && dmSel2.getAttribute('data-val') === att.dommage) &&
                        (parseInt(gSel2.value) === att.gravite) &&
                        (eVal2 === att.exposition) && (dcVal2 === att.declencheur);
            if (allOk) nbLignesOk++;
        });
        var msgs = [];
        if (nbLignesOk < c.lignes.length) {
            msgs.push('ðŸ“Œ ' + nbLignesOk + '/' + c.lignes.length + ' lignes de risque correctement evaluees');
            msgs.push('ðŸ“Œ Rappel : Probabilite = Exposition Ã— Declencheur');
            msgs.push('ðŸ“Œ Le risque est PRIORITAIRE lorsque Gravite + Probabilite â‰¥ 5');
        }
        if (msgs.length > 0) {
            fb.innerHTML = msgs.join('<br>');
            fb.classList.add('visible');
        }
    }

    // === DUERP MISSION DIRECTEUR ===
    else if (type === 'duer_mission_directeur') {
        var c = currentExo.contenu;

        // Helper: score a qcm_multi question
        function scoreDmQcm(groupId, question, maxPts) {
            var bonnes = new Set(question.reponse || []);
            var els = document.querySelectorAll('.dm-qcm-choice[data-group="' + groupId + '"]');
            var selected = [];
            els.forEach(function(el) { if (el.classList.contains('selected')) selected.push(el.getAttribute('data-id')); });
            var selectedSet = new Set(selected);
            var bonnesTrouvees = 0;
            bonnes.forEach(function(b) { if (selectedSet.has(b)) bonnesTrouvees++; });
            var mauvaisesCochees = selected.filter(function(s) { return !bonnes.has(s); }).length;
            var score = 0;
            if (bonnesTrouvees === bonnes.size && mauvaisesCochees === 0) score = maxPts;
            else if (bonnesTrouvees >= Math.ceil(bonnes.size / 2) && mauvaisesCochees === 0) score = maxPts / 2;
            // Correct visually
            els.forEach(function(el) {
                el.onclick = null; el.style.cursor = 'default';
                var elId = el.getAttribute('data-id');
                if (bonnes.has(elId)) {
                    el.classList.add(selectedSet.has(elId) ? 'correct' : 'show-correct');
                } else if (selectedSet.has(elId)) {
                    el.classList.add('wrong');
                }
            });
            return score;
        }

        // Questions globales
        var questions = c.questions || [];
        questions.forEach(function(q, qi) {
            var pts = q.points || 1;
            if (q.type === 'qcm_multi') {
                var s = scoreDmQcm('dm-gq-' + qi, q, pts);
                total += pts;
                correct += s;
                details.push({ ok: s >= pts, label: q.id + ' (global)', detail: s >= pts ? 'Correct' : (s > 0 ? 'Partiel (' + s + '/' + pts + ')' : 'Incorrect') });
            } else if (q.type === 'ordonner') {
                var elems = q.elements || [];
                var selects = document.querySelectorAll('.dm-ordre-q' + qi);
                var posOk = 0;
                selects.forEach(function(sel) {
                    var row = sel.closest('.dm-ordre-item');
                    var correctIdx = parseInt(row.getAttribute('data-correct'));
                    var selectedPos = parseInt(sel.value) - 1;
                    sel.disabled = true;
                    if (selectedPos === correctIdx) {
                        posOk++;
                        sel.classList.add('correct');
                    } else {
                        sel.classList.add('wrong');
                    }
                });
                var ordreScore = 0;
                if (posOk === elems.length) ordreScore = pts;
                else if (posOk >= Math.ceil(elems.length * 0.6)) ordreScore = pts / 2;
                total += pts;
                correct += ordreScore;
                details.push({ ok: ordreScore >= pts, label: q.id + ' (global)', detail: posOk + '/' + elems.length + ' positions correctes' });
            }
            // Show correction + explication
            var corrEl = document.getElementById('dm-gq-corr-' + qi);
            if (corrEl && q.correction) { corrEl.textContent = 'âœ… ' + q.correction; corrEl.classList.add('visible'); }
            var explEl = document.getElementById('dm-gq-expl-' + qi);
            if (explEl) explEl.classList.add('visible');
        });

        // Situations
        var situations = c.situations || [];
        situations.forEach(function(sit, si) {
            var sitQs = sit.questions || [];
            sitQs.forEach(function(sq, sqi) {
                var pts = sq.points || 2;
                var groupId = 'dm-s' + si + 'q' + sqi;
                var s = scoreDmQcm(groupId, sq, pts);
                total += pts;
                correct += s;
                details.push({ ok: s >= pts, label: sit.id + ' Q' + (sqi + 1), detail: s >= pts ? 'Correct' : (s > 0 ? 'Partiel (' + s + '/' + pts + ')' : 'Incorrect') });
                // Show correction + explication
                var corrEl = document.getElementById(groupId + '-corr');
                if (corrEl && sq.correction) { corrEl.textContent = 'âœ… ' + sq.correction; corrEl.classList.add('visible'); }
                var explEl = document.getElementById(groupId + '-expl');
                if (explEl) explEl.classList.add('visible');
            });
            // Show bilan
            var bilanEl = document.getElementById('dm-bilan-' + si);
            if (bilanEl) bilanEl.classList.add('visible');
        });

        // Mission finale
        var mf = c.mission_finale || {};
        var mfPts = mf.points || 2;
        var mfBonnes = new Set(mf.reponse || []);
        var mfSelected = [];
        document.querySelectorAll('.duerp-mission-row').forEach(function(row) {
            var mId = row.getAttribute('data-mission-id');
            var isChecked = row.classList.contains('checked');
            var shouldBeChecked = mfBonnes.has(mId);
            row.onclick = null; row.style.cursor = 'default';
            if (isChecked) mfSelected.push(mId);
            if (isChecked === shouldBeChecked) {
                row.classList.add('correct');
            } else if (shouldBeChecked) {
                row.classList.add('show-correct');
            } else {
                row.classList.add('wrong');
            }
        });
        // Score: full points if exact match, 0 otherwise
        var mfSelectedSet = new Set(mfSelected);
        var mfExactMatch = mfBonnes.size === mfSelectedSet.size && [...mfBonnes].every(function(b) { return mfSelectedSet.has(b); });
        var mfScore = mfExactMatch ? mfPts : 0;
        total += mfPts;
        correct += mfScore;
        details.push({ ok: mfExactMatch, label: 'Mission finale', detail: mfExactMatch ? 'Correct' : 'Selection incorrecte' });
        // Show correction + explication
        var mfCorrEl = document.getElementById('dm-mission-corr');
        if (mfCorrEl && mf.correction) { mfCorrEl.textContent = 'âœ… ' + mf.correction; mfCorrEl.classList.add('visible'); }
        var mfExplEl = document.getElementById('dm-mission-expl');
        if (mfExplEl) mfExplEl.classList.add('visible');

        // Feedback
        var fb = document.getElementById('dm-feedback');
        if (fb) {
            var pct = total > 0 ? Math.round(correct / total * 100) : 0;
            var msgs = ['ðŸ“Š Score : ' + correct + ' / ' + total + ' points (' + pct + '%)'];
            if (pct < 100) {
                msgs.push('ðŸ“Œ Rappel : Probabilite = Exposition x Declencheur');
                msgs.push('ðŸ“Œ Le risque est PRIORITAIRE lorsque Gravite + Probabilite â‰¥ 5');
            }
            fb.innerHTML = msgs.join('<br>');
            fb.classList.add('visible');
        }
    }

    // QCM Classique validation
    else if (type === 'qcm_classique') {
        const c = currentExo.contenu;
        const isMultiple = !!c.multiple;
        const repIds = Array.isArray(c.reponse) ? c.reponse : (c.reponse != null ? [c.reponse] : []);
        const choices = document.querySelectorAll('.qcm-c-choice');
        if (isMultiple) {
            // Multiple: score = nb correct selections + nb correct non-selections
            total = c.choix.length;
            choices.forEach(el => {
                const id = el.dataset.id;
                const isSelected = el.classList.contains('selected');
                const shouldBeSelected = repIds.includes(id);
                if (isSelected && shouldBeSelected) { correct++; el.classList.add('correct'); }
                else if (isSelected && !shouldBeSelected) { el.classList.add('wrong'); }
                else if (!isSelected && shouldBeSelected) { el.classList.add('show-correct'); }
                else { correct++; } // correctly not selected
                el.style.pointerEvents = 'none';
            });
        } else {
            total = 1;
            const selected = document.querySelector('.qcm-c-choice.selected');
            choices.forEach(el => {
                el.style.pointerEvents = 'none';
                if (repIds.includes(el.dataset.id)) {
                    if (el.classList.contains('selected')) { correct = 1; el.classList.add('correct'); }
                    else { el.classList.add('show-correct'); }
                } else if (el.classList.contains('selected')) {
                    el.classList.add('wrong');
                }
            });
            details.push({ label: c.question.substring(0, 60), ok: correct === 1 });
        }
        // Show explication
        const explEl = document.getElementById('qcmc-explication');
        if (explEl) explEl.style.display = 'block';
    }

    // QCM Serie validation
    else if (type === 'qcm_series_multi') {
        const c = currentExo.contenu;
        (c.questions || []).forEach((q, qi) => {
            const isMultiple = !!q.multiple || Array.isArray(q.reponse);
            const repIds = Array.isArray(q.reponse) ? q.reponse : (q.reponse != null ? [q.reponse] : []);
            const choices = document.querySelectorAll('.qcms-choice[data-qindex="' + qi + '"]');
            let qOk = true;
            if (isMultiple) {
                total += (q.choix || []).length;
                choices.forEach(el => {
                    const id = el.dataset.id;
                    const isSelected = el.classList.contains('selected');
                    const shouldBeSelected = repIds.includes(id);
                    if (isSelected && shouldBeSelected) { correct++; el.classList.add('correct'); }
                    else if (isSelected && !shouldBeSelected) { el.classList.add('wrong'); qOk = false; }
                    else if (!isSelected && shouldBeSelected) { el.classList.add('show-correct'); qOk = false; }
                    else { correct++; }
                    el.style.pointerEvents = 'none';
                });
            } else {
                total += 1;
                qOk = false;
                choices.forEach(el => {
                    el.style.pointerEvents = 'none';
                    if (repIds.includes(el.dataset.id)) {
                        if (el.classList.contains('selected')) { qOk = true; el.classList.add('correct'); }
                        else { el.classList.add('show-correct'); }
                    } else if (el.classList.contains('selected')) {
                        el.classList.add('wrong');
                    }
                });
                if (qOk) correct++;
            }
            details.push({ label: 'Question ' + (qi + 1), ok: qOk });
            const explEl = document.getElementById('qcms-explication-' + qi);
            if (explEl) explEl.style.display = 'block';
        });
    }

    // Categoriser validation
    else if (type === 'categoriser') {
        const c = currentExo.contenu;
        total = (c.items || []).length;
        (c.items || []).forEach(item => {
            const placement = catState.placements[item.id];
            const ok = placement === item.categorie;
            if (ok) correct++;
            details.push({ label: item.label, ok: ok });
            // Visual feedback on placed items
            const placedEl = document.querySelector('.cat-placed[data-id="' + item.id + '"]');
            if (placedEl) { placedEl.classList.add(ok ? 'correct' : 'wrong'); }
            // If not placed, mark as wrong in pool
            if (!placement) {
                const poolItem = document.querySelector('.cat-pool .cat-item[data-id="' + item.id + '"]');
                if (poolItem) poolItem.style.border = '2px solid #ef4444';
            }
        });
        // Disable all interactions
        document.querySelectorAll('.cat-item').forEach(el => { el.style.pointerEvents = 'none'; });
        document.querySelectorAll('.cat-zone').forEach(el => { el.onclick = null; });
        document.querySelectorAll('.cat-placed').forEach(el => { el.onclick = null; });
    }

    // ---- PICTOGRAMME (mode categoriser) ----
    else if (type === 'pictogramme') {
        var s = pictoState;
        total = s.pool.length;
        s.pool.forEach(function(p) {
            var placedCat = s.placed[p.id];
            var ok = placedCat === p.cat;
            if (ok) correct++;
            details.push({ label: p.nom, ok: ok, detail: ok ? PICTO_CAT_NAMES[p.cat] : (placedCat ? PICTO_CAT_NAMES[placedCat] + ' â†’ ' + PICTO_CAT_NAMES[p.cat] : 'Non place â†’ ' + PICTO_CAT_NAMES[p.cat]) });
            // Visual feedback
            var itemEl = document.getElementById('picto-item-' + p.id);
            if (itemEl) {
                itemEl.classList.add(ok ? 'correct' : 'wrong');
            }
        });
        // Disable all interactions
        document.querySelectorAll('.picto-drag-item').forEach(function(el) { el.style.pointerEvents = 'none'; });
        document.querySelectorAll('.picto-cat-zone').forEach(function(el) { el.onclick = null; });
    }

    // === ANALYSE DE COPIE ===
    else if (type === 'analyse_copie') {
        if (acNewState && acNewState.zone) {
            var newRes = acNewFinishAndShow();
            if (!newRes) return;
            return;
        }
        // Save current item first
        acSaveCurrentItem();
        var c = currentExo.contenu;
        var items = c.items || [];

        // Show all items for correction display
        var corrHtml = '';
        items.forEach(function(item, idx) {
            var resp = acState.responses[idx];
            var att = item.attendus || {};
            // Normaliser validee boolean â†’ string
            if (att.validee === true) att.validee = 'oui';
            if (att.validee === false) att.validee = 'non';
            var itemCorrect = 0;
            var itemTotal = 0;

            corrHtml += '<div class="ac-item" style="margin-bottom:16px;">';
            corrHtml += '<div style="font-weight:800; color:#6366f1; margin-bottom:8px;">Item ' + (idx + 1) + ' / ' + items.length + '</div>';
            corrHtml += '<div class="ac-exam-question"><strong>ðŸ“‹ Question :</strong>' + item.question_examen + '</div>';
            corrHtml += '<div class="ac-response-eleve"><strong>âœï¸ Reponse :</strong>' + item.reponse_eleve + '</div>';

            // 1. Verbe (1 pt)
            itemTotal++;
            var verbeOk = resp.verbe === att.verbe;
            if (verbeOk) { itemCorrect++; correct++; }
            total++;
            var verbes = item.verbes_proposes || AC_VERBES;
            corrHtml += '<div class="ac-section"><div class="ac-section-title">1. Verbe d\'action</div><div class="ac-qcu">';
            verbes.forEach(function(v) {
                var cls = '';
                if (v === att.verbe && v === resp.verbe) cls = 'correct';
                else if (v === resp.verbe && v !== att.verbe) cls = 'wrong';
                else if (v === att.verbe) cls = 'show-correct';
                corrHtml += '<div class="ac-choice ' + cls + '" style="pointer-events:none;">' + v.charAt(0).toUpperCase() + v.slice(1) + '</div>';
            });
            corrHtml += '</div></div>';
            details.push({ ok: verbeOk, label: 'Item ' + (idx + 1) + ' â€” Verbe', detail: verbeOk ? 'Correct : ' + att.verbe : 'Repondu : ' + (resp.verbe || 'â€”') + ' | Attendu : ' + att.verbe });

            // 2. Competence (1 pt)
            itemTotal++;
            var compOk = resp.competence === att.competence;
            if (compOk) { itemCorrect++; correct++; }
            total++;
            var compLabels = { C2: 'C2 â€” Analyser', C3: 'C3 â€” Expliquer', C4: 'C4 â€” Proposer', C5: 'C5 â€” Argumenter', C6: 'C6 â€” Communiquer' };
            corrHtml += '<div class="ac-section"><div class="ac-section-title">2. Competence dominante</div><div class="ac-qcu">';
            AC_COMPETENCES.forEach(function(cc) {
                var cls = '';
                if (cc === att.competence && cc === resp.competence) cls = 'correct';
                else if (cc === resp.competence && cc !== att.competence) cls = 'wrong';
                else if (cc === att.competence) cls = 'show-correct';
                corrHtml += '<div class="ac-choice ' + cls + '" style="pointer-events:none;">' + compLabels[cc] + '</div>';
            });
            corrHtml += '</div></div>';
            details.push({ ok: compOk, label: 'Item ' + (idx + 1) + ' â€” Competence', detail: compOk ? 'Correct : ' + att.competence : 'Repondu : ' + (resp.competence || 'â€”') + ' | Attendu : ' + att.competence });

            // 3. ValidÃ©e (1 pt)
            itemTotal++;
            var valOk = resp.validee === att.validee;
            if (valOk) { itemCorrect++; correct++; }
            total++;
            corrHtml += '<div class="ac-section"><div class="ac-section-title">3. Reponse validee ?</div><div class="ac-qcu">';
            ['oui', 'non'].forEach(function(v) {
                var cls = '';
                if (v === att.validee && v === resp.validee) cls = 'correct';
                else if (v === resp.validee && v !== att.validee) cls = 'wrong';
                else if (v === att.validee) cls = 'show-correct';
                corrHtml += '<div class="ac-choice ' + cls + '" style="pointer-events:none;">' + (v === 'oui' ? 'âœ… Oui' : 'âŒ Non') + '</div>';
            });
            corrHtml += '</div></div>';
            details.push({ ok: valOk, label: 'Item ' + (idx + 1) + ' â€” Validee', detail: valOk ? 'Correct' : 'Repondu : ' + (resp.validee || 'â€”') + ' | Attendu : ' + att.validee });

            // 4. Niveau (1 pt) â€” si validÃ©e=oui, sinon pt gratuit
            itemTotal++;
            total++;
            if (att.validee === 'oui') {
                var nivOk = resp.niveau === att.niveau;
                if (nivOk) { itemCorrect++; correct++; }
                var nivLabels = { 1: '1 â€” Insuffisant', 2: '2 â€” Fragile', 3: '3 â€” Satisfaisant', 4: '4 â€” Tres bien' };
                corrHtml += '<div class="ac-section"><div class="ac-section-title">4. Niveau de maitrise</div><div class="ac-qcu">';
                for (var n = 1; n <= 4; n++) {
                    var cls = '';
                    if (n === att.niveau && n === resp.niveau) cls = 'correct';
                    else if (n === resp.niveau && n !== att.niveau) cls = 'wrong';
                    else if (n === att.niveau) cls = 'show-correct';
                    corrHtml += '<div class="ac-choice ' + cls + '" style="pointer-events:none;">' + nivLabels[n] + '</div>';
                }
                corrHtml += '</div></div>';
                details.push({ ok: nivOk, label: 'Item ' + (idx + 1) + ' â€” Niveau', detail: nivOk ? 'Correct : ' + att.niveau : 'Repondu : ' + (resp.niveau || 'â€”') + ' | Attendu : ' + att.niveau });
            } else {
                // Point gratuit si validÃ©e=non (pas de niveau attendu)
                itemCorrect++; correct++;
                details.push({ ok: true, label: 'Item ' + (idx + 1) + ' â€” Niveau', detail: 'Non applicable (reponse non validee)' });
            }

            // 5. Justification (1 pt) â€” au moins 1 mot-clÃ©
            itemTotal++;
            total++;
            var justNorm = norm(resp.justification);
            var justMotsCles = att.justification_mots_cles || [];
            var justOk = justMotsCles.length === 0 || justMotsCles.some(function(mc) { return justNorm.indexOf(norm(mc)) !== -1; });
            if (justOk && resp.justification.trim().length > 0) { itemCorrect++; correct++; }
            else { justOk = false; }
            corrHtml += '<div class="ac-section"><div class="ac-section-title">5. Justification</div>';
            corrHtml += '<textarea class="ac-textarea ' + (justOk ? 'correct' : 'wrong') + '" readonly>' + (resp.justification || '') + '</textarea>';
            if (!justOk) {
                corrHtml += '<div class="ac-correction-hint" style="display:block;">ðŸ’¡ Mots-cles attendus : ' + justMotsCles.join(', ') + '</div>';
            }
            corrHtml += '</div>';
            // 7b: justification_modele
            if (att.justification_modele) {
                corrHtml += '<div class="ac-justification-modele">ðŸ’¡ Modele : ' + att.justification_modele + '</div>';
            }
            details.push({ ok: justOk, label: 'Item ' + (idx + 1) + ' â€” Justification', detail: justOk ? 'Mots-cles trouves' : 'Mots-cles attendus : ' + justMotsCles.join(', ') });

            // 6. Grille C6 (4 pts) â€” tolÃ©rance Â±1
            var c6Att = att.c6 || {};
            if (c6Att.actif) {
                var c6Criteres = c6Att.criteres || [0, 0, 0, 0];
                var c6Points = 0;
                corrHtml += '<div class="ac-section"><div class="ac-section-title">6. Grille C6</div>';
                corrHtml += '<div class="ac-c6-grid">';
                AC_C6_CRITERES.forEach(function(crit, ci) {
                    var given = resp.c6[ci];
                    var expected = c6Criteres[ci];
                    var diff = Math.abs(given - expected);
                    var pts = 0;
                    if (diff === 0) pts = 1;
                    else if (diff === 1) pts = 0.5;
                    c6Points += pts;
                    itemTotal++;
                    total++;
                    correct += pts;
                    itemCorrect += pts;

                    var rowClass = pts === 1 ? 'correct' : pts === 0.5 ? 'partial' : 'wrong';
                    corrHtml += '<div class="ac-c6-row ' + rowClass + '">';
                    corrHtml += '<div class="ac-c6-label">' + crit + '</div>';
                    corrHtml += '<div class="ac-c6-btns">';
                    for (var v = 0; v <= 2; v++) {
                        var btnCls = '';
                        if (v === expected && v === given) btnCls = 'correct';
                        else if (v === given && v !== expected) btnCls = (diff === 1 ? 'partial' : 'wrong');
                        else if (v === expected) btnCls = 'show-correct';
                        corrHtml += '<div class="ac-c6-btn ' + btnCls + '" style="pointer-events:none;">' + v + '</div>';
                    }
                    corrHtml += '</div></div>';
                    // 7c: feedback texte C6 par critere
                    var c6CritKeys = ['vocabulaire', 'syntaxe', 'argumentation', 'presentation'];
                    if (item.explications && item.explications.explication_c6 && item.explications.explication_c6[c6CritKeys[ci]]) {
                        corrHtml += '<div style="padding:4px 12px 8px; font-size:0.8rem; color:#6d28d9; font-style:italic;">';
                        corrHtml += 'â†’ ' + item.explications.explication_c6[c6CritKeys[ci]];
                        corrHtml += '</div>';
                    }
                    details.push({ ok: pts >= 1, label: 'Item ' + (idx + 1) + ' â€” C6 ' + crit, detail: pts === 1 ? 'Exact' : pts === 0.5 ? 'Proche (Â±1)' : 'Repondu ' + given + ' | Attendu ' + expected });
                });
                corrHtml += '</div></div>';
            } else {
                // C6 non actif : 4 pts gratuits
                for (var gi = 0; gi < 4; gi++) {
                    itemTotal++; total++; correct++; itemCorrect++;
                }
                details.push({ ok: true, label: 'Item ' + (idx + 1) + ' â€” C6', detail: 'Non applicable (pas de C6)' });
            }

            // 7. AmÃ©lioration (1 pt) â€” au moins 1 mot-clÃ©
            itemTotal++;
            total++;
            var amelNorm = norm(resp.amelioration);
            var amelMotsCles = att.amelioration_mots_cles || [];
            var amelOk = amelMotsCles.length === 0 || amelMotsCles.some(function(mc) { return amelNorm.indexOf(norm(mc)) !== -1; });
            if (amelOk && resp.amelioration.trim().length > 0) { itemCorrect++; correct++; }
            else { amelOk = false; }
            corrHtml += '<div class="ac-section"><div class="ac-section-title">7. Amelioration</div>';
            corrHtml += '<textarea class="ac-textarea ' + (amelOk ? 'correct' : 'wrong') + '" readonly>' + (resp.amelioration || '') + '</textarea>';
            if (!amelOk) {
                corrHtml += '<div class="ac-correction-hint" style="display:block;">ðŸ’¡ Mots-cles attendus : ' + amelMotsCles.join(', ') + '</div>';
            }
            corrHtml += '</div>';
            details.push({ ok: amelOk, label: 'Item ' + (idx + 1) + ' â€” Amelioration', detail: amelOk ? 'Mots-cles trouves' : 'Mots-cles attendus : ' + amelMotsCles.join(', ') });

            // 7d: Resume + bloc explications pedagogiques
            if (item.explications) {
                var expl = item.explications;
                // Resume visible sans ouvrir le details
                if (expl.resume) {
                    corrHtml += '<div class="ac-expl-resume">ðŸ’¬ ' + expl.resume + '</div>';
                }
                corrHtml += '<details class="ac-explications">';
                corrHtml += '<summary>ðŸ“– Explications pedagogiques</summary>';
                corrHtml += '<div class="ac-expl-body">';
                if (expl.pourquoi_valide_ou_non) {
                    corrHtml += '<div class="ac-expl-block"><div class="ac-expl-label">â“ Pourquoi cette evaluation</div>';
                    corrHtml += '<div class="ac-expl-text">' + expl.pourquoi_valide_ou_non + '</div></div>';
                }
                if (expl.attendu_pedagogique) {
                    corrHtml += '<div class="ac-expl-block"><div class="ac-expl-label">ðŸŽ¯ Attendu pedagogique</div>';
                    corrHtml += '<div class="ac-expl-text">' + expl.attendu_pedagogique + '</div></div>';
                }
                if (expl.exemple_reponse_amelioree) {
                    corrHtml += '<div class="ac-expl-block"><div class="ac-expl-label">âœ¨ Comment faire mieux</div>';
                    corrHtml += '<div class="ac-expl-text">' + expl.exemple_reponse_amelioree + '</div></div>';
                }
                if (expl.exemple_reponse_excellente) {
                    corrHtml += '<div class="ac-expl-block"><div class="ac-expl-label">ðŸ† Reponse excellente</div>';
                    corrHtml += '<div class="ac-expl-text">' + expl.exemple_reponse_excellente + '</div></div>';
                }
                if (expl.erreurs_frequentes && expl.erreurs_frequentes.length > 0) {
                    corrHtml += '<div class="ac-expl-block"><div class="ac-expl-label">âš ï¸ Erreurs frequentes</div>';
                    corrHtml += '<ul class="ac-expl-list">';
                    expl.erreurs_frequentes.forEach(function(err) {
                        corrHtml += '<li>' + err + '</li>';
                    });
                    corrHtml += '</ul></div>';
                }
                // Detail C6 (si C6 + explication_c6)
                if (expl.explication_c6) {
                    corrHtml += '<div class="ac-expl-block"><div class="ac-expl-label">ðŸ“ Detail C6</div>';
                    corrHtml += '<div class="ac-expl-c6-feedback">';
                    var c6Keys = ['vocabulaire', 'syntaxe', 'argumentation', 'presentation'];
                    var c6Labels = ['Vocabulaire', 'Syntaxe', 'Argumentation', 'Presentation'];
                    c6Keys.forEach(function(key, ki) {
                        if (expl.explication_c6[key]) {
                            corrHtml += '<div class="ac-expl-c6-item"><strong>' + c6Labels[ki] + ' :</strong> ' + expl.explication_c6[key] + '</div>';
                        }
                    });
                    corrHtml += '</div></div>';
                }
                if (expl.exemple_reformulation) {
                    corrHtml += '<div class="ac-expl-block"><div class="ac-expl-label">ðŸ’¬ Exemple de reformulation</div>';
                    corrHtml += '<div class="ac-expl-text">' + expl.exemple_reformulation + '</div></div>';
                }
                corrHtml += '</div></details>';
            }

            corrHtml += '</div>'; // close ac-item
        });

        // Replace the zone with correction display
        var zone = document.getElementById('screen-play');
        if (zone) {
            var consigneEl = zone.querySelector('.consigne-box');
            var navEl = document.getElementById('ac-nav');
            if (navEl) navEl.style.display = 'none';
            document.getElementById('ac-item-zone').innerHTML = corrHtml;
            // Hide progress
            var progText = document.getElementById('ac-progress-text');
            if (progText) progText.textContent = 'ðŸ“Š Correction';
            var progBar = document.getElementById('ac-progress-bar');
            if (progBar) progBar.style.display = 'none';
        }
    }

    // Injecte une explication pedagogique globale si presente dans le contenu
    // et si aucune explication specifique n'a deja ete ajoutee.
    if (currentExo && currentExo.contenu) {
        const globalExpl = (currentExo.contenu.explication != null) ? String(currentExo.contenu.explication).trim() : '';
        const hasExplInDetails = details.some(function(d) {
            return d && d.explication && String(d.explication).trim();
        });
        if (globalExpl && !hasExplInDetails) {
            details.push({
                ok: true,
                label: 'Explication pedagogique',
                explication: globalExpl
            });
        } else if (!globalExpl && !hasExplInDetails) {
            var explFallbackByType = {
                texte_trous: 'Relis le texte complet : repere les indices de sens et la cohÃ©rence grammaticale de chaque trou.',
                relier: 'Associe chaque element par logique de sens : definition, fonction ou consequence.',
                ordre: 'Verifie la chronologie logique : cause, action, consequence.',
                hierarchiser: 'Classe du plus prioritaire/efficace au moins prioritaire selon la logique de prevention.',
                pendu: 'Observe l\'indice, le champ lexical et les notions du module pour identifier le bon terme.',
                mots_croises: 'Les definitions renvoient au vocabulaire cle du cours : repere le mot technique attendu.',
                tableau: 'Chaque case doit respecter la logique de classement du tableau (ligne/colonne).',
                categoriser: 'Le tri se fait par categorie : compare la definition de chaque categorie avant de classer.',
                scenario: 'Une bonne decision en prevention est celle qui protege d\'abord et rÃ©duit le risque a la source.',
                pad: 'Rappel PAD : Danger â†’ Situation dangereuse â†’ Evenement declencheur â†’ Dommage.',
                prevention: 'Hierarchie de prevention : Supprimer > Reduire > Protection collective > EPI > Formation.',
                estimation_risque: 'Le niveau de risque depend du croisement Gravite Ã— Probabilite (Exposition + Declencheur).',
                pictogramme: 'Identifie d\'abord la famille visuelle du pictogramme (obligation, interdiction, danger, secours...).'
            };
            var fallback = explFallbackByType[type];
            if (fallback) {
                details.push({
                    ok: true,
                    label: 'Explication pedagogique',
                    explication: fallback
                });
            }
        }
    }

    document.getElementById('btn-validate').disabled = true;
    showResults(correct, total, details);
}

// =====================================================================
// RESULTS
// =====================================================================

function showResults(correct, total, details) {
    corrected = true;
    const pct = total > 0 ? Math.round(correct / total * 100) : 0;
    const colorClass = pct >= 70 ? 'score-ok' : pct >= 40 ? 'score-mid' : 'score-low';
    const msgs = pct >= 80 ? 'Excellent !' : pct >= 60 ? 'Bien joue !' : pct >= 40 ? 'Pas mal, continue !' : 'Courage, tu peux faire mieux !';

    let html = '<div class="results-box">';
    html += '<div style="font-size:2rem;">ðŸ†</div>';
    html += '<div class="score-big ' + colorClass + '">' + pct + '%</div>';
    html += '<div class="score-label">' + correct + ' / ' + total + ' â€” ' + msgs + '</div>';
    html += '<div class="results-actions">';
    html += '<button class="btn-retry" onclick="retryExercice()">ðŸ”„ Refaire</button>';
    html += '<button class="btn-back-list" onclick="backToList()">â† Retour</button>';
    html += '</div></div>';

    // Correction details
    if (details && details.length > 0) {
        html += '<div class="correction-list">';
        details.forEach(d => {
            html += '<div class="corr-item ' + (d.ok ? 'corr-ok' : 'corr-ko') + '">';
            html += '<span class="corr-icon">' + (d.ok ? 'âœ“' : 'âœ—') + '</span>';
            html += '<div class="corr-text"><strong>' + d.label + '</strong>';
            if (d.detail) html += '<br><span style="font-size:0.8rem; color:#64748b;">' + d.detail + '</span>';
            if (d.explication) html += '<br><span style="display:inline-block; margin-top:6px; font-size:0.85rem; color:#334155; background:#f8fafc; border-left:3px solid #60a5fa; padding:8px 10px; border-radius:6px;">ðŸ’¡ ' + d.explication + '</span>';
            html += '</div></div>';
        });
        html += '</div>';
    }

    const resultsZone = document.getElementById('zone-results');
    resultsZone.innerHTML = html;
    resultsZone.style.display = '';
    resultsZone.scrollIntoView({ behavior: 'smooth' });
}

// =====================================================================
// PICTOGRAMMES â€” BANQUE + RENDERERS
// =====================================================================
var PICTO_DB = [
    // OBLIGATION (12)
    {id:'OB01',nom:'Port des gants obligatoire',image:'pictogrammes/images/OBLIGATION-gants.jpg',cat:'obligation'},
    {id:'OB02',nom:'Port du casque obligatoire',image:'pictogrammes/images/OBLIGATION-casque.jpg',cat:'obligation'},
    {id:'OB03',nom:'Chaussures de securite obligatoires',image:'pictogrammes/images/OBLIGATION-chaussures.jpg',cat:'obligation'},
    {id:'OB04',nom:'Lunettes de protection obligatoires',image:'pictogrammes/images/OBLIGATION-lunettes.jpg',cat:'obligation'},
    {id:'OB05',nom:'Visiere de protection obligatoire',image:'pictogrammes/images/OBLIGATION-visiere.jpg',cat:'obligation'},
    {id:'OB06',nom:'Casque antibruit obligatoire',image:'pictogrammes/images/OBLIGATION-casque-antibruit.jpg',cat:'obligation'},
    {id:'OB07',nom:'Protection des voies respiratoires obligatoire',image:'pictogrammes/images/OBLIGATION-protection-voies-espiratoires.jpg',cat:'obligation'},
    {id:'OB08',nom:'Combinaison de protection obligatoire',image:'pictogrammes/images/OBLIGATION-combinaison.jpg',cat:'obligation'},
    {id:'OB09',nom:'Harnais de securite obligatoire',image:'pictogrammes/images/OBLIGATION-harnais.jpg',cat:'obligation'},
    {id:'OB10',nom:'Obligation generale',image:'pictogrammes/images/OBLIGATION-general.jpg',cat:'obligation'},
    {id:'OB11',nom:'Consulter la notice obligatoire',image:'pictogrammes/images/OBLIGATION-consulter-notice.jpg',cat:'obligation'},
    {id:'OB12',nom:'Passage obligatoire pour pietons',image:'pictogrammes/images/OBLIGATION-pieton.jpg',cat:'obligation'},
    // INTERDICTION (8)
    {id:'IN01',nom:'Interdiction de fumer',image:'pictogrammes/images/INTERDIT-fumer.jpg',cat:'interdiction'},
    {id:'IN02',nom:'Flamme nue interdite',image:'pictogrammes/images/INTERDIT-flamme.jpg',cat:'interdiction'},
    {id:'IN03',nom:'Acces interdit',image:'pictogrammes/images/INTERDIT-entrer.jpg',cat:'interdiction'},
    {id:'IN04',nom:'Defense de toucher',image:'pictogrammes/images/INTERDIT-toucher.jpg',cat:'interdiction'},
    {id:'IN05',nom:'Eau interdite sur ce materiel',image:'pictogrammes/images/INTERDIT-seau-eau.jpg',cat:'interdiction'},
    {id:'IN06',nom:'Interdit aux pietons',image:'pictogrammes/images/INTERDIT-pietons.jpg',cat:'interdiction'},
    {id:'IN07',nom:'Interdit aux chariots',image:'pictogrammes/images/INTERDIT-chariot.jpg',cat:'interdiction'},
    {id:'IN08',nom:'Interdiction de boire et manger',image:'pictogrammes/images/INTERDIT-boire.jpg',cat:'interdiction'},
    // DANGER (20)
    {id:'DA01',nom:'Danger electrique',image:'pictogrammes/images/DANGER-electricite.jpg',cat:'danger'},
    {id:'DA02',nom:'Danger de chute',image:'pictogrammes/images/DANGER-chute.jpg',cat:'danger'},
    {id:'DA03',nom:'Danger de trebuchement',image:'pictogrammes/images/DANGER-trebuchement.jpg',cat:'danger'},
    {id:'DA04',nom:'Danger general',image:'pictogrammes/images/DANGER-general.jpg',cat:'danger'},
    {id:'DA05',nom:'Produit inflammable',image:'pictogrammes/images/DANGER-produit-inflammable.jpg',cat:'danger'},
    {id:'DA06',nom:'Produit explosif',image:'pictogrammes/images/DANGER-produit-explosif.jpg',cat:'danger'},
    {id:'DA07',nom:'Produit toxique',image:'pictogrammes/images/DANGER-produit-toxique.jpg',cat:'danger'},
    {id:'DA08',nom:'Produit nocif / irritant',image:'pictogrammes/images/DANGER-produit-nocif.jpg',cat:'danger'},
    {id:'DA09',nom:'Produit corrosif',image:'pictogrammes/images/DANGER-produit-corrosif.jpg',cat:'danger'},
    {id:'DA10',nom:'Produit comburant',image:'pictogrammes/images/DANGER-comburant.jpg',cat:'danger'},
    {id:'DA11',nom:'Atmosphere explosive',image:'pictogrammes/images/DANGER-atmosphere-explosive.jpg',cat:'danger'},
    {id:'DA12',nom:'Risque biologique',image:'pictogrammes/images/DANGER-risque-biologique.jpg',cat:'danger'},
    {id:'DA13',nom:'Danger radioactif',image:'pictogrammes/images/DANGER-radioactivite.jpg',cat:'danger'},
    {id:'DA14',nom:'Radiations non ionisantes',image:'pictogrammes/images/DANGER-radiations-non-ionisantes.jpg',cat:'danger'},
    {id:'DA15',nom:'Danger laser',image:'pictogrammes/images/DANGER-laser.jpg',cat:'danger'},
    {id:'DA16',nom:'Charge suspendue',image:'pictogrammes/images/DANGER-charge-suspendue.jpg',cat:'danger'},
    {id:'DA17',nom:'Danger chariot',image:'pictogrammes/images/DANGER-chariot.jpg',cat:'danger'},
    {id:'DA18',nom:'Champ magnetique',image:'pictogrammes/images/DANGER-champ-magnetique.jpg',cat:'danger'},
    {id:'DA19',nom:'Danger froid / gel',image:'pictogrammes/images/DANGER-froid-gel.jpg',cat:'danger'},
    {id:'DA20',nom:'Bande de signalisation',image:'pictogrammes/images/DANGER-bande-signalisation.jpg',cat:'danger'},
    // INCENDIE (14)
    {id:'IC01',nom:'Extincteur',image:'pictogrammes/images/INCENDIE-extincteur.jpg',cat:'incendie'},
    {id:'IC02',nom:'Alarme incendie',image:'pictogrammes/images/INCENDIE-alarme.jpg',cat:'incendie'},
    {id:'IC03',nom:'Lance a incendie',image:'pictogrammes/images/INCENDIE-lance.jpg',cat:'incendie'},
    {id:'IC04',nom:'Echelle incendie',image:'pictogrammes/images/INCENDIE-echelle.jpg',cat:'incendie'},
    {id:'IC05',nom:'Equipement incendie',image:'pictogrammes/images/INCENDIE-equipement.jpg',cat:'incendie'},
    {id:'IC06',nom:'Telephone urgence incendie',image:'pictogrammes/images/INCENDIE-telephone.jpg',cat:'incendie'},
    {id:'IC07',nom:'Fleche incendie haut',image:'pictogrammes/images/INCENDIE-fleche-haut.jpg',cat:'incendie'},
    {id:'IC08',nom:'Fleche incendie bas',image:'pictogrammes/images/INCENDIE-fleche-bas.jpg',cat:'incendie'},
    {id:'IC09',nom:'Fleche incendie droite',image:'pictogrammes/images/INCENDIE-fleche-droite.jpg',cat:'incendie'},
    {id:'IC10',nom:'Fleche incendie gauche',image:'pictogrammes/images/INCENDIE-fleche-gauche.jpg',cat:'incendie'},
    {id:'IC11',nom:'Fleche incendie haut-droit',image:'pictogrammes/images/INCENDIE-fleche-haut-droit.jpg',cat:'incendie'},
    {id:'IC12',nom:'Fleche incendie haut-gauche',image:'pictogrammes/images/INCENDIE-fleche-haut-gauche.jpg',cat:'incendie'},
    {id:'IC13',nom:'Fleche incendie bas-droit',image:'pictogrammes/images/INCENDIE-fleche-bas-droit.jpg',cat:'incendie'},
    {id:'IC14',nom:'Fleche incendie bas-gauche',image:'pictogrammes/images/INCENDIE-fleche-bas-gauche.jpg',cat:'incendie'},
    // SECOURS (17)
    {id:'SE01',nom:'Sortie de secours vers la droite',image:'pictogrammes/images/SECOURS-sortie-vers-droite.jpg',cat:'secours'},
    {id:'SE02',nom:'Sortie de secours vers la gauche',image:'pictogrammes/images/SECOURS-sortie-vers-gauche.jpg',cat:'secours'},
    {id:'SE03',nom:'Point de rassemblement',image:'pictogrammes/images/SECOURS-point-rassemblement.jpg',cat:'secours'},
    {id:'SE04',nom:'Defibrillateur',image:'pictogrammes/images/SECOURS-defibrillateur.jpg',cat:'secours'},
    {id:'SE05',nom:'Premiers secours',image:'pictogrammes/images/SECOURS-croix.jpg',cat:'secours'},
    {id:'SE06',nom:'Civiere',image:'pictogrammes/images/SECOURS-civiere.jpg',cat:'secours'},
    {id:'SE07',nom:'Douche de securite',image:'pictogrammes/images/SECOURS-douche-securite.jpg',cat:'secours'},
    {id:'SE08',nom:'Douche oculaire',image:'pictogrammes/images/SECOURS-douche-oeil.jpg',cat:'secours'},
    {id:'SE09',nom:'Telephone urgence secours',image:'pictogrammes/images/SECOURS-telephone-urgence.jpg',cat:'secours'},
    {id:'SE10',nom:'Refuge temporaire evacuation',image:'pictogrammes/images/SECOURS-refuge-temporaire-evacuation.jpg',cat:'secours'},
    {id:'SE11',nom:'Fleche secours haut',image:'pictogrammes/images/SECOURS-fleche-haut.jpg',cat:'secours'},
    {id:'SE12',nom:'Fleche secours bas',image:'pictogrammes/images/SECOURS-fleche-bas.jpg',cat:'secours'},
    {id:'SE13',nom:'Fleche secours droite',image:'pictogrammes/images/SECOURS-fleche-droite.jpg',cat:'secours'},
    {id:'SE14',nom:'Fleche secours gauche',image:'pictogrammes/images/SECOURS-fleche-gauche.jpg',cat:'secours'},
    {id:'SE15',nom:'Fleche secours haut-droit',image:'pictogrammes/images/SECOURS-fleche-haut-droit.jpg',cat:'secours'},
    {id:'SE16',nom:'Fleche secours haut-gauche',image:'pictogrammes/images/SECOURS-fleche-haut-gauche.jpg',cat:'secours'},
    {id:'SE17',nom:'Fleche secours bas-droit',image:'pictogrammes/images/SECOURS-fleche-bas-droit.jpg',cat:'secours'},
    {id:'SE18',nom:'Fleche secours bas-gauche',image:'pictogrammes/images/SECOURS-fleche-bas-gauche.jpg',cat:'secours'},
    // SGH - Produits chimiques (9)
    {id:'SG01',nom:'Bombe explosante',image:'pictogrammes/images/SGH01_BombeExplosant.jpg',cat:'sgh'},
    {id:'SG02',nom:'Flamme',image:'pictogrammes/images/SGH02_Flamme.jpg',cat:'sgh'},
    {id:'SG03',nom:'Flamme sur cercle',image:'pictogrammes/images/SGH03_FlammeSurCercle.jpg',cat:'sgh'},
    {id:'SG04',nom:'Bouteille de gaz',image:'pictogrammes/images/SGH04_BouteilleGaz.jpg',cat:'sgh'},
    {id:'SG05',nom:'Corrosion',image:'pictogrammes/images/SGH05_Corrosion.jpg',cat:'sgh'},
    {id:'SG06',nom:'Tete de mort',image:'pictogrammes/images/SGH06_TeteDeMort.jpg',cat:'sgh'},
    {id:'SG07',nom:'Point d\'exclamation',image:'pictogrammes/images/SGH07_PointExclamation.jpg',cat:'sgh'},
    {id:'SG08',nom:'Danger pour la sante',image:'pictogrammes/images/SGH08_DangerSante.jpg',cat:'sgh'},
    {id:'SG09',nom:'Environnement',image:'pictogrammes/images/SGH09_Environnement.jpg',cat:'sgh'}
];
var PICTO_CAT_NAMES = { obligation: 'Obligation', interdiction: 'Interdiction', danger: 'Danger', incendie: 'Incendie', secours: 'Secours', sgh: 'Produits chimiques (SGH)' };
var PICTO_CAT_ICONS = { obligation: 'ðŸ”µ', interdiction: 'ðŸ”´', danger: 'âš ï¸', incendie: 'ðŸ”¥', secours: 'ðŸŸ¢', sgh: 'â˜£ï¸' };

function pictoShuffle(arr) { var a = arr.slice(); for (var i = a.length - 1; i > 0; i--) { var j = Math.floor(Math.random() * (i + 1)); var t = a[i]; a[i] = a[j]; a[j] = t; } return a; }

function pictoGetPool(c) {
    var cats = c.categories || ['obligation','interdiction','danger','incendie','secours','sgh'];
    var pool = PICTO_DB.filter(function(p) { return cats.indexOf(p.cat) !== -1; });
    var nb = Math.min(c.nb || 8, pool.length);
    return pictoShuffle(pool).slice(0, nb);
}

// --- PICTO STATE ---
var pictoState = {};

// --- MAIN RENDERER ---
function renderPictogramme(zone, c) {
    var mode = c.mode || 'quiz_image';
    if (mode === 'quiz_image') renderPictoQuizImage(zone, c);
    else if (mode === 'nom_vers_image') renderPictoNomVersImage(zone, c);
    else if (mode === 'categoriser') renderPictoCategoriser(zone, c);
    else if (mode === 'memory') renderPictoMemory(zone, c);
    else if (mode === 'speed') renderPictoSpeed(zone, c);
    else if (mode === 'escape_game') renderPictoEscapeGame(zone, c);
    else zone.innerHTML = '<div class="empty-msg">Mode pictogramme non supporte.</div>';
}

// =====================================================================
// MODE 1 : QUIZ IMAGE (image â†’ 4 noms)
// =====================================================================
function renderPictoQuizImage(zone, c) {
    var pool = pictoGetPool(c);
    pictoState = { pool: pool, idx: 0, correct: 0, answers: [] };
    zone.innerHTML = '<div class="picto-progress" id="picto-progress">1 / ' + pool.length + '</div>' +
        '<div class="picto-progress-bar"><div class="picto-progress-fill" id="picto-progress-fill" style="width:0%"></div></div>' +
        '<div id="picto-question-zone"></div>';
    pictoShowQuestion();
}
function pictoShowQuestion() {
    var s = pictoState;
    if (s.idx >= s.pool.length) { pictoFinish(); return; }
    var q = s.pool[s.idx];
    document.getElementById('picto-progress').textContent = (s.idx + 1) + ' / ' + s.pool.length;
    document.getElementById('picto-progress-fill').style.width = ((s.idx / s.pool.length) * 100) + '%';
    // Get 3 wrong answers from same category first, then any
    var wrongs = PICTO_DB.filter(function(p) { return p.id !== q.id; });
    wrongs = pictoShuffle(wrongs).slice(0, 3);
    var choices = pictoShuffle([q].concat(wrongs));
    var html = '<div style="text-align:center;">';
    html += '<span class="picto-cat-label picto-cat-' + q.cat + '">' + PICTO_CAT_ICONS[q.cat] + ' ' + PICTO_CAT_NAMES[q.cat] + '</span>';
    html += '</div>';
    html += '<img src="' + q.image + '" class="picto-quiz-img" alt="Pictogramme">';
    html += '<div class="picto-choices">';
    choices.forEach(function(ch) {
        html += '<div class="picto-choice" data-id="' + ch.id + '" onclick="pictoSelectAnswer(this)">' + ch.nom + '</div>';
    });
    html += '</div>';
    document.getElementById('picto-question-zone').innerHTML = html;
}
function pictoSelectAnswer(el) {
    var s = pictoState;
    if (el.classList.contains('correct') || el.classList.contains('wrong')) return;
    var q = s.pool[s.idx];
    var chosen = el.dataset.id;
    var ok = chosen === q.id;
    if (ok) s.correct++;
    s.answers.push({ picto: q, chosen: chosen, ok: ok });
    // Highlight
    document.querySelectorAll('.picto-choice').forEach(function(c) {
        if (c.dataset.id === q.id) c.classList.add('correct');
        else if (c === el && !ok) c.classList.add('wrong');
        c.style.pointerEvents = 'none';
    });
    setTimeout(function() { s.idx++; pictoShowQuestion(); }, ok ? 600 : 1200);
}
function pictoFinish() {
    var s = pictoState;
    document.getElementById('picto-progress-fill').style.width = '100%';
    var details = s.answers.map(function(a) {
        return { ok: a.ok, label: a.picto.nom, detail: a.ok ? 'Correct' : 'Mauvaise reponse' };
    });
    showResults(s.correct, s.pool.length, details);
}

// =====================================================================
// MODE 2 : NOM VERS IMAGE (nom â†’ 4 images)
// =====================================================================
function renderPictoNomVersImage(zone, c) {
    var pool = pictoGetPool(c);
    pictoState = { pool: pool, idx: 0, correct: 0, answers: [] };
    zone.innerHTML = '<div class="picto-progress" id="picto-progress">1 / ' + pool.length + '</div>' +
        '<div class="picto-progress-bar"><div class="picto-progress-fill" id="picto-progress-fill" style="width:0%"></div></div>' +
        '<div id="picto-question-zone"></div>';
    pictoShowNomQuestion();
}
function pictoShowNomQuestion() {
    var s = pictoState;
    if (s.idx >= s.pool.length) { pictoFinishNom(); return; }
    var q = s.pool[s.idx];
    document.getElementById('picto-progress').textContent = (s.idx + 1) + ' / ' + s.pool.length;
    document.getElementById('picto-progress-fill').style.width = ((s.idx / s.pool.length) * 100) + '%';
    var wrongs = PICTO_DB.filter(function(p) { return p.id !== q.id; });
    wrongs = pictoShuffle(wrongs).slice(0, 3);
    var choices = pictoShuffle([q].concat(wrongs));
    var html = '<div style="text-align:center;">';
    html += '<span class="picto-cat-label picto-cat-' + q.cat + '">' + PICTO_CAT_ICONS[q.cat] + ' ' + PICTO_CAT_NAMES[q.cat] + '</span>';
    html += '<h3 style="margin:10px 0 20px; font-size:1.2rem; color:#1e293b;">' + q.nom + '</h3>';
    html += '</div>';
    html += '<div class="picto-choices" style="grid-template-columns: repeat(2, 1fr);">';
    choices.forEach(function(ch) {
        html += '<div class="picto-choice" data-id="' + ch.id + '" onclick="pictoSelectNomAnswer(this)" style="padding:10px;">';
        html += '<img src="' + ch.image + '" class="picto-choice-img" alt="Pictogramme">';
        html += '</div>';
    });
    html += '</div>';
    document.getElementById('picto-question-zone').innerHTML = html;
}
function pictoSelectNomAnswer(el) {
    var s = pictoState;
    var q = s.pool[s.idx];
    var chosen = el.dataset.id;
    var ok = chosen === q.id;
    if (ok) s.correct++;
    s.answers.push({ picto: q, chosen: chosen, ok: ok });
    document.querySelectorAll('.picto-choice').forEach(function(c) {
        if (c.dataset.id === q.id) c.classList.add('correct');
        else if (c === el && !ok) c.classList.add('wrong');
        c.style.pointerEvents = 'none';
    });
    setTimeout(function() { s.idx++; pictoShowNomQuestion(); }, ok ? 600 : 1200);
}
function pictoFinishNom() {
    var s = pictoState;
    document.getElementById('picto-progress-fill').style.width = '100%';
    var details = s.answers.map(function(a) {
        return { ok: a.ok, label: a.picto.nom, detail: a.ok ? 'Correct' : 'Mauvaise reponse' };
    });
    showResults(s.correct, s.pool.length, details);
}

// =====================================================================
// MODE 3 : CATEGORISER (trier par catÃ©gorie)
// =====================================================================
function renderPictoCategoriser(zone, c) {
    var pool = pictoGetPool(c);
    var cats = [];
    pool.forEach(function(p) { if (cats.indexOf(p.cat) === -1) cats.push(p.cat); });
    var shuffled = pictoShuffle(pool);
    pictoState = { pool: pool, cats: cats, placed: {} };
    var html = '<div class="picto-cat-items" id="picto-cat-items">';
    shuffled.forEach(function(p) {
        html += '<div class="picto-drag-item" data-id="' + p.id + '" data-cat="' + p.cat + '" title="' + p.nom + '" id="picto-item-' + p.id + '">';
        html += '<img src="' + p.image + '" alt="' + p.nom + '" draggable="false">';
        html += '</div>';
    });
    html += '</div>';
    html += '<p style="text-align:center; color:#64748b; font-size:0.85rem; margin:12px 0;">Clique sur un pictogramme puis clique sur sa categorie</p>';
    html += '<div class="picto-cat-container" id="picto-cat-zones">';
    cats.forEach(function(cat) {
        html += '<div class="picto-cat-zone" data-cat="' + cat + '" onclick="pictoCatZoneClick(\'' + cat + '\')">';
        html += '<div class="picto-cat-zone-title picto-cat-' + cat + '">' + PICTO_CAT_ICONS[cat] + ' ' + PICTO_CAT_NAMES[cat] + '</div>';
        html += '<div class="picto-cat-dropped" id="picto-dropped-' + cat + '"></div>';
        html += '</div>';
    });
    html += '</div>';
    zone.innerHTML = html;
    // Click to select
    document.querySelectorAll('.picto-drag-item').forEach(function(item) {
        item.addEventListener('click', function() {
            if (corrected) return;
            document.querySelectorAll('.picto-drag-item').forEach(function(i) { i.style.outline = ''; });
            item.style.outline = '3px solid #3b82f6';
            pictoState.selectedItem = item.dataset.id;
        });
    });
}
window.pictoCatZoneClick = function(cat) {
    if (corrected) return;
    var s = pictoState;
    if (!s.selectedItem) return;
    var itemEl = document.getElementById('picto-item-' + s.selectedItem);
    if (!itemEl) return;
    var dropZone = document.getElementById('picto-dropped-' + cat);
    dropZone.appendChild(itemEl);
    itemEl.style.outline = '';
    s.placed[s.selectedItem] = cat;
    s.selectedItem = null;
};

// =====================================================================
// MODE 4 : MEMORY (image â†” nom)
// =====================================================================
function renderPictoMemory(zone, c) {
    var pool = pictoGetPool(c);
    var nb = Math.min(pool.length, 8); // Max 8 paires pour memory
    pool = pool.slice(0, nb);
    var cards = [];
    pool.forEach(function(p) {
        cards.push({ pairId: p.id, type: 'image', content: p.image, nom: p.nom });
        cards.push({ pairId: p.id, type: 'text', content: p.nom, nom: p.nom });
    });
    cards = pictoShuffle(cards);
    pictoState = { cards: cards, flipped: [], matched: new Set(), attempts: 0, nbPairs: nb, busy: false };
    var cols = nb <= 6 ? 4 : 4;
    var html = '<div class="picto-mem-board" id="picto-mem-board" style="grid-template-columns:repeat(' + cols + ',1fr);">';
    cards.forEach(function(card, i) {
        html += '<div class="picto-mem-card" data-idx="' + i + '" onclick="pictoFlipCard(this)">';
        html += '<div class="mem-back">?</div>';
        if (card.type === 'image') {
            html += '<div class="mem-face"><img src="' + card.content + '" alt="Pictogramme"></div>';
        } else {
            html += '<div class="mem-face"><div class="mem-face-text">' + card.content + '</div></div>';
        }
        html += '</div>';
    });
    html += '</div>';
    html += '<div class="mem-attempts" id="picto-mem-attempts" style="text-align:center; margin-top:12px; color:#64748b; font-weight:600;">Tentatives : 0</div>';
    zone.innerHTML = html;
}
window.pictoFlipCard = function(el) {
    var s = pictoState;
    if (s.busy || corrected) return;
    var idx = parseInt(el.dataset.idx);
    if (el.classList.contains('flipped') || el.classList.contains('matched')) return;
    el.classList.add('flipped');
    s.flipped.push(idx);
    if (s.flipped.length === 2) {
        s.attempts++;
        document.getElementById('picto-mem-attempts').textContent = 'Tentatives : ' + s.attempts;
        var i1 = s.flipped[0], i2 = s.flipped[1];
        var c1 = s.cards[i1], c2 = s.cards[i2];
        if (c1.pairId === c2.pairId && i1 !== i2) {
            s.matched.add(c1.pairId);
            document.querySelector('.picto-mem-card[data-idx="' + i1 + '"]').classList.add('matched');
            document.querySelector('.picto-mem-card[data-idx="' + i2 + '"]').classList.add('matched');
            s.flipped = [];
            if (s.matched.size === s.nbPairs) {
                setTimeout(pictoFinishMemory, 500);
            }
        } else {
            s.busy = true;
            setTimeout(function() {
                document.querySelector('.picto-mem-card[data-idx="' + i1 + '"]').classList.remove('flipped');
                document.querySelector('.picto-mem-card[data-idx="' + i2 + '"]').classList.remove('flipped');
                s.flipped = [];
                s.busy = false;
            }, 1000);
        }
    }
};
function pictoFinishMemory() {
    var s = pictoState;
    var erreurs = Math.max(0, s.attempts - s.nbPairs);
    var penalite = Math.floor(erreurs / 2);
    var score = Math.max(0, s.nbPairs - penalite);
    var details = [{ label: s.nbPairs + ' paires trouvees en ' + s.attempts + ' tentatives', ok: erreurs === 0 }];
    showResults(score, s.nbPairs, details);
}

// =====================================================================
// MODE 5 : SPEED CHALLENGE (chrono 60s)
// =====================================================================
function renderPictoSpeed(zone, c) {
    var pool = pictoGetPool(c);
    if (pool.length < 4) pool = pictoGetPool({ categories: ['obligation','interdiction','danger','incendie','secours','sgh'], nb: 20 });
    pictoState = { pool: pool, idx: 0, correct: 0, total: 0, timer: 60, interval: null, answers: [] };
    zone.innerHTML = '<div class="picto-speed-timer" id="picto-speed-timer">60</div>' +
        '<div class="picto-speed-score" id="picto-speed-score">Score : 0</div>' +
        '<div id="picto-question-zone"></div>';
    pictoSpeedStart();
}
function pictoSpeedStart() {
    var s = pictoState;
    s.interval = setInterval(function() {
        s.timer--;
        var timerEl = document.getElementById('picto-speed-timer');
        if (timerEl) {
            timerEl.textContent = s.timer;
            if (s.timer <= 10) timerEl.classList.add('urgent');
        }
        if (s.timer <= 0) {
            clearInterval(s.interval);
            pictoSpeedFinish();
        }
    }, 1000);
    pictoSpeedNext();
}
function pictoSpeedNext() {
    var s = pictoState;
    if (s.timer <= 0) return;
    // Pick random from pool
    var q = s.pool[Math.floor(Math.random() * s.pool.length)];
    s.currentQ = q;
    var wrongs = PICTO_DB.filter(function(p) { return p.id !== q.id; });
    wrongs = pictoShuffle(wrongs).slice(0, 3);
    var choices = pictoShuffle([q].concat(wrongs));
    var html = '<img src="' + q.image + '" class="picto-quiz-img" alt="Pictogramme">';
    html += '<div class="picto-choices">';
    choices.forEach(function(ch) {
        html += '<div class="picto-choice" data-id="' + ch.id + '" onclick="pictoSpeedAnswer(this)">' + ch.nom + '</div>';
    });
    html += '</div>';
    document.getElementById('picto-question-zone').innerHTML = html;
}
window.pictoSpeedAnswer = function(el) {
    var s = pictoState;
    if (s.timer <= 0) return;
    var q = s.currentQ;
    var ok = el.dataset.id === q.id;
    s.total++;
    if (ok) s.correct++;
    s.answers.push({ picto: q, ok: ok });
    document.getElementById('picto-speed-score').textContent = 'Score : ' + s.correct + ' / ' + s.total;
    // Flash color briefly
    document.querySelectorAll('.picto-choice').forEach(function(c) {
        if (c.dataset.id === q.id) c.classList.add('correct');
        else if (c === el && !ok) c.classList.add('wrong');
        c.style.pointerEvents = 'none';
    });
    setTimeout(pictoSpeedNext, 400);
};
function pictoSpeedFinish() {
    var s = pictoState;
    var details = s.answers.map(function(a) {
        return { ok: a.ok, label: a.picto.nom, detail: a.ok ? 'Correct' : 'Faux' };
    });
    showResults(s.correct, s.total > 0 ? s.total : 1, details);
}

// =====================================================================
// MODE 6 : ESCAPE GAME (Ã©preuves enchaÃ®nÃ©es)
// =====================================================================
function renderPictoEscapeGame(zone, c) {
    var epreuves = c.epreuves || [];
    if (epreuves.length === 0) {
        zone.innerHTML = '<div class="empty-msg">Aucune epreuve definie pour cet escape game.</div>';
        return;
    }
    // RÃ©soudre les pictos par ID pour chaque Ã©preuve
    epreuves.forEach(function(ep) {
        if (ep.pictos && Array.isArray(ep.pictos)) {
            ep.resolvedPictos = ep.pictos.map(function(id) {
                return PICTO_DB.find(function(p) { return p.id === id; });
            }).filter(Boolean);
        } else {
            ep.resolvedPictos = pictoGetPool({ categories: c.categories || ['obligation','interdiction','danger','incendie','secours','sgh'], nb: 4 });
        }
    });
    pictoState = { epreuves: epreuves, currentEp: 0, totalCorrect: 0, totalQuestions: 0, epResults: [] };
    var html = '<div class="escape-container">';
    html += '<div class="escape-title">' + (c.consigne || 'Escape Game : Mission Securite !') + '</div>';
    html += '<div class="escape-progress" id="escape-progress">';
    epreuves.forEach(function(ep, i) {
        html += '<div class="escape-step' + (i === 0 ? ' active' : '') + '" id="escape-step-' + i + '">';
        html += '<div class="escape-lock" id="escape-lock-' + i + '">ðŸ”’</div>';
        html += '<div class="escape-step-num">' + (i + 1) + '</div>';
        html += '</div>';
    });
    html += '</div>';
    html += '<div class="escape-epreuve" id="escape-epreuve-zone"></div>';
    html += '</div>';
    zone.innerHTML = html;
    escapeLoadEpreuve(0);
}

function escapeLoadEpreuve(idx) {
    var s = pictoState;
    var ep = s.epreuves[idx];
    s.currentEp = idx;
    // Mettre Ã  jour les cadenas
    for (var i = 0; i < s.epreuves.length; i++) {
        var stepEl = document.getElementById('escape-step-' + i);
        var lockEl = document.getElementById('escape-lock-' + i);
        if (stepEl) {
            stepEl.className = 'escape-step' + (i < idx ? ' done' : '') + (i === idx ? ' active' : '') + (i > idx ? '' : '');
        }
        if (lockEl) {
            lockEl.textContent = i < idx ? 'âœ…' : (i === idx ? 'ðŸ”“' : 'ðŸ”’');
        }
    }
    var epZone = document.getElementById('escape-epreuve-zone');
    var html = '<div class="escape-ep-header">';
    html += '<div class="escape-ep-title">' + (ep.titre || ('Epreuve ' + (idx + 1))) + '</div>';
    html += '<div class="escape-ep-desc">' + (ep.description || '') + '</div>';
    html += '</div>';
    html += '<div class="escape-ep-content" id="escape-ep-content"></div>';
    epZone.innerHTML = html;
    var contentZone = document.getElementById('escape-ep-content');
    // Rendre le mini-exercice selon le type
    var type = ep.type || 'quiz_image';
    if (type === 'quiz_image') {
        escapeRenderQuiz(contentZone, ep, idx);
    } else if (type === 'nom_vers_image') {
        escapeRenderNomVersImage(contentZone, ep, idx);
    } else if (type === 'categoriser') {
        escapeRenderCategoriser(contentZone, ep, idx);
    } else if (type === 'memory') {
        escapeRenderMemory(contentZone, ep, idx);
    } else {
        escapeRenderQuiz(contentZone, ep, idx);
    }
}

// --- ESCAPE QUIZ (image â†’ nom) ---
function escapeRenderQuiz(zone, ep, epIdx) {
    var pool = ep.resolvedPictos;
    pictoState.epState = { pool: pool, idx: 0, correct: 0 };
    zone.innerHTML = '<div class="picto-progress" id="escape-q-progress">1 / ' + pool.length + '</div>' +
        '<div class="picto-progress-bar"><div class="picto-progress-fill" id="escape-q-fill" style="width:0%"></div></div>' +
        '<div id="escape-q-zone"></div>';
    escapeShowQuizQuestion();
}
function escapeShowQuizQuestion() {
    var es = pictoState.epState;
    if (es.idx >= es.pool.length) { escapeFinishEpreuve(es.correct, es.pool.length); return; }
    var q = es.pool[es.idx];
    document.getElementById('escape-q-progress').textContent = (es.idx + 1) + ' / ' + es.pool.length;
    document.getElementById('escape-q-fill').style.width = ((es.idx / es.pool.length) * 100) + '%';
    var wrongs = PICTO_DB.filter(function(p) { return p.id !== q.id; });
    wrongs = pictoShuffle(wrongs).slice(0, 3);
    var choices = pictoShuffle([q].concat(wrongs));
    var html = '<div style="text-align:center;">';
    html += '<span class="picto-cat-label picto-cat-' + q.cat + '">' + PICTO_CAT_ICONS[q.cat] + ' ' + PICTO_CAT_NAMES[q.cat] + '</span>';
    html += '</div>';
    html += '<img src="' + q.image + '" class="picto-quiz-img" alt="Pictogramme">';
    html += '<div class="picto-choices">';
    choices.forEach(function(ch) {
        html += '<div class="picto-choice" data-id="' + ch.id + '" onclick="escapeQuizAnswer(this)">' + ch.nom + '</div>';
    });
    html += '</div>';
    document.getElementById('escape-q-zone').innerHTML = html;
}
window.escapeQuizAnswer = function(el) {
    var es = pictoState.epState;
    var q = es.pool[es.idx];
    var ok = el.dataset.id === q.id;
    if (ok) { es.correct++; el.style.background = '#dcfce7'; el.style.borderColor = '#22c55e'; }
    else { el.style.background = '#fef2f2'; el.style.borderColor = '#ef4444'; }
    document.querySelectorAll('#escape-q-zone .picto-choice').forEach(function(c) { c.onclick = null; c.style.pointerEvents = 'none'; if (c.dataset.id === q.id) { c.style.background = '#dcfce7'; c.style.borderColor = '#22c55e'; } });
    setTimeout(function() { es.idx++; escapeShowQuizQuestion(); }, 1000);
};

// --- ESCAPE NOM VERS IMAGE ---
function escapeRenderNomVersImage(zone, ep, epIdx) {
    var pool = ep.resolvedPictos;
    pictoState.epState = { pool: pool, idx: 0, correct: 0 };
    zone.innerHTML = '<div class="picto-progress" id="escape-q-progress">1 / ' + pool.length + '</div>' +
        '<div class="picto-progress-bar"><div class="picto-progress-fill" id="escape-q-fill" style="width:0%"></div></div>' +
        '<div id="escape-q-zone"></div>';
    escapeShowNomQuestion();
}
function escapeShowNomQuestion() {
    var es = pictoState.epState;
    if (es.idx >= es.pool.length) { escapeFinishEpreuve(es.correct, es.pool.length); return; }
    var q = es.pool[es.idx];
    document.getElementById('escape-q-progress').textContent = (es.idx + 1) + ' / ' + es.pool.length;
    document.getElementById('escape-q-fill').style.width = ((es.idx / es.pool.length) * 100) + '%';
    var wrongs = PICTO_DB.filter(function(p) { return p.id !== q.id; });
    wrongs = pictoShuffle(wrongs).slice(0, 3);
    var choices = pictoShuffle([q].concat(wrongs));
    var html = '<div style="text-align:center;">';
    html += '<span class="picto-cat-label picto-cat-' + q.cat + '">' + PICTO_CAT_ICONS[q.cat] + ' ' + PICTO_CAT_NAMES[q.cat] + '</span>';
    html += '<h3 style="margin:10px 0 20px; font-size:1.2rem; color:#1e293b;">' + q.nom + '</h3>';
    html += '</div>';
    html += '<div class="picto-choices" style="grid-template-columns: repeat(2, 1fr);">';
    choices.forEach(function(ch) {
        html += '<div class="picto-choice" data-id="' + ch.id + '" onclick="escapeNomAnswer(this)" style="padding:10px;">';
        html += '<img src="' + ch.image + '" class="picto-choice-img" alt="Pictogramme">';
        html += '</div>';
    });
    html += '</div>';
    document.getElementById('escape-q-zone').innerHTML = html;
}
window.escapeNomAnswer = function(el) {
    var es = pictoState.epState;
    var q = es.pool[es.idx];
    var ok = el.dataset.id === q.id;
    if (ok) { es.correct++; el.style.background = '#dcfce7'; el.style.borderColor = '#22c55e'; }
    else { el.style.background = '#fef2f2'; el.style.borderColor = '#ef4444'; }
    document.querySelectorAll('#escape-q-zone .picto-choice').forEach(function(c) { c.onclick = null; c.style.pointerEvents = 'none'; if (c.dataset.id === q.id) { c.style.background = '#dcfce7'; c.style.borderColor = '#22c55e'; } });
    setTimeout(function() { es.idx++; escapeShowNomQuestion(); }, 1000);
};

// --- ESCAPE CATEGORISER ---
function escapeRenderCategoriser(zone, ep, epIdx) {
    var pool = ep.resolvedPictos;
    var cats = [];
    pool.forEach(function(p) { if (cats.indexOf(p.cat) === -1) cats.push(p.cat); });
    var shuffled = pictoShuffle(pool);
    pictoState.epState = { pool: pool, cats: cats, placed: {}, selectedItem: null };
    var html = '<div class="picto-cat-items" id="escape-cat-items">';
    shuffled.forEach(function(p) {
        html += '<div class="picto-drag-item" data-id="' + p.id + '" data-cat="' + p.cat + '" title="' + p.nom + '" id="escape-item-' + p.id + '">';
        html += '<img src="' + p.image + '" alt="' + p.nom + '" draggable="false">';
        html += '</div>';
    });
    html += '</div>';
    html += '<p style="text-align:center; color:#64748b; font-size:0.85rem; margin:12px 0;">Clique sur un pictogramme puis clique sur sa categorie</p>';
    html += '<div class="picto-cat-container" id="escape-cat-zones">';
    cats.forEach(function(cat) {
        html += '<div class="picto-cat-zone" data-cat="' + cat + '" onclick="escapeCatZoneClick(\'' + cat + '\')">';
        html += '<div class="picto-cat-zone-title picto-cat-' + cat + '">' + PICTO_CAT_ICONS[cat] + ' ' + PICTO_CAT_NAMES[cat] + '</div>';
        html += '<div class="picto-cat-dropped" id="escape-dropped-' + cat + '"></div>';
        html += '</div>';
    });
    html += '</div>';
    html += '<button class="btn-validate" id="escape-cat-validate" onclick="escapeValidateCat()" style="margin-top:16px;">Valider le classement</button>';
    zone.innerHTML = html;
    document.querySelectorAll('#escape-cat-items .picto-drag-item').forEach(function(item) {
        item.addEventListener('click', function() {
            document.querySelectorAll('#escape-cat-items .picto-drag-item').forEach(function(i) { i.style.outline = ''; });
            item.style.outline = '3px solid #3b82f6';
            pictoState.epState.selectedItem = item.dataset.id;
        });
    });
}
window.escapeCatZoneClick = function(cat) {
    var es = pictoState.epState;
    if (!es.selectedItem) return;
    var itemEl = document.getElementById('escape-item-' + es.selectedItem);
    if (!itemEl) return;
    es.placed[es.selectedItem] = cat;
    var droppedZone = document.getElementById('escape-dropped-' + cat);
    droppedZone.appendChild(itemEl);
    itemEl.style.outline = '';
    es.selectedItem = null;
};
window.escapeValidateCat = function() {
    var es = pictoState.epState;
    var correct = 0;
    es.pool.forEach(function(p) {
        var placedCat = es.placed[p.id];
        var ok = placedCat === p.cat;
        if (ok) correct++;
        var itemEl = document.getElementById('escape-item-' + p.id);
        if (itemEl) { itemEl.classList.add(ok ? 'correct' : 'wrong'); itemEl.style.pointerEvents = 'none'; }
    });
    document.querySelectorAll('#escape-cat-items .picto-drag-item').forEach(function(el) { el.style.pointerEvents = 'none'; });
    document.getElementById('escape-cat-validate').disabled = true;
    setTimeout(function() { escapeFinishEpreuve(correct, es.pool.length); }, 1500);
};

// --- ESCAPE MEMORY ---
function escapeRenderMemory(zone, ep, epIdx) {
    var pool = ep.resolvedPictos;
    var nb = Math.min(pool.length, 6);
    pool = pool.slice(0, nb);
    var cards = [];
    pool.forEach(function(p) {
        cards.push({ pairId: p.id, type: 'image', content: p.image, nom: p.nom });
        cards.push({ pairId: p.id, type: 'text', content: p.nom, nom: p.nom });
    });
    cards = pictoShuffle(cards);
    pictoState.epState = { cards: cards, flipped: [], matched: new Set(), attempts: 0, nbPairs: nb, busy: false };
    var cols = nb <= 4 ? 4 : 4;
    var html = '<div class="picto-mem-board" id="escape-mem-board" style="grid-template-columns:repeat(' + cols + ',1fr);">';
    cards.forEach(function(card, i) {
        html += '<div class="picto-mem-card" data-idx="' + i + '" onclick="escapeFlipCard(this)">';
        html += '<div class="mem-back">?</div>';
        if (card.type === 'image') {
            html += '<div class="mem-face"><img src="' + card.content + '" alt="Pictogramme"></div>';
        } else {
            html += '<div class="mem-face"><div class="mem-face-text">' + card.content + '</div></div>';
        }
        html += '</div>';
    });
    html += '</div>';
    html += '<div class="mem-attempts" id="escape-mem-attempts" style="text-align:center; margin-top:12px; color:#64748b; font-weight:600;">Tentatives : 0</div>';
    zone.innerHTML = html;
}
window.escapeFlipCard = function(el) {
    var es = pictoState.epState;
    var idx = parseInt(el.dataset.idx);
    if (es.busy || es.matched.has(idx) || es.flipped.includes(idx)) return;
    el.classList.add('flipped');
    es.flipped.push(idx);
    if (es.flipped.length === 2) {
        es.attempts++;
        document.getElementById('escape-mem-attempts').textContent = 'Tentatives : ' + es.attempts;
        es.busy = true;
        var a = es.flipped[0], b = es.flipped[1];
        if (es.cards[a].pairId === es.cards[b].pairId) {
            es.matched.add(a); es.matched.add(b);
            es.flipped = []; es.busy = false;
            document.querySelectorAll('#escape-mem-board .picto-mem-card[data-idx="' + a + '"], #escape-mem-board .picto-mem-card[data-idx="' + b + '"]').forEach(function(c) { c.classList.add('matched'); });
            if (es.matched.size === es.cards.length) {
                var score = Math.max(0, es.nbPairs - Math.max(0, es.attempts - es.nbPairs));
                setTimeout(function() { escapeFinishEpreuve(score, es.nbPairs); }, 800);
            }
        } else {
            setTimeout(function() {
                document.querySelectorAll('#escape-mem-board .picto-mem-card[data-idx="' + a + '"], #escape-mem-board .picto-mem-card[data-idx="' + b + '"]').forEach(function(c) { c.classList.remove('flipped'); });
                es.flipped = []; es.busy = false;
            }, 1000);
        }
    }
};

// --- FIN D'EPREUVE â†’ passage Ã  la suivante ---
function escapeFinishEpreuve(correct, total) {
    var s = pictoState;
    s.totalCorrect += correct;
    s.totalQuestions += total;
    s.epResults.push({ titre: s.epreuves[s.currentEp].titre || ('Epreuve ' + (s.currentEp + 1)), correct: correct, total: total });
    var nextIdx = s.currentEp + 1;
    if (nextIdx >= s.epreuves.length) {
        // Toutes les Ã©preuves terminÃ©es
        escapeShowFinalResults();
    } else {
        // Animation de dÃ©verrouillage
        var lockEl = document.getElementById('escape-lock-' + s.currentEp);
        if (lockEl) lockEl.textContent = 'âœ…';
        var stepEl = document.getElementById('escape-step-' + s.currentEp);
        if (stepEl) stepEl.className = 'escape-step done';
        var epZone = document.getElementById('escape-epreuve-zone');
        epZone.innerHTML = '<div class="escape-unlock-msg">' +
            '<div style="font-size:3rem; margin-bottom:12px;">ðŸ”“</div>' +
            '<div style="font-size:1.2rem; font-weight:700; color:#16a34a;">Epreuve reussie !</div>' +
            '<div style="color:#64748b; margin-top:8px;">Score : ' + correct + ' / ' + total + '</div>' +
            '<div style="color:#64748b; margin-top:4px;">Passage a l\'epreuve suivante...</div>' +
            '</div>';
        setTimeout(function() { escapeLoadEpreuve(nextIdx); }, 2000);
    }
}

function escapeShowFinalResults() {
    var s = pictoState;
    var details = [];
    s.epResults.forEach(function(r) {
        details.push({ ok: r.correct >= Math.ceil(r.total / 2), label: r.titre, detail: r.correct + ' / ' + r.total });
    });
    showResults(s.totalCorrect, s.totalQuestions, details);
}

// =====================================================================
// ANALYSE DE COPIE â€” RENDERER
// =====================================================================
var acState = { items: [], currentIdx: 0, responses: [], zone: null };
var acNewState = null;

var AC_VERBES = ['identifier', 'expliquer', 'proposer', 'argumenter', 'communiquer', 'appliquer'];
var AC_COMPETENCES = ['C2', 'C3', 'C4', 'C5', 'C6'];
var AC_C6_CRITERES = [
    'Vocabulaire adapte',
    'Syntaxe claire et correcte',
    'Argumentation structuree',
    'Mise en forme (presentation)'
];

function isAnalyseCopieNewSchema(c) {
    if (!c || !Array.isArray(c.items) || c.items.length === 0) return false;
    var item0 = c.items[0] || {};
    var att = item0.attendus || {};
    return att.verbe_index !== undefined ||
           att.competence_index !== undefined ||
           att.justif_index !== undefined ||
           !!item0.etape1 ||
           !!item0.etape1_competence ||
           !!item0.etape2_analyse ||
           !!item0.etape3_niveau ||
           !!item0.etape4_corrections ||
           Array.isArray(item0.justifs_proposees) ||
           Array.isArray(item0.ameliorations_proposees) ||
           !!c.final_c6 ||
           !!c.intro_eleve;
}

function acGetNewSchemaMissingBlocks(item) {
    var missing = [];
    if (!item || !item.etape1) missing.push('etape1');
    if (!item || !item.etape1_competence) missing.push('etape1_competence');
    if (!item || !item.etape3_niveau) missing.push('etape3_niveau');
    if (!item || !item.etape4_corrections) missing.push('etape4_corrections');
    return missing;
}

function acHasNewSchemaCore(item) {
    return acGetNewSchemaMissingBlocks(item).length === 0;
}

function acHasAnyNewSchemaBlock(item) {
    return !!(item && (item.etape1 || item.etape1_competence || item.etape3_niveau || item.etape4_corrections));
}

function acBuildAttendusFromNewSchema(item) {
    var e1 = item.etape1 || {};
    var e1c = item.etape1_competence || {};
    var e3 = item.etape3_niveau || {};
    var recap = item.recap_item || {};
    return {
        verbe_index: (typeof e1.verbe_index === 'number' ? e1.verbe_index : 0),
        competence_index: (typeof e1c.competence_index === 'number' ? e1c.competence_index : 0),
        niveau: e3.niveau_attendu || 'insuffisant',
        justif_index: null,
        amelioration_index: null,
        justification_modele: e1c.justification_modele || recap.resume || '',
        reponse_amelioree_modele: recap.modele_reponse_amelioree || recap.modele_reponse || ''
    };
}

function normalizeAnalyseCopie(exo) {
    if (!exo || typeof exo !== 'object') return exo;
    if (!Array.isArray(exo.items)) return exo;
    exo.items.forEach(function(item) {
        if (!item || typeof item !== 'object') return;

        if (!item.attendus && acHasNewSchemaCore(item)) {
            item.attendus = acBuildAttendusFromNewSchema(item);
        } else if (!item.attendus && acHasAnyNewSchemaBlock(item)) {
            item.attendus = acBuildAttendusFromNewSchema(item);
        }

        if (!item.attendus || typeof item.attendus !== 'object') return;

        var recap = item.recap_item || {};
        var e1c = item.etape1_competence || {};

        if (!item.attendus.justification_modele) {
            item.attendus.justification_modele = e1c.justification_modele || recap.resume || '';
        }
        if (!item.attendus.reponse_amelioree_modele) {
            item.attendus.reponse_amelioree_modele = recap.modele_reponse_amelioree || recap.modele_reponse || '';
        }

        if (item.attendus.validee === true) item.attendus.validee = 'oui';
        if (item.attendus.validee === false) item.attendus.validee = 'non';

        if (acHasAnyNewSchemaBlock(item)) {
            if (item.attendus.justif_index === undefined) item.attendus.justif_index = null;
            if (item.attendus.amelioration_index === undefined) item.attendus.amelioration_index = null;
        } else {
            if (item.attendus.justif_index === undefined) item.attendus.justif_index = 0;
            if (item.attendus.amelioration_index === undefined) item.attendus.amelioration_index = 0;
        }
    });
    return exo;
}

function acAdaptLegacySchema(c) {
    if (!c || !Array.isArray(c.items) || c.items.length === 0) return c;
    if (isAnalyseCopieNewSchema(c)) return c;

    var adapted = {
        titre: c.titre || 'Analyse de copie',
        type: 'analyse_copie',
        consigne: c.consigne || 'Tu es correcteur : verbe, competence, niveau, justification, amelioration.',
        contexte: c.contexte || '',
        intro_eleve: c.intro_eleve || {
            titre: 'Corrige une copie de Bac Pro PSE',
            accroche: 'Tu joues le correcteur. Corrige 5 reponses comme a l\'examen.',
            etapes: [
                'Repere le verbe d\'action',
                'Trouve la competence dominante',
                'Choisis un niveau',
                'Choisis la justification correcte',
                'Choisis la meilleure amelioration'
            ]
        },
        final_c6: c.final_c6 || { actif: false },
        items: []
    };

    adapted.items = c.items.slice(0, 5).map(function(item, idx) {
        var att = item.attendus || {};
        var exp = item.explications || {};
        var verbes = item.verbes_proposes || ['identifier', 'expliquer', 'proposer', 'argumenter'];
        var compOptions = item.competences_proposees || ['C2', 'C3', 'C4', 'C5'];
        if (att.competence && compOptions.indexOf(att.competence) === -1) compOptions[0] = att.competence;
        if (compOptions.length < 4) compOptions = ['C2', 'C3', 'C4', 'C5'];

        var justifs = item.justifs_proposees || [];
        if (!Array.isArray(justifs) || justifs.length < 3) {
            justifs = [
                att.justification_modele || exp.pourquoi_valide_ou_non || 'Cette competence est la plus adaptee a la consigne.',
                'La reponse contient quelques mots du cours mais reste trop generale.',
                'La reponse parle du theme sans traiter la demande exacte.'
            ];
        }

        var amels = item.ameliorations_proposees || [];
        if (!Array.isArray(amels) || amels.length < 3) {
            amels = [
                att.reponse_amelioree_modele || exp.exemple_reponse_amelioree || 'Ajouter une reponse plus precise avec vocabulaire professionnel.',
                'Raccourcir la reponse sans justification.',
                'Reprendre les memes mots sans precision supplementaire.'
            ];
        }

        var expectedComp = att.competence || compOptions[0];
        var expectedNiveau = att.niveau;
        if (typeof expectedNiveau === 'number') {
            expectedNiveau = expectedNiveau <= 1 ? 'non_traite' :
                expectedNiveau === 2 ? 'insuffisant' :
                expectedNiveau === 3 ? 'acceptable' : 'maitrise';
        }

        return {
            id: item.id || ('I' + (idx + 1)),
            contexte: item.contexte || '',
            question_examen: item.question_examen || '',
            reponse_eleve: item.reponse_eleve || '',
            verbes_proposes: verbes.slice(0, 4),
            competences_proposees: compOptions.slice(0, 4),
            niveaux_proposees: item.niveaux_proposees || ['non_traite', 'insuffisant', 'acceptable', 'maitrise'],
            justifs_proposees: justifs.slice(0, 3),
            ameliorations_proposees: amels.slice(0, 3),
            attendus: {
                verbe_index: acGetAttenduIndex(verbes, att.verbe_index, att.verbe, 0),
                competence_index: acGetAttenduIndex(compOptions, att.competence_index, expectedComp, 0),
                niveau: expectedNiveau || 'insuffisant',
                justif_index: acGetAttenduIndex(justifs, att.justif_index, att.justification_modele, 0),
                amelioration_index: acGetAttenduIndex(amels, att.amelioration_index, att.reponse_amelioree_modele, 0),
                justification_modele: att.justification_modele || exp.pourquoi_valide_ou_non || '',
                reponse_amelioree_modele: att.reponse_amelioree_modele || exp.exemple_reponse_amelioree || ''
            },
            correction: item.correction || {
                resume: exp.resume || 'Correction de l\'item.',
                verbe_definition: exp.attendu_pedagogique || '',
                verbe_exemple: exp.exemple_reponse_amelioree || '',
                competence_definition: '',
                competence_exemple: '',
                pourquoi_ce_niveau: exp.pourquoi_valide_ou_non || '',
                erreurs_frequentes: exp.erreurs_frequentes || []
            }
        };
    });
    return adapted;
}

function acLevelToLabel(level) {
    var lv = String(level || '').toLowerCase();
    if (lv === 'non_traite' || lv === '0' || lv === '1') return 'non_traite';
    if (lv === 'insuffisant' || lv === '2') return 'insuffisant';
    if (lv === 'acceptable' || lv === '3') return 'acceptable';
    if (lv === 'maitrise' || lv === 'maitrisee' || lv === '4') return 'maitrise';
    return 'insuffisant';
}

function acGetAttenduIndex(options, attenduIndex, attenduValue, fallback) {
    if (typeof attenduIndex === 'number' && attenduIndex >= 0 && attenduIndex < (options || []).length) {
        return attenduIndex;
    }
    if (attenduValue !== undefined && attenduValue !== null) {
        var expectedNorm = norm(String(attenduValue));
        for (var i = 0; i < (options || []).length; i++) {
            if (norm(String(options[i])) === expectedNorm) return i;
        }
    }
    return fallback || 0;
}

function acGetExpectedNiveau(item) {
    var niveaux = item.niveaux_proposees || ['non_traite', 'insuffisant', 'acceptable', 'maitrise'];
    var att = item.attendus || {};
    var niveauLabel = acLevelToLabel(att.niveau);
    return acGetAttenduIndex(niveaux, att.niveau_index, niveauLabel, 0);
}

function acHasGuidedItemSchema(item) {
    return !!(item && item.etape1 && item.etape1_competence && item.etape2_analyse && item.etape3_niveau && item.etape4_corrections);
}

function acSetEq(a, b) {
    if (!Array.isArray(a) || !Array.isArray(b)) return false;
    if (a.length !== b.length) return false;
    var sa = a.slice().sort();
    var sb = b.slice().sort();
    for (var i = 0; i < sa.length; i++) if (sa[i] !== sb[i]) return false;
    return true;
}

function acNormalizeIdList(v) {
    if (!v) return [];
    if (Array.isArray(v)) return v.filter(Boolean).map(String);
    return [String(v)];
}

function acNewCanScoreC6() {
    return !!(acNewState && acNewState.finalC6 && acNewState.finalC6.actif);
}

function acFormatNote(value) {
    var n = Number(value);
    if (!isFinite(n)) return '0,0';
    return n.toFixed(1).replace('.', ',');
}

function acNewComputeItemScore(item, resp) {
    if (acHasGuidedItemSchema(item)) {
        var scoreGuided = 0;
        var e1 = item.etape1 || {};
        var e1c = item.etape1_competence || {};
        var e2 = item.etape2_analyse || {};
        var e3 = item.etape3_niveau || {};
        var e4 = item.etape4_corrections || {};

        var verbeOk = resp.verbe_index === (typeof e1.verbe_index === 'number' ? e1.verbe_index : 0);
        var verbeSensOk = resp.verbe_sens_index === (typeof (e1.verbe_sens_qcu || {}).correct === 'number' ? (e1.verbe_sens_qcu || {}).correct : 0);
        if (verbeOk && verbeSensOk) scoreGuided++;
        if (resp.competence_index === (typeof e1c.competence_index === 'number' ? e1c.competence_index : 0)) scoreGuided++;
        if (acSetEq(acNormalizeIdList(resp.analyse_selected_ids), acNormalizeIdList(e2.corrects))) scoreGuided++;
        if (String(resp.niveau_value || '') === String(e3.niveau_attendu || 'insuffisant')) scoreGuided++;

        var selectedCorr = acNormalizeIdList(resp.correction_selected_ids);
        var acceptables = acNormalizeIdList(e4.acceptables);
        if (acSetEq(selectedCorr, acceptables)) scoreGuided++;
        return scoreGuided;
    }

    var attendus = item.attendus || {};
    var score = 0;
    var verbes = item.verbes_proposes || ['identifier', 'expliquer', 'proposer', 'argumenter'];
    var comps = item.competences_proposees || ['C2', 'C3', 'C4', 'C5'];
    var nivs = item.niveaux_proposees || ['non_traite', 'insuffisant', 'acceptable', 'maitrise'];
    var justifs = item.justifs_proposees || [];
    var amels = item.ameliorations_proposees || [];
    if (!Array.isArray(justifs) || justifs.length === 0) {
        justifs = [attendus.justification_modele || 'Justification attendue', 'Justification partielle', 'Justification hors sujet'];
    }
    if (!Array.isArray(amels) || amels.length === 0) {
        amels = [attendus.reponse_amelioree_modele || 'RÃ©ponse amÃ©liorÃ©e attendue', 'AmÃ©lioration vague', 'AmÃ©lioration inadaptÃ©e'];
    }

    var verbeIdx = acGetAttenduIndex(verbes, attendus.verbe_index, attendus.verbe, 0);
    var compIdx = acGetAttenduIndex(comps, attendus.competence_index, attendus.competence, 0);
    var nivIdx = acGetExpectedNiveau(item);
    var justIdx = acGetAttenduIndex(justifs, attendus.justif_index, attendus.justification_modele, 0);
    var amIdx = acGetAttenduIndex(amels, attendus.amelioration_index, attendus.reponse_amelioree_modele, 0);

    if (resp.verbe_index === verbeIdx) score++;
    if (resp.competence_index === compIdx) score++;
    if (resp.niveau_index === acGetAttenduIndex(nivs, nivIdx, null, 0)) score++;
    if (resp.justif_index === justIdx) score++;
    if (resp.amelioration_index === amIdx) score++;
    return score;
}

function acNewComputeScores() {
    var items = acNewState.items || [];
    var itemScore = 0;
    for (var i = 0; i < items.length; i++) {
        itemScore += acNewComputeItemScore(items[i], acNewState.responses[i] || {});
    }

    var c6Score = 0;
    if (acNewCanScoreC6()) {
        Object.keys(acNewState.c6Selections || {}).forEach(function(k) {
            c6Score += parseInt(acNewState.c6Selections[k], 10) || 0;
        });
    }

    var note;
    if (acNewCanScoreC6()) {
        note = Math.round(((itemScore / 25) * 12 + (c6Score / 8) * 8) * 10) / 10;
    } else {
        note = Math.round((itemScore / 25) * 20 * 10) / 10;
    }
    var noteApprox = Math.round(note);
    return {
        itemScore: itemScore,
        c6Score: c6Score,
        note: note,
        noteDisplay: acFormatNote(note),
        noteApprox: noteApprox
    };
}

function acNewRenderCorrectionPanel(item, resp) {
    var corr = item.correction || {};
    var exp = item.explications || {};
    var att = item.attendus || {};

    var resume = corr.resume || exp.resume || 'Correction de cet item';
    var verbeDef = corr.verbe_definition || exp.attendu_pedagogique || '';
    var verbeEx = corr.verbe_exemple || exp.exemple_reponse_amelioree || '';
    var verbeBad = corr.verbe_exemple_mauvais || '';
    var compDef = corr.competence_definition || '';
    var compEx = corr.competence_exemple || '';
    var compBad = corr.competence_exemple_mauvais || '';
    var why = corr.pourquoi_ce_niveau || exp.pourquoi_valide_ou_non || '';
    var justModele = att.justification_modele || '';
    var repModele = att.reponse_amelioree_modele || exp.exemple_reponse_amelioree || '';
    var errs = corr.erreurs_frequentes || exp.erreurs_frequentes || [];

    var html = '<div class="ac-v2-corr">';
    html += '<div class="ac-v2-corr-title">âœ… Correction complÃ¨te</div>';
    html += '<div class="ac-v2-corr-resume">ðŸ’¬ ' + resume + '</div>';

    html += '<div class="ac-v2-corr-block"><strong>1) Pourquoi ce verbe</strong>';
    if (verbeDef) html += '<div>' + verbeDef + '</div>';
    if (verbeEx) html += '<div class="ac-v2-example good">Exemple concret : ' + verbeEx + '</div>';
    if (verbeBad) html += '<div class="ac-v2-example bad">Exemple Ã  Ã©viter : ' + verbeBad + '</div>';
    html += '</div>';

    html += '<div class="ac-v2-corr-block"><strong>2) Pourquoi cette compÃ©tence</strong>';
    if (compDef) html += '<div>' + compDef + '</div>';
    if (compEx) html += '<div class="ac-v2-example good">Exemple concret : ' + compEx + '</div>';
    if (compBad) html += '<div class="ac-v2-example bad">Exemple Ã  Ã©viter : ' + compBad + '</div>';
    html += '</div>';

    if (why) {
        html += '<div class="ac-v2-corr-block"><strong>3) Pourquoi ce niveau</strong><div>' + why + '</div></div>';
    }
    if (justModele) {
        html += '<div class="ac-v2-corr-block"><strong>4) ModÃ¨le de justification</strong><div>' + justModele + '</div></div>';
    }
    if (repModele) {
        html += '<div class="ac-v2-corr-block"><strong>5) ModÃ¨le de rÃ©ponse amÃ©liorÃ©e</strong><div>' + repModele + '</div></div>';
    }
    if (Array.isArray(errs) && errs.length > 0) {
        html += '<div class="ac-v2-corr-block"><strong>6) Erreurs frÃ©quentes</strong><ul class="ac-v2-ul">';
        errs.slice(0, 3).forEach(function(e) { html += '<li>' + e + '</li>'; });
        html += '</ul></div>';
    }
    html += '</div>';
    return html;
}

function acNewRenderIntro() {
    var intro = acNewState.contenu.intro_eleve || {};
    var steps = intro.etapes || [
        'RepÃ©rer le verbe dâ€™action',
        'Trouver la compÃ©tence dominante',
        'Choisir un niveau',
        'Choisir une justification',
        'Choisir la meilleure amÃ©lioration',
        'Ã‰valuer C6 Ã  la fin et obtenir une note /20'
    ];
    var rappel = intro.rappel_competences || [];
    var html = '<div class="ac-v2-intro">';
    html += '<h3>' + (intro.titre || 'Corrige une copie de Bac Pro PSE') + '</h3>';
    html += '<p>' + (intro.accroche || 'Tu joues le correcteur. Tu vas corriger 5 rÃ©ponses dâ€™examen.') + '</p>';
    html += '<div class="ac-v2-subtitle">Ce que tu vas faire</div><ol>';
    steps.forEach(function(s) { html += '<li>' + s + '</li>'; });
    html += '</ol>';
    if (rappel.length > 0) {
        html += '<div class="ac-v2-subtitle">Rappel compÃ©tences</div><div class="ac-v2-comp-grid">';
        rappel.forEach(function(c) {
            html += '<div class="ac-v2-comp-card"><strong>' + (c.id || '') + ' â€” ' + (c.titre || '') + '</strong>';
            if (c.exemple) html += '<div>' + c.exemple + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }
    html += '<button class="ac-v2-btn-main" onclick="window.acNewStartItems()">Commencer</button>';
    html += '</div>';
    document.getElementById('ac-item-zone').innerHTML = html;
    document.getElementById('ac-progress-text').textContent = 'Introduction';
}

function acNewRenderItem(idx) {
    var item = acNewState.items[idx];
    var resp = acNewState.responses[idx] || {};
    if (!item) return;

    if (acHasGuidedItemSchema(item)) {
        acNewRenderItemGuided(idx, item, resp);
        return;
    }

    var verbes = item.verbes_proposes || ['identifier', 'expliquer', 'proposer', 'argumenter'];
    var comps = item.competences_proposees || ['C2', 'C3', 'C4', 'C5'];
    var nivs = item.niveaux_proposees || ['non_traite', 'insuffisant', 'acceptable', 'maitrise'];
    var justifs = item.justifs_proposees || [];
    var amels = item.ameliorations_proposees || [];
    var att = item.attendus || {};
    if (!Array.isArray(justifs) || justifs.length === 0) {
        justifs = [att.justification_modele || 'Justification attendue', 'Justification partielle', 'Justification hors sujet'];
    }
    if (!Array.isArray(amels) || amels.length === 0) {
        amels = [att.reponse_amelioree_modele || 'RÃ©ponse amÃ©liorÃ©e attendue', 'AmÃ©lioration vague', 'AmÃ©lioration inadaptÃ©e'];
    }

    var html = '<div class="ac-item">';
    if (item.contexte) html += '<div class="ac-contexte">' + item.contexte + '</div>';
    html += '<div class="ac-exam-question"><strong>ðŸ“‹ Consigne dâ€™examen</strong>' + (item.question_examen || '') + '</div>';
    html += '<div class="ac-response-eleve"><strong>âœï¸ RÃ©ponse de lâ€™Ã©lÃ¨ve fictif</strong>' + (item.reponse_eleve || '') + '</div>';

    function qcu(title, key, choices, labels) {
        html += '<div class="ac-section"><div class="ac-section-title">' + title + '</div><div class="ac-qcu">';
        choices.forEach(function(ch, i) {
            var selected = resp[key] === i ? ' selected' : '';
            var txt = labels ? (labels[ch] || ch) : ch;
            html += '<div class="ac-choice' + selected + '" onclick="window.acNewPick(' + idx + ',\'' + key + '\',' + i + ')">' + txt + '</div>';
        });
        html += '</div></div>';
    }

    qcu('1. Verbe dâ€™action principal', 'verbe_index', verbes);
    qcu('2. CompÃ©tence dominante', 'competence_index', comps, { C2: 'C2 â€” Analyser', C3: 'C3 â€” Expliquer', C4: 'C4 â€” Proposer', C5: 'C5 â€” Argumenter' });
    qcu('3. Niveau de maÃ®trise', 'niveau_index', nivs, { non_traite: 'Non traitÃ©', insuffisant: 'Insuffisant', acceptable: 'Acceptable', maitrise: 'MaÃ®trisÃ©' });
    qcu('4. Justification', 'justif_index', justifs);
    qcu('5. AmÃ©lioration', 'amelioration_index', amels);

    html += '<div class="ac-v2-actions">';
    html += '<button class="ac-btn-prev" onclick="window.acNewPrev()" ' + (idx === 0 ? 'disabled' : '') + '>â† PrÃ©cÃ©dent</button>';
    html += '<button class="ac-v2-btn-main" onclick="window.acNewValidateItem()">Valider lâ€™item</button>';
    html += '<button class="ac-btn-next" onclick="window.acNewNext()">' + (idx === acNewState.items.length - 1 ? 'Ã‰tape finale â†’' : 'Suivant â†’') + '</button>';
    html += '</div>';

    if (resp.validated) {
        html += acNewRenderCorrectionPanel(item, resp);
    }
    html += '</div>';

    document.getElementById('ac-item-zone').innerHTML = html;
    document.getElementById('ac-progress-text').textContent = 'Item ' + (idx + 1) + ' / ' + acNewState.items.length;
    for (var d = 0; d < acNewState.items.length; d++) {
        var dot = document.getElementById('ac-dot-' + d);
        if (!dot) continue;
        var cls = 'ac-progress-dot';
        if (d === idx) cls += ' active';
        else if ((acNewState.responses[d] || {}).validated) cls += ' done';
        dot.className = cls;
    }
}

function acNewRenderFeedbackBlock(title, ok, text) {
    if (!text) return '';
    return '<div class="ac-v2-corr-block" style="margin-top:8px; border-left:4px solid ' + (ok ? '#16a34a' : '#ef4444') + '; background:' + (ok ? '#f0fdf4' : '#fef2f2') + ';">' +
        '<strong>' + title + '</strong><div>' + text + '</div></div>';
}

function acNewRenderPendingHint(text) {
    if (!text) return '';
    return '<div class="ac-v2-pending">' + text + '</div>';
}

function acNewRenderItemGuided(idx, item, resp) {
    var e1 = item.etape1 || {};
    var e1v = e1.verbe_sens_qcu || {};
    var e1c = item.etape1_competence || {};
    var e2 = item.etape2_analyse || {};
    var e3 = item.etape3_niveau || {};
    var e4 = item.etape4_corrections || {};

    var verbes = e1.verbes_proposes || ['identifier', 'expliquer', 'proposer', 'argumenter'];
    var comps = e1c.competences_proposees || ['C2', 'C3', 'C4', 'C5'];
    var nivs = e3.niveaux_proposees || ['non_traite', 'insuffisant', 'acceptable', 'maitrise'];
    var anChoices = Array.isArray(e2.choix) ? e2.choix : [];
    var corrProps = Array.isArray(e4.propositions) ? e4.propositions : [];

    var html = '<div class="ac-item">';
    if (item.contexte) html += '<div class="ac-contexte">' + item.contexte + '</div>';
    html += '<div class="ac-exam-question"><strong>Consigne d\'examen</strong>' + (item.question_examen || '') + '</div>';
    html += '<div class="ac-response-eleve"><strong>Reponse eleve</strong>' + (item.reponse_eleve || '') + '</div>';

    html += '<div class="ac-section"><div class="ac-section-title">Etape 1 - Je comprends la consigne</div>';
    html += '<div style="margin-bottom:8px; color:#475569;">A quelle competence fait appel cette consigne ?</div>';
    html += '<div style="font-weight:700; margin:8px 0;">1.1 Pour cela, dans un premier temps, je repere le verbe d\'action.</div><div class="ac-qcu">';
    verbes.forEach(function(v, i) {
        var selected = resp.verbe_index === i ? ' selected' : '';
        html += '<div class="ac-choice' + selected + '" onclick="window.acNewPick(' + idx + ',\'verbe_index\',' + i + ')">' + v + '</div>';
    });
    html += '</div>';
    html += acNewRenderPendingHint(resp.step11_pending || '');
    html += '<button class="ac-v2-btn-main" type="button" style="margin-top:8px;" onclick="window.acNewValidateStep(' + idx + ',\'step11\')">Valider 1.1</button>';
    html += acNewRenderFeedbackBlock('Feedback 1.1', !!resp.step11_ok, resp.step11_feedback || '');

    html += '<div style="font-weight:700; margin:12px 0 8px;">1.2 Pour verifier que j\'ai compris, j\'associe le verbe a sa signification.</div><div class="ac-qcu">';
    (e1v.choix || []).forEach(function(v, i) {
        var selected = resp.verbe_sens_index === i ? ' selected' : '';
        html += '<div class="ac-choice' + selected + '" onclick="window.acNewPick(' + idx + ',\'verbe_sens_index\',' + i + ')">' + v + '</div>';
    });
    html += '</div>';
    html += acNewRenderPendingHint(resp.step12_pending || '');
    html += '<button class="ac-v2-btn-main" type="button" style="margin-top:8px;" onclick="window.acNewValidateStep(' + idx + ',\'step12\')">Valider 1.2</button>';
    html += acNewRenderFeedbackBlock('Feedback 1.2', !!resp.step12_ok, resp.step12_feedback || '');

    html += '<div style="font-weight:700; margin:12px 0 8px;">1.3 Ensuite, j\'identifie la competence mobilisee.</div><div class="ac-qcu">';
    comps.forEach(function(c, i) {
        var labels = {
            C2: 'C2 - Appliquer une demarche d\'analyse dans une situation donnee',
            C3: 'C3 - Expliquer un phenomene, un enjeu ou une disposition',
            C4: 'C4 - Proposer une solution adaptee',
            C5: 'C5 - Argumenter un choix'
        };
        var selected = resp.competence_index === i ? ' selected' : '';
        html += '<div class="ac-choice' + selected + '" onclick="window.acNewPick(' + idx + ',\'competence_index\',' + i + ')">' + (labels[c] || c) + '</div>';
    });
    html += '</div>';
    html += acNewRenderPendingHint(resp.step13_pending || '');
    html += '<button class="ac-v2-btn-main" type="button" style="margin-top:8px;" onclick="window.acNewValidateStep(' + idx + ',\'step13\')">Valider 1.3</button>';
    html += acNewRenderFeedbackBlock('Feedback 1.3', !!resp.step13_ok, resp.step13_feedback || '');
    html += '</div>';

    html += '<div class="ac-section"><div class="ac-section-title">Etape 2 - J\'analyse la reponse de l\'eleve</div>';
    html += '<div style="margin-bottom:8px; color:#475569;">Competence attendue : <strong>' + (e1c.competence_titre || 'C2/C3/C4/C5') + '</strong></div>';
    html += '<div style="margin-bottom:8px;">' + (e2.question || 'Au regard de la competence attendue, l\'eleve a-t-il repondu ?') + '</div><div class="ac-qcu">';
    anChoices.forEach(function(ch) {
        var id = ch.id || '';
        var selected = (resp.analyse_selected_ids || []).indexOf(id) !== -1 ? ' selected' : '';
        html += '<div class="ac-choice' + selected + '" onclick="window.acNewPickMulti(' + idx + ',\'analyse_selected_ids\',\'' + id + '\')">' + (ch.texte || '') + '</div>';
    });
    html += '</div>';
    html += acNewRenderPendingHint(resp.step2_pending || '');
    html += '<button class="ac-v2-btn-main" type="button" style="margin-top:8px;" onclick="window.acNewValidateStep(' + idx + ',\'step2\')">Valider l\'etape 2</button>';
    html += acNewRenderFeedbackBlock('Feedback etape 2', !!resp.step2_ok, resp.step2_feedback || '');
    html += '</div>';

    html += '<div class="ac-section"><div class="ac-section-title">Etape 3 - J\'attribue un niveau de maitrise</div><div class="ac-qcu">';
    var nivLabels = { non_traite: 'Non traite', insuffisant: 'Insuffisant', acceptable: 'Acceptable', maitrise: 'Maitrise' };
    nivs.forEach(function(n) {
        var selected = resp.niveau_value === n ? ' selected' : '';
        html += '<div class="ac-choice' + selected + '" onclick="window.acNewPick(' + idx + ',\'niveau_value\',\'' + n + '\')">' + (nivLabels[n] || n) + '</div>';
    });
    html += '</div>';
    html += acNewRenderPendingHint(resp.step3_pending || '');
    if (Array.isArray(e3.criteres_simplifies) && e3.criteres_simplifies.length > 0) {
        html += '<div class="ac-v2-corr-block" style="margin-top:8px;"><strong>Es-tu sur ?</strong><ul class="ac-v2-ul">';
        e3.criteres_simplifies.forEach(function(c) { html += '<li>' + c + '</li>'; });
        html += '</ul></div>';
    }
    html += '<button class="ac-v2-btn-main" type="button" style="margin-top:8px;" onclick="window.acNewValidateStep(' + idx + ',\'step3\')">Valider l\'etape 3</button>';
    html += acNewRenderFeedbackBlock('Feedback etape 3', !!resp.step3_ok, resp.step3_feedback || '');
    html += '</div>';

    html += '<div class="ac-section"><div class="ac-section-title">Etape 4 - Je propose un corrige possible</div>';
    html += '<div style="margin-bottom:8px;">' + (e4.instruction || 'Je selectionne une ou plusieurs propositions de correction acceptables.') + '</div><div class="ac-qcu">';
    corrProps.forEach(function(ch) {
        var id = ch.id || '';
        var selected = (resp.correction_selected_ids || []).indexOf(id) !== -1 ? ' selected' : '';
        html += '<div class="ac-choice' + selected + '" onclick="window.acNewPickMulti(' + idx + ',\'correction_selected_ids\',\'' + id + '\')">' + (ch.texte || '') + '</div>';
    });
    html += '</div>';
    html += acNewRenderPendingHint(resp.step4_pending || '');
    html += '<button class="ac-v2-btn-main" type="button" style="margin-top:8px;" onclick="window.acNewValidateStep(' + idx + ',\'step4\')">Valider l\'etape 4</button>';
    html += acNewRenderFeedbackBlock('Feedback etape 4', !!resp.step4_ok, resp.step4_feedback || '');
    html += '</div>';

    html += '<div class="ac-v2-actions">';
    html += '<button class="ac-btn-prev" onclick="window.acNewPrev()" ' + (idx === 0 ? 'disabled' : '') + '>Precedent</button>';
    html += '<button class="ac-v2-btn-main" onclick="window.acNewValidateItem()">Valider l\'item</button>';
    html += '<button class="ac-btn-next" onclick="window.acNewNext()">' + (idx === acNewState.items.length - 1 ? 'Etape finale' : 'Suivant') + '</button>';
    html += '</div>';

    if (resp.validated && item.recap_item) {
        var recap = item.recap_item;
        html += '<details class="ac-explications" open><summary>Correction recapitulative</summary><div class="ac-expl-body">';
        if (recap.resume) html += '<div class="ac-v2-corr-resume">' + recap.resume + '</div>';
        if (recap.modele_reponse_amelioree) html += '<div class="ac-v2-corr-block"><strong>Modele de reponse amelioree</strong><div>' + recap.modele_reponse_amelioree + '</div></div>';
        if (Array.isArray(recap.erreurs_frequentes) && recap.erreurs_frequentes.length > 0) {
            html += '<div class="ac-v2-corr-block"><strong>Erreurs frequentes</strong><ul class="ac-v2-ul">';
            recap.erreurs_frequentes.forEach(function(e) { html += '<li>' + e + '</li>'; });
            html += '</ul></div>';
        }
        html += '</div></details>';
    }

    html += '</div>';
    document.getElementById('ac-item-zone').innerHTML = html;
    document.getElementById('ac-progress-text').textContent = 'Item ' + (idx + 1) + ' / ' + acNewState.items.length;
    for (var d = 0; d < acNewState.items.length; d++) {
        var dot = document.getElementById('ac-dot-' + d);
        if (!dot) continue;
        var cls = 'ac-progress-dot';
        if (d === idx) cls += ' active';
        else if ((acNewState.responses[d] || {}).validated) cls += ' done';
        dot.className = cls;
    }
}

function acNewRenderFinalC6() {
    var finalC6 = acNewState.finalC6;
    var criteres = finalC6.criteres || [];
    var expl = finalC6.explications || {};
    var scores = acNewComputeScores();
    var html = '<div class="ac-item">';
    html += '<div class="ac-v2-final-title">Competence 6 - J\'evalue la qualite globale de l\'ecrit</div>';
    html += '<div class="ac-contexte">' + (finalC6.consigne || 'C6 sâ€™Ã©value sur lâ€™ensemble de la copie : clartÃ©, syntaxe, vocabulaire, organisation.') + '</div>';

    html += '<div class="ac-v2-subtitle">RÃ©capitulatif des 5 rÃ©ponses</div>';
    (acNewState.items || []).forEach(function(it, i) {
        html += '<details class="ac-explications"><summary>Item ' + (i + 1) + ' â€” Voir la rÃ©ponse</summary>';
        html += '<div class="ac-expl-body"><div class="ac-exam-question"><strong>Consigne</strong>' + (it.question_examen || '') + '</div>';
        html += '<div class="ac-response-eleve"><strong>RÃ©ponse</strong>' + (it.reponse_eleve || '') + '</div></div></details>';
    });

    html += '<div class="ac-v2-subtitle">Grille C6 (0 / 1 / 2)</div>';
    criteres.forEach(function(cr) {
        var cid = cr.id;
        var selected = acNewState.c6Selections[cid];
        var help = expl[cid] || {};
        if ((!help || Object.keys(help).length === 0) && (cr.definition || cr.bon_exemple || cr.mauvais_exemple)) {
            help = { definition: cr.definition, bon_exemple: cr.bon_exemple, mauvais_exemple: cr.mauvais_exemple };
        }
        html += '<div class="ac-v2-c6-row">';
        html += '<div class="ac-v2-c6-left"><strong>' + (cr.label || cid) + '</strong>';
        html += '<button type="button" class="ac-v2-info-btn" onclick="window.acNewToggleC6Help(\'' + cid + '\')">i</button></div>';
        html += '<div class="ac-v2-c6-btns">';
        [0, 1, 2].forEach(function(v) {
            html += '<button type="button" class="ac-c6-btn' + (selected === v ? ' active' : '') + '" onclick="window.acNewPickC6(\'' + cid + '\',' + v + ')">' + v + '</button>';
        });
        html += '</div>';
        html += '<div class="ac-v2-c6-help" id="ac-v2-help-' + cid + '" style="display:none;">';
        if (help.definition) html += '<div><strong>DÃ©finition :</strong> ' + help.definition + '</div>';
        if (help.bon_exemple) html += '<div class="ac-v2-example good"><strong>Bon exemple :</strong> ' + help.bon_exemple + '</div>';
        if (help.mauvais_exemple) html += '<div class="ac-v2-example bad"><strong>Mauvais exemple :</strong> ' + help.mauvais_exemple + '</div>';
        html += '</div></div>';
    });

    html += '<div class="ac-v2-score-preview">';
    html += '<div>Score items : <strong>' + scores.itemScore + '/25</strong></div>';
    html += '<div>Score C6 : <strong>' + scores.c6Score + '/8</strong></div>';
    html += '<div>Note finale : <strong>' + scores.noteDisplay + '/20</strong> (â‰ˆ ' + scores.noteApprox + '/20)</div>';
    html += '</div>';

    html += '<div class="ac-v2-actions">';
    html += '<button class="ac-btn-prev" onclick="window.acNewBackToLastItem()">â† Revenir aux items</button>';
    html += '<button class="ac-v2-btn-main" onclick="window.acNewFinish()">Valider lâ€™Ã©valuation finale</button>';
    html += '</div></div>';
    document.getElementById('ac-item-zone').innerHTML = html;
    document.getElementById('ac-progress-text').textContent = 'Final C6';
}

function acNewAllItemsValidated() {
    return (acNewState.responses || []).every(function(r) { return !!r.validated; });
}

function acNewAllC6Selected() {
    if (!acNewCanScoreC6()) return true;
    var criteres = (acNewState.finalC6.criteres || []).map(function(c) { return c.id; });
    return criteres.every(function(id) { return acNewState.c6Selections[id] !== undefined; });
}

function acNewBuildDetails(scores) {
    var details = [];
    acNewState.items.forEach(function(item, idx) {
        var resp = acNewState.responses[idx] || {};
        var itemScore = acNewComputeItemScore(item, resp);
        details.push({
            ok: itemScore >= 3,
            label: 'Item ' + (idx + 1),
            detail: itemScore + '/5'
        });
    });
    details.unshift({
        ok: true,
        label: 'Note finale /20',
        detail: 'Items: ' + scores.itemScore + '/25 | C6: ' + scores.c6Score + '/8 | Note: ' + scores.noteDisplay + '/20 (â‰ˆ ' + scores.noteApprox + '/20)'
    });
    return details;
}

function acNewFinishAndShow() {
    if (!acNewAllItemsValidated()) {
        showToast('Valide tous les items avant de terminer.');
        return null;
    }
    if (!acNewAllC6Selected()) {
        showToast('Renseigne tous les critÃ¨res C6 avant de terminer.');
        return null;
    }
    var scores = acNewComputeScores();
    var details = acNewBuildDetails(scores);
    var total = acNewCanScoreC6() ? 33 : 25;
    var correct = scores.itemScore + scores.c6Score;
    showResults(correct, total, details);
    var zone = document.getElementById('zone-results');
    var extra = '<div class="ac-v2-final-box">' +
        '<div><strong>Score items :</strong> ' + scores.itemScore + '/25 (pondÃ©rÃ© sur 12)</div>' +
        '<div><strong>Score C6 :</strong> ' + scores.c6Score + '/8 (pondÃ©rÃ© sur 8)</div>' +
        '<div class="ac-v2-final-note">Note finale : ' + scores.noteDisplay + '/20 (â‰ˆ ' + scores.noteApprox + '/20)</div>' +
        '</div>';
    zone.innerHTML = extra + zone.innerHTML;
    document.getElementById('btn-validate').disabled = true;
    corrected = true;
    return { correct: correct, total: total, details: details };
}

function renderAnalyseCopieV2(zone, c) {
    acNewState = {
        contenu: c || {},
        items: (c.items || []).slice(0, 5),
        idx: 0,
        stage: (c.intro_eleve ? 'intro' : 'items'),
        responses: [],
        finalC6: c.final_c6 || { actif: false },
        c6Selections: {},
        zone: zone
    };
    acNewState.items.forEach(function() {
        acNewState.responses.push({
            verbe_index: null,
            verbe_sens_index: null,
            competence_index: null,
            niveau_index: null,
            niveau_value: null,
            justif_index: null,
            amelioration_index: null,
            analyse_selected_ids: [],
            correction_selected_ids: [],
            step11_done: false,
            step12_done: false,
            step13_done: false,
            step2_done: false,
            step3_done: false,
            step4_done: false,
            step11_ok: false,
            step12_ok: false,
            step13_ok: false,
            step2_ok: false,
            step3_ok: false,
            step4_ok: false,
            step11_feedback: '',
            step12_feedback: '',
            step13_feedback: '',
            step2_feedback: '',
            step3_feedback: '',
            step4_feedback: '',
            step11_pending: '',
            step12_pending: '',
            step13_pending: '',
            step2_pending: '',
            step3_pending: '',
            step4_pending: '',
            validated: false
        });
    });

    var html = '';
    if (c.contexte) html += '<div class="ac-contexte">' + c.contexte + '</div>';
    if (c.consigne) html += '<div style="font-weight:700; color:#334155; margin-bottom:16px; text-align:center;">' + c.consigne + '</div>';
    html += '<div class="ac-progress" id="ac-progress-text">PrÃ©paration</div>';
    html += '<div class="ac-progress-bar" id="ac-progress-bar">';
    for (var i = 0; i < acNewState.items.length; i++) {
        html += '<div class="ac-progress-dot' + (i === 0 ? ' active' : '') + '" id="ac-dot-' + i + '"></div>';
    }
    html += '</div><div id="ac-item-zone"></div>';
    zone.innerHTML = html;

    document.getElementById('btn-validate').style.display = 'none';
    if (acNewState.stage === 'intro') acNewRenderIntro();
    else acNewRenderItem(0);
}

window.acNewStartItems = function() {
    acNewState.stage = 'items';
    acNewState.idx = 0;
    acNewRenderItem(0);
};

window.acNewPick = function(itemIdx, key, value) {
    if (!acNewState || acNewState.idx !== itemIdx) return;
    var resp = acNewState.responses[itemIdx] || {};
    var item = acNewState.items[itemIdx] || {};
    if (acHasGuidedItemSchema(item)) {
        if (key === 'verbe_index') {
            resp.step11_done = false; resp.step11_ok = false; resp.step11_feedback = '';
            resp.step11_pending = 'Choix enregistre. Clique sur "Valider 1.1" pour verifier.';
        } else if (key === 'verbe_sens_index') {
            resp.step12_done = false; resp.step12_ok = false; resp.step12_feedback = '';
            resp.step12_pending = 'Choix enregistre. Clique sur "Valider 1.2" pour verifier.';
        } else if (key === 'competence_index') {
            resp.step13_done = false; resp.step13_ok = false; resp.step13_feedback = '';
            resp.step13_pending = 'Choix enregistre. Clique sur "Valider 1.3" pour verifier.';
        } else if (key === 'niveau_value') {
            resp.step3_done = false; resp.step3_ok = false; resp.step3_feedback = '';
            resp.step3_pending = 'Choix enregistre. Clique sur "Valider l\'etape 3" pour verifier.';
        }
    }
    resp[key] = value;
    acNewState.responses[itemIdx] = resp;
    acNewRenderItem(itemIdx);
};

window.acNewPickMulti = function(itemIdx, key, id) {
    if (!acNewState || acNewState.idx !== itemIdx) return;
    var resp = acNewState.responses[itemIdx] || {};
    var item = acNewState.items[itemIdx] || {};
    var arr = resp[key] || [];
    var i = arr.indexOf(id);
    if (i === -1) arr.push(id);
    else arr.splice(i, 1);
    if (acHasGuidedItemSchema(item)) {
        if (key === 'analyse_selected_ids') {
            resp.step2_done = false; resp.step2_ok = false; resp.step2_feedback = '';
            resp.step2_pending = 'Choix enregistres. Clique sur "Valider l\'etape 2" pour verifier.';
        } else if (key === 'correction_selected_ids') {
            resp.step4_done = false; resp.step4_ok = false; resp.step4_feedback = '';
            resp.step4_pending = 'Choix enregistres. Clique sur "Valider l\'etape 4" pour verifier.';
        }
    }
    resp[key] = arr;
    acNewState.responses[itemIdx] = resp;
    acNewRenderItem(itemIdx);
};

window.acNewValidateStep = function(itemIdx, stepKey) {
    if (!acNewState || acNewState.idx !== itemIdx) return;
    var item = acNewState.items[itemIdx] || {};
    var resp = acNewState.responses[itemIdx] || {};
    if (!acHasGuidedItemSchema(item)) return;

    var e1 = item.etape1 || {};
    var e1v = e1.verbe_sens_qcu || {};
    var e1c = item.etape1_competence || {};
    var e2 = item.etape2_analyse || {};
    var e3 = item.etape3_niveau || {};
    var e4 = item.etape4_corrections || {};

    if (stepKey === 'step11') {
        resp.step11_done = true;
        resp.step11_pending = '';
        var ok11 = resp.verbe_index === (typeof e1.verbe_index === 'number' ? e1.verbe_index : 0);
        resp.step11_ok = ok11;
        resp.step11_feedback = ok11
            ? ('Correct. ' + (e1.verbe_definition || '') + ' ' + (e1.verbe_exemple_concret || ''))
            : ('Incorrect. ' + (e1.verbe_definition || 'Reprends le verbe d\'action de la consigne.'));
    }
    if (stepKey === 'step12') {
        resp.step12_done = true;
        resp.step12_pending = '';
        var ok12 = resp.verbe_sens_index === (typeof e1v.correct === 'number' ? e1v.correct : 0);
        resp.step12_ok = ok12;
        resp.step12_feedback = ok12 ? ('Correct. ' + (e1v.explication || '')) : ('Incorrect. ' + (e1v.explication || ''));
    }
    if (stepKey === 'step13') {
        resp.step13_done = true;
        resp.step13_pending = '';
        var ok13 = resp.competence_index === (typeof e1c.competence_index === 'number' ? e1c.competence_index : 0);
        resp.step13_ok = ok13;
        resp.step13_feedback = ok13
            ? ('Correct. ' + (e1c.competence_definition || '') + ' ' + (e1c.competence_exemple_concret || '') + ' ' + (e1c.pourquoi_pas_les_autres || ''))
            : ('Incorrect. ' + (e1c.competence_definition || '') + ' ' + (e1c.pourquoi_pas_les_autres || ''));
    }
    if (stepKey === 'step2') {
        resp.step2_done = true;
        resp.step2_pending = '';
        var selected = acNormalizeIdList(resp.analyse_selected_ids);
        var corrects = acNormalizeIdList(e2.corrects);
        var ok2 = acSetEq(selected, corrects);
        resp.step2_ok = ok2;
        var fb2 = [];
        function findChoiceText(id) {
            var choix = Array.isArray(e2.choix) ? e2.choix : [];
            for (var j = 0; j < choix.length; j++) {
                if (String(choix[j].id || '') === String(id)) return choix[j].texte || id;
            }
            return id;
        }
        var extras = selected.filter(function(id) { return corrects.indexOf(id) === -1; });
        var missing = corrects.filter(function(id) { return selected.indexOf(id) === -1; });
        selected.forEach(function(id) { if (e2.feedback && e2.feedback[id]) fb2.push(e2.feedback[id]); });
        if (ok2) fb2.unshift('Bonne combinaison exacte : 1 point.');
        if (extras.length > 0) {
            var extrasTxt = extras.map(function(id) { return '"' + findChoiceText(id) + '"'; }).join(', ');
            fb2.push('Tu as coche une option en trop (' + extrasTxt + '). Ici, une option en trop fait perdre le point.');
        }
        if (missing.length > 0) {
            var missingTxt = missing.map(function(id) { return '"' + findChoiceText(id) + '"'; }).join(', ');
            fb2.push('Il manque une ou plusieurs options attendues : ' + missingTxt + '.');
        }
        if (!ok2 && selected.length === 0) fb2.push('Choisis les affirmations qui correspondent a l\'analyse attendue.');
        if (!ok2 && fb2.length === 0) fb2.push('La combinaison doit etre exacte pour obtenir le point.');
        resp.step2_feedback = fb2.join(' ');
    }
    if (stepKey === 'step3') {
        resp.step3_done = true;
        resp.step3_pending = '';
        var ok3 = String(resp.niveau_value || '') === String(e3.niveau_attendu || 'insuffisant');
        resp.step3_ok = ok3;
        resp.step3_feedback = (ok3 ? 'Correct. ' : 'Incorrect. ') + (e3.pourquoi_ce_niveau || '');
    }
    if (stepKey === 'step4') {
        resp.step4_done = true;
        resp.step4_pending = '';
        var selectedC = acNormalizeIdList(resp.correction_selected_ids);
        var acc = acNormalizeIdList(e4.acceptables);
        var nonp = acNormalizeIdList(e4.non_pertinentes);
        var exactSet = acSetEq(selectedC, acc);
        resp.step4_ok = exactSet;
        var fb4 = [];
        selectedC.forEach(function(id) { if (e4.feedback && e4.feedback[id]) fb4.push(e4.feedback[id]); });
        if (selectedC.some(function(id) { return nonp.indexOf(id) !== -1; })) fb4.push('Certaines propositions cochees sont non pertinentes.');
        if (!exactSet && selectedC.length > 0 && !selectedC.some(function(id) { return nonp.indexOf(id) !== -1; })) {
            fb4.push('Il manque encore une ou plusieurs propositions acceptables.');
        }
        fb4.push(e4.message_pedagogique || 'Plusieurs formulations peuvent etre acceptables si elles respectent la competence.');
        resp.step4_feedback = fb4.join(' ');
    }
    acNewState.responses[itemIdx] = resp;
    acNewRenderItem(itemIdx);
};

window.acNewValidateItem = function() {
    var idx = acNewState.idx;
    var item = acNewState.items[idx] || {};
    var resp = acNewState.responses[idx];
    if (acHasGuidedItemSchema(item)) {
        var allDone = resp.step11_done && resp.step12_done && resp.step13_done && resp.step2_done && resp.step3_done && resp.step4_done;
        if (!allDone) {
            showToast('Valide les etapes 1.1, 1.2, 1.3, 2, 3 et 4 avant de continuer.');
            return;
        }
        resp.validated = true;
        acNewRenderItem(idx);
        return;
    }
    var missing = [];
    ['verbe_index', 'competence_index', 'niveau_index', 'justif_index', 'amelioration_index'].forEach(function(k) {
        if (resp[k] === null || resp[k] === undefined) missing.push(k);
    });
    if (missing.length > 0) {
        showToast('Choisis les 5 Ã©tapes avant de valider cet item.');
        return;
    }
    resp.validated = true;
    acNewRenderItem(idx);
};

window.acNewNext = function() {
    if (!acNewState.responses[acNewState.idx].validated) {
        showToast('Valide dâ€™abord cet item.');
        return;
    }
    if (acNewState.idx < acNewState.items.length - 1) {
        acNewState.idx++;
        acNewRenderItem(acNewState.idx);
        acNewState.zone.scrollIntoView({ behavior: 'smooth', block: 'start' });
        return;
    }
    if (acNewCanScoreC6()) {
        if (!acNewAllItemsValidated()) {
            showToast('Valide les 5 items avant la grille C6.');
            return;
        }
        acNewState.stage = 'final_c6';
        acNewRenderFinalC6();
        return;
    }
    acNewFinishAndShow();
};

window.acNewPrev = function() {
    if (acNewState.idx > 0) {
        acNewState.idx--;
        acNewRenderItem(acNewState.idx);
        acNewState.zone.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
};

window.acNewBackToLastItem = function() {
    acNewState.stage = 'items';
    acNewState.idx = acNewState.items.length - 1;
    acNewRenderItem(acNewState.idx);
};

window.acNewPickC6 = function(critId, val) {
    acNewState.c6Selections[critId] = val;
    acNewRenderFinalC6();
};

window.acNewToggleC6Help = function(critId) {
    var el = document.getElementById('ac-v2-help-' + critId);
    if (!el) return;
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
};

window.acNewFinish = function() {
    if (!acNewAllItemsValidated()) {
        showToast('Valide tous les items avant de finir.');
        return;
    }
    if (!acNewAllC6Selected()) {
        showToast('Attribue une note 0/1/2 pour chaque critÃ¨re C6.');
        return;
    }
    acNewFinishAndShow();
};

function renderAnalyseCopie(zone, c) {
    c = normalizeAnalyseCopie(c || {});
    if (isAnalyseCopieNewSchema(c)) {
        renderAnalyseCopieV2(zone, c);
        return;
    }
    var adapted = acAdaptLegacySchema(c);
    if (isAnalyseCopieNewSchema(adapted)) {
        renderAnalyseCopieV2(zone, adapted);
        return;
    }
    acState.items = c.items || [];
    acState.currentIdx = 0;
    acState.responses = [];
    acState.zone = zone;
    // Initialize empty responses for each item
    for (var i = 0; i < acState.items.length; i++) {
        acState.responses.push({
            verbe: '', competence: '', validee: '', niveau: 0,
            justification: '', c6: [-1, -1, -1, -1], amelioration: ''
        });
    }

    var html = '';
    // Contexte
    if (c.contexte) {
        html += '<div class="ac-contexte">' + c.contexte + '</div>';
    }
    if (c.consigne) {
        html += '<div style="font-weight:700; color:#334155; margin-bottom:16px; text-align:center;">' + c.consigne + '</div>';
    }
    // Progress bar
    html += '<div class="ac-progress" id="ac-progress-text">Item 1 / ' + acState.items.length + '</div>';
    html += '<div class="ac-progress-bar" id="ac-progress-bar">';
    for (var i = 0; i < acState.items.length; i++) {
        html += '<div class="ac-progress-dot' + (i === 0 ? ' active' : '') + '" id="ac-dot-' + i + '"></div>';
    }
    html += '</div>';
    // Item zone
    html += '<div id="ac-item-zone"></div>';
    // Navigation
    html += '<div class="ac-nav" id="ac-nav">';
    html += '<button class="ac-btn-prev" id="ac-btn-prev" onclick="window.acPrev()">â† Precedent</button>';
    html += '<button class="ac-btn-next" id="ac-btn-next" onclick="window.acNext()">Suivant â†’</button>';
    html += '</div>';

    zone.innerHTML = html;
    acRenderItem(0);
}

function acRenderItem(idx) {
    var item = acState.items[idx];
    var resp = acState.responses[idx];
    if (!item) return;

    var html = '<div class="ac-item">';

    // Question d'examen
    html += '<div class="ac-exam-question"><strong>ðŸ“‹ Question de l\'examen :</strong>' + item.question_examen + '</div>';

    // RÃ©ponse de l'Ã©lÃ¨ve
    html += '<div class="ac-response-eleve"><strong>âœï¸ Reponse de l\'eleve :</strong>' + item.reponse_eleve + '</div>';

    // Section 1: Verbe d'action
    var verbes = item.verbes_proposes || AC_VERBES;
    html += '<div class="ac-section">';
    html += '<div class="ac-section-title">1. Quel verbe d\'action est utilise dans la question ?</div>';
    html += '<div class="ac-qcu" data-group="ac-' + idx + '-verbe">';
    verbes.forEach(function(v) {
        html += '<div class="ac-choice' + (resp.verbe === v ? ' selected' : '') + '" data-val="' + v + '" data-group="ac-' + idx + '-verbe" onclick="window.acSelect(this)">' + v.charAt(0).toUpperCase() + v.slice(1) + '</div>';
    });
    html += '</div></div>';

    // Section 2: CompÃ©tence dominante
    html += '<div class="ac-section">';
    html += '<div class="ac-section-title">2. Quelle competence est principalement evaluee ?</div>';
    html += '<div class="ac-qcu" data-group="ac-' + idx + '-comp">';
    AC_COMPETENCES.forEach(function(c) {
        var compLabels = { C2: 'C2 â€” Analyser', C3: 'C3 â€” Expliquer', C4: 'C4 â€” Proposer', C5: 'C5 â€” Argumenter', C6: 'C6 â€” Communiquer' };
        html += '<div class="ac-choice' + (resp.competence === c ? ' selected' : '') + '" data-val="' + c + '" data-group="ac-' + idx + '-comp" onclick="window.acSelect(this)">' + compLabels[c] + '</div>';
    });
    html += '</div></div>';

    // Section 3: RÃ©ponse validÃ©e ?
    html += '<div class="ac-section">';
    html += '<div class="ac-section-title">3. La reponse de l\'eleve est-elle valide ?</div>';
    html += '<div class="ac-qcu" data-group="ac-' + idx + '-validee">';
    html += '<div class="ac-choice' + (resp.validee === 'oui' ? ' selected' : '') + '" data-val="oui" data-group="ac-' + idx + '-validee" onclick="window.acSelect(this)">âœ… Oui</div>';
    html += '<div class="ac-choice' + (resp.validee === 'non' ? ' selected' : '') + '" data-val="non" data-group="ac-' + idx + '-validee" onclick="window.acSelect(this)">âŒ Non</div>';
    html += '</div></div>';

    // Section 4: Niveau (conditionnel â€” visible si validÃ©e = oui)
    html += '<div class="ac-section ac-conditional' + (resp.validee === 'oui' ? ' visible' : '') + '" id="ac-' + idx + '-niveau-section">';
    html += '<div class="ac-section-title">4. Quel niveau de maitrise ? (1 = insuffisant, 4 = excellent)</div>';
    html += '<div class="ac-qcu" data-group="ac-' + idx + '-niveau">';
    for (var n = 1; n <= 4; n++) {
        var nivLabels = { 1: '1 â€” Non maitrisee', 2: '2 â€” Insuffisamment maitrisee', 3: '3 â€” Maitrisee', 4: '4 â€” Bien maitrisee' };
        html += '<div class="ac-choice' + (resp.niveau === n ? ' selected' : '') + '" data-val="' + n + '" data-group="ac-' + idx + '-niveau" onclick="window.acSelect(this)">' + nivLabels[n] + '</div>';
    }
    html += '</div></div>';

    // Section 5: Justification anti-hasard
    html += '<div class="ac-section">';
    html += '<div class="ac-section-title">5. Justifie ton evaluation (pourquoi cette competence / ce niveau ?)</div>';
    html += '<textarea class="ac-textarea" id="ac-' + idx + '-justification" placeholder="Explique en quelques mots pourquoi tu as fait ces choix...">' + (resp.justification || '') + '</textarea>';
    html += '<div class="ac-correction-hint" id="ac-' + idx + '-justification-hint"></div>';
    html += '</div>';

    // Section 6: Grille C6 (conditionnel â€” visible si compÃ©tence = C6)
    html += '<div class="ac-section ac-conditional' + (resp.competence === 'C6' ? ' visible' : '') + '" id="ac-' + idx + '-c6-section">';
    html += '<div class="ac-section-title">6. Grille d\'evaluation C6 â€” Communication</div>';
    html += '<div class="ac-c6-grid">';
    AC_C6_CRITERES.forEach(function(crit, ci) {
        html += '<div class="ac-c6-row" id="ac-' + idx + '-c6-row-' + ci + '">';
        html += '<div class="ac-c6-label">' + crit + '</div>';
        html += '<div class="ac-c6-btns">';
        for (var v = 0; v <= 2; v++) {
            html += '<div class="ac-c6-btn' + (resp.c6[ci] === v ? ' active' : '') + '" data-idx="' + idx + '" data-crit="' + ci + '" data-val="' + v + '" onclick="window.acC6Select(this)">' + v + '</div>';
        }
        html += '</div></div>';
    });
    html += '</div></div>';

    // Section 7: AmÃ©lioration
    html += '<div class="ac-section">';
    html += '<div class="ac-section-title">7. Que pourrait ameliorer l\'eleve dans sa reponse ?</div>';
    html += '<textarea class="ac-textarea" id="ac-' + idx + '-amelioration" placeholder="Propose des pistes d\'amelioration...">' + (resp.amelioration || '') + '</textarea>';
    html += '<div class="ac-correction-hint" id="ac-' + idx + '-amelioration-hint"></div>';
    html += '</div>';

    html += '</div>'; // close ac-item

    document.getElementById('ac-item-zone').innerHTML = html;

    // Update progress
    document.getElementById('ac-progress-text').textContent = 'Item ' + (idx + 1) + ' / ' + acState.items.length;
    for (var d = 0; d < acState.items.length; d++) {
        var dot = document.getElementById('ac-dot-' + d);
        dot.className = 'ac-progress-dot' + (d === idx ? ' active' : (d < idx ? ' done' : ''));
    }

    // Update navigation buttons
    document.getElementById('ac-btn-prev').style.display = idx === 0 ? 'none' : '';
    var nextBtn = document.getElementById('ac-btn-next');
    if (idx === acState.items.length - 1) {
        nextBtn.textContent = 'âœ… Terminer';
        nextBtn.className = 'ac-btn-next';
        nextBtn.style.background = '#22c55e';
    } else {
        nextBtn.textContent = 'Suivant â†’';
        nextBtn.className = 'ac-btn-next';
        nextBtn.style.background = '';
    }
}

function acSaveCurrentItem() {
    var idx = acState.currentIdx;
    var resp = acState.responses[idx];

    // Save QCU selections
    var verbeEl = document.querySelector('.ac-choice[data-group="ac-' + idx + '-verbe"].selected');
    resp.verbe = verbeEl ? verbeEl.getAttribute('data-val') : '';

    var compEl = document.querySelector('.ac-choice[data-group="ac-' + idx + '-comp"].selected');
    resp.competence = compEl ? compEl.getAttribute('data-val') : '';

    var valEl = document.querySelector('.ac-choice[data-group="ac-' + idx + '-validee"].selected');
    resp.validee = valEl ? valEl.getAttribute('data-val') : '';

    var nivEl = document.querySelector('.ac-choice[data-group="ac-' + idx + '-niveau"].selected');
    resp.niveau = nivEl ? parseInt(nivEl.getAttribute('data-val')) : 0;

    // Save textareas
    var justEl = document.getElementById('ac-' + idx + '-justification');
    resp.justification = justEl ? justEl.value : '';

    var amelEl = document.getElementById('ac-' + idx + '-amelioration');
    resp.amelioration = amelEl ? amelEl.value : '';

    // C6 already saved via acC6Select
}

window.acSelect = function(el) {
    var group = el.getAttribute('data-group');
    document.querySelectorAll('.ac-choice[data-group="' + group + '"]').forEach(function(ch) {
        ch.classList.remove('selected');
    });
    el.classList.add('selected');

    // Handle conditional sections
    var idx = acState.currentIdx;
    if (group.endsWith('-validee')) {
        var val = el.getAttribute('data-val');
        var nivSection = document.getElementById('ac-' + idx + '-niveau-section');
        if (nivSection) {
            if (val === 'oui') nivSection.classList.add('visible');
            else nivSection.classList.remove('visible');
        }
    }
    if (group.endsWith('-comp')) {
        var comp = el.getAttribute('data-val');
        var c6Section = document.getElementById('ac-' + idx + '-c6-section');
        if (c6Section) {
            if (comp === 'C6') c6Section.classList.add('visible');
            else c6Section.classList.remove('visible');
        }
    }
};

window.acC6Select = function(el) {
    var idx = parseInt(el.getAttribute('data-idx'));
    var crit = parseInt(el.getAttribute('data-crit'));
    var val = parseInt(el.getAttribute('data-val'));

    // Deselect siblings
    var row = el.parentElement;
    row.querySelectorAll('.ac-c6-btn').forEach(function(b) { b.classList.remove('active'); });
    el.classList.add('active');

    // Save
    acState.responses[idx].c6[crit] = val;
};

window.acNext = function() {
    acSaveCurrentItem();
    if (acState.currentIdx < acState.items.length - 1) {
        acState.currentIdx++;
        acRenderItem(acState.currentIdx);
        acState.zone.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // Last item â€” trigger validation
        document.getElementById('btn-validate').click();
    }
};

window.acPrev = function() {
    acSaveCurrentItem();
    if (acState.currentIdx > 0) {
        acState.currentIdx--;
        acRenderItem(acState.currentIdx);
        acState.zone.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
};

function retryExercice() {
    if (currentExo) startExercice(currentExo);
}
</script>
</body>
</html>
