<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"/>
<title>Module C1 : Traiter l'information</title>
<style>
  :root{
    --bg:#0b1220; 
    --text:#eaf0ff;
    --card-bg: rgba(16, 31, 61, 0.95);
    --accent:#7dd3fc;
    --accent2:#a78bfa;
    --success:#34d399;
    --error:#fb7185;
    --font-ui: system-ui, -apple-system, sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:var(--font-ui); color:var(--text);
    background: radial-gradient(1200px 600px at 20% -10%, rgba(125, 211, 252,.15), transparent 55%),
                radial-gradient(900px 520px at 100% 0%, rgba(167, 139, 250,.15), transparent 52%),
                var(--bg);
    padding:10px; padding-bottom:80px;
    background-attachment: fixed;
    user-select: none; overflow-x: hidden;
  }
  .wrap{max-width:900px; margin:0 auto; min-height: 90vh; display: flex; flex-direction: column;}

  /* HEADER COACH */
  .header-zone { display:flex; align-items:center; gap:15px; background: rgba(11, 18, 32, 0.95); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .avatar-circle { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--accent); background: #0f172a; object-fit: cover; flex-shrink: 0;}
  .coach-bubble { font-size: 0.95rem; color: #e2e8f0; line-height: 1.4; flex:1; }

  /* PAGES */
  .page-section { display: none; animation: fadeIn 0.4s; }
  .page-section.active { display: block; }

  /* COMPOSANTS */
  .card { background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 15px; }
  .card h3 { margin-top:0; color:var(--accent); font-size:1.1rem; display:flex; align-items:center; gap:10px;}
  
  .btn-nav { padding: 14px 24px; background: linear-gradient(135deg, var(--accent2), var(--accent)); color: #0b1220; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 800; width: 100%; transition: 0.2s; box-shadow: 0 4px 15px rgba(125, 211, 252, 0.3); margin-top: 10px; }
  .btn-nav:active { transform: scale(0.98); }
  .btn-nav.ghost { background: transparent; border: 2px solid rgba(255,255,255,0.2); color: var(--text); box-shadow: none; margin-bottom:10px; }
  .btn-small { padding: 8px 12px; font-size: 0.85rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: var(--accent); cursor: pointer; }
  
  /* AUDIO BUTTON */
  .btn-audio { background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px; opacity: 0.8; }
  .btn-audio:hover { transform: scale(1.2); opacity: 1; }

  /* INPUTS IDENTIFIANT */
  .identity-box {
      border: 1px solid var(--accent);
      background: rgba(15, 23, 42, 0.6);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
  }
  .name-input, .class-select { background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); color: white; padding: 15px; border-radius: 12px; font-size: 1rem; width: 100%; margin: 5px 0 15px 0; display: block; outline:none; }
  .name-input:focus, .class-select:focus { border-color: var(--accent); }
  .class-select option { background: #0b1220; text-align: left; }
  label { color: #b9c6ff; font-size: 0.9rem; display: block; margin-bottom: 5px; text-align: left; }

  /* CORRECTION & FEEDBACK */
  .correction-box {
      margin-top: 15px;
      padding: 15px;
      background: rgba(52, 211, 153, 0.1);
      border-left: 4px solid var(--success);
      color: #e2e8f0;
      border-radius: 8px;
      display: none; /* Masqu√© par d√©faut */
      font-size: 0.9rem;
  }
  .correction-box strong { color: var(--success); }
  
  #global-feedback {
      margin-top: 10px;
      font-size: 0.9rem;
      font-weight: bold;
      min-height: 20px;
  }

  /* EXERCICES */
  .question-block { margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
  .check-label { display: flex; gap: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; transition:0.2s; align-items: flex-start; }
  .check-label:hover { background: rgba(255,255,255,0.1); }
  .check-label input { margin-top: 4px; }
  
  select.std-select { width:100%; padding:12px; background:#0f172a; border:1px solid rgba(255,255,255,0.3); color:white; border-radius:8px; margin-top:5px; outline:none; font-size: 1rem; }

  /* DRAG & DROP (CHIPS) */
  .bank-zone { display: flex; flex-wrap: wrap; gap: 8px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; min-height: 60px; margin-bottom: 20px; }
  .chip { padding: 8px 14px; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.8rem; font-weight: bold; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition:0.2s; user-select: none; }
  .chip.selected { background: var(--accent2); color: #0b1220; border-color: var(--accent2); transform: scale(1.05); box-shadow: 0 0 15px rgba(167, 139, 250, 0.5); }
  
  .target-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .target-zone { background: rgba(255,255,255,0.02); border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 10px; min-height: 120px; display:flex; flex-direction:column; gap:5px; align-items: center;}
  .target-title { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; font-weight: bold; text-align: center; margin-bottom: 5px; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;}

  /* DOCS */
  .doc-modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; overflow-y: auto; padding: 20px; }
  .doc-content { background: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; border-radius: 16px; border: 1px solid var(--accent); position: relative; }
  .close-doc { position: absolute; top: 10px; right: 10px; background: var(--error); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
  .doc-item { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
  .mini-table { width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px; color: #cbd5e1; }
  .mini-table th { text-align:left; color:var(--accent); border-bottom:1px solid rgba(255,255,255,0.1); padding:8px; background: rgba(255,255,255,0.05); }
  .mini-table td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 9999; top: -10px; }
  @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

</style>
</head>
<body>

<div class="wrap">

    <div class="header-zone">
        <img src="avatar-neutral.png" class="avatar-circle" id="coachImg" onerror="this.src='https://placehold.co/60?text=Prof'">
        <div class="coach-bubble" id="coachText">Bienvenue ! Pr√™t pour la Comp√©tence C1 ?</div>
    </div>

    <div id="docModal" class="doc-modal">
        <div class="doc-content">
            <button class="close-doc" onclick="toggleDocs()">‚úï</button>
            <h2 style="color:var(--accent); margin-top:0;">üìö Documents Ressources</h2>
            <div class="doc-item">
                <h4 style="color:var(--accent); margin:0 0 5px 0;">Doc 1 : Eau du robinet et en bouteille</h4>
                <p style="font-size:0.9rem; color:#e2e8f0;">L‚Äôeau du robinet est <b>potable</b> et contr√¥l√©e.<br>L‚Äôeau en bouteille n√©cessite <b>emballage</b>, <b>transport</b> et g√©n√®re des <b>d√©chets</b>.</p>
            </div>
            <div class="doc-item">
                <h4 style="color:var(--accent); margin:0 0 5px 0;">Doc 2 : DDM et Rappels</h4>
                <p style="font-size:0.9rem; color:#e2e8f0;"><b>DDM :</b> Date de qualit√© (go√ªt), pas dangereux apr√®s.<br><b>Rappel :</b> Risque pour la sant√©, suivre la consigne.</p>
            </div>
            <div class="doc-item">
                <h4 style="color:var(--accent); margin:0 0 5px 0;">Doc 3 : Habitudes</h4>
                <table class="mini-table">
                    <tr><th>Habitude</th><th>Avant</th><th>Apr√®s</th></tr>
                    <tr><td>Douche</td><td>9 min</td><td>5 min</td></tr>
                    <tr><td>Lave-vaisselle</td><td>1/2 plein</td><td>Plein</td></tr>
                    <tr><td>Chasse d'eau</td><td>Simple</td><td>Double</td></tr>
                    <tr><td>Arrosage</td><td>Potable</td><td>Pluie</td></tr>
                </table>
            </div>
            <button class="btn-nav" onclick="toggleDocs()">Fermer les documents</button>
        </div>
    </div>

    <div id="page0" class="page-section active">
        <div style="text-align:center; padding:40px 20px;">
            <h1 style="background: linear-gradient(to right, var(--accent), var(--accent2)); -webkit-background-clip: text; color: transparent; font-size: 2.5rem; margin-bottom: 10px;">TRAITER L'INFO</h1>
            <div style="font-size:3rem; margin:20px 0;">üìëüß†‚úÖ</div>
            <button class="btn-nav" onclick="startModule()" style="margin-top:25px;">C'EST PARTI !</button>
        </div>
    </div>

    <div id="page1" class="page-section">
        <div class="card">
            <h3>üéØ OBJECTIF C1 <button class="btn-audio" onclick="speak('Objectif : Rep√©rer, s√©lectionner et classer l\'information utile.')">üîà</button></h3>
            <p>Dans ce module, tu ne donnes pas ton avis. <br>Ton but : <strong>Rep√©rer, s√©lectionner et classer</strong> l'information utile dans les documents.</p>
        </div>
        <button class="btn-nav" onclick="goToPage(2)">D√©couvrir les Documents ‚û°</button>
    </div>

    <div id="page2" class="page-section">
        <div class="card" style="text-align:center;">
            <h3>üìÇ DOCUMENTS <button class="btn-audio" onclick="speak('Prends le temps de lire les documents. Tu en auras besoin pour la suite.')">üîà</button></h3>
            <p>Prends une minute pour lire les documents.</p>
            <button class="btn-nav ghost" onclick="toggleDocs()">üëÅÔ∏è Lire les documents</button>
        </div>
        <button class="btn-nav" onclick="goToPage(3)">Commencer l'Exercice 1 ‚û°</button>
    </div>

    <div id="page3" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Exercice 1/4 (5 pts) <button class="btn-audio" onclick="speak('Coche uniquement les affirmations VRAIES selon les documents 1 et 2.')">üîà</button></h3>
            <button class="btn-small" onclick="toggleDocs()">üìñ Voir les Docs</button>
        </div>
        <div class="card">
            <p style="font-size:0.9rem; margin-bottom:15px; color:#cbd5e1;">Coche uniquement les affirmations <strong>VRAIES</strong>.</p>
            <div id="ex1-container">
                <label class="check-label"><input type="checkbox" data-ans="true"> L‚Äôeau du robinet est potable et contr√¥l√©e.</label>
                <label class="check-label"><input type="checkbox" data-ans="true"> La DDM est une date de qualit√© (le go√ªt peut changer).</label>
                <label class="check-label"><input type="checkbox" data-ans="false"> Un rappel est toujours li√© √† une date DDM d√©pass√©e.</label>
                <label class="check-label"><input type="checkbox" data-ans="true"> L‚Äôeau en bouteille g√©n√®re des d√©chets (emballage).</label>
                <label class="check-label"><input type="checkbox" data-ans="false"> Apr√®s la DDM, le produit est forc√©ment dangereux.</label>
            </div>
            <div id="cor-ex1" class="correction-box">
                <strong>Correction :</strong><br>‚úÖ Vrai : Eau potable, DDM (qualit√©), D√©chets bouteille.<br>‚ùå Faux : Le rappel n'est pas li√© √† la date. Apr√®s la DDM, ce n'est pas dangereux.
            </div>
        </div>
        <button class="btn-nav" onclick="goToPage(4)">Exercice Suivant ‚û°</button>
    </div>

    <div id="page4" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Exercice 2/4 (3 pts) <button class="btn-audio" onclick="speak('Compl√®te les phrases en utilisant le Document 3.')">üîà</button></h3>
            <button class="btn-small" onclick="toggleDocs()">üìñ Voir les Docs</button>
        </div>
        <div class="card">
            <p style="font-size:0.9rem;">Compl√®te les phrases avec le <strong>Doc 3</strong>.</p>
            <div class="question-block">
                <label>Quelle habitude passe de "Simple" √† "Double commande" ?</label>
                <select id="q2-1" class="std-select"><option value="">Choisir...</option><option value="ok">Chasse d'eau</option><option value="no">Douche</option><option value="no">Arrosage</option></select>
            </div>
            <div class="question-block">
                <label>Quelle habitude passe de "9 min" √† "5 min" ?</label>
                <select id="q2-2" class="std-select"><option value="">Choisir...</option><option value="no">Vaisselle</option><option value="ok">Douche</option><option value="no">Chasse d'eau</option></select>
            </div>
            <div class="question-block">
                <label>Quelle habitude passe de "Eau potable" √† "Eau de pluie" ?</label>
                <select id="q2-3" class="std-select"><option value="">Choisir...</option><option value="ok">Arrosage</option><option value="no">Douche</option></select>
            </div>
            <div id="cor-ex2" class="correction-box">
                <strong>Correction :</strong> 1. Chasse d'eau / 2. Douche / 3. Arrosage.
            </div>
        </div>
        <button class="btn-nav" onclick="goToPage(5)">Exercice Suivant ‚û°</button>
    </div>

    <div id="page5" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Exercice 3/4 (8 pts) <button class="btn-audio" onclick="speak('Classe les √©tiquettes dans la bonne zone.')">üîà</button></h3>
            <button class="btn-small" onclick="toggleDocs()">üìñ Voir les Docs</button>
        </div>
        <div class="card">
            <p style="font-size:0.9rem;">Clique sur une √©tiquette (en haut) puis clique sur sa case (en bas).</p>
            <div class="bank-zone" id="chipBank"></div>
            <div class="target-grid">
                <div class="target-zone" id="zone-robinet" onclick="dropChip('zone-robinet')"><div class="target-title">Eau Robinet</div></div>
                <div class="target-zone" id="zone-bouteille" onclick="dropChip('zone-bouteille')"><div class="target-title">Eau Bouteille</div></div>
                <div class="target-zone" id="zone-ddm" onclick="dropChip('zone-ddm')"><div class="target-title">DDM</div></div>
                <div class="target-zone" id="zone-rappel" onclick="dropChip('zone-rappel')"><div class="target-title">Rappel Produit</div></div>
            </div>
            <div id="cor-ex3" class="correction-box">
                <strong>Correction :</strong> V√©rifie le code couleur (Vert = Juste).
            </div>
        </div>
        <button class="btn-nav" onclick="goToPage(6)">Exercice Suivant ‚û°</button>
    </div>

    <div id="page6" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Exercice 4/4 (4 pts) <button class="btn-audio" onclick="speak('R√©ponds aux questions de compr√©hension.')">üîà</button></h3>
            <button class="btn-small" onclick="toggleDocs()">üìñ Voir les Docs</button>
        </div>
        <div class="card">
            <div class="question-block">
                <label>Que se passe-t-il apr√®s la date DDM ?</label>
                <select id="q4-1" class="std-select"><option value="">Choisir...</option><option value="ok">Perte de qualit√© (go√ªt) mais pas dangereux</option><option value="no">Danger mortel imm√©diat</option><option value="no">Le produit explose</option></select>
            </div>
            <div class="question-block">
                <label>√Ä quoi sert un rappel de produit ?</label>
                <select id="q4-2" class="std-select"><option value="">Choisir...</option><option value="no">Faire de la publicit√©</option><option value="ok">Informer d'un risque et donner une consigne</option><option value="no">Vendre le produit moins cher</option></select>
            </div>
            <div id="cor-ex4" class="correction-box">
                <strong>Correction :</strong> 1. Perte de qualit√© seulement. 2. Informer d'un risque.
            </div>
        </div>
        <button class="btn-nav" onclick="goToPage(7)">Terminer et Voir le Bilan ‚û°</button>
    </div>

    <div id="page7" class="page-section" style="text-align:center;">
        <h2 style="color:var(--accent); font-size:2rem; margin-top:20px;">BILAN FINAL</h2>
        
        <div class="card">
            <p>Remplis tes informations pour voir ta note et la correction.</p>
            
            <div class="identity-box">
                <label>Identifiant √©l√®ve :</label>
                <input type="text" id="pse-eleve-nom" class="name-input" placeholder="Ex: P12...">
                
                <label>Classe :</label>
                <select id="pse-eleve-classe" class="class-select">
                    <option value="">-- Choisis ta classe --</option>
                    <option value="2BACPRO_GATL1">2BACPRO_GATL1</option><option value="2BACPRO_GATL2">2BACPRO_GATL2</option>
                    <option value="1BACPRO_AGO1">1BACPRO_AGO1</option><option value="1BACPRO_AGO2">1BACPRO_AGO2</option>
                    <option value="TBACPRO_AGO1">TBACPRO_AGO1</option><option value="TBACPRO_AGO2">TBACPRO_AGO2</option>
                    <option value="2_MELEC">2_MELEC</option><option value="1_MELEC">1_MELEC</option><option value="T_MELEC">T_MELEC</option>
                    <option value="CAP_PSR1">CAP_PSR1</option><option value="CAP_PSR2">CAP_PSR2</option>
                    <option value="CAP_VAN1">CAP_VAN1</option><option value="CAP_VAN2">CAP_VAN2</option>
                    <option value="CAP_CAN1">CAP_CAN1</option><option value="CAP_CAN2">CAP_CAN2</option>
                    <option value="CAP_HORT1">CAP_HORT1</option><option value="CAP_HORT2">CAP_HORT2</option>
                    <option value="CAP_JP1">CAP_JP1</option><option value="CAP_JP2">CAP_JP2</option>
                </select>
            </div>

            <button id="main-action-btn" class="btn-nav" onclick="showResultsAndSend()">VOIR MON R√âSULTAT</button>
            <div id="global-feedback"></div>

            <div id="result-zone" style="display:none; margin-top:20px;">
                <div style="font-size:4rem;">üèÜ</div>
                <p id="finalScoreText" style="font-weight:bold; color:white; font-size:1.5rem;"></p>
                <p style="color:#cbd5e1; font-size:0.9rem;">Les corrections sont maintenant affich√©es sur chaque page.</p>
            </div>
        </div>

        <div id="review-nav" style="display:none; margin-top:20px;">
            <p style="color:var(--accent);">Naviguer pour voir les corrections :</p>
            <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                <button class="btn-small" onclick="goToPage(3)">Ex 1</button>
                <button class="btn-small" onclick="goToPage(4)">Ex 2</button>
                <button class="btn-small" onclick="goToPage(5)">Ex 3</button>
                <button class="btn-small" onclick="goToPage(6)">Ex 4</button>
            </div>
        </div>

        <button class="btn-nav ghost" onclick="resetModule()" style="margin-top:30px;">Tout effacer et recommencer</button>
    </div>

</div>

<script>
    let globalScore = 0;
    
    const CHIPS_DATA = [
        {id:"c1", txt:"Potable et contr√¥l√©e", cat:"zone-robinet"},
        {id:"c2", txt:"Moins de d√©chets plastiques", cat:"zone-robinet"},
        {id:"c3", txt:"N√©cessite transport & emballage", cat:"zone-bouteille"},
        {id:"c4", txt:"G√©n√®re des d√©chets", cat:"zone-bouteille"},
        {id:"c5", txt:"Date de qualit√©", cat:"zone-ddm"},
        {id:"c6", txt:"Perte de go√ªt possible", cat:"zone-ddm"},
        {id:"c7", txt:"Risque sanitaire", cat:"zone-rappel"},
        {id:"c8", txt:"Consigne √† suivre", cat:"zone-rappel"}
    ];
    let selectedChip = null;

    // AUDIO
    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'fr-FR';
            window.speechSynthesis.speak(msg);
        }
    }

    // INIT
    window.addEventListener('load', () => {
        const savedId = localStorage.getItem('pse_id');
        const savedClass = localStorage.getItem('pse_class');
        if(savedId) document.getElementById('pse-eleve-nom').value = savedId;
        if(savedClass) document.getElementById('pse-eleve-classe').value = savedClass;
    });

    function startModule() {
        goToPage(1);
        setCoach("Bonjour ! Lis bien les documents page suivante.", "happy");
    }

    function resetModule() { location.reload(); }

    function goToPage(pageNum) {
        document.getElementById('docModal').style.display = 'none';
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById('page' + pageNum).classList.add('active');
        window.scrollTo(0,0);

        if(pageNum === 2) setCoach("Prends le temps de lire.", "neutral");
        if(pageNum === 5) initEx3();
    }

    function toggleDocs() {
        const modal = document.getElementById('docModal');
        modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
    }

    function setCoach(msg, mood) {
        const bubble = document.getElementById('coachText');
        const img = document.getElementById('coachImg');
        bubble.innerHTML = msg;
        if(mood === "happy") img.src = "avatar-bravo.png";
        else if(mood === "sad") img.src = "avatar-attention.png";
        else img.src = "avatar-neutral.png";
        img.onerror = function() { this.src = "https://placehold.co/60?text=Prof"; };
    }

    /* DRAG & DROP LOGIC */
    function initEx3() {
        const bank = document.getElementById('chipBank');
        if(bank.innerHTML !== "") return;
        CHIPS_DATA.sort(() => Math.random() - 0.5).forEach(c => {
            let el = document.createElement('div');
            el.className = 'chip';
            el.innerText = c.txt;
            el.dataset.id = c.id;
            el.dataset.cat = c.cat;
            el.onclick = (e) => { e.stopPropagation(); selectChip(el); };
            bank.appendChild(el);
        });
    }
    function selectChip(el) {
        if(selectedChip) selectedChip.classList.remove('selected');
        selectedChip = el;
        el.classList.add('selected');
    }
    function dropChip(zoneId) {
        if(!selectedChip) return;
        let zone = document.getElementById(zoneId);
        zone.appendChild(selectedChip);
        selectedChip.classList.remove('selected');
        selectedChip = null;
    }

    /* --- FONCTION PRINCIPALE : CALCUL + AFFICHAGE + ENVOI --- */
    function showResultsAndSend() {
        const idInput = document.getElementById('pse-eleve-nom').value.trim();
        const classInput = document.getElementById('pse-eleve-classe').value;
        const feedback = document.getElementById('global-feedback');

        // 1. V√©rif Identit√©
        if(!idInput || !classInput) {
            feedback.style.color = "var(--error)";
            feedback.innerHTML = "‚ö†Ô∏è Remplis ton identifiant et ta classe d'abord !";
            return;
        }

        // Sauvegarde
        localStorage.setItem('pse_id', idInput);
        localStorage.setItem('pse_class', classInput);

        globalScore = 0;

        // 2. Correction EX 1
        let inputs = document.querySelectorAll('#ex1-container input');
        inputs.forEach(inp => {
            let isChecked = inp.checked;
            let shouldBe = inp.dataset.ans === "true";
            if(isChecked === shouldBe) {
                globalScore++; 
                inp.parentElement.style.border = "1px solid var(--success)";
            } else {
                inp.parentElement.style.border = "1px solid var(--error)";
            }
        });
        document.getElementById('cor-ex1').style.display = 'block';

        // 3. Correction EX 2
        let q2_1 = document.getElementById('q2-1').value;
        let q2_2 = document.getElementById('q2-2').value;
        let q2_3 = document.getElementById('q2-3').value;
        if(q2_1 === "ok") globalScore++;
        if(q2_2 === "ok") globalScore++;
        if(q2_3 === "ok") globalScore++;
        document.getElementById('cor-ex2').style.display = 'block';

        // 4. Correction EX 3
        let chips = document.querySelectorAll('.target-zone .chip');
        chips.forEach(c => {
            let parentId = c.parentElement.id;
            if(c.dataset.cat === parentId) {
                globalScore++;
                c.style.background = "var(--success)";
            } else {
                c.style.background = "var(--error)";
            }
        });
        document.getElementById('cor-ex3').style.display = 'block';

        // 5. Correction EX 4
        let q4_1 = document.getElementById('q4-1').value;
        let q4_2 = document.getElementById('q4-2').value;
        if(q4_1 === "ok") globalScore += 2;
        if(q4_2 === "ok") globalScore += 2;
        document.getElementById('cor-ex4').style.display = 'block';

        // 6. Affichage Score
        document.getElementById('result-zone').style.display = 'block';
        document.getElementById('finalScoreText').innerText = `Ton score : ${globalScore} / 20`;
        document.getElementById('review-nav').style.display = 'block'; // Affiche la nav de correction
        
        // 7. Envoi Firebase Discret
        sendToFirebase(idInput, classInput, globalScore);
    }

    function triggerConfetti() {
        for(let i=0; i<50; i++) {
            let conf = document.createElement('div');
            conf.className = 'confetti';
            conf.style.left = Math.random() * 100 + 'vw';
            conf.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
            conf.style.animationDuration = Math.random() * 3 + 2 + 's';
            document.body.appendChild(conf);
        }
    }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Fonction globale appel√©e par showResultsAndSend
  window.sendToFirebase = async function(id, classe, score) {
    const feedback = document.getElementById('global-feedback');
    const btn = document.getElementById('main-action-btn');

    feedback.style.color = "var(--accent)";
    feedback.innerHTML = "Calcul et enregistrement...";
    btn.disabled = true;

    try {
      await addDoc(collection(db, "bacpro"), {
        meta: {
          createdAt: new Date().toISOString(),
          nom: id, 
          prenom: id, // Copie pour compatibilit√© PageProf
          classe: classe,
          type: "exercice",
          support: "Module_C1_Traiter_Info"
        },
        resultat: {
          score: score + " / 20",
          url: location.href,
          titre: document.title
        }
      });

      feedback.style.color = "var(--success)";
      feedback.innerHTML = "‚úÖ R√©sultat affich√© et enregistr√©.";
      triggerConfetti();
      btn.textContent = "Mettre √† jour mon r√©sultat"; // Bouton change de texte
      btn.disabled = false; // R√©activ√© pour renvoi

    } catch (error) {
      console.error("Erreur:", error);
      feedback.style.color = "var(--error)";
      feedback.innerHTML = "Score affich√© (mais erreur de connexion pour l'envoi).";
      btn.disabled = false;
    }
  };
</script>

</body>
</html>
