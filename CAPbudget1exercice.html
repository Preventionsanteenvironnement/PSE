<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Le Budget de Lucas - Niveau Sup√©rieur (Version Corrig√©e)</title>
  <style>
    :root{
      --recettes-color:#d4edda;
      --recettes-border:#28a745;
      --fixe-color:#cce5ff;
      --fixe-border:#007bff;
      --courant-color:#fff3cd;
      --courant-border:#ffc107;
      --occas-color:#f8d7da;
      --occas-border:#dc3545;
      --bg-color:#f9f9f9;
      --text-color:#333;

      --recette-travail:#a2d9c2;
      --recette-social:#7fc3af;
      --recette-autre:#55aa99;

      --ok:#28a745;
      --ko:#dc3545;
      --warn:#ff9800;
    }

    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background-color:var(--bg-color);
      color:var(--text-color);
      margin:0;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    h1{color:#2c3e50;margin-bottom:10px}

    .legend-bar{
      display:flex;
      gap:15px;
      font-size:.95rem;
      margin-bottom:10px;
      background:#fff;
      padding:10px 16px;
      border-radius:50px;
      border:1px solid #ddd;
      flex-wrap:wrap;
      justify-content:center;
      text-align:center;
    }

    .context-box{
      background:#fff;
      padding:20px;
      border-radius:15px;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      max-width:900px;
      width:100%;
      margin-bottom:20px;
      line-height:1.8;
      font-size:1.15rem;
      position:relative;
    }

    .audio-btn{
      background-color:#6c757d;
      color:#fff;
      border:none;
      padding:8px 16px;
      border-radius:50px;
      cursor:pointer;
      font-size:1rem;
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-bottom:15px;
      transition:background .2s;
    }
    .audio-btn:hover{background-color:#5a6268}
    .audio-btn.playing{background-color:#dc3545}

    #item-bank{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      background:#fff;
      padding:15px;
      border-radius:10px;
      min-height:80px;
      width:100%;
      max-width:1000px;
      margin-bottom:20px;
      border:2px dashed #ccc;
    }

    .draggable-item{
      padding:10px 20px;
      background:#fff;
      border:2px solid #555;
      border-radius:8px;
      cursor:grab;
      user-select:none;
      font-weight:bold;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
      transition:transform .2s, background-color .2s, border-color .2s;
      outline:none;
    }
    .draggable-item:active{cursor:grabbing;transform:scale(1.05)}
    .draggable-item.is-selected{background:#e2e6ea;border-color:#007bff}
    .draggable-item.item-ok{border-color:var(--ok)}
    .draggable-item.item-ko{border:3px solid var(--ko)}
    .draggable-item.item-warn{border:3px solid var(--warn)}

    .budget-container{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:15px;
      width:100%;
      max-width:1200px;
    }

    .column{
      background:#fff;
      border-radius:10px;
      padding:10px;
      display:flex;
      flex-direction:column;
      min-height:400px;
      border-top:6px solid #ccc;
    }

    .column h3{
      text-align:center;
      margin-top:0;
      padding-bottom:10px;
      border-bottom:1px solid #eee;
      font-size:1.1rem;
    }

    #col-recettes{
      grid-column:span 1;
      border-top-color:var(--recettes-border);
      display:grid;
      grid-template-rows:auto 1fr auto;
    }
    #col-recettes h3{margin-bottom:10px}

    .recette-sub-zones{
      display:flex;
      flex-direction:column;
      gap:5px;
      flex-grow:1;
      padding-bottom:10px;
      border-bottom:1px solid #ccc;
    }

    .sub-zone{
      flex-grow:1;
      padding:8px;
      border-radius:5px;
      margin-bottom:5px;
      min-height:80px;
    }
    .sub-zone h4{
      font-size:.9rem;
      font-weight:bold;
      color:#2c3e50;
      margin:0 0 5px 0;
      padding-bottom:3px;
      border-bottom:1px dashed #fff;
    }

    .sub-zone[data-category="recette-travail"]{background-color:var(--recette-travail)}
    .sub-zone[data-category="recette-social"]{background-color:var(--recette-social)}
    .sub-zone[data-category="recette-autre"]{background-color:var(--recette-autre)}

    .drop-zone{
      flex-grow:1;
      padding:10px;
      border-radius:5px;
      background-color:rgba(0,0,0,.02);
      transition:background .2s;
      min-height:80px;
    }
    .drop-zone.drag-over{background-color:rgba(0,0,0,.1)}

    #col-fixes{border-top-color:var(--fixe-border)}
    #col-fixes .drop-zone{background-color:var(--fixe-color)}

    #col-courantes{border-top-color:var(--courant-border)}
    #col-courantes .drop-zone{background-color:var(--courant-color)}

    #col-occas{border-top-color:var(--occas-border)}
    #col-occas .drop-zone{background-color:var(--occas-color)}

    .calc-zone{
      margin-top:10px;
      padding-top:10px;
      border-top:2px solid #eee;
      text-align:center;
    }

    input[type="number"]{
      width:110px;
      padding:8px;
      font-size:1.1rem;
      border:2px solid #ccc;
      border-radius:5px;
      text-align:right;
      margin-bottom:5px;
    }

    .verify-btn{
      background-color:#17a2b8;
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:5px;
      cursor:pointer;
      font-size:1rem;
      margin-top:5px;
    }
    .verify-btn:hover{background-color:#138496}

    .feedback-msg{
      display:block;
      font-size:.95rem;
      margin-top:8px;
      font-weight:bold;
      min-height:1.2em;
    }
    .correct{color:var(--ok)}
    .incorrect{color:var(--ko)}

    .final-synthesis{
      margin-top:40px;
      background:#fff;
      padding:30px;
      border-radius:15px;
      width:100%;
      max-width:800px;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      border-left:10px solid #2c3e50;
    }

    .synthesis-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:15px;
      font-size:1.2rem;
      gap:10px;
    }

    .result-options{
      display:flex;
      gap:15px;
      justify-content:center;
      margin-top:25px;
      flex-wrap:wrap;
    }

    .result-options label{
      cursor:pointer;
      padding:12px 20px;
      background:#f1f3f5;
      border-radius:50px;
      border:2px solid transparent;
      transition:.2s;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }

    .result-options input{display:none}

    .result-options label.selected{
      border-color:#007bff;
      background-color:#e7f1ff;
    }
    .result-options label.selected span{
      font-weight:bold;
      color:#007bff;
    }

    @media (max-width:900px){
      .budget-container{grid-template-columns:1fr 1fr}
      .column{margin-bottom:20px}
      #col-recettes{grid-column:span 2}
    }
  </style>
</head>
<body>

  <h1>üí∞ Le Budget de Lucas - Challenge !</h1>

  <div class="legend-bar">
    <span>Objectif : Identifier si c‚Äôest une <strong>Recette</strong> ou une <strong>D√©pense</strong>, puis classer la nature exacte.</span>
  </div>

  <div class="context-box">
    <button id="main-audio-btn" class="audio-btn">
      <span>‚ñ∂Ô∏è Lire l‚Äôhistoire</span>
    </button>

    <div id="text-content">
      Lucas, √©tudiant en alternance et jeune papa, essaie de faire ses comptes. Chaque mois, il re√ßoit son <strong>salaire de 1 600 ‚Ç¨</strong>. Il a √©galement re√ßu une <strong>prime exceptionnelle de 150 ‚Ç¨</strong> pour un projet r√©ussi au travail.<br><br>

      Au niveau des aides, il touche les <strong>APL de 280 ‚Ç¨</strong> et les <strong>allocations familiales de 130 ‚Ç¨</strong>.<br>

      Ce mois-ci, il a vendu une vieille console de jeux pour <strong>100 ‚Ç¨</strong> sur internet.
      <hr>
      Ses charges r√©currentes : Loyer (650 ‚Ç¨), Remboursement de pr√™t √©tudiant (85 ‚Ç¨), Assurance auto (40 ‚Ç¨), Abonnements (streaming, jeux : 35 ‚Ç¨).<br>

      Ses d√©penses courantes : Courses alimentaires (300 ‚Ç¨), Essence (120 ‚Ç¨), √âlectricit√© / Gaz (100 ‚Ç¨), Forfait t√©l√©phone (15 ‚Ç¨).<br><br>

      Pour le b√©b√©, il a achet√© un si√®ge auto neuf (150 ‚Ç¨). Il est sorti deux fois au restaurant avec sa femme (80 ‚Ç¨ au total) et a d√ª payer une consultation chez le dentiste (45 ‚Ç¨) qui n'√©tait pas enti√®rement rembours√©e.
    </div>
  </div>

  <div style="width:100%; max-width:1000px; text-align:left; margin-bottom:5px; font-size:1.1rem;">
    <strong>1. Classe les √©tiquettes dans leur nature (Recette, D√©pense Fixe, Courante, Occasionnelle) :</strong>
  </div>

  <div id="item-bank" data-category="bank" aria-label="Banque d‚Äô√©tiquettes"></div>

  <div class="budget-container">
    <div class="column" id="col-recettes">
      <h3>Recettes</h3>
      <div class="recette-sub-zones">
        <div class="sub-zone drop-zone" data-category="recette-travail">
          <h4>Travail (Salaire, Prime)</h4>
        </div>
        <div class="sub-zone drop-zone" data-category="recette-social">
          <h4>Social (Aides, Allocations)</h4>
        </div>
        <div class="sub-zone drop-zone" data-category="recette-autre">
          <h4>Autre (Vente, Cadeau...)</h4>
        </div>
      </div>
      <div class="calc-zone">
        <label>Total Recettes : </label>
        <input type="number" id="input-recettes" placeholder="?"> ‚Ç¨
        <br>
        <button class="verify-btn" data-verify="recette">V√©rifier</button>
        <span id="msg-recettes" class="feedback-msg"></span>
      </div>
    </div>

    <div class="column" id="col-fixes">
      <h3>D√©penses Fixes</h3>
      <div class="drop-zone" data-category="fixe"></div>
      <div class="calc-zone">
        <label>Total : </label>
        <input type="number" id="input-fixes" placeholder="?"> ‚Ç¨
        <br>
        <button class="verify-btn" data-verify="fixe">V√©rifier</button>
        <span id="msg-fixes" class="feedback-msg"></span>
      </div>
    </div>

    <div class="column" id="col-courantes">
      <h3>D√©penses Courantes</h3>
      <div class="drop-zone" data-category="courante"></div>
      <div class="calc-zone">
        <label>Total : </label>
        <input type="number" id="input-courantes" placeholder="?"> ‚Ç¨
        <br>
        <button class="verify-btn" data-verify="courante">V√©rifier</button>
        <span id="msg-courantes" class="feedback-msg"></span>
      </div>
    </div>

    <div class="column" id="col-occas">
      <h3>D√©penses Occas.</h3>
      <div class="drop-zone" data-category="occas"></div>
      <div class="calc-zone">
        <label>Total : </label>
        <input type="number" id="input-occas" placeholder="?"> ‚Ç¨
        <br>
        <button class="verify-btn" data-verify="occas">V√©rifier</button>
        <span id="msg-occas" class="feedback-msg"></span>
      </div>
    </div>
  </div>

  <div class="final-synthesis">
    <h2>üìä Le Bilan</h2>
    <p>Reporte tes totaux pour calculer le solde.</p>

    <div class="synthesis-row">
      <span>Total des Recettes :</span>
      <input type="number" id="final-recettes" placeholder="..."> ‚Ç¨
    </div>
    <div class="synthesis-row">
      <span>Total des D√©penses :</span>
      <input type="number" id="final-depenses" placeholder="..."> ‚Ç¨
    </div>
    <hr>
    <div class="synthesis-row" style="font-weight:bold;font-size:1.4rem;">
      <span>SOLDE (Recettes - D√©penses) :</span>
      <input type="number" id="final-solde" placeholder="..."> ‚Ç¨
    </div>

    <div style="text-align:center;margin-top:10px;">
      <button class="verify-btn" id="btn-bilan" style="font-size:1.1rem;padding:10px 20px;">V√©rifier le Solde</button>
      <div id="msg-bilan" class="feedback-msg" style="font-size:1.1rem;margin-top:10px;"></div>
    </div>

    <div class="result-options" id="budget-status" style="opacity:.3; pointer-events:none;">
      <p style="width:100%; text-align:center; margin-bottom:10px;">Le budget est :</p>
      <label>
        <input type="radio" name="budget" value="exc√©dentaire">
        <span>Exc√©dentaire (+)</span>
      </label>
      <label>
        <input type="radio" name="budget" value="d√©ficitaire">
        <span>D√©ficitaire (-)</span>
      </label>
      <label>
        <input type="radio" name="budget" value="√©quilibr√©">
        <span>√âquilibr√© (=)</span>
      </label>
    </div>

    <div style="text-align:center;margin-top:20px;">
      <button class="verify-btn" id="btn-conclusion" style="display:none;padding:10px 25px;">V√©rifier la r√©ponse</button>
      <div id="msg-conclusion" class="feedback-msg"></div>
    </div>
  </div>

  <script>
    const itemsData = [
      { id: 1,  name: "Salaire",                     val: 1600, cat: "recette-travail", globalCat: "recette" },
      { id: 2,  name: "Prime Travail",               val: 150,  cat: "recette-travail", globalCat: "recette" },
      { id: 3,  name: "APL",                         val: 280,  cat: "recette-social",  globalCat: "recette" },
      { id: 4,  name: "Allocations Familiales",      val: 130,  cat: "recette-social",  globalCat: "recette" },
      { id: 5,  name: "Vente Console",               val: 100,  cat: "recette-autre",   globalCat: "recette" },

      { id: 6,  name: "Loyer",                       val: 650,  cat: "fixe",            globalCat: "depense" },
      { id: 7,  name: "Pr√™t √âtudiant",               val: 85,   cat: "fixe",            globalCat: "depense" },
      { id: 8,  name: "Assurance Auto",              val: 40,   cat: "fixe",            globalCat: "depense" },
      { id: 9,  name: "Abonnements",                 val: 35,   cat: "fixe",            globalCat: "depense" },

      { id: 10, name: "Courses Alim.",               val: 300,  cat: "courante",        globalCat: "depense" },
      { id: 11, name: "Essence",                     val: 120,  cat: "courante",        globalCat: "depense" },
      { id: 12, name: "√âlectricit√© / Gaz",           val: 100,  cat: "courante",        globalCat: "depense" },
      { id: 13, name: "Forfait T√©l√©phone",           val: 15,   cat: "courante",        globalCat: "depense" },

      { id: 14, name: "Si√®ge Auto",                  val: 150,  cat: "occas",           globalCat: "depense" },
      { id: 15, name: "Restaurant",                  val: 80,   cat: "occas",           globalCat: "depense" },
      { id: 16, name: "Dentiste (reste √† charge)",   val: 45,   cat: "occas",           globalCat: "depense" }
    ];

    const totalsExpected = {
      recettes: itemsData.filter(i => i.globalCat === "recette").reduce((a,b)=>a+b.val,0),
      fixe:     itemsData.filter(i => i.globalCat === "depense" && i.cat === "fixe").reduce((a,b)=>a+b.val,0),
      courante: itemsData.filter(i => i.globalCat === "depense" && i.cat === "courante").reduce((a,b)=>a+b.val,0),
      occas:    itemsData.filter(i => i.globalCat === "depense" && i.cat === "occas").reduce((a,b)=>a+b.val,0)
    };

    const totalDepensesReelles = totalsExpected.fixe + totalsExpected.courante + totalsExpected.occas;
    const soldeReel = totalsExpected.recettes - totalDepensesReelles;

    const bank = document.getElementById("item-bank");
    const shuffled = [...itemsData].sort(() => Math.random() - 0.5);

    shuffled.forEach(item => {
      const el = document.createElement("div");
      el.className = "draggable-item";
      el.draggable = true;
      el.id = "item-" + item.id;

      el.dataset.val = item.val;
      el.dataset.cat = item.cat;
      el.dataset.globalCat = item.globalCat;

      el.tabIndex = 0;
      el.textContent = `${item.name} (${item.val} ‚Ç¨)`;

      el.addEventListener("dragstart", onDragStart);
      el.addEventListener("click", () => selectItem(el));
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          selectItem(el);
        }
      });

      bank.appendChild(el);
    });

    let selectedItem = null;

    function clearSelection(){
      if(!selectedItem) return;
      selectedItem.classList.remove("is-selected");
      selectedItem = null;
    }

    function selectItem(el){
      if(selectedItem === el){
        clearSelection();
        return;
      }
      clearSelection();
      selectedItem = el;
      el.classList.add("is-selected");
    }

    function onDragStart(ev){
      const el = ev.currentTarget;
      ev.dataTransfer.setData("text/plain", el.id);
      selectItem(el);
    }

    function onDragOver(ev){
      ev.preventDefault();
      ev.currentTarget.classList.add("drag-over");
    }

    function onDragLeave(ev){
      ev.currentTarget.classList.remove("drag-over");
    }

    function appendItemToZone(zone, el){
      zone.appendChild(el);
      clearSelection();
      el.focus();
    }

    function onDrop(ev){
      ev.preventDefault();
      const zone = ev.currentTarget;
      zone.classList.remove("drag-over");

      const id = ev.dataTransfer.getData("text/plain");
      const dragged = id ? document.getElementById(id) : null;
      const el = dragged || selectedItem;
      if(!el) return;

      appendItemToZone(zone, el);
    }

    function onZoneClick(ev){
      const zone = ev.currentTarget;
      if(!selectedItem) return;
      if(ev.target.closest(".draggable-item")) return;
      appendItemToZone(zone, selectedItem);
    }

    const allZones = [ bank, ...document.querySelectorAll(".drop-zone") ];
    allZones.forEach(zone => {
      zone.addEventListener("dragover", onDragOver);
      zone.addEventListener("dragleave", onDragLeave);
      zone.addEventListener("drop", onDrop);
      zone.addEventListener("click", onZoneClick);
    });

    function resetItemMarks(){
      document.querySelectorAll(".draggable-item").forEach(el => {
        el.classList.remove("item-ok","item-ko","item-warn");
      });
    }
    function markOk(el){ el.classList.add("item-ok"); }
    function markKo(el){ el.classList.add("item-ko"); }
    function markWarn(el){ el.classList.add("item-warn"); }

    function setMsg(msgEl, html, ok){
      msgEl.innerHTML = html;
      msgEl.className = "feedback-msg " + (ok ? "correct" : "incorrect");
    }

    function isInRecetteArea(el){
      const p = el.parentElement;
      return p && p.classList.contains("sub-zone") && (p.dataset.category || "").startsWith("recette-");
    }

    function getItemElById(id){ return document.getElementById("item-" + id); }

    function verifierRecettes(){
      resetItemMarks();

      const msg = document.getElementById("msg-recettes");
      const input = document.getElementById("input-recettes");

      const recetteZones = [...document.querySelectorAll('.sub-zone[data-category^="recette-"]')];

      let majorError = false;
      recetteZones.forEach(zone => {
        [...zone.querySelectorAll(":scope > .draggable-item")].forEach(el => {
          if(el.dataset.globalCat !== "recette"){
            majorError = true;
            markKo(el);
          }
        });
      });
      if(majorError){
        setMsg(msg, "‚ùå <strong>ERREUR MAJEURE :</strong> Une d√©pense a √©t√© plac√©e dans les Recettes. Corrige les √©tiquettes en rouge.", false);
        return;
      }

      const recetteItems = itemsData.filter(i => i.globalCat === "recette");
      const missing = [];
      let warnSub = false;

      recetteItems.forEach(it => {
        const el = getItemElById(it.id);
        if(!el) return;
        if(!isInRecetteArea(el)){
          missing.push(it.name);
          markKo(el);
          return;
        }
        const currentZoneCat = el.parentElement.dataset.category;
        if(currentZoneCat !== it.cat){
          warnSub = true;
          markWarn(el);
        }else{
          markOk(el);
        }
      });

      if(missing.length){
        setMsg(msg, `‚ö†Ô∏è <strong>CLASSEMENT INCOMPLET :</strong> Il manque ${missing.length} recette(s) dans la zone Recettes.`, false);
        return;
      }

      const userVal = parseInt(input.value, 10);
      if(Number.isNaN(userVal)){
        msg.innerHTML = "√âcris le total des Recettes dans la case, puis clique sur V√©rifier.";
        msg.className = "feedback-msg";
        return;
      }

      if(userVal !== totalsExpected.recettes){
        setMsg(msg, `‚ùå Le calcul est faux. Total attendu : <strong>${totalsExpected.recettes} ‚Ç¨</strong>.`, false);
        return;
      }

      input.dataset.validated = "true";
      document.getElementById("final-recettes").value = userVal;

      if(warnSub){
        setMsg(msg, "‚úÖ Total correct. <strong>Attention :</strong> corrige les sous-cat√©gories en orange pour finaliser.", true);
        input.style.borderColor = "#28a745";
        input.style.backgroundColor = "#e8f5e9";
        return;
      }

      setMsg(msg, "‚úÖ Bravo ! Classement et total des Recettes : correct.", true);
      input.style.borderColor = "#28a745";
      input.style.backgroundColor = "#e8f5e9";
      input.disabled = true;
      input.dataset.validated = "true";
    }

    function verifierDepenses(cat, inputId, msgId){
      resetItemMarks();

      const zone = document.querySelector(`.drop-zone[data-category="${cat}"]`);
      const msg = document.getElementById(msgId);
      const input = document.getElementById(inputId);

      let majorError = false;
      [...zone.querySelectorAll(":scope > .draggable-item")].forEach(el => {
        if(el.dataset.globalCat === "recette"){
          majorError = true;
          markKo(el);
        }
      });
      if(majorError){
        setMsg(msg, "‚ùå <strong>ERREUR MAJEURE :</strong> Une recette a √©t√© plac√©e dans cette colonne. Corrige les √©tiquettes en rouge.", false);
        return;
      }

      let wrongInZone = false;
      [...zone.querySelectorAll(":scope > .draggable-item")].forEach(el => {
        if(el.dataset.globalCat !== "depense" || el.dataset.cat !== cat){
          wrongInZone = true;
          markKo(el);
        }else{
          markOk(el);
        }
      });
      if(wrongInZone){
        setMsg(msg, "‚ö†Ô∏è <strong>CLASSEMENT √Ä CORRIGER :</strong> Un poste ne correspond pas √† cette colonne (en rouge).", false);
        return;
      }

      const expectedItems = itemsData.filter(i => i.globalCat === "depense" && i.cat === cat);
      const missing = [];

      expectedItems.forEach(it => {
        const el = getItemElById(it.id);
        if(!el) return;
        if(el.parentElement !== zone){
          missing.push(it.name);
          markKo(el);
        }else{
          markOk(el);
        }
      });

      if(missing.length){
        setMsg(msg, `‚ö†Ô∏è <strong>CLASSEMENT INCOMPLET :</strong> Il manque ${missing.length} d√©pense(s) dans cette colonne.`, false);
        return;
      }

      const expectedTotal = totalsExpected[cat];
      const userVal = parseInt(input.value, 10);
      if(Number.isNaN(userVal)){
        msg.innerHTML = "√âcris le total dans la case, puis clique sur V√©rifier.";
        msg.className = "feedback-msg";
        return;
      }

      if(userVal !== expectedTotal){
        setMsg(msg, `‚ùå Le calcul est faux. Total attendu : <strong>${expectedTotal} ‚Ç¨</strong>.`, false);
        return;
      }

      setMsg(msg, "‚úÖ Bravo ! Classement et total : correct.", true);
      input.style.borderColor = "#28a745";
      input.style.backgroundColor = "#e8f5e9";
      input.disabled = true;
      input.dataset.validated = "true";

      autoFillDepensesFinalIfReady();
    }

    function autoFillDepensesFinalIfReady(){
      const a = document.getElementById("input-fixes").dataset.validated === "true";
      const b = document.getElementById("input-courantes").dataset.validated === "true";
      const c = document.getElementById("input-occas").dataset.validated === "true";
      if(!(a && b && c)) return;

      const dFixe = parseInt(document.getElementById("input-fixes").value,10) || 0;
      const dCour = parseInt(document.getElementById("input-courantes").value,10) || 0;
      const dOcc  = parseInt(document.getElementById("input-occas").value,10) || 0;
      const sum = dFixe + dCour + dOcc;

      const finalDep = document.getElementById("final-depenses");
      if(!finalDep.value) finalDep.value = sum;
    }

    function verifierBilan(){
      const msg = document.getElementById("msg-bilan");

      const recettesOK = document.getElementById("input-recettes").dataset.validated === "true";
      const fixesOK    = document.getElementById("input-fixes").dataset.validated === "true";
      const courOK     = document.getElementById("input-courantes").dataset.validated === "true";
      const occasOK    = document.getElementById("input-occas").dataset.validated === "true";

      if(!(recettesOK && fixesOK && courOK && occasOK)){
        msg.innerHTML = "‚ö†Ô∏è V√©rifie d‚Äôabord les 4 totaux de colonnes (Recettes, Fixes, Courantes, Occasionnelles).";
        msg.className = "feedback-msg incorrect";
        return;
      }

      const r = parseInt(document.getElementById("final-recettes").value,10) || 0;
      const dFinal = parseInt(document.getElementById("final-depenses").value,10);
      const s = parseInt(document.getElementById("final-solde").value,10);

      const dFixe = parseInt(document.getElementById("input-fixes").value,10) || 0;
      const dCour = parseInt(document.getElementById("input-courantes").value,10) || 0;
      const dOcc  = parseInt(document.getElementById("input-occas").value,10) || 0;
      const dCalc = dFixe + dCour + dOcc;

      const errors = [];
      if(r !== totalsExpected.recettes) errors.push("Total Recettes report√© incorrect.");
      if(Number.isNaN(dFinal)) errors.push("√âcris le Total D√©penses.");
      else if(dFinal !== dCalc) errors.push(`Total D√©penses report√© incorrect. Il doit √™tre la somme des 3 colonnes : ${dCalc} ‚Ç¨.`);
      else if(dFinal !== totalDepensesReelles) errors.push(`Total D√©penses incorrect (attendu : ${totalDepensesReelles} ‚Ç¨).`);

      if(errors.length){
        msg.innerHTML = "‚ùå " + errors.join(" ");
        msg.className = "feedback-msg incorrect";
        return;
      }

      if(Number.isNaN(s)){
        msg.innerHTML = "√âcris le solde dans la case, puis v√©rifie.";
        msg.className = "feedback-msg";
        return;
      }

      if(s === (r - dFinal)){
        msg.innerHTML = `‚úÖ Excellent ! Solde correct : <strong>${soldeReel} ‚Ç¨</strong>.`;
        msg.className = "feedback-msg correct";
        document.getElementById("budget-status").style.opacity = "1";
        document.getElementById("budget-status").style.pointerEvents = "auto";
        document.getElementById("btn-conclusion").style.display = "inline-block";
      }else{
        msg.innerHTML = `‚ö†Ô∏è Solde faux. Fais : Recettes - D√©penses. R√©sultat attendu : <strong>${soldeReel} ‚Ç¨</strong>.`;
        msg.className = "feedback-msg incorrect";
      }
    }

    function verifierConclusion(){
      const msg = document.getElementById("msg-conclusion");

      const correctStatus = soldeReel > 0 ? "exc√©dentaire" : (soldeReel < 0 ? "d√©ficitaire" : "√©quilibr√©");
      const checked = document.querySelector('input[name="budget"]:checked');

      if(!checked){
        msg.innerHTML = "Choisis une r√©ponse : exc√©dentaire, d√©ficitaire ou √©quilibr√©.";
        msg.className = "feedback-msg incorrect";
        return;
      }

      if(checked.value === correctStatus){
        msg.innerHTML = "üéâ BRAVO ! Tu as termin√© l‚Äôexercice avec succ√®s.";
        msg.className = "feedback-msg correct";
        msg.style.fontSize = "1.3rem";
        document.body.style.backgroundColor = "#e8f5e9";
      }else{
        msg.innerHTML = `Non. Regarde le signe de ton solde (${soldeReel} ‚Ç¨).`;
        msg.className = "feedback-msg incorrect";
      }
    }

    let isSpeaking = false;
    function toggleAudio(){
      const btn = document.getElementById("main-audio-btn");

      if(isSpeaking){
        window.speechSynthesis.cancel();
        isSpeaking = false;
        btn.classList.remove("playing");
        btn.innerHTML = "<span>‚ñ∂Ô∏è Lire l‚Äôhistoire</span>";
        return;
      }

      const text = document.getElementById("text-content").innerText;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "fr-FR";
      utterance.rate = 0.9;

      utterance.onend = () => {
        isSpeaking = false;
        btn.classList.remove("playing");
        btn.innerHTML = "<span>‚ñ∂Ô∏è Lire l‚Äôhistoire</span>";
      };

      window.speechSynthesis.speak(utterance);
      isSpeaking = true;
      btn.classList.add("playing");
      btn.innerHTML = "<span>‚èπÔ∏è Arr√™ter</span>";
    }

    function syncRadioLabels(){
      document.querySelectorAll('#budget-status label').forEach(l => l.classList.remove('selected'));
      const checked = document.querySelector('#budget-status input[name="budget"]:checked');
      if(checked){
        checked.closest('label').classList.add('selected');
      }
    }

    document.getElementById("main-audio-btn").addEventListener("click", toggleAudio);

    document.querySelectorAll('button[data-verify]').forEach(btn => {
      btn.addEventListener("click", () => {
        const which = btn.dataset.verify;
        if(which === "recette") verifierRecettes();
        if(which === "fixe") verifierDepenses("fixe", "input-fixes", "msg-fixes");
        if(which === "courante") verifierDepenses("courante", "input-courantes", "msg-courantes");
        if(which === "occas") verifierDepenses("occas", "input-occas", "msg-occas");
      });
    });

    document.getElementById("btn-bilan").addEventListener("click", verifierBilan);
    document.getElementById("btn-conclusion").addEventListener("click", verifierConclusion);

    document.querySelectorAll('#budget-status input[name="budget"]').forEach(r => {
      r.addEventListener("change", syncRadioLabels);
    });
  </script>
</body>
  <script type="module">
    // 1. Importation des outils Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // 2. Configuration (La cl√© de ton projet devoirs-pse)
    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.appspot.com",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    // 3. Initialisation
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 4. R√©cup√©ration automatique du Nom et du Support
    // Il prend ce qui est √©crit dans la balise <title> tout en haut
    let nomPage = document.title;
    
    // S√©curit√© : si tu as oubli√© le titre, il prend le nom du fichier (ex: index.html)
    if (!nomPage || nomPage === "") {
        nomPage = window.location.pathname.split("/").pop();
    }

    // D√©tection Mobile ou Ordinateur
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const support = isMobile ? "Mobile" : "Ordinateur";

    // 5. Envoi vers Firebase
    async function envoyerLaVisite() {
        try {
            await addDoc(collection(db, "statistiques_usage"), {
                page: nomPage,
                device: support,
                timestamp: serverTimestamp(), // Enregistre l'heure exacte pour tes stats Jour/Nuit
                date: new Date().toISOString()
            });
            console.log("üöÄ Statistique envoy√©e : " + nomPage + " (" + support + ")");
        } catch (e) {
            console.error("Erreur lors de l'envoi de la stat :", e);
        }
    }

    // Ex√©cution imm√©diate au chargement de la page
    envoyerLaVisite();
</script>
</body>
</html>
