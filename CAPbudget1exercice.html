<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Budget de Lucas - Niveau Sup√©rieur (Version Am√©lior√©e)</title>
    <style>
        /* Les styles sont principalement conserv√©s pour la coh√©rence */
        :root {
            --recettes-color: #d4edda;
            --recettes-border: #28a745;
            --fixe-color: #cce5ff;
            --fixe-border: #007bff;
            --courant-color: #fff3cd;
            --courant-border: #ffc107;
            --occas-color: #f8d7da;
            --occas-border: #dc3545;
            --bg-color: #f9f9f9;
            --text-color: #333;
            /* Nouvelles couleurs pour les sous-cat√©gories de recettes */
            --recette-travail: #a2d9c2;
            --recette-social: #7fc3af;
            --recette-autre: #55aa99;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: #2c3e50; margin-bottom: 10px; }

        /* L√©gende des codes (simplifi√©e ou retir√©e si on veut que ce soit un d√©fi) */
        .legend-bar {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            background: #fff;
            padding: 8px 15px;
            border-radius: 50px;
            border: 1px solid #ddd;
        }
        .code-hint { font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        
        /* Zone de texte */
        .context-box {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 1.15rem;
            position: relative;
        }

        .audio-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: background 0.2s;
        }
        .audio-btn:hover { background-color: #5a6268; }
        .audio-btn.playing { background-color: #dc3545; }

        /* Zone des √©tiquettes (Banque) */
        #item-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            background: white;
            padding: 15px;
            border-radius: 10px;
            min-height: 80px;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 20px;
            border: 2px dashed #ccc;
        }

        .draggable-item {
            padding: 10px 20px;
            background-color: white;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: grab;
            user-select: none;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, background-color 0.2s;
        }

        .draggable-item:active { cursor: grabbing; transform: scale(1.05); }

        /* Le Tableau - Nouvelle grille pour la sous-cat√©gorie Recettes */
        .budget-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 1200px;
        }

        .column {
            background: white;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 400px;
            border-top: 6px solid #ccc;
        }

        .column h3 {
            text-align: center;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
        }
        
        /* Conteneur sp√©cial pour les Recettes */
        #col-recettes { 
            grid-column: span 1; /* Il prendra un quart */
            border-top-color: var(--recettes-border); 
            display: grid;
            grid-template-rows: auto 1fr auto; /* Titre, zones de d√©p√¥t, calcul */
        }
        #col-recettes h3 { margin-bottom: 10px;}

        .recette-sub-zones {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }

        .sub-zone {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            min-height: 80px;
        }
        .sub-zone h4 {
            font-size: 0.9rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 0 0 5px 0;
            padding-bottom: 3px;
            border-bottom: 1px dashed #fff;
        }

        .sub-zone[data-category="recette-travail"] { background-color: var(--recette-travail); }
        .sub-zone[data-category="recette-social"] { background-color: var(--recette-social); }
        .sub-zone[data-category="recette-autre"] { background-color: var(--recette-autre); }


        .drop-zone {
            flex-grow: 1;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.02);
            transition: background 0.3s;
            min-height: 80px;
        }

        .drop-zone.drag-over { background-color: rgba(0,0,0,0.1); }
        
        /* Couleurs des D√©penses */
        #col-fixes { border-top-color: var(--fixe-border); }
        #col-fixes .drop-zone { background-color: var(--fixe-color); }

        #col-courantes { border-top-color: var(--courant-border); }
        #col-courantes .drop-zone { background-color: var(--courant-color); }

        #col-occas { border-top-color: var(--occas-border); }
        #col-occas .drop-zone { background-color: var(--occas-color); }

        /* Zone de Calcul */
        .calc-zone {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #eee;
            text-align: center;
        }
        
        input[type="number"] {
            width: 90px;
            padding: 8px;
            font-size: 1.1rem;
            border: 2px solid #ccc;
            border-radius: 5px;
            text-align: right;
            margin-bottom: 5px;
        }

        .verify-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 5px;
        }
        .verify-btn:hover { background-color: #138496; }
        
        .feedback-msg {
            display: block;
            font-size: 0.95rem;
            margin-top: 8px;
            font-weight: bold;
            min-height: 1.2em;
        }

        .correct { color: #28a745; }
        .incorrect { color: #dc3545; }

        /* Synth√®se finale */
        .final-synthesis {
            margin-top: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 10px solid #2c3e50;
        }

        .synthesis-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .result-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .result-options label {
            cursor: pointer;
            padding: 12px 20px;
            background: #f1f3f5;
            border-radius: 50px;
            border: 2px solid transparent;
            transition: 0.3s;
        }

        .result-options input { display: none; }

        .result-options input:checked + span {
            font-weight: bold;
            color: #007bff;
        }
        .result-options label:has(input:checked) {
            border-color: #007bff;
            background-color: #e7f1ff;
        }

        /* Responsive tablette simple */
        @media (max-width: 900px) {
            .budget-container { grid-template-columns: 1fr 1fr; }
            .column { margin-bottom: 20px; }
            #col-recettes { grid-column: span 2; } /* Prend 2 colonnes sur 2 en mode mobile */
        }

    </style>
</head>
<body>

    <h1>üí∞ Le Budget de Lucas - Challenge !</h1>

    <div class="legend-bar">
        <span>Objectif : Identifier si c'est une **Recette** ou une **D√©pense**. Puis classer la nature exacte.</span>
    </div>

    <div class="context-box">
        <button id="main-audio-btn" class="audio-btn" onclick="toggleAudio()">
            <span>‚ñ∂Ô∏è Lire l'histoire</span>
        </button>
        
        <div id="text-content">
            Lucas, √©tudiant en alternance et jeune papa, essaie de faire ses comptes. Chaque mois, il re√ßoit son **salaire de 1 600 ‚Ç¨**. Il a √©galement re√ßu une **prime exceptionnelle de 150 ‚Ç¨** pour un projet r√©ussi au travail.<br><br>
            
            Au niveau des aides, il touche les **APL de 280 ‚Ç¨** et les **allocations familiales de 130 ‚Ç¨**.<br>
            
            Ce mois-ci, il a vendu une vieille console de jeux pour **100 ‚Ç¨** sur internet.
            <hr>
            Ses charges r√©currentes : Loyer (650 ‚Ç¨), Remboursement de pr√™t √©tudiant (85 ‚Ç¨), Assurance auto (40 ‚Ç¨), Abonnements (streaming, jeux : 35 ‚Ç¨).<br>
            
            Ses d√©penses courantes : Courses alimentaires (300 ‚Ç¨), Essence (120 ‚Ç¨), √âlectricit√© / Gaz (100 ‚Ç¨), Forfait t√©l√©phone (15 ‚Ç¨).<br><br>
            
            Pour le b√©b√©, il a achet√© un si√®ge auto neuf (150 ‚Ç¨). Il est sorti deux fois au restaurant avec sa femme (80 ‚Ç¨ au total) et a d√ª payer une consultation chez le dentiste (45 ‚Ç¨) qui n'√©tait pas enti√®rement rembours√©e.
        </div>
    </div>

    <div style="width:100%; max-width:1000px; text-align:left; margin-bottom:5px; font-size:1.1rem;">
        <strong>1. Classe les √©tiquettes dans leur nature (Recette, D√©pense Fixe, Courante, Occasionnelle) :</strong>
    </div>
    
    <div id="item-bank" ondrop="drop(event)" ondragover="allowDrop(event)">
        </div>

    <div class="budget-container">
        <div class="column" id="col-recettes">
            <h3>Recettes</h3>
            <div class="recette-sub-zones">
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-travail">
                    <h4>Travail (Salaire, Prime)</h4>
                </div>
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-social">
                    <h4>Social (Aides, Allocations)</h4>
                </div>
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-autre">
                    <h4>Autre (Vente, Cadeau...)</h4>
                </div>
            </div>
            <div class="calc-zone">
                <label>Total Recettes : </label>
                <input type="number" id="input-recettes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('recette', 'input-recettes', 'msg-recettes')">V√©rifier</button>
                <span id="msg-recettes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-fixes">
            <h3>D√©penses Fixes</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="fixe"></div>
            <div class="calc-zone">
                <label>Total : </label>
                <input type="number" id="input-fixes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('fixe', 'input-fixes', 'msg-fixes')">V√©rifier</button>
                <span id="msg-fixes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-courantes">
            <h3>D√©penses Courantes</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="courante"></div>
            <div class="calc-zone">
                <label>Total : </label>
                <input type="number" id="input-courantes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('courante', 'input-courantes', 'msg-courantes')">V√©rifier</button>
                <span id="msg-courantes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-occas">
            <h3>D√©penses Occas.</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="occas"></div>
            <div class="calc-zone">
                <label>Total : </label>
                <input type="number" id="input-occas" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('occas', 'input-occas', 'msg-occas')">V√©rifier</button>
                <span id="msg-occas" class="feedback-msg"></span>
            </div>
        </div>
    </div>

    <div class="final-synthesis">
        <h2>üìä Le Bilan</h2>
        <p>Reporte tes totaux pour calculer le solde.</p>
        
        <div class="synthesis-row">
            <span>Total des Recettes :</span>
            <input type="number" id="final-recettes" placeholder="..."> ‚Ç¨
        </div>
        <div class="synthesis-row">
            <span>Total des D√©penses :</span>
            <input type="number" id="final-depenses" placeholder="..."> ‚Ç¨
        </div>
        <hr>
        <div class="synthesis-row" style="font-weight: bold; font-size: 1.4rem;">
            <span>SOLDE (Recettes - D√©penses) :</span>
            <input type="number" id="final-solde" placeholder="..."> ‚Ç¨
        </div>
        
        <div style="text-align: center; margin-top:10px;">
             <button class="verify-btn" onclick="verifierBilan()" style="font-size:1.1rem; padding: 10px 20px;">V√©rifier le Solde</button>
             <div id="msg-bilan" class="feedback-msg" style="font-size:1.1rem; margin-top:10px;"></div>
        </div>

        <div class="result-options" id="budget-status" style="opacity: 0.3; pointer-events: none;">
            <p style="width:100%; text-align:center; margin-bottom:10px;">Le budget est : </p>
            <label>
                <input type="radio" name="budget" value="exc√©dentaire">
                <span>Exc√©dentaire (+)</span>
            </label>
            <label>
                <input type="radio" name="budget" value="d√©ficitaire">
                <span>D√©ficitaire (-)</span>
            </label>
            <label>
                <input type="radio" name="budget" value="√©quilibr√©">
                <span>√âquilibr√© (=)</span>
            </label>
        </div>
        <div style="text-align: center; margin-top:20px;">
            <button class="verify-btn" onclick="verifierConclusion()" id="btn-conclusion" style="display:none; padding:10px 25px;">V√©rifier la r√©ponse</button>
             <div id="msg-conclusion" class="feedback-msg"></div>
        </div>
    </div>

    <script>
        // --- DONN√âES DE LUCAS ---
        const items = [
            // Recettes
            { id: 1, name: "Salaire", val: 1600, cat: "recette-travail", globalCat: "recette" },
            { id: 2, name: "Prime Travail", val: 150, cat: "recette-travail", globalCat: "recette" },
            { id: 3, name: "APL", val: 280, cat: "recette-social", globalCat: "recette" },
            { id: 4, name: "Allocations Familiales", val: 130, cat: "recette-social", globalCat: "recette" },
            { id: 5, name: "Vente Console", val: 100, cat: "recette-autre", globalCat: "recette" },
            
            // D√©penses
            { id: 6, name: "Loyer", val: 650, cat: "fixe", globalCat: "depense" },
            { id: 7, name: "Pr√™t √âtudiant", val: 85, cat: "fixe", globalCat: "depense" },
            { id: 8, name: "Assurance Auto", val: 40, cat: "fixe", globalCat: "depense" },
            { id: 9, name: "Abonnements", val: 35, cat: "fixe", globalCat: "depense" },
            
            { id: 10, name: "Courses Alim.", val: 300, cat: "courante", globalCat: "depense" },
            { id: 11, name: "Essence", val: 120, cat: "courante", globalCat: "depense" },
            { id: 12, name: "√âlectricit√© / Gaz", val: 100, cat: "courante", globalCat: "depense" },
            { id: 13, name: "Forfait T√©l√©phone", val: 15, cat: "courante", globalCat: "depense" },
            
            { id: 14, name: "Si√®ge Auto", val: 150, cat: "occas", globalCat: "depense" },
            { id: 15, name: "Restaurant", val: 80, cat: "occas", globalCat: "depense" },
            { id: 16, name: "Dentiste (reste √† charge)", val: 45, cat: "occas", globalCat: "depense" }
        ];

        // --- INITIALISATION ---
        const bank = document.getElementById("item-bank");
        
        // Calcul des totaux r√©els (pour la v√©rification)
        const totalRecettesReelles = items.filter(i => i.globalCat === 'recette').reduce((a, b) => a + b.val, 0); // 2260
        const totalDepensesReelles = items.filter(i => i.globalCat === 'depense').reduce((a, b) => a + b.val, 0); // 1620
        const soldeReel = totalRecettesReelles - totalDepensesReelles; // 640


        // M√©langer les items pour l'exercice
        items.sort(() => Math.random() - 0.5);

        items.forEach(item => {
            let el = document.createElement("div");
            el.classList.add("draggable-item");
            el.setAttribute("draggable", "true");
            el.setAttribute("id", "item-" + item.id);
            el.setAttribute("data-val", item.val);
            el.setAttribute("data-cat", item.cat); // La sous-cat√©gorie exacte
            el.setAttribute("data-global-cat", item.globalCat); // La grande cat√©gorie
            
            el.innerText = `${item.name} (${item.val} ‚Ç¨)`;
            
            // √âv√©nements Drag & Drop
            el.addEventListener("dragstart", drag);
            
            // Accessibilit√© Clic
            el.addEventListener("click", function() {
                selectItem(el);
            });
            
            bank.appendChild(el);
        });

        let selectedItem = null;

        function selectItem(el) {
            if(selectedItem) {
                selectedItem.style.backgroundColor = "white";
                selectedItem.style.borderColor = "#555";
            }
            if (selectedItem === el) {
                selectedItem = null;
                return;
            }
            selectedItem = el;
            el.style.backgroundColor = "#e2e6ea";
            el.style.borderColor = "#007bff";
        }

        // --- DRAG AND DROP LOGIQUE ---
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add("drag-over");
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            selectItem(ev.target);
        }

        function drop(ev) {
            ev.preventDefault();
            document.querySelectorAll('.drop-zone, .sub-zone, #item-bank').forEach(z => z.classList.remove('drag-over'));

            let data = ev.dataTransfer ? ev.dataTransfer.getData("text") : null;
            let draggedElement;

            if (data) draggedElement = document.getElementById(data);
            else if (selectedItem) draggedElement = selectedItem;
            else return;

            let target = ev.target;
            // On s'assure que la cible est bien une zone de d√©p√¥t
            while (!target.classList.contains("drop-zone") && !target.classList.contains("sub-zone") && target.id !== "item-bank" && target.tagName !== "BODY") {
                target = target.parentElement;
            }

            if (target.classList.contains("drop-zone") || target.classList.contains("sub-zone") || target.id === "item-bank") {
                target.appendChild(draggedElement);
            }
            
            if(selectedItem) {
                selectedItem.style.backgroundColor = "white";
                selectedItem.style.borderColor = "#555";
                selectedItem = null;
            }
        }

        // Support "Click to Drop" sur les zones
        document.querySelectorAll('.drop-zone, .sub-zone, #item-bank').forEach(zone => {
            zone.addEventListener('click', function(e) {
                if (selectedItem && e.target !== selectedItem && !e.target.closest('.draggable-item')) {
                    zone.appendChild(selectedItem);
                    selectedItem.style.backgroundColor = "white";
                    selectedItem.style.borderColor = "#555";
                    selectedItem = null;
                }
            });
            zone.addEventListener('dragleave', function() { zone.classList.remove("drag-over"); });
        });


        // --- V√âRIFICATION LOGIQUE (Am√©lior√©e pour le feedback) ---
        
        function verifierColonneGlobale(globalCatName, inputId, msgId) {
            let dropZones = [];
            
            // 1. D√âFINITION DE LA CAT√âGORIE ET CIBLAGE DES ZONES
            if (globalCatName === 'recette') {
                dropZones = document.querySelectorAll(`.sub-zone[data-category^="recette-"]`);
            } else {
                dropZones = document.querySelectorAll(`.drop-zone[data-category="${globalCatName}"]`);
            }
            
            const input = document.getElementById(inputId);
            const msg = document.getElementById(msgId);
            
            let sumItemsPlaces = 0; // Somme des items DANS la zone
            let erreurDePlacementGrave = false; // Item dans la mauvaise GRANDE cat√©gorie (Recette vs D√©pense)
            let erreurDeSousClassification = false; // Item dans la mauvaise SOUS-cat√©gorie (Prime Travail dans Social)

            // Calcul de la somme r√©elle pour la cat√©gorie, bas√©e sur les donn√©es initiales
            const itemsPourCategorie = items.filter(i => (globalCatName === 'recette' ? i.globalCat === 'recette' : i.cat === globalCatName) || (globalCatName !== 'recette' && i.globalCat === 'depense' && i.cat === globalCatName));
            const totalReelAttendu = itemsPourCategorie.reduce((a, b) => a + b.val, 0);

            // 2. V√âRIFICATION DU PLACEMENT DES √âL√âMENTS
            for (let zone of dropZones) {
                let expectedCat = zone.getAttribute("data-category");
                for (let item of zone.children) {
                    let itemVal = parseInt(item.getAttribute("data-val"));
                    let itemCat = item.getAttribute("data-cat"); 
                    let itemGlobalCat = item.getAttribute("data-global-cat"); 
                    
                    // a) V√âRIFICATION DES RECETTES (Sous-cat√©gorie stricte)
                    if (globalCatName === 'recette') {
                        if (itemGlobalCat !== 'recette') {
                            erreurDePlacementGrave = true; // Probl√®me majeur
                            item.style.border = "3px solid #dc3545"; 
                        } else if (itemCat !== expectedCat) {
                            erreurDeSousClassification = true; // Probl√®me mineur (Rouge)
                            item.style.border = "3px solid #dc3545"; 
                        } else {
                            sumItemsPlaces += itemVal;
                            item.style.border = "2px solid #28a745"; // Correct (Vert)
                        }
                    } 
                    // b) V√âRIFICATION DES D√âPENSES (Cat√©gorie stricte)
                    else {
                        if (itemGlobalCat === 'recette') {
                            erreurDePlacementGrave = true; // Probl√®me majeur
                            item.style.border = "3px solid #dc3545";
                        } else if (itemCat !== globalCatName) {
                            erreurDeSousClassification = true; // Probl√®me mineur (Rouge)
                            item.style.border = "3px solid #dc3545";
                        } else {
                            sumItemsPlaces += itemVal;
                            item.style.border = "2px solid #28a745"; // Correct (Vert)
                        }
                    }
                }
            }
            
            // R√©initialiser les bordures des items non valid√©s (qui n'ont pas √©t√© v√©rifi√©s dans la boucle ci-dessus)
            document.querySelectorAll('.draggable-item').forEach(item => {
                if (item.style.border !== "2px solid rgb(40, 167, 69)") {
                    item.style.border = "2px solid #555";
                }
            });


            // 3. AFFICHAGE DES MESSAGES ET D√âTERMINATION DU BLOCAGE
            if (erreurDePlacementGrave) {
                msg.innerHTML = "‚ùå **ERREUR MAJEURE :** Un poste est dans la mauvaise GRANDE cat√©gorie (Recette vs D√©pense). V√©rifiez la bordure rouge.";
                msg.className = "feedback-msg incorrect";
                return;
            }
            
            const itemsRestants = document.querySelectorAll('#item-bank .draggable-item').length;

            if (sumItemsPlaces !== totalReelAttendu || itemsRestants > 0) {
                // Manque un item OU item en trop
                let messageErreur = "";
                if (itemsRestants > 0) messageErreur = `‚ö†Ô∏è **CLASSEMENT INCOMPLET :** Il reste ${itemsRestants} poste(s) dans la banque d'items.`;
                else if (sumItemsPlaces > totalReelAttendu) messageErreur = `‚ö†Ô∏è **ITEM EN TROP :** Un poste de trop est dans cette colonne. Total attendu: **${totalReelAttendu} ‚Ç¨**.`;
                else if (sumItemsPlaces < totalReelAttendu) messageErreur = `‚ö†Ô∏è **ITEM MANQUANT :** Il manque un poste dans cette colonne. Total attendu: **${totalReelAttendu} ‚Ç¨**.`;

                msg.innerHTML = messageErreur;
                msg.className = "feedback-msg incorrect";
                return;
            }

            if (erreurDeSousClassification) {
                // Sous-cat√©gorie fausse (ex: Salaire dans Social) - Ne bloque pas le calcul mais alerte
                msg.innerHTML = "üü° **Attention :** Le classement est fonctionnel, mais une sous-cat√©gorie est incorrecte (voir les √©tiquettes rouges).";
                msg.className = "feedback-msg incorrect";
            }


            // 4. V√âRIFICATION DU CALCUL (Seulement si le classement est complet)
            let userVal = parseInt(input.value);
            
            if (isNaN(userVal)) {
                msg.innerHTML = "√âcrivez le total dans la case pour v√©rifier l'addition.";
                msg.className = "feedback-msg";
                return;
            }

            if (userVal === totalReelAttendu) {
                msg.innerHTML = "‚úÖ Bravo ! C'est juste." + (erreurDeSousClassification ? " (Veuillez corriger la sous-cat√©gorie en rouge pour finaliser.)" : "");
                msg.className = "feedback-msg correct";
                input.style.borderColor = "#28a745";
                input.style.backgroundColor = "#e8f5e9";
                input.disabled = true; 
                
                // Mise √† jour de la synth√®se finale
                if (globalCatName === 'recette') {
                    document.getElementById('final-recettes').value = userVal;
                } 
            } else {
                msg.innerHTML = "‚ùå Le calcul est faux. R√©essaie. Le total attendu est : **" + totalReelAttendu + " ‚Ç¨**";
                msg.className = "feedback-msg incorrect";
            }
        }

        function verifierBilan() {
            const r = parseInt(document.getElementById('final-recettes').value) || 0;
            const dFixe = parseInt(document.getElementById('input-fixes').value) || 0;
            const dCourante = parseInt(document.getElementById('input-courantes').value) || 0;
            const dOccas = parseInt(document.getElementById('input-occas').value) || 0;
            
            const totalDepensesCalcule = dFixe + dCourante + dOccas;

            const dFinalInput = parseInt(document.getElementById('final-depenses').value) || 0;
            const s = parseInt(document.getElementById('final-solde').value);
            const msg = document.getElementById('msg-bilan');

            let errors = [];

            // 1. V√©rifier si les totaux interm√©diaires ont √©t√© valid√©s
            if (document.getElementById('input-recettes').disabled === false || 
                document.getElementById('input-fixes').disabled === false ||
                document.getElementById('input-courantes').disabled === false ||
                document.getElementById('input-occas').disabled === false) {
                
                msg.innerHTML = "‚ö†Ô∏è V√©rifie et valide d'abord les 4 totaux de colonnes (Recettes, DF, DC, DO).";
                msg.className = "feedback-msg incorrect";
                return;
            }

            // 2. V√©rification des totaux report√©s
            if (r !== totalRecettesReelles) errors.push("Total Recettes report√© incorrect.");
            
            if (dFinalInput !== totalDepensesCalcule) {
                errors.push(`Total D√©penses report√© incorrect. Il doit √™tre la somme de ${totalDepensesCalcule} ‚Ç¨.`);
            } else if (dFinalInput !== totalDepensesReelles) {
                errors.push(`Total D√©penses incorrect (Total attendu : ${totalDepensesReelles} ‚Ç¨)`);
            }

            if (errors.length > 0) {
                msg.innerHTML = "‚ùå " + errors.join(" ");
                msg.className = "feedback-msg incorrect";
                return;
            }

            // 3. V√©rification du solde
            if (s === (r - dFinalInput)) {
                msg.innerHTML = "‚úÖ Excellent calcul ! Le solde est de " + soldeReel + " ‚Ç¨.";
                msg.className = "feedback-msg correct";
                document.getElementById('budget-status').style.opacity = "1";
                document.getElementById('budget-status').style.pointerEvents = "auto";
                document.getElementById('btn-conclusion').style.display = "inline-block";
            } else {
                msg.innerHTML = "‚ö†Ô∏è Solde faux. Fais : Recettes - D√©penses. (R√©sultat attendu : " + soldeReel + " ‚Ç¨)";
                msg.className = "feedback-msg incorrect";
            }
        }

        function verifierConclusion() {
            const radios = document.getElementsByName('budget');
            let selected;
            for(let radio of radios) { if(radio.checked) selected = radio.value; }
            
            const msg = document.getElementById('msg-conclusion');

            let correctStatus = "";
            if (soldeReel > 0) correctStatus = "exc√©dentaire";
            else if (soldeReel < 0) correctStatus = "d√©ficitaire";
            else correctStatus = "√©quilibr√©";

            if (selected === correctStatus) {
                msg.innerHTML = "üéâ BRAVO ! Tu as termin√© l'exercice avec succ√®s !";
                msg.className = "feedback-msg correct";
                msg.style.fontSize = "1.3rem";
                document.body.style.backgroundColor = "#e8f5e9";
            } else {
                msg.innerHTML = "Non. Regarde le signe de ton solde (" + soldeReel + " ‚Ç¨).";
                msg.className = "feedback-msg incorrect";
            }
        }

        // --- AUDIO GESTION (Play/Stop & Clean Text) ---
        let isSpeaking = false;
        
        function toggleAudio() {
            const btn = document.getElementById('main-audio-btn');
            
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                btn.classList.remove('playing');
                btn.innerHTML = '<span>‚ñ∂Ô∏è Lire l\'histoire</span>';
            } else {
                let text = document.getElementById('text-content').innerText;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                utterance.rate = 0.9;
                
                utterance.onend = function() {
                    isSpeaking = false;
                    btn.classList.remove('playing');
                    btn.innerHTML = '<span>‚ñ∂Ô∏è Lire l\'histoire</span>';
                };

                window.speechSynthesis.speak(utterance);
                isSpeaking = true;
                btn.classList.add('playing');
                btn.innerHTML = '<span>‚èπÔ∏è Arr√™ter</span>';
            }
        }
    </script>
</body>
</html>
