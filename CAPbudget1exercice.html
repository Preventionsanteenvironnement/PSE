<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PSE - Module D2 - Le Budget</title>
  <style>
    :root{
      --recettes-color:#d4edda;
      --recettes-border:#28a745;
      --fixe-color:#cce5ff;
      --fixe-border:#007bff;
      --courant-color:#fff3cd;
      --courant-border:#ffc107;
      --occas-color:#f8d7da;
      --occas-border:#dc3545;
      --bg-color:#f9f9f9;
      --text-color:#333;

      --recette-travail:#a2d9c2;
      --recette-social:#7fc3af;
      --recette-autre:#55aa99;

      --ok:#28a745;
      --ko:#dc3545;
      --warn:#ff9800;
    }

    *{box-sizing:border-box}

    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background-color:var(--bg-color);
      color:var(--text-color);
      margin:0;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    /* ===== PAGE D'INTRODUCTION ===== */
    #intro-page{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height:80vh;
      text-align:center;
      padding:30px 20px;
      max-width:700px;
    }

    #intro-page h1{
      color:#2c3e50;
      font-size:1.4rem;
      margin-bottom:8px;
      font-weight:600;
    }

    #intro-page h2{
      color:#34495e;
      font-size:1.2rem;
      margin-bottom:8px;
      font-weight:500;
    }

    #intro-page h3{
      color:#007bff;
      font-size:1.3rem;
      margin-bottom:30px;
      font-weight:600;
    }

    .objectif-box{
      background:#fff;
      border-left:5px solid #007bff;
      padding:20px 25px;
      margin:20px 0 40px 0;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      text-align:left;
      line-height:1.7;
    }

    .objectif-box strong{
      display:block;
      margin-bottom:10px;
      color:#2c3e50;
    }

    #btn-demarrer{
      background:linear-gradient(135deg,#007bff,#0056b3);
      color:#fff;
      border:none;
      padding:16px 40px;
      border-radius:50px;
      font-size:1.2rem;
      font-weight:600;
      cursor:pointer;
      transition:transform .2s, box-shadow .2s;
      box-shadow:0 4px 15px rgba(0,123,255,.3);
    }

    #btn-demarrer:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(0,123,255,.4);
    }

    #btn-demarrer:active{
      transform:translateY(0);
    }

    /* ===== CONTENU EXERCICE (cach√© au d√©part) ===== */
    #exercice-content{
      display:none;
      width:100%;
      flex-direction:column;
      align-items:center;
    }

    h1{color:#2c3e50;margin-bottom:10px}

    .legend-bar{
      display:flex;
      gap:15px;
      font-size:.95rem;
      margin-bottom:10px;
      background:#fff;
      padding:10px 16px;
      border-radius:50px;
      border:1px solid #ddd;
      flex-wrap:wrap;
      justify-content:center;
      text-align:center;
    }

    .context-box{
      background:#fff;
      padding:20px;
      border-radius:15px;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      max-width:900px;
      width:100%;
      margin-bottom:20px;
      line-height:1.8;
      font-size:1.15rem;
      position:relative;
    }

    .audio-btn{
      background-color:#6c757d;
      color:#fff;
      border:none;
      padding:8px 16px;
      border-radius:50px;
      cursor:pointer;
      font-size:1rem;
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-bottom:15px;
      transition:background .2s;
    }
    .audio-btn:hover{background-color:#5a6268}
    .audio-btn.playing{background-color:#dc3545}

    #item-bank{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      background:#fff;
      padding:15px;
      border-radius:10px;
      min-height:80px;
      width:100%;
      max-width:1000px;
      margin-bottom:20px;
      border:2px dashed #ccc;
    }

    .draggable-item{
      padding:10px 20px;
      background:#fff;
      border:2px solid #555;
      border-radius:8px;
      cursor:grab;
      user-select:none;
      font-weight:bold;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
      transition:transform .2s, background-color .2s, border-color .2s;
      outline:none;
      -webkit-touch-callout:none;
      touch-action:none;
    }
    .draggable-item:active{cursor:grabbing;transform:scale(1.05)}
    .draggable-item.is-selected{background:#e2e6ea;border-color:#007bff}
    .draggable-item.item-ok{border-color:var(--ok)}
    .draggable-item.item-ko{border:3px solid var(--ko)}
    .draggable-item.item-warn{border:3px solid var(--warn)}

    .budget-container{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:15px;
      width:100%;
      max-width:1200px;
    }

    .column{
      background:#fff;
      border-radius:10px;
      padding:10px;
      display:flex;
      flex-direction:column;
      min-height:400px;
      border-top:6px solid #ccc;
    }

    .column h3{
      text-align:center;
      margin-top:0;
      padding-bottom:10px;
      border-bottom:1px solid #eee;
      font-size:1.1rem;
    }

    #col-recettes{
      grid-column:span 1;
      border-top-color:var(--recettes-border);
      display:grid;
      grid-template-rows:auto 1fr auto;
    }
    #col-recettes h3{margin-bottom:10px}

    .recette-sub-zones{
      display:flex;
      flex-direction:column;
      gap:5px;
      flex-grow:1;
      padding-bottom:10px;
      border-bottom:1px solid #ccc;
    }

    .sub-zone{
      flex-grow:1;
      padding:8px;
      border-radius:5px;
      margin-bottom:5px;
      min-height:80px;
    }
    .sub-zone h4{
      font-size:.9rem;
      font-weight:bold;
      color:#2c3e50;
      margin:0 0 5px 0;
      padding-bottom:3px;
      border-bottom:1px dashed #fff;
    }

    .sub-zone[data-category="recette-travail"]{background-color:var(--recette-travail)}
    .sub-zone[data-category="recette-social"]{background-color:var(--recette-social)}
    .sub-zone[data-category="recette-autre"]{background-color:var(--recette-autre)}

    .drop-zone{
      flex-grow:1;
      padding:10px;
      border-radius:5px;
      background-color:rgba(0,0,0,.02);
      transition:background .2s;
      min-height:80px;
    }
    .drop-zone.drag-over{background-color:rgba(0,0,0,.1)}

    #col-fixes{border-top-color:var(--fixe-border)}
    #col-fixes .drop-zone{background-color:var(--fixe-color)}

    #col-courantes{border-top-color:var(--courant-border)}
    #col-courantes .drop-zone{background-color:var(--courant-color)}

    #col-occas{border-top-color:var(--occas-border)}
    #col-occas .drop-zone{background-color:var(--occas-color)}

    .calc-zone{
      margin-top:10px;
      padding-top:10px;
      border-top:2px solid #eee;
      text-align:center;
    }

    /* Champs de saisie - type text pour meilleure compatibilit√© */
    input.number-input{
      width:110px;
      padding:8px;
      font-size:1.1rem;
      border:2px solid #ccc;
      border-radius:5px;
      text-align:right;
      margin-bottom:5px;
      -webkit-appearance:none;
      -moz-appearance:textfield;
    }

    input.number-input:focus{
      outline:none;
      border-color:#007bff;
    }

    .verify-btn{
      background-color:#17a2b8;
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:5px;
      cursor:pointer;
      font-size:1rem;
      margin-top:5px;
    }
    .verify-btn:hover{background-color:#138496}

    .feedback-msg{
      display:block;
      font-size:.95rem;
      margin-top:8px;
      font-weight:bold;
      min-height:1.2em;
      line-height:1.4;
    }
    .correct{color:var(--ok)}
    .incorrect{color:var(--ko)}
    .info{color:#6c757d;font-weight:normal}

    .final-synthesis{
      margin-top:40px;
      background:#fff;
      padding:30px;
      border-radius:15px;
      width:100%;
      max-width:800px;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      border-left:10px solid #2c3e50;
    }

    .synthesis-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:15px;
      font-size:1.2rem;
      gap:10px;
      flex-wrap:wrap;
    }

    .result-options{
      display:flex;
      gap:15px;
      justify-content:center;
      margin-top:25px;
      flex-wrap:wrap;
    }

    .result-options label{
      cursor:pointer;
      padding:12px 20px;
      background:#f1f3f5;
      border-radius:50px;
      border:2px solid transparent;
      transition:.2s;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }

    .result-options input{display:none}

    .result-options label.selected{
      border-color:#007bff;
      background-color:#e7f1ff;
    }
    .result-options label.selected span{
      font-weight:bold;
      color:#007bff;
    }

    /* ===== CALCULATRICE FLOTTANTE ===== */
    #calc-toggle{
      position:fixed;
      bottom:20px;
      right:20px;
      width:50px;
      height:50px;
      border-radius:50%;
      background:linear-gradient(135deg,#6c757d,#495057);
      color:#fff;
      border:none;
      font-size:1.4rem;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.25);
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform .2s;
    }
    #calc-toggle:hover{transform:scale(1.1)}

    #calculator{
      display:none;
      position:fixed;
      bottom:80px;
      right:20px;
      width:220px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 5px 25px rgba(0,0,0,.2);
      z-index:1001;
      overflow:hidden;
    }

    #calculator.open{display:block}

    #calc-header{
      background:#495057;
      color:#fff;
      padding:10px 15px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
      font-size:.9rem;
    }

    #calc-close{
      background:none;
      border:none;
      color:#fff;
      font-size:1.2rem;
      cursor:pointer;
      padding:0;
      line-height:1;
    }

    #calc-display{
      width:100%;
      padding:15px;
      font-size:1.5rem;
      text-align:right;
      border:none;
      border-bottom:1px solid #eee;
      background:#f8f9fa;
      font-family:monospace;
    }

    #calc-buttons{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:1px;
      background:#ddd;
    }

    .calc-btn{
      padding:15px;
      font-size:1.1rem;
      border:none;
      background:#fff;
      cursor:pointer;
      transition:background .1s;
    }

    .calc-btn:hover{background:#e9ecef}
    .calc-btn:active{background:#dee2e6}

    .calc-btn.operator{background:#e7f1ff;color:#007bff;font-weight:bold}
    .calc-btn.operator:hover{background:#cce0ff}

    .calc-btn.equals{background:#007bff;color:#fff;font-weight:bold}
    .calc-btn.equals:hover{background:#0056b3}

    .calc-btn.clear{background:#f8d7da;color:#dc3545}
    .calc-btn.clear:hover{background:#f1b0b7}

    /* ===== RESPONSIVE ===== */
    @media (max-width:900px){
      .budget-container{grid-template-columns:1fr 1fr}
      .column{margin-bottom:20px}
      #col-recettes{grid-column:span 2}
    }

    @media (max-width:600px){
      body{padding:10px}
      
      .budget-container{grid-template-columns:1fr}
      #col-recettes{grid-column:span 1}
      .column{min-height:300px}
      
      .context-box{padding:15px;font-size:1rem;line-height:1.6}
      
      .draggable-item{padding:8px 14px;font-size:.9rem}
      
      input.number-input{width:90px;font-size:1rem;padding:6px}
      
      .synthesis-row{font-size:1rem;flex-direction:column;align-items:flex-start}
      .synthesis-row input{width:100%;max-width:150px}
      
      .final-synthesis{padding:20px}
      
      #calculator{
        right:10px;
        bottom:75px;
        width:200px;
      }
      
      #calc-toggle{
        bottom:15px;
        right:15px;
        width:45px;
        height:45px;
        font-size:1.2rem;
      }
      
      .calc-btn{padding:12px;font-size:1rem}
      #calc-display{font-size:1.3rem;padding:12px}
      
      .result-options{gap:10px}
      .result-options label{padding:10px 15px;font-size:.95rem}
      
      #intro-page{padding:20px 15px;min-height:70vh}
      #intro-page h1{font-size:1.2rem}
      #intro-page h2{font-size:1rem}
      #intro-page h3{font-size:1.1rem}
      .objectif-box{padding:15px;font-size:.95rem}
      #btn-demarrer{padding:14px 30px;font-size:1.1rem}
    }

    /* Assurer le scroll fluide sur mobile */
    @supports (-webkit-overflow-scrolling: touch) {
      body{-webkit-overflow-scrolling:touch}
    }
  </style>
</head>
<body>

  <!-- ===== PAGE D'INTRODUCTION ===== -->
  <div id="intro-page">
    <h1>PSE ‚Äì Th√©matique D</h1>
    <h2>L'individu consommateur averti</h2>
    <h3>Module D2 ‚Äì Le budget</h3>
    
    <div class="objectif-box">
      <strong>Objectif g√©n√©ral :</strong>
      Je dois √™tre capable de g√©rer mon budget et de prendre les bonnes d√©cisions face aux propositions de cr√©dit afin d'adopter une attitude responsable et d'√©viter le surendettement.
    </div>
    
    <button id="btn-demarrer">D√©marrer l'exercice</button>
  </div>

  <!-- ===== CONTENU DE L'EXERCICE ===== -->
  <div id="exercice-content">
    <h1>üí∞ Le Budget de Lucas - Challenge !</h1>

    <div class="legend-bar">
      <span>Objectif : Identifier si c'est une <strong>Recette</strong> ou une <strong>D√©pense</strong>, puis classer la nature exacte.</span>
    </div>

    <div class="context-box">
      <button id="main-audio-btn" class="audio-btn">
        <span>‚ñ∂Ô∏è Lire l'histoire</span>
      </button>

      <div id="text-content">
        Lucas, √©tudiant en alternance et jeune papa, essaie de faire ses comptes. Chaque mois, il re√ßoit son <strong>salaire de 1 600 ‚Ç¨</strong>. Il a √©galement re√ßu une <strong>prime exceptionnelle de 150 ‚Ç¨</strong> pour un projet r√©ussi au travail.<br><br>

        Au niveau des aides, il touche les <strong>APL de 280 ‚Ç¨</strong> et les <strong>allocations familiales de 130 ‚Ç¨</strong>.<br>

        Ce mois-ci, il a vendu une vieille console de jeux pour <strong>100 ‚Ç¨</strong> sur internet.
        <hr>
        Ses charges r√©currentes : Loyer (650 ‚Ç¨), Remboursement de pr√™t √©tudiant (85 ‚Ç¨), Assurance auto (40 ‚Ç¨), Abonnements (streaming, jeux : 35 ‚Ç¨).<br>

        Ses d√©penses courantes : Courses alimentaires (300 ‚Ç¨), Essence (120 ‚Ç¨), √âlectricit√© / Gaz (100 ‚Ç¨), Forfait t√©l√©phone (15 ‚Ç¨).<br><br>

        Pour le b√©b√©, il a achet√© un si√®ge auto neuf (150 ‚Ç¨). Il est sorti deux fois au restaurant avec sa femme (80 ‚Ç¨ au total) et a d√ª payer une consultation chez le dentiste (45 ‚Ç¨) qui n'√©tait pas enti√®rement rembours√©e.
      </div>
    </div>

    <div style="width:100%; max-width:1000px; text-align:left; margin-bottom:5px; font-size:1.1rem;">
      <strong>1. Classe les √©tiquettes dans leur nature (Recette, D√©pense Fixe, Courante, Occasionnelle) :</strong>
    </div>

    <div id="item-bank" data-category="bank" aria-label="Banque d'√©tiquettes"></div>

    <div class="budget-container">
      <div class="column" id="col-recettes">
        <h3>Recettes</h3>
        <div class="recette-sub-zones">
          <div class="sub-zone drop-zone" data-category="recette-travail">
            <h4>Travail (Salaire, Prime)</h4>
          </div>
          <div class="sub-zone drop-zone" data-category="recette-social">
            <h4>Social (Aides, Allocations)</h4>
          </div>
          <div class="sub-zone drop-zone" data-category="recette-autre">
            <h4>Autre (Vente, Cadeau...)</h4>
          </div>
        </div>
        <div class="calc-zone">
          <label>Total Recettes : </label>
          <input type="text" inputmode="decimal" class="number-input" id="input-recettes" placeholder="?" autocomplete="off"> ‚Ç¨
          <br>
          <button class="verify-btn" data-verify="recette">V√©rifier</button>
          <span id="msg-recettes" class="feedback-msg"></span>
        </div>
      </div>

      <div class="column" id="col-fixes">
        <h3>D√©penses Fixes</h3>
        <div class="drop-zone" data-category="fixe"></div>
        <div class="calc-zone">
          <label>Total : </label>
          <input type="text" inputmode="decimal" class="number-input" id="input-fixes" placeholder="?" autocomplete="off"> ‚Ç¨
          <br>
          <button class="verify-btn" data-verify="fixe">V√©rifier</button>
          <span id="msg-fixes" class="feedback-msg"></span>
        </div>
      </div>

      <div class="column" id="col-courantes">
        <h3>D√©penses Courantes</h3>
        <div class="drop-zone" data-category="courante"></div>
        <div class="calc-zone">
          <label>Total : </label>
          <input type="text" inputmode="decimal" class="number-input" id="input-courantes" placeholder="?" autocomplete="off"> ‚Ç¨
          <br>
          <button class="verify-btn" data-verify="courante">V√©rifier</button>
          <span id="msg-courantes" class="feedback-msg"></span>
        </div>
      </div>

      <div class="column" id="col-occas">
        <h3>D√©penses Occas.</h3>
        <div class="drop-zone" data-category="occas"></div>
        <div class="calc-zone">
          <label>Total : </label>
          <input type="text" inputmode="decimal" class="number-input" id="input-occas" placeholder="?" autocomplete="off"> ‚Ç¨
          <br>
          <button class="verify-btn" data-verify="occas">V√©rifier</button>
          <span id="msg-occas" class="feedback-msg"></span>
        </div>
      </div>
    </div>

    <div class="final-synthesis">
      <h2>üìä Le Bilan</h2>
      <p>Reporte tes totaux pour calculer le solde.</p>

      <div class="synthesis-row">
        <span>Total des Recettes :</span>
        <span><input type="text" inputmode="decimal" class="number-input" id="final-recettes" placeholder="..." autocomplete="off"> ‚Ç¨</span>
      </div>
      <div class="synthesis-row">
        <span>Total des D√©penses :</span>
        <span><input type="text" inputmode="decimal" class="number-input" id="final-depenses" placeholder="..." autocomplete="off"> ‚Ç¨</span>
      </div>
      <hr>
      <div class="synthesis-row" style="font-weight:bold;font-size:1.4rem;">
        <span>SOLDE (Recettes - D√©penses) :</span>
        <span><input type="text" inputmode="decimal" class="number-input" id="final-solde" placeholder="..." autocomplete="off"> ‚Ç¨</span>
      </div>

      <div style="text-align:center;margin-top:10px;">
        <button class="verify-btn" id="btn-bilan" style="font-size:1.1rem;padding:10px 20px;">V√©rifier le Solde</button>
        <div id="msg-bilan" class="feedback-msg" style="font-size:1.1rem;margin-top:10px;"></div>
      </div>

      <div class="result-options" id="budget-status" style="opacity:.3; pointer-events:none;">
        <p style="width:100%; text-align:center; margin-bottom:10px;">Le budget est :</p>
        <label>
          <input type="radio" name="budget" value="exc√©dentaire">
          <span>Exc√©dentaire (+)</span>
        </label>
        <label>
          <input type="radio" name="budget" value="d√©ficitaire">
          <span>D√©ficitaire (-)</span>
        </label>
        <label>
          <input type="radio" name="budget" value="√©quilibr√©">
          <span>√âquilibr√© (=)</span>
        </label>
      </div>

      <div style="text-align:center;margin-top:20px;">
        <button class="verify-btn" id="btn-conclusion" style="display:none;padding:10px 25px;">V√©rifier la r√©ponse</button>
        <div id="msg-conclusion" class="feedback-msg"></div>
      </div>
    </div>
  </div>

  <!-- ===== CALCULATRICE FLOTTANTE ===== -->
  <button id="calc-toggle" title="Calculatrice">üßÆ</button>
  
  <div id="calculator">
    <div id="calc-header">
      <span>Calculatrice</span>
      <button id="calc-close" title="Fermer">√ó</button>
    </div>
    <input type="text" id="calc-display" readonly value="0">
    <div id="calc-buttons">
      <button class="calc-btn clear" data-action="clear">C</button>
      <button class="calc-btn" data-action="backspace">‚å´</button>
      <button class="calc-btn operator" data-action="operator" data-value="/">√∑</button>
      <button class="calc-btn operator" data-action="operator" data-value="*">√ó</button>
      
      <button class="calc-btn" data-action="number" data-value="7">7</button>
      <button class="calc-btn" data-action="number" data-value="8">8</button>
      <button class="calc-btn" data-action="number" data-value="9">9</button>
      <button class="calc-btn operator" data-action="operator" data-value="-">‚àí</button>
      
      <button class="calc-btn" data-action="number" data-value="4">4</button>
      <button class="calc-btn" data-action="number" data-value="5">5</button>
      <button class="calc-btn" data-action="number" data-value="6">6</button>
      <button class="calc-btn operator" data-action="operator" data-value="+">+</button>
      
      <button class="calc-btn" data-action="number" data-value="1">1</button>
      <button class="calc-btn" data-action="number" data-value="2">2</button>
      <button class="calc-btn" data-action="number" data-value="3">3</button>
      <button class="calc-btn equals" data-action="equals" style="grid-row:span 2">=</button>
      
      <button class="calc-btn" data-action="number" data-value="0" style="grid-column:span 2">0</button>
      <button class="calc-btn" data-action="decimal">,</button>
    </div>
  </div>

  <script>
    // ===== GESTION DE LA PAGE D'INTRODUCTION =====
    document.getElementById('btn-demarrer').addEventListener('click', function() {
      document.getElementById('intro-page').style.display = 'none';
      document.getElementById('exercice-content').style.display = 'flex';
      document.getElementById('calc-toggle').style.display = 'flex';
    });

    // Cacher la calculatrice au d√©part
    document.getElementById('calc-toggle').style.display = 'none';

    // ===== CALCULATRICE =====
    const calcToggle = document.getElementById('calc-toggle');
    const calculator = document.getElementById('calculator');
    const calcClose = document.getElementById('calc-close');
    const calcDisplay = document.getElementById('calc-display');
    const calcButtons = document.getElementById('calc-buttons');

    let calcCurrentValue = '0';
    let calcPreviousValue = '';
    let calcOperator = null;
    let calcWaitingForOperand = false;

    calcToggle.addEventListener('click', () => {
      calculator.classList.toggle('open');
    });

    calcClose.addEventListener('click', () => {
      calculator.classList.remove('open');
    });

    calcButtons.addEventListener('click', (e) => {
      const btn = e.target.closest('.calc-btn');
      if (!btn) return;

      const action = btn.dataset.action;
      const value = btn.dataset.value;

      switch(action) {
        case 'number':
          inputNumber(value);
          break;
        case 'operator':
          inputOperator(value);
          break;
        case 'decimal':
          inputDecimal();
          break;
        case 'equals':
          performCalculation();
          break;
        case 'clear':
          clearCalculator();
          break;
        case 'backspace':
          backspace();
          break;
      }
      updateDisplay();
    });

    function inputNumber(num) {
      if (calcWaitingForOperand) {
        calcCurrentValue = num;
        calcWaitingForOperand = false;
      } else {
        calcCurrentValue = calcCurrentValue === '0' ? num : calcCurrentValue + num;
      }
    }

    function inputDecimal() {
      if (calcWaitingForOperand) {
        calcCurrentValue = '0.';
        calcWaitingForOperand = false;
        return;
      }
      if (!calcCurrentValue.includes('.')) {
        calcCurrentValue += '.';
      }
    }

    function inputOperator(op) {
      const inputValue = parseFloat(calcCurrentValue);

      if (calcPreviousValue === '') {
        calcPreviousValue = inputValue;
      } else if (calcOperator) {
        const result = calculate(calcPreviousValue, inputValue, calcOperator);
        calcCurrentValue = String(result);
        calcPreviousValue = result;
      }

      calcWaitingForOperand = true;
      calcOperator = op;
    }

    function calculate(prev, current, op) {
      switch(op) {
        case '+': return prev + current;
        case '-': return prev - current;
        case '*': return prev * current;
        case '/': return current !== 0 ? prev / current : 'Erreur';
        default: return current;
      }
    }

    function performCalculation() {
      if (calcOperator === null || calcWaitingForOperand) return;

      const inputValue = parseFloat(calcCurrentValue);
      const result = calculate(calcPreviousValue, inputValue, calcOperator);

      calcCurrentValue = String(result);
      calcPreviousValue = '';
      calcOperator = null;
      calcWaitingForOperand = true;
    }

    function clearCalculator() {
      calcCurrentValue = '0';
      calcPreviousValue = '';
      calcOperator = null;
      calcWaitingForOperand = false;
    }

    function backspace() {
      if (calcWaitingForOperand) return;
      calcCurrentValue = calcCurrentValue.length > 1 ? calcCurrentValue.slice(0, -1) : '0';
    }

    function updateDisplay() {
      // Afficher avec virgule pour les francophones
      let displayValue = calcCurrentValue;
      if (typeof displayValue === 'string') {
        displayValue = displayValue.replace('.', ',');
      }
      // Limiter la longueur d'affichage
      if (displayValue.length > 12) {
        displayValue = parseFloat(calcCurrentValue).toExponential(6);
      }
      calcDisplay.value = displayValue;
    }

    // ===== FONCTION DE NORMALISATION DES SAISIES NUM√âRIQUES =====
    function normalizeNumber(input) {
      if (input === null || input === undefined) return NaN;
      
      let str = String(input).trim();
      
      // Supprimer le symbole ‚Ç¨
      str = str.replace(/‚Ç¨/g, '');
      
      // Supprimer tous les espaces (normaux et ins√©cables)
      str = str.replace(/[\s\u00A0\u202F]/g, '');
      
      // Remplacer la virgule par un point
      str = str.replace(/,/g, '.');
      
      // G√©rer plusieurs points (garder seulement le premier)
      const parts = str.split('.');
      if (parts.length > 2) {
        str = parts[0] + '.' + parts.slice(1).join('');
      }
      
      // Convertir en nombre
      const num = parseFloat(str);
      
      return num;
    }

    // ===== FONCTION DE D√âTECTION DU TYPE D'ERREUR =====
    function analyzeInputError(rawInput, expectedValue) {
      const normalized = normalizeNumber(rawInput);
      
      // Champ vide
      if (rawInput === null || rawInput === undefined || String(rawInput).trim() === '') {
        return { type: 'empty', message: null };
      }
      
      // Erreur de format (caract√®res invalides)
      const cleanedForCheck = String(rawInput).replace(/[\s\u00A0\u202F‚Ç¨,.\-]/g, '');
      if (!/^\d*$/.test(cleanedForCheck)) {
        return { 
          type: 'format', 
          message: '‚ö†Ô∏è <strong>Erreur de saisie :</strong> Utilise uniquement des chiffres. Tu peux ajouter une virgule ou un point pour les d√©cimales.'
        };
      }
      
      // Valeur non convertible
      if (isNaN(normalized)) {
        return { 
          type: 'format', 
          message: '‚ö†Ô∏è <strong>Erreur de saisie :</strong> Ce format n\'est pas reconnu. √âcris simplement le nombre (ex : 1620 ou 1620,50).'
        };
      }
      
      // Valeur correcte
      if (Math.abs(normalized - expectedValue) < 0.01) {
        return { type: 'correct', message: null };
      }
      
      // Erreur de calcul (proche mais pas exact - dans les 20%)
      const diff = Math.abs(normalized - expectedValue);
      const percentDiff = (diff / expectedValue) * 100;
      
      if (percentDiff <= 20) {
        return { 
          type: 'calcul', 
          message: `‚ùå <strong>Erreur de calcul :</strong> Ton r√©sultat (${normalized} ‚Ç¨) est proche mais pas exact. V√©rifie ton addition.`
        };
      }
      
      // Erreur de raisonnement (valeur tr√®s diff√©rente)
      return { 
        type: 'raisonnement', 
        message: `‚ùå <strong>Erreur de raisonnement :</strong> Ton r√©sultat (${normalized} ‚Ç¨) est √©loign√© du total attendu. As-tu class√© tous les √©l√©ments et additionn√© les bons montants ?`
      };
    }

    // ===== DONN√âES DE L'EXERCICE =====
    const itemsData = [
      { id: 1,  name: "Salaire",                     val: 1600, cat: "recette-travail", globalCat: "recette" },
      { id: 2,  name: "Prime Travail",               val: 150,  cat: "recette-travail", globalCat: "recette" },
      { id: 3,  name: "APL",                         val: 280,  cat: "recette-social",  globalCat: "recette" },
      { id: 4,  name: "Allocations Familiales",      val: 130,  cat: "recette-social",  globalCat: "recette" },
      { id: 5,  name: "Vente Console",               val: 100,  cat: "recette-autre",   globalCat: "recette" },

      { id: 6,  name: "Loyer",                       val: 650,  cat: "fixe",            globalCat: "depense" },
      { id: 7,  name: "Pr√™t √âtudiant",               val: 85,   cat: "fixe",            globalCat: "depense" },
      { id: 8,  name: "Assurance Auto",              val: 40,   cat: "fixe",            globalCat: "depense" },
      { id: 9,  name: "Abonnements",                 val: 35,   cat: "fixe",            globalCat: "depense" },

      { id: 10, name: "Courses Alim.",               val: 300,  cat: "courante",        globalCat: "depense" },
      { id: 11, name: "Essence",                     val: 120,  cat: "courante",        globalCat: "depense" },
      { id: 12, name: "√âlectricit√© / Gaz",           val: 100,  cat: "courante",        globalCat: "depense" },
      { id: 13, name: "Forfait T√©l√©phone",           val: 15,   cat: "courante",        globalCat: "depense" },

      { id: 14, name: "Si√®ge Auto",                  val: 150,  cat: "occas",           globalCat: "depense" },
      { id: 15, name: "Restaurant",                  val: 80,   cat: "occas",           globalCat: "depense" },
      { id: 16, name: "Dentiste (reste √† charge)",   val: 45,   cat: "occas",           globalCat: "depense" }
    ];

    const totalsExpected = {
      recettes: itemsData.filter(i => i.globalCat === "recette").reduce((a,b)=>a+b.val,0),
      fixe:     itemsData.filter(i => i.globalCat === "depense" && i.cat === "fixe").reduce((a,b)=>a+b.val,0),
      courante: itemsData.filter(i => i.globalCat === "depense" && i.cat === "courante").reduce((a,b)=>a+b.val,0),
      occas:    itemsData.filter(i => i.globalCat === "depense" && i.cat === "occas").reduce((a,b)=>a+b.val,0)
    };

    const totalDepensesReelles = totalsExpected.fixe + totalsExpected.courante + totalsExpected.occas;
    const soldeReel = totalsExpected.recettes - totalDepensesReelles;

    // ===== CR√âATION DES √âTIQUETTES =====
    const bank = document.getElementById("item-bank");
    const shuffled = [...itemsData].sort(() => Math.random() - 0.5);

    shuffled.forEach(item => {
      const el = document.createElement("div");
      el.className = "draggable-item";
      el.draggable = true;
      el.id = "item-" + item.id;

      el.dataset.val = item.val;
      el.dataset.cat = item.cat;
      el.dataset.globalCat = item.globalCat;

      el.tabIndex = 0;
      el.textContent = `${item.name} (${item.val} ‚Ç¨)`;

      el.addEventListener("dragstart", onDragStart);
      el.addEventListener("click", () => selectItem(el));
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          selectItem(el);
        }
      });

      // Support tactile
      el.addEventListener("touchstart", onTouchStart, { passive: false });
      el.addEventListener("touchmove", onTouchMove, { passive: false });
      el.addEventListener("touchend", onTouchEnd);

      bank.appendChild(el);
    });

    let selectedItem = null;
    let touchedItem = null;
    let touchStartX = 0;
    let touchStartY = 0;

    function clearSelection(){
      if(!selectedItem) return;
      selectedItem.classList.remove("is-selected");
      selectedItem = null;
    }

    function selectItem(el){
      if(selectedItem === el){
        clearSelection();
        return;
      }
      clearSelection();
      selectedItem = el;
      el.classList.add("is-selected");
    }

    function onDragStart(ev){
      const el = ev.currentTarget;
      ev.dataTransfer.setData("text/plain", el.id);
      selectItem(el);
    }

    function onDragOver(ev){
      ev.preventDefault();
      ev.currentTarget.classList.add("drag-over");
    }

    function onDragLeave(ev){
      ev.currentTarget.classList.remove("drag-over");
    }

    function appendItemToZone(zone, el){
      zone.appendChild(el);
      clearSelection();
      el.focus();
    }

    function onDrop(ev){
      ev.preventDefault();
      const zone = ev.currentTarget;
      zone.classList.remove("drag-over");

      const id = ev.dataTransfer.getData("text/plain");
      const dragged = id ? document.getElementById(id) : null;
      const el = dragged || selectedItem;
      if(!el) return;

      appendItemToZone(zone, el);
    }

    function onZoneClick(ev){
      const zone = ev.currentTarget;
      if(!selectedItem) return;
      if(ev.target.closest(".draggable-item")) return;
      appendItemToZone(zone, selectedItem);
    }

    // ===== SUPPORT TACTILE AM√âLIOR√â =====
    function onTouchStart(ev) {
      const touch = ev.touches[0];
      touchedItem = ev.currentTarget;
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      selectItem(touchedItem);
    }

    function onTouchMove(ev) {
      if (!touchedItem) return;
      ev.preventDefault();
    }

    function onTouchEnd(ev) {
      if (!touchedItem) return;
      
      const touch = ev.changedTouches[0];
      const endX = touch.clientX;
      const endY = touch.clientY;
      
      // V√©rifier si c'est un tap (pas de mouvement significatif)
      const deltaX = Math.abs(endX - touchStartX);
      const deltaY = Math.abs(endY - touchStartY);
      
      if (deltaX < 10 && deltaY < 10) {
        // C'est un tap, garder la s√©lection
        touchedItem = null;
        return;
      }
      
      // Trouver la zone sous le point de rel√¢chement
      const elementsUnder = document.elementsFromPoint(endX, endY);
      const targetZone = elementsUnder.find(el => 
        el.classList.contains('drop-zone') || el.id === 'item-bank'
      );
      
      if (targetZone && touchedItem) {
        appendItemToZone(targetZone, touchedItem);
      }
      
      touchedItem = null;
    }

    const allZones = [ bank, ...document.querySelectorAll(".drop-zone") ];
    allZones.forEach(zone => {
      zone.addEventListener("dragover", onDragOver);
      zone.addEventListener("dragleave", onDragLeave);
      zone.addEventListener("drop", onDrop);
      zone.addEventListener("click", onZoneClick);
    });

    // ===== FONCTIONS DE MARQUAGE =====
    function resetItemMarks(){
      document.querySelectorAll(".draggable-item").forEach(el => {
        el.classList.remove("item-ok","item-ko","item-warn");
      });
    }
    function markOk(el){ el.classList.add("item-ok"); }
    function markKo(el){ el.classList.add("item-ko"); }
    function markWarn(el){ el.classList.add("item-warn"); }

    function setMsg(msgEl, html, ok){
      msgEl.innerHTML = html;
      msgEl.className = "feedback-msg " + (ok ? "correct" : "incorrect");
      
      // Scroll vers le message sur mobile
      if (window.innerWidth <= 600) {
        setTimeout(() => {
          msgEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }

    function isInRecetteArea(el){
      const p = el.parentElement;
      return p && p.classList.contains("sub-zone") && (p.dataset.category || "").startsWith("recette-");
    }

    function getItemElById(id){ return document.getElementById("item-" + id); }

    // ===== V√âRIFICATION DES RECETTES =====
    function verifierRecettes(){
      resetItemMarks();

      const msg = document.getElementById("msg-recettes");
      const input = document.getElementById("input-recettes");

      const recetteZones = [...document.querySelectorAll('.sub-zone[data-category^="recette-"]')];

      let majorError = false;
      recetteZones.forEach(zone => {
        [...zone.querySelectorAll(":scope > .draggable-item")].forEach(el => {
          if(el.dataset.globalCat !== "recette"){
            majorError = true;
            markKo(el);
          }
        });
      });
      if(majorError){
        setMsg(msg, "‚ùå <strong>ERREUR MAJEURE :</strong> Une d√©pense a √©t√© plac√©e dans les Recettes. Corrige les √©tiquettes en rouge.", false);
        return;
      }

      const recetteItems = itemsData.filter(i => i.globalCat === "recette");
      const missing = [];
      let warnSub = false;

      recetteItems.forEach(it => {
        const el = getItemElById(it.id);
        if(!el) return;
        if(!isInRecetteArea(el)){
          missing.push(it.name);
          markKo(el);
          return;
        }
        const currentZoneCat = el.parentElement.dataset.category;
        if(currentZoneCat !== it.cat){
          warnSub = true;
          markWarn(el);
        }else{
          markOk(el);
        }
      });

      if(missing.length){
        setMsg(msg, `‚ö†Ô∏è <strong>CLASSEMENT INCOMPLET :</strong> Il manque ${missing.length} recette(s) dans la zone Recettes.`, false);
        return;
      }

      // Utiliser la normalisation pour la saisie
      const rawValue = input.value;
      const analysis = analyzeInputError(rawValue, totalsExpected.recettes);
      
      if (analysis.type === 'empty') {
        msg.innerHTML = "√âcris le total des Recettes dans la case, puis clique sur V√©rifier.";
        msg.className = "feedback-msg info";
        return;
      }
      
      if (analysis.type === 'format') {
        setMsg(msg, analysis.message, false);
        return;
      }
      
      if (analysis.type !== 'correct') {
        setMsg(msg, `‚ùå Le calcul est incorrect. Total attendu : <strong>${totalsExpected.recettes} ‚Ç¨</strong>.`, false);
        return;
      }

      input.dataset.validated = "true";
      document.getElementById("final-recettes").value = totalsExpected.recettes;

      if(warnSub){
        setMsg(msg, "‚úÖ Total correct. <strong>Attention :</strong> corrige les sous-cat√©gories en orange pour finaliser.", true);
        input.style.borderColor = "#28a745";
        input.style.backgroundColor = "#e8f5e9";
        return;
      }

      setMsg(msg, "‚úÖ Bravo ! Classement et total des Recettes : correct.", true);
      input.style.borderColor = "#28a745";
      input.style.backgroundColor = "#e8f5e9";
      input.disabled = true;
      input.dataset.validated = "true";
    }

    // ===== V√âRIFICATION DES D√âPENSES =====
    function verifierDepenses(cat, inputId, msgId){
      resetItemMarks();

      const zone = document.querySelector(`.drop-zone[data-category="${cat}"]`);
      const msg = document.getElementById(msgId);
      const input = document.getElementById(inputId);

      let majorError = false;
      [...zone.querySelectorAll(":scope > .draggable-item")].forEach(el => {
        if(el.dataset.globalCat === "recette"){
          majorError = true;
          markKo(el);
        }
      });
      if(majorError){
        setMsg(msg, "‚ùå <strong>ERREUR MAJEURE :</strong> Une recette a √©t√© plac√©e dans cette colonne. Corrige les √©tiquettes en rouge.", false);
        return;
      }

      let wrongInZone = false;
      [...zone.querySelectorAll(":scope > .draggable-item")].forEach(el => {
        if(el.dataset.globalCat !== "depense" || el.dataset.cat !== cat){
          wrongInZone = true;
          markKo(el);
        }else{
          markOk(el);
        }
      });
      if(wrongInZone){
        setMsg(msg, "‚ö†Ô∏è <strong>CLASSEMENT √Ä CORRIGER :</strong> Un poste ne correspond pas √† cette colonne (en rouge).", false);
        return;
      }

      const expectedItems = itemsData.filter(i => i.globalCat === "depense" && i.cat === cat);
      const missing = [];

      expectedItems.forEach(it => {
        const el = getItemElById(it.id);
        if(!el) return;
        if(el.parentElement !== zone){
          missing.push(it.name);
          markKo(el);
        }else{
          markOk(el);
        }
      });

      if(missing.length){
        setMsg(msg, `‚ö†Ô∏è <strong>CLASSEMENT INCOMPLET :</strong> Il manque ${missing.length} d√©pense(s) dans cette colonne.`, false);
        return;
      }

      const expectedTotal = totalsExpected[cat];
      const rawValue = input.value;
      const analysis = analyzeInputError(rawValue, expectedTotal);
      
      if (analysis.type === 'empty') {
        msg.innerHTML = "√âcris le total dans la case, puis clique sur V√©rifier.";
        msg.className = "feedback-msg info";
        return;
      }
      
      if (analysis.type === 'format') {
        setMsg(msg, analysis.message, false);
        return;
      }
      
      if (analysis.type !== 'correct') {
        setMsg(msg, `‚ùå Le calcul est incorrect. Total attendu : <strong>${expectedTotal} ‚Ç¨</strong>.`, false);
        return;
      }

      setMsg(msg, "‚úÖ Bravo ! Classement et total : correct.", true);
      input.style.borderColor = "#28a745";
      input.style.backgroundColor = "#e8f5e9";
      input.disabled = true;
      input.dataset.validated = "true";

      autoFillDepensesFinalIfReady();
    }

    function autoFillDepensesFinalIfReady(){
      const a = document.getElementById("input-fixes").dataset.validated === "true";
      const b = document.getElementById("input-courantes").dataset.validated === "true";
      const c = document.getElementById("input-occas").dataset.validated === "true";
      if(!(a && b && c)) return;

      const dFixe = totalsExpected.fixe;
      const dCour = totalsExpected.courante;
      const dOcc  = totalsExpected.occas;
      const sum = dFixe + dCour + dOcc;

      const finalDep = document.getElementById("final-depenses");
      if(!finalDep.value) finalDep.value = sum;
    }

    // ===== V√âRIFICATION DU BILAN =====
    function verifierBilan(){
      const msg = document.getElementById("msg-bilan");

      const recettesOK = document.getElementById("input-recettes").dataset.validated === "true";
      const fixesOK    = document.getElementById("input-fixes").dataset.validated === "true";
      const courOK     = document.getElementById("input-courantes").dataset.validated === "true";
      const occasOK    = document.getElementById("input-occas").dataset.validated === "true";

      if(!(recettesOK && fixesOK && courOK && occasOK)){
        msg.innerHTML = "‚ö†Ô∏è V√©rifie d'abord les 4 totaux de colonnes (Recettes, Fixes, Courantes, Occasionnelles).";
        msg.className = "feedback-msg incorrect";
        return;
      }

      const rRaw = document.getElementById("final-recettes").value;
      const dRaw = document.getElementById("final-depenses").value;
      const sRaw = document.getElementById("final-solde").value;
      
      const r = normalizeNumber(rRaw);
      const dFinal = normalizeNumber(dRaw);
      const s = normalizeNumber(sRaw);

      const dCalc = totalDepensesReelles;

      const errors = [];
      if(Math.abs(r - totalsExpected.recettes) > 0.01) errors.push("Total Recettes report√© incorrect.");
      if(isNaN(dFinal)) errors.push("√âcris le Total D√©penses.");
      else if(Math.abs(dFinal - dCalc) > 0.01) errors.push(`Total D√©penses report√© incorrect. Il doit √™tre la somme des 3 colonnes : ${dCalc} ‚Ç¨.`);

      if(errors.length){
        msg.innerHTML = "‚ùå " + errors.join(" ");
        msg.className = "feedback-msg incorrect";
        return;
      }

      if(isNaN(s)){
        msg.innerHTML = "√âcris le solde dans la case, puis v√©rifie.";
        msg.className = "feedback-msg info";
        return;
      }

      const expectedSolde = r - dFinal;
      if(Math.abs(s - expectedSolde) < 0.01){
        msg.innerHTML = `‚úÖ Excellent ! Solde correct : <strong>${soldeReel} ‚Ç¨</strong>.`;
        msg.className = "feedback-msg correct";
        document.getElementById("budget-status").style.opacity = "1";
        document.getElementById("budget-status").style.pointerEvents = "auto";
        document.getElementById("btn-conclusion").style.display = "inline-block";
      }else{
        msg.innerHTML = `‚ö†Ô∏è Solde incorrect. Fais : Recettes - D√©penses. R√©sultat attendu : <strong>${soldeReel} ‚Ç¨</strong>.`;
        msg.className = "feedback-msg incorrect";
      }
    }

    // ===== V√âRIFICATION DE LA CONCLUSION =====
    function verifierConclusion(){
      const msg = document.getElementById("msg-conclusion");

      const correctStatus = soldeReel > 0 ? "exc√©dentaire" : (soldeReel < 0 ? "d√©ficitaire" : "√©quilibr√©");
      const checked = document.querySelector('input[name="budget"]:checked');

      if(!checked){
        msg.innerHTML = "Choisis une r√©ponse : exc√©dentaire, d√©ficitaire ou √©quilibr√©.";
        msg.className = "feedback-msg incorrect";
        return;
      }

      if(checked.value === correctStatus){
        msg.innerHTML = "üéâ BRAVO ! Tu as termin√© l'exercice avec succ√®s.";
        msg.className = "feedback-msg correct";
        msg.style.fontSize = "1.3rem";
        document.body.style.backgroundColor = "#e8f5e9";
      }else{
        msg.innerHTML = `Non. Regarde le signe de ton solde (${soldeReel} ‚Ç¨).`;
        msg.className = "feedback-msg incorrect";
      }
    }

    // ===== SYNTH√àSE VOCALE =====
    let isSpeaking = false;
    function toggleAudio(){
      const btn = document.getElementById("main-audio-btn");

      if(isSpeaking){
        window.speechSynthesis.cancel();
        isSpeaking = false;
        btn.classList.remove("playing");
        btn.innerHTML = "<span>‚ñ∂Ô∏è Lire l'histoire</span>";
        return;
      }

      const text = document.getElementById("text-content").innerText;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "fr-FR";
      utterance.rate = 0.9;

      utterance.onend = () => {
        isSpeaking = false;
        btn.classList.remove("playing");
        btn.innerHTML = "<span>‚ñ∂Ô∏è Lire l'histoire</span>";
      };

      window.speechSynthesis.speak(utterance);
      isSpeaking = true;
      btn.classList.add("playing");
      btn.innerHTML = "<span>‚èπÔ∏è Arr√™ter</span>";
    }

    function syncRadioLabels(){
      document.querySelectorAll('#budget-status label').forEach(l => l.classList.remove('selected'));
      const checked = document.querySelector('#budget-status input[name="budget"]:checked');
      if(checked){
        checked.closest('label').classList.add('selected');
      }
    }

    // ===== √âV√âNEMENTS =====
    document.getElementById("main-audio-btn").addEventListener("click", toggleAudio);

    document.querySelectorAll('button[data-verify]').forEach(btn => {
      btn.addEventListener("click", () => {
        const which = btn.dataset.verify;
        if(which === "recette") verifierRecettes();
        if(which === "fixe") verifierDepenses("fixe", "input-fixes", "msg-fixes");
        if(which === "courante") verifierDepenses("courante", "input-courantes", "msg-courantes");
        if(which === "occas") verifierDepenses("occas", "input-occas", "msg-occas");
      });
    });

    document.getElementById("btn-bilan").addEventListener("click", verifierBilan);
    document.getElementById("btn-conclusion").addEventListener("click", verifierConclusion);

    document.querySelectorAll('#budget-status input[name="budget"]').forEach(r => {
      r.addEventListener("change", syncRadioLabels);
    });
  </script>
</body>
</html>
