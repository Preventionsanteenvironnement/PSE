<!DOCTYPE html>
<html lang='fr'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Julie : √âpargne et Arbitrage</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="annuaire.js"></script>

    <style>
        :root { --primary:#2563eb; --success:#16a34a; --error:#dc2626; --bg:#f8fafc; }
        body{font-family:'Segoe UI',sans-serif;background:var(--bg);padding:20px;color:#1e293b;line-height:1.6;margin:0}
        .container{max-width:900px;width:100%;margin:0 auto;background:white;padding:30px;border-radius:15px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .box{background:#f1f5f9;padding:20px;border-radius:10px;margin-bottom:25px;border-left:6px solid var(--primary)}
        .step{display:none;margin-top:25px;padding:20px;border:1px solid #e2e8f0;border-radius:12px}
        .step.active{display:block}
        .data-table{width:100%;border-collapse:collapse;margin:15px 0}
        .data-table td{padding:10px;border-bottom:1px solid #e2e8f0}
        input[type='number']{padding:10px;border:2px solid #cbd5e1;border-radius:6px;width:160px;font-weight:bold;max-width:100%}
        .btn{padding:12px 25px;background:var(--primary);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;margin-top:15px;width:auto}
        .btn-restart{background:#64748b;margin-top:30px;width:100%;padding:15px;font-size:1.1rem}
        .feedback{margin-top:15px;padding:15px;border-radius:8px;display:none}
        .feedback.success{display:block;background:#dcfce7;color:#166534;border-left:5px solid var(--success)}
        .feedback.error{display:block;background:#fee2e2;color:#991b1b;border-left:5px solid var(--error)}
        .math-box{background:#fff;padding:10px;border:1px dashed #cbd5e1;margin-top:10px;font-family:monospace;font-weight:bold}
        @media(max-width:600px){
            .container{padding:18px;border-radius:12px}
            h1{font-size:1.3rem}
            .btn{width:100%}
        }
    </style>
</head>
<body>
<div class='container'>
    <header>
        <h1>üì± Mission : Financer le projet de Julie</h1>
        <script>
            if(typeof enregistrerVisite === "function") {
                enregistrerVisite("Exercice Julie - Arbitrage");
            }
        </script>
    </header>

    <div class='box'>
        <strong>SITUATION :</strong> Julie veut acheter un t√©l√©phone √† <strong>670,00 ‚Ç¨</strong>.
        
        <table class='data-table'>
            <tr><td>Total des Recettes :</td><td align='right'><strong>1 777,00 ‚Ç¨</strong></td></tr>
            <tr><td>Total des D√©penses (Fixes + Courantes + Occas.) :</td><td align='right'><strong>1 580,59 ‚Ç¨</strong></td></tr>
        </table>
    </div>

    <div id='step1' class='step active'>
        <h3>1. Calculer l'√©pargne mensuelle possible</h3>
        <p>Pour savoir combien elle peut mettre de c√¥t√© chaque mois, calculez son <b>solde</b>.</p>
        <p><strong>Recettes (1777,00) - D√©penses (1580,59) = ?</strong></p>
        <input type='number' step='0.01' id='q1-solde'> ‚Ç¨
        <button class='btn' onclick='verifierEtape1()'>V√©rifier le solde</button>
        <div id='fb1' class='feedback'></div>
    </div>

    <div id='step2' class='step'>
        <h3>2. Calculer le temps d'attente</h3>
        <p>Julie va √©conomiser ce solde tous les mois. Combien de mois doit-elle attendre pour atteindre 670 ‚Ç¨ ?</p>
        <p><strong>Conseil :</strong> Si le r√©sultat n'est pas 'rond' (ex: 3,2), elle doit attendre le mois suivant pour avoir la somme totale.</p>
        <input type='number' id='q2-mois'> mois
        <button class='btn' onclick='verifierEtape2()'>V√©rifier la dur√©e</button>
        <div id='fb2' class='feedback'></div>
    </div>

    <div id='step3' class='step'>
        <h3>3. Strat√©gie d'Arbitrage (Acc√©l√©rer l'achat)</h3>
        <p>Julie d√©cide de r√©duire ses sorties et son shopping de <strong>180 ‚Ç¨</strong> par mois pour aller plus vite.</p>
        <p><strong>Quel est son NOUVEAU solde (Ancien solde + 180 ‚Ç¨) ?</strong></p>
        <input type='number' step='0.01' id='q3-solde'> ‚Ç¨
        <p><strong>Dans combien de mois aura-t-elle son t√©l√©phone avec cet effort ?</strong></p>
        <input type='number' id='q3-mois'> mois
        <button class='btn' onclick='verifierEtape3()'>V√©rifier la strat√©gie</button>
        <div id='fb3' class='feedback'></div>
    </div>

    <div id='final-step' style='display:none;'>
        <button class='btn btn-restart' onclick='location.reload()'>üîÑ RECOMMENCER L'EXERCICE</button>
    </div>
</div>

<script>
    const prixTel = 670.00; 
    const soldeInitial = 196.41;

    function verifierEtape1(){
        const userSolde = parseFloat(document.getElementById('q1-solde').value);
        const fb = document.getElementById('fb1');
        if(Math.abs(userSolde - soldeInitial) < 0.1){
            fb.innerHTML = `‚úÖ <b>Bravo !</b> Julie peut √©pargner <b>196,41 ‚Ç¨</b> par mois.<br><div class='math-box'>Calcul : 1777,00 - 1580,59 = 196,41 ‚Ç¨</div>`;
            fb.className = 'feedback success';
            document.getElementById('step2').classList.add('active');
        } else {
            fb.innerHTML = `‚ùå <b>Calcul incorrect.</b><br>Soustrais les d√©penses des recettes.`;
            fb.className = 'feedback error';
        }
    }

    function verifierEtape2(){
        const userMois = parseInt(document.getElementById('q2-mois').value);
        const fb = document.getElementById('fb2');
        if(userMois === 4){
            fb.innerHTML = `‚úÖ <b>C'est juste !</b><div class='math-box'>670 / 196,41 = 3,41 ‚Üí attendre 4 mois.</div>`;
            fb.className = 'feedback success';
            document.getElementById('step3').classList.add('active');
        } else {
            fb.innerHTML = `‚ùå <b>Attention √† l'arrondi !</b><br>R√©sultat non entier = mois suivant.`;
            fb.className = 'feedback error';
        }
    }

    async function verifierEtape3(){
        const userNouvSolde = parseFloat(document.getElementById('q3-solde').value);
        const userMois = parseInt(document.getElementById('q3-mois').value);
        const fb = document.getElementById('fb3');
        const nouveauSolde = 376.41; // 196.41 + 180

        if(Math.abs(userNouvSolde - nouveauSolde) < 0.1 && userMois === 2){
            fb.innerHTML = `üèÜ <b>F√©licitations !</b><div class='math-box'>670 / 376,41 = 1,78 ‚Üí 2 mois.</div>`;
            fb.className = 'feedback success';
            document.getElementById('final-step').style.display = 'block';
            
            // Validation finale -> Envoi Score
            envoyerResultatFinal();
        } else {
            fb.innerHTML = `‚ùå <b>Rev√©rifie :</b><br>196,41 + 180 = 376,41 puis 670 / 376,41 ‚âà 2 mois.`;
            fb.className = 'feedback error';
        }
    }

    async function envoyerResultatFinal() {
        // --- ENVOI FIREBASE (Comp√©tences C1, C2, C4) ---
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();
            
            // R√©cup√©ration Identit√©
            const code = localStorage.getItem("codeEleve") || "ANONYME";
            const classe = (typeof ANNUAIRE !== 'undefined' && ANNUAIRE[code]) ? ANNUAIRE[code] : "AUTRE";

            // Envoi (Note max car exercice r√©ussi)
            await db.collection("resultats_exercices").add({
                eleve: code,
                classe: classe,
                exercice: "Module D2 - Julie Arbitrage",
                note: 20,
                total: 20,
                competences: {
                    "C1": 20, 
                    "C2": 20,
                    "C4": 20
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("‚úÖ R√©sultats envoy√©s vers C1, C2 et C4 pour " + code);

        } catch (e) {
            console.error("Erreur lors de l'envoi Firebase : ", e);
        }
    }
</script>
</body>
</html>
