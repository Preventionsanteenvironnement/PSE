<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julie : √âpargne et Arbitrage</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="annuaire.js"></script>

    <style>
        :root { --primary: #2563eb; --success: #16a34a; --error: #dc2626; --warning: #f59e0b; --bg: #f8fafc; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; color: #1e293b; line-height: 1.6; margin: 0; }
        .container { max-width: 900px; width: 100%; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .box { background: #f1f5f9; padding: 18px; border-radius: 10px; margin-bottom: 20px; border-left: 6px solid var(--primary); }
        .step { display: none; margin-top: 20px; padding: 18px; border: 1px solid #e2e8f0; border-radius: 12px; }
        .step.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; margin: 12px 0; }
        .data-table td { padding: 8px 5px; border-bottom: 1px solid #e2e8f0; }
        
        /* INPUTS RESPONSIVES */
        .input-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
        input[type="text"], input[type="number"] { 
            padding: 12px; 
            border: 2px solid #cbd5e1; 
            border-radius: 6px; 
            width: 100%;
            max-width: 150px; 
            font-weight: bold; 
            font-size: 1rem;
        }
        input:focus { border-color: var(--primary); outline: none; }
        .unit { font-weight: bold; font-size: 1rem; }
        
        .btn { 
            padding: 12px 20px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            margin-top: 12px;
            width: 100%;
            max-width: 250px;
        }
        .btn:hover { background: #1d4ed8; }
        
        .btn-restart { 
            background: #64748b; 
            margin-top: 25px; 
            width: 100%; 
            max-width: 100%;
            padding: 15px; 
            font-size: 1.1rem; 
        }
        .btn-restart:hover { background: #475569; }
        
        .feedback { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; }
        .feedback.success { display: block; background: #dcfce7; color: #166534; border-left: 5px solid var(--success); }
        .feedback.error { display: block; background: #fee2e2; color: #991b1b; border-left: 5px solid var(--error); }
        .feedback.warning { display: block; background: #fef3c7; color: #92400e; border-left: 5px solid var(--warning); }
        
        .math-box { 
            background: #f8fafc; 
            padding: 12px; 
            border: 1px dashed #cbd5e1; 
            margin-top: 10px; 
            font-family: 'Courier New', monospace; 
            font-weight: bold;
            border-radius: 6px;
            overflow-x: auto;
        }
        
        h1 { font-size: 1.4rem; margin-bottom: 5px; }
        h3 { color: var(--primary); margin-bottom: 10px; }
        
        .success-banner {
            text-align: center;
            padding: 20px;
            background: #dcfce7;
            border-radius: 10px;
            margin-top: 20px;
        }
        .success-banner h2 { color: #166534; margin: 0 0 10px 0; }
        
        /* MOBILE */
        @media (max-width: 500px) {
            .container { padding: 15px; }
            h1 { font-size: 1.2rem; }
            h3 { font-size: 1rem; }
            .data-table td { font-size: 0.9rem; padding: 6px 3px; }
            input[type="text"], input[type="number"] { max-width: 120px; padding: 10px; }
            .btn { padding: 12px 15px; font-size: 0.95rem; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>üì± Mission : Financer le projet de Julie</h1>
        <script>
            if(typeof enregistrerVisite === "function") {
                enregistrerVisite("Exercice Julie - Arbitrage");
            }
        </script>
    </header>

    <div class="box">
        <strong>üìã SITUATION :</strong> Julie veut acheter un t√©l√©phone √† <strong>670,00 ‚Ç¨</strong>.
        
        <table class="data-table">
            <tr><td>Total des Recettes :</td><td align="right"><strong>1 777,00 ‚Ç¨</strong></td></tr>
            <tr><td>Total des D√©penses (Fixes + Courantes + Occas.) :</td><td align="right"><strong>1 580,59 ‚Ç¨</strong></td></tr>
        </table>
    </div>

    <!-- √âTAPE 1 -->
    <div id="step1" class="step active">
        <h3>üìä √âtape 1 : Calculer l'√©pargne mensuelle possible</h3>
        <p>Pour savoir combien Julie peut mettre de c√¥t√© chaque mois, calculez son <b>solde</b>.</p>
        <p><strong>Recettes ‚àí D√©penses = ?</strong></p>
        
        <div class="input-group">
            <input type="text" inputmode="decimal" id="q1-solde" placeholder="Ex : 150,00">
            <span class="unit">‚Ç¨</span>
        </div>
        
        <button class="btn" onclick="verifierEtape1()">‚úì V√©rifier le solde</button>
        <div id="fb1" class="feedback"></div>
    </div>

    <!-- √âTAPE 2 -->
    <div id="step2" class="step">
        <h3>‚è±Ô∏è √âtape 2 : Calculer le temps d'attente</h3>
        <p>Julie va √©conomiser ce solde tous les mois. <strong>Combien de mois</strong> doit-elle attendre pour atteindre 670 ‚Ç¨ ?</p>
        <p><em>üí° Conseil : Si le r√©sultat n'est pas entier (ex : 3,2), elle doit attendre le mois suivant pour avoir la somme totale.</em></p>
        
        <div class="input-group">
            <input type="number" inputmode="numeric" id="q2-mois" min="1" max="24" placeholder="?">
            <span class="unit">mois</span>
        </div>
        
        <button class="btn" onclick="verifierEtape2()">‚úì V√©rifier la dur√©e</button>
        <div id="fb2" class="feedback"></div>
    </div>

    <!-- √âTAPE 3 -->
    <div id="step3" class="step">
        <h3>üöÄ √âtape 3 : Strat√©gie d'Arbitrage (Acc√©l√©rer l'achat)</h3>
        <p>Julie d√©cide de <strong>r√©duire ses sorties et son shopping</strong> de <strong>180 ‚Ç¨</strong> par mois pour aller plus vite.</p>
        
        <p><strong>Question A :</strong> Quel est son NOUVEAU solde mensuel ?</p>
        <p><em>üí° Ancien solde + √âconomies = ?</em></p>
        <div class="input-group">
            <input type="text" inputmode="decimal" id="q3-solde" placeholder="Ex : 300,00">
            <span class="unit">‚Ç¨</span>
        </div>
        
        <p style="margin-top: 15px;"><strong>Question B :</strong> Dans combien de mois aura-t-elle son t√©l√©phone avec cet effort ?</p>
        <div class="input-group">
            <input type="number" inputmode="numeric" id="q3-mois" min="1" max="12" placeholder="?">
            <span class="unit">mois</span>
        </div>
        
        <button class="btn" onclick="verifierEtape3()">‚úì V√©rifier la strat√©gie</button>
        <div id="fb3" class="feedback"></div>
    </div>

    <!-- FINAL -->
    <div id="final-step" style="display:none;">
        <div class="success-banner">
            <h2>üéâ F√©licitations !</h2>
            <p>Tu as aid√© Julie √† planifier son √©pargne et √† acc√©l√©rer son projet gr√¢ce √† l'arbitrage budg√©taire.</p>
        </div>
        <button class="btn btn-restart" onclick="location.reload()">üîÑ RECOMMENCER L'EXERCICE</button>
    </div>
</div>

<script>
    const prixTel = 670.00; 
    const soldeInitial = 196.41;
    const nouveauSolde = 376.41;
    const moisSansArbitrage = 4;
    const moisAvecArbitrage = 2;

    // === FONCTION UTILITAIRE : Normaliser les entr√©es (virgule/point) ===
    function normaliserNombre(valeur) {
        if (!valeur || valeur.trim() === '') return NaN;
        const normalise = valeur.replace(/\s/g, '').replace(',', '.');
        return parseFloat(normalise);
    }

    // === √âTAPE 1 ===
    function verifierEtape1() {
        const input = document.getElementById('q1-solde');
        const userSolde = normaliserNombre(input.value);
        const fb = document.getElementById('fb1');
        
        if (isNaN(userSolde)) {
            fb.innerHTML = `‚ö†Ô∏è <b>Entre un montant !</b><br>Calcule : 1 777,00 ‚àí 1 580,59 = ?`;
            fb.className = 'feedback warning';
            input.focus();
            return;
        }
        
        if (Math.abs(userSolde - soldeInitial) < 0.5) {
            fb.innerHTML = `‚úÖ <b>Bravo !</b> Julie peut √©pargner <b>196,41 ‚Ç¨</b> par mois.<br>
            <div class="math-box">üìê Calcul : 1 777,00 ‚Ç¨ ‚àí 1 580,59 ‚Ç¨ = <strong>196,41 ‚Ç¨</strong></div>`;
            fb.className = 'feedback success';
            document.getElementById('step2').classList.add('active');
            document.getElementById('q2-mois').focus();
        } else {
            fb.innerHTML = `‚ùå <b>Calcul incorrect.</b><br>Soustrais les d√©penses des recettes :<br><strong>1 777,00 ‚àí 1 580,59 = ?</strong>`;
            fb.className = 'feedback error';
        }
    }

    // === √âTAPE 2 ===
    function verifierEtape2() {
        const input = document.getElementById('q2-mois');
        const userMois = parseInt(input.value);
        const fb = document.getElementById('fb2');
        
        if (isNaN(userMois) || userMois < 1) {
            fb.innerHTML = `‚ö†Ô∏è <b>Entre un nombre de mois !</b><br>Divise 670 par 196,41 et arrondis au mois sup√©rieur.`;
            fb.className = 'feedback warning';
            input.focus();
            return;
        }
        
        if (userMois === moisSansArbitrage) {
            fb.innerHTML = `‚úÖ <b>C'est juste !</b><br>
            <div class="math-box">üìê Calcul : 670 ‚Ç¨ √∑ 196,41 ‚Ç¨ = 3,41 mois<br>
            ‚Üí Au 3√®me mois : 3 √ó 196,41 = 589,23 ‚Ç¨ (pas assez)<br>
            ‚Üí Au <strong>4√®me mois</strong> : 4 √ó 196,41 = <strong>785,64 ‚Ç¨</strong> ‚úì</div>`;
            fb.className = 'feedback success';
            document.getElementById('step3').classList.add('active');
            document.getElementById('q3-solde').focus();
        } else if (userMois === 3) {
            fb.innerHTML = `‚ùå <b>Presque !</b><br>Au 3√®me mois, Julie aura : 3 √ó 196,41 = <strong>589,23 ‚Ç¨</strong><br>C'est insuffisant pour les 670 ‚Ç¨. Elle doit attendre <strong>un mois de plus</strong>.`;
            fb.className = 'feedback error';
        } else {
            fb.innerHTML = `‚ùå <b>Attention √† l'arrondi !</b><br>Divise <strong>670 √∑ 196,41 = 3,41...</strong><br>Comme on ne peut pas attendre 3,41 mois, Julie doit attendre le <strong>mois entier suivant</strong>.`;
            fb.className = 'feedback error';
        }
    }

    // === √âTAPE 3 ===
    async function verifierEtape3() {
        const inputSolde = document.getElementById('q3-solde');
        const inputMois = document.getElementById('q3-mois');
        const userNouvSolde = normaliserNombre(inputSolde.value);
        const userMois = parseInt(inputMois.value);
        const fb = document.getElementById('fb3');
        
        // V√©rification champs vides
        if (isNaN(userNouvSolde) && isNaN(userMois)) {
            fb.innerHTML = `‚ö†Ô∏è <b>Remplis les deux r√©ponses !</b>`;
            fb.className = 'feedback warning';
            inputSolde.focus();
            return;
        }
        if (isNaN(userNouvSolde)) {
            fb.innerHTML = `‚ö†Ô∏è <b>Entre le nouveau solde !</b><br>Calcule : 196,41 + 180 = ?`;
            fb.className = 'feedback warning';
            inputSolde.focus();
            return;
        }
        if (isNaN(userMois) || userMois < 1) {
            fb.innerHTML = `‚ö†Ô∏è <b>Entre le nombre de mois !</b>`;
            fb.className = 'feedback warning';
            inputMois.focus();
            return;
        }
        
        const soldeOK = Math.abs(userNouvSolde - nouveauSolde) < 0.5;
        const moisOK = userMois === moisAvecArbitrage;
        
        if (soldeOK && moisOK) {
            fb.innerHTML = `üèÜ <b>F√©licitations !</b><br>
            <div class="math-box">üìê Nouveau solde : 196,41 + 180 = <strong>376,41 ‚Ç¨</strong><br>
            üìê Dur√©e : 670 √∑ 376,41 = 1,78 ‚Üí <strong>2 mois</strong></div>
            <p style="margin-top:10px;">Gr√¢ce √† l'arbitrage, Julie obtient son t√©l√©phone en <strong>2 mois au lieu de 4</strong> !</p>`;
            fb.className = 'feedback success';
            document.getElementById('final-step').style.display = 'block';
            envoyerResultatFinal();
        } else if (soldeOK && !moisOK) {
            // Solde correct, mois incorrect
            if (userMois === 1) {
                fb.innerHTML = `‚ùå <b>Le solde est bon, mais v√©rifie les mois.</b><br>Au 1er mois : 376,41 ‚Ç¨ (pas assez pour 670 ‚Ç¨).<br>Il faut attendre <strong>un mois de plus</strong>.`;
            } else {
                fb.innerHTML = `‚ùå <b>Le solde est bon !</b> Mais v√©rifie la dur√©e.<br>Divise <strong>670 √∑ 376,41 = 1,78</strong> ‚Üí arrondis au mois sup√©rieur.`;
            }
            fb.className = 'feedback error';
        } else if (!soldeOK && moisOK) {
            // Mois correct, solde incorrect
            fb.innerHTML = `‚ùå <b>Les mois sont bons, mais v√©rifie le solde.</b><br>Calcul : <strong>196,41 + 180 = ?</strong>`;
            fb.className = 'feedback error';
        } else {
            // Tout faux
            fb.innerHTML = `‚ùå <b>Rev√©rifie les deux r√©ponses :</b><br>
            ‚Ä¢ Nouveau solde : 196,41 + 180 = ?<br>
            ‚Ä¢ Puis divise 670 par ce nouveau solde et arrondis au mois sup√©rieur.`;
            fb.className = 'feedback error';
        }
    }

    // === ENVOI FIREBASE ===
    async function envoyerResultatFinal() {
        try {
            if (typeof firebase === 'undefined' || !firebase.apps) {
                console.log("Firebase non disponible - Mode hors ligne");
                return;
            }
            
            if (!firebase.apps.length && typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
            }
            
            if (!firebase.apps.length) {
                console.log("Configuration Firebase manquante");
                return;
            }
            
            const db = firebase.firestore();
            const code = localStorage.getItem("codeEleve") || "ANONYME";
            const classe = (typeof ANNUAIRE !== 'undefined' && ANNUAIRE[code]) ? ANNUAIRE[code] : "AUTRE";

            await db.collection("resultats_exercices").add({
                eleve: code,
                classe: classe,
                exercice: "Module D2 - Julie Arbitrage",
                note: 20,
                total: 20,
                competences: {
                    "C1": 20, 
                    "C2": 20,
                    "C4": 20
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("‚úÖ R√©sultats envoy√©s vers C1, C2 et C4 pour " + code);

        } catch (e) {
            console.error("Erreur lors de l'envoi Firebase : ", e);
        }
    }

    // === VALIDATION PAR TOUCHE ENTR√âE ===
    document.getElementById('q1-solde').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifierEtape1();
    });
    document.getElementById('q2-mois').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifierEtape2();
    });
    document.getElementById('q3-solde').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') document.getElementById('q3-mois').focus();
    });
    document.getElementById('q3-mois').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifierEtape3();
    });
</script>
</body>
</html>
