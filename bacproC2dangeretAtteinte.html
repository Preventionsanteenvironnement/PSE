<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dangers au travail ‚Äì Exercice interactif Bac Pro</title>
  <style>
    :root{
      --primary:#1d4ed8;
      --secondary:#eff6ff;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#f59e0b;
      --bg:#f3f4f6;
      --radius:10px;
      --text:#111827;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:10px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrapper{
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:18px;
      border-radius:14px;
      box-shadow:0 10px 25px rgba(15,23,42,.08);
    }
    h1{
      text-align:center;
      font-size:1.6rem;
      margin:0 0 10px;
    }
    h2{
      margin-top:20px;
      font-size:1.25rem;
      border-bottom:2px solid var(--primary);
      padding-bottom:4px;
    }
    h3{
      margin:0 0 8px;
      font-size:1.05rem;
      border-bottom:1px solid #e5e7eb;
      padding-bottom:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .points{
      font-size:.8rem;
      font-weight:600;
      color:#6b7280;
    }
    p{margin:6px 0 10px;}
    .tag{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:999px;
      font-size:.7rem;
      font-weight:700;
      background:var(--secondary);
      color:var(--primary);
    }
    .bloc-def{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
      margin:12px 0 4px;
    }
    .def-card{
      padding:10px 12px;
      border-radius:var(--radius);
      border-left:5px solid;
      background:#f9fafb;
      font-size:.95rem;
    }
    .def-card.danger{border-color:var(--danger);background:#fef2f2;}
    .def-card.atteinte{border-color:var(--success);background:#ecfdf5;}
    .exo{
      margin:16px 0;
      padding:12px;
      border-radius:var(--radius);
      background:var(--secondary);
      border:1px dashed #cbd5f5;
    }
    fieldset{border:none;padding:0;margin:0;}
    label{font-size:.95rem;}
    input[type="radio"]{margin-right:4px;}
    select,input[type="text"],textarea{
      width:100%;
      max-width:420px;
      padding:7px 8px;
      border-radius:7px;
      border:1px solid #d1d5db;
      font-size:.95rem;
      margin-top:4px;
    }
    textarea{resize:vertical;min-height:60px;}
    .drag-zones{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .drag-zone{
      flex:1 1 160px;
      min-height:70px;
      padding:8px;
      border-radius:8px;
      border:2px dashed #c7d2fe;
      background:#fff;
      font-size:.9rem;
    }
    .drag-zone h4{
      margin:0 0 4px;
      font-size:.9rem;
      color:#4b5563;
    }
    .drag-items{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .item{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      font-size:.85rem;
      cursor:grab;
      user-select:none;
    }
    .item.selected{
      outline:3px solid rgba(37,99,235,.45);
      border-color:var(--primary);
    }
    .feedback{
      margin-top:8px;
      padding:7px 9px;
      border-radius:7px;
      font-size:.9rem;
      display:none;
      font-weight:600;
    }
    .fb-good{background:#dcfce7;color:#166534;}
    .fb-mid{background:#fef9c3;color:#854d0e;}
    .fb-bad{background:#fee2e2;color:#b91c1c;}
    .correction{
      display:none;
      margin-top:6px;
      padding:7px 9px;
      border-radius:7px;
      font-size:.86rem;
      background:#f9fafb;
      border:1px dashed #d1d5db;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      border-radius:999px;
      border:none;
      font-weight:700;
      cursor:pointer;
      font-size:.95rem;
      margin-top:10px;
      gap:6px;
    }
    .btn-main{
      background:var(--primary);
      color:#fff;
    }
    .btn-main:disabled{opacity:.6;cursor:not-allowed;}
    .btn-reset{
      background:#6b7280;
      color:#fff;
    }
    .score-box{
      margin-top:22px;
      padding:14px;
      border-radius:12px;
      border:2px solid var(--success);
      background:#ecfdf5;
      text-align:center;
    }
    #final-score{
      font-size:2rem;
      margin:8px 0 4px;
      font-weight:800;
      color:var(--danger);
    }
    #global-msg{
      margin-top:10px;
      padding:9px 10px;
      border-radius:8px;
      background:#f9fafb;
      border-left:5px solid var(--primary);
      text-align:left;
      display:none;
      font-size:.9rem;
    }
    ul{padding-left:18px;}
    @media (max-width:640px){
      .wrapper{padding:14px;}
      h1{font-size:1.35rem;}
    }

    /* bloc envoi prof */
    #pse-envoi-prof{
      margin:26px auto 10px;
      max-width:620px;
      padding:16px 14px;
      border-radius:14px;
      border:2px solid #0ea5e9;
      background:#e0f2fe;
      text-align:center;
    }
    #pse-envoi-prof h3{
      border:none;
      justify-content:center;
      color:#0369a1;
    }
    #pse-envoi-prof .row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      margin-top:4px;
    }
    #pse-eleve-nom,#pse-eleve-classe{
      padding:9px 10px;
      border-radius:9px;
      border:1px solid #cbd5e1;
    }
    #pse-eleve-nom{flex:1 1 170px;}
    #pse-eleve-classe{flex:0 0 150px;}
    #pse-btn-envoyer{
      margin-top:10px;
      padding:10px 20px;
      border-radius:999px;
      border:none;
      background:#0284c7;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size:.95rem;
    }
    #pse-msg{
      margin-top:8px;
      min-height:18px;
      font-size:.9rem;
      font-weight:600;
    }
  </style>
</head>
<body>

<div class="wrapper">
  <h1>üéØ Dangers au travail et atteintes √† la sant√©</h1>
  <p style="text-align:center;font-size:.95rem;">Objectif Bac Pro : √™tre capable de <strong>distinguer la CAUSE (danger)</strong> et la <strong>CONS√âQUENCE (atteinte √† la sant√©)</strong> dans des situations professionnelles simples.</p>

  <h2>1. Rappels PSE</h2>
  <div class="bloc-def">
    <div class="def-card danger">
      <strong>üö® Danger = CAUSE</strong><br>
      √âl√©ment, situation ou organisation du travail qui peut provoquer une blessure ou une maladie.
      <br><span class="tag">Ex : sol glissant, produit chimique, bruit, charge lourde‚Ä¶</span>
    </div>
    <div class="def-card atteinte">
      <strong>ü©∫ Atteinte √† la sant√© = CONS√âQUENCE</strong><br>
      Dommage sur le corps ou la sant√© : blessure, maladie, fatigue, stress‚Ä¶
      <br><span class="tag">Ex : entorse, br√ªlure, lombalgie, intoxication‚Ä¶</span>
    </div>
  </div>

  <h2>2. Exercices interactifs (score sur 15)</h2>

  <!-- EXO 1 -->
  <div class="exo" id="exo1">
    <h3>Exercice 1 ‚Äì QCM cause / cons√©quence <span class="points">(5 pts)</span></h3>
    <p>Pour chaque situation, coche si la phrase d√©crit un <strong>danger</strong> ou une <strong>atteinte √† la sant√©</strong>.</p>

    <fieldset>
      <legend style="position:absolute;left:-9999px;">QCM exercice 1</legend>

      <p><strong>1.</strong> Un sol mouill√© dans la cuisine du restaurant.</p>
      <label><input type="radio" name="e1q1" value="danger"> Danger (cause)</label><br>
      <label><input type="radio" name="e1q1" value="atteinte"> Atteinte √† la sant√© (cons√©quence)</label>

      <p style="margin-top:10px;"><strong>2.</strong> Entorse de la cheville apr√®s une chute.</p>
      <label><input type="radio" name="e1q2" value="danger"> Danger</label><br>
      <label><input type="radio" name="e1q2" value="atteinte"> Atteinte √† la sant√©</label>

      <p style="margin-top:10px;"><strong>3.</strong> Fum√©es de produits de nettoyage mal ventil√©es.</p>
      <label><input type="radio" name="e1q3" value="danger"> Danger</label><br>
      <label><input type="radio" name="e1q3" value="atteinte"> Atteinte √† la sant√©</label>

      <p style="margin-top:10px;"><strong>4.</strong> Maux de t√™te et irritation des yeux apr√®s plusieurs heures d'exposition.</p>
      <label><input type="radio" name="e1q4" value="danger"> Danger</label><br>
      <label><input type="radio" name="e1q4" value="atteinte"> Atteinte √† la sant√©</label>

      <p style="margin-top:10px;"><strong>5.</strong> Port r√©p√©t√© de charges lourdes sans aide m√©canique.</p>
      <label><input type="radio" name="e1q5" value="danger"> Danger</label><br>
      <label><input type="radio" name="e1q5" value="atteinte"> Atteinte √† la sant√©</label>
    </fieldset>

    <div id="fb-exo1" class="feedback"></div>
    <div id="corr-exo1" class="correction">
      1 Danger ‚Äì sol mouill√©. 2 Atteinte ‚Äì entorse. 3 Danger ‚Äì fum√©es chimiques. 4 Atteinte ‚Äì maux de t√™te/irritations. 5 Danger ‚Äì manutention manuelle.
    </div>
  </div>

  <!-- EXO 2 -->
  <div class="exo" id="exo2">
    <h3>Exercice 2 ‚Äì Classer les √©l√©ments <span class="points">(5 pts)</span></h3>
    <p>D√©place chaque √©tiquette dans la bonne zone. Tu peux toucher une √©tiquette puis la zone sur t√©l√©phone.</p>

    <div class="drag-zones">
      <div class="drag-zone" id="zone-source">
        <h4>Zone de d√©part</h4>
        <div class="drag-items">
          <div class="item" data-type="danger">Produit corrosif non √©tiquet√©</div>
          <div class="item" data-type="atteinte">Br√ªlure chimique sur la main</div>
          <div class="item" data-type="danger">√âchelle mal fix√©e</div>
          <div class="item" data-type="atteinte">Fracture du poignet</div>
          <div classitem data-type="danger">Rythme de travail tr√®s rapide</div>
          <div class="item" data-type="atteinte">Stress important</div>
        </div>
      </div>

      <div class="drag-zone" id="zone-danger" data-target="danger">
        <h4>üö® DANGERS (CAUSES)</h4>
      </div>

      <div class="drag-zone" id="zone-atteinte" data-target="atteinte">
        <h4>ü©∫ ATTEINTES (CONS√âQUENCES)</h4>
      </div>
    </div>

    <div id="fb-exo2" class="feedback"></div>
    <div id="corr-exo2" class="correction">
      Dangers : produit corrosif non √©tiquet√©, √©chelle mal fix√©e, rythme de travail tr√®s rapide. Atteintes : br√ªlure chimique, fracture du poignet, stress important.
    </div>
  </div>

  <!-- EXO 3 -->
  <div class="exo" id="exo3">
    <h3>Exercice 3 ‚Äì Associer danger / atteinte <span class="points">(3 pts)</span></h3>
    <p>Choisis, pour chaque danger, l‚Äôatteinte la plus logique.</p>
    <ol style="padding-left:18px;">
      <li style="margin-bottom:8px;">
        Travail avec un casque audio au volume tr√®s √©lev√© pendant plusieurs heures.<br>
        <select id="e3s1">
          <option value="">Choisir...</option>
          <option value="mal_dos">Mal de dos</option>
          <option value="surdite">Surdit√© / baisse d'audition</option>
          <option value="coupure">Coupure</option>
        </select>
      </li>
      <li style="margin-bottom:8px;">
        Utilisation prolong√©e d‚Äôun ordinateur avec √©cran mal r√©gl√© et pauses rares.<br>
        <select id="e3s2">
          <option value="">Choisir...</option>
          <option value="tms">Douleurs cervicales / TMS</option>
          <option value="intoxication">Intoxication aigu√´</option>
          <option value="fracture">Fracture</option>
        </select>
      </li>
      <li>
        Manipulation de sacs de farine de 25 kg plusieurs fois par jour sans formation ni mat√©riel.<br>
        <select id="e3s3">
          <option value="">Choisir...</option>
          <option value="toux">Toux passag√®re</option>
          <option value="lombalgie">Lombalgie chronique</option>
          <option value="irritation_peau">Irritation de la peau</option>
        </select>
      </li>
    </ol>
    <div id="fb-exo3" class="feedback"></div>
    <div id="corr-exo3" class="correction">
      1 Surdit√© / baisse d'audition. 2 Douleurs cervicales / TMS. 3 Lombalgie chronique.
    </div>
  </div>

  <!-- EXO 4 -->
  <div class="exo" id="exo4">
    <h3>Exercice 4 ‚Äì D√©crire danger et atteinte <span class="points">(2 pts)</span></h3>
    <p>Situation : en cuisine, un couteau est pos√© sur le bord de la table. Un √©l√®ve le fait tomber et se coupe le pied.</p>
    <p style="margin-bottom:4px;"><strong>1.</strong> √âcris le <strong>danger (cause)</strong> principal :</p>
    <input type="text" id="e4t1" placeholder="Danger (cause)‚Ä¶">
    <p style="margin:10px 0 4px;"><strong>2.</strong> √âcris l‚Äô<strong>atteinte √† la sant√© (cons√©quence)</strong> :</p>
    <input type="text" id="e4t2" placeholder="Atteinte √† la sant√©‚Ä¶">

    <div id="fb-exo4" class="feedback"></div>
    <div id="corr-exo4" class="correction">
      Danger : couteau pos√© au bord de la table / risque de chute d'objet coupant. Atteinte : coupure au pied / blessure au pied.
    </div>
  </div>

  <!-- EXO 5 -->
  <div class="exo" id="exo5">
    <h3>Exercice 5 ‚Äì Phrase synth√®se Bac Pro <span class="points">(0 √† 0 pt, bonus formatif)</span></h3>
    <p>√âcris une phrase simple qui r√©sume la diff√©rence entre <strong>danger</strong> et <strong>atteinte √† la sant√©</strong> dans le travail.</p>
    <textarea id="e5txt" placeholder="Exemple : Le danger est ce qui peut provoquer l'accident, l'atteinte √† la sant√© est la cons√©quence sur le corps ou la sant√©."></textarea>
    <div id="fb-exo5" class="feedback"></div>
    <div id="corr-exo5" class="correction">
      Exemple attendu : le danger est la cause (ce qui peut provoquer un dommage), l‚Äôatteinte √† la sant√© est la cons√©quence sur le corps ou la sant√©.
    </div>
  </div>

  <div class="score-box">
    <h2>3. Ton score</h2>
    <p>Appuie sur le bouton pour corriger tous les exercices et afficher les explications.</p>
    <button class="btn btn-main" id="btn-corriger">‚úÖ Corriger et calculer mon score</button>
    <div id="final-score">-- / 15</div>
    <div id="global-msg"></div>

    <div id="zone-explication" style="margin-top:12px;text-align:left;display:none;font-size:.9rem;">
      <h3 style="border:none;margin:0 0 4px;">Comment lire ton r√©sultat ?</h3>
      <ul>
        <li><strong>12 √† 15</strong> : distinction danger / atteinte bien ma√Ætris√©e.</li>
        <li><strong>8 √† 11</strong> : bases pr√©sentes, revoir quelques confusions.</li>
        <li><strong>0 √† 7</strong> : reprendre les d√©finitions et les corrections.</li>
      </ul>
      <button class="btn btn-reset" id="btn-reset">‚ôªÔ∏è R√©initialiser tous les exercices</button>
    </div>
  </div>
</div>

<!-- bloc envoi prof -->
<div id="pse-envoi-prof">
  <h3>üì§ Enregistrer mon r√©sultat pour le professeur</h3>
  <div class="row">
    <input id="pse-eleve-nom" type="text" placeholder="Pr√©nom NOM">
    <select id="pse-eleve-classe">
      <option value="">-- Ta classe --</option>
      <option value="2nde Bac Pro">2nde Bac Pro</option>
      <option value="1√®re Bac Pro">1√®re Bac Pro</option>
      <option value="Tle Bac Pro">Tle Bac Pro</option>
      <option value="CAP 1">CAP 1</option>
      <option value="CAP 2">CAP 2</option>
      <option value="Autre">Autre</option>
    </select>
  </div>
  <button id="pse-btn-envoyer">Envoyer au professeur</button>
  <div id="pse-msg"></div>
</div>

<script>
  const MAX_SCORE = 15;

  function norm(t){
    return (t||"")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g,"")
      .replace(/[‚Äô']/g,"'")
      .replace(/\s+/g," ")
      .trim();
  }

  function showFb(id, msg, type){
    const el = document.getElementById(id);
    if(!el) return;
    el.style.display="block";
    el.textContent=msg;
    el.className="feedback "+(type==="good"?"fb-good":type==="mid"?"fb-mid":"fb-bad");
  }
  function showCorr(id){
    const el = document.getElementById(id);
    if(el) el.style.display="block";
  }

  function checkExo1(){
    const correct = {e1q1:"danger",e1q2:"atteinte",e1q3:"danger",e1q4:"atteinte",e1q5:"danger"};
    let score = 0, answered=0;
    Object.keys(correct).forEach(name=>{
      const sel = document.querySelector('input[name="'+name+'"]:checked');
      if(sel){
        answered++;
        if(sel.value===correct[name]) score++;
      }
    });
    if(answered<5){
      showFb("fb-exo1","Exercice incomplet : r√©ponds √† toutes les questions.","mid");
    }else if(score===5){
      showFb("fb-exo1","Parfait : 5 / 5.","good");
    }else if(score>=3){
      showFb("fb-exo1",score+" / 5 : encore quelques confusions.","mid");
    }else{
      showFb("fb-exo1",score+" / 5 : reprends bien les d√©finitions.","bad");
    }
    showCorr("corr-exo1");
    return score;
  }

  // clic pour d√©placer (mobile + ordi)
  let selectedItem=null;
  function clearSelection(){
    document.querySelectorAll("#exo2 .item").forEach(i=>i.classList.remove("selected"));
    selectedItem=null;
  }
  function setupDragClick(){
    const items=document.querySelectorAll("#exo2 .item");
    const zones=document.querySelectorAll("#exo2 .drag-zone");
    items.forEach(it=>{
      it.addEventListener("click",()=>{
        if(selectedItem===it){clearSelection();return;}
        clearSelection();
        selectedItem=it;
        it.classList.add("selected");
      });
    });
    zones.forEach(z=>{
      z.addEventListener("click",()=>{
        if(!selectedItem) return;
        const holder = z.querySelector(".drag-items") || z;
        holder.appendChild(selectedItem);
        selectedItem.classList.remove("selected");
        selectedItem=null;
      });
    });
  }

  function checkExo2(){
    const zoneDanger=document.getElementById("zone-danger");
    const zoneAtteinte=document.getElementById("zone-atteinte");
    let scoreRaw=0;
    let total=0;
    const checkZone=(zone,type)=>{
      let s=0;
      zone.querySelectorAll(".item").forEach(it=>{
        total++;
        if(it.dataset.type===type) s++;
      });
      return s;
    };
    scoreRaw+=checkZone(zoneDanger,"danger");
    scoreRaw+=checkZone(zoneAtteinte,"atteinte");
    if(total<6){
      showFb("fb-exo2","Place toutes les √©tiquettes avant de corriger.","mid");
    }else if(scoreRaw===6){
      showFb("fb-exo2","Classement parfait : 5 / 5.","good");
    }else if(scoreRaw>=3){
      showFb("fb-exo2",scoreRaw+" / 6 bonnes √©tiquettes ‚âà 4 / 5.","mid");
    }else{
      showFb("fb-exo2",scoreRaw+" / 6 bonnes √©tiquettes ‚âà 2 / 5.","bad");
    }
    showCorr("corr-exo2");
    const ratio = scoreRaw/6;
    return Math.round(ratio*5);
  }

  function checkExo3(){
    let score=0;
    const s1=document.getElementById("e3s1").value;
    const s2=document.getElementById("e3s2").value;
    const s3=document.getElementById("e3s3").value;
    if(s1==="surdite") score++;
    if(s2==="tms") score++;
    if(s3==="lombalgie") score++;
    if(!s1 || !s2 || !s3){
      showFb("fb-exo3","Compl√®te les trois associations.","mid");
    }else if(score===3){
      showFb("fb-exo3","3 / 3 : associations correctes.","good");
    }else if(score===2){
      showFb("fb-exo3","2 / 3 : une association est √† revoir.","mid");
    }else{
      showFb("fb-exo3","0 ou 1 / 3 : plusieurs confusions.","bad");
    }
    showCorr("corr-exo3");
    return score;
  }

  function checkExo4(){
    const t1=norm(document.getElementById("e4t1").value);
    const t2=norm(document.getElementById("e4t2").value);
    let score=0;
    const dangerOk = ["couteau","bord de la table","couteau au bord","chute de couteau"];
    const attOk = ["coupure","blessure","plaie","coupure au pied","coupure pied"];
    if(dangerOk.some(v=>t1.includes(norm(v)))) score++;
    if(attOk.some(v=>t2.includes(norm(v)))) score++;
    if(!t1 || !t2){
      showFb("fb-exo4","√âcris les deux r√©ponses avant de corriger.","mid");
    }else if(score===2){
      showFb("fb-exo4","Tr√®s bien : 2 / 2.","good");
    }else if(score===1){
      showFb("fb-exo4","1 / 2 : tu as bien rep√©r√© un des deux √©l√©ments.","mid");
    }else{
      showFb("fb-exo4","0 / 2 : reprends la situation et la correction.","bad");
    }
    showCorr("corr-exo4");
    return score;
  }

  function checkExo5(){
    const txt = norm(document.getElementById("e5txt").value);
    let fb = "Exercice bonus : utile pour m√©moriser la diff√©rence.";
    if(txt){
      if(txt.includes("cause") && txt.includes("consequence")) fb="Ta phrase contient d√©j√† la logique cause / cons√©quence, bravo.";
      else fb="Bonne tentative : v√©rifie que tu parles bien de cause (danger) et de cons√©quence (atteinte).";
    }
    const el=document.getElementById("fb-exo5");
    el.style.display="block";
    el.textContent=fb;
    el.className="feedback fb-mid";
    showCorr("corr-exo5");
  }

  function globalMessage(score){
    const box=document.getElementById("global-msg");
    box.style.display="block";
    let txt="";
    let color="var(--primary)";
    if(score>=12){txt="Tr√®s bon niveau : tu diff√©rencies bien les dangers des atteintes √† la sant√©.";color="var(--success)";}
    else if(score>=8){txt="Niveau correct : quelques confusions √† corriger avec les explications.";color="var(--warning)";}
    else{txt="Niveau √† renforcer : reprends les d√©finitions et les corrections pour chaque exercice.";color="var(--danger)";}
    box.style.borderLeftColor=color;
    box.textContent="Commentaire : "+txt;
  }

  function corrigerTout(){
    const s1=checkExo1();
    const s2=checkExo2();
    const s3=checkExo3();
    const s4=checkExo4();
    checkExo5();
    const total=s1+s2+s3+s4;
    document.getElementById("final-score").textContent=total+" / "+MAX_SCORE;
    document.getElementById("zone-explication").style.display="block";
    globalMessage(total);
    window.scrollTo({top:document.querySelector(".score-box").offsetTop-8,behavior:"smooth"});
  }

  function resetAll(){
    document.querySelectorAll('input[type="radio"]').forEach(r=>r.checked=false);
    ["e3s1","e3s2","e3s3"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("e4t1").value="";
    document.getElementById("e4t2").value="";
    document.getElementById("e5txt").value="";
    const source=document.querySelector("#zone-source .drag-items");
    document.querySelectorAll("#exo2 .item").forEach(it=>{it.classList.remove("selected");source.appendChild(it);});
    document.querySelectorAll(".feedback").forEach(f=>{f.style.display="none";f.textContent="";});
    document.querySelectorAll(".correction").forEach(c=>c.style.display="none");
    document.getElementById("final-score").textContent="-- / "+MAX_SCORE;
    document.getElementById("zone-explication").style.display="none";
    const gm=document.getElementById("global-msg");gm.style.display="none";gm.textContent="";
    window.scrollTo({top:0,behavior:"smooth"});
  }

  document.addEventListener("DOMContentLoaded",()=>{
    setupDragClick();
    document.getElementById("btn-corriger").addEventListener("click",corrigerTout);
    document.getElementById("btn-reset").addEventListener("click",resetAll);
  });

  function getScoreFinalString(){
    const el=document.getElementById("final-score");
    return el ? (el.textContent||"").trim() : "";
  }
</script>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const nomEl = document.getElementById("pse-eleve-nom");
  const classeEl = document.getElementById("pse-eleve-classe");
  const btnEnv = document.getElementById("pse-btn-envoyer");
  const msg = document.getElementById("pse-msg");
  const box = document.getElementById("pse-envoi-prof");

  const LS_NOM = "pse_nom_eleve";
  const LS_CLASSE = "pse_classe_eleve";
  const LS_SENT_PREFIX = "pse_sent_";

  function pageKey(){
    const k = (location.pathname+"|"+document.title).toLowerCase();
    return LS_SENT_PREFIX + btoa(unescape(encodeURIComponent(k))).slice(0,32);
  }

  function initLocal(){
    try{
      const n=localStorage.getItem(LS_NOM);
      const c=localStorage.getItem(LS_CLASSE);
      if(n) nomEl.value=n;
      if(c) classeEl.value=c;
    }catch(e){}
  }
  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded",initLocal); else initLocal();

  function setSending(s){
    btnEnv.disabled=s;
    btnEnv.style.opacity=s?".7":"1";
    btnEnv.style.cursor=s?"not-allowed":"pointer";
  }

  btnEnv.addEventListener("click", async ()=>{
    const nom=(nomEl.value||"").trim();
    const classe=(classeEl.value||"").trim();
    if(!nom || !classe){
      msg.style.color="#b91c1c";
      msg.textContent="√âcris ton nom et choisis ta classe.";
      return;
    }
    const sentKey=pageKey();
    try{
      if(localStorage.getItem(sentKey)==="1"){
        msg.style.color="#15803d";
        msg.textContent="D√©j√† envoy√© pour cette activit√©.";
        return;
      }
    }catch(e){}

    try{
      localStorage.setItem(LS_NOM,nom);
      localStorage.setItem(LS_CLASSE,classe);
    }catch(e){}

    setSending(true);
    msg.style.color="#0369a1";
    msg.textContent="Envoi en cours‚Ä¶";

    try{
      const parts = nom.split(/\s+/);
      const prenom = parts.shift() || "";
      const nomFamille = parts.join(" ") || prenom;

      await addDoc(collection(db,"bacpro"),{
        meta:{
          createdAt:new Date().toISOString(),
          nom:nomFamille,
          prenom:prenom,
          classe:classe,
          type:"exercice",
          support:"Danger_atteinte_test2"
        },
        resultat:{
          score:getScoreFinalString() || "Non corrig√©",
          url:location.href,
          titre:document.title
        }
      });

      try{localStorage.setItem(sentKey,"1");}catch(e){}
      msg.style.color="#16a34a";
      msg.textContent="R√©ponse envoy√©e au professeur ‚úÖ";
      setTimeout(()=>{box.style.display="none";},900);
    }catch(e){
      console.error(e);
      msg.style.color="#b91c1c";
      msg.textContent="Erreur d‚Äôenvoi : v√©rifie la connexion et r√©essaie.";
      setSending(false);
    }
  });
</script>

</body>
</html>
