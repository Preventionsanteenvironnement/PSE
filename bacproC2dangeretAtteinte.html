<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danger et Atteinte √† la Sant√© - Fiche P√©dagogique PSE</title>
    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #f0f8ff;
            --danger-color: #dc3545;
            --health-color: #28a745;
            --info-color: #ffc107;
            --text-color: #333;
            --border-radius: 8px;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 15px;
            background-color: #f4f7f6;
            color: var(--text-color);
        }

        .container {
            max-width: 900px;
            margin: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-top: 20px;
        }

        h1 {
            text-align: center;
            font-size: 1.8em;
            background-color: var(--secondary-color);
            padding: 10px;
            border-radius: var(--border-radius);
            border-bottom: none;
        }

        .definition-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            border-left: 5px solid;
        }

        .danger-def {
            border-color: var(--danger-color);
            background-color: #fde0e3;
        }

        .health-def {
            border-color: var(--health-color);
            background-color: #e6f7e8;
        }

        .exercice {
            margin: 25px 0;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: var(--border-radius);
            background-color: var(--secondary-color);
        }

        .exercice h3 {
            margin-top: 0;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .points {
            font-size: 0.8em;
            color: #666;
            font-weight: normal;
        }

        .correction {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--info-color);
            border: 1px solid #e0ad00;
            border-radius: 4px;
            display: none; 
        }

        .correction strong {
            color: var(--primary-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s;
            font-weight: bold;
            display: inline-block;
        }

        button:hover {
            background-color: #004494;
        }

        .score-zone {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border: 3px solid var(--health-color);
            border-radius: var(--border-radius);
            background-color: #e6f7e8;
        }

        #final-score {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--danger-color);
            margin: 15px 0;
        }

        .drop-zone {
            border: 2px dashed #0056b3;
            padding: 10px;
            min-height: 50px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: center;
            background-color: white;
            min-width: 45%;
        }

        .draggable-item {
            display: inline-block;
            background-color: #f7f7f7;
            padding: 5px 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: move;
            user-select: none;
        }

        .danger-item { background-color: var(--danger-color); color: white; }
        .health-item { background-color: var(--health-color); color: white; }

        .feedback { 
            margin-top: 10px; 
            font-weight: bold; 
            padding: 8px;
            border-radius: 4px;
            display: none;
        } 
        .feedback.correct { background-color: #d4edda; color: var(--health-color); }
        .feedback.partial { background-color: #fff3cd; color: #8a6d00; }
        .feedback.incorrect { background-color: #f8d7da; color: var(--danger-color); }

        input[type="text"], textarea, select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 90%;
            box-sizing: border-box;
        }
        
        .reset-button {
            background-color: #6c757d;
            margin-top: 20px;
        }
        .reset-button:hover {
            background-color: #5a6268;
        }

        .exo1-columns {
            display: flex;
            justify-content: space-around;
            gap: 12px;
        }
        .exo1-col {
            width: 45%;
        }

        .touch-hint {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-left: 5px solid var(--primary-color);
            background: #ffffff;
            border-radius: 6px;
        }

        .selected {
            outline: 3px solid rgba(0, 86, 179, 0.35);
            border-color: var(--primary-color);
        }

        #global-message {
            display: none;
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            text-align: left;
            background: #ffffff;
            border: 1px solid rgba(0,0,0,0.12);
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 14px; }
            h1 { font-size: 1.4em; }
            .exo1-columns { flex-direction: column; }
            .exo1-col { width: 100% !important; }
            .drop-zone { min-width: 100% !important; }
            .touch-hint { display: block; }
        }

        @media (hover: none) and (pointer: coarse) {
            .touch-hint { display: block; }
            .draggable-item { cursor: pointer; }
        }

        /* --- Bloc envoi prof (ajout) --- */
        #pse-envoi-prof{
          margin: 40px auto 20px;
          max-width: 600px;
          padding: 20px;
          background: #f0f9ff;
          border: 2px solid #0ea5e9;
          border-radius: 15px;
          font-family: sans-serif;
          text-align: center;
          box-shadow: 0 4px 15px rgba(0,0,0,.1);
        }
        #pse-envoi-prof .row{
          display:flex;
          gap:10px;
          flex-wrap:wrap;
          justify-content:center;
        }
        #pse-eleve-nom{
          padding:10px;
          border:1px solid #ccc;
          border-radius:8px;
          flex:1;
          min-width:150px;
        }
        #pse-eleve-classe{
          padding:10px;
          border:1px solid #ccc;
          border-radius:8px;
        }
        #pse-btn-envoyer{
          margin-top:15px;
          padding:12px 25px;
          background:#0284c7;
          color:#fff;
          border:none;
          border-radius:50px;
          font-weight:700;
          cursor:pointer;
          font-size:1em;
          transition:.3s;
        }
        #pse-msg{
          margin-top:15px;
          font-weight:700;
          min-height:20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üéØ Danger et atteinte √† la Sant√© ü§ï</h1>
    <p>Objectif : Diff√©rencier la <strong>CAUSE (Danger)</strong> de la <strong>CONS√âQUENCE (Atteinte √† la Sant√©)</strong>.</p>

    <h2>1. Rappels des D√©finitions PSE</h2>
    <div class="definition-box danger-def">
        <h3>üö® DANGER : La CAUSE</h3>
        <p>C'est tout ce qui peut <strong>provoquer</strong> une blessure ou une maladie (ex: couteau, sol glissant, bruit).</p>
    </div>
    <div class="definition-box health-def">
        <h3>ü©∫ ATTEINTE √Ä LA SANT√â : La CONS√âQUENCE</h3>
        <p>C'est le dommage qui arrive <strong>sur le corps</strong> (blessure ou maladie) (ex: coupure, br√ªlure, mal de dos, intoxication).</p>
    </div>

    <hr>

    <h2>2. Les 6 Exercices (Total : 15 Points)</h2>
    
    <div id="exercices-container">
        <div class="exercice" id="exo1">
            <h3>Exercice 1 : Classification Glisser-D√©poser <span class="points">(5 points)</span></h3>
            <p>Glisse chaque √©l√©ment dans la bonne cat√©gorie. (1 point par bonne r√©ponse)</p>
            <div class="touch-hint">
                Sur t√©l√©phone ou tablette : touche un √©l√©ment pour le s√©lectionner, puis touche la zone o√π tu veux le placer (Danger, Atteinte, ou zone de d√©part).
            </div>

            <h4 style="margin-top: 15px;">Zone de d√©part</h4>
            <div class="drop-zone" id="drag-source-1" data-target="source" style="display: flex; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                <div class="draggable-item" draggable="true" data-type="danger" id="item1-1">Cartons en hauteur</div>
                <div class="draggable-item" draggable="true" data-type="health" id="item1-2">Fracture</div>
                <div class="draggable-item" draggable="true" data-type="danger" id="item1-3">Posture courb√©e</div>
                <div class="draggable-item" draggable="true" data-type="health" id="item1-4">Mal de dos</div>
                <div class="draggable-item" draggable="true" data-type="danger" id="item1-5">Produit corrosif</div>
            </div>

            <div class="exo1-columns">
                <div class="exo1-col">
                    <h4>DANGER (La CAUSE)</h4>
                    <div class="drop-zone" id="drop-danger-1" data-target="danger" aria-label="Zone Danger (Cause)"></div>
                </div>
                <div class="exo1-col">
                    <h4>ATTEINTE √Ä LA SANT√â (La CONS√âQUENCE)</h4>
                    <div class="drop-zone" id="drop-health-1" data-target="health" aria-label="Zone Atteinte √† la sant√© (Cons√©quence)"></div>
                </div>
            </div>

            <div class="feedback" id="feedback-exo1"></div>
            <div class="correction" id="correction-exo1">
                <strong>Correction d√©taill√©e :</strong> Les Dangers sont la cause potentielle (Cartons en hauteur, Posture courb√©e, Produit corrosif). Les Atteintes sont les cons√©quences sur le corps (Fracture, Mal de dos).
            </div>
        </div>

        <div class="exercice" id="exo2">
            <h3>Exercice 2 : QCM - Le Danger <span class="points">(2 points)</span></h3>
            <p>Dans un chantier, un marteau est laiss√© au bord d'un √©chafaudage. Quel est le <strong>Danger</strong> ?</p>

            <fieldset style="border:none; padding:0; margin:0;">
                <legend style="position:absolute; left:-9999px;">QCM Exercice 2</legend>
                <label for="qcm2a"><input type="radio" name="qcm2" value="A" id="qcm2a"> A. La bosse sur la t√™te.</label><br>
                <label for="qcm2b"><input type="radio" name="qcm2" value="B" id="qcm2b"> B. Le marteau en √©quilibre.</label><br>
                <label for="qcm2c"><input type="radio" name="qcm2" value="C" id="qcm2c"> C. La fatigue de l'ouvrier.</label>
            </fieldset>

            <div class="feedback" id="feedback-exo2"></div>
            <div class="correction" id="correction-exo2">
                <strong>Correction d√©taill√©e : R√©ponse B.</strong> Le marteau en √©quilibre est la CAUSE (Danger de chute d'objet). La bosse est la CONS√âQUENCE (Atteinte √† la Sant√©).
            </div>
        </div>

        <div class="exercice" id="exo3">
            <h3>Exercice 3 : Vrai ou Faux <span class="points">(1 point)</span></h3>
            <p>Le fait de devoir faire le m√©nage trop rapidement (pression) est une <strong>Atteinte √† la Sant√©</strong>.</p>

            <fieldset style="border:none; padding:0; margin:0;">
                <legend style="position:absolute; left:-9999px;">Vrai ou Faux Exercice 3</legend>
                <label for="vf3v"><input type="radio" name="vf3" value="V" id="vf3v"> Vrai</label><br>
                <label for="vf3f"><input type="radio" name="vf3" value="F" id="vf3f"> Faux</label>
            </fieldset>

            <div class="feedback" id="feedback-exo3"></div>
            <div class="correction" id="correction-exo3">
                <strong>Correction d√©taill√©e : R√©ponse Faux.</strong> La pression/rapidit√© est un <strong>Danger</strong> (Danger li√© √† l'organisation du travail, la CAUSE). L'atteinte serait le stress ou l'√©puisement (la CONS√âQUENCE).
            </div>
        </div>

        <div class="exercice" id="exo4">
            <h3>Exercice 4 : Compl√©ter l'Association <span class="points">(2 points)</span></h3>
            <p>Associe le Danger (Cause) √† l'Atteinte (Cons√©quence) :</p>
            <ol>
                <li>Un √©quipement qui fait beaucoup de bruit (Danger) peut provoquer une 
                    <label for="select4-1" style="position:absolute; left:-9999px;">Choix 1</label>
                    <select id="select4-1">
                        <option value="">Choisir...</option>
                        <option value="surdit√©">surdit√©</option>
                        <option value="chute">chute</option>
                        <option value="maladie">maladie</option>
                    </select> (Atteinte).
                </li>
                <li>Un sol avec une flaque d'huile (Danger) peut provoquer une 
                    <label for="select4-2" style="position:absolute; left:-9999px;">Choix 2</label>
                    <select id="select4-2">
                        <option value="">Choisir...</option>
                        <option value="coupure">coupure</option>
                        <option value="entorse">entorse</option>
                        <option value="br√ªlure">br√ªlure</option>
                    </select> (Atteinte) apr√®s une glissade.
                </li>
            </ol>
            <div class="feedback" id="feedback-exo4"></div>
            <div class="correction" id="correction-exo4">
                <strong>Correction d√©taill√©e :</strong> 1. Surdit√© (cons√©quence du bruit). 2. Entorse (cons√©quence de la glissade).
            </div>
        </div>

        <div class="exercice" id="exo5">
            <h3>Exercice 5 : Identifier les deux notions <span class="points">(3 points)</span></h3>
            <p>Un cuisinier se coupe le doigt en pr√©parant des l√©gumes.</p>
            <p>Le <strong>Danger</strong> (la cause) est le 
                <label for="text5-1" style="position:absolute; left:-9999px;">Danger</label>
                <input type="text" id="text5-1" placeholder="Danger"> 
                et l'<strong>Atteinte</strong> (la cons√©quence) est la 
                <label for="text5-2" style="position:absolute; left:-9999px;">Atteinte</label>
                <input type="text" id="text5-2" placeholder="Atteinte">.
            </p>
            <div class="feedback" id="feedback-exo5"></div>
            <div class="correction" id="correction-exo5">
                <strong>Correction d√©taill√©e :</strong> Danger : Couteau / Lame (la CAUSE). Atteinte : Coupure / L√©sion (la CONS√âQUENCE sur le corps).
            </div>
        </div>

        <div class="exercice" id="exo6">
            <h3>Exercice 6 : √âcrire l'Atteinte (Phrase simple) <span class="points">(2 points)</span></h3>
            <p><strong>Sc√©nario :</strong> Un agent de logistique utilise un transpalette dont les roues sont bloqu√©es, il doit forcer pour le d√©placer.</p>
            <p>√âcris le nom de l'<strong>Atteinte √† la Sant√©</strong> (cons√©quence) la plus probable √† long terme sur son corps :</p>
            <label for="text6-1" style="position:absolute; left:-9999px;">Atteinte √† la sant√©</label>
            <textarea id="text6-1" rows="2" style="width: 100%;" placeholder="L'atteinte √† la sant√© est..."></textarea>
            <div class="feedback" id="feedback-exo6"></div>
            <div class="correction" id="correction-exo6">
                <strong>Correction d√©taill√©e :</strong> L'atteinte √† la sant√© est un <strong>mal de dos</strong> ou une <strong>lombalgie</strong> (caus√©e par l'effort excessif et la posture forc√©e).
            </div>
        </div>
    </div>

    <hr>

    <div class="score-zone">
        <h2>üìä Ton Bilan Final</h2>
        <p>Clique ci-dessous pour v√©rifier tes r√©ponses, obtenir ton score final sur 15 et afficher les corrections d√©taill√©es.</p>
        <button type="button" onclick="calculateScoreAndDisplayResults()">Calculer mon Score et Afficher la Correction</button>
        <p id="final-score">-- / 15 Points</p>

        <div id="global-message"></div>

        <div id="score-explanation" style="display:none; text-align: left; margin-top: 20px;">
            <h3>Explication de ton Score</h3>
            <p>Ce score mesure ta capacit√© √† distinguer la <strong>CAUSE</strong> (Danger) de la <strong>CONS√âQUENCE</strong> (Atteinte √† la Sant√©) :</p>
            <ul>
                <li><strong>12 √† 15 points (Bien Ma√Ætris√©)</strong> : F√©licitations ! Tu fais parfaitement la distinction.</li>
                <li><strong>8 √† 11 points (√Ä Am√©liorer)</strong> : Tu as les bases, mais tu inverses parfois les notions. Revois les d√©finitions et les corrections.</li>
                <li><strong>Moins de 8 points (Bases √† Consolider)</strong> : Il est important de bien relire les d√©finitions. La cause (Danger) vient toujours avant la cons√©quence (Atteinte).</li>
            </ul>
        </div>

        <button type="button" class="reset-button" onclick="resetAll()">R√©initialiser tous les exercices</button>
    </div>

</div>

<script>
    const maxScore = 15;

    function normalizeText(str) {
        return (str || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[‚Äô']/g, "'")
            .replace(/\s+/g, " ")
            .trim();
    }

    function showGlobalMessage(html, type = "info") {
        const box = document.getElementById("global-message");
        box.style.display = "block";
        box.innerHTML = html;
        box.style.borderLeft = "6px solid " + (type === "good" ? "var(--health-color)" : (type === "bad" ? "var(--danger-color)" : "var(--primary-color)"));
    }

    function setFeedback(el, html, cls) {
        el.innerHTML = html;
        el.className = "feedback " + cls;
    }

    function checkExo1(pointsTotal = 5) {
        const dropDanger = document.getElementById("drop-danger-1");
        const dropHealth = document.getElementById("drop-health-1");
        const source = document.getElementById("drag-source-1");
        let correctCount = 0;
        let totalItemsPlaced = 0;

        Array.from(dropDanger.children).forEach(item => {
            totalItemsPlaced++;
            if (item.getAttribute("data-type") === "danger") {
                correctCount++;
                item.classList.add("health-item");
            } else {
                item.classList.add("danger-item");
            }
        });

        Array.from(dropHealth.children).forEach(item => {
            totalItemsPlaced++;
            if (item.getAttribute("data-type") === "health") {
                correctCount++;
                item.classList.add("health-item");
            } else {
                item.classList.add("danger-item");
            }
        });

        const totalItemsAll = document.querySelectorAll("#exo1 .draggable-item").length;
        const remainingInSource = Array.from(source.children).filter(n => n.classList && n.classList.contains("draggable-item")).length;
        const totalMoved = totalItemsAll - remainingInSource;

        const feedback = document.getElementById("feedback-exo1");

        if (totalMoved !== 5 || totalItemsPlaced !== 5) {
            setFeedback(feedback, `‚ö†Ô∏è Exercice incomplet (plac√© ${totalItemsPlaced}/5 √©l√©ments). 0 point.`, "incorrect");
            return 0;
        }

        const score = correctCount;

        if (score === pointsTotal) {
            setFeedback(feedback, `‚úÖ <strong>CORRECT</strong> ! Tu as obtenu ${score}/${pointsTotal} points.`, "correct");
        } else if (score > 0) {
            setFeedback(feedback, `üü° <strong>PARTIEL</strong> : ${score}/${pointsTotal} points. R√©vois les √©l√©ments en rouge.`, "partial");
        } else {
            setFeedback(feedback, `‚ùå <strong>FAUX</strong> : Tu as obtenu 0/${pointsTotal} points.`, "incorrect");
        }
        return score;
    }

    function checkExo2(pointsTotal = 2) {
        const selected = document.querySelector(`input[name="qcm2"]:checked`);
        const feedback = document.getElementById("feedback-exo2");
        let score = 0;

        if (selected && selected.value === "B") {
            score = pointsTotal;
            setFeedback(feedback, `‚úÖ <strong>CORRECT</strong> ! Tu as obtenu ${score}/${pointsTotal} points.`, "correct");
        } else {
            setFeedback(feedback, `‚ùå <strong>FAUX</strong> : Tu as obtenu 0/${pointsTotal} points. La bonne r√©ponse √©tait B.`, "incorrect");
        }
        return score;
    }

    function checkExo3(pointsTotal = 1) {
        const selected = document.querySelector(`input[name="vf3"]:checked`);
        const feedback = document.getElementById("feedback-exo3");
        let score = 0;

        if (selected && selected.value === "F") {
            score = pointsTotal;
            setFeedback(feedback, `‚úÖ <strong>CORRECT</strong> ! Tu as obtenu ${score}/${pointsTotal} point.`, "correct");
        } else {
            setFeedback(feedback, `‚ùå <strong>FAUX</strong> : Tu as obtenu 0/${pointsTotal} point. La bonne r√©ponse √©tait Faux.`, "incorrect");
        }
        return score;
    }

    function checkExo4(pointsTotal = 2) {
        const select1 = document.getElementById("select4-1").value;
        const select2 = document.getElementById("select4-2").value;
        const feedback = document.getElementById("feedback-exo4");
        let correctCount = 0;

        if (select1 === "surdit√©") correctCount++;
        if (select2 === "entorse") correctCount++;
        
        const score = correctCount;

        if (score === pointsTotal) {
            setFeedback(feedback, `‚úÖ <strong>CORRECT</strong> ! Tu as obtenu ${score}/${pointsTotal} points.`, "correct");
        } else if (score > 0) {
            setFeedback(feedback, `üü° <strong>PARTIEL</strong> : ${score}/${pointsTotal} points. Revois l'association manquante.`, "partial");
        } else {
            setFeedback(feedback, `‚ùå <strong>FAUX</strong> : Tu as obtenu 0/${pointsTotal} points.`, "incorrect");
        }
        return score;
    }

    function checkExo5(pointsTotal = 3) {
        const text1 = normalizeText(document.getElementById("text5-1").value);
        const text2 = normalizeText(document.getElementById("text5-2").value);
        const feedback = document.getElementById("feedback-exo5");
        let score = 0;

        const correct1 = ["couteau", "lame", "ustensile tranchant", "objet tranchant", "outil tranchant"];
        const correct2 = ["coupure", "lesion", "blessure", "plaie"];

        const isCorrect1 = correct1.some(val => text1.includes(normalizeText(val)));
        const isCorrect2 = correct2.some(val => text2.includes(normalizeText(val)));

        if (isCorrect1) score++;
        if (isCorrect2) score += 2;

        if (score === pointsTotal) {
            setFeedback(feedback, `‚úÖ <strong>CORRECT</strong> ! Tu as obtenu ${score}/${pointsTotal} points.`, "correct");
        } else if (score > 0) {
            setFeedback(feedback, `üü° <strong>PARTIEL</strong> : ${score}/${pointsTotal} points. V√©rifie si tu n'as pas invers√© le Danger (Cause) et l'Atteinte (Cons√©quence).`, "partial");
        } else {
            setFeedback(feedback, `‚ùå <strong>FAUX</strong> : Tu as obtenu 0/${pointsTotal} points.`, "incorrect");
        }
        return score;
    }

    function checkExo6(pointsTotal = 2) {
        const text = normalizeText(document.getElementById("text6-1").value);
        const feedback = document.getElementById("feedback-exo6");
        let score = 0;

        const accepted = [
            "mal de dos", "dos", "douleur au dos", "douleur dos", "douleur lombaire", "lombaire", "lombalgie",
            "tendinite", "tendinite", "trouble musculo squelettique", "tms", "musculaire", "douleur musculaire"
        ];

        if (accepted.some(val => text.includes(normalizeText(val)))) {
            score = pointsTotal;
            setFeedback(feedback, `‚úÖ <strong>CORRECT</strong> ! Tu as obtenu ${score}/${pointsTotal} points.`, "correct");
        } else {
            setFeedback(feedback, `‚ùå <strong>FAUX</strong> : Tu as obtenu 0/${pointsTotal} points. L'atteinte √©tait li√©e au dos / aux efforts physiques (ex : mal de dos, lombalgie).`, "incorrect");
        }
        return score;
    }

    function calculateScoreAndDisplayResults() {
        let totalScore = 0;

        document.querySelectorAll(".draggable-item").forEach(item => {
            item.classList.remove("danger-item", "health-item");
        });

        totalScore += checkExo1(5);
        totalScore += checkExo2(2);
        totalScore += checkExo3(1);
        totalScore += checkExo4(2);
        totalScore += checkExo5(3);
        totalScore += checkExo6(2);

        document.getElementById("final-score").textContent = `${totalScore} / ${maxScore} Points`;

        document.querySelectorAll(".feedback").forEach(f => f.style.display = "block");
        document.querySelectorAll(".correction").forEach(c => c.style.display = "block");
        document.getElementById("score-explanation").style.display = "block";

        const type = totalScore >= 12 ? "good" : (totalScore >= 8 ? "info" : "bad");
        showGlobalMessage(`Ton score final est de <strong>${totalScore} / 15</strong>. Les r√©sultats d√©taill√©s sont affich√©s pour chaque exercice.`, type);
        window.scrollTo({ top: document.querySelector(".score-zone").offsetTop - 10, behavior: "smooth" });
    }

    let draggedItem = null;

    function enableDesktopDnD() {
        document.querySelectorAll(".draggable-item").forEach(item => {
            item.addEventListener("dragstart", (e) => {
                draggedItem = e.target;
                e.dataTransfer.setData("text/plain", e.target.id);
                setTimeout(() => e.target.style.opacity = "0.5", 0);
            });

            item.addEventListener("dragend", (e) => {
                e.target.style.opacity = "1";
                draggedItem = null;
            });
        });

        document.querySelectorAll(".drop-zone").forEach(zone => {
            zone.addEventListener("dragover", (e) => {
                e.preventDefault();
                zone.style.backgroundColor = "#e0f7fa";
            });

            zone.addEventListener("dragleave", () => {
                zone.style.backgroundColor = "white";
            });

            zone.addEventListener("drop", (e) => {
                e.preventDefault();
                zone.style.backgroundColor = "white";
                if (draggedItem) {
                    if (draggedItem.parentNode && draggedItem.parentNode.classList.contains("drop-zone")) {
                        draggedItem.parentNode.removeChild(draggedItem);
                    }
                    zone.appendChild(draggedItem);
                    draggedItem.classList.remove("danger-item", "health-item");
                }
            });
        });
    }

    let selectedItem = null;

    function clearSelection() {
        document.querySelectorAll(".draggable-item").forEach(i => i.classList.remove("selected"));
        selectedItem = null;
    }

    function enableTouchFallback() {
        document.querySelectorAll(".draggable-item").forEach(item => {
            item.setAttribute("draggable", "false");
            item.addEventListener("click", (e) => {
                const target = e.currentTarget;
                if (selectedItem === target) {
                    clearSelection();
                    return;
                }
                clearSelection();
                selectedItem = target;
                target.classList.add("selected");
            });
        });

        document.querySelectorAll(".drop-zone").forEach(zone => {
            zone.addEventListener("click", () => {
                if (!selectedItem) return;
                zone.appendChild(selectedItem);
                selectedItem.classList.remove("danger-item", "health-item");
                clearSelection();
            });
        });
    }

    const isTouch = window.matchMedia && window.matchMedia("(hover: none) and (pointer: coarse)").matches;

    if (isTouch) {
        enableTouchFallback();
    } else {
        enableDesktopDnD();
    }

    function resetAll() {
        document.getElementById("text5-1").value = "";
        document.getElementById("text5-2").value = "";
        document.getElementById("text6-1").value = "";
        document.getElementById("select4-1").selectedIndex = 0;
        document.getElementById("select4-2").selectedIndex = 0;

        document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);

        const source = document.getElementById("drag-source-1");
        Array.from(document.querySelectorAll(".draggable-item")).forEach(item => {
            item.classList.remove("danger-item", "health-item", "selected");
            source.appendChild(item);
        });

        document.getElementById("final-score").textContent = `-- / ${maxScore} Points`;

        document.querySelectorAll(".feedback").forEach(f => {
            f.style.display = "none";
            f.innerHTML = "";
            f.className = "feedback";
        });
        document.querySelectorAll(".correction").forEach(c => c.style.display = "none");
        document.getElementById("score-explanation").style.display = "none";

        const msg = document.getElementById("global-message");
        msg.style.display = "none";
        msg.innerHTML = "";

        clearSelection();
        window.scrollTo({ top: 0, behavior: "smooth" });
    }
</script>

<!-- Bloc envoi prof (ajout) -->
<div id="pse-envoi-prof">
  <h3 style="margin-top:0;color:#0369a1">üöÄ Enregistrer mon r√©sultat pour le Prof</h3>

  <div class="row">
    <input type="text" id="pse-eleve-nom" placeholder="Ton Pr√©nom et NOM">
    <select id="pse-eleve-classe">
      <option value="">-- Ta classe --</option>
      <option value="2nde Bac Pro">2nde Bac Pro</option>
      <option value="1√®re Bac Pro">1√®re Bac Pro</option>
      <option value="Tle Bac Pro">Tle Bac Pro</option>
      <option value="CAP 1">CAP 1</option>
      <option value="CAP 2">CAP 2</option>
      <option value="Autre">Autre</option>
    </select>
  </div>

  <button id="pse-btn-envoyer">Envoyer au Professeur üì§</button>

  <div id="pse-msg"></div>
</div>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const box = document.getElementById("pse-envoi-prof");
  const nomEl = document.getElementById("pse-eleve-nom");
  const classeEl = document.getElementById("pse-eleve-classe");
  const btn = document.getElementById("pse-btn-envoyer");
  const msg = document.getElementById("pse-msg");

  const LS_NOM = "pse_nom_eleve";
  const LS_CLASSE = "pse_classe_eleve";
  const LS_SENT_PREFIX = "pse_sent_";

  function safeInit(){
    const n = localStorage.getItem(LS_NOM);
    const c = localStorage.getItem(LS_CLASSE);
    if(n) nomEl.value = n;
    if(c) classeEl.value = c;
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", safeInit);
  else safeInit();

  function getScoreFinal(){
    const elScore2 = document.getElementById("final-score");
    if(elScore2) return (elScore2.textContent || "").trim();
    return "Termin√©";
  }

  function pageKey(){
    const k = (location.pathname + "|" + document.title).toLowerCase();
    return LS_SENT_PREFIX + btoa(unescape(encodeURIComponent(k))).slice(0, 32);
  }

  function setStateSending(sending){
    btn.disabled = sending;
    btn.style.backgroundColor = sending ? "#94a3b8" : "#0284c7";
    btn.style.cursor = sending ? "not-allowed" : "pointer";
  }

  btn.addEventListener("click", async () => {
    const nom = (nomEl.value || "").trim();
    const classe = (classeEl.value || "").trim();

    if(!nom || !classe){
      msg.style.color = "#dc2626";
      msg.textContent = "‚ö†Ô∏è √âcris ton nom et choisis ta classe";
      return;
    }

    const sentKey = pageKey();
    if(localStorage.getItem(sentKey) === "1"){
      msg.style.color = "#0f766e";
      msg.textContent = "‚úÖ D√©j√† envoy√© pour cette activit√©";
      return;
    }

    localStorage.setItem(LS_NOM, nom);
    localStorage.setItem(LS_CLASSE, classe);

    setStateSending(true);
    msg.style.color = "#0284c7";
    msg.textContent = "Envoi en cours...";

    try{
      await addDoc(collection(db, "resultats_eleves"), {
        createdAt: new Date().toISOString(),
        nom,
        classe,
        exercice: document.title,
        url: location.href,
        score: getScoreFinal()
      });

      localStorage.setItem(sentKey, "1");
      msg.style.color = "#16a34a";
      msg.textContent = "‚úÖ Envoy√©";
      setTimeout(() => { if(box) box.style.display = "none"; }, 900);

    }catch(e){
      console.error(e);
      msg.style.color = "#dc2626";
      msg.textContent = "Erreur. V√©rifie ta connexion et r√©essaie.";
      setStateSending(false);
    }
  });
</script>

</body>
</html>
