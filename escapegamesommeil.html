<!doctype html>
<html lang=fr>
<head>
  <meta charset=utf-8>
  <meta name=viewport content=width=device-width,initial-scale=1>
  <title>Mission Sommeil • Escape game</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --text:#f2f5ff;
      --muted:#c7d2fe;
      --line:rgba(255,255,255,.14);
      --ok:#22c55e;
      --no:#ef4444;
      --accent:#60a5fa;
      --focus:#fbbf24;

      --scale:1;
      --spacing:0;
      --lineh:1.45;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --imgzoom:1;
      --pixel:0;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:radial-gradient(1200px 600px at 30% -10%, rgba(96,165,250,.22), transparent 60%),
                 radial-gradient(900px 500px at 110% 10%, rgba(34,197,94,.16), transparent 55%),
                 linear-gradient(180deg,#081026 0%, #0b1220 60%, #081026 100%);
      color:var(--text);
      line-height:var(--lineh);
      font-size:calc(18px * var(--scale));
      letter-spacing:calc(0px + var(--spacing));
      transform:scale(calc(1 + (var(--pixel) * 0.06)));
      transform-origin:top center;
    }

    a{color:inherit}
    .skip{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip:focus{
      left:12px;top:12px;width:auto;height:auto;z-index:1000;
      background:var(--focus);color:#111827;padding:10px 12px;border-radius:12px;
      outline:4px solid rgba(251,191,36,.35)
    }

    header{max-width:1150px;margin:0 auto;padding:18px 16px 10px}
    .topRow{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pills{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(96,165,250,.14);
      border:1px solid rgba(96,165,250,.35);
      padding:8px 12px;border-radius:999px;
      font-weight:900
    }
    h1{margin:10px 0 0;font-size:calc(34px * var(--scale));letter-spacing:.2px}
    .sub{margin:6px 0 0;color:var(--muted);max-width:920px}

    main{max-width:1150px;margin:0 auto;padding:10px 16px 28px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(16,26,47,.92);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.28);
    }
    .sectionTitle{margin:0 0 10px;font-size:calc(22px * var(--scale));font-weight:900}
    .muted{color:var(--muted)}
    .small{color:var(--muted);font-size:calc(14px * var(--scale))}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=text]{
      width:min(420px,100%);
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      font-size:calc(18px * var(--scale));
      outline:none;
    }
    input[type=text]:focus{outline:4px solid rgba(96,165,250,.25);border-color:rgba(96,165,250,.6)}

    button,.btn{
      border:1px solid rgba(96,165,250,.45);
      background:rgba(96,165,250,.18);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size:calc(16px * var(--scale));
      user-select:none;
    }
    button:focus,.btn:focus{outline:4px solid rgba(251,191,36,.35);outline-offset:2px}
    .secondary{background:rgba(255,255,255,.06);border:1px solid var(--line)}
    .danger{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35)}
    button:disabled,.btn[aria-disabled=true]{opacity:.45;cursor:not-allowed;filter:saturate(.6)}
    .btn[aria-disabled=true]{pointer-events:none}

    .hud{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
    }
    .kpi{display:flex;gap:10px;flex-wrap:wrap;align-items:center;font-weight:900}
    .kpi span{color:var(--muted);font-weight:800}
    .bar{
      flex:1;min-width:220px;height:14px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar>div{height:100%;width:0%;background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(96,165,250,.95))}
    .enc{margin:10px 0 0;font-weight:900}
    .enc.ok{color:#dcfce7}
    .enc.mid{color:#fde68a}
    .enc.low{color:#fecaca}

    .map{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:780px){.map{grid-template-columns:1fr}}
    .node{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
    }
    .nodeTop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .num{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background:rgba(96,165,250,.18);
      border:1px solid rgba(96,165,250,.35);
      font-weight:1000;
      flex:0 0 auto;
    }
    .node h3{margin:0;font-size:calc(18px * var(--scale))}
    .node p{margin:6px 0 0;color:var(--muted)}
    .nodeActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .status{
      margin-top:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      color:var(--muted);
      font-weight:800;
    }
    .status.ok{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.10);color:#dcfce7}
    .status.no{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.08);color:#fee2e2}

    .panel{display:none}
    .panel.active{display:block}
    .panelTitle{margin:0 0 6px;font-weight:1000;font-size:calc(22px * var(--scale))}
    .panelSub{margin:0 0 12px;color:var(--muted)}

    .imgWrap{
      width:100%;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background:#0b1220;
      image-rendering:pixelated;
    }
    .imgWrap img{
      width:100%;
      height:auto;
      display:block;
      transform-origin:center;
      transform:scale(var(--imgzoom));
    }

    .qBlock{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
    }
    .qTitle{margin:0 0 10px;font-weight:1000}
    .choices{display:grid;gap:10px}
    @media (min-width:780px){.choices.two{grid-template-columns:1fr 1fr}}
    .choice{
      display:flex;gap:12px;align-items:flex-start;
      padding:10px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
    }
    .choice input{width:22px;height:22px;accent-color:var(--accent);margin-top:2px}
    .choice label{cursor:pointer;width:100%}
    .choice:focus-within{outline:4px solid rgba(251,191,36,.35);border-color:rgba(251,191,36,.45)}
    .hintBox{
      margin-top:10px;
      padding:10px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      color:var(--muted);
    }

    select{
      width:100%;
      font-size:calc(18px * var(--scale));
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:#0b1220;color:var(--text);
    }
    select:focus{outline:4px solid rgba(251,191,36,.35);border-color:rgba(251,191,36,.45)}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      padding:10px 12px;border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .chip[aria-pressed=true]{
      border-color:rgba(96,165,250,.55);
      background:rgba(96,165,250,.18);
    }

    .slots{display:grid;gap:10px}
    @media (min-width:900px){.slots{grid-template-columns:1fr 1fr}}
    .slot{
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      min-height:84px;
    }
    .slot strong{display:block;margin-bottom:6px}
    .tokens{display:flex;gap:8px;flex-wrap:wrap}
    .token{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      padding:10px 12px;border-radius:14px;
      font-weight:900;
      cursor:grab;
      user-select:none;
    }
    .token:active{cursor:grabbing}
    .slot.over{outline:4px solid rgba(96,165,250,.25);border-color:rgba(96,165,250,.6)}
    .token.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.08)}
    .token.good{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.10)}

    .feedback{
      margin-top:12px;
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:900;
    }
    .feedback.ok{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.10);color:#dcfce7}
    .feedback.no{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.08);color:#fee2e2}

    body.dys{--font: Verdana, Arial, system-ui, sans-serif;--spacing:.6px;--lineh:1.65}
  </style>
</head>

<body>
  <a class=skip href=#contenu>Aller au contenu</a>

  <header>
    <div class=topRow>
      <div class=pills>
        <div class=pill>Module A2</div>
        <div class=pill>Mission Sommeil</div>
        <div class=pill>Escape game</div>
      </div>
      <div class=pill>C1 + C2</div>
    </div>
    <h1>Le coffre du sommeil récupérateur</h1>
    <p class=sub>
      Tu es dans un centre de contrôle du sommeil. Pour ouvrir le coffre final, tu dois gagner 4 badges. Chaque badge te donne un chiffre.
    </p>
  </header>

  <main id=contenu>
    <div class=grid>
      <section class=card aria-label=Jeu>
        <h2 class=sectionTitle>Table de mission</h2>

        <div class=row>
          <div class=small style=font-weight:1000>Prénom</div>
          <input id=prenom type=text autocomplete=given-name placeholder="Écris ton prénom">
          <button id=saveName type=button>OK</button>
          <button id=resetAll class="secondary danger" type=button>Recommencer</button>
        </div>

        <div class=hud style=margin-top:12px>
          <div class=kpi>
            <div>Score <span id=scoreTxt>0/40</span></div>
            <div>•</div>
            <div>Badges <span id=badgeTxt>0/4</span></div>
            <div>•</div>
            <div>Code <span id=codeTxt>____</span></div>
          </div>
          <div class=bar role=progressbar aria-valuemin=0 aria-valuemax=100 aria-valuenow=0>
            <div id=barFill></div>
          </div>
          <button id=goMap class=secondary type=button>Plan des salles</button>
        </div>

        <p id=hello class=muted style=margin:12px 0 0></p>
        <p id=enc class=enc></p>

        <div class=hr></div>

        <div id=mapPanel class="panel active" aria-label="Plan des salles">
          <h3 class=panelTitle>Plan des salles</h3>
          <p class=panelSub>Clique sur une salle. Les suivantes se débloquent quand tu gagnes le badge.</p>

          <div class=map>
            <article class=node>
              <div class=nodeTop>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div class=num aria-hidden=true>1</div>
                  <div>
                    <h3>Salle Écrans</h3>
                    <p>Comprendre le problème du soir</p>
                  </div>
                </div>
              </div>
              <div class=nodeActions>
                <button id=open1 type=button>Entrer</button>
              </div>
              <div id=st1 class=status>À faire</div>
            </article>

            <article class=node>
              <div class=nodeTop>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div class=num aria-hidden=true>2</div>
                  <div>
                    <h3>Salle Horloge</h3>
                    <p>Rythme circadien et mélatonine</p>
                  </div>
                </div>
              </div>
              <div class=nodeActions>
                <button id=open2 type=button disabled>Entrer</button>
              </div>
              <div id=st2 class="status no">Verrouillée</div>
            </article>

            <article class=node>
              <div class=nodeTop>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div class=num aria-hidden=true>3</div>
                  <div>
                    <h3>Salle Cycle</h3>
                    <p>Phases du sommeil et récupération</p>
                  </div>
                </div>
              </div>
              <div class=nodeActions>
                <button id=open3 type=button disabled>Entrer</button>
              </div>
              <div id=st3 class="status no">Verrouillée</div>
            </article>

            <article class=node>
              <div class=nodeTop>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <div class=num aria-hidden=true>4</div>
                  <div>
                    <h3>Salle Solutions</h3>
                    <p>Manque de sommeil + mesures</p>
                  </div>
                </div>
              </div>
              <div class=nodeActions>
                <button id=open4 type=button disabled>Entrer</button>
              </div>
              <div id=st4 class="status no">Verrouillée</div>
            </article>
          </div>

          <div class=qBlock style=margin-top:12px>
            <div class=qTitle>Coffre final</div>
            <div class=small>Quand tu as 4 badges, écris le code pour ouvrir.</div>
            <div class=row style=margin-top:10px>
              <input id=finalCode type=text inputmode=numeric placeholder="Code à 4 chiffres" style="max-width:220px">
              <button id=tryOpen type=button disabled>Ouvrir le coffre</button>
            </div>
            <div id=finalFb class=feedback>Le coffre est fermé.</div>
          </div>
        </div>

        <div id=room1 class=panel aria-label="Salle 1 Écrans">
          <h3 class=panelTitle>Salle Écrans</h3>
          <p class=panelSub>Objectif : repérer le problème et ses indices.</p>

          <div class=imgWrap>
            <img src=apres-diner.jpg alt="Adolescent devant un écran après le dîner.">
          </div>
          <div class=hintBox style=margin-top:10px>
            Le soir, les écrans (smartphone, ordinateur, console) peuvent retarder l endormissement.
            La lumière de l écran fait croire au cerveau que ce n est pas encore la nuit.
          </div>

          <div class=qBlock>
            <div class=qTitle>Défi 1 : trouve la bonne problématique</div>
            <div class=choices>
              <div class=choice>
                <input id=r1q1a type=radio name=r1q1>
                <label for=r1q1a>Les écrans aident toujours à s endormir plus vite</label>
              </div>
              <div class=choice>
                <input id=r1q1b type=radio name=r1q1>
                <label for=r1q1b>Le temps passé sur les écrans le soir peut retarder l endormissement</label>
              </div>
              <div class=choice>
                <input id=r1q1c type=radio name=r1q1>
                <label for=r1q1c>Le sommeil n a aucun lien avec la lumière</label>
              </div>
            </div>
          </div>

          <div class=qBlock>
            <div class=qTitle>Défi 2 : repère les éléments</div>
            <div class=small>Choisis dans les menus. Pas besoin d écrire.</div>

            <div class=choices two style=margin-top:10px>
              <div>
                <div class=small style=font-weight:1000;margin-bottom:6px>Qui est concerné</div>
                <select id=r1qui>
                  <option value=>Je choisis</option>
                  <option value=ados>Les adolescents</option>
                  <option value=bebes>Les bébés</option>
                  <option value=chauffeurs>Les chauffeurs de bus</option>
                </select>
              </div>

              <div>
                <div class=small style=font-weight:1000;margin-bottom:6px>Quoi</div>
                <select id=r1quoi>
                  <option value=>Je choisis</option>
                  <option value=ecrans>Temps passé devant les écrans le soir</option>
                  <option value=sport>Sport avant de dormir</option>
                  <option value=bains>Prendre un bain</option>
                </select>
              </div>

              <div>
                <div class=small style=font-weight:1000;margin-bottom:6px>Comment</div>
                <select id=r1comment>
                  <option value=>Je choisis</option>
                  <option value=lumiere>La lumière de l écran imite la lumière du jour</option>
                  <option value=bruit>Le bruit des oiseaux</option>
                  <option value=froid>Il fait toujours 19 degrés</option>
                </select>
              </div>

              <div>
                <div class=small style=font-weight:1000;margin-bottom:6px>Pourquoi c est un problème</div>
                <select id=r1pourquoi>
                  <option value=>Je choisis</option>
                  <option value=retard>Ça retarde l endormissement</option>
                  <option value=avance>Ça fait dormir trop tôt</option>
                  <option value=rien>Ça ne change rien</option>
                </select>
              </div>
            </div>
          </div>

          <div class=row style=margin-top:12px>
            <button id=check1 type=button>Valider la salle 1</button>
            <button id=back1 class=secondary type=button>Retour au plan</button>
          </div>
          <div id=fb1 class=feedback>Réponds puis valide.</div>
        </div>

        <div id=room2 class=panel aria-label="Salle 2 Horloge">
          <h3 class=panelTitle>Salle Horloge</h3>
          <p class=panelSub>Objectif : comprendre le rythme circadien et la mélatonine.</p>

          <div class=imgWrap>
            <img src=doc-a-rythme-biologique.jpg alt="Schéma jour nuit et mélatonine.">
          </div>

          <div class=hintBox style=margin-top:10px>
            Notre horloge biologique reçoit le signal de la lumière.
            Quand il n y a plus de lumière, le corps augmente la production de mélatonine (hormone du sommeil).
            Le rythme veille sommeil dure 24 heures : on parle de rythme circadien.
          </div>

          <div class=qBlock>
            <div class=qTitle>Défi 1 : appuie sur les bonnes réponses</div>
            <div class=chips role=group aria-label="Choix">
              <button class=chip id=r2c1 aria-pressed=false type=button>24 heures</button>
              <button class=chip id=r2c2 aria-pressed=false type=button>Rythme circadien</button>
              <button class=chip id=r2c3 aria-pressed=false type=button>Mélatonine</button>
              <button class=chip id=r2c4 aria-pressed=false type=button>Vitamine C</button>
            </div>
            <div class=small style=margin-top:8px>Astuce : il y a 3 bonnes réponses.</div>
          </div>

          <div class=qBlock>
            <div class=qTitle>Défi 2 : quel facteur déclenche la mélatonine</div>
            <div class=choices>
              <div class=choice>
                <input id=r2q2a type=radio name=r2q2>
                <label for=r2q2a>La lumière du soleil</label>
              </div>
              <div class=choice>
                <input id=r2q2b type=radio name=r2q2>
                <label for=r2q2b>L absence de lumière</label>
              </div>
              <div class=choice>
                <input id=r2q2c type=radio name=r2q2>
                <label for=r2q2c>Le bruit</label>
              </div>
            </div>
          </div>

          <div class=row style=margin-top:12px>
            <button id=check2 type=button>Valider la salle 2</button>
            <button id=back2 class=secondary type=button>Retour au plan</button>
          </div>
          <div id=fb2 class=feedback>Réponds puis valide.</div>
        </div>

        <div id=room3 class=panel aria-label="Salle 3 Cycle">
          <h3 class=panelTitle>Salle Cycle</h3>
          <p class=panelSub>Objectif : reconstituer le cycle du sommeil.</p>

          <div class=imgWrap>
            <img src=doc-b-cycle-sommeil.jpg alt="Schéma des phases du sommeil et du cycle.">
          </div>

          <div class=hintBox style=margin-top:10px>
            Un cycle dure environ 90 minutes et compte 5 phases.
            Une nuit comprend plusieurs cycles.
          </div>

          <div class=qBlock>
            <div class=qTitle>Défi 1 : place les cartes au bon endroit</div>
            <div class=small>Glisse les cartes dans les zones.</div>

            <div class=slots style=margin-top:10px>
              <div class=slot data-slot=fatigue>
                <strong>Récupération de la fatigue physique</strong>
                <div class=tokens data-target=fatigue></div>
              </div>
              <div class=slot data-slot=mental>
                <strong>Récupération mentale</strong>
                <div class=tokens data-target=mental></div>
              </div>
            </div>

            <div class=tokens style=margin-top:10px id=pool3>
              <div class=token draggable=true data-kind=fatigue>Sommeil lent très profond</div>
              <div class=token draggable=true data-kind=mental>Sommeil paradoxal</div>
              <div class=token draggable=true data-kind=none>Latence</div>
            </div>

            <div class=small style=margin-top:10px>Astuce : une carte ne va dans aucune zone.</div>
          </div>

          <div class=qBlock>
            <div class=qTitle>Défi 2 : nombre de phases et durée</div>
            <div class=choices two>
              <div>
                <div class=small style=font-weight:1000;margin-bottom:6px>Nombre de phases</div>
                <select id=r3phases>
                  <option value=>Je choisis</option>
                  <option value=3>3</option>
                  <option value=5>5</option>
                  <option value=7>7</option>
                </select>
              </div>
              <div>
                <div class=small style=font-weight:1000;margin-bottom:6px>Durée d un cycle</div>
                <select id=r3duree>
                  <option value=>Je choisis</option>
                  <option value=45>45 minutes</option>
                  <option value=90>90 minutes</option>
                  <option value=180>180 minutes</option>
                </select>
              </div>
            </div>
          </div>

          <div class=row style=margin-top:12px>
            <button id=check3 type=button>Valider la salle 3</button>
            <button id=back3 class=secondary type=button>Retour au plan</button>
          </div>
          <div id=fb3 class=feedback>Réponds puis valide.</div>
        </div>

        <div id=room4 class=panel aria-label="Salle 4 Solutions">
          <h3 class=panelTitle>Salle Solutions</h3>
          <p class=panelSub>Objectif : repérer effets et choisir les bonnes habitudes.</p>

          <div class=qBlock>
            <div class=qTitle>Défi 1 : témoignages (choix rapides)</div>
            <div class=small>Pour chaque personne, choisis ce qui correspond.</div>

            <div class=qBlock style="margin-top:10px">
              <div class=row style="justify-content:space-between">
                <div style=font-weight:1000>Sylvie</div>
                <div class=small>Accident au travail</div>
              </div>
              <div class=choices two style=margin-top:10px>
                <div>
                  <div class=small style=font-weight:1000;margin-bottom:6px>Effet principal</div>
                  <select id=sylvieEffet>
                    <option value=>Je choisis</option>
                    <option value=fatigue>Fatigue et baisse de vigilance</option>
                    <option value=joie>Joie et énergie</option>
                    <option value=parfait>Sommeil parfait</option>
                  </select>
                </div>
                <div>
                  <div class=small style=font-weight:1000;margin-bottom:6px>Conséquence pro</div>
                  <select id=sylviePro>
                    <option value=>Je choisis</option>
                    <option value=accident>Accident du travail</option>
                    <option value=promo>Promotion</option>
                    <option value=vacances>Vacances</option>
                  </select>
                </div>
              </div>
            </div>

            <div class=qBlock>
              <div class=row style="justify-content:space-between">
                <div style=font-weight:1000>Catherine</div>
                <div class=small>Disputes + moins efficace</div>
              </div>
              <div class=choices two style=margin-top:10px>
                <div>
                  <div class=small style=font-weight:1000;margin-bottom:6px>Effets</div>
                  <select id=cathEffet>
                    <option value=>Je choisis</option>
                    <option value=humeur>Mauvaise humeur et fatigue</option>
                    <option value=force>Force et énergie</option>
                    <option value=zen>Zen et calme</option>
                  </select>
                </div>
                <div>
                  <div class=small style=font-weight:1000;margin-bottom:6px>Conséquence sociale</div>
                  <select id=cathSocial>
                    <option value=>Je choisis</option>
                    <option value=disputes>Disputes et voit moins sa famille</option>
                    <option value=amis>Plus de sorties</option>
                    <option value=top>Tout va mieux</option>
                  </select>
                </div>
              </div>
            </div>

            <div class=qBlock>
              <div class=row style="justify-content:space-between">
                <div style=font-weight:1000>Éric</div>
                <div class=small>Digestion + sport arrêté</div>
              </div>
              <div class=choices two style=margin-top:10px>
                <div>
                  <div class=small style=font-weight:1000;margin-bottom:6px>Effets</div>
                  <select id=ericEffet>
                    <option value=>Je choisis</option>
                    <option value=dig>Problèmes digestifs + fatigue + maux de tête</option>
                    <option value=parfait>Sommeil parfait</option>
                    <option value=aucun>Aucun effet</option>
                  </select>
                </div>
                <div>
                  <div class=small style=font-weight:1000;margin-bottom:6px>Conséquence sociale</div>
                  <select id=ericSocial>
                    <option value=>Je choisis</option>
                    <option value=moins>Sort moins et arrêt du sport</option>
                    <option value=plus>Sort plus</option>
                    <option value=stable>Rien ne change</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class=qBlock>
            <div class=qTitle>Défi 2 : tri des images (éviter ou conseillé)</div>
            <div class=small>Glisse chaque image dans la bonne zone.</div>

            <div class=slots style=margin-top:10px>
              <div class=slot data-slot=avoid>
                <strong>À éviter</strong>
                <div class=tokens data-target=avoid></div>
              </div>
              <div class=slot data-slot=good>
                <strong>Conseillé</strong>
                <div class=tokens data-target=good></div>
              </div>
            </div>

            <div class=tokens style=margin-top:10px id=pool4>
              <div class=token draggable=true data-kind=avoid>Éviter les excitants</div>
              <div class=token draggable=true data-kind=avoid>Éviter les écrans</div>
              <div class=token draggable=true data-kind=avoid>Éviter les repas copieux</div>
              <div class=token draggable=true data-kind=avoid>Éviter les casques audio</div>
              <div class=token draggable=true data-kind=avoid>Éviter les siestes</div>

              <div class=token draggable=true data-kind=good>Prendre un bain</div>
              <div class=token draggable=true data-kind=good>Chambre à 19 degrés</div>
              <div class=token draggable=true data-kind=good>Activité physique la journée</div>
              <div class=token draggable=true data-kind=good>Bonne literie</div>
              <div class=token draggable=true data-kind=good>Heures fixes</div>
            </div>

            <div class=small style=margin-top:10px>
              Les images à utiliser : eviter-excitants.jpg, eviter-ecrans.jpg, eviter-repas-copieux.jpg, eviter-casque-audio.jpg, eviter-sieste.jpg,
              prendre-bain.jpg, regler-temperature-19c.jpg, activite-physique-journee.jpg, bonne-literie.jpg, se-coucher-heure-reguliere.jpg
            </div>
          </div>

          <div class=row style=margin-top:12px>
            <button id=check4 type=button>Valider la salle 4</button>
            <button id=back4 class=secondary type=button>Retour au plan</button>
          </div>
          <div id=fb4 class=feedback>Réponds puis valide.</div>
        </div>

      </section>

      <aside class=card aria-label=Accessibilité>
        <h2 class=sectionTitle>Options pour mieux lire</h2>

        <div class=row style=margin-bottom:10px>
          <label class=row style=gap:10px;font-weight:1000>
            <input id=toggleDys type=checkbox style="width:22px;height:22px;accent-color:var(--accent)">
            Mode dys
          </label>
        </div>

        <div class=qBlock>
          <div class=small style=font-weight:1000;margin-bottom:6px>Taille du texte</div>
          <div class=row>
            <input id=fontScale type=range min=100 max=180 value=100 step=5 style=width:100%>
            <div id=fontScaleVal class=small style=font-weight:1000;min-width:64px;text-align:right>100%</div>
          </div>
        </div>

        <div class=qBlock>
          <div class=small style=font-weight:1000;margin-bottom:6>Zoom images</div>
          <div class=row>
            <input id=imgZoom type=range min=100 max=220 value=100 step=10 style=width:100%>
            <div id=imgZoomVal class=small style=font-weight:1000;min-width:64px;text-align:right>100%</div>
          </div>
        </div>

        <div class=qBlock>
          <div class=small style=font-weight:1000;margin-bottom:6>Gros pixels</div>
          <div class=row>
            <input id=pixel type=range min=0 max=4 value=0 step=1 style=width:100%>
            <div id=pixelVal class=small style=font-weight:1000;min-width:64px;text-align:right>0</div>
          </div>
        </div>

        <div class=row style=margin-top:10px>
          <button id=resetA11y class=secondary type=button>Réinitialiser</button>
        </div>

        <div class=hr></div>

        <div class=small>
          Sauvegarde automatique : prénom, progression, score, accessibilité.
        </div>
      </aside>
    </div>
  </main>

  <script>
    (function(){
      const K = {
        name: 'a2_eg_name_v1',
        unlock: 'a2_eg_unlock_v1',
        digits: 'a2_eg_digits_v1',
        score: 'a2_eg_score_v1',
        solved: 'a2_eg_solved_v1',
        dys: 'a2_sleep_dys',
        scale: 'a2_sleep_scale',
        img: 'a2_sleep_imgzoom',
        pixel: 'a2_eg_pixel_v1',
        drag3: 'a2_eg_drag3_v1',
        drag4: 'a2_eg_drag4_v1'
      };

      const MAX_SCORE = 40;

      const $ = id => document.getElementById(id);

      function getInt(key, d=0){
        const v = parseInt(localStorage.getItem(key) || String(d), 10);
        return isNaN(v) ? d : v;
      }
      function getJSON(key, d){
        try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(d)); }
        catch(e){ return d; }
      }
      function setJSON(key, v){ localStorage.setItem(key, JSON.stringify(v)); }

      function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

      function setActive(panelId){
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        $(panelId).classList.add('active');
        window.scrollTo({top:0, behavior:'instant'});
      }

      function getUnlock(){
        return clamp(getInt(K.unlock, 1), 1, 5);
      }
      function setUnlock(u){
        localStorage.setItem(K.unlock, String(clamp(u,1,5)));
      }

      function solvedMap(){ return getJSON(K.solved, {}); }
      function setSolved(id){
        const m = solvedMap();
        m[id] = 1;
        setJSON(K.solved, m);
      }
      function isSolved(id){
        const m = solvedMap();
        return m[id] === 1;
      }

      function addScore(id, pts){
        if(isSolved(id)) return;
        const s = clamp(getInt(K.score, 0) + pts, 0, MAX_SCORE);
        localStorage.setItem(K.score, String(s));
        setSolved(id);
      }

      function digits(){
        return getJSON(K.digits, {1:'_',2:'_',3:'_',4:'_'});
      }
      function setDigit(room, d){
        const m = digits();
        m[room] = String(d);
        setJSON(K.digits, m);
      }
      function codeString(){
        const m = digits();
        return String(m[1]) + String(m[2]) + String(m[3]) + String(m[4]);
      }

      function updateHud(){
        const name = (localStorage.getItem(K.name) || '').trim();
        $('prenom').value = name;

        $('hello').textContent = name ? ('Salut ' + name + ' !') : 'Écris ton prénom pour personnaliser la mission.';
        const sc = clamp(getInt(K.score,0), 0, MAX_SCORE);
        $('scoreTxt').textContent = sc + '/' + MAX_SCORE;

        const u = getUnlock();
        const badgeCount = (u>=2?1:0) + (u>=3?1:0) + (u>=4?1:0) + (u>=5?1:0);
        $('badgeTxt').textContent = badgeCount + '/4';

        const cs = codeString();
        $('codeTxt').textContent = cs;

        const pct = Math.round((sc / MAX_SCORE) * 100);
        $('barFill').style.width = pct + '%';
        document.querySelector('.bar[role=progressbar]').setAttribute('aria-valuenow', String(pct));

        const enc = $('enc');
        enc.className = 'enc';
        if(u >= 5){
          enc.classList.add('ok');
          enc.textContent = 'Coffre prêt. Tu peux l ouvrir sur le plan.';
        }else if(pct >= 70){
          enc.classList.add('ok');
          enc.textContent = 'Très bien. Continue, tu es proche du coffre.';
        }else if(pct >= 35){
          enc.classList.add('mid');
          enc.textContent = 'Bien. Une étape à la fois, tu vas y arriver.';
        }else{
          enc.classList.add('low');
          enc.textContent = 'Pas grave. Relis les indices et réessaie.';
        }

        $('open2').disabled = !(u >= 2);
        $('open3').disabled = !(u >= 3);
        $('open4').disabled = !(u >= 4);

        $('st1').className = 'status ' + (u>=2 ? 'ok':'');
        $('st1').textContent = (u>=2) ? 'Badge gagné' : 'À faire';

        $('st2').className = 'status ' + (u>=3 ? 'ok': (u>=2 ? '' : 'no'));
        $('st2').textContent = (u>=3) ? 'Badge gagné' : (u>=2 ? 'À faire' : 'Verrouillée');

        $('st3').className = 'status ' + (u>=4 ? 'ok': (u>=3 ? '' : 'no'));
        $('st3').textContent = (u>=4) ? 'Badge gagné' : (u>=3 ? 'À faire' : 'Verrouillée');

        $('st4').className = 'status ' + (u>=5 ? 'ok': (u>=4 ? '' : 'no'));
        $('st4').textContent = (u>=5) ? 'Badge gagné' : (u>=4 ? 'À faire' : 'Verrouillée');

        $('tryOpen').disabled = !(u >= 5);
        $('finalCode').disabled = !(u >= 5);
      }

      function applyA11y(){
        const dys = localStorage.getItem(K.dys) === '1';
        const scalePct = clamp(getInt(K.scale, 100), 100, 180);
        const imgPct = clamp(getInt(K.img, 100), 100, 220);
        const pix = clamp(getInt(K.pixel, 0), 0, 4);

        $('toggleDys').checked = dys;
        $('fontScale').value = String(scalePct);
        $('fontScaleVal').textContent = scalePct + '%';
        $('imgZoom').value = String(imgPct);
        $('imgZoomVal').textContent = imgPct + '%';
        $('pixel').value = String(pix);
        $('pixelVal').textContent = String(pix);

        document.documentElement.style.setProperty('--scale', (scalePct/100).toFixed(2));
        document.documentElement.style.setProperty('--imgzoom', (imgPct/100).toFixed(2));
        document.documentElement.style.setProperty('--pixel', String(pix));

        if(dys) document.body.classList.add('dys');
        else document.body.classList.remove('dys');
      }

      function chipToggle(btn){
        const pressed = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
      }

      function markFb(el, ok, msg){
        el.classList.remove('ok'); el.classList.remove('no');
        el.classList.add(ok ? 'ok' : 'no');
        el.textContent = msg;
      }

      function setupDrag(poolId, storageKey){
        const pool = $(poolId);
        const saved = getJSON(storageKey, {});
        const slots = document.querySelectorAll('.slot');

        function serialize(){
          const state = {};
          document.querySelectorAll('.slot').forEach(s=>{
            const k = s.getAttribute('data-slot');
            const t = s.querySelectorAll('.token');
            state[k] = Array.from(t).map(x=>x.textContent.trim());
          });
          state.__pool = Array.from(pool.querySelectorAll('.token')).map(x=>x.textContent.trim());
          setJSON(storageKey, state);
        }

        function restore(){
          if(!saved || Object.keys(saved).length===0) return;
          const allTokens = {};
          document.querySelectorAll('.token').forEach(t=>{ allTokens[t.textContent.trim()] = t; });

          if(saved.__pool){
            saved.__pool.forEach(txt=>{
              const t = allTokens[txt];
              if(t) pool.appendChild(t);
            });
          }
          document.querySelectorAll('.slot').forEach(s=>{
            const k = s.getAttribute('data-slot');
            const target = s.querySelector('.tokens[data-target]');
            if(saved[k] && target){
              saved[k].forEach(txt=>{
                const t = allTokens[txt];
                if(t) target.appendChild(t);
              });
            }
          });
        }

        let dragged = null;

        function onDragStart(e){
          dragged = e.target.closest('.token');
          if(!dragged) return;
          e.dataTransfer.setData('text/plain', dragged.textContent.trim());
          setTimeout(()=>{ dragged.style.opacity = '.55'; }, 0);
        }
        function onDragEnd(){
          if(dragged) dragged.style.opacity = '1';
          dragged = null;
          serialize();
        }

        function onOver(e){
          e.preventDefault();
          const slot = e.currentTarget;
          slot.classList.add('over');
        }
        function onLeave(e){
          e.currentTarget.classList.remove('over');
        }
        function onDrop(e){
          e.preventDefault();
          const slot = e.currentTarget;
          slot.classList.remove('over');
          const zone = slot.querySelector('.tokens[data-target]');
          if(!zone || !dragged) return;
          zone.appendChild(dragged);
          serialize();
        }

        pool.addEventListener('dragstart', onDragStart);
        pool.addEventListener('dragend', onDragEnd);

        document.querySelectorAll('.tokens[data-target]').forEach(z=>{
          z.addEventListener('dragover', e=>e.preventDefault());
          z.addEventListener('drop', e=>{
            e.preventDefault();
            if(dragged) z.appendChild(dragged);
            serialize();
          });
        });

        slots.forEach(s=>{
          s.addEventListener('dragover', onOver);
          s.addEventListener('dragleave', onLeave);
          s.addEventListener('drop', onDrop);
        });

        restore();
      }

      function checkRoom1(){
        const ok1 = $('r1q1b').checked;

        const ok2 =
          $('r1qui').value === 'ados' &&
          $('r1quoi').value === 'ecrans' &&
          $('r1comment').value === 'lumiere' &&
          $('r1pourquoi').value === 'retard';

        const fb = $('fb1');

        if(!ok1 || !ok2){
          addScore('r1_try', 0);
          markFb(fb, false, 'Il manque des réponses ou il y a une erreur. Relis les indices et recommence.');
          return false;
        }

        addScore('r1', 10);
        setDigit(1, 7);
        setUnlock(Math.max(getUnlock(), 2));
        markFb(fb, true, 'Badge gagné. Chiffre 7 ajouté au code.');
        updateHud();
        return true;
      }

      function checkRoom2(){
        const c1 = $('r2c1').getAttribute('aria-pressed') === 'true';
        const c2 = $('r2c2').getAttribute('aria-pressed') === 'true';
        const c3 = $('r2c3').getAttribute('aria-pressed') === 'true';
        const c4 = $('r2c4').getAttribute('aria-pressed') === 'true';
        const okChips = c1 && c2 && c3 && !c4;

        const okQ2 = $('r2q2b').checked;

        const fb = $('fb2');

        if(!okChips || !okQ2){
          markFb(fb, false, 'Pas encore. Vérifie 24 heures, rythme circadien, mélatonine, et le facteur lumière.');
          return false;
        }

        addScore('r2', 10);
        setDigit(2, 2);
        setUnlock(Math.max(getUnlock(), 3));
        markFb(fb, true, 'Badge gagné. Chiffre 2 ajouté au code.');
        updateHud();
        return true;
      }

      function checkRoom3(){
        const fatigueZone = document.querySelector('.slot[data-slot=fatigue] .tokens[data-target=fatigue]');
        const mentalZone = document.querySelector('.slot[data-slot=mental] .tokens[data-target=mental]');

        const hasFatigue = Array.from(fatigueZone.querySelectorAll('.token')).some(t=>t.textContent.trim()==='Sommeil lent très profond');
        const hasMental = Array.from(mentalZone.querySelectorAll('.token')).some(t=>t.textContent.trim()==='Sommeil paradoxal');

        const latenceInPool = Array.from($('pool3').querySelectorAll('.token')).some(t=>t.textContent.trim()==='Latence');

        const okSel = $('r3phases').value === '5' && $('r3duree').value === '90';

        const fb = $('fb3');

        if(!(hasFatigue && hasMental && latenceInPool && okSel)){
          markFb(fb, false, 'Presque. Replace les cartes et vérifie 5 phases et 90 minutes.');
          return false;
        }

        addScore('r3', 10);
        setDigit(3, 9);
        setUnlock(Math.max(getUnlock(), 4));
        markFb(fb, true, 'Badge gagné. Chiffre 9 ajouté au code.');
        updateHud();
        return true;
      }

      function checkRoom4(){
        const okT =
          $('sylvieEffet').value === 'fatigue' &&
          $('sylviePro').value === 'accident' &&
          $('cathEffet').value === 'humeur' &&
          $('cathSocial').value === 'disputes' &&
          $('ericEffet').value === 'dig' &&
          $('ericSocial').value === 'moins';

        const avoidZone = document.querySelector('.slot[data-slot=avoid] .tokens[data-target=avoid]');
        const goodZone  = document.querySelector('.slot[data-slot=good]  .tokens[data-target=good]');

        const avoidNeeded = [
          'Éviter les excitants','Éviter les écrans','Éviter les repas copieux','Éviter les casques audio','Éviter les siestes'
        ];
        const goodNeeded = [
          'Prendre un bain','Chambre à 19 degrés','Activité physique la journée','Bonne literie','Heures fixes'
        ];

        const avoidHave = Array.from(avoidZone.querySelectorAll('.token')).map(t=>t.textContent.trim());
        const goodHave = Array.from(goodZone.querySelectorAll('.token')).map(t=>t.textContent.trim());

        const okAvoid = avoidNeeded.every(x=>avoidHave.includes(x)) && avoidHave.length===5;
        const okGood  = goodNeeded.every(x=>goodHave.includes(x)) && goodHave.length===5;

        const fb = $('fb4');

        if(!(okT && okAvoid && okGood)){
          markFb(fb, false, 'Il reste une erreur. Revois les témoignages et le tri éviter ou conseillé.');
          return false;
        }

        addScore('r4', 10);
        setDigit(4, 4);
        setUnlock(5);
        markFb(fb, true, 'Badge gagné. Chiffre 4 ajouté au code. Retourne au plan pour ouvrir le coffre.');
        updateHud();
        return true;
      }

      function openChest(){
        const expected = codeString();
        const val = ($('finalCode').value || '').trim();
        if(val === expected){
          markFb($('finalFb'), true, 'Coffre ouvert. Mission terminée.');
        }else{
          markFb($('finalFb'), false, 'Mauvais code. Regarde les 4 chiffres du code.');
        }
      }

      function init(){
        if(!localStorage.getItem(K.unlock)) setUnlock(1);

        $('saveName').addEventListener('click', ()=>{
          const v = ($('prenom').value || '').trim().slice(0,30);
          if(v) localStorage.setItem(K.name, v);
          updateHud();
        });
        $('prenom').addEventListener('keydown', e=>{
          if(e.key === 'Enter'){ e.preventDefault(); $('saveName').click(); }
        });

        $('goMap').addEventListener('click', ()=>setActive('mapPanel'));

        $('open1').addEventListener('click', ()=>setActive('room1'));
        $('open2').addEventListener('click', ()=>setActive('room2'));
        $('open3').addEventListener('click', ()=>setActive('room3'));
        $('open4').addEventListener('click', ()=>setActive('room4'));

        $('back1').addEventListener('click', ()=>setActive('mapPanel'));
        $('back2').addEventListener('click', ()=>setActive('mapPanel'));
        $('back3').addEventListener('click', ()=>setActive('mapPanel'));
        $('back4').addEventListener('click', ()=>setActive('mapPanel'));

        $('check1').addEventListener('click', checkRoom1);
        $('check2').addEventListener('click', checkRoom2);
        $('check3').addEventListener('click', checkRoom3);
        $('check4').addEventListener('click', checkRoom4);

        $('r2c1').addEventListener('click', ()=>chipToggle($('r2c1')));
        $('r2c2').addEventListener('click', ()=>chipToggle($('r2c2')));
        $('r2c3').addEventListener('click', ()=>chipToggle($('r2c3')));
        $('r2c4').addEventListener('click', ()=>chipToggle($('r2c4')));

        setupDrag('pool3', K.drag3);
        setupDrag('pool4', K.drag4);

        $('tryOpen').addEventListener('click', openChest);

        $('toggleDys').addEventListener('change', ()=>{
          localStorage.setItem(K.dys, $('toggleDys').checked ? '1' : '0');
          applyA11y();
        });
        $('fontScale').addEventListener('input', ()=>{
          localStorage.setItem(K.scale, String($('fontScale').value));
          applyA11y();
        });
        $('imgZoom').addEventListener('input', ()=>{
          localStorage.setItem(K.img, String($('imgZoom').value));
          applyA11y();
        });
        $('pixel').addEventListener('input', ()=>{
          localStorage.setItem(K.pixel, String($('pixel').value));
          applyA11y();
        });
        $('resetA11y').addEventListener('click', ()=>{
          localStorage.removeItem(K.dys);
          localStorage.removeItem(K.scale);
          localStorage.removeItem(K.img);
          localStorage.removeItem(K.pixel);
          applyA11y();
        });

        $('resetAll').addEventListener('click', ()=>{
          localStorage.removeItem(K.unlock);
          localStorage.removeItem(K.digits);
          localStorage.removeItem(K.score);
          localStorage.removeItem(K.solved);
          localStorage.removeItem(K.drag3);
          localStorage.removeItem(K.drag4);
          setUnlock(1);
          setActive('mapPanel');
          updateHud();
          markFb($('finalFb'), false, 'Le coffre est fermé.');
          $('finalCode').value = '';
          location.reload();
        });

        applyA11y();
        updateHud();

        window.addEventListener('focus', updateHud);
        document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) updateHud(); });
      }

      init();
    })();
  </script>
</body>
</html>
