<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
  authDomain: "devoirs-pse.firebaseapp.com",
  projectId: "devoirs-pse",
  storageBucket: "devoirs-pse.firebasestorage.app",
  messagingSenderId: "614730413904",
  appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const copiesCol = collection(db, "bacpro");

(function(){
  const TOTAL_MAX = 22;
  const STORAGE_KEY = "pse_bacpro_chute_hauteur_c2_v1";

  const totalScoreEl = document.getElementById('totalScore');
  const doneCountEl = document.getElementById('doneCount');
  document.getElementById('totalMax').textContent = String(TOTAL_MAX);

  const state = {
    done: { exo1:false, exo2:false, exo3:false },
    scores: { exo1:0, exo2:0, exo3:0 }
  };

  const chipsData = [
    { id:"c1", text:"Ne ferme pas le portillon d’une nacelle", zone:"main_oeuvre", hint:"erreur humaine" },
    { id:"c2", text:"Oublie de s’attacher (harnais non utilisé)", zone:"main_oeuvre", hint:"EPI" },
    { id:"c3", text:"Travaille trop vite / fatigue en fin de journée", zone:"main_oeuvre", hint:"vigilance" },

    { id:"c4", text:"Garde-corps absent ou incomplet", zone:"materiel", hint:"protection collective" },
    { id:"c5", text:"Échelle mal fixée ou glissante", zone:"materiel", hint:"accès" },
    { id:"c6", text:"Échafaudage instable / mal monté", zone:"materiel", hint:"structure" },

    { id:"c7", text:"Pas de balisage des zones à risque", zone:"methode", hint:"organisation" },
    { id:"c8", text:"Pas de formation au travail en hauteur", zone:"methode", hint:"consigne" },
    { id:"c9", text:"Préparation au sol non faite → trop d’actions en hauteur", zone:"methode", hint:"planification" },

    { id:"c10", text:"Toiture humide / vent", zone:"milieu", hint:"conditions" },
    { id:"c11", text:"Matériaux fragiles (verrière, dôme)", zone:"milieu", hint:"support" },
    { id:"c12", text:"Zone encombrée (outils, câbles)", zone:"milieu", hint:"circulation" },
  ];

  function sumScores(){
    const t = state.scores.exo1 + state.scores.exo2 + state.scores.exo3;
    totalScoreEl.textContent = String(t);
    const d = Object.values(state.done).filter(Boolean).length;
    doneCountEl.textContent = String(d);
  }

  function snapshotChips(){
    const data = { zones:{}, bank:[] };
    document.querySelectorAll('#exo2 .drop').forEach(drop=>{
      const zone = drop.dataset.zone;
      data.zones[zone] = Array.from(drop.querySelectorAll('.chip')).map(c=>c.dataset.chipId);
    });
    const bankEl = document.getElementById('bank5m');
    data.bank = Array.from(bankEl.querySelectorAll('.chip')).map(c=>c.dataset.chipId);
    return data;
  }

  function restoreChips(layout){
    if(!layout) return;
    const allChips = {};
    document.querySelectorAll('#exo2 .chip').forEach(ch=>{
      allChips[ch.dataset.chipId] = ch;
    });

    document.querySelectorAll('#exo2 .drop').forEach(drop=>{
      drop.innerHTML = "";
    });
    const bankEl = document.getElementById('bank5m');
    bankEl.innerHTML = "";

    if(layout.zones){
      Object.entries(layout.zones).forEach(([zone, ids])=>{
        const drop = document.querySelector(`#exo2 .drop[data-zone="${zone}"]`);
        if(!drop) return;
        (ids || []).forEach(id=>{
          const chip = allChips[id];
          if(chip) drop.appendChild(chip);
        });
      });
    }
    if(layout.bank){
      (layout.bank || []).forEach(id=>{
        const chip = allChips[id];
        if(chip) bankEl.appendChild(chip);
      });
    }
    ensureDropHints();
  }

  function saveState(){
    const payload = { v:1, exo1:{}, exo3:{}, chips:null, meta:{} };
    document.querySelectorAll('#exo1 [data-q]').forEach(sel=>{
      payload.exo1[sel.dataset.q] = sel.value || "";
    });
    document.querySelectorAll('#exo3 [data-q]').forEach(sel=>{
      payload.exo3[sel.dataset.q] = sel.value || "";
    });
    payload.chips = snapshotChips();
    payload.meta.classe = (document.getElementById('meta_classe')?.value || "");
    payload.meta.code = (document.getElementById('meta_code')?.value || "");
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }catch(e){}
  }

  function loadState(){
    let raw = null;
    try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){}
    if(!raw) return;
    let payload;
    try{ payload = JSON.parse(raw); }catch(e){ return; }
    if(!payload || payload.v !== 1) return;

    if(payload.exo1){
      Object.entries(payload.exo1).forEach(([k,val])=>{
        const sel = document.querySelector(`#exo1 [data-q="${k}"]`);
        if(sel) sel.value = val;
      });
    }
    if(payload.exo3){
      Object.entries(payload.exo3).forEach(([k,val])=>{
        const sel = document.querySelector(`#exo3 [data-q="${k}"]`);
        if(sel) sel.value = val;
      });
    }
    if(payload.meta){
      if(payload.meta.classe && document.getElementById('meta_classe')){
        document.getElementById('meta_classe').value = payload.meta.classe;
      }
      if(payload.meta.code && document.getElementById('meta_code')){
        document.getElementById('meta_code').value = payload.meta.code;
      }
    }
    if(payload.chips) restoreChips(payload.chips);
  }

  // ---------- EXO 1 ----------
  const exo1Answers = {
    A_danger: "ouverture",
    A_situation: "toit_fragile",
    A_event: "rupture",
    A_damage: "grave",
    B_danger: "ouverture",
    B_situation: "zone_non_secu",
    B_event: "chute_dans_vide",
    B_damage: "grave",
    C_danger: "impact",
    C_situation: "echafaud",
    C_event: "perte_equilibre",
    C_damage: "fracture",
  };
  function checkExo1(){
    let pts = 0;
    const total = 8;
    const keys = Object.keys(exo1Answers);

    keys.forEach(k=>{
      const sel = document.querySelector(`#exo1 [data-q="${k}"]`);
      const v = sel ? sel.value : "";
      if(v && v === exo1Answers[k]) pts += 0.5;
    });

    pts = Math.round(pts * 2) / 2;
    document.getElementById('s1').textContent = String(pts);
    const r = document.getElementById('r1');
    const missing = keys.filter(k=>{
      const sel = document.querySelector(`#exo1 [data-q="${k}"]`);
      return !sel || !sel.value;
    }).length;

    let msg = `Score : ${pts}/${total}. `;
    if(missing>0) msg += `Il manque ${missing} sélection(s). `;
    msg += `Correction attendue : A(ouverture→toit matériaux fragiles→rupture→dommage grave), B(trémie/vide→zone non sécurisée→chute→dommage grave), C(impact sol→travail sur échafaudage→perte d’équilibre→fracture).`;

    r.className = "result " + (pts>=6 ? "ok" : (pts>=3 ? "" : "bad"));
    r.textContent = msg;

    state.scores.exo1 = pts;
    state.done.exo1 = true;
    sumScores();
    saveState();
  }
  function resetExo1(){
    document.querySelectorAll('#exo1 select').forEach(s=>s.value="");
    document.getElementById('s1').textContent = "0";
    const r = document.getElementById('r1');
    r.className = "result";
    r.textContent = "Résultat : en attente de correction.";
    state.scores.exo1 = 0;
    state.done.exo1 = false;
    sumScores();
    saveState();
  }

  // ---------- EXO 2 (5M) ----------
  const bank = document.getElementById('bank5m');
  let selectedChipId = null;

  function escapeHtml(str){
    return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function makeChip(ch){
    const el = document.createElement('div');
    el.className = "chip";
    el.setAttribute('draggable','true');
    el.dataset.chipId = ch.id;
    el.dataset.correctZone = ch.zone;
    el.innerHTML = `<span>${escapeHtml(ch.text)}</span><small>${escapeHtml(ch.hint)}</small>`;

    el.addEventListener('click', (e)=>{
      const parentDrop = el.closest('.drop');
      if(parentDrop){
        moveChipToBank(el);
        clearSelection();
        saveState();
        return;
      }
      if(selectedChipId === ch.id){
        clearSelection();
      } else {
        clearSelection();
        selectedChipId = ch.id;
        el.classList.add('selected');
      }
    }, {passive:true});

    el.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', ch.id);
      try{ ev.dataTransfer.effectAllowed = "move"; }catch(_){}
      selectedChipId = ch.id;
      el.classList.add('selected');
    });

    return el;
  }

  function clearSelection(){
    selectedChipId = null;
    document.querySelectorAll('.chip.selected').forEach(c=>c.classList.remove('selected'));
  }

  function moveChipToBank(chipEl){
    const parentDrop = chipEl.closest('.drop');
    if(parentDrop){
      parentDrop.querySelectorAll('.hint').forEach(h=>h.remove());
    }
    chipEl.classList.remove('selected');
    bank.appendChild(chipEl);
    ensureDropHints();
  }

  function ensureDropHints(){
    document.querySelectorAll('#exo2 .drop').forEach(drop=>{
      if(drop.querySelectorAll('.chip').length === 0){
        if(!drop.querySelector('.hint')){
          const hint = document.createElement('span');
          hint.className = "hint";
          hint.textContent = "Dépose ici";
          drop.appendChild(hint);
        }
      } else {
        drop.querySelectorAll('.hint').forEach(h=>h.remove());
      }
    });
  }

  function getChipById(id){
    return document.querySelector(`.chip[data-chip-id="${CSS.escape(id)}"]`);
  }

  function placeSelectedInto(drop){
    if(!selectedChipId) return;
    const chipEl = getChipById(selectedChipId);
    if(!chipEl) return;
    drop.querySelectorAll('.hint').forEach(h=>h.remove());
    chipEl.classList.remove('selected');
    drop.appendChild(chipEl);
    selectedChipId = null;
    ensureDropHints();
    saveState();
  }

  function init5M(){
    bank.innerHTML = "";
    chipsData.forEach(ch=>bank.appendChild(makeChip(ch)));
    ensureDropHints();

    document.querySelectorAll('#exo2 .drop').forEach(drop=>{
      drop.addEventListener('click', (e)=>{
        if(e.target.classList.contains('drop') || e.target.classList.contains('hint')){
          placeSelectedInto(drop);
        }
      });

      drop.addEventListener('dragover', (ev)=>{
        ev.preventDefault();
        drop.classList.add('dragover');
      });
      drop.addEventListener('dragleave', ()=>{
        drop.classList.remove('dragover');
      });
      drop.addEventListener('drop', (ev)=>{
        ev.preventDefault();
        drop.classList.remove('dragover');
        const id = ev.dataTransfer.getData('text/plain');
        if(!id) return;
        const chipEl = getChipById(id);
        if(!chipEl) return;
        drop.querySelectorAll('.hint').forEach(h=>h.remove());
        chipEl.classList.remove('selected');
        drop.appendChild(chipEl);
        clearSelection();
        ensureDropHints();
        saveState();
      });
    });

    document.addEventListener('click', (e)=>{
      if(!e.target.closest('#exo2 .chip')) clearSelection();
    }, {passive:true});
  }

  const expected5M = {
    main_oeuvre: new Set(["c1","c2","c3"]),
    materiel: new Set(["c4","c5","c6"]),
    methode: new Set(["c7","c8","c9"]),
    milieu: new Set(["c10","c11","c12"]),
  };

  function score5M(){
    let pts = 0;
    const total = 8;
    const each = total / 12;

    Object.keys(expected5M).forEach(zone=>{
      const drop = document.querySelector(`#exo2 .drop[data-zone="${zone}"]`);
      const placed = Array.from(drop.querySelectorAll('.chip')).map(c=>c.dataset.chipId);
      placed.forEach(id=>{
        if(expected5M[zone].has(id)) pts += each;
      });
    });

    pts = Math.round(pts * 10) / 10;
    document.getElementById('s2').textContent = String(pts);
    const r = document.getElementById('r2');

    const allPlaced = document.querySelectorAll('#exo2 .drop .chip').length;
    let msg = `Score : ${pts}/${total}. `;
    if(allPlaced < 12) msg += `Il manque ${12 - allPlaced} cause(s) à placer. `;
    msg += `Rappel : 5M = Main d’œuvre (humain), Matériel (équipement), Méthode (organisation), Milieu (environnement).`;

    r.className = "result " + (pts>=6 ? "ok" : (pts>=3 ? "" : "bad"));
    r.textContent = msg;

    state.scores.exo2 = pts;
    state.done.exo2 = true;
    sumScores();
    saveState();
  }

  function reset5M(){
    document.querySelectorAll('#exo2 .drop .chip').forEach(ch=>bank.appendChild(ch));
    clearSelection();
    ensureDropHints();
    document.getElementById('s2').textContent = "0";
    const r = document.getElementById('r2');
    r.className = "result";
    r.textContent = "Résultat : en attente de correction.";
    state.scores.exo2 = 0;
    state.done.exo2 = false;
    sumScores();
    saveState();
  }

  // ---------- EXO 3 ----------
  function checkExo3(){
    const total = 6;
    let pts = 0;

    const g = document.querySelector('#exo3 [data-q="gravite"]').value;
    const p = document.querySelector('#exo3 [data-q="proba"]').value;
    const pr = document.querySelector('#exo3 [data-q="priorite"]').value;
    const j = document.querySelector('#exo3 [data-q="justif"]').value;

    if(g === "4") pts += 2;
    if(p === "3" || p === "4") pts += 2;
    if(pr === "elevee") pts += 1;
    if(j === "bonne") pts += 1;

    document.getElementById('s3').textContent = String(pts);
    const r = document.getElementById('r3');

    const missing = [g,p,pr,j].filter(x=>!x).length;
    let msg = `Score : ${pts}/${total}. `;
    if(missing>0) msg += `Il manque ${missing} choix. `;
    msg += `Attendu : gravité très élevée (chute 4 m), probabilité fréquente (activité quotidienne + pas de garde-corps), priorité élevée, justification : chute possible + conséquences graves.`;

    r.className = "result " + (pts>=5 ? "ok" : (pts>=3 ? "" : "bad"));
    r.textContent = msg;

    state.scores.exo3 = pts;
    state.done.exo3 = true;
    sumScores();
    saveState();
  }

  function resetExo3(){
    document.querySelectorAll('#exo3 select').forEach(s=>s.value="");
    document.getElementById('s3').textContent = "0";
    const r = document.getElementById('r3');
    r.className = "result";
    r.textContent = "Résultat : en attente de correction.";
    state.scores.exo3 = 0;
    state.done.exo3 = false;
    sumScores();
    saveState();
  }

  function buildPayloadForFirebase(classe, code){
    const exo1Data = { A:{danger:"",situation:"",event:"",dommage:""}, B:{danger:"",situation:"",event:"",dommage:""}, C:{danger:"",situation:"",event:"",dommage:""} };
    document.querySelectorAll('#exo1 [data-q]').forEach(sel=>{
      const key = sel.dataset.q;
      const parts = key.split("_");
      const sc = parts[0], field = parts[1];
      if(exo1Data[sc]) exo1Data[sc][field] = sel.value || "";
    });

    const exo3Data = {};
    document.querySelectorAll('#exo3 [data-q]').forEach(sel=>{
      exo3Data[sel.dataset.q] = sel.value || "";
    });

    const layout = snapshotChips();
    const chipById = {};
    chipsData.forEach(c=>{ chipById[c.id] = c; });

    const exo2Zones = {};
    Object.entries(layout.zones).forEach(([zone, ids])=>{
      exo2Zones[zone] = (ids || []).map(id=>({
        id,
        text: chipById[id]?.text || "",
        hint: chipById[id]?.hint || ""
      }));
    });
    const exo2Bank = (layout.bank || []).map(id=>({
      id,
      text: chipById[id]?.text || "",
      hint: chipById[id]?.hint || ""
    }));

    const total = state.scores.exo1 + state.scores.exo2 + state.scores.exo3;
    const max = TOTAL_MAX;
    const percent = max ? Math.round((total/max)*100) : 0;

    return {
      meta:{
        exoId:"bacpro_chute_hauteur_c2_v1",
        classe: classe || "",
        eleveCode: code,
        createdAt: serverTimestamp()
      },
      score:{ total, max, percent },
      perExo:{
        exo1: state.scores.exo1,
        exo2: state.scores.exo2,
        exo3: state.scores.exo3
      },
      answers:{
        exo1: exo1Data,
        exo2: { zones: exo2Zones, bank: exo2Bank },
        exo3: exo3Data
      },
      raw:{
        chipsLayout: layout,
        selectsExo1: exo1Data,
        selectsExo3: exo3Data
      },
      client:{
        ua: navigator.userAgent || "",
        ts: Date.now()
      }
    };
  }

  function wire(){
    document.querySelectorAll('#exo1 select').forEach(sel=>{
      sel.addEventListener('change', saveState);
    });
    document.querySelectorAll('#exo3 select').forEach(sel=>{
      sel.addEventListener('change', saveState);
    });
    const metaClasse = document.getElementById('meta_classe');
    const metaCode = document.getElementById('meta_code');
    if(metaClasse) metaClasse.addEventListener('input', saveState);
    if(metaCode) metaCode.addEventListener('input', saveState);

    document.querySelectorAll('[data-check]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const exo = btn.getAttribute('data-check');
        if(exo === "exo1") checkExo1();
        if(exo === "exo2") score5M();
        if(exo === "exo3") checkExo3();
      });
    });
    document.querySelectorAll('[data-reset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const exo = btn.getAttribute('data-reset');
        if(exo === "exo1") resetExo1();
        if(exo === "exo2") reset5M();
        if(exo === "exo3") resetExo3();
      });
    });

    const globalCheck = document.getElementById('btnGlobalCheck');
    if(globalCheck){
      globalCheck.addEventListener('click', ()=>{
        checkExo1();
        score5M();
        checkExo3();
      });
    }

    const sendBtn = document.getElementById('sendFirebase');
    if(sendBtn){
      sendBtn.addEventListener('click', async ()=>{
        const classe = (document.getElementById('meta_classe')?.value || "").trim();
        const code = (document.getElementById('meta_code')?.value || "").trim();
        if(!code){
          alert("Merci d’indiquer ton code élève (ex : C2-07) avant d’envoyer.");
          return;
        }
        try{
          const payload = buildPayloadForFirebase(classe, code);
          await addDoc(copiesCol, payload);
          alert("Copie envoyée. Ton professeur la recevra dans son cockpit.");
        }catch(e){
          console.error(e);
          alert("Erreur lors de l’envoi. Vérifie la connexion et réessaie.");
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    init5M();
    loadState();
    wire();
    sumScores();
  });

})();
</script>
