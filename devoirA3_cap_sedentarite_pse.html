<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Devoir PSE CAP — Sédentarité, effort et bien-être</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#4b5563;
      --border:#e5e7eb;
      --accent:#2563eb;
      --good:#16a34a;
      --bad:#dc2626;
      --scale:1;
      --radius:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --focus: 0 0 0 3px rgba(37,99,235,.25);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.35;
      font-size: calc(16px * var(--scale));
    }
    body.dys{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing: .02em;
      word-spacing: .08em;
      line-height: 1.6;
    }
    body.contrast{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#000000;
      --muted:#111111;
      --border:#000000;
      --accent:#000000;
      --shadow:none;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 70px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 12px;
    }
    .title{
      font-weight:800;
      font-size: 1.2em;
      letter-spacing: .01em;
    }
    .tools{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .toolbtn{
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight:700;
      cursor:pointer;
      font-size: .95em;
      box-shadow: none;
    }
    .toolbtn:focus{ outline:none; box-shadow: var(--focus); }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--card);
      color:var(--muted);
      font-weight:700;
      font-size:.95em;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    label{
      font-weight:700;
      color:var(--muted);
    }
    input[type="text"]{
      width: 260px;
      max-width: 100%;
      padding: 12px 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      font-size: 1em;
      background: var(--card);
      color: var(--text);
    }
    input[type="text"]:focus{ outline:none; box-shadow: var(--focus); }
    .stepper{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin: 12px 0 10px;
    }
    .step{
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: var(--card);
      color: var(--muted);
      font-weight:800;
      font-size:.95em;
    }
    .step.active{
      background: rgba(37,99,235,.08);
      color: var(--text);
      border-color: rgba(37,99,235,.35);
    }
    .step.done{
      background: rgba(22,163,74,.10);
      border-color: rgba(22,163,74,.35);
      color: var(--text);
    }
    .section-title{
      font-weight:900;
      font-size: 1.15em;
      margin: 0 0 8px;
    }
    .hint{
      color: var(--muted);
      margin: 0 0 10px;
      font-weight:600;
    }
    .imgbox{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      overflow:hidden;
    }
    .imgbox img{
      width:100%;
      display:block;
      height:auto;
    }
    .q{
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.02);
    }
    body.contrast .q{ background:#fff; }
    .qhead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .qtitle{
      font-weight:900;
      font-size: 1.05em;
      margin:0;
    }
    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--card);
      font-weight:900;
      font-size:.9em;
      color: var(--muted);
    }
    .pts{
      color: var(--muted);
      font-weight:900;
      font-size:.9em;
    }
    .opts{
      margin-top: 10px;
      display:grid;
      gap:10px;
    }
    .opt{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      cursor:pointer;
      user-select:none;
    }
    .opt input{ transform: scale(1.25); }
    .opt:focus-within{ box-shadow: var(--focus); }
    .opt .otext{ font-weight:800; }
    .grid6{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top:10px;
    }
    @media (max-width: 720px){
      input[type="text"]{ width: 100%; }
      .grid6{ grid-template-columns: 1fr; }
    }
    .mini{
      padding: 10px;
      border:1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
    }
    .mini .mhead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
    }
    .toggle{
      display:flex;
      gap:8px;
      margin-top:8px;
    }
    .tbtn{
      flex:1;
      border:1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 12px;
      padding: 10px;
      cursor:pointer;
      font-weight:900;
    }
    .tbtn.active{
      border-color: rgba(37,99,235,.55);
      background: rgba(37,99,235,.10);
    }
    body.contrast .tbtn.active{
      border-color:#000;
      background:#fff;
      outline: 3px solid #000;
      outline-offset: -3px;
    }
    .nav{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight:900;
      min-width: 140px;
    }
    .btn.primary{
      background: var(--accent);
      border-color: var(--accent);
      color:#fff;
    }
    body.contrast .btn.primary{
      background:#000;
      border-color:#000;
      color:#fff;
    }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .status{
      margin-top: 10px;
      font-weight:900;
      color: var(--muted);
    }
    .status.ok{ color: var(--good); }
    .status.err{ color: var(--bad); }
    .scorebox{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.02);
    }
    body.contrast .scorebox{ background:#fff; }
    .score{
      font-weight:900;
      font-size: 1.05em;
    }
    .sub{
      color: var(--muted);
      font-weight:800;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tiny{
      font-size:.92em;
      color: var(--muted);
      font-weight:700;
      margin: 6px 0 0;
    }

    @media print{
      .tools, .nav, .actions, .status, .topbar .pill { display:none !important; }
      body{ background:#fff; }
      .card{ box-shadow:none; }
      .wrap{ max-width: 100%; padding: 0; }
      .q{ break-inside: avoid; }
      .imgbox{ break-inside: avoid; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Devoir PSE CAP — Sédentarité, effort et bien-être</div>
        <div class="pill">C1 • C2 • C4 • Barème /20</div>
      </div>

      <div class="tools" aria-label="Outils d'accessibilité">
        <button class="toolbtn" id="zoomOut" type="button">A-</button>
        <button class="toolbtn" id="zoomIn" type="button">A+</button>
        <button class="toolbtn" id="toggleDys" type="button">Dys</button>
        <button class="toolbtn" id="toggleContrast" type="button">Contraste</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div>
          <label for="nom">Nom</label><br/>
          <input id="nom" type="text" autocomplete="family-name" />
        </div>
        <div>
          <label for="prenom">Prénom</label><br/>
          <input id="prenom" type="text" autocomplete="given-name" />
        </div>
        <div>
          <label for="classe">Classe</label><br/>
          <input id="classe" type="text" autocomplete="organization" placeholder="ex : CAP..." />
        </div>
      </div>

      <div class="scorebox" role="status" aria-live="polite">
        <div>
          <div class="score" id="scoreLine">Note : 0 / 20</div>
          <div class="sub" id="stepLine">Étape 1 sur 4</div>
        </div>
        <div class="actions">
          <button class="btn" id="downloadBtn" type="button">Télécharger JSON</button>
          <button class="btn" id="printBtn" type="button">Imprimer PDF</button>
          <button class="btn primary" id="sendBtn" type="button">Envoyer</button>
        </div>
      </div>

      <div class="stepper" aria-label="Progression">
        <div class="step active" id="s0">1 Situation</div>
        <div class="step" id="s1">2 Activité 1</div>
        <div class="step" id="s2">3 Activité 2</div>
        <div class="step" id="s3">4 Activité 3</div>
      </div>

      <section id="step0">
        <h2 class="section-title">Situation : Tom et le cours d’EPS</h2>
        <p class="hint">Observe la BD, puis réponds aux questions.</p>

        <div class="imgbox">
          <img src="images/01-bd-tom.jpg" alt="BD : Tom court pour aller en EPS et parle de sédentarité" />
        </div>

        <div class="q" data-q="1">
          <div class="qhead">
            <p class="qtitle">Question 1 — Où Tom va-t-il ?</p>
            <div class="badges">
              <span class="badge">C1</span>
              <span class="pts">2,0 pts</span>
            </div>
          </div>
          <div class="opts">
            <label class="opt"><input type="radio" name="q1" value="A"> <span class="otext">Au cours d’EPS</span></label>
            <label class="opt"><input type="radio" name="q1" value="B"> <span class="otext">À la cantine</span></label>
            <label class="opt"><input type="radio" name="q1" value="C"> <span class="otext">À la bibliothèque</span></label>
          </div>
        </div>

        <div class="q" data-q="2">
          <div class="qhead">
            <p class="qtitle">Question 2 — Quand Tom dit-il qu’il n’arrive pas à respirer ?</p>
            <div class="badges">
              <span class="badge">C1</span>
              <span class="pts">2,0 pts</span>
            </div>
          </div>
          <div class="opts">
            <label class="opt"><input type="radio" name="q2" value="A"> <span class="otext">Après avoir couru très vite</span></label>
            <label class="opt"><input type="radio" name="q2" value="B"> <span class="otext">Avant de partir de chez lui</span></label>
            <label class="opt"><input type="radio" name="q2" value="C"> <span class="otext">Pendant qu’il mange</span></label>
          </div>
        </div>

        <div class="q" data-q="3">
          <div class="qhead">
            <p class="qtitle">Question 3 — Pourquoi l’effort est difficile pour Tom ?</p>
            <div class="badges">
              <span class="badge">C2</span>
              <span class="pts">2,0 pts</span>
            </div>
          </div>
          <div class="opts">
            <label class="opt"><input type="radio" name="q3" value="A"> <span class="otext">Il a passé le week-end assis : il a peu bougé</span></label>
            <label class="opt"><input type="radio" name="q3" value="B"> <span class="otext">Il a oublié son sac de sport</span></label>
            <label class="opt"><input type="radio" name="q3" value="C"> <span class="otext">Il a trop bu d’eau</span></label>
          </div>
        </div>

        <div class="nav">
          <span></span>
          <button class="btn primary" id="next0" type="button">Suivant</button>
        </div>
      </section>

      <section id="step1" hidden>
        <h2 class="section-title">Activité 1 : Échanges entre le muscle et le sang</h2>
        <p class="hint">Quand le muscle travaille, il a besoin de plus d’oxygène et de glucose. Le sang qui ressort emporte aussi plus de CO2.</p>

        <div class="imgbox">
          <img src="images/02-muscle-echanges.png" alt="Infographie : muscle au repos et muscle en activité avec sang entrant et sortant" />
        </div>

        <div class="q" data-q="4">
          <div class="qhead">
            <p class="qtitle">Question 4 — Dans le sang entrant, on trouve surtout…</p>
            <div class="badges">
              <span class="badge">C1</span>
              <span class="pts">2,0 pts</span>
            </div>
          </div>
          <div class="opts">
            <label class="opt"><input type="radio" name="q4" value="A"> <span class="otext">De l’oxygène et du glucose</span></label>
            <label class="opt"><input type="radio" name="q4" value="B"> <span class="otext">Du CO2 uniquement</span></label>
            <label class="opt"><input type="radio" name="q4" value="C"> <span class="otext">Des déchets seulement</span></label>
          </div>
        </div>

        <div class="q" data-q="5">
          <div class="qhead">
            <p class="qtitle">Question 5 — Quand le muscle est en activité, le sang sortant contient…</p>
            <div class="badges">
              <span class="badge">C2</span>
              <span class="pts">2,0 pts</span>
            </div>
          </div>
          <div class="opts">
            <label class="opt"><input type="radio" name="q5" value="A"> <span class="otext">Plus de CO2 (plus de déchets)</span></label>
            <label class="opt"><input type="radio" name="q5" value="B"> <span class="otext">Moins de CO2</span></label>
            <label class="opt"><input type="radio" name="q5" value="C"> <span class="otext">Zéro CO2</span></label>
          </div>
        </div>

        <div class="nav">
          <button class="btn" id="back1" type="button">Retour</button>
          <button class="btn primary" id="next1" type="button">Suivant</button>
        </div>
      </section>

      <section id="step2" hidden>
        <h2 class="section-title">Activité 2 : Risque de sédentarité</h2>
        <p class="hint">Regarde les 6 vignettes numérotées. Pour chaque numéro, choisis : risque de sédentarité ou pas de risque.</p>

        <div class="imgbox">
          <img src="images/03-sedentarite-6.png" alt="6 vignettes sur des situations du quotidien (numérotées 1 à 6)" />
        </div>

        <div class="grid6">
          <div class="mini" data-sed="1">
            <div class="mhead"><span>Vignette 1</span><span class="badge">C2 • 1 pt</span></div>
            <div class="toggle">
              <button class="tbtn" type="button" data-value="RISQUE">Risque</button>
              <button class="tbtn" type="button" data-value="PAS">Pas de risque</button>
            </div>
          </div>

          <div class="mini" data-sed="2">
            <div class="mhead"><span>Vignette 2</span><span class="badge">C2 • 1 pt</span></div>
            <div class="toggle">
              <button class="tbtn" type="button" data-value="RISQUE">Risque</button>
              <button class="tbtn" type="button" data-value="PAS">Pas de risque</button>
            </div>
          </div>

          <div class="mini" data-sed="3">
            <div class="mhead"><span>Vignette 3</span><span class="badge">C2 • 1 pt</span></div>
            <div class="toggle">
              <button class="tbtn" type="button" data-value="RISQUE">Risque</button>
              <button class="tbtn" type="button" data-value="PAS">Pas de risque</button>
            </div>
          </div>

          <div class="mini" data-sed="4">
            <div class="mhead"><span>Vignette 4</span><span class="badge">C2 • 1 pt</span></div>
            <div class="toggle">
              <button class="tbtn" type="button" data-value="RISQUE">Risque</button>
              <button class="tbtn" type="button" data-value="PAS">Pas de risque</button>
            </div>
          </div>

          <div class="mini" data-sed="5">
            <div class="mhead"><span>Vignette 5</span><span class="badge">C2 • 1 pt</span></div>
            <div class="toggle">
              <button class="tbtn" type="button" data-value="RISQUE">Risque</button>
              <button class="tbtn" type="button" data-value="PAS">Pas de risque</button>
            </div>
          </div>

          <div class="mini" data-sed="6">
            <div class="mhead"><span>Vignette 6</span><span class="badge">C2 • 1 pt</span></div>
            <div class="toggle">
              <button class="tbtn" type="button" data-value="RISQUE">Risque</button>
              <button class="tbtn" type="button" data-value="PAS">Pas de risque</button>
            </div>
          </div>
        </div>

        <div class="nav">
          <button class="btn" id="back2" type="button">Retour</button>
          <button class="btn primary" id="next2" type="button">Suivant</button>
        </div>
      </section>

      <section id="step3" hidden>
        <h2 class="section-title">Activité 3 : Les 3 bien-être (OMS)</h2>
        <p class="hint">Pour l’OMS, la santé est un état de bien-être complet : physique, mental et social.</p>

        <div class="imgbox">
          <img src="images/04-bien-etre-9.png" alt="9 vignettes numérotées 1 à 9 sur des activités liées au bien-être" />
        </div>

        <div class="q" data-q="12">
          <div class="qhead">
            <p class="qtitle">Question 12 — Quel numéro montre surtout le bien-être social ?</p>
            <div class="badges">
              <span class="badge">C1</span>
              <span class="pts">2,0 pts</span>
            </div>
          </div>
          <div class="opts">
            <label class="opt"><input type="radio" name="q12" value="A"> <span class="otext">2 (discuter avec d’autres)</span></label>
            <label class="opt"><input type="radio" name="q12" value="B"> <span class="otext">1 (courir)</span></label>
            <label class="opt"><input type="radio" name="q12" value="C"> <span class="otext">3 (lire seul)</span></label>
          </div>
        </div>

        <div class="q" data-q="13">
          <div class="qhead">
            <p class="qtitle">Question 13 — Propose une action simple pour bouger plus au quotidien</p>
            <div class="badges">
              <span class="badge">C4</span>
              <span class="pts">2,0 pts</span>
            </div>
          </div>
          <div class="opts">
            <label class="opt"><input type="radio" name="q13" value="A"> <span class="otext">Marcher 10 minutes</span></label>
            <label class="opt"><input type="radio" name="q13" value="B"> <span class="otext">Prendre les escaliers</span></label>
            <label class="opt"><input type="radio" name="q13" value="C"> <span class="otext">Faire une pause active (se lever, s’étirer)</span></label>
            <label class="opt"><input type="radio" name="q13" value="D"> <span class="otext">Rester assis plus longtemps</span></label>
          </div>
        </div>

        <div class="nav">
          <button class="btn" id="back3" type="button">Retour</button>
          <button class="btn primary" id="finish" type="button">Terminer</button>
        </div>

        <div class="status" id="status"></div>
        <p class="tiny">À la fin : Télécharger JSON ou Envoyer.</p>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJJn3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.firebasestorage.app",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55",
      measurementId: "G-7R9N0JL6GG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const MAX_SCORE = 20;

    const answerKey = {
      "1": { correct: ["A"], points: 2, competence: "C1" },
      "2": { correct: ["A"], points: 2, competence: "C1" },
      "3": { correct: ["A"], points: 2, competence: "C2" },
      "4": { correct: ["A"], points: 2, competence: "C1" },
      "5": { correct: ["A"], points: 2, competence: "C2" },
      "6": { correct: ["RISQUE"], points: 1, competence: "C2" },
      "7": { correct: ["PAS"], points: 1, competence: "C2" },
      "8": { correct: ["RISQUE"], points: 1, competence: "C2" },
      "9": { correct: ["PAS"], points: 1, competence: "C2" },
      "10":{ correct: ["RISQUE"], points: 1, competence: "C2" },
      "11":{ correct: ["PAS"], points: 1, competence: "C2" },
      "12":{ correct: ["A"], points: 2, competence: "C1" },
      "13":{ correctAny: ["A","B","C"], points: 2, competence: "C4" }
    };

    const state = { reponses: {}, step: 0, scale: 1 };

    const $ = (sel) => document.querySelector(sel);

    const statusEl = $("#status");
    const scoreLine = $("#scoreLine");
    const stepLine = $("#stepLine");

    function setStatus(msg, type="") {
      if(!statusEl) return;
      statusEl.textContent = msg || "";
      statusEl.className = "status " + (type || "");
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function updateScore(){
      let score = 0;
      const details = {};
      for(const qid of Object.keys(answerKey)){
        const rule = answerKey[qid];
        const ans = state.reponses[qid];

        let ok = false;
        if(rule.correct){
          ok = ans !== undefined && rule.correct.includes(ans);
        }else if(rule.correctAny){
          ok = ans !== undefined && rule.correctAny.includes(ans);
        }

        const pts = ok ? rule.points : 0;
        score += pts;

        details[qid] = { points: rule.points, competence: rule.competence, ok: ok, reponse: ans ?? "" };
      }

      scoreLine.textContent = `Note : ${score} / ${MAX_SCORE}`;
      return { score, details };
    }

    function gotoStep(n){
      state.step = clamp(n, 0, 3);
      $("#step0").hidden = state.step !== 0;
      $("#step1").hidden = state.step !== 1;
      $("#step2").hidden = state.step !== 2;
      $("#step3").hidden = state.step !== 3;

      stepLine.textContent = `Étape ${state.step + 1} sur 4`;

      const steps = [$("#s0"), $("#s1"), $("#s2"), $("#s3")];
      steps.forEach((el, i) => {
        el.classList.toggle("active", i === state.step);
        el.classList.toggle("done", i < state.step);
      });

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function bindRadios(qnum, name){
      document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
        r.addEventListener("change", () => {
          state.reponses[String(qnum)] = r.value;
          updateScore();
        });
      });
    }

    function bindSedToggles(){
      document.querySelectorAll('.mini[data-sed]').forEach(mini => {
        const sed = mini.getAttribute("data-sed"); // 1..6
        const qnum = String(5 + Number(sed)); // 6..11

        const btns = mini.querySelectorAll(".tbtn");
        btns.forEach(btn => {
          btn.addEventListener("click", () => {
            btns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            state.reponses[qnum] = btn.getAttribute("data-value"); // RISQUE / PAS
            updateScore();
          });
        });
      });
    }

    function getIdentite(){
      const nom = $("#nom").value.trim();
      const prenom = $("#prenom").value.trim();
      const classe = $("#classe").value.trim();
      return { nom, prenom, classe };
    }

    function validateMinimal(){
      const { nom, prenom, classe } = getIdentite();
      if(!nom || !prenom || !classe){
        setStatus("Complète Nom, Prénom et Classe.", "err");
        return false;
      }
      setStatus("", "");
      return true;
    }

    function buildPayload(){
      const { nom, prenom, classe } = getIdentite();
      const { score, details } = updateScore();

      return {
        type: "copie_eleve_pse",
        nom,
        prenom,
        classe,
        reponses: state.reponses,
        meta: {
          createdAt: new Date().toISOString(),
          competences: ["C1","C2","C4"],
          score,
          maxScore: MAX_SCORE,
          bareme: "/20",
          details
        }
      };
    }

    function downloadJSON(){
      if(!validateMinimal()) return;
      const payload = buildPayload();
      const safe = (s) => String(s || "").trim().toLowerCase().replace(/[^\w\-]+/g, "_").slice(0, 40);
      const filename = `copie_${safe(payload.classe)}_${safe(payload.nom)}_${safe(payload.prenom)}.json`;

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("Fichier JSON téléchargé.", "ok");
    }

    async function sendToFirebase(){
      if(!validateMinimal()) return;
      const payload = buildPayload();
      setStatus("Envoi en cours…", "");
      try{
        await addDoc(collection(db, "bacpro"), payload);
        setStatus("Envoyé. Tu peux fermer la page.", "ok");
      }catch(err){
        setStatus("Erreur d’envoi : " + (err?.message || "inconnue"), "err");
      }
    }

    $("#zoomIn").addEventListener("click", () => {
      state.scale = clamp(state.scale + 0.1, 1, 1.6);
      document.documentElement.style.setProperty("--scale", state.scale.toFixed(2));
    });
    $("#zoomOut").addEventListener("click", () => {
      state.scale = clamp(state.scale - 0.1, 1, 1.6);
      document.documentElement.style.setProperty("--scale", state.scale.toFixed(2));
    });
    $("#toggleDys").addEventListener("click", () => document.body.classList.toggle("dys"));
    $("#toggleContrast").addEventListener("click", () => document.body.classList.toggle("contrast"));

    bindRadios(1, "q1");
    bindRadios(2, "q2");
    bindRadios(3, "q3");
    bindRadios(4, "q4");
    bindRadios(5, "q5");
    bindSedToggles();
    bindRadios(12, "q12");
    bindRadios(13, "q13");

    $("#next0").addEventListener("click", () => gotoStep(1));
    $("#back1").addEventListener("click", () => gotoStep(0));
    $("#next1").addEventListener("click", () => gotoStep(2));
    $("#back2").addEventListener("click", () => gotoStep(1));
    $("#next2").addEventListener("click", () => gotoStep(3));
    $("#back3").addEventListener("click", () => gotoStep(2));
    $("#finish").addEventListener("click", () => {
      gotoStep(3);
      const { score } = updateScore();
      setStatus(`Terminé. Note actuelle : ${score} / ${MAX_SCORE}.`, "ok");
    });

    $("#downloadBtn").addEventListener("click", downloadJSON);
    $("#printBtn").addEventListener("click", () => window.print());
    $("#sendBtn").addEventListener("click", sendToFirebase);

    updateScore();
    gotoStep(0);
  </script>
</body>
</html>
