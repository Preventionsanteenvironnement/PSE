<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>C9 – Les Risques Psychosociaux (RPS) – Révision interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #4f46e5;
      --secondary: #eef2ff;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #1f2937;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --radius: 12px;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      margin: 0;
      padding: 15px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      background: var(--card);
      padding: 25px;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
    }
    h1 {
      text-align: center;
      color: var(--primary);
      margin: 0 0 10px 0;
      font-size: 1.8rem;
    }
    h2 {
      color: var(--primary);
      font-size: 1.3rem;
      border-bottom: 2px solid var(--secondary);
      padding-bottom: 8px;
      margin-top: 0;
    }
    .header-info {
      background-color: var(--secondary);
      border-left: 5px solid var(--primary);
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      font-size: 0.95rem;
    }
    .identity-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      background: #f8fafb;
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #4b5563;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      background-color: #fff;
      box-sizing: border-box;
    }
    .question-item {
      background-color: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid var(--border);
    }
    .question-label {
      font-weight: 600;
      margin-bottom: 10px;
      display: block;
    }
    select.answer-select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--primary);
      color: var(--primary);
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
    }
    .options-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .option-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
    }
    .option-label:hover {
      background: #f3f4f6;
    }
    .feedback {
      margin-top: 10px;
      padding: 12px;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: bold;
      display: none;
    }
    .fb-correct {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    .fb-incorrect {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .correction-detail {
      margin-top: 10px;
      padding: 10px;
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
      color: #92400e;
      display: none;
      font-size: 0.95rem;
    }
    .result-section {
      text-align: center;
      background: #312e81;
      color: white;
      padding: 30px;
      border-radius: var(--radius);
      margin-top: 20px;
    }
    #final-score {
      font-size: 2.5rem;
      font-weight: 800;
      margin: 10px 0;
      color: #818cf8;
    }
    #btn-voir-resultat {
      background-color: var(--success);
      color: white;
      border: none;
      padding: 18px 36px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
    }
    #btn-voir-resultat:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }
    #btn-restart {
      background: transparent;
      border: 2px solid #6366f1;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
      display: none;
    }
    #btn-restart:hover {
      background: rgba(99, 102, 241, 0.2);
    }
    .error-msg {
      color: #fca5a5;
      font-weight: bold;
      margin-bottom: 10px;
      display: none;
    }
    @media (max-width: 600px) {
      .identity-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<div class="container">

  <div class="card">
    <h1>Module C9 : Les Risques Psychosociaux (RPS)</h1>
    <div class="header-info">
      <p><strong>Objectif :</strong> Identifier les facteurs, les conséquences et les mesures de prévention des risques psychosociaux au travail.</p>
    </div>

    <div class="identity-grid">
      <div class="form-group">
        <label for="student-id">Identifiant élève *</label>
        <input type="text" id="student-id" placeholder="Ton identifiant...">
      </div>
      <div class="form-group">
        <label for="student-class">Classe *</label>
        <select id="student-class">
          <option value="">-- Choisir --</option>
          <option value="2BACPRO_GATL1">2BACPRO_GATL1</option>
          <option value="2BACPRO_GATL2">2BACPRO_GATL2</option>
          <option value="1BACPRO_AGO1">1BACPRO_AGO1</option>
          <option value="1BACPRO_AGO2">1BACPRO_AGO2</option>
          <option value="TBACPRO_AGO1">TBACPRO_AGO1</option>
          <option value="TBACPRO_AGO2">TBACPRO_AGO2</option>
          <option value="2_MELEC">2_MELEC</option>
          <option value="1_MELEC">1_MELEC</option>
          <option value="T_MELEC">T_MELEC</option>
          <option value="CAP_PSR1">CAP_PSR1</option>
          <option value="CAP_PSR2">CAP_PSR2</option>
          <option value="CAP_VAN1">CAP_VAN1</option>
          <option value="CAP_VAN2">CAP_VAN2</option>
          <option value="CAP_CAN1">CAP_CAN1</option>
          <option value="CAP_CAN2">CAP_CAN2</option>
          <option value="CAP_HORT1">CAP_HORT1</option>
          <option value="CAP_HORT2">CAP_HORT2</option>
          <option value="CAP_JP1">CAP_JP1</option>
          <option value="CAP_JP2">CAP_JP2</option>
          <option value="Autre">Autre</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Exercice 1 — Identifier les facteurs de risques (5 pts)</h2>
    <p>Indique pour chaque situation s'il s'agit de stress lié à l'organisation, de violence interne ou de violence externe.</p>

    <div class="question-item">
      <span class="question-label">1. Un client insulte le vendeur.</span>
      <select id="q1-1" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-1" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">2. Marc est surchargé de travail.</span>
      <select id="q1-2" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-2" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">3. Dispute violente entre collègues.</span>
      <select id="q1-3" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-3" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">4. Harcèlement moral d'un supérieur.</span>
      <select id="q1-4" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-4" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">5. Agression physique par un usager.</span>
      <select id="q1-5" class="answer-select">
        <option value="">Choisir...</option>
        <option value="stress">Stress / Organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-5" class="feedback"></div>
    </div>

    <div id="cor-ex1" class="correction-detail">
      <strong>Correction :</strong> 1. Externe (client) • 2. Stress (surcharge) • 3. Interne (collègues) • 4. Interne (hiérarchie) • 5. Externe (usager).
    </div>
  </div>

  <div class="card">
    <h2>Exercice 2 — Classer les conséquences (5 pts)</h2>

    <div class="question-item">
      <span class="question-label">1. Dépression ou burn-out</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-1" value="sante"> Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-1" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-1" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">2. Augmentation de l'absentéisme</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-2" value="sante"> Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-2" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-2" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">3. TMS (mal de dos)</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-3" value="sante"> Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-3" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-3" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">4. Baisse de la productivité</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-4" value="sante"> Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-4" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-4" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">5. Tentative de suicide</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-5" value="sante"> Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-5" value="entreprise"> Entreprise</label>
      </div>
      <div id="fb-q2-5" class="feedback"></div>
    </div>

    <div id="cor-ex2" class="correction-detail">
      <strong>Correction :</strong> Santé : burn-out, TMS, tentative de suicide • Entreprise : absentéisme, baisse de productivité.
    </div>
  </div>

  <div class="card">
    <h2>Exercice 3 — Mesures de prévention (5 pts)</h2>

    <div class="question-item">
      <span class="question-label">1. Dépliant sur les RPS.</span>
      <select id="q3-1" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-1" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">2. Apprendre aux managers à gérer les conflits.</span>
      <select id="q3-2" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-2" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">3. Réduire la surcharge de travail.</span>
      <select id="q3-3" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-3" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">4. Favoriser l'autonomie.</span>
      <select id="q3-4" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-4" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">5. Cellule d'écoute psychologique.</span>
      <select id="q3-5" class="answer-select">
        <option value="">Choisir...</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-5" class="feedback"></div>
    </div>

    <div id="cor-ex3" class="correction-detail">
      <strong>Correction :</strong> Information : dépliant • Formation : managers • Organisation : surcharge, autonomie, cellule d'écoute.
    </div>
  </div>

  <div class="card">
    <h2>Exercice 4 — Définitions (5 pts)</h2>

    <div class="question-item">
      <span class="question-label">1. Épuisement par surcharge de travail et stress.</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-1" value="burnout"> Le burn-out</label>
        <label class="option-label"><input type="radio" name="q4-1" value="boreout"> Le bore-out</label>
      </div>
      <div id="fb-q4-1" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">2. Épuisement par l'ennui (manque de travail).</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-2" value="burnout"> Le burn-out</label>
        <label class="option-label"><input type="radio" name="q4-2" value="boreout"> Le bore-out</label>
      </div>
      <div id="fb-q4-2" class="feedback"></div>
    </div>

    <div class="question-item">
      <span class="question-label">3. Vrai ou faux : le harcèlement sexuel est une violence interne.</span>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-3" value="vrai"> Vrai</label>
        <label class="option-label"><input type="radio" name="q4-3" value="faux"> Faux</label>
      </div>
      <div id="fb-q4-3" class="feedback"></div>
    </div>

    <div id="cor-ex4" class="correction-detail">
      <strong>Correction :</strong> 1. Burn-out • 2. Bore-out • 3. Vrai.
    </div>
  </div>

  <div class="result-section">
    <div id="error-message" class="error-msg"></div>

    <div id="score-display" style="display:none;">
      <h3>Ton bilan</h3>
      <p id="final-score">-- / 20</p>
      <p id="score-comment"></p>
    </div>

    <button id="btn-voir-resultat" onclick="calculateAndSend()">VOIR MON RÉSULTAT</button>
    <button id="btn-restart" onclick="location.reload()">Recommencer</button>
  </div>

</div>

<script type="module">
  // 1. CONNEXION FIREBASE
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  // Ta configuration (inchangée)
  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 2. TUYAU N°1 : STATISTIQUES D'USAGE (Automatique)
  async function envoyerStatistiqueOuverture() {
    try {
      await addDoc(collection(db, "statistiques_usage"), {
        page_titre: document.title,
        date: serverTimestamp(),
        type_action: "ouverture_page"
      });
      console.log("Statistique d'ouverture envoyée.");
    } catch (e) {
      console.log("Erreur stat ou hors ligne:", e);
    }
  }
  // On lance la stat dès l'ouverture de la page
  envoyerStatistiqueOuverture();


  // 3. FONCTIONS UTILITAIRES POUR LE CALCUL
  function getLevel(score, max) {
    let ratio = score / max;
    if (ratio < 0.25) return 0; // NM
    if (ratio < 0.50) return 1; // IM
    if (ratio < 0.75) return 2; // M
    return 3;                   // BM
  }

  function checkSelects(answers, pts) {
    let s = 0;
    for (const [id, val] of Object.entries(answers)) {
      const el = document.getElementById(id);
      const fb = document.getElementById("fb-" + id);
      if (el && fb) {
        fb.style.display = "block";
        if (el.value === val) {
          s += pts;
          fb.className = "feedback fb-correct";
          fb.textContent = "✅ Correct";
        } else {
          fb.className = "feedback fb-incorrect";
          fb.textContent = "❌ Faux";
        }
      }
    }
    return s;
  }

  function checkRadios(answers, pts) {
    let s = 0;
    for (const [name, val] of Object.entries(answers)) {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      const fb = document.getElementById("fb-" + name);
      if (fb) {
        fb.style.display = "block";
        if (el && el.value === val) {
          s += pts;
          fb.className = "feedback fb-correct";
          fb.textContent = "✅ Correct";
        } else {
          fb.className = "feedback fb-incorrect";
          fb.textContent = "❌ Faux";
        }
      }
    }
    return s;
  }

  function checkRadioSingle(name, val, pts) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    const fb = document.getElementById("fb-" + name);
    if (fb) {
      fb.style.display = "block";
      if (el && el.value === val) {
        fb.className = "feedback fb-correct";
        fb.textContent = "✅ Correct";
        return pts;
      } else {
        fb.className = "feedback fb-incorrect";
        fb.textContent = "❌ Faux";
        return 0;
      }
    }
    return 0;
  }

  // 4. TUYAU N°2 : ÉVALUATION ET ENVOI (Au clic)
  window.calculateAndSend = async function () {
    const idEleve = document.getElementById("student-id").value.trim();
    const classeEleve = document.getElementById("student-class").value;
    const btn = document.getElementById("btn-voir-resultat");
    const errorMsg = document.getElementById("error-message");
    const restartBtn = document.getElementById("btn-restart");

    if (!idEleve || !classeEleve) {
      errorMsg.textContent = "⚠️ Merci de saisir ton identifiant et de choisir ta classe.";
      errorMsg.style.display = "block";
      return;
    }
    errorMsg.style.display = "none";
    btn.textContent = "Envoi vers CodePilote...";
    btn.disabled = true;

    // --- CALCUL DES POINTS ---
    // Exo 1 & 2 -> C2 (Analyse) / 10 pts
    let ptsC2 = 0;
    ptsC2 += checkSelects({ "q1-1": "externe", "q1-2": "stress", "q1-3": "interne", "q1-4": "interne", "q1-5": "externe" }, 1);
    ptsC2 += checkRadios({ "q2-1": "sante", "q2-2": "entreprise", "q2-3": "sante", "q2-4": "entreprise", "q2-5": "sante" }, 1);

    // Exo 3 -> C4 (Solution) / 5 pts
    let ptsC4 = 0;
    ptsC4 += checkSelects({ "q3-1": "information", "q3-2": "formation", "q3-3": "organisation", "q3-4": "organisation", "q3-5": "organisation" }, 1);

    // Exo 4 -> C1 (Connaissances) / 5 pts
    let ptsC1 = 0;
    ptsC1 += checkRadioSingle("q4-1", "burnout", 1.5);
    ptsC1 += checkRadioSingle("q4-2", "boreout", 1.5);
    ptsC1 += checkRadioSingle("q4-3", "vrai", 2);

    // Note finale
    let total = ptsC1 + ptsC2 + ptsC4;
    total = Math.min(20, Math.round(total * 10) / 10);

    // Affichage Feedback
    document.getElementById("final-score").textContent = total + " / 20";
    document.getElementById("score-display").style.display = "block";
    document.querySelectorAll(".correction-detail").forEach(el => el.style.display = "block");

    // --- PRÉPARATION DU PAQUET CODEPILOTE ---
    const paquetCodePilote = {
      identifiant: idEleve,
      classe: classeEleve,
      exercice_titre: document.title,
      exercice_id: "C9_RPS_revisions", // ID unique
      date: serverTimestamp(),
      
      // Note
      note_finale: total,
      note_sur: 20,

      // Compétences (Niveaux 0,1,2,3)
      competences: {
        C1_Traiter_Info: getLevel(ptsC1, 5),
        C2_Analyse: getLevel(ptsC2, 10),
        C4_Solution: getLevel(ptsC4, 5)
      }
    };

    // --- ENVOI VERS LA COLLECTION CODEPILOTE ---
    try {
      await addDoc(collection(db, "evaluations_competences"), paquetCodePilote);
      alert("✅ Résultat enregistré avec succès dans CodePilote !");
    } catch (e) {
      console.error("Erreur", e);
      alert("Erreur de connexion : " + e.message);
    }

    btn.style.display = "none";
    restartBtn.style.display = "inline-block";
  };
</script>

</body>
</html>
