<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>C9 – Les Risques Psychosociaux (RPS) – Révision interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#eef2ff;
      --bg-soft:#e5e7eb;
      --card:#ffffff;
      --border:#e5e7eb;
      --primary:#4f46e5;
      --primary-soft:#eef2ff;
      --accent:#06b6d4;
      --accent-soft:#cffafe;
      --success:#22c55e;
      --success-soft:#dcfce7;
      --danger:#ef4444;
      --danger-soft:#fee2e2;
      --warn:#f59e0b;
      --warn-soft:#fef3c7;
      --text:#111827;
      --muted:#6b7280;
      --radius-lg:20px;
      --radius:12px;
      --shadow:0 18px 40px rgba(15,23,42,.18);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,"Segoe UI","Inter",sans-serif;
      background:radial-gradient(circle at top,#e0e7ff 0,#eef2ff 35%,#e5e7eb 100%);
      color:var(--text);
      line-height:1.6;
      padding:14px;
    }
    .page{
      max-width:960px;
      margin:0 auto;
      background:linear-gradient(to bottom right,rgba(255,255,255,.98),rgba(239,246,255,.99));
      border-radius:26px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:var(--shadow);
      padding:20px 16px 24px;
    }
    header{
      border-radius:var(--radius-lg);
      padding:18px 18px 16px;
      background:
        radial-gradient(circle at 0 0,rgba(79,70,229,.16),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(6,182,212,.18),transparent 55%),
        #ffffff;
      border:1px solid rgba(129,140,248,.55);
      margin-bottom:18px;
    }
    .title-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .title-main{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .title-main h1{
      font-size:1.5rem;
      letter-spacing:.03em;
      color:#111827;
    }
    .title-main h1 span{
      color:var(--primary);
    }
    .title-main small{
      font-size:.8rem;
      color:var(--muted);
    }
    .badge-box{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      font-size:.78rem;
      color:var(--muted);
    }
    .badge{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(129,140,248,.7);
      background:rgba(248,250,252,.9);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge span.dot{
      width:8px;height:8px;border-radius:999px;background:var(--accent);
    }
    .obj-card{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      background:var(--primary-soft);
      border:1px solid rgba(129,140,248,.45);
      font-size:.88rem;
    }
    .obj-card strong{color:var(--primary);}
    .obj-meta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:.78rem;
      color:var(--muted);
    }
    .obj-meta span.tag{
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:#f9fafb;
    }
    .section-card{
      background:#ffffff;
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      padding:18px 16px 18px;
      box-shadow:0 10px 25px rgba(15,23,42,.08);
      margin-bottom:16px;
    }
    .section-card h2{
      font-size:1.12rem;
      color:var(--primary);
      margin-bottom:4px;
    }
    .section-sub{
      font-size:.85rem;
      color:var(--muted);
      margin-bottom:14px;
    }
    .identity-grid{
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:16px;
      background:#f9fafb;
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:14px;
    }
    .form-group label{
      display:block;
      font-size:.82rem;
      font-weight:600;
      color:#374151;
      margin-bottom:4px;
    }
    .form-group small{
      display:block;
      font-size:.7rem;
      color:var(--muted);
      margin-top:2px;
    }
    .form-group input,
    .form-group select{
      width:100%;
      padding:10px 11px;
      border-radius:9px;
      border:1px solid #d1d5db;
      font-size:.95rem;
      background:#ffffff;
    }
    .form-group input:focus,
    .form-group select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(79,70,229,.35);
    }
    .question-block{
      background:#f9fafb;
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:12px 12px 10px;
      margin-bottom:10px;
    }
    .question-label{
      font-weight:600;
      margin-bottom:6px;
      font-size:.94rem;
    }
    .question-help{
      font-size:.78rem;
      color:var(--muted);
      margin-bottom:6px;
    }
    .answer-select{
      width:100%;
      padding:9px 10px;
      border-radius:9px;
      border:1px solid rgba(79,70,229,.55);
      color:var(--primary);
      font-weight:600;
      background:#ffffff;
      font-size:.9rem;
    }
    .options-group{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .option-label{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:9px;
      border:1px solid #d1d5db;
      background:#ffffff;
      font-size:.9rem;
    }
    .option-label input{accent-color:var(--primary);}
    .feedback{
      margin-top:8px;
      padding:8px 9px;
      border-radius:8px;
      font-size:.8rem;
      font-weight:600;
      display:none;
    }
    .fb-ok{
      background:var(--success-soft);
      color:#166534;
      border:1px solid #86efac;
    }
    .fb-ko{
      background:var(--danger-soft);
      color:#991b1b;
      border:1px solid #fca5a5;
    }
    .correction-detail{
      margin-top:8px;
      padding:8px 10px;
      border-radius:8px;
      background:var(--warn-soft);
      border-left:4px solid var(--warn);
      font-size:.8rem;
      color:#92400e;
      display:none;
    }
    .result-zone{
      margin-top:4px;
      border-radius:var(--radius-lg);
      background:#111827;
      color:#e5e7eb;
      padding:20px 14px 18px;
      text-align:center;
    }
    .error-msg{
      display:none;
      color:#fecaca;
      background:#7f1d1d;
      border-radius:10px;
      padding:8px 10px;
      font-size:.82rem;
      margin-bottom:10px;
      border:1px solid #fecaca;
    }
    #score-box{
      display:none;
      margin-top:6px;
    }
    #final-score{
      font-size:2.3rem;
      font-weight:800;
      color:#a5b4fc;
      margin:4px 0 4px;
    }
    #score-comment{
      font-size:.9rem;
      color:#e5e7eb;
      margin-bottom:6px;
    }
    #competences-resume{
      font-size:.8rem;
      color:#cbd5f5;
    }
    .main-btn{
      margin-top:12px;
      width:100%;
      max-width:420px;
      border-radius:999px;
      border:none;
      padding:14px 20px;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      background:linear-gradient(120deg,#22c55e,#4ade80);
      color:#052e16;
      box-shadow:0 10px 22px rgba(34,197,94,.35);
    }
    .main-btn:disabled{
      opacity:.6;
      cursor:default;
      box-shadow:none;
    }
    #btn-restart{
      margin-top:10px;
      border-radius:999px;
      background:transparent;
      border:1px solid #6366f1;
      color:#e5e7eb;
      padding:8px 16px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      display:none;
    }
    #btn-restart:hover{
      background:rgba(129,140,248,.12);
    }
    @media(max-width:720px){
      body{padding:10px;}
      .page{padding:16px 12px 20px;border-radius:20px;}
      .identity-grid{grid-template-columns:1fr;}
      header{padding:14px 12px 12px;}
      .title-main h1{font-size:1.25rem;}
    }
  </style>
</head>
<body>
<div class="page">

  <header>
    <div class="title-row">
      <div class="title-main">
        <h1><span>C9</span> – Les risques psychosociaux (RPS)</h1>
        <small>Exercice interactif de révision (CAP / Bac Pro)</small>
      </div>
      <div class="badge-box">
        <div class="badge"><span class="dot"></span>Compatible téléphone et ordinateur</div>
        <div class="badge">Envoi automatique vers PageProf / Firebase</div>
      </div>
    </div>
    <div class="obj-card">
      <strong>Objectifs de la séance</strong>
      <ul style="margin:6px 0 0 16px;font-size:.86rem;">
        <li>Identifier les types de risques psychosociaux (stress, violences interne / externe).</li>
        <li>Classer les conséquences pour le salarié et pour l’entreprise.</li>
        <li>Relier les situations à des mesures de prévention adaptées.</li>
      </ul>
      <div class="obj-meta">
        <span class="tag">Compétences : C1 • C2 • C3 • C4</span>
        <span class="tag">Score final sur 20</span>
      </div>
    </div>
  </header>

  <section class="section-card">
    <h2>Identification élève</h2>
    <p class="section-sub">Ton identifiant est une lettre + deux chiffres (ex. S10, M03), code remis par le prof.</p>
    <div class="identity-grid">
      <div class="form-group">
        <label for="student-id">Identifiant élève *</label>
        <input id="student-id" type="text" maxlength="4" placeholder="Ex : S10" />
        <small>Identifiant remis par le prof (lettre du prénom + jour de naissance).</small>
      </div>
      <div class="form-group">
        <label for="student-class">Classe *</label>
        <select id="student-class">
          <option value="">-- Choisir ta classe --</option>
          <option value="2BACPRO_GATL1">2BACPRO_GATL1</option>
          <option value="2BACPRO_GATL2">2BACPRO_GATL2</option>
          <option value="1BACPRO_AGO1">1BACPRO_AGO1</option>
          <option value="1BACPRO_AGO2">1BACPRO_AGO2</option>
          <option value="TBACPRO_AGO1">TBACPRO_AGO1</option>
          <option value="TBACPRO_AGO2">TBACPRO_AGO2</option>
          <option value="2_MELEC">2_MELEC</option>
          <option value="1_MELEC">1_MELEC</option>
          <option value="T_MELEC">T_MELEC</option>
          <option value="CAP_PSR1">CAP_PSR1</option>
          <option value="CAP_PSR2">CAP_PSR2</option>
          <option value="CAP_VAN1">CAP_VAN1</option>
          <option value="CAP_VAN2">CAP_VAN2</option>
          <option value="CAP_CAN1">CAP_CAN1</option>
          <option value="CAP_CAN2">CAP_CAN2</option>
          <option value="CAP_HORT1">CAP_HORT1</option>
          <option value="CAP_HORT2">CAP_HORT2</option>
          <option value="CAP_JP1">CAP_JP1</option>
          <option value="CAP_JP2">CAP_JP2</option>
          <option value="Autre">Autre</option>
        </select>
      </div>
    </div>
  </section>

  <section class="section-card">
    <h2>Exercice 1 – Identifier le type de RPS (5 pts)</h2>
    <p class="section-sub">Pour chaque situation, choisis si c’est du stress lié à l’organisation, de la violence interne ou de la violence externe.</p>

    <div class="question-block">
      <div class="question-label">1. Un client insulte le vendeur.</div>
      <select id="q1-1" class="answer-select">
        <option value="">Choisir…</option>
        <option value="stress">Stress / organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-1" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">2. Marc est surchargé de travail.</div>
      <select id="q1-2" class="answer-select">
        <option value="">Choisir…</option>
        <option value="stress">Stress / organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-2" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">3. Dispute violente entre collègues.</div>
      <select id="q1-3" class="answer-select">
        <option value="">Choisir…</option>
        <option value="stress">Stress / organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-3" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">4. Harcèlement moral d’un supérieur.</div>
      <select id="q1-4" class="answer-select">
        <option value="">Choisir…</option>
        <option value="stress">Stress / organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-4" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">5. Agression physique par un usager.</div>
      <select id="q1-5" class="answer-select">
        <option value="">Choisir…</option>
        <option value="stress">Stress / organisation</option>
        <option value="interne">Violence interne</option>
        <option value="externe">Violence externe</option>
      </select>
      <div id="fb-q1-5" class="feedback"></div>
    </div>

    <div id="cor-ex1" class="correction-detail">
      Correction : 1 Externe (client) • 2 Stress (surcharge) • 3 Interne (collègues) • 4 Interne (hiérarchie) • 5 Externe (usager).
    </div>
  </section>

  <section class="section-card">
    <h2>Exercice 2 – Classer les conséquences (5 pts)</h2>
    <p class="section-sub">Pour chaque conséquence, indique si elle touche la santé du salarié ou l’entreprise.</p>

    <div class="question-block">
      <div class="question-label">1. Dépression ou burn-out.</div>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-1" value="sante">Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-1" value="entreprise">Entreprise</label>
      </div>
      <div id="fb-q2-1" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">2. Augmentation de l’absentéisme.</div>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-2" value="sante">Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-2" value="entreprise">Entreprise</label>
      </div>
      <div id="fb-q2-2" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">3. TMS (mal de dos).</div>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-3" value="sante">Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-3" value="entreprise">Entreprise</label>
      </div>
      <div id="fb-q2-3" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">4. Baisse de la productivité.</div>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-4" value="sante">Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-4" value="entreprise">Entreprise</label>
      </div>
      <div id="fb-q2-4" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">5. Tentative de suicide.</div>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q2-5" value="sante">Santé du salarié</label>
        <label class="option-label"><input type="radio" name="q2-5" value="entreprise">Entreprise</label>
      </div>
      <div id="fb-q2-5" class="feedback"></div>
    </div>

    <div id="cor-ex2" class="correction-detail">
      Correction : Santé = burn-out, TMS, tentative de suicide. Entreprise = absentéisme, baisse de productivité.
    </div>
  </section>

  <section class="section-card">
    <h2>Exercice 3 – Mesures de prévention (5 pts)</h2>
    <p class="section-sub">Choisis si la mesure est de l’information, de la formation ou une action d’organisation du travail.</p>

    <div class="question-block">
      <div class="question-label">1. Dépliant d’information sur les RPS.</div>
      <select id="q3-1" class="answer-select">
        <option value="">Choisir…</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-1" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">2. Former les managers à gérer les conflits.</div>
      <select id="q3-2" class="answer-select">
        <option value="">Choisir…</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-2" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">3. Réduire la surcharge de travail.</div>
      <select id="q3-3" class="answer-select">
        <option value="">Choisir…</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-3" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">4. Donner plus d’autonomie dans l’organisation du travail.</div>
      <select id="q3-4" class="answer-select">
        <option value="">Choisir…</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-4" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">5. Mettre en place une cellule d’écoute psychologique.</div>
      <select id="q3-5" class="answer-select">
        <option value="">Choisir…</option>
        <option value="information">Information</option>
        <option value="formation">Formation</option>
        <option value="organisation">Organisation</option>
      </select>
      <div id="fb-q3-5" class="feedback"></div>
    </div>

    <div id="cor-ex3" class="correction-detail">
      Correction : Information = dépliant. Formation = managers. Organisation = surcharge, autonomie, cellule d’écoute.
    </div>
  </section>

  <section class="section-card">
    <h2>Exercice 4 – Définitions et vrai/faux (5 pts)</h2>
    <p class="section-sub">Choisis la bonne définition ou la bonne réponse.</p>

    <div class="question-block">
      <div class="question-label">1. Épuisement par surcharge de travail et stress.</div>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-1" value="burnout">Burn-out</label>
        <label class="option-label"><input type="radio" name="q4-1" value="boreout">Bore-out</label>
      </div>
      <div id="fb-q4-1" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">2. Épuisement par l’ennui (manque de travail).</div>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-2" value="burnout">Burn-out</label>
        <label class="option-label"><input type="radio" name="q4-2" value="boreout">Bore-out</label>
      </div>
      <div id="fb-q4-2" class="feedback"></div>
    </div>

    <div class="question-block">
      <div class="question-label">3. Vrai ou faux : le harcèlement sexuel est une forme de violence interne.</div>
      <div class="options-group">
        <label class="option-label"><input type="radio" name="q4-3" value="vrai">Vrai</label>
        <label class="option-label"><input type="radio" name="q4-3" value="faux">Faux</label>
      </div>
      <div id="fb-q4-3" class="feedback"></div>
    </div>

    <div id="cor-ex4" class="correction-detail">
      Correction : 1 Burn-out • 2 Bore-out • 3 Vrai (violence interne dans l’entreprise).
    </div>
  </section>

  <section class="result-zone">
    <div id="error-message" class="error-msg"></div>

    <div id="score-box">
      <h3 style="font-size:1.05rem;">Ton bilan sur les risques psychosociaux</h3>
      <div id="final-score">-- / 20</div>
      <p id="score-comment"></p>
      <p id="competences-resume"></p>
    </div>

    <button id="btn-result" class="main-btn" type="button">VOIR MON RÉSULTAT</button>
    <button id="btn-restart" type="button">Recommencer l’exercice</button>
  </section>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const COL_NAME = "exercices";
  const SUPPORT_CODE = "C9_RPS_revisions";

  const startTime = Date.now();

  const $ = (id)=>document.getElementById(id);

  const answersEx1 = {
    "q1-1":"externe",
    "q1-2":"stress",
    "q1-3":"interne",
    "q1-4":"interne",
    "q1-5":"externe"
  };
  const answersEx2 = {
    "q2-1":"sante",
    "q2-2":"entreprise",
    "q2-3":"sante",
    "q2-4":"entreprise",
    "q2-5":"sante"
  };
  const answersEx3 = {
    "q3-1":"information",
    "q3-2":"formation",
    "q3-3":"organisation",
    "q3-4":"organisation",
    "q3-5":"organisation"
  };

  function levelFromScore(score,max){
    if(score <= 0) return "NM";
    const r = score / max;
    if(r < 0.5) return "IM";
    if(r < 0.8) return "M";
    return "BM";
  }

  function showFeedbackSelect(map, basePts, prefix){
    let pts = 0;
    for(const [id, good] of Object.entries(map)){
      const el = $(id);
      const fb = $("fb-"+id);
      fb.style.display = "block";
      if(el.value === good){
        pts += basePts;
        fb.className = "feedback fb-ok";
        fb.textContent = "✅ Correct : tu as bien identifié "+prefix;
      }else{
        fb.className = "feedback fb-ko";
        fb.textContent = "❌ À revoir : relis bien la définition avant de répondre.";
      }
    }
    return pts;
  }

  function showFeedbackRadios(map, basePts, prefix){
    let pts = 0;
    for(const [name, good] of Object.entries(map)){
      const el = document.querySelector(`input[name="${name}"]:checked`);
      const fb = $("fb-"+name);
      fb.style.display = "block";
      if(el && el.value === good){
        pts += basePts;
        fb.className = "feedback fb-ok";
        fb.textContent = "✅ Correct pour cette conséquence ("+prefix+").";
      }else{
        fb.className = "feedback fb-ko";
        fb.textContent = "❌ Mauvaise catégorie : essaie de distinguer santé / entreprise.";
      }
    }
    return pts;
  }

  function showFeedbackRadioSingle(name, good, pts, msgOk, msgKo){
    const el = document.querySelector(`input[name="${name}"]:checked`);
    const fb = $("fb-"+name);
    fb.style.display = "block";
    if(el && el.value === good){
      fb.className = "feedback fb-ok";
      fb.textContent = "✅ "+msgOk;
      return pts;
    }else{
      fb.className = "feedback fb-ko";
      fb.textContent = "❌ "+msgKo;
      return 0;
    }
  }

  async function calculateAndSend(){
    const idEleve = $("student-id").value.trim();
    const classeEleve = $("student-class").value;
    const errorMsg = $("error-message");
    const btn = $("btn-result");
    const restartBtn = $("btn-restart");

    if(!idEleve || !classeEleve){
      errorMsg.textContent = "Merci de saisir ton identifiant et de choisir ta classe avant de voir ton résultat.";
      errorMsg.style.display = "block";
      return;
    }
    errorMsg.style.display = "none";

    btn.disabled = true;
    btn.textContent = "Correction en cours…";

    let totalScore = 0;

    const ptsEx1 = showFeedbackSelect(answersEx1, 1, "le type de risque");
    const ptsEx2 = showFeedbackRadios(answersEx2, 1, "RPS");
    const ptsEx3 = showFeedbackSelect(answersEx3, 1, "la bonne mesure de prévention");

    let ptsEx4 = 0;
    ptsEx4 += showFeedbackRadioSingle("q4-1","burnout",1.5,"Tu as reconnu le burn-out.","C’est le burn-out (épuisement par surcharge).");
    ptsEx4 += showFeedbackRadioSingle("q4-2","boreout",1.5,"Tu as reconnu le bore-out.","C’est le bore-out (épuisement par l’ennui).");
    ptsEx4 += showFeedbackRadioSingle("q4-3","vrai",2,"Oui, c’est bien une violence interne.","Le harcèlement sexuel est une violence interne.");

    totalScore = ptsEx1 + ptsEx2 + ptsEx3 + ptsEx4;
    totalScore = Math.min(20, Math.round(totalScore * 10) / 10);

    ["cor-ex1","cor-ex2","cor-ex3","cor-ex4"].forEach(id=>{
      $(id).style.display = "block";
    });

    const scoreBox = $("score-box");
    const finalScoreEl = $("final-score");
    const scoreComment = $("score-comment");
    const compResume = $("competences-resume");

    finalScoreEl.textContent = `${totalScore} / 20`;
    scoreBox.style.display = "block";

    let commentaireGlobal = "";
    if(totalScore <= 5){
      commentaireGlobal = "Niveau très fragile : reprends le cours sur les définitions de base des RPS.";
    }else if(totalScore <= 10){
      commentaireGlobal = "Tu as quelques repères, mais il faut encore consolider les notions clés.";
    }else if(totalScore <= 15){
      commentaireGlobal = "Bon début : les notions principales sont maîtrisées, continue à t’entraîner.";
    }else{
      commentaireGlobal = "Très bon résultat : tu maîtrises bien les notions de ce module C9.";
    }
    scoreComment.textContent = commentaireGlobal;

    const c2Score = ptsEx1 + ptsEx2;
    const c4Score = ptsEx3;
    const c3Score = ptsEx4;
    const c1Score = totalScore;

    const lvlGlobal = levelFromScore(totalScore,20);
    const lvlC1 = levelFromScore(c1Score,20);
    const lvlC2 = levelFromScore(c2Score,10);
    const lvlC3 = levelFromScore(c3Score,5);
    const lvlC4 = levelFromScore(c4Score,5);

    compResume.textContent =
      `C1 ${lvlC1} • C2 ${lvlC2} • C3 ${lvlC3} • C4 ${lvlC4} (C5 et C6 non travaillées dans cet exercice).`;

    const now = new Date();
    const tempsPasse = Math.round((Date.now() - startTime) / 1000);
    const tentativesKey = `tries_${SUPPORT_CODE}_${idEleve}`;
    let tentatives = Number(localStorage.getItem(tentativesKey) || "0") + 1;
    localStorage.setItem(tentativesKey,String(tentatives));

    try{
      await addDoc(collection(db, COL_NAME), {
        meta:{
          createdAt: now.toISOString(),
          nom: idEleve,
          prenom: idEleve,
          classe: classeEleve,
          type: "exercice",
          support: SUPPORT_CODE
        },
        resultat:{
          score: `${totalScore} / 20`,
          url: location.href,
          titre: document.title,
          niveauGlobal: lvlGlobal,
          competences:{
            C1: lvlC1,
            C2: lvlC2,
            C3: lvlC3,
            C4: lvlC4,
            C5: "",
            C6: ""
          },
          tempsPasse: tempsPasse,
          tentatives: tentatives
        }
      });
    }catch(e){
      console.error("Erreur d’envoi Firestore", e);
    }

    btn.style.display = "none";
    restartBtn.style.display = "inline-block";
    restartBtn.onclick = ()=>location.reload();
  }

  $("btn-result").addEventListener("click", calculateAndSend);
</script>
</body>
</html>
