<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSE Bac Pro — Compétence C3</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f1730;
      --card2:#111a33;
      --line:rgba(255,255,255,.10);
      --txt:#eef2ff;
      --muted:#b9c5ff;
      --ok:#2bd4a6;
      --bad:#ff5a7a;
      --warn:#ffcf5a;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(92,124,255,.22), transparent 60%),
        radial-gradient(900px 600px at 82% 28%, rgba(43,212,166,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 95%, rgba(255,90,122,.14), transparent 55%),
        var(--bg);
      line-height:1.45;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .top{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ .top{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:16px;
      box-shadow:var(--shadow);
    }
    h1{margin:0 0 8px 0;font-size:22px}
    h2{margin:0 0 10px 0;font-size:18px}
    h3{margin:14px 0 8px 0;font-size:15px;color:var(--muted)}
    p{margin:8px 0;color:var(--muted)}
    .pillRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:8px 10px;border-radius:999px;
      font-size:13px;color:var(--muted);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      padding:2px 6px;border-radius:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .scoreBox{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .scoreBig{font-size:18px;font-weight:800}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;border:1px solid var(--line);min-width:180px}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg, rgba(43,212,166,.95), rgba(92,124,255,.95))}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      font-weight:750;
      transition: transform .08s ease, background .2s ease;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button:active{transform: translateY(1px)}
    .primary{background: rgba(43,212,166,.16);border-color: rgba(43,212,166,.35)}
    .danger{background: rgba(255,90,122,.14);border-color: rgba(255,90,122,.32)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    .stepRow{display:flex;gap:8px;flex-wrap:wrap}
    .step{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      padding:10px 12px;border-radius:14px;
      display:flex;gap:10px;align-items:flex-start;
      flex:1;
      min-width:210px;
    }
    .step strong{color:var(--txt)}
    .step span{color:var(--muted);font-size:13px}

    .q{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    .qHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:4px 8px;border-radius:999px
    }
    select, input[type="text"], textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .choices{display:grid;gap:10px;margin-top:8px}
    .choiceBox{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:12px;border-radius:16px;
    }
    .choiceRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .radioPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .radioPill input{margin:0}
    .small{font-size:12px;color:var(--muted)}
    .feedback{
      margin-top:10px;
      padding:10px 12px;border-radius:14px;
      border:1px dashed var(--line);
      color:var(--muted);
      display:none;
    }
    .feedback.ok{display:block;border-color:rgba(43,212,166,.45);color:rgba(214,255,244,.95);background: rgba(43,212,166,.10)}
    .feedback.bad{display:block;border-color:rgba(255,90,122,.50);color:rgba(255,220,228,.95);background: rgba(255,90,122,.10)}
    .feedback.warn{display:block;border-color:rgba(255,207,90,.55);color:rgba(255,243,210,.95);background: rgba(255,207,90,.10)}

    .drags{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.drags{grid-template-columns:1fr}}
    .bank,.zone{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.14);
      min-height:120px;
    }
    .token{
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      margin:6px 6px 0 0;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      cursor:grab;
      font-size:13px;
    }
    .token:active{cursor:grabbing}
    .bank h4,.zone h4{margin:0 0 8px 0;font-size:13px;color:var(--muted);font-weight:800}

    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.twoCols{grid-template-columns:1fr}}

    .rubric{display:grid;gap:8px;margin-top:10px}
    .rubric label{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px;border-radius:14px;
      cursor:pointer;color:var(--muted)
    }
    .rubric input{margin-top:2px}
    .mini{font-size:12px;color:var(--muted);margin-top:10px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .linkish{color:rgba(180,200,255,.95);font-weight:800}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid var(--line);
      padding:10px 12px;border-radius:14px;
      color:var(--txt);
      display:none;
      box-shadow: var(--shadow);
      max-width: calc(100% - 28px);
      z-index: 9999;
    }

    @media print{
      body{background:white;color:black}
      .wrap{padding:0}
      .btnRow, .toast{display:none !important}
      .card{box-shadow:none;border:1px solid #ccc;background:white}
      .q{background:white}
      select,input,textarea{border:1px solid #999;background:white;color:black}
      .token{border:1px solid #999;background:white;color:black}
      .pill,.tag,.kbd{border:1px solid #999;background:white;color:black}
      .feedback{display:block !important;border:1px solid #999 !important;background:white !important;color:black !important}
    }
  
.token.selected{outline:2px solid var(--accent, #7ee7d7); box-shadow:0 0 0 4px rgba(126,231,215,.15);}
.dndInfo{margin-top:10px; font-size:0.92rem; opacity:.85; line-height:1.25;}
</style>
</head>
<body>
  <div class="wrap">

    <section class="top">
      <div class="card">
        <h1>Compétence C3</h1>

        <div class="pillRow">
          <div class="pill"><span class="kbd">C3</span> Expliquer un mécanisme, un lien cause → effet, un intérêt, une règle</div>
          <div class="pill"><span class="kbd">C4</span> Proposer une mesure</div>
          <div class="pill"><span class="kbd">C5</span> Argumenter un choix</div>
          <div class="pill"><span class="kbd">C6</span> Écrire clair + vocabulaire adapté</div>
        </div>

        <div class="sep"></div>

        <h2>Méthode C3</h2>

        <div class="stepRow">
          <div class="step"><strong>Cause</strong><span>facteur / situation</span></div>
          <div class="step"><strong>Mécanisme</strong><span>comment ça agit</span></div>
          <div class="step"><strong>Conséquence</strong><span>effet sur santé / env / travail</span></div>
          <div class="step"><strong>Prévention</strong><span>seulement si demandé</span></div>
          <div class="step"><strong>Justification</strong><span>pourquoi ça réduit le risque</span></div>
        </div>

        <div class="q">
          <div class="qHead">
            <strong>Qualité de rédaction</strong>
            <span class="tag">C6</span>
          </div>
          <div class="hint">
            Phrases complètes<br>
            Vocabulaire scientifique<br>
            Connecteurs logiques : car, donc, ainsi, en conséquence, puisque, c’est pourquoi
          </div>
        </div>

        <div class="mini">
          Thèmes du bac blanc : GES et transports (JO) • alimentation flexitarienne • risque imminent et grave (chantiers)
        </div>
      </div>

      <aside class="card">
        <h2>Suivi</h2>

        <div class="scoreBox">
          <div style="min-width:220px">
            <div class="small">Élève</div>
            <input id="studentName" type="text" placeholder="Prénom" />
          </div>
          <div>
            <div class="small">Score</div>
            <div class="scoreBig"><span id="score">0</span> / <span id="maxScore">24</span></div>
          </div>
          <div style="min-width:220px">
            <div class="small">Progression</div>
            <div class="bar"><div id="barFill"></div></div>
          </div>
        </div>

        <div class="btnRow">
          <button class="primary" id="checkAll">Tout corriger</button>
          <button id="saveBtn">Sauvegarder</button>
          <button id="exportBtn">Exporter</button>
          <button id="printBtn">Imprimer</button>
          <button class="danger" id="resetBtn">Réinitialiser</button>
        </div>

        <div class="sep"></div>

        <h2>Choisir un mini-sujet</h2>

        <select id="themeSelect"></select>

        <div class="mini">
          Objectif : réussir les questions C3 du bac en expliquant clairement le lien cause → effet
        </div>
      </aside>
    </section>

    <section class="grid">

      <div class="card">
        <h2>Repères</h2>

        <div class="q">
          <div class="qHead">
            <strong>Différencier C2, C3, C4, C5, C6</strong>
            <span class="tag">Bloom : analyser</span>
          </div>
          <div class="hint">
            <span class="kbd">C2</span> repérer, identifier, indiquer, relever<br>
            <span class="kbd">C3</span> expliquer un mécanisme, un lien, un intérêt, une règle<br>
            <span class="kbd">C4</span> proposer une mesure de prévention<br>
            <span class="kbd">C5</span> choisir + argumenter (justifier un choix)<br>
            <span class="kbd">C6</span> écrire clair : phrases + vocabulaire + connecteurs
          </div>
          <div class="mini">
            Si la réponse tient en un mot ou un chiffre, c’est souvent C2
          </div>
        </div>

        <div class="q">
          <div class="qHead">
            <strong>Verbes utiles</strong>
            <span class="tag">Bloom : comprendre</span>
          </div>
          <div class="hint">
            <span class="kbd">Expliquer</span> comment / pourquoi<br>
            <span class="kbd">Relier</span> A entraîne B car…<br>
            <span class="kbd">Justifier</span> parce que… donc…<br>
            <span class="kbd">Argumenter</span> choix + raisons (C5)
          </div>
        </div>

      </div>

      <div class="card">
        <h2>Entraînement progressif</h2>

        <div class="q" data-q="1" data-max="6">
          <div class="qHead">
            <strong>Exercice 1</strong>
            <span class="tag">Identifier la compétence</span>
            <span class="tag">6 points</span>
          </div>

          <p>Pour chaque consigne, choisir la compétence la plus logique</p>

          <div class="choices" id="ex1"></div>

          <button class="primary" data-action="check1">Corriger</button>

          <div class="feedback" id="fb1"></div>
        </div>

        <div class="q" data-q="2" data-max="6">
          <div class="qHead">
            <strong>Exercice 2</strong>
            <span class="tag">Compléter une explication C3</span>
            <span class="tag">6 points</span>
          </div>

          <div id="clozeText" class="hint"></div>

          <div style="margin-top:10px;display:grid;gap:10px">
            <select id="c2a"></select>
            <select id="c2b"></select>
            <select id="c2c"></select>
          </div>

          <button class="primary" data-action="check2">Corriger</button>

          <div class="feedback" id="fb2"></div>
        </div>

        <div class="q" data-q="3" data-max="6">
          <div class="qHead">
            <strong>Exercice 3</strong>
            <span class="tag">Classer : cause / mécanisme / conséquence / prévention</span>
            <span class="tag">6 points</span>
          </div>

          <p class="hint">Ordinateur : glisse-dépose. Smartphone ou tablette : touche un mot pour le sélectionner, puis touche la case où le déposer.</p>
<div class="drags">
            <div class="bank" id="bank">
              <h4>Banque</h4>
            </div>

            <div style="display:grid;gap:12px">
              <div class="zone" data-accept="cause"><h4>Cause</h4></div>
              <div class="zone" data-accept="meca"><h4>Mécanisme</h4></div>
              <div class="zone" data-accept="cons"><h4>Conséquence</h4></div>
              <div class="zone" data-accept="prev"><h4>Prévention</h4></div>
            </div>
          </div>

          <div class="btnRow">
            <button class="primary" data-action="check3">Corriger</button>
            <button data-action="reset3">Remettre</button>
          </div>

          <div class="feedback" id="fb3"></div>
        </div>

        <div class="q" data-q="4" data-max="6">
          <div class="qHead">
            <strong>Exercice 4</strong>
            <span class="tag">Rédiger type bac</span>
            <span class="tag">6 points</span>
          </div>

          <div class="twoCols">
            <div>
              <h3>Consigne</h3>
              <div id="prompt4" class="hint"></div>

              <div class="sep"></div>

              <textarea id="answer4" placeholder="6 à 10 lignes, phrases complètes, connecteurs"></textarea>

              <div class="btnRow">
                <button class="primary" data-action="check4">Valider</button>
                <button data-action="showModel">Voir le modèle</button>
                <button data-action="buildAnswer">Générer avec les blocs</button>
              </div>

              <div class="feedback" id="fb4"></div>
            </div>

            <div>
              <h3>Auto-barème</h3>

              <div class="rubric" id="rubric4">
                <label><input type="checkbox" data-pts="1"> Cause ou facteur nommé</label>
                <label><input type="checkbox" data-pts="1"> Mécanisme expliqué</label>
                <label><input type="checkbox" data-pts="1"> Conséquence précisée</label>
                <label><input type="checkbox" data-pts="1"> Si demandé : une prévention est proposée</label>
                <label><input type="checkbox" data-pts="1"> Justification : prévention → réduction du risque</label>
                <label><input type="checkbox" data-pts="1"> C6 : phrases + vocabulaire + connecteurs</label>
              </div>

              <div class="sep"></div>

              <h3>Blocs C3</h3>
              <div class="hint">Remplir les blocs puis générer</div>

              <div style="display:grid;gap:10px;margin-top:8px">
                <textarea id="bCause" placeholder="Cause"></textarea>
                <textarea id="bMeca" placeholder="Mécanisme"></textarea>
                <textarea id="bCons" placeholder="Conséquence"></textarea>
                <textarea id="bPrev" placeholder="Prévention si demandé"></textarea>
                <textarea id="bJust" placeholder="Justification de la prévention"></textarea>
              </div>

              <div class="q" style="margin-top:12px">
                <div class="qHead">
                  <strong>Modèle</strong>
                  <span class="tag">Exemple</span>
                </div>
                <div id="model4" class="hint"></div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </section>

    <div class="toast" id="toast"></div>
  </div>

  <script>

    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    
const isTouch = (('ontouchstart' in window) || (navigator.maxTouchPoints > 0));
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));

    const themes = [
      {
        id:"jo_transport",
        title:"JO 2024 : Transports en commun et GES",
        ex1:[
          {txt:"Identifier les impacts des GES sur l’environnement", ans:"C2", why:"On liste des impacts"},
          {txt:"Expliquer en quoi favoriser les transports en commun limite les émissions de GES", ans:"C3", why:"Lien cause → effet"},
          {txt:"Proposer une mesure individuelle pour réduire les GES liés au transport", ans:"C4", why:"Mesure concrète"},
          {txt:"Indiquer le secteur émettant le plus de GES", ans:"C2", why:"Une info ciblée"},
          {txt:"Sélectionner un panier à privilégier et argumenter", ans:"C5", why:"Choix + justification"},
          {txt:"Expliquer la notion de risque imminent et grave", ans:"C3", why:"Définition expliquée"}
        ],
        cloze:{
          text:"Favoriser les ___ réduit le nombre de ___ sur la route. Or le ___ est un secteur très émetteur, donc cela ___ les émissions de GES.",
          a:{label:"Choisir", opts:["transports en commun","voitures de sport","feux d’artifice"], ans:"transports en commun"},
          b:{label:"Choisir", opts:["véhicules individuels","arbres","stades"], ans:"véhicules individuels"},
          c:{label:"Choisir", opts:["transport","recyclage","bénévolat"], ans:"transport"}
        },
        drag:[
          {t:"Beaucoup de spectateurs se déplacent", type:"cause"},
          {t:"Le transport routier émet des GES", type:"cause"},
          {t:"Moins de voitures si on prend métro/bus", type:"meca"},
          {t:"Moins de carburant consommé", type:"meca"},
          {t:"Réduction des émissions de CO2", type:"cons"},
          {t:"Moins de pollution de l’air", type:"cons"},
          {t:"Covoiturage / mobilités douces", type:"prev"},
          {t:"Vélo ou marche sur place", type:"prev"}
        ],
        prompt:"Expliquer en quoi favoriser les transports en commun lors des Jeux de Paris 2024 est une mesure permettant de limiter les émissions de GES.",
        model:"Favoriser les transports en commun réduit le nombre de véhicules individuels sur la route. Or le transport est un secteur très émetteur de gaz à effet de serre. Moins de voitures signifie moins de carburant brûlé et donc moins d’émissions de CO2, ce qui limite l’impact sur le climat. Ainsi, cette mesure contribue à réduire les GES liés aux déplacements du public."
      },
      {
        id:"flexitarien",
        title:"Alimentation : flexitarien (pratique choisie)",
        ex1:[
          {txt:"Évaluer l’empreinte carbone de burgers et repérer les ingrédients à impact élevé", ans:"C2", why:"Lecture de données"},
          {txt:"Expliquer en quoi l’alimentation flexitarienne est une pratique alimentaire choisie", ans:"C3", why:"Explication + sens"},
          {txt:"Proposer une mesure individuelle pour limiter l’impact carbone de l’alimentation", ans:"C4", why:"Mesure concrète"},
          {txt:"Identifier pourquoi le panier flexitarien a un meilleur Nutri-Score", ans:"C2", why:"Cause simple (plus de végétaux)"},
          {txt:"Sélectionner le panier à privilégier et argumenter", ans:"C5", why:"Choix + justification"},
          {txt:"Indiquer une information utile sur l’étiquette (DLC, allergènes…)", ans:"C2", why:"Repérage"}
        ],
        cloze:{
          text:"Une alimentation flexitarienne est une alimentation ___ : on ___ sa consommation de viande, par ___ ou convictions, sans contrainte médicale.",
          a:{label:"Choisir", opts:["choisie","imposée","interdite"], ans:"choisie"},
          b:{label:"Choisir", opts:["réduit","double","annule"], ans:"réduit"},
          c:{label:"Choisir", opts:["goûts","amendes","machines"], ans:"goûts"}
        },
        drag:[
          {t:"Je souhaite réduire mon impact carbone", type:"cause"},
          {t:"La viande (bœuf) a un bilan carbone élevé", type:"cause"},
          {t:"Je mange moins de viande et plus de végétaux", type:"meca"},
          {t:"Je choisis selon mes goûts/convictions", type:"meca"},
          {t:"Moins d’émissions liées à l’élevage", type:"cons"},
          {t:"Menu plus riche en fruits/légumes", type:"cons"},
          {t:"Privilégier circuits courts", type:"prev"},
          {t:"Limiter produits ultra-transformés", type:"prev"}
        ],
        prompt:"Expliquer en quoi l’alimentation flexitarienne est une pratique alimentaire choisie.",
        model:"L’alimentation flexitarienne est une pratique alimentaire choisie car la personne décide volontairement de réduire sa consommation de viande tout en continuant à en manger parfois. Ce choix peut être motivé par des goûts, des convictions personnelles ou la volonté de limiter son impact sur l’environnement. Il ne s’agit pas d’une contrainte médicale mais d’une décision personnelle."
      },
      {
        id:"chantier",
        title:"Chantiers JO : risque imminent et grave",
        ex1:[
          {txt:"Identifier les principaux risques sur un chantier (chute, électrique…)", ans:"C2", why:"Liste de risques"},
          {txt:"Expliquer la notion de risque imminent et grave (arrêt de travaux)", ans:"C3", why:"Définition expliquée"},
          {txt:"Proposer une mesure de prévention collective et une individuelle pour un risque prioritaire", ans:"C4", why:"Mesures concrètes"},
          {txt:"Indiquer la signification de DUERP", ans:"C2", why:"Sigle"},
          {txt:"Sélectionner le risque à traiter en priorité et argumenter", ans:"C5", why:"Choix + justification"},
          {txt:"Indiquer trois critères de reconnaissance d’un accident du travail", ans:"C2", why:"Repérage critères"}
        ],
        cloze:{
          text:"Un risque est dit ___ si l’accident peut arriver à tout moment, et ___ si les conséquences peuvent être très importantes. Cela peut conduire à un ___ des travaux.",
          a:{label:"Choisir", opts:["imminent","lent","imaginaire"], ans:"imminent"},
          b:{label:"Choisir", opts:["grave","léger","inutile"], ans:"grave"},
          c:{label:"Choisir", opts:["arrêt","démarrage","report"], ans:"arrêt"}
        },
        drag:[
          {t:"Situation dangereuse sur le chantier", type:"cause"},
          {t:"Absence de protection collective", type:"cause"},
          {t:"Accident possible à tout moment", type:"meca"},
          {t:"Dommage potentiellement très important", type:"meca"},
          {t:"Décision d’arrêt de travaux", type:"cons"},
          {t:"Protection de la santé et sécurité", type:"cons"},
          {t:"Séparer engins/piétons + balisage", type:"prev"},
          {t:"Gilet haute visibilité", type:"prev"}
        ],
        prompt:"Expliquer la notion de risque imminent et grave qui conduit à la décision d’arrêt de travaux.",
        model:"Un risque est dit imminent lorsque l’accident peut survenir à tout moment, sans délai. Il est dit grave lorsque les conséquences possibles sont très importantes (blessures graves, décès, incapacité). Quand un risque est à la fois imminent et grave, on peut décider d’arrêter les travaux pour protéger immédiatement la santé et la sécurité des travailleurs."
      }
    ];

    const state = {
      points:{1:0,2:0,3:0,4:0},
      max:{1:6,2:6,3:6,4:6},
      themeId: themes[0].id
    };

    function totalScore(){ return Object.values(state.points).reduce((a,b)=>a+b,0); }
    function maxScore(){ return Object.values(state.max).reduce((a,b)=>a+b,0); }

    function renderScore(){
      $("#score").textContent = totalScore();
      $("#maxScore").textContent = maxScore();
      const pct = (totalScore()/maxScore())*100;
      $("#barFill").style.width = clamp(pct,0,100).toFixed(0) + "%";
    }

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._id);
      toast._id = setTimeout(()=>t.style.display="none", 1700);
    }

    function setFeedback(id, kind, html){
      const el = $(id);
      el.className = "feedback " + kind;
      el.innerHTML = html;
    }

    function currentTheme(){
      return themes.find(t=>t.id===state.themeId) || themes[0];
    }

    function fillThemes(){
      const sel = $("#themeSelect");
      sel.innerHTML = themes.map(t=>`<option value="${t.id}">${t.title}</option>`).join("");
      sel.value = state.themeId;
      sel.addEventListener("change", ()=>{
        state.themeId = sel.value;
        buildAll();
        toast("Mini-sujet changé");
        saveLocal();
      });
    }

    function buildEx1(){
      const t = currentTheme();
      const wrap = $("#ex1");
      wrap.innerHTML = "";

      t.ex1.forEach((item, idx)=>{
        const qId = `ex1_${idx}`;
        const block = document.createElement("div");
        block.className = "choiceBox";
        block.innerHTML = `
          <div style="font-weight:900">${idx+1}. ${item.txt}</div>
          <div class="small" style="margin-top:6px">Indice : ${item.why}</div>
          <div class="choiceRow" role="group" aria-label="Choix de compétence">
            ${makeRadio(qId,"C2","C2")}
            ${makeRadio(qId,"C3","C3")}
            ${makeRadio(qId,"C4","C4")}
            ${makeRadio(qId,"C5","C5")}
          </div>
          <div class="small">Choix : <span class="kbd">C2</span> <span class="kbd">C3</span> <span class="kbd">C4</span> <span class="kbd">C5</span></div>
        `;
        wrap.appendChild(block);
      });
    }

    function makeRadio(name, value, label){
      const id = `${name}_${value}`;
      return `
        <label class="radioPill" for="${id}">
          <input id="${id}" type="radio" name="${name}" value="${value}">
          <span class="kbd">${label}</span>
        </label>
      `;
    }

    function check1(){
      const t = currentTheme();
      let pts = 0;
      let wrong = [];
      t.ex1.forEach((item, idx)=>{
        const qId = `ex1_${idx}`;
        const picked = ($$(`input[name="${qId}"]:checked`)[0] || {}).value || "";
        if(picked === item.ans) pts += 1;
        else wrong.push(idx+1);
      });
      state.points[1] = pts;
      if(pts === 6){
        setFeedback("#fb1","ok",`✅ ${pts}/6. Bonne lecture des consignes.`);
      }else{
        setFeedback("#fb1","warn",`⚠️ ${pts}/6. À revoir : item(s) ${wrong.join(", ")}. Astuce : expliquer = C3 ; proposer = C4 ; argumenter = C5 ; repérer/identifier = C2.`);
      }
      renderScore();
      saveLocal();
    }

    function buildCloze(){
      const t = currentTheme();
      $("#clozeText").innerHTML = t.cloze.text.replaceAll("___", `<span class="kbd">…</span>`);
      const a = $("#c2a"), b = $("#c2b"), c = $("#c2c");
      a.innerHTML = `<option value="">${t.cloze.a.label}</option>` + t.cloze.a.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      b.innerHTML = `<option value="">${t.cloze.b.label}</option>` + t.cloze.b.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      c.innerHTML = `<option value="">${t.cloze.c.label}</option>` + t.cloze.c.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      a.value=""; b.value=""; c.value="";
    }

    function check2(){
      const t = currentTheme();
      let pts = 0;
      if($("#c2a").value === t.cloze.a.ans) pts += 2;
      if($("#c2b").value === t.cloze.b.ans) pts += 2;
      if($("#c2c").value === t.cloze.c.ans) pts += 2;
      state.points[2] = pts;

      if(pts === 6){
        setFeedback("#fb2","ok","✅ 6/6. Explication C3 correcte.");
      }else{
        setFeedback("#fb2","bad",`❌ ${pts}/6. Relis la phrase : elle doit expliquer un lien cause → effet avec du sens.`);
      }
      renderScore();
      saveLocal();
    }

    let dragItem = null;

    function enableDnD(){
      document.addEventListener("dragstart", e=>{
        if(e.target.classList && e.target.classList.contains("token")){
          dragItem = e.target;
          setTimeout(()=>dragItem.style.opacity=".55",0);
        }
      });
      document.addEventListener("dragend", e=>{
        if(dragItem){
          dragItem.style.opacity="1";
          dragItem = null;
        }
      });

      $$(".zone, #bank").forEach(z=>{
        z.addEventListener("dragover", e=>e.preventDefault());
        z.addEventListener("drop", e=>{
          e.preventDefault();
          if(!dragItem) return;
          z.appendChild(dragItem);
        });
      });
    }

function enableTouchPickPlace(){
  // Mode mobile : toucher pour sélectionner, toucher une zone pour déposer
  const bank = $("#bank");
  let selected = null;

  const toast = (msg)=>{
    const t = $("#toast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>t.classList.remove("show"), 1200);
  };

  const clearSel = ()=>{
    if(selected){
      selected.classList.remove("selected");
      selected = null;
    }
  };

  document.addEventListener("pointerdown", (e)=>{
    if(!isTouch) return;

    const tok = e.target.closest(".token");
    const drop = e.target.closest(".zone, #bank");

    if(tok){
      e.preventDefault();
      if(selected === tok){
        bank.appendChild(tok);
        clearSel();
        toast("Mot remis dans la banque");
      }else{
        clearSel();
        selected = tok;
        tok.classList.add("selected");
        toast("Mot sélectionné");
      }
      return;
    }

    if(drop && selected){
      e.preventDefault();
      drop.appendChild(selected);
      clearSel();
      toast("Déposé");
      return;
    }

    // Tap ailleurs : on annule la sélection
    if(selected) clearSel();
  }, {passive:false});
}



    function buildDrag(){
      const t = currentTheme();
      const bank = $("#bank");
      bank.innerHTML = "<h4>Banque</h4>";
      t.drag.forEach((item)=>{
        const d = document.createElement("div");
        d.className = "token";
        d.draggable = !isTouch;
        d.dataset.type = item.type;
        d.textContent = item.t;
        bank.appendChild(d);
      });

      $$(".zone").forEach(z=>{
        $$(".token", z).forEach(tok=>bank.appendChild(tok));
      });
    }

    function reset3(){
      const bank = $("#bank");
      $$(".zone .token").forEach(t=>bank.appendChild(t));
      state.points[3] = 0;
      setFeedback("#fb3","warn","Remis à zéro.");
      renderScore();
      saveLocal();
    }

    function check3(){
      let pts = 0;
      let wrong = [];
      $$(".zone").forEach(z=>{
        const accept = z.dataset.accept;
        $$(".token", z).forEach(tok=>{
          if(tok.dataset.type === accept) pts += 1;
          else wrong.push(tok.textContent.trim());
        });
      });

      state.points[3] = clamp(pts,0,6);

      if(state.points[3] === 6){
        setFeedback("#fb3","ok","✅ 6/6. Structure maîtrisée.");
      }else{
        const ex = wrong.slice(0,4).map(s=>`• ${s}`).join("<br>");
        setFeedback("#fb3","warn",`⚠️ ${state.points[3]}/6. À replacer :<br>${ex}${wrong.length>4?"<br>• …":""}<br><br>Astuce : prévention = action concrète ; mécanisme = comment ça agit.`);
      }
      renderScore();
      saveLocal();
    }

    function buildEx4(){
      const t = currentTheme();
      $("#prompt4").innerHTML = `<span class="linkish">${t.title}</span><br><br>${t.prompt}`;
      $("#model4").textContent = t.model;

      $("#answer4").value = "";
      $$("#rubric4 input").forEach(cb=>cb.checked=false);
      $("#bCause").value=""; $("#bMeca").value=""; $("#bCons").value=""; $("#bPrev").value=""; $("#bJust").value="";
    }

    function check4(){
      const text = $("#answer4").value.trim();
      let pts = 0;

      $$("#rubric4 input[type=\"checkbox\"]").forEach(cb=>{
        if(cb.checked) pts += Number(cb.dataset.pts || 0);
      });

      if(text.length < 180){
        pts = Math.min(pts, 3);
        setFeedback("#fb4","warn",`⚠️ ${pts}/6. Réponse trop courte. Vise 6 à 10 lignes, avec mécanisme + conséquence.`);
      }else{
        if(pts >= 5) setFeedback("#fb4","ok",`✅ ${pts}/6. Niveau bac.`);
        else if(pts >= 3) setFeedback("#fb4","warn",`⚠️ ${pts}/6. Ajoute connecteurs + vocabulaire précis (C6) et vérifie le mécanisme.`);
        else setFeedback("#fb4","bad",`❌ ${pts}/6. Reprends : cause → mécanisme → conséquence.`);
      }

      state.points[4] = clamp(pts,0,6);
      renderScore();
      saveLocal();
    }

    function showModel(){
      const m = $("#model4");
      m.parentElement.scrollIntoView({behavior:"smooth", block:"start"});
      toast("Modèle visible");
    }

    function buildAnswerFromBlocks(){
      const parts = [];
      const c = $("#bCause").value.trim();
      const m = $("#bMeca").value.trim();
      const k = $("#bCons").value.trim();
      const p = $("#bPrev").value.trim();
      const j = $("#bJust").value.trim();

      if(c) parts.push(c);
      if(m) parts.push(m);
      if(k) parts.push(k);
      if(p) parts.push(p);
      if(j) parts.push(j);

      const built = parts.join(" ");
      if(built.length < 10){
        toast("Remplir au moins un bloc");
        return;
      }
      $("#answer4").value = built;
      toast("Réponse générée");
      saveLocal();
    }

    function checkAll(){
      check1();
      check2();
      check3();
      check4();
      const pct = Math.round((totalScore()/maxScore())*100);
      if(pct >= 85) toast("Bravo");
      else if(pct >= 60) toast("Bien");
      else toast("À reprendre");
    }

    function resetAll(){
      state.points = {1:0,2:0,3:0,4:0};

      // ex1
      currentTheme().ex1.forEach((_, idx)=>{
        const qId = `ex1_${idx}`;
        $$(`input[name="${qId}"]`).forEach(r=>r.checked=false);
      });

      // ex2
      $("#c2a").value = ""; $("#c2b").value = ""; $("#c2c").value = "";

      // ex3
      reset3();

      // ex4
      $("#answer4").value = "";
      $$("#rubric4 input").forEach(cb=>cb.checked=false);
      $("#bCause").value=""; $("#bMeca").value=""; $("#bCons").value=""; $("#bPrev").value=""; $("#bJust").value="";

      ["#fb1","#fb2","#fb3","#fb4"].forEach(id=>{
        const el = $(id);
        el.className = "feedback";
        el.style.display = "none";
        el.textContent = "";
      });

      renderScore();
      saveLocal();
      toast("Réinitialisé");
    }

    function saveLocal(){
      const payload = {
        themeId: state.themeId,
        points: state.points,
        studentName: $("#studentName").value || "",
        inputs: {
          c2a: $("#c2a").value,
          c2b: $("#c2b").value,
          c2c: $("#c2c").value,
          answer4: $("#answer4").value,
          rubric4: $$("#rubric4 input").map(cb=>cb.checked),
          blocks: {
            bCause: $("#bCause").value,
            bMeca: $("#bMeca").value,
            bCons: $("#bCons").value,
            bPrev: $("#bPrev").value,
            bJust: $("#bJust").value
          },
          ex1: currentTheme().ex1.map((_, idx)=>{
            const qId = `ex1_${idx}`;
            const picked = ($$(`input[name="${qId}"]:checked`)[0] || {}).value || "";
            return picked;
          })
        }
      };
      localStorage.setItem("pse_c3_ex2_j2024", JSON.stringify(payload));
    }

    function restoreLocal(){
      const raw = localStorage.getItem("pse_c3_ex2_j2024");
      if(!raw) return;
      try{
        const payload = JSON.parse(raw);
        if(payload.themeId) state.themeId = payload.themeId;
        if(payload.studentName) $("#studentName").value = payload.studentName;

        $("#themeSelect").value = state.themeId;
        buildAll(false);

        // ex1 restore
        const ex1 = payload.inputs?.ex1 || [];
        ex1.forEach((val, idx)=>{
          const qId = `ex1_${idx}`;
          if(val) {
            const r = $(`input[name="${qId}"][value="${val}"]`);
            if(r) r.checked = true;
          }
        });

        // cloze
        if(payload.inputs?.c2a) $("#c2a").value = payload.inputs.c2a;
        if(payload.inputs?.c2b) $("#c2b").value = payload.inputs.c2b;
        if(payload.inputs?.c2c) $("#c2c").value = payload.inputs.c2c;

        // ex4
        if(payload.inputs?.answer4) $("#answer4").value = payload.inputs.answer4;
        const rb = payload.inputs?.rubric4 || [];
        $$("#rubric4 input").forEach((cb,i)=>cb.checked = !!rb[i]);

        const blocks = payload.inputs?.blocks || {};
        $("#bCause").value = blocks.bCause || "";
        $("#bMeca").value = blocks.bMeca || "";
        $("#bCons").value = blocks.bCons || "";
        $("#bPrev").value = blocks.bPrev || "";
        $("#bJust").value = blocks.bJust || "";

        // points
        if(payload.points) state.points = payload.points;
        renderScore();
      }catch(e){}
    }

    async function exportAll(){
      const name = ($("#studentName").value || "eleve").trim().replaceAll(" ","_");
      const t = currentTheme();
      const data = {
        student: name,
        theme: t.title,
        score: {got: totalScore(), max: maxScore()},
        answer: $("#answer4").value || "",
        timestamp: new Date().toISOString()
      };
      const txt = JSON.stringify(data, null, 2);
      try{
        await navigator.clipboard.writeText(txt);
        toast("Export copié");
      }catch(e){
        toast("Copie impossible");
      }
    }

    function buildAll(resetEx4=true){
      buildEx1();
      buildCloze();
      buildDrag();
      if(resetEx4) buildEx4();
      renderScore();
    }

    document.addEventListener("click", e=>{
      const a = e.target?.dataset?.action;
      if(!a) return;
      if(a==="check1") check1();
      if(a==="check2") check2();
      if(a==="check3") check3();
      if(a==="reset3") reset3();
      if(a==="check4") check4();
      if(a==="showModel") showModel();
      if(a==="buildAnswer") buildAnswerFromBlocks();
    });

    $("#checkAll").addEventListener("click", checkAll);
    $("#resetBtn").addEventListener("click", resetAll);
    $("#saveBtn").addEventListener("click", ()=>{ saveLocal(); toast("Sauvegardé"); });
    $("#exportBtn").addEventListener("click", exportAll);
    $("#printBtn").addEventListener("click", ()=>window.print());
    $("#studentName").addEventListener("input", saveLocal);

    fillThemes();
    buildAll();
    enableDnD();
  if(isTouch) enableTouchPickPlace();
    restoreLocal();
    renderScore();
  
</script>
</body>
</html>
