<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"/>
<title>Module C1 : Traiter l'information</title>
<style>
  :root{
    --bg:#0b1220; 
    --text:#eaf0ff;
    --card-bg: rgba(16, 31, 61, 0.95);
    --accent:#7dd3fc; /* Bleu C1 */
    --accent2:#a78bfa; /* Violet */
    --success:#34d399;
    --error:#fb7185;
    --font-ui: system-ui, -apple-system, sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:var(--font-ui); color:var(--text);
    background: radial-gradient(1200px 600px at 20% -10%, rgba(125, 211, 252,.15), transparent 55%),
                radial-gradient(900px 520px at 100% 0%, rgba(167, 139, 250,.15), transparent 52%),
                var(--bg);
    padding:10px; padding-bottom:80px;
    background-attachment: fixed;
    user-select: none; overflow-x: hidden;
  }
  .wrap{max-width:900px; margin:0 auto; min-height: 90vh; display: flex; flex-direction: column;}

  /* HEADER COACH */
  .header-zone { display:flex; align-items:center; gap:15px; background: rgba(11, 18, 32, 0.95); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .avatar-circle { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--accent); background: #0f172a; object-fit: cover; flex-shrink: 0;}
  .coach-bubble { font-size: 0.95rem; color: #e2e8f0; line-height: 1.4; }

  /* PAGES */
  .page-section { display: none; animation: fadeIn 0.4s; }
  .page-section.active { display: block; }

  /* COMPOSANTS */
  .card { background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 15px; }
  .card h3 { margin-top:0; color:var(--accent); font-size:1.1rem; display:flex; align-items:center; gap:10px;}
  
  .btn-nav { padding: 14px 24px; background: linear-gradient(135deg, var(--accent2), var(--accent)); color: #0b1220; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 800; width: 100%; transition: 0.2s; box-shadow: 0 4px 15px rgba(125, 211, 252, 0.3); margin-top: 10px; }
  .btn-nav:active { transform: scale(0.98); }
  .btn-nav.ghost { background: transparent; border: 2px solid rgba(255,255,255,0.2); color: var(--text); box-shadow: none; margin-bottom:10px; }
  .btn-small { padding: 8px 12px; font-size: 0.85rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: var(--accent); cursor: pointer; }

  /* LOGIN & INPUTS */
  .login-box { text-align: center; padding: 40px 20px; }
  .name-input, .class-select { background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); color: white; padding: 15px; border-radius: 12px; font-size: 1.1rem; width: 80%; text-align: center; margin: 10px auto; display: block; outline:none; }
  .name-input:focus, .class-select:focus { border-color: var(--accent); }
  .class-select option { background: #0b1220; }

  /* DOCUMENTS (MODAL) */
  .doc-modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; overflow-y: auto; padding: 20px; }
  .doc-content { background: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; border-radius: 16px; border: 1px solid var(--accent); position: relative; }
  .close-doc { position: absolute; top: 10px; right: 10px; background: var(--error); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
  
  .doc-item { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
  .mini-table { width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px; color: #cbd5e1; }
  .mini-table th { text-align:left; color:var(--accent); border-bottom:1px solid rgba(255,255,255,0.1); padding:8px; background: rgba(255,255,255,0.05); }
  .mini-table td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); }

  /* EXERCICES */
  .question-block { margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
  .check-label { display: flex; gap: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; transition:0.2s; align-items: flex-start; }
  .check-label:hover { background: rgba(255,255,255,0.1); }
  .check-label input { margin-top: 4px; }
  
  select.std-select { width:100%; padding:12px; background:#0f172a; border:1px solid rgba(255,255,255,0.3); color:white; border-radius:8px; margin-top:5px; outline:none; font-size: 1rem; }

  /* DRAG & DROP (CHIPS) */
  .bank-zone { display: flex; flex-wrap: wrap; gap: 8px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; min-height: 60px; margin-bottom: 20px; }
  .chip { padding: 8px 14px; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.8rem; font-weight: bold; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition:0.2s; user-select: none; }
  .chip.selected { background: var(--accent2); color: #0b1220; border-color: var(--accent2); transform: scale(1.05); box-shadow: 0 0 15px rgba(167, 139, 250, 0.5); }
  
  .target-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .target-zone { background: rgba(255,255,255,0.02); border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 10px; min-height: 120px; display:flex; flex-direction:column; gap:5px; align-items: center;}
  .target-title { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; font-weight: bold; text-align: center; margin-bottom: 5px; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;}

  /* FIREBASE SEND BLOCK */
  #pse-envoi-prof {
      margin-top: 30px;
      padding: 20px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--accent);
      border-radius: 12px;
      text-align: center;
  }
  #pse-btn-envoyer {
      margin-top: 15px;
      background: var(--success);
      color: #064e3b;
      font-weight: bold;
  }
  #pse-msg { margin-top: 10px; font-weight: bold; min-height: 20px; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 9999; top: -10px; }
  @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

</style>
</head>
<body>

<div class="wrap">

    <div class="header-zone">
        <img src="avatar-neutral.png" class="avatar-circle" id="coachImg" onerror="this.src='https://placehold.co/60?text=Prof'">
        <div class="coach-bubble" id="coachText">Bienvenue ! Pr√™t pour la Comp√©tence C1 ?</div>
    </div>

    <div id="docModal" class="doc-modal">
        <div class="doc-content">
            <button class="close-doc" onclick="toggleDocs()">‚úï</button>
            <h2 style="color:var(--accent); margin-top:0;">üìö Documents Ressources</h2>
            
            <div class="doc-item">
                <h4 style="color:var(--accent); margin:0 0 5px 0;">Doc 1 : Eau du robinet et en bouteille</h4>
                <p style="font-size:0.9rem; color:#e2e8f0;">L‚Äôeau du robinet est <b>potable</b> (elle peut √™tre bue) et fait l‚Äôobjet de contr√¥les.<br>
                L‚Äôeau en bouteille est aussi potable mais elle n√©cessite <b>emballage</b>, <b>transport</b> et g√©n√®re des <b>d√©chets</b> (plastique).<br>
                <ul>
                    <li>Boire l‚Äôeau du robinet peut limiter les d√©chets plastiques.</li>
                    <li>Boire l‚Äôeau en bouteille g√©n√®re plus de d√©chets.</li>
                </ul>
                </p>
            </div>

            <div class="doc-item">
                <h4 style="color:var(--accent); margin:0 0 5px 0;">Doc 2 : DDM et Rappels</h4>
                <p style="font-size:0.9rem; color:#e2e8f0;">
                <b>DDM (Date de Durabilit√© Minimale) :</b> C'est une date de qualit√©. Apr√®s cette date, le produit peut perdre du go√ªt ou de l'odeur mais n‚Äôest <b>pas dangereux</b>.<br><br>
                <b>Rappel de produit :</b> Informe les consommateurs qu‚Äôun produit pr√©sente un <b>risque</b> (ex : contamination). Il faut suivre la consigne (ne pas consommer, rapporter, d√©truire).
                </p>
            </div>

            <div class="doc-item">
                <h4 style="color:var(--accent); margin:0 0 5px 0;">Doc 3 : Habitudes (Tableau)</h4>
                <table class="mini-table">
                    <tr><th>Habitude</th><th>Avant</th><th>Apr√®s changement</th></tr>
                    <tr><td>Douche (dur√©e)</td><td>9 min</td><td>5 min</td></tr>
                    <tr><td>Lave-vaisselle</td><td>1/2 plein</td><td>Plein</td></tr>
                    <tr><td>Chasse d'eau</td><td>Simple</td><td>Double commande</td></tr>
                    <tr><td>Arrosage</td><td>Eau potable</td><td>Eau de pluie</td></tr>
                </table>
            </div>
            
            <button class="btn-nav" onclick="toggleDocs()">Fermer les documents</button>
        </div>
    </div>

    <div id="page0" class="page-section active">
        <div class="login-box">
            <h1 style="background: linear-gradient(to right, var(--accent), var(--accent2)); -webkit-background-clip: text; color: transparent; font-size: 2.5rem; margin-bottom: 10px;">TRAITER L'INFO</h1>
            <div style="font-size:3rem; margin:20px 0;">üìëüß†‚úÖ</div>
            
            <label style="color:#b9c6ff; display:block; margin-bottom:5px; font-size:0.9rem;">Ton identifiant √©l√®ve :</label>
            <input type="text" id="pse-eleve-nom" class="name-input" placeholder="Ton identifiant (ex: E01)...">
            
            <label style="color:#b9c6ff; display:block; margin-bottom:5px; font-size:0.9rem; margin-top:15px;">Ta classe :</label>
            <select id="pse-eleve-classe" class="class-select">
                <option value="">-- Choisis ta classe --</option>
                <option value="CAP 1">CAP 1</option>
                <option value="CAP 2">CAP 2</option>
                <option value="2nde Bac Pro">2nde Bac Pro</option>
                <option value="1√®re Bac Pro">1√®re Bac Pro</option>
                <option value="Tle Bac Pro">Tle Bac Pro</option>
                <option value="Autre">Autre</option>
            </select>

            <button class="btn-nav" onclick="startModule()" style="margin-top:25px;">C'EST PARTI !</button>
        </div>
        <div style="text-align:center; margin-top:40px; color:#64748b; font-size:0.8rem;">Module Interactif</div>
    </div>

    <div id="page1" class="page-section">
        <div class="card">
            <h3>üéØ OBJECTIF C1</h3>
            <p>Dans ce module, tu ne donnes pas ton avis. <br>Ton but : <strong>Rep√©rer, s√©lectionner et classer</strong> l'information utile dans les documents.</p>
            <div style="background:rgba(52, 211, 153, 0.1); padding:15px; border-radius:10px; border-left:4px solid var(--success); margin-top:15px;">
                <strong>Conseil du prof :</strong> Sois pr√©cis. Pas de blabla, juste les faits pr√©sents dans les documents.
            </div>
        </div>
        <button class="btn-nav" onclick="goToPage(2)">D√©couvrir les Documents ‚û°</button>
    </div>

    <div id="page2" class="page-section">
        <div class="card" style="text-align:center;">
            <h3>üìÇ DOCUMENTS DE TRAVAIL</h3>
            <p>Prends une minute pour lire les documents.</p>
            <p>üí° <em>Astuce : Pendant les exercices, tu pourras toujours les revoir en cliquant sur le bouton "üìñ Voir les Docs".</em></p>
            <button class="btn-nav ghost" onclick="toggleDocs()">üëÅÔ∏è Lire les documents maintenant</button>
        </div>
        <button class="btn-nav" onclick="goToPage(3)">Commencer l'Exercice 1 ‚û°</button>
    </div>

    <div id="page3" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Exercice 1/4 : Vrai ou Faux ?</h3>
            <button class="btn-small" onclick="toggleDocs()">üìñ Voir les Docs</button>
        </div>
        
        <div class="card">
            <p style="font-size:0.9rem; margin-bottom:15px; color:#cbd5e1;">Coche uniquement les affirmations <strong>VRAIES</strong> selon les documents 1 et 2.</p>
            
            <div id="ex1-container">
                <label class="check-label"><input type="checkbox" data-ans="true"> L‚Äôeau du robinet est potable et contr√¥l√©e.</label>
                <label class="check-label"><input type="checkbox" data-ans="true"> La DDM est une date de qualit√© (le go√ªt peut changer).</label>
                <label class="check-label"><input type="checkbox" data-ans="false"> Un rappel est toujours li√© √† une date DDM d√©pass√©e.</label>
                <label class="check-label"><input type="checkbox" data-ans="true"> L‚Äôeau en bouteille g√©n√®re des d√©chets (emballage).</label>
                <label class="check-label"><input type="checkbox" data-ans="false"> Apr√®s la DDM, le produit est forc√©ment dangereux.</label>
            </div>
        </div>
        <button class="btn-nav" onclick="checkEx1()">Valider ‚û°</button>
    </div>

    <div id="page4" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Exercice 2/4 : Le Tableau</h3>
            <button class="btn-small" onclick="toggleDocs()">üìñ Voir les Docs</button>
        </div>

        <div class="card">
            <p style="font-size:0.9rem;">Compl√®te les phrases en utilisant le <strong>Doc 3</strong>.</p>
            
            <div class="question-block">
                <label>Quelle habitude passe de "Simple" √† "Double commande" ?</label>
                <select id="q2-1" class="std-select">
                    <option value="">Choisir...</option><option value="ok">Chasse d'eau</option><option value="no">Douche</option><option value="no">Arrosage</option>
                </select>
            </div>
            <div class="question-block">
                <label>Quelle habitude passe de "9 min" √† "5 min" ?</label>
                <select id="q2-2" class="std-select">
                    <option value="">Choisir...</option><option value="no">Vaisselle</option><option value="ok">Douche</option><option value="no">Chasse d'eau</option>
                </select>
            </div>
            <div class="question-block">
                <label>Quelle habitude passe de "Eau potable" √† "Eau de pluie" ?</label>
                <select id="q2-3" class="std-select">
                    <option value="">Choisir...</option><option value="ok">Arrosage</option><option value="no">Douche</option>
                </select>
            </div>
        </div>
        <button class="btn-nav" onclick="checkEx2()">Valider ‚û°</button>
    </div>

    <div id="page5" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Exercice 3/4 : Classement</h3>
            <button class="btn-small" onclick="toggleDocs()">üìñ Voir les Docs</button>
        </div>

        <div class="card">
            <p style="font-size:0.9rem;">Clique sur une √©tiquette (en haut) puis clique sur sa case (en bas).</p>
            
            <div class="bank-zone" id="chipBank"></div>

            <div class="target-grid">
                <div class="target-zone" id="zone-robinet" onclick="dropChip('zone-robinet')">
                    <div class="target-title">Eau Robinet</div>
                </div>
                <div class="target-zone" id="zone-bouteille" onclick="dropChip('zone-bouteille')">
                    <div class="target-title">Eau Bouteille</div>
                </div>
                <div class="target-zone" id="zone-ddm" onclick="dropChip('zone-ddm')">
                    <div class="target-title">DDM</div>
                </div>
                <div class="target-zone" id="zone-rappel" onclick="dropChip('zone-rappel')">
                    <div class="target-title">Rappel Produit</div>
                </div>
            </div>
        </div>
        <button class="btn-nav" onclick="checkEx3()">V√©rifier ‚û°</button>
    </div>

    <div id="page6" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Exercice 4/4 : Compr√©hension</h3>
            <button class="btn-small" onclick="toggleDocs()">üìñ Voir les Docs</button>
        </div>

        <div class="card">
            <div class="question-block">
                <label>Que se passe-t-il apr√®s la date DDM ?</label>
                <select id="q4-1" class="std-select">
                    <option value="">Choisir...</option>
                    <option value="ok">Perte de qualit√© (go√ªt) mais pas dangereux</option>
                    <option value="no">Danger mortel imm√©diat</option>
                    <option value="no">Le produit explose</option>
                </select>
            </div>
            <div class="question-block">
                <label>√Ä quoi sert un rappel de produit ?</label>
                <select id="q4-2" class="std-select">
                    <option value="">Choisir...</option>
                    <option value="no">Faire de la publicit√©</option>
                    <option value="ok">Informer d'un risque et donner une consigne</option>
                    <option value="no">Vendre le produit moins cher</option>
                </select>
            </div>
        </div>
        <button class="btn-nav" onclick="checkEx4()">Terminer le module ‚û°</button>
    </div>

    <div id="page7" class="page-section" style="text-align:center;">
        <h2 style="color:var(--success); font-size:2rem; margin-top:20px;">BRAVO ! üéâ</h2>
        <div class="card">
            <h3>Bilan de comp√©tence C1</h3>
            <p>Tu sais maintenant rep√©rer l'information utile.</p>
            <div style="font-size:4rem; margin:20px 0;">üèÜ</div>
            <p id="finalScoreText" style="font-weight:bold; color:white; font-size:1.2rem;"></p>
        </div>
        
        <div id="pse-envoi-prof">
            <h3 style="color:var(--accent); margin-top:0;">üöÄ Enregistrer mon r√©sultat</h3>
            <p style="font-size:0.9rem; color:#cbd5e1;">V√©rifie tes informations avant d'envoyer.</p>
            
            <input type="text" id="send-id" class="name-input" placeholder="Ton identifiant" style="margin-bottom:5px;">
            <select id="send-classe" class="class-select">
                <option value="">-- Ta classe --</option>
                <option value="CAP 1">CAP 1</option>
                <option value="CAP 2">CAP 2</option>
                <option value="2nde Bac Pro">2nde Bac Pro</option>
                <option value="1√®re Bac Pro">1√®re Bac Pro</option>
                <option value="Tle Bac Pro">Tle Bac Pro</option>
                <option value="Autre">Autre</option>
            </select>
            
            <button id="pse-btn-envoyer" class="btn-nav">Envoyer au professeur üì§</button>
            <div id="pse-msg"></div>
        </div>

        <button class="btn-nav ghost" onclick="resetModule()" style="margin-top:20px;">Recommencer tout</button>
    </div>

</div>

<script>
    let studentName = "";
    
    // Donn√©es de l'exercice 3
    const CHIPS_DATA = [
        {id:"c1", txt:"Potable et contr√¥l√©e", cat:"zone-robinet"},
        {id:"c2", txt:"Moins de d√©chets plastiques", cat:"zone-robinet"},
        {id:"c3", txt:"N√©cessite transport & emballage", cat:"zone-bouteille"},
        {id:"c4", txt:"G√©n√®re des d√©chets", cat:"zone-bouteille"},
        {id:"c5", txt:"Date de qualit√©", cat:"zone-ddm"},
        {id:"c6", txt:"Perte de go√ªt possible", cat:"zone-ddm"},
        {id:"c7", txt:"Risque sanitaire", cat:"zone-rappel"},
        {id:"c8", txt:"Consigne √† suivre", cat:"zone-rappel"}
    ];
    let selectedChip = null;

    // Chargement initial pour pr√©-remplir si existant
    window.addEventListener('load', () => {
        const savedId = localStorage.getItem('pse_id');
        const savedClass = localStorage.getItem('pse_class');
        if(savedId) {
            document.getElementById('pse-eleve-nom').value = savedId;
            document.getElementById('send-id').value = savedId;
        }
        if(savedClass) {
            document.getElementById('pse-eleve-classe').value = savedClass;
            document.getElementById('send-classe').value = savedClass;
        }
    });

    function startModule() {
        const idInput = document.getElementById('pse-eleve-nom').value.trim();
        const classInput = document.getElementById('pse-eleve-classe').value;

        if(!idInput) {
            alert("Merci d'entrer ton identifiant.");
            return;
        }

        studentName = idInput; // On utilise l'ID pour l'affichage coach aussi
        
        // Synchro avec le bloc de fin et sauvegarde
        document.getElementById('send-id').value = idInput;
        document.getElementById('send-classe').value = classInput;
        
        localStorage.setItem('pse_id', idInput);
        localStorage.setItem('pse_class', classInput);

        goToPage(1);
        setCoach("Bonjour " + studentName + " ! Lis bien les documents page suivante.", "happy");
    }

    function resetModule() {
        // Recharge simple pour r√©initialiser l'√©tat du jeu sans perdre localStorage
        location.reload();
    }

    function goToPage(pageNum) {
        // Fermer le modal si ouvert
        document.getElementById('docModal').style.display = 'none';
        
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById('page' + pageNum).classList.add('active');
        window.scrollTo(0,0);

        if(pageNum === 2) setCoach("Prends le temps de lire. Tu auras besoin de ces infos.", "neutral");
        if(pageNum === 3) setCoach("Exercice 1 : Coche uniquement ce qui est √©crit dans le texte.", "neutral");
        if(pageNum === 5) initEx3();
    }

    function toggleDocs() {
        const modal = document.getElementById('docModal');
        if(modal.style.display === 'block') {
            modal.style.display = 'none';
        } else {
            modal.style.display = 'block';
        }
    }

    function setCoach(msg, mood) {
        const bubble = document.getElementById('coachText');
        const img = document.getElementById('coachImg');
        bubble.innerHTML = msg;
        
        if(mood === "happy") img.src = "avatar-bravo.png";
        else if(mood === "sad") img.src = "avatar-attention.png";
        else img.src = "avatar-neutral.png";

        img.onerror = function() {
            this.src = "https://placehold.co/60?text=Prof";
        };

        img.style.transform = "scale(1.1)";
        setTimeout(()=>img.style.transform = "scale(1)", 200);
    }

    /* EX 1 CHECK */
    function checkEx1() {
        let inputs = document.querySelectorAll('#ex1-container input');
        let errors = 0;
        inputs.forEach(inp => {
            let isChecked = inp.checked;
            let shouldBe = inp.dataset.ans === "true";
            if(isChecked !== shouldBe) {
                errors++;
                inp.parentElement.style.border = "1px solid var(--error)";
                inp.parentElement.style.background = "rgba(251, 113, 133, 0.1)";
            } else {
                inp.parentElement.style.border = "1px solid var(--success)";
                inp.parentElement.style.background = "rgba(52, 211, 153, 0.1)";
            }
        });

        if(errors === 0) {
            setCoach("Parfait ! Tu as bien tri√© le vrai du faux.", "happy");
            setTimeout(() => goToPage(4), 1500);
        } else {
            setCoach(`Il y a ${errors} erreur(s). Ouvre les Docs pour v√©rifier !`, "sad");
        }
    }

    /* EX 2 CHECK */
    function checkEx2() {
        let q1 = document.getElementById('q2-1').value;
        let q2 = document.getElementById('q2-2').value;
        let q3 = document.getElementById('q2-3').value;

        if(q1 === "ok" && q2 === "ok" && q3 === "ok") {
            setCoach("Bien jou√© ! Tu sais lire le tableau.", "happy");
            setTimeout(() => goToPage(5), 1500);
        } else {
            setCoach("Regarde bien les colonnes 'Avant' et 'Apr√®s' du Doc 3.", "sad");
        }
    }

    /* EX 3 LOGIC */
    function initEx3() {
        const bank = document.getElementById('chipBank');
        bank.innerHTML = "";
        CHIPS_DATA.sort(() => Math.random() - 0.5).forEach(c => {
            let el = document.createElement('div');
            el.className = 'chip';
            el.innerText = c.txt;
            el.dataset.id = c.id;
            el.dataset.cat = c.cat;
            
            el.onclick = (e) => { 
                e.stopPropagation(); 
                selectChip(el); 
            };
            
            bank.appendChild(el);
        });
        setCoach("Classe les √©tiquettes dans la bonne zone.", "neutral");
    }

    function selectChip(el) {
        if(selectedChip) selectedChip.classList.remove('selected');
        selectedChip = el;
        el.classList.add('selected');
    }

    function dropChip(zoneId) {
        if(!selectedChip) return;
        let zone = document.getElementById(zoneId);
        zone.appendChild(selectedChip);
        selectedChip.classList.remove('selected');
        selectedChip = null;
    }

    function checkEx3() {
        let errors = 0;
        let chips = document.querySelectorAll('.target-zone .chip');
        if(chips.length < CHIPS_DATA.length) {
            setCoach("Place toutes les √©tiquettes d'abord !", "neutral");
            return;
        }

        chips.forEach(c => {
            let parentId = c.parentElement.id;
            if(c.dataset.cat !== parentId) {
                errors++;
                c.style.background = "var(--error)";
                c.style.borderColor = "var(--error)";
            } else {
                c.style.background = "var(--success)";
                c.style.borderColor = "var(--success)";
            }
        });

        if(errors === 0) {
            setCoach("Excellent classement !", "happy");
            setTimeout(() => goToPage(6), 1500);
        } else {
            setCoach(`Tu as ${errors} erreurs. Regarde les d√©finitions (Docs).`, "sad");
        }
    }

    /* EX 4 CHECK */
    function checkEx4() {
        let q1 = document.getElementById('q4-1').value;
        let q2 = document.getElementById('q4-2').value;

        if(q1 === "ok" && q2 === "ok") {
            setCoach("Bravo ! Module termin√©.", "happy");
            triggerConfetti();
            document.getElementById('finalScoreText').innerText = "F√©licitations " + studentName + " !";
            setTimeout(() => goToPage(7), 1500);
        } else {
            setCoach("Relis le Document 2 sur la DDM et le Rappel.", "sad");
        }
    }

    function triggerConfetti() {
        for(let i=0; i<50; i++) {
            let conf = document.createElement('div');
            conf.className = 'confetti';
            conf.style.left = Math.random() * 100 + 'vw';
            conf.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
            conf.style.animationDuration = Math.random() * 3 + 2 + 's';
            document.body.appendChild(conf);
        }
    }
    
    // Fonction score final demand√©e pour Firestore (ici c'est binaire car on valide chaque √©tape)
    function getScoreFinal() {
        return "4/4 (Valid√©)";
    }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Configuration Firebase (G√©n√©rique - √† remplacer si tu as ta propre config sp√©cifique, sinon celle-ci est standard pour ce type de d√©mos)
  const firebaseConfig = {
    apiKey: "AIzaSy...", 
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "...",
    appId: "..."
  };
  // Note: Si tu as d√©j√† une config active dans tes autres fichiers, remplace le bloc ci-dessus par ta vraie config.
  // Pour l'exercice, je laisse les placeholders standards ou vides si non fournis, mais la structure est l√†.

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const btnEnvoyer = document.getElementById('pse-btn-envoyer');
  const msgBox = document.getElementById('pse-msg');

  btnEnvoyer.addEventListener('click', async () => {
    const idEleve = document.getElementById('send-id').value.trim();
    const classeEleve = document.getElementById('send-classe').value;

    if (!idEleve || !classeEleve) {
      msgBox.style.color = "#fb7185"; // var(--error)
      msgBox.textContent = "‚ö†Ô∏è Merci de remplir ton identifiant et ta classe.";
      return;
    }

    // Feedback visuel
    btnEnvoyer.textContent = "Envoi en cours...";
    btnEnvoyer.disabled = true;
    msgBox.textContent = "";

    try {
      await addDoc(collection(db, "bacpro"), {
        meta: {
          createdAt: new Date().toISOString(),
          nom: idEleve, // On stocke l'identifiant dans le champ 'nom' pour PageProf
          prenom: "",
          classe: classeEleve,
          type: "exercice",
          support: "Module_C1_Traiter_Info"
        },
        resultat: {
          score: getScoreFinal(), // Fonction d√©finie dans le script principal
          url: location.href,
          titre: document.title
        }
      });

      msgBox.style.color = "#34d399"; // var(--success)
      msgBox.textContent = "‚úÖ Bien re√ßu ! R√©sultat envoy√© au professeur.";
      btnEnvoyer.textContent = "Envoyer au professeur üì§";
      btnEnvoyer.disabled = false; // On laisse actif pour renvoi √©ventuel

    } catch (error) {
      console.error("Erreur Firebase:", error);
      msgBox.style.color = "#fb7185";
      msgBox.textContent = "‚ùå Erreur de connexion. R√©essaie.";
      btnEnvoyer.textContent = "R√©essayer";
      btnEnvoyer.disabled = false;
    }
  });
</script>

</body>
</html>
