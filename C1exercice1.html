<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PSE – Compétence C1 – Traiter une information (Exercices 1)</title>
<style>
:root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#101f3d;
      --text:#eaf0ff;
      --muted:#b9c6ff;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --line:rgba(255,255,255,.12);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(125, 211, 252,.22), transparent 55%),
                  radial-gradient(900px 520px at 100% 0%, rgba(167, 139, 250,.20), transparent 52%),
                  radial-gradient(800px 620px at 30% 110%, rgba(52, 211, 153,.12), transparent 52%),
                  var(--bg);
      color:var(--text);
      line-height:1.35;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 44px}
    header{
      position:sticky; top:0; z-index:9;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.60));
      border-bottom:1px solid var(--line);
      padding:12px 14px;
    }
    .head{
      max-width:980px;margin:0 auto;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(125,211,252,.95), rgba(167,139,250,.92));
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      font-weight:900;color:#081025;
    }
    .ttl{display:flex;flex-direction:column}
    .ttl b{font-size:15px;letter-spacing:.2px}
    .ttl span{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .pill strong{color:var(--text);font-weight:700}
    .grid{display:grid;gap:14px;margin-top:14px}
    .card{
      background: linear-gradient(180deg, rgba(16,31,61,.86), rgba(15,27,51,.86));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .top{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background: rgba(125,211,252,.12);
      border:1px solid rgba(125,211,252,.22);
      color: var(--text);
      font-weight:700;font-size:12px;
    }
    .badge small{font-weight:700;color:var(--muted)}
    .card .body{padding:14px}
    .note{
      padding:12px 12px;border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px dashed rgba(255,255,255,.16);
      color: var(--muted);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input[type="text"]{
      width:min(380px,100%);
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    input[type="text"]:focus{border-color: rgba(125,211,252,.55)}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: var(--text);
      padding:12px 14px;border-radius:14px;
      font-weight:700;letter-spacing:.2px;
      cursor:pointer;
      transition: transform .04s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(125,211,252,.35);
      background: linear-gradient(135deg, rgba(125,211,252,.22), rgba(167,139,250,.18));
    }
    .btn.good{
      border-color: rgba(52,211,153,.35);
      background: linear-gradient(135deg, rgba(52,211,153,.18), rgba(125,211,252,.12));
    }
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width:840px){
      .split{grid-template-columns: 1.1fr .9fr}
    }
    .q{
      padding:12px;border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .q h3{
      margin:0 0 8px;font-size:14px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .q h3 .pts{
      font-size:12px;color:var(--muted);font-weight:700;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .opts{display:grid;gap:8px;margin-top:8px}
    .opt{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      touch-action: manipulation;
    }
    .opt input{margin-top:2px}
    select{
      width:100%;
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    select:focus{border-color: rgba(125,211,252,.55)}
    .mini{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .feedback{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      padding:12px;
      background: rgba(0,0,0,.22);
      color: var(--muted);
    }
    .feedback.good{border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.08)}
    .feedback.bad{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.08)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:2px 7px;
      color: var(--text);
      white-space:nowrap;
    }
    .bank{display:flex;flex-wrap:wrap;gap:8px}
    .zones{
      display:grid;gap:10px;
      grid-template-columns: 1fr;
    }
    @media(min-width:840px){
      .zones{grid-template-columns: 1fr 1fr}
    }
    .zone{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:10px;
      min-height:112px;
    }
    .zone h4{
      margin:0 0 8px;
      font-size:13px;
      color: var(--text);
      display:flex;justify-content:space-between;align-items:center;
    }
    .zone h4 span{color:var(--muted);font-size:12px}
    .drop{
      display:flex;flex-wrap:wrap;gap:8px;
      min-height:56px;
    }
    .drop.is-hover{outline:2px dashed var(--accent);background:rgba(124,92,255,.08);}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:700;font-size:12px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .chip.dragging{position:fixed;z-index:9999;box-shadow:0 14px 30px rgba(0,0,0,.45);opacity:.98;cursor:grabbing;touch-action:none;}

    .chip small{font-weight:800;color:var(--muted)}
    .chip.selected{
      border-color: rgba(167,139,250,.6);
      box-shadow: 0 0 0 2px rgba(167,139,250,.18) inset;
      background: rgba(167,139,250,.12);
    }
    .footerbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    .score{
      font-weight:900;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .score b{color:var(--accent)}
    .hint{color:var(--muted);font-size:12px}
    .print-note{display:none}
    @media print{
      header{position:static; backdrop-filter:none}
      body{background:#fff;color:#000}
      .card{box-shadow:none}
      .print-note{display:block;color:#000}
      .btn,.pill{display:none !important}
      .note,.feedback{color:#000}
    }
  /* Petits ajouts spécifiques */
  .docGrid{display:grid;gap:14px;grid-template-columns:1fr;}
  @media (min-width:860px){.docGrid{grid-template-columns:1.15fr .85fr;}}
  .docCard{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px;}
  .docCard h3{margin:0 0 8px 0;font-size:16px;}
  .miniTable{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.10);}
  .miniTable th,.miniTable td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);}
  .miniTable th{text-align:left;color:rgba(255,255,255,.86);font-weight:700;background:rgba(255,255,255,.04)}
  .miniTable tr:last-child td{border-bottom:none;}
  .hint{color:rgba(255,255,255,.72);font-size:13px;line-height:1.35}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(167,139,250,.12);border:1px solid rgba(167,139,250,.35);color:#e9ddff;font-weight:700;font-size:12px;}
  .subtle{color:rgba(255,255,255,.72)}
</style>
</head>
<body>
<div class="wrap">
  <header class="topbar">
    <div class="brand">
      <div class="logo">C1</div>
      <div>
        <div class="title">Traiter une information</div>
        <div class="subtitle">PSE Bac Pro • exercices interactifs • mobile + PC</div>
      </div>
    </div>
    <div class="topActions">
      <button class="btn ghost" id="btnResetAll" type="button">Tout réinitialiser</button>
      <button class="btn" id="btnOpenScore" type="button">Voir le score</button>
    </div>
  </header>

  <section class="hero">
    <div class="heroLeft">
      <div class="kicker">Compétence C1</div>
      <h1>Repérer • sélectionner • classer l’info utile</h1>
      <p class="lead">
        Ici, tu ne donnes pas ton avis : tu <b>trouves</b> dans les documents les informations demandées.
        L’objectif est de répondre <b>juste</b> et <b>sans hors-sujet</b>.
      </p>
      <div class="row">
        <label class="field">
          <span>Prénom</span>
          <input id="studentName" class="input" placeholder="Ton prénom (facultatif)" />
        </label>
        <div class="field">
          <span>Barème</span>
          <div class="pill">Total : 20 points</div>
        </div>
      </div>
      <p class="hint">
        Si tu ouvres le fichier depuis une appli qui prévisualise (ex : Fichiers), les interactions peuvent être bloquées.
        Dans ce cas, ouvre-le dans le navigateur (Safari / Chrome).
      </p>
    </div>
    <div class="heroRight">
      <div class="statCard">
        <div class="statTop">
          <div class="statLabel">Progression</div>
          <div class="statValue" id="progressText">0 / 4 exercices</div>
        </div>
        <div class="bar"><div class="barFill" id="progressFill" style="width:0%"></div></div>
        <div class="statBottom">
          <div class="mini">Score actuel</div>
          <div class="mini strong" id="scoreMini">0 / 20</div>
        </div>
      </div>

      <div class="card tips">
        <h3>Aide rapide</h3>
        <ul>
          <li><b>C1</b> = relever / identifier / citer / classer à partir des documents</li>
          <li>Réponse courte, précise, sans blabla</li>
          <li>Relis le document avant de cliquer Corriger</li>
        </ul>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="sectionTitle">
      <h2>Documents</h2>
      <span class="badge">À lire avant de répondre</span>
    </div>

    <div class="docGrid">
      <div class="docCard">
        <h3>Doc 1 – Eau du robinet et eau en bouteille</h3>
        <p class="subtle">
          L’eau du robinet est <b>potable</b> (elle peut être bue) et fait l’objet de contrôles.
          L’eau en bouteille est aussi potable mais elle nécessite <b>emballage</b>, <b>transport</b> et <b>déchets</b> (plastique).
        </p>
        <ul class="subtle" style="margin:10px 0 0 18px">
          <li>Boire l’eau du robinet peut limiter les déchets plastiques.</li>
          <li>Boire l’eau en bouteille peut générer plus de déchets (bouteilles, films, cartons).</li>
        </ul>
      </div>

      <div class="docCard">
        <h3>Doc 2 – DDM et rappels de produits</h3>
        <p class="subtle">
          La <b>DDM</b> (date de durabilité minimale) indique une date de qualité : après cette date,
          le produit peut perdre des qualités (goût, odeur) mais n’est pas forcément dangereux.
        </p>
        <p class="subtle" style="margin-top:8px">
          Un <b>rappel de produit</b> informe les consommateurs qu’un produit peut présenter un risque
          (ex : contamination). Il faut alors suivre la consigne indiquée.
        </p>
      </div>
    </div>

    <div class="docCard" style="margin-top:14px">
      <h3>Doc 3 – Données fictives pour l’exercice</h3>
      <p class="hint">Les chiffres ci-dessous servent uniquement à s’entraîner à lire un tableau.</p>
      <table class="miniTable">
        <thead>
          <tr>
            <th>Habitude à la maison</th>
            <th>Avant</th>
            <th>Après un changement</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Durée moyenne d’une douche</td>
            <td>9 min</td>
            <td>5 min</td>
          </tr>
          <tr>
            <td>Lavage vaisselle (machine)</td>
            <td>1/2 pleine</td>
            <td>Pleine</td>
          </tr>
          <tr>
            <td>Chasse d’eau</td>
            <td>simple</td>
            <td>double commande</td>
          </tr>
          <tr>
            <td>Arrosage</td>
            <td>eau potable</td>
            <td>eau de pluie</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- EX 1 -->
  <section class="card ex" id="ex1">
    <div class="exHead">
      <div>
        <div class="exTitle">Exercice 1</div>
        <div class="exDesc">Repérer des informations vraies dans les documents</div>
      </div>
      <div class="exMeta">
        <span class="chip">6 pts • C1</span>
        <button class="btn" type="button" data-check="ex1">Corriger</button>
      </div>
    </div>

    <p class="hint">Coche uniquement les affirmations présentes et conformes aux documents.</p>

    <div class="qBlock">
      <label class="check"><input type="checkbox" data-ex1="a"> L’eau du robinet est potable et contrôlée.</label>
      <label class="check"><input type="checkbox" data-ex1="b"> La DDM est une date de qualité : après, le goût peut changer.</label>
      <label class="check"><input type="checkbox" data-ex1="c"> Un rappel de produit est toujours lié à une date DDM dépassée.</label>
      <label class="check"><input type="checkbox" data-ex1="d"> L’eau en bouteille nécessite emballage, transport et déchets.</label>
      <label class="check"><input type="checkbox" data-ex1="e"> Boire l’eau du robinet peut limiter les déchets plastiques.</label>
      <label class="check"><input type="checkbox" data-ex1="f"> Après la DDM, un produit est forcément dangereux.</label>
    </div>
    <div class="feedback" id="fb_ex1"></div>
  </section>

  <!-- EX 2 -->
  <section class="card ex" id="ex2">
    <div class="exHead">
      <div>
        <div class="exTitle">Exercice 2</div>
        <div class="exDesc">Prélever l’info dans un tableau</div>
      </div>
      <div class="exMeta">
        <span class="chip">4 pts • C1</span>
        <button class="btn" type="button" data-check="ex2">Corriger</button>
      </div>
    </div>

    <div class="qBlock">
      <div class="q">
        <div class="qLabel">2.1</div>
        <div class="qText">Quelle habitude passe de <b>simple</b> à <b>double commande</b> ?</div>
        <select class="select" data-ex2="q1">
          <option value="">Choisir…</option>
          <option>Durée moyenne d’une douche</option>
          <option>Lavage vaisselle (machine)</option>
          <option>Chasse d’eau</option>
          <option>Arrosage</option>
        </select>
      </div>

      <div class="q">
        <div class="qLabel">2.2</div>
        <div class="qText">Quelle habitude passe de <b>9 min</b> à <b>5 min</b> ?</div>
        <select class="select" data-ex2="q2">
          <option value="">Choisir…</option>
          <option>Durée moyenne d’une douche</option>
          <option>Lavage vaisselle (machine)</option>
          <option>Chasse d’eau</option>
          <option>Arrosage</option>
        </select>
      </div>

      <div class="q">
        <div class="qLabel">2.3</div>
        <div class="qText">Quelle habitude passe de <b>eau potable</b> à <b>eau de pluie</b> ?</div>
        <select class="select" data-ex2="q3">
          <option value="">Choisir…</option>
          <option>Durée moyenne d’une douche</option>
          <option>Lavage vaisselle (machine)</option>
          <option>Chasse d’eau</option>
          <option>Arrosage</option>
        </select>
      </div>

      <div class="q">
        <div class="qLabel">2.4</div>
        <div class="qText">Quelle habitude passe de <b>1/2 pleine</b> à <b>Pleine</b> ?</div>
        <select class="select" data-ex2="q4">
          <option value="">Choisir…</option>
          <option>Durée moyenne d’une douche</option>
          <option>Lavage vaisselle (machine)</option>
          <option>Chasse d’eau</option>
          <option>Arrosage</option>
        </select>
      </div>
    </div>

    <div class="feedback" id="fb_ex2"></div>
  </section>

  <!-- EX 3 -->
  <section class="card ex" id="ex3">
    <div class="exHead">
      <div>
        <div class="exTitle">Exercice 3</div>
        <div class="exDesc">Classer des informations dans la bonne famille</div>
      </div>
      <div class="exMeta">
        <span class="chip">8 pts • C1</span>
        <button class="btn" type="button" data-check="ex3">Corriger</button>
      </div>
    </div>

    <p class="hint">
      Mode téléphone : touche un chip (il devient violet), puis touche une zone pour le déposer.
      Tu peux retirer un chip d’une zone en le touchant (sans sélection).
    </p>

    <div class="bankRow">
      <div class="bankTitle">Banque d’infos <span class="subtle">(à placer)</span></div>
      <button class="btn ghost" type="button" id="resetEx3">Réinitialiser</button>
    </div>

    <div class="bank" id="bank_ex3"></div>

    <div class="dropGrid">
      <div class="dropZone" data-zone="robinet">
        <div class="zoneHead">
          <div class="zoneTitle">Eau du robinet</div>
          <div class="zoneTag">document</div>
        </div>
        <div class="zoneBody"></div>
      </div>

      <div class="dropZone" data-zone="bouteille">
        <div class="zoneHead">
          <div class="zoneTitle">Eau en bouteille</div>
          <div class="zoneTag">document</div>
        </div>
        <div class="zoneBody"></div>
      </div>

      <div class="dropZone" data-zone="ddm">
        <div class="zoneHead">
          <div class="zoneTitle">DDM</div>
          <div class="zoneTag">définition</div>
        </div>
        <div class="zoneBody"></div>
      </div>

      <div class="dropZone" data-zone="rappel">
        <div class="zoneHead">
          <div class="zoneTitle">Rappel de produit</div>
          <div class="zoneTag">information</div>
        </div>
        <div class="zoneBody"></div>
      </div>
    </div>

    <div class="feedback" id="fb_ex3"></div>
  </section>

  <!-- EX 4 -->
  <section class="card ex" id="ex4">
    <div class="exHead">
      <div>
        <div class="exTitle">Exercice 4</div>
        <div class="exDesc">Relever la bonne information</div>
      </div>
      <div class="exMeta">
        <span class="chip">2 pts • C1</span>
        <button class="btn" type="button" data-check="ex4">Corriger</button>
      </div>
    </div>

    <div class="qBlock">
      <div class="q">
        <div class="qLabel">4.1</div>
        <div class="qText">D’après le Doc 2, après une DDM dépassée, on peut surtout observer :</div>
        <select class="select" data-ex4="q1">
          <option value="">Choisir…</option>
          <option>Une perte possible de qualité (goût/odeur)</option>
          <option>Un danger systématique pour la santé</option>
          <option>Un rappel automatique du produit</option>
        </select>
      </div>
      <div class="q">
        <div class="qLabel">4.2</div>
        <div class="qText">D’après le Doc 2, un rappel de produit sert à :</div>
        <select class="select" data-ex4="q2">
          <option value="">Choisir…</option>
          <option>Informer d’un risque et donner une consigne au consommateur</option>
          <option>Prolonger la DDM du produit</option>
          <option>Obliger à boire uniquement de l’eau en bouteille</option>
        </select>
      </div>
    </div>

    <div class="feedback" id="fb_ex4"></div>
  </section>

  <!-- SCORE MODAL -->
  <div class="modal" id="scoreModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Résultats</h3>
        <button class="iconBtn" id="btnCloseScore" type="button">✕</button>
      </div>
      <div class="modalBody">
        <div class="scoreLine"><span>Exercice 1</span><b id="s_ex1">0</b><span>/6</span></div>
        <div class="scoreLine"><span>Exercice 2</span><b id="s_ex2">0</b><span>/4</span></div>
        <div class="scoreLine"><span>Exercice 3</span><b id="s_ex3">0</b><span>/8</span></div>
        <div class="scoreLine"><span>Exercice 4</span><b id="s_ex4">0</b><span>/2</span></div>
        <hr class="sep"/>
        <div class="scoreTotal"><span>Total</span><b id="s_total">0</b><span>/20</span></div>
        <p class="hint" id="scoreMsg" style="margin-top:10px"></p>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  function $(q, el){ return (el||document).querySelector(q); }
  function $$(q, el){ return Array.prototype.slice.call((el||document).querySelectorAll(q)); }

  var state = {
    ex1:{score:0, done:false},
    ex2:{score:0, done:false},
    ex3:{score:0, done:false},
    ex4:{score:0, done:false}
  };
  var TOTAL = 20;
  var perEx = {ex1:6, ex2:4, ex3:8, ex4:2};

  function setFeedback(id, ok, html){
    var box = $(id);
    box.style.display = "block";
    box.classList.remove("good","bad");
    box.classList.add(ok ? "good" : "bad");
    box.innerHTML = html;
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function updateProgress(){
    var done = Object.keys(state).map(function(k){return state[k].done;}).filter(Boolean).length;
    $("#progressText").textContent = done + " / 4 exercices";
    $("#progressFill").style.width = (done/4*100) + "%";
    var total = state.ex1.score + state.ex2.score + state.ex3.score + state.ex4.score;
    $("#scoreMini").textContent = total + " / " + TOTAL;
  }

  function saveName(){
    try{ localStorage.setItem("pse_studentName", $("#studentName").value || ""); }catch(e){}
  }
  function loadName(){
    try{
      var v = localStorage.getItem("pse_studentName");
      if(v) $("#studentName").value = v;
    }catch(e){}
  }

  function checkEx1(){
    var correct = {a:true,b:true,d:true,e:true};
    var chosen = $$(".qBlock [data-ex1]:checked").map(function(i){return i.getAttribute("data-ex1");});
    var score = 0;
    chosen.forEach(function(id){
      if(correct[id]) score += 1;
      else score -= 1;
    });
    score = clamp(score, 0, perEx.ex1);

    var missed = Object.keys(correct).filter(function(x){ return chosen.indexOf(x)===-1; });
    var wrong = chosen.filter(function(x){ return !correct[x]; });

    state.ex1.score = score;
    state.ex1.done = true;

    var ok = (missed.length===0 && wrong.length===0);
    var html = "<b>"+score+" / 6</b><br/>";
    if(ok){
      html += "Parfait : tu as sélectionné uniquement les infos justes.";
    } else {
      html += "À revoir :<br/>";
      if(wrong.length) html += "• Cases à ne pas cocher : <b>"+wrong.join(", ")+"</b><br/>";
      if(missed.length) html += "• Infos manquantes : <b>"+missed.join(", ")+"</b><br/>";
      html += "<span class='subtle'>Relis Doc 1 et Doc 2.</span>";
    }
    setFeedback("#fb_ex1", ok, html);
    updateProgress();
  }

  function checkEx2(){
    var answers = {
      q1:"Chasse d’eau",
      q2:"Durée moyenne d’une douche",
      q3:"Arrosage",
      q4:"Lavage vaisselle (machine)"
    };
    var score = 0;
    var details = [];
    Object.keys(answers).forEach(function(k){
      var v = $("[data-ex2='"+k+"']").value;
      if(v === answers[k]) score += 1;
      else details.push("• "+k.toUpperCase()+" → attendu : <b>"+answers[k]+"</b>");
    });

    state.ex2.score = score;
    state.ex2.done = true;

    setFeedback("#fb_ex2", score===perEx.ex2,
      "<b>"+score+" / 4</b><br/>" + (details.length ? details.join("<br/>") : "Tout est correct : tu as bien lu le tableau.")
    );
    updateProgress();
  }

  var ex3 = {
    selectedChip:null,
    chips:[
      {id:"c1", text:"Potable et contrôlée", zone:"robinet"},
      {id:"c2", text:"Peut limiter les déchets plastiques", zone:"robinet"},
      {id:"c3", text:"Nécessite emballage, transport, déchets", zone:"bouteille"},
      {id:"c4", text:"Génère plus de déchets (bouteilles)", zone:"bouteille"},
      {id:"c5", text:"Date de durabilité minimale (qualité)", zone:"ddm"},
      {id:"c6", text:"Après la date : goût/odeur peuvent changer", zone:"ddm"},
      {id:"c7", text:"Informe d’un risque possible", zone:"rappel"},
      {id:"c8", text:"Donne une consigne à suivre", zone:"rappel"}
    ],
    placements:new Map()
  };

  function renderEx3(){
    var bank = $("#bank_ex3");
    bank.innerHTML = "";
    ex3.placements = new Map();
    ex3.selectedChip = null;
    $$(".dropZone .zoneBody").forEach(function(z){ z.innerHTML=""; });

    ex3.chips.forEach(function(ch){
      var el = document.createElement("button");
      el.type = "button";
      el.className = "chipBtn";
      el.textContent = ch.text;
      el.dataset.chipId = ch.id;

      el.addEventListener("click", function(){
        if(ex3.selectedChip && ex3.selectedChip !== el) ex3.selectedChip.classList.remove("selected");
        if(el.classList.contains("selected")){
          el.classList.remove("selected");
          ex3.selectedChip = null;
        } else {
          el.classList.add("selected");
          ex3.selectedChip = el;
        }
      });

      bank.appendChild(el);
    });
  }

  function labelZone(z){
    return {robinet:"Eau du robinet", bouteille:"Eau en bouteille", ddm:"DDM", rappel:"Rappel de produit"}[z] || z;
  }

  function placeChipIntoZone(chipEl, zoneEl){
    var chipId = chipEl.dataset.chipId;
    var zone = zoneEl.dataset.zone;
    zoneEl.querySelector(".zoneBody").appendChild(chipEl);
    chipEl.classList.remove("selected");
    ex3.selectedChip = null;
    ex3.placements.set(chipId, zone);
  }

  function removeChipFromZone(chipEl){
    $("#bank_ex3").appendChild(chipEl);
    ex3.placements.delete(chipEl.dataset.chipId);
  }

  function wireEx3(){
    $$(".dropZone").forEach(function(zoneEl){
      zoneEl.addEventListener("click", function(e){
        var chipBtn = e.target.closest(".chipBtn");
        if(chipBtn && !ex3.selectedChip){
          removeChipFromZone(chipBtn);
          return;
        }
        if(!ex3.selectedChip) return;
        placeChipIntoZone(ex3.selectedChip, zoneEl);
      });
    });

    $("#resetEx3").addEventListener("click", function(){
      renderEx3();
      updateProgress();
    });
  }

  function checkEx3(){
    var score = 0;
    var errors = [];
    ex3.chips.forEach(function(ch){
      var placed = ex3.placements.get(ch.id);
      if(placed === ch.zone) score += 1;
      else errors.push("• \""+ch.text+"\" → attendu : <b>"+labelZone(ch.zone)+"</b>");
    });
    state.ex3.score = score;
    state.ex3.done = true;

    setFeedback("#fb_ex3", score===perEx.ex3,
      "<b>"+score+" / 8</b><br/>" + (errors.length ? errors.join("<br/>") : "Parfait : tout est dans la bonne famille.")
    );
    updateProgress();
  }

  function checkEx4(){
    var a1 = ($("[data-ex4='q1']").value === "Une perte possible de qualité (goût/odeur)");
    var a2 = ($("[data-ex4='q2']").value === "Informer d’un risque et donner une consigne au consommateur");
    var score = (a1?1:0) + (a2?1:0);

    state.ex4.score = score;
    state.ex4.done = true;

    var details = [];
    if(!a1) details.push("• 4.1 → Relis la définition de la DDM (Doc 2).");
    if(!a2) details.push("• 4.2 → Relis l’objectif d’un rappel (Doc 2).");

    setFeedback("#fb_ex4", score===perEx.ex4,
      "<b>"+score+" / 2</b><br/>" + (details.length ? details.join("<br/>") : "Nickel : tu as bien relevé les informations.")
    );
    updateProgress();
  }

  function openScore(){
    $("#s_ex1").textContent = state.ex1.score;
    $("#s_ex2").textContent = state.ex2.score;
    $("#s_ex3").textContent = state.ex3.score;
    $("#s_ex4").textContent = state.ex4.score;
    var total = state.ex1.score + state.ex2.score + state.ex3.score + state.ex4.score;
    $("#s_total").textContent = total;

    var name = ($("#studentName").value || "").trim();
    var msg = "";
    if(total >= 16) msg = "Très bon niveau : tu repères et classes l’essentiel.";
    else if(total >= 12) msg = "Correct : continue à éviter le hors-sujet et vérifie chaque détail.";
    else if(total >= 8) msg = "À renforcer : relis les documents et réponds plus précisément.";
    else msg = "Priorité : apprendre à repérer l’info utile sans recopier tout le texte.";
    $("#scoreMsg").textContent = (name ? (name + " – ") : "") + msg;

    var modal = $("#scoreModal");
    modal.classList.add("open");
    modal.setAttribute("aria-hidden","false");
  }
  function closeScore(){
    var modal = $("#scoreModal");
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden","true");
  }

  function resetAll(){
    $$("[data-ex1]").forEach(function(i){ i.checked = false; });
    $$("[data-ex2]").forEach(function(s){ s.value = ""; });
    $$("[data-ex4]").forEach(function(s){ s.value = ""; });

    ["#fb_ex1","#fb_ex2","#fb_ex3","#fb_ex4"].forEach(function(id){
      var el = $(id);
      el.style.display = "none";
      el.innerHTML = "";
      el.classList.remove("good","bad");
    });

    Object.keys(state).forEach(function(k){
      state[k].score = 0;
      state[k].done = false;
    });

    renderEx3();
    updateProgress();
  }

  function init(){
    loadName();
    $("#studentName").addEventListener("input", saveName);

    $$("[data-check='ex1']").forEach(function(b){ b.addEventListener("click", checkEx1); });
    $$("[data-check='ex2']").forEach(function(b){ b.addEventListener("click", checkEx2); });
    $$("[data-check='ex3']").forEach(function(b){ b.addEventListener("click", checkEx3); });
    $$("[data-check='ex4']").forEach(function(b){ b.addEventListener("click", checkEx4); });

    $("#btnOpenScore").addEventListener("click", openScore);
    $("#btnCloseScore").addEventListener("click", closeScore);
    $("#scoreModal").addEventListener("click", function(e){ if(e.target.id === "scoreModal") closeScore(); });

    $("#btnResetAll").addEventListener("click", resetAll);

    renderEx3();
    wireEx3();

    requestAnimationFrame(function(){ setTimeout(renderEx3, 0); });

    updateProgress();
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script>
</body>
</html>
