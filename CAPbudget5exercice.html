<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Budget d'Amira - Ratios et Endettement</title>
    <style>
        /* Styles de base conserv√©s, ajout d'une colonne */
        :root {
            --recettes-color: #d4edda;
            --recettes-border: #28a745;
            --dette-color: #fce4ec; /* Nouveau: Rose clair pour la dette */
            --dette-border: #e91e63;
            --fixe-color: #cce5ff;
            --fixe-border: #007bff;
            --courant-color: #fff3cd;
            --courant-border: #ffc107;
            --occas-color: #f8d7da;
            --occas-border: #dc3545;
            --epargne-color: #e6e0ff;
            --epargne-border: #6f42c1;
            
            --recette-travail: #a2d9c2;
            --recette-social: #7fc3af;
            --recette-autre: #55aa99;

            --bg-color: #f9f9f9;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: #2c3e50; margin-bottom: 10px; }

        .legend-bar {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            background: #fff;
            padding: 8px 15px;
            border-radius: 50px;
            border: 1px solid #ddd;
        }
        
        .context-box {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 1.15rem;
            position: relative;
        }

        .audio-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: background 0.2s;
        }

        #item-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            background: white;
            padding: 15px;
            border-radius: 10px;
            min-height: 80px;
            width: 100%;
            max-width: 1300px; /* Plus large pour 6 colonnes */
            margin-bottom: 20px;
            border: 2px dashed #ccc;
        }

        .draggable-item {
            padding: 10px 20px;
            background-color: white;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: grab;
            user-select: none;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, background-color 0.2s;
        }

        /* Le Tableau - 6 colonnes */
        .budget-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr); 
            gap: 8px; /* R√©duire le gap */
            width: 100%;
            max-width: 1300px;
        }

        .column {
            background: white;
            border-radius: 10px;
            padding: 10px 5px; /* R√©duire le padding */
            display: flex;
            flex-direction: column;
            min-height: 400px;
            border-top: 6px solid #ccc;
        }

        .column h3 {
            text-align: center;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 1rem; /* R√©duire la taille du titre */
        }
        
        /* Recettes (identique) */
        #col-recettes { 
            border-top-color: var(--recettes-border); 
            grid-column: span 1;
        }

        /* Colonne Dette/Pr√™t (nouveau) */
        #col-dettes { border-top-color: var(--dette-border); }
        #col-dettes .drop-zone { background-color: var(--dette-color); }
        
        /* D√©penses Fixes (mis √† jour) */
        #col-fixes { border-top-color: var(--fixe-border); }
        #col-fixes .drop-zone { background-color: var(--fixe-color); }
        
        /* D√©penses Courantes (identique) */
        #col-courantes { border-top-color: var(--courant-border); }
        #col-courantes .drop-zone { background-color: var(--courant-color); }

        /* D√©penses Occasionnelles (identique) */
        #col-occas { border-top-color: var(--occas-border); }
        #col-occas .drop-zone { background-color: var(--occas-color); }

        /* Colonne √âpargne (identique) */
        #col-epargne { border-top-color: var(--epargne-border); }
        #col-epargne .drop-zone { background-color: var(--epargne-color); }
        
        /* Zones de calcul et Synth√®se */
        .calc-zone {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #eee;
            text-align: center;
        }
        
        input[type="number"] {
            width: 80px; /* R√©duire la largeur */
            padding: 8px;
            font-size: 1rem;
            border: 2px solid #ccc;
            border-radius: 5px;
            text-align: right;
            margin-bottom: 5px;
        }

        .verify-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 5px;
        }
        
        .feedback-msg {
            display: block;
            font-size: 0.95rem;
            margin-top: 8px;
            font-weight: bold;
            min-height: 1.2em;
        }

        .final-synthesis {
            margin-top: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            border-left: 10px solid #e91e63;
        }

        .synthesis-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .ratio-row {
            font-size: 1.1rem;
            padding: 10px;
            background: #ffebee;
            border-left: 5px solid #e91e63;
            margin-top: 15px;
            border-radius: 5px;
        }
        
        /* Ajustements Responsive */
        @media (max-width: 1300px) {
            .budget-container { grid-template-columns: repeat(3, 1fr); } 
            #col-recettes { grid-column: span 1; }
            #col-dettes { grid-column: span 1; }
        }
        @media (max-width: 900px) {
            .budget-container { grid-template-columns: 1fr 1fr; } 
            #col-recettes, #col-dettes, #col-fixes, #col-courantes, #col-occas, #col-epargne { grid-column: span 1; }
        }

    </style>
</head>
<body>

    <h1>üí∞ Le Budget d'Amira - Ma√Ætrise et Ratios</h1>

    <div class="legend-bar">
        <span>Objectif : Calculer le **Taux d'Endettement** et √©valuer la **Marge de Man≈ìuvre**.</span>
    </div>

    <div class="context-box">
        <button id="main-audio-btn" class="audio-btn" onclick="toggleAudio()">
            <span>‚ñ∂Ô∏è Lire l'histoire</span>
        </button>
        
        <div id="text-content">
            Amira est salari√©e en CDI. Elle touche un **salaire net de 2 100 ‚Ç¨**. Elle re√ßoit aussi des **tickets restaurant** utilisables imm√©diatement pour **120 ‚Ç¨**.<br>
            
            Elle rembourse actuellement un **cr√©dit immobilier de 750 ‚Ç¨** et un **cr√©dit √† la consommation de 150 ‚Ç¨**. Ces postes doivent √™tre class√©s dans la cat√©gorie **Dette/Pr√™t**.<br>
            
            Ses autres charges fixes : Assurance maladie (50 ‚Ç¨), Taxe d'habitation (mensualis√©e) de **40 ‚Ç¨**.<br>
            
            Ses d√©penses courantes sont : Courses alimentaires (380 ‚Ç¨), Transport (100 ‚Ç¨), Coiffeur (30 ‚Ç¨).<br><br>
            
            Ce mois-ci, elle a :
            * Mis **200 ‚Ç¨** dans son √©pargne (Livret A). Elle a d√©j√† **4 500 ‚Ç¨** sur ce livret.
            * Achet√© un nouvel ordinateur portable pour **600 ‚Ç¨** (d√©pense impr√©vue mais pay√©e cash).
            * Re√ßu le remboursement d'une consultation m√©dicale de **30 ‚Ç¨** (encaiss√©).
        </div>
    </div>

    <div style="width:100%; max-width:1300px; text-align:left; margin-bottom:5px; font-size:1.1rem;">
        <strong>1. Classe les √©tiquettes. Les remboursements de pr√™ts doivent √™tre class√©s comme "Dette/Pr√™t".</strong>
    </div>
    
    <div id="item-bank" ondrop="drop(event)" ondragover="allowDrop(event)">
    </div>

    <div class="budget-container">
        <div class="column" id="col-recettes">
            <h3>Recettes</h3>
            <div class="recette-sub-zones">
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-travail">
                    <h4>Travail (Salaire, TR)</h4>
                </div>
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-social">
                    <h4>Social/√âtat (Remboursement)</h4>
                </div>
                <div class="sub-zone drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="recette-autre">
                    <h4>Autre</h4>
                </div>
            </div>
            <div class="calc-zone">
                <label>Total R : </label>
                <input type="number" id="input-recettes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('recette', 'input-recettes', 'msg-recettes')">V√©rifier</button>
                <span id="msg-recettes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-dettes">
            <h3>Dette/Pr√™t</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="dette"></div>
            <div class="calc-zone">
                <label>Total Dt : </label>
                <input type="number" id="input-dettes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('dette', 'input-dettes', 'msg-dettes')">V√©rifier</button>
                <span id="msg-dettes" class="feedback-msg"></span>
            </div>
        </div>
        
        <div class="column" id="col-fixes">
            <h3>D√©penses Fixes</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="fixe"></div>
            <div class="calc-zone">
                <label>Total DF : </label>
                <input type="number" id="input-fixes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('fixe', 'input-fixes', 'msg-fixes')">V√©rifier</button>
                <span id="msg-fixes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-courantes">
            <h3>D√©penses Courantes</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="courante"></div>
            <div class="calc-zone">
                <label>Total DC : </label>
                <input type="number" id="input-courantes" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('courante', 'input-courantes', 'msg-courantes')">V√©rifier</button>
                <span id="msg-courantes" class="feedback-msg"></span>
            </div>
        </div>

        <div class="column" id="col-occas">
            <h3>D√©penses Occas.</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="occas"></div>
            <div class="calc-zone">
                <label>Total DO : </label>
                <input type="number" id="input-occas" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('occas', 'input-occas', 'msg-occas')">V√©rifier</button>
                <span id="msg-occas" class="feedback-msg"></span>
            </div>
        </div>
        
        <div class="column" id="col-epargne">
            <h3>√âpargne/Trans.</h3>
            <div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-category="epargne"></div>
            <div class="calc-zone">
                <label>Total E : </label>
                <input type="number" id="input-epargne" placeholder="?"> ‚Ç¨
                <br>
                <button class="verify-btn" onclick="verifierColonneGlobale('epargne', 'input-epargne', 'msg-epargne')">V√©rifier</button>
                <span id="msg-epargne" class="feedback-msg"></span>
            </div>
        </div>
    </div>

    <div class="final-synthesis">
        <h2>üìä Le Diagnostic Financier d'Amira</h2>
        <p>Utilise tes totaux pour calculer la sant√© financi√®re d'Amira.</p>
        
        <div class="synthesis-row">
            <span>A. Total des **Recettes (R)** :</span>
            <input type="number" id="final-recettes" placeholder="..."> ‚Ç¨
        </div>
        <div class="synthesis-row">
            <span>B. Total des **Dettes/Pr√™ts (Dt)** :</span>
            <input type="number" id="final-dettes" placeholder="..."> ‚Ç¨
        </div>
        <div class="synthesis-row">
            <span>C. Total des **D√©penses Fixes HORS Dette (DF)** :</span>
            <input type="number" id="final-fixes" placeholder="..."> ‚Ç¨
        </div>
        <hr>
        <div class="ratio-row">
            **Taux d'Endettement (TE)** = (B / A) x 100
            <br>
            $ \left( \frac{\text{Total Dettes}}{\text{Total Recettes}} \times 100 \right) $
            <input type="number" id="final-taux-endettement" placeholder="..." style="width: 60px;"> %
        </div>
        <hr>
        <div class="synthesis-row" style="font-weight: bold; font-size: 1.3rem; color: #007bff;">
            <span>D. Reste √† Vivre (R - Dt - DF) :</span>
            <input type="number" id="final-rav" placeholder="..."> ‚Ç¨
        </div>
        <div class="synthesis-row">
            <span>E. Total D√©penses Courantes et Occasionnelles (DC + DO) :</span>
            <input type="number" id="final-courant-occas" placeholder="..."> ‚Ç¨
        </div>
        <div class="synthesis-row" style="font-weight: bold; font-size: 1.3rem; color: #6f42c1;">
            <span>F. Marge de Man≈ìuvre (RAV - (DC + DO)) :</span>
            <input type="number" id="final-marge-manoeuvre" placeholder="..."> ‚Ç¨
        </div>
        
        <div style="text-align: center; margin-top:10px;">
             <button class="verify-btn" onclick="verifierBilanAmira()" style="font-size:1.1rem; padding: 10px 20px;">V√©rifier le Diagnostic</button>
             <div id="msg-bilan" class="feedback-msg" style="font-size:1.1rem; margin-top:10px;"></div>
        </div>

        <div class="result-options" id="budget-status" style="opacity: 0.3; pointer-events: none;">
            <p style="width:100%; text-align:center; margin-bottom:10px;">Amira est : </p>
            <label>
                <input type="radio" name="budget" value="secure">
                <span>En s√©curit√© (TE < 33%)</span>
            </label>
            <label>
                <input type="radio" name="budget" value="alerte">
                <span>En alerte (TE > 33%)</span>
            </label>
            <label>
                <input type="radio" name="budget" value="critique">
                <span>En situation critique</span>
            </label>
        </div>
        <div style="text-align: center; margin-top:20px;">
            <button class="verify-btn" onclick="verifierConclusionAmira()" id="btn-conclusion" style="display:none; padding:10px 25px;">V√©rifier l'√©valuation</button>
             <div id="msg-conclusion" class="feedback-msg"></div>
        </div>
    </div>

    <script>
        // --- DONN√âES D'AMIRA ---
        const items = [
            // Recettes
            { id: 1, name: "Salaire Net", val: 2100, cat: "recette-travail", globalCat: "recette", tresorerie: 2100 },
            { id: 2, name: "Tickets Restaurant", val: 120, cat: "recette-travail", globalCat: "recette", tresorerie: 120 },
            { id: 3, name: "Remboursement M√©dical (encaiss√©)", val: 30, cat: "recette-social", globalCat: "recette", tresorerie: 30 },
            
            // Dettes/Pr√™ts
            { id: 4, name: "Cr√©dit Immobilier (mensualit√©)", val: 750, cat: "dette", globalCat: "depense", tresorerie: -750 },
            { id: 5, name: "Cr√©dit Consommation (mensualit√©)", val: 150, cat: "dette", globalCat: "depense", tresorerie: -150 },
            
            // D√©penses Fixes (Hors dette)
            { id: 6, name: "Assurance Maladie", val: 50, cat: "fixe", globalCat: "depense", tresorerie: -50 },
            { id: 7, name: "Taxe Habitation (mensualis√©e)", val: 40, cat: "fixe", globalCat: "depense", tresorerie: -40 },
            
            // D√©penses Courantes
            { id: 8, name: "Courses Alimentaires", val: 380, cat: "courante", globalCat: "depense", tresorerie: -380 },
            { id: 9, name: "Transport", val: 100, cat: "courante", globalCat: "depense", tresorerie: -100 },
            { id: 10, name: "Coiffeur", val: 30, cat: "courante", globalCat: "depense", tresorerie: -30 },
            
            // D√©penses Occasionnelles
            { id: 11, name: "Achat Ordinateur Portable", val: 600, cat: "occas", globalCat: "depense", tresorerie: -600 },
            
            // √âpargne / Transfert
            { id: 12, name: "√âpargne Livret A", val: 200, cat: "epargne", globalCat: "epargne", tresorerie: -200 }
        ];
        
        // --- CALCULS R√âELS ---
        
        const totalRecettes = items.filter(i => i.globalCat === 'recette').reduce((a, b) => a + b.val, 0); // 2100+120+30 = 2250
        const totalDettes = items.filter(i => i.cat === 'dette').reduce((a, b) => a + b.val, 0); // 750 + 150 = 900
        const totalFixes = items.filter(i => i.cat === 'fixe').reduce((a, b) => a + b.val, 0); // 50 + 40 = 90
        const totalCourantes = items.filter(i => i.cat === 'courante').reduce((a, b) => a + b.val, 0); // 380 + 100 + 30 = 510
        const totalOccasionnelles = items.filter(i => i.cat === 'occas').reduce((a, b) => a + b.val, 0); // 600
        const totalEpargne = items.filter(i => i.globalCat === 'epargne').reduce((a, b) => a + b.val, 0); // 200
        
        // Indicateurs cl√©s
        const resteAVivre = totalRecettes - totalDettes - totalFixes; // 2250 - 900 - 90 = 1260
        const depensesCourantesEtOccasionnelles = totalCourantes + totalOccasionnelles; // 510 + 600 = 1110
        const margeDeManoeuvre = resteAVivre - depensesCourantesEtOccasionnelles; // 1260 - 1110 = 150 (Avant √©pargne)

        const tauxEndettement = (totalDettes / totalRecettes) * 100; // (900 / 2250) * 100 = 40.0%

        // --- LOGIQUE G√âN√âRALE (Recyclage des fonctions pr√©c√©dentes) ---
        const bank = document.getElementById("item-bank");
        items.sort(() => Math.random() - 0.5); 

        items.forEach(item => {
            let el = document.createElement("div");
            el.classList.add("draggable-item");
            el.setAttribute("draggable", "true");
            el.setAttribute("id", "item-" + item.id);
            el.setAttribute("data-val", item.val);
            el.setAttribute("data-cat", item.cat); 
            el.setAttribute("data-global-cat", item.globalCat); 
            el.innerText = `${item.name} (${item.val} ‚Ç¨)`;
            
            el.addEventListener("dragstart", drag);
            el.addEventListener("click", function() { selectItem(el); });
            bank.appendChild(el);
        });

        let selectedItem = null;

        function selectItem(el) {
            if(selectedItem) {
                selectedItem.style.backgroundColor = "white";
                selectedItem.style.borderColor = "#555";
            }
            if (selectedItem === el) {
                selectedItem = null;
                return;
            }
            selectedItem = el;
            el.style.backgroundColor = "#e2e6ea";
            el.style.borderColor = "#007bff";
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add("drag-over");
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            selectItem(ev.target);
        }

        function drop(ev) {
            ev.preventDefault();
            document.querySelectorAll('.drop-zone, .sub-zone, #item-bank').forEach(z => z.classList.remove('drag-over'));

            let data = ev.dataTransfer ? ev.dataTransfer.getData("text") : null;
            let draggedElement;

            if (data) draggedElement = document.getElementById(data);
            else if (selectedItem) draggedElement = selectedItem;
            else return;

            let target = ev.target;
            while (!target.classList.contains("drop-zone") && !target.classList.contains("sub-zone") && target.id !== "item-bank" && target.tagName !== "BODY") {
                target = target.parentElement;
            }

            if (target.classList.contains("drop-zone") || target.classList.contains("sub-zone") || target.id === "item-bank") {
                target.appendChild(draggedElement);
            }
            
            if(selectedItem) {
                selectedItem.style.backgroundColor = "white";
                selectedItem.style.borderColor = "#555";
                selectedItem = null;
            }
        }

        document.querySelectorAll('.drop-zone, .sub-zone, #item-bank').forEach(zone => {
            zone.addEventListener('click', function(e) {
                if (selectedItem && e.target !== selectedItem && !e.target.closest('.draggable-item')) {
                    zone.appendChild(selectedItem);
                    selectedItem.style.backgroundColor = "white";
                    selectedItem.style.borderColor = "#555";
                    selectedItem = null;
                }
            });
            zone.addEventListener('dragleave', function() { zone.classList.remove("drag-over"); });
        });


        // --- V√âRIFICATION LOGIQUE ---
        
        function verifierColonneGlobale(globalCatName, inputId, msgId) {
            let dropZones = [];
            
            if (globalCatName === 'recette') {
                dropZones = document.querySelectorAll(`.sub-zone[data-category^="recette-"]`);
            } else {
                dropZones = document.querySelectorAll(`.drop-zone[data-category="${globalCatName}"]`);
            }
            
            const input = document.getElementById(inputId);
            const msg = document.getElementById(msgId);
            
            let sumItems = 0;
            let errors = false;

            for (let zone of dropZones) {
                for (let item of zone.children) {
                    let itemVal = parseInt(item.getAttribute("data-val"));
                    let itemCat = item.getAttribute("data-cat"); 
                    let expectedCat = zone.getAttribute("data-category");
                    
                    if (globalCatName === 'recette' ? itemCat !== expectedCat : itemCat !== globalCatName) {
                        errors = true;
                        item.style.border = "3px solid #dc3545"; 
                        setTimeout(() => item.style.border = "2px solid #555", 3000);
                    } else {
                        sumItems += itemVal;
                        item.style.border = "2px solid #28a745"; 
                    }
                }
            }

            if (errors) {
                msg.innerHTML = "‚ö†Ô∏è Il y a une erreur de classification. (Dette, Fixe HORS Dette, Courante ?).";
                msg.className = "feedback-msg incorrect";
                return;
            }

            let userVal = parseInt(input.value);
            let totalReelAttendu = items.filter(i => (globalCatName === 'recette' ? i.globalCat === 'recette' : i.cat === globalCatName)).reduce((a, b) => a + b.val, 0);

            if (isNaN(userVal)) {
                msg.innerHTML = "√âcris le total dans la case.";
                msg.className = "feedback-msg";
                return;
            }

            if (userVal === totalReelAttendu) {
                msg.innerHTML = "‚úÖ Classification et Total Th√©orique corrects.";
                msg.className = "feedback-msg correct";
                input.style.borderColor = "#28a745";
                input.style.backgroundColor = "#e8f5e9";
                input.disabled = true; 
                
                // Remplissage des cases du bilan pour acc√©l√©rer
                if (globalCatName === 'recette') document.getElementById('final-recettes').value = userVal;
                if (globalCatName === 'dette') document.getElementById('final-dettes').value = userVal;
                if (globalCatName === 'fixe') document.getElementById('final-fixes').value = userVal;
                if (globalCatName === 'courante' || globalCatName === 'occas') {
                    // On ne fait rien ici, ce sera g√©r√© par la fonction bilan
                }

            } else {
                msg.innerHTML = "‚ùå Le calcul est faux. (Attendu : " + totalReelAttendu + " ‚Ç¨)";
                msg.className = "feedback-msg incorrect";
            }
        }

        // --- V√âRIFICATION BILAN ET RATIOS ---
        function verifierBilanAmira() {
            // Totaux interm√©diaires
            const R = parseInt(document.getElementById('final-recettes').value) || 0;
            const Dt = parseInt(document.getElementById('final-dettes').value) || 0;
            const DF = parseInt(document.getElementById('final-fixes').value) || 0;
            const inputDC = parseInt(document.getElementById('input-courantes').value) || 0;
            const inputDO = parseInt(document.getElementById('input-occas').value) || 0;
            const inputE = parseInt(document.getElementById('input-epargne').value) || 0;
            
            // Cases de sortie
            const TE_input = parseFloat(document.getElementById('final-taux-endettement').value.replace(',', '.'));
            const RAV_input = parseInt(document.getElementById('final-rav').value) || 0;
            const DCOO_input = parseInt(document.getElementById('final-courant-occas').value) || 0;
            const MM_input = parseInt(document.getElementById('final-marge-manoeuvre').value) || 0;
            const msg = document.getElementById('msg-bilan');

            // 1. V√©rifier si les 6 totaux de classification sont valid√©s
            if (document.getElementById('input-recettes').disabled === false || 
                document.getElementById('input-dettes').disabled === false ||
                document.getElementById('input-fixes').disabled === false ||
                document.getElementById('input-courantes').disabled === false ||
                document.getElementById('input-occas').disabled === false ||
                document.getElementById('input-epargne').disabled === false) {
                
                msg.innerHTML = "‚ö†Ô∏è Valide d'abord les 6 totaux de colonnes (R, Dt, DF, DC, DO, E).";
                msg.className = "feedback-msg incorrect";
                return;
            }

            let errors = [];

            // 2. Calculs et v√©rifications
            
            // Taux d'endettement
            const teAttendu = (Dt / R) * 100;
            if (Math.abs(TE_input - teAttendu) > 0.1) {
                errors.push("Taux d'Endettement (TE) faux. (Attendu : " + teAttendu.toFixed(1) + "%)");
            }
            
            // Reste √† vivre (RAV)
            const ravAttendu = R - Dt - DF;
            if (RAV_input !== ravAttendu) {
                errors.push("Reste √† Vivre (RAV) faux. (Attendu : " + ravAttendu + " ‚Ç¨)");
            }

            // D√©penses courantes + occasionnelles (DCOO)
            const dcooAttendu = inputDC + inputDO;
            if (DCOO_input !== dcooAttendu) {
                 errors.push("Total D√©penses Courantes et Occasionnelles (DCOO) faux. (Attendu : " + dcooAttendu + " ‚Ç¨)");
            }
            
            // Marge de man≈ìuvre (MM)
            const mmAttendu = ravAttendu - dcooAttendu;
            if (MM_input !== mmAttendu) {
                errors.push("Marge de Man≈ìuvre (MM) fausse. (Attendu : " + mmAttendu + " ‚Ç¨)");
            }
            
            if (errors.length > 0) {
                msg.innerHTML = "‚ùå " + errors.join(" ");
                msg.className = "feedback-msg incorrect";
                return;
            }
            
            // Succ√®s
            document.getElementById('final-taux-endettement').value = teAttendu.toFixed(1);
            document.getElementById('final-marge-manoeuvre').value = mmAttendu;
            
            msg.innerHTML = "‚úÖ Diagnostic correct ! Taux d'endettement : " + teAttendu.toFixed(1) + "%. Marge de Man≈ìuvre : " + mmAttendu + " ‚Ç¨.";
            msg.className = "feedback-msg correct";
            document.getElementById('budget-status').style.opacity = "1";
            document.getElementById('budget-status').style.pointerEvents = "auto";
            document.getElementById('btn-conclusion').style.display = "inline-block";
        }

        function verifierConclusionAmira() {
            const radios = document.getElementsByName('budget');
            let selected;
            for(let radio of radios) { if(radio.checked) selected = radio.value; }
            
            const msg = document.getElementById('msg-conclusion');

            let correctStatus = "";
            if (tauxEndettement <= 33) correctStatus = "secure";
            else if (tauxEndettement > 33) correctStatus = "alerte";
            // Pas de cas critique pour Amira
            
            if (selected === correctStatus) {
                msg.innerHTML = "üéâ AMIRA est en **alerte** ! Son taux d'endettement de " + tauxEndettement.toFixed(1) + "% est sup√©rieur au seuil de 33%. Elle aura du mal √† emprunter √† nouveau.";
                msg.className = "feedback-msg correct";
                msg.style.fontSize = "1.3rem";
                document.body.style.backgroundColor = "#fff9e6"; // Jaune/cr√®me d'alerte pour finir
            } else {
                msg.innerHTML = "Non. Le TE est de " + tauxEndettement.toFixed(1) + "%. Quel est le statut ?";
                msg.className = "feedback-msg incorrect";
            }
        }

        // --- AUDIO GESTION (Play/Stop & Clean Text) ---
        let isSpeaking = false;
        
        function toggleAudio() {
            const btn = document.getElementById('main-audio-btn');
            
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                btn.classList.remove('playing');
                btn.innerHTML = '<span>‚ñ∂Ô∏è Lire l\'histoire</span>';
            } else {
                let text = document.getElementById('text-content').innerText;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                utterance.rate = 0.9;
                
                utterance.onend = function() {
                    isSpeaking = false;
                    btn.classList.remove('playing');
                    btn.innerHTML = '<span>‚ñ∂Ô∏è Lire l\'histoire</span>';
                };

                window.speechSynthesis.speak(utterance);
                isSpeaking = true;
                btn.classList.add('playing');
                btn.innerHTML = '<span>‚èπÔ∏è Arr√™ter</span>';
            }
        }
    </script>
</body>
</html>