<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module D2 : Le Budget d'Amira</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --error: #dc2626; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; padding: 15px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 1100px; width: 100%; }
        header { background: #2563eb; color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .obj-box { background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px; font-size: 0.9rem; margin-top: 10px; }
        .context-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; line-height: 1.6; }
        #item-bank { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; background: #fff; padding: 15px; border-radius: 12px; border: 2px dashed #cbd5e1; margin-bottom: 20px; min-height: 80px; }
        .draggable-item { padding: 12px 15px; background: white; border: 2px solid #64748b; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; user-select: none; }
        .draggable-item.selected { border-color: #2563eb; background: #eff6ff; transform: scale(1.05); }
        .correct-info { display: none; font-size: 0.85rem; color: #dc3545; margin-top: 5px; font-weight: bold; }
        .budget-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; width: 100%; }
        .column { background: white; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; min-height: 400px; border-top: 8px solid #ccc; }
        #col-recettes { border-top-color: #28a745; }
        #col-fixes { border-top-color: #007bff; }
        #col-courantes { border-top-color: #ffc107; }
        #col-occas { border-top-color: #dc3545; }
        .drop-zone { flex-grow: 1; padding: 10px; border-radius: 8px; background: #f8fafc; min-height: 150px; cursor: pointer; }
        .sub-zone { background: #e2f3e5; margin-bottom: 10px; border-radius: 8px; padding: 10px; min-height: 80px; }
        .sub-zone h4 { margin: 0 0 8px 0; font-size: 0.85rem; text-transform: uppercase; color: #166534; }
        .calc-zone { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; text-align: center; }
        input[type="number"] { width: 100px; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center; }
        .btn-valider { background: #1e293b; color: white; border: none; padding: 20px; border-radius: 12px; font-size: 1.2rem; font-weight: 800; cursor: pointer; margin-top: 30px; width: 100%; }
        #result-zone { display: none; width: 100%; background: white; padding: 25px; border-radius: 20px; border: 4px solid #2563eb; margin-top: 30px; text-align: center; }
        .synthesis-card { background: #eff6ff; border: 2px solid #2563eb; padding: 15px; border-radius: 12px; margin: 20px 0; text-align: left; }
        .syn-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; }
        .chart-box { height: 350px; margin: 20px 0; }

        /* âœ… Ajustements techniques (sans modifier le contenu pÃ©dagogique) */
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; }
        body { padding: 15px; }
        .container { width: 100%; max-width: 1100px; }
        .context-box, header, #result-zone { max-width: 1100px; }
        .draggable-item { max-width: 100%; }
        .draggable-item, .btn-valider, input[type="number"] { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .budget-container { overflow: hidden; }
        .chart-box { position: relative; width: 100%; }
        canvas { max-width: 100% !important; height: 100% !important; }

        /* EmpÃªche dÃ©bordement horizontal sur mobile */
        body { overflow-x: hidden; }
        .container { overflow-x: hidden; }

        /* Solde: Ã©viter la ligne trop large sur mobile */
        .context-box input#in-solde { max-width: 140px; }

        @media (max-width: 600px) {
            body { padding: 12px; }
            header { padding: 16px; border-radius: 12px; }
            .context-box { padding: 14px; border-radius: 12px; }
            #item-bank { padding: 12px; }
            .draggable-item { padding: 10px 12px; }
            .column { min-height: 320px; padding: 12px; }
            input[type="number"] { width: 120px; }
            .btn-valider { padding: 16px; font-size: 1.1rem; border-radius: 12px; }
            .chart-box { height: 280px; }
            /* Ligne solde en colonne sur mobile */
            .context-box .solde-row { flex-direction: column; align-items: flex-start !important; gap: 10px; }
            .context-box .solde-row input#in-solde { width: 100%; max-width: 220px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1 style="margin:0;">Module D2 : Le Budget</h1>
        <div class="obj-box"><strong>Objectif :</strong> Adopter une attitude responsable face Ã  la gestion de son budget.</div>
    </header>
    <div class="context-box">
        <strong>Situation :</strong> Amira perÃ§oit un <b>salaire de 2 257,14 â‚¬</b>. Elle reÃ§oit Ã©galement une <b>allocation de soutien familial de 113,22 â‚¬</b>. <br><br>
        Ses opÃ©rations : Loyer (1 027,13 â‚¬), Taxe d'habitation (60,00 â‚¬), Mutuelle (57,13 â‚¬), Facture d'Ã©lectricitÃ© (113,33 â‚¬), Courses alimentaires (297,23 â‚¬), Transport (100,00 â‚¬), Abonnement transport (30,00 â‚¬), HygiÃ¨ne (27,00 â‚¬), Coiffeur (35,00 â‚¬), Achat d'un ordinateur (650,00 â‚¬) et Habillement (83,00 â‚¬).
    </div>
    <p style="font-weight:bold;">1. Cliquez sur une Ã©tiquette, puis sur sa catÃ©gorie :</p>
    <div id="item-bank"></div>
    <div class="budget-container">
        <div class="column" id="col-recettes">
            <h3>Recettes</h3>
            <div class="drop-zone sub-zone" data-category="recette-travail"><h4>Travail</h4></div>
            <div class="drop-zone sub-zone" data-category="recette-social"><h4>Social</h4></div>
            <div class="calc-zone">Total : <input type="number" step="0.01" id="in-recettes"> â‚¬</div>
        </div>
        <div class="column" id="col-fixes">
            <h3>Fixes (Incompressibles)</h3>
            <div class="drop-zone" data-category="fixe"></div>
            <div class="calc-zone">Total : <input type="number" step="0.01" id="in-fixes"> â‚¬</div>
        </div>
        <div class="column" id="col-courantes">
            <h3>Courantes</h3>
            <div class="drop-zone" data-category="courante"></div>
            <div class="calc-zone">Total : <input type="number" step="0.01" id="in-courantes"> â‚¬</div>
        </div>
        <div class="column" id="col-occas">
            <h3>Occas. (Exceptionnelles)</h3>
            <div class="drop-zone" data-category="occas"></div>
            <div class="calc-zone">Total : <input type="number" step="0.01" id="in-occas"> â‚¬</div>
        </div>
    </div>
    <div class="context-box" style="margin-top: 20px;">
        <span style="font-weight: bold;">Calcul final :</span>
        <div class="solde-row" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <span>Quel est le solde d'Amira ? (Recettes - DÃ©penses)</span>
            <input type="number" step="0.01" id="in-solde" style="width: 120px; padding: 12px; border: 2px solid var(--primary); border-radius: 8px;">
        </div>
    </div>
    <button class="btn-valider" onclick="analyser()" id="btn-analyser">VOIR MES RÃ‰SULTATS</button>
    <div id="result-zone">
        <h2 id="final-score">Score : -- / 20</h2>
        <div class="synthesis-card">
            <div class="syn-row" id="syn-rec"><span>Total Recettes :</span> <span class="val">--</span></div>
            <div class="syn-row" id="syn-dep"><span>Total DÃ©penses :</span> <span class="val">--</span></div>
            <hr><div class="syn-row" id="syn-sol" style="color:#2563eb"><span>SOLDE FINAL :</span> <span class="val">--</span></div>
        </div>
        <div class="chart-box"><canvas id="barChart"></canvas></div>
        <button class="btn-valider" style="background: #64748b;" onclick="location.reload()">ðŸ”„ RECOMMENCER</button>
    </div>
</div>
<script>
    const items = [
        { id: 1, name: "Salaire", val: 2257.14, cat: "recette-travail", label: "Recettes (Travail)" },
        { id: 2, name: "Allocation soutien familial", val: 113.22, cat: "recette-social", label: "Recettes (Social)" },
        { id: 3, name: "Loyer", val: 1027.13, cat: "fixe", label: "DÃ©penses Fixes" },
        { id: 4, name: "Taxe habitation", val: 60.00, cat: "fixe", label: "DÃ©penses Fixes" },
        { id: 5, name: "Mutuelle", val: 57.13, cat: "fixe", label: "DÃ©penses Fixes" },
        { id: 6, name: "Facture Ã©lectricitÃ©", val: 113.33, cat: "fixe", label: "DÃ©penses Fixes" },
        { id: 7, name: "Courses alimentaires", val: 297.23, cat: "courante", label: "DÃ©penses Courantes" },
        { id: 8, name: "Transport", val: 100.00, cat: "courante", label: "DÃ©penses Courantes" },
        { id: 9, name: "Abonnement transport", val: 30.00, cat: "courante", label: "DÃ©penses Courantes" },
        { id: 10, name: "HygiÃ¨ne", val: 27.00, cat: "courante", label: "DÃ©penses Courantes" },
        { id: 11, name: "Coiffeur", val: 35.00, cat: "occas", label: "DÃ©penses Occasionnelles" },
        { id: 12, name: "Ordinateur", val: 650.00, cat: "occas", label: "DÃ©penses Occasionnelles" },
        { id: 13, name: "Habillement", val: 83.00, cat: "occas", label: "DÃ©penses Occasionnelles" }
    ];
    let selectedItem = null;
    const bank = document.getElementById("item-bank");
    items.sort(() => Math.random() - 0.5).forEach(item => {
        let el = document.createElement("div");
        el.className = "draggable-item";
        el.id = "i-" + item.id;
        el.innerHTML = `${item.name} (${item.val.toFixed(2)}â‚¬) <div class="correct-info" id="info-${item.id}">Doit Ãªtre dans : ${item.label}</div>`;
        el.onclick = (e) => {
            e.stopPropagation();
            if(selectedItem) selectedItem.classList.remove('selected');
            selectedItem = el;
            el.classList.add('selected');
        };
        bank.appendChild(el);
    });
    document.querySelectorAll('.drop-zone, #item-bank').forEach(zone => {
        zone.onclick = () => {
            if(selectedItem) {
                zone.appendChild(selectedItem);
                selectedItem.classList.remove('selected');
                selectedItem = null;
            }
        };
    });

    let _barChartInstance = null;

    function analyser() {
        const btn = document.getElementById('btn-analyser');
        if (btn && btn.disabled) return;
        if (btn) { btn.disabled = true; btn.style.opacity = "0.85"; btn.style.cursor = "not-allowed"; }

        let score = 0;
        let placementRecettes = 0;
        let placementDepenses = 0;
        items.forEach(item => {
            let el = document.getElementById("i-" + item.id);
            let info = document.getElementById("info-" + item.id);
            let parentCat = el.parentElement && el.parentElement.dataset ? el.parentElement.dataset.category : undefined;
            if (parentCat === item.cat) {
                score += 1; el.style.borderColor = "#28a745"; info.style.display = "none";
                if(item.cat.includes("recette")) placementRecettes++; else placementDepenses++;
            } else {
                el.style.borderColor = "#dc3545"; info.style.display = "block";
            }
        });

        const inR = parseFloat(document.getElementById("in-recettes").value) || 0;
        const inF = parseFloat(document.getElementById("in-fixes").value) || 0;
        const inC = parseFloat(document.getElementById("in-courantes").value) || 0;
        const inO = parseFloat(document.getElementById("in-occas").value) || 0;
        const inSolde = parseFloat(document.getElementById("in-solde").value) || 0;
        const totalD = Number((inF + inC + inO).toFixed(2));
        const soldeCorrect = Number((2370.36 - 2533.15).toFixed(2)); // Solde attendu : -162.79â‚¬

        if (Math.abs(inR - 2370.36) < 0.01) score += 2;
        if (Math.abs(inF - 1257.59) < 0.01) score += 1.5;
        if (Math.abs(inC - 454.23) < 0.01) score += 1.5;
        if (Math.abs(inO - 768.00) < 0.01) score += 1.5;
        if (Math.abs(inSolde - (-162.79)) < 0.01) score += 0.5;

        document.getElementById("result-zone").style.display = "block";
        document.getElementById("final-score").innerText = `Score : ${Math.round(Math.min(20, score))} / 20`;
        document.querySelector("#syn-rec .val").innerHTML = `${inR.toFixed(2)}â‚¬ ${Math.abs(inR - 2370.36) < 0.01 ? 'âœ…' : 'âŒ'}`;
        document.querySelector("#syn-dep .val").innerHTML = `${totalD.toFixed(2)}â‚¬ ${Math.abs(totalD - 2533.15) < 0.01 ? 'âœ…' : 'âŒ'}`;
        document.querySelector("#syn-sol .val").innerHTML = `${inSolde.toFixed(2)}â‚¬ ${Math.abs(inSolde - (-162.79)) < 0.01 ? 'âœ…' : 'âŒ'}`;

        // Anti-crash / anti-duplication Chart si l'Ã©lÃ¨ve clique plusieurs fois
        try {
            const ctx = document.getElementById('barChart');
            if (_barChartInstance) { _barChartInstance.destroy(); _barChartInstance = null; }
            _barChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Recettes', 'DÃ©penses', 'Solde'],
                    datasets: [{
                        label: '% de rÃ©ussite',
                        data: [ (placementRecettes/2)*100, (placementDepenses/11)*100, (Math.abs(inSolde - (-162.79)) < 0.01 ? 100 : 0) ],
                        backgroundColor: ['#28a745', '#ffc107', '#2563eb'],
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
            });
        } catch(e) {
            // Si Chart.js ne charge pas (rÃ©seau), on ne bloque pas l'exercice
        }

        window.scrollTo({ top: document.getElementById("result-zone").offsetTop, behavior: 'smooth' });
    }
</script>
</body>
</html>
