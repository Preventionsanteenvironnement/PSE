<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module D2 : Le Budget d'Amira</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="annuaire.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    :root { --primary:#2563eb; --success:#16a34a; --error:#dc2626; --bg:#f1f5f9; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; }
    body{
      font-family:'Segoe UI',sans-serif; background:var(--bg); color:#333;
      padding:15px; display:flex; flex-direction:column; align-items:center;
      overflow-x:hidden;
    }
    .container{ max-width:1100px; width:100%; overflow-x:hidden; }
    header{
      background:#2563eb; color:#fff; padding:20px; border-radius:15px;
      text-align:center; margin-bottom:20px;
    }
    .obj-box{
      background:rgba(255,255,255,0.15); padding:10px; border-radius:8px;
      font-size:0.9rem; margin-top:10px;
    }
    .context-box{
      background:#fff; padding:20px; border-radius:15px;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
      margin-bottom:20px; line-height:1.6;
      overflow-wrap:anywhere;
    }

    #item-bank{
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
      background:#fff; padding:15px; border-radius:12px;
      border:2px dashed #cbd5e1; margin-bottom:20px; min-height:80px;
    }
    .draggable-item{
      padding:12px 15px; background:#fff; border:2px solid #64748b;
      border-radius:8px; cursor:pointer; font-weight:bold; transition:0.2s;
      user-select:none; max-width:100%;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .draggable-item.selected{ border-color:#2563eb; background:#eff6ff; transform:scale(1.03); }
    .draggable-item.correct{ border-color:var(--success); }
    .draggable-item.wrong{ border-color:var(--error); }
    .correct-info{
      display:none; font-size:0.85rem; color:#dc3545; margin-top:5px; font-weight:bold;
    }

    .budget-container{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr));
      gap:15px; width:100%; overflow:hidden;
    }
    .column{
      background:#fff; border-radius:12px; padding:15px;
      display:flex; flex-direction:column; min-height:400px; border-top:8px solid #ccc;
    }
    #col-recettes{ border-top-color:#28a745; }
    #col-fixes{ border-top-color:#007bff; }
    #col-courantes{ border-top-color:#ffc107; }
    #col-occas{ border-top-color:#dc3545; }

    .drop-zone{
      flex-grow:1; padding:10px; border-radius:8px; background:#f8fafc;
      min-height:150px; cursor:pointer; overflow:auto;
    }
    .sub-zone{
      background:#e2f3e5; margin-bottom:10px; border-radius:8px;
      padding:10px; min-height:80px; overflow:auto;
    }
    .sub-zone h4{
      margin:0 0 8px 0; font-size:0.85rem; text-transform:uppercase; color:#166534;
    }

    .calc-zone{
      margin-top:15px; padding-top:10px; border-top:1px solid #eee;
      display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap;
      text-align:center;
    }
    input[type="text"]{
      width:150px; padding:8px; border:2px solid #cbd5e1; border-radius:6px;
      text-align:center; font-weight:bold; font-size:1rem;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .hint{ font-size:0.9rem; color:#64748b; width:100%; }

    .btn-valider{
      background:#1e293b; color:#fff; border:none; padding:20px;
      border-radius:12px; font-size:1.2rem; font-weight:800; cursor:pointer;
      margin-top:30px; width:100%;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .btn-disabled{ opacity:0.7; cursor:not-allowed; }

    #result-zone{
      display:none; width:100%; background:#fff; padding:25px;
      border-radius:20px; border:4px solid #2563eb; margin-top:30px; text-align:center;
      overflow-wrap:anywhere;
    }
    .synthesis-card{
      background:#eff6ff; border:2px solid #2563eb; padding:15px;
      border-radius:12px; margin:20px 0; text-align:left;
    }
    .syn-row{
      display:flex; justify-content:space-between; margin-bottom:8px; font-weight:bold;
      gap:10px; flex-wrap:wrap;
    }
    .chart-box{ height:350px; margin:20px 0; position:relative; width:100%; }
    .chart-box canvas{ max-width:100% !important; height:100% !important; }

    .warn-box{
      text-align:left; background:#fff7ed; border:2px solid #fdba74;
      padding:12px; border-radius:10px; margin:0 0 15px; display:none;
    }

    .solde-row{
      display:flex; justify-content:space-between; align-items:center;
      margin-top:10px; gap:12px; flex-wrap:wrap;
    }
    .solde-row > span{ flex:1 1 260px; min-width:200px; }
    .solde-row > input{ flex:0 0 auto; }

    .locked .drop-zone,
    .locked #item-bank,
    .locked .draggable-item{ pointer-events:none; }
    .locked input{ pointer-events:none; opacity:0.95; }

    @media (max-width:600px){
      body{ padding:12px; }
      header{ padding:16px; border-radius:12px; }
      .context-box{ padding:14px; border-radius:12px; }
      #item-bank{ padding:12px; }
      .draggable-item{ padding:10px 12px; }
      .column{ min-height:320px; padding:12px; }
      input[type="text"]{ width:170px; }
      .btn-valider{ padding:16px; font-size:1.1rem; border-radius:12px; }
      .chart-box{ height:280px; }
      .solde-row{ flex-direction:column; align-items:flex-start; }
      .solde-row input{ width:100%; max-width:240px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1 style="margin:0;">Module D2 : Le Budget</h1>
      <div class="obj-box"><strong>Objectif :</strong> Adopter une attitude responsable face √† la gestion de son budget.</div>
    </header>

    <script>
      if(typeof enregistrerVisite === "function") {
        try { enregistrerVisite("Exercice Amira - Budget"); } catch(e) {}
      }
    </script>

    <div class="context-box">
      <strong>Situation :</strong> Amira per√ßoit un <b>salaire de 2 257,14 ‚Ç¨</b>. Elle re√ßoit √©galement une <b>allocation de soutien familial de 113,22 ‚Ç¨</b>.<br><br>
      Ses op√©rations : Loyer (1 027,13 ‚Ç¨), Taxe d'habitation (60,00 ‚Ç¨), Mutuelle (57,13 ‚Ç¨), Facture d'√©lectricit√© (113,33 ‚Ç¨), Courses alimentaires (297,23 ‚Ç¨), Transport (100,00 ‚Ç¨), Abonnement transport (30,00 ‚Ç¨), Hygi√®ne (27,00 ‚Ç¨), Coiffeur (35,00 ‚Ç¨), Achat d'un ordinateur (650,00 ‚Ç¨) et Habillement (83,00 ‚Ç¨).
    </div>

    <p style="font-weight:bold;">1. Clique sur une √©tiquette, puis clique sur sa cat√©gorie :</p>
    <div id="item-bank"></div>

    <div class="budget-container">
      <div class="column" id="col-recettes">
        <h3>Recettes</h3>
        <div class="drop-zone sub-zone" data-category="recette-travail" role="button" tabindex="0"><h4>Travail</h4></div>
        <div class="drop-zone sub-zone" data-category="recette-social" role="button" tabindex="0"><h4>Social</h4></div>
        <div class="calc-zone">
          Total :
          <input type="text" inputmode="decimal" id="in-recettes" placeholder="ex 2370,36">
          ‚Ç¨
          <div class="hint">Virgule, point, espaces et ‚Ç¨ accept√©s</div>
        </div>
      </div>

      <div class="column" id="col-fixes">
        <h3>Fixes (Incompressibles)</h3>
        <div class="drop-zone" data-category="fixe" role="button" tabindex="0"></div>
        <div class="calc-zone">
          Total :
          <input type="text" inputmode="decimal" id="in-fixes" placeholder="ex 1257,59">
          ‚Ç¨
        </div>
      </div>

      <div class="column" id="col-courantes">
        <h3>Courantes</h3>
        <div class="drop-zone" data-category="courante" role="button" tabindex="0"></div>
        <div class="calc-zone">
          Total :
          <input type="text" inputmode="decimal" id="in-courantes" placeholder="ex 454,23">
          ‚Ç¨
        </div>
      </div>

      <div class="column" id="col-occas">
        <h3>Occas. (Exceptionnelles)</h3>
        <div class="drop-zone" data-category="occas" role="button" tabindex="0"></div>
        <div class="calc-zone">
          Total :
          <input type="text" inputmode="decimal" id="in-occas" placeholder="ex 768,00">
          ‚Ç¨
        </div>
      </div>
    </div>

    <div class="context-box" style="margin-top: 20px;">
      <span style="font-weight: bold;">Calcul final :</span>
      <div class="solde-row">
        <span>Quel est le solde d'Amira ? (Recettes - D√©penses)</span>
        <input type="text" inputmode="decimal" id="in-solde" placeholder="ex -109,46"
               style="width: 170px; padding: 12px; border: 2px solid var(--primary); border-radius: 8px; font-weight:bold;">
      </div>
      <div class="hint">Le solde peut √™tre n√©gatif</div>
    </div>

    <div class="warn-box" id="warn-box"></div>

    <button class="btn-valider" id="btn-analyser" type="button">VOIR MES R√âSULTATS</button>

    <div id="result-zone">
      <h2 id="final-score">Score : -- / 20</h2>
      <div class="synthesis-card">
        <div class="syn-row" id="syn-rec"><span>Total Recettes :</span> <span class="val">--</span></div>
        <div class="syn-row" id="syn-dep"><span>Total D√©penses :</span> <span class="val">--</span></div>
        <hr>
        <div class="syn-row" id="syn-sol" style="color:#2563eb"><span>SOLDE FINAL :</span> <span class="val">--</span></div>
      </div>
      <div class="chart-box"><canvas id="barChart"></canvas></div>
      <div id="chart-fallback" style="display:none; margin: 15px 0; padding: 12px; border-radius: 10px; background: #f8fafc; border: 1px solid #e2e8f0; text-align:left;"></div>
      <button class="btn-valider" type="button" style="background:#64748b" onclick="location.reload()">üîÑ RECOMMENCER</button>
    </div>
  </div>

  <script>
    window.PSE_CODE_REQUIRED = true;

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    try {
      if (typeof firebase !== "undefined" && firebaseConfig && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      window.db = (typeof firebase !== "undefined") ? firebase.firestore() : null;
    } catch(e) {
      window.db = null;
    }
  </script>

  <script>
    const items = [
      { id: 1,  name: "Salaire",                    val: 2257.14, cat: "recette-travail", label: "Recettes (Travail)" },
      { id: 2,  name: "Allocation soutien familial", val:  113.22, cat: "recette-social",  label: "Recettes (Social)" },
      { id: 3,  name: "Loyer",                      val: 1027.13, cat: "fixe",           label: "D√©penses Fixes" },
      { id: 4,  name: "Taxe habitation",            val:   60.00, cat: "fixe",           label: "D√©penses Fixes" },
      { id: 5,  name: "Mutuelle",                   val:   57.13, cat: "fixe",           label: "D√©penses Fixes" },
      { id: 6,  name: "Facture √©lectricit√©",        val:  113.33, cat: "fixe",           label: "D√©penses Fixes" },
      { id: 7,  name: "Courses alimentaires",       val:  297.23, cat: "courante",       label: "D√©penses Courantes" },
      { id: 8,  name: "Transport",                  val:  100.00, cat: "courante",       label: "D√©penses Courantes" },
      { id: 9,  name: "Abonnement transport",       val:   30.00, cat: "courante",       label: "D√©penses Courantes" },
      { id: 10, name: "Hygi√®ne",                    val:   27.00, cat: "courante",       label: "D√©penses Courantes" },
      { id: 11, name: "Coiffeur",                   val:   35.00, cat: "occas",          label: "D√©penses Occasionnelles" },
      { id: 12, name: "Ordinateur",                 val:  650.00, cat: "occas",          label: "D√©penses Occasionnelles" },
      { id: 13, name: "Habillement",                val:   83.00, cat: "occas",          label: "D√©penses Occasionnelles" }
    ];

    const EXPECT = {
      R: 2370.36,
      F: 1257.59,
      C: 454.23,
      O: 768.00,
      D: 2479.82,
      S: -109.46
    };

    let selectedItem = null;
    const bank = document.getElementById("item-bank");
    const warnBox = document.getElementById("warn-box");
    const btnAnalyser = document.getElementById("btn-analyser");

    function normalizeNumberInput(str) {
      if (!str) return null;
      let s = String(str);

      s = s.replace(/\u00A0/g, " ").trim();
      s = s.replace(/\s+/g, "");
      s = s.replace(/‚Ç¨/g, "");
      s = s.replace(/[^0-9+\-.,]/g, "");

      const lastComma = s.lastIndexOf(",");
      const lastDot = s.lastIndexOf(".");
      const decPos = Math.max(lastComma, lastDot);

      if (decPos !== -1) {
        const intPart = s.slice(0, decPos).replace(/[.,]/g, "");
        const decPart = s.slice(decPos + 1).replace(/[.,]/g, "");
        s = intPart + "." + decPart;
      } else {
        s = s.replace(/[.,]/g, "");
      }

      if (!s || s === "+" || s === "-" || s === "." || s === "+." || s === "-.") return null;

      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function isClose(n, target, tol = 0.02) {
      return (typeof n === "number") && Number.isFinite(n) && Math.abs(n - target) <= tol;
    }

    function setWarn(html) {
      warnBox.innerHTML = html;
      warnBox.style.display = html ? "block" : "none";
    }

    function kbActivate(e, fn) {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); fn(); }
    }

    function toggleSelect(el) {
      if (selectedItem === el) {
        el.classList.remove("selected");
        selectedItem = null;
        return;
      }
      if (selectedItem) selectedItem.classList.remove("selected");
      selectedItem = el;
      el.classList.add("selected");
    }

    function lockAll() {
      document.body.classList.add("locked");
    }

    function countUnplaced() {
      let unplaced = 0;
      items.forEach(item => {
        const el = document.getElementById("i-" + item.id);
        if (el && el.parentElement && el.parentElement.id === "item-bank") unplaced++;
      });
      return unplaced;
    }

    items.slice().sort(() => Math.random() - 0.5).forEach(item => {
      const el = document.createElement("div");
      el.className = "draggable-item";
      el.id = "i-" + item.id;
      el.setAttribute("role","button");
      el.setAttribute("tabindex","0");
      el.innerHTML = `${item.name} (${item.val.toFixed(2)}‚Ç¨) <div class="correct-info" id="info-${item.id}">Doit √™tre dans : ${item.label}</div>`;
      el.onclick = (e) => { e.stopPropagation(); toggleSelect(el); };
      el.onkeydown = (e) => kbActivate(e, () => toggleSelect(el));
      bank.appendChild(el);
    });

    document.querySelectorAll(".drop-zone, #item-bank").forEach(zone => {
      zone.onclick = () => {
        if (selectedItem) {
          zone.appendChild(selectedItem);
          selectedItem.classList.remove("selected");
          selectedItem = null;
        }
      };
      zone.onkeydown = (e) => kbActivate(e, () => zone.click());
    });

    let chartInstance = null;
    let alreadySubmitted = false;

    btnAnalyser.addEventListener("click", analyser);

    async function analyser() {
      if (alreadySubmitted) return;
      alreadySubmitted = true;

      btnAnalyser.disabled = true;
      btnAnalyser.classList.add("btn-disabled");

      const unplaced = countUnplaced();
      if (unplaced > 0) {
        setWarn(`Il reste ${unplaced} √©tiquette${unplaced > 1 ? "s" : ""} non class√©e${unplaced > 1 ? "s" : ""}. Tu peux quand m√™me voir tes r√©sultats, mais ton score sera plus bas.`);
      } else {
        setWarn("");
      }

      let score = 0;
      let placementRecettes = 0;
      let placementDepenses = 0;

      items.forEach(item => {
        const el = document.getElementById("i-" + item.id);
        const info = document.getElementById("info-" + item.id);
        const parentCat = (el.parentElement && el.parentElement.dataset) ? el.parentElement.dataset.category : undefined;

        el.classList.remove("correct","wrong");
        if (info) info.style.display = "none";

        if (parentCat === item.cat) {
          score += 1; // 13 √©tiquettes = 13 points
          el.classList.add("correct");
          if (item.cat.includes("recette")) placementRecettes++; else placementDepenses++;
        } else {
          el.classList.add("wrong");
          if (info) info.style.display = "block";
        }
      });

      const inR = normalizeNumberInput(document.getElementById("in-recettes").value);
      const inF = normalizeNumberInput(document.getElementById("in-fixes").value);
      const inC = normalizeNumberInput(document.getElementById("in-courantes").value);
      const inO = normalizeNumberInput(document.getElementById("in-occas").value);
      const inS = normalizeNumberInput(document.getElementById("in-solde").value);

      const vR = (inR === null) ? NaN : inR;
      const vF = (inF === null) ? NaN : inF;
      const vC = (inC === null) ? NaN : inC;
      const vO = (inO === null) ? NaN : inO;
      const vS = (inS === null) ? NaN : inS;

      const totalD = (Number.isFinite(vF) ? vF : 0) + (Number.isFinite(vC) ? vC : 0) + (Number.isFinite(vO) ? vO : 0);

      const recOk = isClose(vR, EXPECT.R, 0.03);
      const fixOk = isClose(vF, EXPECT.F, 0.03);
      const couOk = isClose(vC, EXPECT.C, 0.03);
      const occOk = isClose(vO, EXPECT.O, 0.03);

      const depOk = isClose(totalD, EXPECT.D, 0.05);
      const soldeOk = isClose(vS, EXPECT.S, 0.05) || (Number.isFinite(vS) && Math.abs(vS - EXPECT.S) <= 0.5);

      // 7 points de calculs pour arriver √† /20
      if (recOk) score += 2;
      if (fixOk) score += 1.5;
      if (couOk) score += 1.5;
      if (occOk) score += 1.5;
      if (soldeOk) score += 0.5;

      const finalScore = Math.max(0, Math.min(20, Math.round(score)));

      document.getElementById("result-zone").style.display = "block";
      document.getElementById("final-score").innerText = `Score : ${finalScore} / 20`;

      document.querySelector("#syn-rec .val").innerHTML = `${Number.isFinite(vR) ? (Math.round(vR*100)/100).toFixed(2) : "--"}‚Ç¨ ${recOk ? "‚úÖ" : "‚ùå"}`;
      document.querySelector("#syn-dep .val").innerHTML = `${(Math.round(totalD*100)/100).toFixed(2)}‚Ç¨ ${depOk ? "‚úÖ" : "‚ùå"}`;
      document.querySelector("#syn-sol .val").innerHTML = `${Number.isFinite(vS) ? (Math.round(vS*100)/100).toFixed(2) : "--"}‚Ç¨ ${soldeOk ? "‚úÖ" : "‚ùå"}`;

      const pcRec = ((placementRecettes + (recOk ? 1 : 0)) / 3) * 100;             // 2 placements + total recettes
      const pcDep = ((placementDepenses + (depOk ? 1 : 0)) / 12) * 100;            // 11 placements + total d√©penses
      const pcSolde = soldeOk ? 100 : 0;

      const fallback = document.getElementById("chart-fallback");
      if (fallback) fallback.style.display = "none";

      try {
        const canvas = document.getElementById("barChart");
        const canDraw = (typeof Chart !== "undefined") && canvas && canvas.getContext;

        if (canDraw) {
          if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
          chartInstance = new Chart(canvas, {
            type: "bar",
            data: {
              labels: ["Recettes", "D√©penses", "Solde"],
              datasets: [{
                label: "% de r√©ussite",
                data: [pcRec, pcDep, pcSolde],
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true, max: 100 } },
              plugins: { legend: { display: false } }
            }
          });
        } else if (fallback) {
          fallback.style.display = "block";
          fallback.innerHTML = `<b>R√©sultats</b><br>Recettes : ${Math.round(pcRec)}%<br>D√©penses : ${Math.round(pcDep)}%<br>Solde : ${Math.round(pcSolde)}%`;
        }
      } catch(e) {
        if (fallback) {
          fallback.style.display = "block";
          fallback.innerHTML = `<b>R√©sultats</b><br>Recettes : ${Math.round(pcRec)}%<br>D√©penses : ${Math.round(pcDep)}%<br>Solde : ${Math.round(pcSolde)}%`;
        }
      }

      lockAll();
      window.scrollTo({ top: document.getElementById("result-zone").offsetTop, behavior: "smooth" });

      try {
        const code = localStorage.getItem("userCode") || localStorage.getItem("codeEleve") || "ANONYME";
        const classe =
          localStorage.getItem("userClasse") ||
          ((typeof ANNUAIRE !== "undefined" && ANNUAIRE && ANNUAIRE[code]) ? ANNUAIRE[code] : "AUTRE");

        if (window.db && typeof firebase !== "undefined") {
          const sentKey = "sent_budget_amira_" + code;
          if (!sessionStorage.getItem(sentKey)) {
            await db.collection("resultats_exercices").add({
              eleve: code,
              classe: classe,
              exercice: "Module D2 - Budget Amira",
              note: finalScore,
              total: 20,
              competences: { "C1": finalScore, "C2": finalScore },
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            sessionStorage.setItem(sentKey, "1");
          }
        }
      } catch(e) {
        console.error("Erreur lors de l'envoi Firebase : ", e);
      }
    }
  </script>
</body>
</html>
