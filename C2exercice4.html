<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>PSE Bac Pro — Prévention (Chute de hauteur) — C4</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101b33;
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.16);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --ok:#37d67a;
      --bad:#ff5a7a;
      --accent:#6d7cff;
      --accent2:#2ad3ff;
      --shadow:0 14px 35px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:26px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% 10%, rgba(109,124,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, rgba(42,211,255,.14), transparent 55%),
                  radial-gradient(900px 600px at 50% 100%, rgba(55,214,122,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding: clamp(14px, 3vw, 26px);
    }
    .wrap{max-width:1020px;margin:0 auto; padding-bottom:40px}
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      margin-bottom:16px;
    }
    h1{margin:0;font-size: clamp(20px, 3.8vw, 34px);letter-spacing:.2px}
    .sub{color:var(--muted);font-size: clamp(13px, 2.5vw, 15px);line-height:1.35}
    .badges{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .badge{
      padding:10px 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      font-size:13px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
      backdrop-filter: blur(10px);
    }
    .badge b{color:var(--text)}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card + .card{margin-top:14px}
    .card-h{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background: rgba(0,0,0,.15);
      border-bottom:1px solid var(--stroke);
    }
    .left{display:flex; align-items:center; gap:10px; flex-wrap:wrap; min-width:0}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill strong{color:var(--text)}
    .card-b{padding:14px 16px}
    .note{color:var(--muted);line-height:1.45;font-size:14px;margin:0 0 12px 0}
    .mini{color:var(--muted2);font-size:12.5px;margin-top:8px;line-height:1.35}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.grid.cols2{grid-template-columns:1fr 1fr}}
    .box{
      background: rgba(0,0,0,.16);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:12px;
    }
    .box h3{margin:0 0 8px 0;font-size:15px;color:var(--text)}
    .scenario{color:var(--muted);font-size:14px;line-height:1.45;margin:0 0 10px 0}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{
      cursor:pointer;border:none;border-radius:14px;padding:12px 14px;font-weight:650;color:var(--text);
      background: linear-gradient(180deg, rgba(109,124,255,.95), rgba(109,124,255,.78));
      box-shadow: 0 10px 20px rgba(109,124,255,.22);
      transition: transform .06s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform: translateY(1px)}
    .btn2{
      background: rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      color:var(--muted);
      box-shadow:none;
      font-weight:650;
    }
    .result{
      margin-top:10px;
      padding:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      background: rgba(0,0,0,.18);
      line-height:1.45;
      font-size:14px;
      white-space:pre-wrap;
    }
    .result.ok{border-color: rgba(55,214,122,.45); color: rgba(221,255,236,.92)}
    .result.bad{border-color: rgba(255,90,122,.55); color: rgba(255,228,235,.92)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      padding:3px 7px;
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      color: var(--muted);
      display:inline-block;
    }
    /* Chips / sorting */
    .bank{
      display:flex;flex-wrap:wrap;gap:10px;min-height:46px;padding:10px;border-radius: var(--radius);
      border:1px solid var(--stroke); background: rgba(0,0,0,.16);
    }
    .chip{
      user-select:none;-webkit-user-select:none;touch-action: manipulation;
      padding:10px 12px;border-radius:999px;border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(22,36,80,.92), rgba(22,36,80,.72));
      color: var(--text);font-size: 13.5px;line-height:1;
      display:inline-flex;gap:8px;align-items:center;
    }
    .chip small{color: var(--muted2);font-weight:600;font-size:12px}
    .chip[draggable="true"]{cursor:grab}
    .chip.selected{
      outline: 3px solid rgba(42,211,255,.42);
      box-shadow: 0 0 0 4px rgba(42,211,255,.16);
      transform: translateY(-1px);
    }
    .drop{
      min-height: 62px;
      padding:10px;
      border-radius: var(--radius);
      border:2px dashed rgba(109,124,255,.35);
      background: rgba(109,124,255,.07);
      display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;
    }
    .drop.dragover{border-color: rgba(42,211,255,.62); background: rgba(42,211,255,.08)}
    .hint{
      color: rgba(255,255,255,.55);
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .fourCol{
      display:grid;grid-template-columns:1fr;gap:12px;
    }
    @media(min-width:980px){.fourCol{grid-template-columns:1fr 1fr 1fr 1fr}}
    .familyHead{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:8px}
    .tag{color: rgba(255,255,255,.65);font-size: 12.5px}
    /* QCM blocks */
    .qcm{
      display:grid;gap:10px;margin-top:8px;
    }
    .opt{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .opt input{margin-top:2px}
    textarea{
      width:100%;
      min-height:96px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(15,24,48,.85);
      color:var(--text);
      outline:none;
      font-size:14px;
      line-height:1.4;
      resize:vertical;
    }
    textarea:focus{border-color: rgba(109,124,255,.55); box-shadow: 0 0 0 4px rgba(109,124,255,.16)}
    .scorebig{
      padding:10px 12px;border-radius:999px;border:1px solid var(--stroke);
      background: rgba(0,0,0,.16);color: var(--muted);font-size:13px
    }
    .scorebig b{color:var(--text)}
    .footer{margin-top:16px;color: var(--muted2);font-size:12.5px;line-height:1.35;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Prévenir le risque • Chute de hauteur</h1>
        <div class="sub">
          Compétence visée : <b>C4</b> — Proposer une solution pour résoudre un problème (mesures de prévention)
          <span class="kbd">Mobile + PC</span>
        </div>
      </div>
      <div class="badges">
        <div class="badge"><b id="totalScore">0</b>/<span id="totalMax">20</span> points</div>
        <div class="badge"><b id="doneCount">0</b>/3 exercices corrigés</div>
      </div>
    </header>

    <section class="card">
      <div class="card-h">
        <div class="left">
          <div class="pill">Idée clé</div>
          <div class="pill"><strong>Priorité</strong> : supprimer le danger / réduire la nocivité (avant EPI)</div>
        </div>
        <div class="pill"><strong>Hiérarchie</strong> des mesures</div>
      </div>
      <div class="card-b">
        <p class="note">
          Les mesures de prévention se classent en 4 familles :
          <b>Élimination / réduction</b> • <b>Protection collective</b> • <b>Protection individuelle (EPI)</b> • <b>Complémentaires</b> (formation, information, consignes).
        </p>
        <div class="mini">
          Exemple : <b>garde-corps</b> = protection collective (prioritaire). <b>Harnais</b> = EPI (complément si la protection collective ne suffit pas).
        </div>
      </div>
    </section>

    <!-- EXO 1 -->
    <section class="card" id="exo1">
      <div class="card-h">
        <div class="left">
          <div class="pill">Exercice 1</div>
          <div class="pill"><strong>Classer les mesures</strong></div>
          <div class="pill"><strong>10</strong> pts • C4</div>
        </div>
        <div class="pill">Glisser-déposer ou toucher</div>
      </div>
      <div class="card-b">
        <p class="note">
          Classe chaque mesure dans la bonne famille.
          <span class="kbd">Téléphone</span> : touche un chip (violet) puis touche une zone pour le déposer. Retire un chip d’une zone en le touchant.
        </p>

        <div class="box">
          <div class="familyHead">
            <h3 style="margin:0">Banque de mesures (à placer)</h3>
            <div class="tag">chute de hauteur</div>
          </div>
          <div class="bank" id="bankMeasures"></div>
        </div>

        <div class="fourCol" style="margin-top:12px">
          <div class="box">
            <div class="familyHead">
              <h3>Élimination / réduction</h3>
              <div class="tag">agir à la source</div>
            </div>
            <div class="drop" data-zone="elim"><span class="hint">Dépose ici</span></div>
          </div>
          <div class="box">
            <div class="familyHead">
              <h3>Protection collective</h3>
              <div class="tag">pour tous</div>
            </div>
            <div class="drop" data-zone="pc"><span class="hint">Dépose ici</span></div>
          </div>
          <div class="box">
            <div class="familyHead">
              <h3>Protection individuelle</h3>
              <div class="tag">EPI</div>
            </div>
            <div class="drop" data-zone="epi"><span class="hint">Dépose ici</span></div>
          </div>
          <div class="box">
            <div class="familyHead">
              <h3>Complémentaires</h3>
              <div class="tag">formation/consignes</div>
            </div>
            <div class="drop" data-zone="comp"><span class="hint">Dépose ici</span></div>
          </div>
        </div>

        <div class="actions">
          <button type="button" data-check="exo1">Corriger</button>
          <button type="button" class="btn2" data-reset="exo1">Réinitialiser</button>
          <div class="scorebig">Score ex. 1 : <b id="s1">0</b>/10</div>
        </div>
        <div class="result" id="r1">Résultat : en attente de correction.</div>
      </div>
    </section>

    <!-- EXO 2 -->
    <section class="card" id="exo2">
      <div class="card-h">
        <div class="left">
          <div class="pill">Exercice 2</div>
          <div class="pill"><strong>Choisir les bonnes mesures</strong></div>
          <div class="pill"><strong>6</strong> pts • C4</div>
        </div>
        <div class="pill">QCM + justification</div>
      </div>
      <div class="card-b">
        <p class="note">
          Situation : intervention sur une toiture (4 m). Il faut installer une protection <b>prioritaire</b>.
          Coche les 2 meilleures réponses.
        </p>

        <div class="box">
          <h3>QCM (2 réponses)</h3>
          <div class="qcm" id="qcm2">
            <label class="opt"><input type="checkbox" value="gc"/>Installer une protection collective : garde-corps / plate-forme de travail sécurisée</label>
            <label class="opt"><input type="checkbox" value="harnais"/>Mettre un harnais antichute avec longe + point d’ancrage</label>
            <label class="opt"><input type="checkbox" value="echelle"/>Utiliser une échelle comme poste de travail (plus rapide)</label>
            <label class="opt"><input type="checkbox" value="sans"/>Faire attention, ça suffit</label>
            <label class="opt"><input type="checkbox" value="formation"/>Former le personnel au travail en hauteur (consignes, utilisation EPI)</label>
          </div>

          <div style="margin-top:10px">
            <h3>Justifie (2 phrases max)</h3>
            <textarea id="justif2" placeholder="Explique pourquoi ces choix réduisent le risque…"></textarea>
            <div class="mini">
              Indices possibles : priorité à la protection collective, chute = conséquences graves, EPI = complément si besoin.
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="button" data-check="exo2">Corriger</button>
          <button type="button" class="btn2" data-reset="exo2">Réinitialiser</button>
          <div class="scorebig">Score ex. 2 : <b id="s2">0</b>/6</div>
        </div>
        <div class="result" id="r2">Résultat : en attente de correction.</div>
      </div>
    </section>

    <!-- EXO 3 -->
    <section class="card" id="exo3">
      <div class="card-h">
        <div class="left">
          <div class="pill">Exercice 3</div>
          <div class="pill"><strong>Proposer un plan d’action</strong></div>
          <div class="pill"><strong>4</strong> pts • C4</div>
        </div>
        <div class="pill">Réponse guidée</div>
      </div>
      <div class="card-b">
        <p class="note">
          Situation : un chef veut faire travailler un salarié en hauteur sur une échelle (poste de travail), sans garde-corps, car c’est plus rapide.
          Propose des mesures réalistes (au moins 4 au total) en respectant la hiérarchie.
        </p>

        <div class="grid cols2">
          <div class="box">
            <h3>Ta proposition</h3>
            <p class="scenario">Écris des mesures sous forme de liste. Exemple : Installer… Prévoir… Former…</p>
            <textarea id="plan3" placeholder="Élimination / réduction : ...&#10;Protection collective : ...&#10;EPI : ...&#10;Complémentaires : ..."></textarea>
          </div>
          <div class="box">
            <h3>Attendus (repères)</h3>
            <p class="scenario">
              Élimination / réduction : préparer au sol, préfabrication, limiter le travail en hauteur.<br/>
              Protection collective : garde-corps (1,00 à 1,10 m + plinthe + lisse), plate-forme/nacelle sécurisée, accès sécurisé.<br/>
              EPI : chaussures antidérapantes, harnais + longe + point d’ancrage (si nécessaire).<br/>
              Complémentaires : formation au travail en hauteur, consignes, contrôle du matériel.
            </p>
            <div class="mini">
              Bonus culture : certains équipements nécessitent une autorisation/formation (ex : échafaudage R408/R457, PEMP CACES R386).
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="button" data-check="exo3">Corriger</button>
          <button type="button" class="btn2" data-reset="exo3">Réinitialiser</button>
          <div class="scorebig">Score ex. 3 : <b id="s3">0</b>/4</div>
        </div>
        <div class="result" id="r3">Résultat : en attente de correction.</div>
      </div>
    </section>

    <div class="footer">
      Rappel : la meilleure prévention commence <b>à la source</b>, puis protège <b>collectivement</b>, puis complète avec les <b>EPI</b> et la <b>formation</b>.
    </div>
  </div>

<script>
(function(){
  const TOTAL_MAX = 20;
  document.getElementById('totalMax').textContent = String(TOTAL_MAX);

  const state = {
    done: { exo1:false, exo2:false, exo3:false },
    scores: { exo1:0, exo2:0, exo3:0 }
  };
  const totalScoreEl = document.getElementById('totalScore');
  const doneCountEl = document.getElementById('doneCount');

  function sumScores(){
    const t = state.scores.exo1 + state.scores.exo2 + state.scores.exo3;
    totalScoreEl.textContent = String(t);
    doneCountEl.textContent = String(Object.values(state.done).filter(Boolean).length);
  }

  // ----- Chips sorting (Exo1) -----
  const bank = document.getElementById('bankMeasures');
  let selectedChipId = null;

  const measures = [
    { id:"m1",  text:"Faire le maximum d’assemblage/préparation au sol", zone:"elim", hint:"réduction" },
    { id:"m2",  text:"Faire préfabrquer des éléments en atelier", zone:"elim", hint:"source" },
    { id:"m3",  text:"Concevoir/choisir des installations entretenables depuis le sol", zone:"elim", hint:"source" },

    { id:"m4",  text:"Installer une plate-forme/nacelle avec protection périphérique", zone:"pc", hint:"collectif" },
    { id:"m5",  text:"Mettre en place des garde-corps (1,00–1,10 m + plinthe)", zone:"pc", hint:"collectif" },
    { id:"m6",  text:"Balisage + sécurisation des trémies/ouvertures", zone:"pc", hint:"collectif" },

    { id:"m7",  text:"Porter chaussures de sécurité antidérapantes", zone:"epi", hint:"EPI" },
    { id:"m8",  text:"Système d’arrêt de chute : harnais + longe + ancrage", zone:"epi", hint:"EPI" },

    { id:"m9",  text:"Former au travail en hauteur (poste, gestes, risques)", zone:"comp", hint:"formation" },
    { id:"m10", text:"Former au choix et à l’utilisation correcte des EPI", zone:"comp", hint:"formation" },
  ];

  function esc(s){return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}

  function clearSelection(){
    selectedChipId = null;
    document.querySelectorAll('.chip.selected').forEach(c=>c.classList.remove('selected'));
  }

  function ensureHints(){
    document.querySelectorAll('#exo1 .drop').forEach(drop=>{
      if(drop.querySelectorAll('.chip').length===0){
        if(!drop.querySelector('.hint')){
          const h=document.createElement('span');
          h.className="hint";
          h.textContent="Dépose ici";
          drop.appendChild(h);
        }
      } else {
        drop.querySelectorAll('.hint').forEach(h=>h.remove());
      }
    });
  }

  function getChipById(id){
    return document.querySelector(`.chip[data-chip-id="${CSS.escape(id)}"]`);
  }

  function moveToBank(chipEl){
    const parentDrop = chipEl.closest('.drop');
    if(parentDrop) parentDrop.querySelectorAll('.hint').forEach(h=>h.remove());
    chipEl.classList.remove('selected');
    bank.appendChild(chipEl);
    ensureHints();
  }

  function placeSelected(drop){
    if(!selectedChipId) return;
    const chipEl = getChipById(selectedChipId);
    if(!chipEl) return;
    drop.querySelectorAll('.hint').forEach(h=>h.remove());
    chipEl.classList.remove('selected');
    drop.appendChild(chipEl);
    selectedChipId = null;
    ensureHints();
  }

  function makeChip(m){
    const el=document.createElement('div');
    el.className="chip";
    el.setAttribute('draggable','true');
    el.dataset.chipId=m.id;
    el.dataset.correctZone=m.zone;
    el.innerHTML = `<span>${esc(m.text)}</span><small>${esc(m.hint)}</small>`;

    el.addEventListener('click', ()=>{
      const inDrop = el.closest('.drop');
      if(inDrop){ moveToBank(el); clearSelection(); return; }
      if(selectedChipId===m.id){ clearSelection(); return; }
      clearSelection();
      selectedChipId=m.id;
      el.classList.add('selected');
    }, {passive:true});

    el.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', m.id);
      try{ ev.dataTransfer.effectAllowed="move"; }catch(_){}
      selectedChipId=m.id;
      el.classList.add('selected');
    });

    return el;
  }

  function initSort(){
    bank.innerHTML="";
    measures.forEach(m=>bank.appendChild(makeChip(m)));
    ensureHints();

    document.querySelectorAll('#exo1 .drop').forEach(drop=>{
      drop.addEventListener('click', (e)=>{
        if(e.target.classList.contains('drop') || e.target.classList.contains('hint')){
          placeSelected(drop);
        }
      });

      drop.addEventListener('dragover', (ev)=>{
        ev.preventDefault();
        drop.classList.add('dragover');
      });
      drop.addEventListener('dragleave', ()=>drop.classList.remove('dragover'));
      drop.addEventListener('drop', (ev)=>{
        ev.preventDefault();
        drop.classList.remove('dragover');
        const id = ev.dataTransfer.getData('text/plain');
        if(!id) return;
        const chipEl = getChipById(id);
        if(!chipEl) return;
        drop.querySelectorAll('.hint').forEach(h=>h.remove());
        chipEl.classList.remove('selected');
        drop.appendChild(chipEl);
        clearSelection();
        ensureHints();
      });
    });

    document.addEventListener('click', (e)=>{
      if(!e.target.closest('#exo1 .chip')) clearSelection();
    }, {passive:true});
  }

  const expected = {
    elim: new Set(["m1","m2","m3"]),
    pc:   new Set(["m4","m5","m6"]),
    epi:  new Set(["m7","m8"]),
    comp: new Set(["m9","m10"]),
  };

  function scoreExo1(){
    const total = 10;
    let pts = 0;
    const each = total / 10; // 10 measures

    Object.keys(expected).forEach(zone=>{
      const drop = document.querySelector(`#exo1 .drop[data-zone="${zone}"]`);
      const placed = Array.from(drop.querySelectorAll('.chip')).map(c=>c.dataset.chipId);
      placed.forEach(id=>{
        if(expected[zone].has(id)) pts += each;
      });
    });

    pts = Math.round(pts * 10) / 10;
    document.getElementById('s1').textContent = String(pts);

    const r = document.getElementById('r1');
    const placedCount = document.querySelectorAll('#exo1 .drop .chip').length;
    let msg = `Score : ${pts}/${total}. `;
    if(placedCount < 10) msg += `Il manque ${10 - placedCount} mesure(s) à placer.\n`;
    msg += `Rappel : on privilégie Élimination/Réduction puis Protection collective, puis EPI, puis Formation/Consignes.`;

    r.className = "result " + (pts>=8 ? "ok" : (pts>=4 ? "" : "bad"));
    r.textContent = msg;

    state.scores.exo1 = pts;
    state.done.exo1 = true;
    sumScores();
  }

  function resetExo1(){
    document.querySelectorAll('#exo1 .drop .chip').forEach(ch=>bank.appendChild(ch));
    clearSelection();
    ensureHints();
    document.getElementById('s1').textContent = "0";
    const r = document.getElementById('r1');
    r.className = "result";
    r.textContent = "Résultat : en attente de correction.";
    state.scores.exo1 = 0;
    state.done.exo1 = false;
    sumScores();
  }

  // ----- Exo2 QCM -----
  function getCheckedValues(){
    return Array.from(document.querySelectorAll('#qcm2 input[type="checkbox"]:checked')).map(i=>i.value).sort();
  }

  function scoreExo2(){
    const total = 6;
    let pts = 0;

    const checked = getCheckedValues();
    // expected: protection collective + formation OR collective + harnais (acceptable) but penalize if ladder/sans
    const badChosen = checked.includes("echelle") || checked.includes("sans");
    if(badChosen){
      pts = 0;
    } else {
      const hasGC = checked.includes("gc");
      const hasFormation = checked.includes("formation");
      const hasHarnais = checked.includes("harnais");

      // 2 best: gc + formation (top), gc + harnais (ok)
      if(checked.length === 2){
        if(hasGC && hasFormation) pts = 4;
        else if(hasGC && hasHarnais) pts = 3.5;
        else if(hasGC) pts = 2.5;
        else pts = 1.5;
      } else if(checked.length === 1){
        pts = hasGC ? 2 : (hasFormation ? 1.5 : (hasHarnais ? 1.5 : 0));
      } else {
        // more than 2 choices -> reduce
        if(hasGC) pts += 2;
        if(hasFormation) pts += 1;
        if(hasHarnais) pts += 1;
        pts = Math.min(pts, 3.5);
      }

      // justification: simple keyword check
      const txt = (document.getElementById('justif2').value || "").toLowerCase();
      const hasKey1 = txt.includes("collective") || txt.includes("garde") || txt.includes("plate") || txt.includes("garde-corps");
      const hasKey2 = txt.includes("prior") || txt.includes("d'abord") || txt.includes("hiérarch") || txt.includes("source");
      const hasKey3 = txt.includes("grave") || txt.includes("décès") || txt.includes("fracture") || txt.includes("traum");
      if(txt.trim().length >= 15){
        if(hasKey1) pts += 1;
        if(hasKey2 || hasKey3) pts += 1;
      }

      pts = Math.min(total, Math.round(pts*10)/10);
    }

    document.getElementById('s2').textContent = String(pts);

    const r = document.getElementById('r2');
    let msg = `Score : ${pts}/${total}.\n`;
    msg += `Attendu : priorité à la protection collective (garde-corps/plate-forme), puis compléter si besoin (harnais), et renforcer par la formation/consignes.\n`;
    msg += `À éviter : échelle comme poste de travail, ou "faire attention" sans mesure.`

    r.className = "result " + (pts>=5 ? "ok" : (pts>=3 ? "" : "bad"));
    r.textContent = msg;

    state.scores.exo2 = pts;
    state.done.exo2 = true;
    sumScores();
  }

  function resetExo2(){
    document.querySelectorAll('#qcm2 input[type="checkbox"]').forEach(i=>i.checked=false);
    document.getElementById('justif2').value = "";
    document.getElementById('s2').textContent = "0";
    const r = document.getElementById('r2');
    r.className = "result";
    r.textContent = "Résultat : en attente de correction.";
    state.scores.exo2 = 0;
    state.done.exo2 = false;
    sumScores();
  }

  // ----- Exo3 plan -----
  function scoreExo3(){
    const total = 4;
    let pts = 0;
    const txt = (document.getElementById('plan3').value || "").toLowerCase();

    const hasElim = txt.includes("prépar") || txt.includes("au sol") || txt.includes("préfabr") || txt.includes("limiter");
    const hasPC = txt.includes("garde") || txt.includes("plate") || txt.includes("nacelle") || txt.includes("balis");
    const hasEPI = txt.includes("harnais") || txt.includes("longe") || txt.includes("chauss");
    const hasComp = txt.includes("formation") || txt.includes("consigne") || txt.includes("informer") || txt.includes("contrôle");

    if(hasElim) pts += 1;
    if(hasPC) pts += 1.5; // priorité
    if(hasEPI) pts += 0.5;
    if(hasComp) pts += 1;

    pts = Math.min(total, Math.round(pts*10)/10);
    document.getElementById('s3').textContent = String(pts);

    const r = document.getElementById('r3');
    let msg = `Score : ${pts}/${total}.\n`;
    msg += `Critères : au moins 1 mesure à la source, 1 protection collective (prioritaire), 1 EPI si nécessaire, 1 formation/consigne.\n`;
    msg += `Exemples : préparer au sol, installer garde-corps, sécuriser trémies, harnais + ancrage, formation au travail en hauteur.`

    r.className = "result " + (pts>=3.5 ? "ok" : (pts>=2 ? "" : "bad"));
    r.textContent = msg;

    state.scores.exo3 = pts;
    state.done.exo3 = true;
    sumScores();
  }

  function resetExo3(){
    document.getElementById('plan3').value = "";
    document.getElementById('s3').textContent = "0";
    const r = document.getElementById('r3');
    r.className = "result";
    r.textContent = "Résultat : en attente de correction.";
    state.scores.exo3 = 0;
    state.done.exo3 = false;
    sumScores();
  }

  function wire(){
    document.querySelectorAll('[data-check]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const exo = btn.getAttribute('data-check');
        if(exo==="exo1") scoreExo1();
        if(exo==="exo2") scoreExo2();
        if(exo==="exo3") scoreExo3();
      });
    });
    document.querySelectorAll('[data-reset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const exo = btn.getAttribute('data-reset');
        if(exo==="exo1") resetExo1();
        if(exo==="exo2") resetExo2();
        if(exo==="exo3") resetExo3();
      });
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    initSort();
    wire();
    sumScores();
  });
})();
</script>
</body>
</html>
