<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>RPS ‚Äî Facteurs et Analyse (Terminale Bac Pro ¬∑ Module C9)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-dark:#1d4ed8;
      --text:#111827;
      --muted:#6b7280;
      --good:#16a34a;
      --bad:#dc2626;
      --warn:#ca8a04;
      --radius:18px;
      --shadow:0 14px 35px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(circle at top,#e0f2fe,#eef2ff 40%,#f3f4f6 75%);
      color:var(--text);
    }
    .page{
      max-width:980px;
      margin:0 auto;
      padding:20px 14px 40px;
    }
    header{
      background:var(--card);
      border-radius:24px;
      padding:18px 18px 16px;
      box-shadow:var(--shadow);
      margin-bottom:18px;
    }
    h1{
      margin:0 0 6px;
      font-size:1.3rem;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
    }
    h1 span.badge{
      font-size:.78rem;
      background:var(--accent-soft);
      color:var(--accent-dark);
      padding:2px 10px;
      border-radius:999px;
      font-weight:700;
    }
    .objectif{
      font-size:.9rem;
      color:var(--muted);
      line-height:1.5;
      margin-top:6px;
    }
    .objectif strong{color:#1f2937;}
    .tagline{
      margin-top:6px;
      font-size:.8rem;
      color:#4b5563;
      font-weight:600;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px 14px 14px;
      margin-top:14px;
      box-shadow:0 8px 22px rgba(15,23,42,.08);
    }
    .card h2{
      margin:0 0 10px;
      font-size:1rem;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:5px;
      border-radius:999px;
      padding:3px 10px;
      font-size:.75rem;
      font-weight:700;
      border:1px solid rgba(148,163,184,.5);
      background:#f9fafb;
      color:#334155;
      margin-right:6px;
      margin-bottom:4px;
    }
    .chip span{
      font-size:.7rem;
      opacity:.9;
    }
    label{
      display:block;
      font-size:.85rem;
      margin-bottom:4px;
      font-weight:600;
      color:#374151;
    }
    input[type="text"], select, textarea{
      width:100%;
      border-radius:10px;
      border:1px solid #d1d5db;
      padding:8px 10px;
      font-size:.9rem;
      font-family:inherit;
      resize:vertical;
      min-height:40px;
    }
    textarea{min-height:90px;}
    .field-row{
      margin-bottom:10px;
    }
    .help{
      font-size:.78rem;
      color:var(--muted);
      margin-top:4px;
    }
    .error{
      font-size:.8rem;
      color:var(--bad);
      margin-top:4px;
    }
    .exo-header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      margin-bottom:6px;
    }
    .exo-title{
      font-size:.95rem;
      font-weight:700;
    }
    .exo-sub{
      font-size:.8rem;
      color:var(--muted);
    }
    .q-row{
      margin-top:8px;
      padding:7px 8px 9px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .q-label{
      display:flex;
      align-items:flex-start;
      gap:6px;
      font-size:.88rem;
      margin-bottom:4px;
    }
    .q-num{
      width:22px;
      height:22px;
      border-radius:999px;
      background:var(--accent-soft);
      color:var(--accent-dark);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.8rem;
      font-weight:800;
      flex-shrink:0;
    }
    .feedback{
      font-size:.8rem;
      margin-top:4px;
    }
    .good{color:var(--good);}
    .bad{color:var(--bad);}
    .neutral{color:var(--muted);}
    .btn-primary{
      margin-top:20px;
      width:100%;
      border-radius:999px;
      border:none;
      padding:11px 16px;
      font-size:1rem;
      font-weight:700;
      background:var(--accent);
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow:0 12px 28px rgba(37,99,235,.35);
      transition:transform .08s ease, box-shadow .08s ease, background .08s ease;
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 34px rgba(37,99,235,.45);
      background:var(--accent-dark);
    }
    .btn-primary:active{
      transform:translateY(0);
      box-shadow:0 10px 24px rgba(37,99,235,.3);
    }
    .result-card{
      margin-top:18px;
      padding:14px 14px 12px;
      border-radius:18px;
      background:#ecfdf5;
      border:1px solid #bbf7d0;
      display:none;
    }
    .result-line{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.92rem;
      margin-bottom:6px;
    }
    .result-score{
      font-size:1.1rem;
      font-weight:800;
    }
    .badge-score{
      padding:2px 8px;
      border-radius:999px;
      font-size:.78rem;
      font-weight:700;
    }
    .score-good{background:#bbf7d0;color:#166534;}
    .score-mid{background:#fef3c7;color:#92400e;}
    .score-bad{background:#fee2e2;color:#b91c1c;}
    .result-note{
      font-size:.8rem;
      color:#047857;
    }
    .remediation{
      margin-top:8px;
      font-size:.82rem;
      color:#065f46;
    }
    .remediation ul{
      padding-left:18px;
      margin:4px 0 0;
    }
    .footer-msg{
      margin-top:10px;
      font-size:.8rem;
      text-align:center;
      color:#6b7280;
    }
    .footer-msg span{
      color:#059669;
      font-weight:700;
    }
    @media (max-width:640px){
      header{border-radius:20px;padding:14px 14px 12px;}
      .card{border-radius:16px;padding:12px 10px 10px;}
      .q-row{padding:7px 7px 8px;}
      .btn-primary{margin-top:14px;}
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>üß† RPS ‚Äî Facteurs et Analyse (Terminale Bac Pro) <span class="badge">Module C9</span></h1>
      <div class="objectif">
        Objectif&nbsp;: comprendre et analyser les risques psychosociaux (RPS) √† partir de situations professionnelles.
        Savoir relier une situation aux principaux types de RPS (stress, violences internes, violences externes),
        aux six cat√©gories de facteurs, et aux cons√©quences pour la sant√© du salari√© et l‚Äôentreprise.
      </div>
      <div class="tagline">Comp√©tences travaill√©es&nbsp;: C2, C3, C5, C6 (et amorce C4 en r√©flexion finale).</div>
    </header>

    <section class="card" id="bloc-identite">
      <h2>ü™™ Identification √©l√®ve</h2>
      <div class="field-row">
        <label for="identifiant">Identifiant √©l√®ve</label>
        <input type="text" id="identifiant" autocomplete="off" placeholder="Ex. A12 0312 (initiales + date de naissance)">
      </div>
      <div class="field-row">
        <label for="classe">Classe</label>
        <select id="classe">
          <option value="">-- Choisir --</option>
          <option>2BACPRO_GATL1</option>
          <option>2BACPRO_GATL2</option>
          <option>1BACPRO_AGO1</option>
          <option>1BACPRO_AGO2</option>
          <option>TBACPRO_AGO1</option>
          <option>TBACPRO_AGO2</option>
          <option>2_MELEC</option>
          <option>1_MELEC</option>
          <option>T_MELEC</option>
          <option>CAP_PSR1</option>
          <option>CAP_PSR2</option>
          <option>CAP_VAN1</option>
          <option>CAP_VAN2</option>
          <option>CAP_CAN1</option>
          <option>CAP_CAN2</option>
          <option>CAP_HORT1</option>
          <option>CAP_HORT2</option>
          <option>CAP_JP1</option>
          <option>CAP_JP2</option>
          <option>Autre</option>
        </select>
        <div class="error" id="id-error" style="display:none;"></div>
      </div>
      <div class="help">Ces informations servent uniquement au professeur pour suivre les entra√Ænements et les scores.</div>
    </section>

    <!-- Exercice 1 -->
    <section class="card">
      <div class="exo-header">
        <div class="exo-title">Exercice 1 ‚Äî Identifier le type de RPS <span class="exo-sub">(C2)</span></div>
        <div>
          <span class="chip">Type vis√©&nbsp;: <span>C2 ‚Äì Appliquer une d√©marche d‚Äôanalyse</span></span>
        </div>
      </div>
      <div class="exo-sub">Pour chaque situation, choisir le type de RPS principal.</div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">1</div>
          <div>Mon chef me d√©valorise r√©guli√®rement, critique mon travail devant les coll√®gues et me met sous pression.</div>
        </div>
        <select id="q1">
          <option value="">Choisir‚Ä¶</option>
          <option value="stress">Stress</option>
          <option value="vi_int">Violences internes</option>
          <option value="vi_ext">Violences externes</option>
        </select>
        <div class="feedback neutral" id="fb1"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">2</div>
          <div>Des clients m‚Äôinsultent et me menacent car ils ne sont pas satisfaits du service rendu.</div>
        </div>
        <select id="q2">
          <option value="">Choisir‚Ä¶</option>
          <option value="stress">Stress</option>
          <option value="vi_int">Violences internes</option>
          <option value="vi_ext">Violences externes</option>
        </select>
        <div class="feedback neutral" id="fb2"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">3</div>
          <div>Je dois g√©rer une pile de dossiers urgents en m√™me temps, avec des d√©lais tr√®s courts.</div>
        </div>
        <select id="q3">
          <option value="">Choisir‚Ä¶</option>
          <option value="stress">Stress</option>
          <option value="vi_int">Violences internes</option>
          <option value="vi_ext">Violences externes</option>
        </select>
        <div class="feedback neutral" id="fb3"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">4</div>
          <div>Un coll√®gue me harc√®le par des remarques humiliantes r√©p√©t√©es et des messages d√©plac√©s.</div>
        </div>
        <select id="q4">
          <option value="">Choisir‚Ä¶</option>
          <option value="stress">Stress</option>
          <option value="vi_int">Violences internes</option>
          <option value="vi_ext">Violences externes</option>
        </select>
        <div class="feedback neutral" id="fb4"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">5</div>
          <div>√Ä la fin de ma tourn√©e, un usager m‚Äôattend √† la sortie de l‚Äôentreprise pour m‚Äôinsulter et me menacer.</div>
        </div>
        <select id="q5">
          <option value="">Choisir‚Ä¶</option>
          <option value="stress">Stress</option>
          <option value="vi_int">Violences internes</option>
          <option value="vi_ext">Violences externes</option>
        </select>
        <div class="feedback neutral" id="fb5"></div>
      </div>
    </section>

    <!-- Exercice 2 -->
    <section class="card">
      <div class="exo-header">
        <div class="exo-title">Exercice 2 ‚Äî Associer au facteur de RPS <span class="exo-sub">(C3)</span></div>
        <div>
          <span class="chip">Type vis√©&nbsp;: <span>C3 ‚Äì Expliquer un enjeu de sant√© au travail</span></span>
        </div>
      </div>
      <div class="exo-sub">Pour chaque situation, choisir la cat√©gorie de facteur principale.</div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">6</div>
          <div>Peur de perdre son emploi, avenir incertain.</div>
        </div>
        <select id="q6">
          <option value="">Choisir‚Ä¶</option>
          <option value="intensite">Intensit√© et temps de travail</option>
          <option value="exigences">Exigences √©motionnelles</option>
          <option value="autonomie">Manque d‚Äôautonomie</option>
          <option value="rapports">Rapports sociaux d√©grad√©s</option>
          <option value="valeurs">Conflits de valeurs</option>
          <option value="insecurite">Ins√©curit√© de la situation de travail</option>
        </select>
        <div class="feedback neutral" id="fb6"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">7</div>
          <div>Travail impos√© sans possibilit√© de d√©cider de son organisation.</div>
        </div>
        <select id="q7">
          <option value="">Choisir‚Ä¶</option>
          <option value="intensite">Intensit√© et temps de travail</option>
          <option value="exigences">Exigences √©motionnelles</option>
          <option value="autonomie">Manque d‚Äôautonomie</option>
          <option value="rapports">Rapports sociaux d√©grad√©s</option>
          <option value="valeurs">Conflits de valeurs</option>
          <option value="insecurite">Ins√©curit√© de la situation de travail</option>
        </select>
        <div class="feedback neutral" id="fb7"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">8</div>
          <div>Objectifs irr√©alistes, surcharge de travail et horaires impr√©visibles.</div>
        </div>
        <select id="q8">
          <option value="">Choisir‚Ä¶</option>
          <option value="intensite">Intensit√© et temps de travail</option>
          <option value="exigences">Exigences √©motionnelles</option>
          <option value="autonomie">Manque d‚Äôautonomie</option>
          <option value="rapports">Rapports sociaux d√©grad√©s</option>
          <option value="valeurs">Conflits de valeurs</option>
          <option value="insecurite">Ins√©curit√© de la situation de travail</option>
        </select>
        <div class="feedback neutral" id="fb8"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">9</div>
          <div>Tensions avec le public, contact fr√©quent avec la souffrance ou la d√©tresse.</div>
        </div>
        <select id="q9">
          <option value="">Choisir‚Ä¶</option>
          <option value="intensite">Intensit√© et temps de travail</option>
          <option value="exigences">Exigences √©motionnelles</option>
          <option value="autonomie">Manque d‚Äôautonomie</option>
          <option value="rapports">Rapports sociaux d√©grad√©s</option>
          <option value="valeurs">Conflits de valeurs</option>
          <option value="insecurite">Ins√©curit√© de la situation de travail</option>
        </select>
        <div class="feedback neutral" id="fb9"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">10</div>
          <div>Relations conflictuelles avec la hi√©rarchie, manque de reconnaissance.</div>
        </div>
        <select id="q10">
          <option value="">Choisir‚Ä¶</option>
          <option value="intensite">Intensit√© et temps de travail</option>
          <option value="exigences">Exigences √©motionnelles</option>
          <option value="autonomie">Manque d‚Äôautonomie</option>
          <option value="rapports">Rapports sociaux d√©grad√©s</option>
          <option value="valeurs">Conflits de valeurs</option>
          <option value="insecurite">Ins√©curit√© de la situation de travail</option>
        </select>
        <div class="feedback neutral" id="fb10"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">11</div>
          <div>Ne plus se reconna√Ætre dans le travail demand√©, impression de faire un travail contraire √† ses valeurs.</div>
        </div>
        <select id="q11">
          <option value="">Choisir‚Ä¶</option>
          <option value="intensite">Intensit√© et temps de travail</option>
          <option value="exigences">Exigences √©motionnelles</option>
          <option value="autonomie">Manque d‚Äôautonomie</option>
          <option value="rapports">Rapports sociaux d√©grad√©s</option>
          <option value="valeurs">Conflits de valeurs</option>
          <option value="insecurite">Ins√©curit√© de la situation de travail</option>
        </select>
        <div class="feedback neutral" id="fb11"></div>
      </div>
    </section>

    <!-- Exercice 3 -->
    <section class="card">
      <div class="exo-header">
        <div class="exo-title">Exercice 3 ‚Äî Vrai / Faux sur les RPS <span class="exo-sub">(C1 ‚Äì C3)</span></div>
        <div>
          <span class="chip">Type vis√©&nbsp;: <span>C1 ‚Äì Traiter une information</span></span>
          <span class="chip">+ <span>C3 ‚Äì Expliquer un enjeu</span></span>
        </div>
      </div>
      <div class="exo-sub">Cocher la bonne r√©ponse pour chaque affirmation.</div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">12</div>
          <div>Les RPS peuvent √™tre li√©s √† l‚Äôorganisation du travail et aux relations entre coll√®gues.</div>
        </div>
        <select id="q12">
          <option value="">Choisir‚Ä¶</option>
          <option value="vrai">Vrai</option>
          <option value="faux">Faux</option>
        </select>
        <div class="feedback neutral" id="fb12"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">13</div>
          <div>Seuls les m√©tiers physiques (manutention, BTP) sont concern√©s par les risques psychosociaux.</div>
        </div>
        <select id="q13">
          <option value="">Choisir‚Ä¶</option>
          <option value="vrai">Vrai</option>
          <option value="faux">Faux</option>
        </select>
        <div class="feedback neutral" id="fb13"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">14</div>
          <div>Les RPS peuvent avoir des cons√©quences sur la sant√© mentale (anxi√©t√©, d√©pression, burn-out).</div>
        </div>
        <select id="q14">
          <option value="">Choisir‚Ä¶</option>
          <option value="vrai">Vrai</option>
          <option value="faux">Faux</option>
        </select>
        <div class="feedback neutral" id="fb14"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">15</div>
          <div>Les RPS n‚Äôont pas d‚Äôimpact sur le fonctionnement de l‚Äôentreprise.</div>
        </div>
        <select id="q15">
          <option value="">Choisir‚Ä¶</option>
          <option value="vrai">Vrai</option>
          <option value="faux">Faux</option>
        </select>
        <div class="feedback neutral" id="fb15"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">16</div>
          <div>Un m√™me salari√© peut √™tre expos√© √† plusieurs facteurs de RPS en m√™me temps.</div>
        </div>
        <select id="q16">
          <option value="">Choisir‚Ä¶</option>
          <option value="vrai">Vrai</option>
          <option value="faux">Faux</option>
        </select>
        <div class="feedback neutral" id="fb16"></div>
      </div>
    </section>

    <!-- Exercice 4 -->
    <section class="card">
      <div class="exo-header">
        <div class="exo-title">Exercice 4 ‚Äî Ce qui est touch√© par les RPS <span class="exo-sub">(C2 ‚Äì C3)</span></div>
        <div>
          <span class="chip">Analyse&nbsp;: <span>sant√© / entreprise</span></span>
        </div>
      </div>
      <div class="exo-sub">Pour chaque situation, indiquer ce qui est le plus touch√©.</div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">17</div>
          <div>Apr√®s plusieurs mois de surcharge et de conflits, une salari√©e est en arr√™t de travail pour d√©pression.</div>
        </div>
        <select id="q17">
          <option value="">Choisir‚Ä¶</option>
          <option value="sante">La sant√© du salari√©</option>
          <option value="entreprise">Le fonctionnement de l‚Äôentreprise</option>
          <option value="les_deux">Les deux</option>
        </select>
        <div class="feedback neutral" id="fb17"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">18</div>
          <div>Dans l‚Äôentreprise, les conflits se multiplient, le turnover augmente et les clients se plaignent davantage.</div>
        </div>
        <select id="q18">
          <option value="">Choisir‚Ä¶</option>
          <option value="sante">La sant√© du salari√©</option>
          <option value="entreprise">Le fonctionnement de l‚Äôentreprise</option>
          <option value="les_deux">Les deux</option>
        </select>
        <div class="feedback neutral" id="fb18"></div>
      </div>
    </section>

    <!-- Exercice 5 -->
    <section class="card">
      <div class="exo-header">
        <div class="exo-title">Exercice 5 ‚Äî Analyse √©crite des cons√©quences <span class="exo-sub">(C5 ‚Äì C6)</span></div>
        <div>
          <span class="chip">C5 ‚Äì Argumenter un choix</span>
          <span class="chip">C6 ‚Äì Communication √©crite claire</span>
        </div>
      </div>
      <div class="q-row">
        <div class="q-label">
          <div class="q-num">19</div>
          <div>Explique, en quelques lignes, deux cons√©quences possibles des RPS sur la sant√© du salari√©.</div>
        </div>
        <textarea id="q19" placeholder="Exemples possibles : troubles du sommeil, anxi√©t√©, d√©pression, burn-out, etc."></textarea>
        <div class="feedback neutral" id="fb19"></div>
      </div>

      <div class="q-row">
        <div class="q-label">
          <div class="q-num">20</div>
          <div>Explique, en quelques lignes, deux cons√©quences possibles des RPS pour l‚Äôentreprise.</div>
        </div>
        <textarea id="q20" placeholder="Exemples possibles : absent√©isme, accidents, baisse de qualit√©, mauvaise image, etc."></textarea>
        <div class="feedback neutral" id="fb20"></div>
      </div>
      <div class="help">Soigne la formulation : phrases compl√®tes, vocabulaire pr√©cis, orthographe soign√©e.</div>
    </section>

    <button class="btn-primary" id="btn-resultat">
      <span>Voir mon r√©sultat</span>
    </button>

    <section class="result-card" id="resultats">
      <div class="result-line">
        <div>
          Score global&nbsp;: <span class="result-score" id="score-texte">0 / 20</span>
        </div>
        <div id="score-badge" class="badge-score score-mid">Entra√Ænement</div>
      </div>
      <div class="result-note" id="score-commentaire"></div>
      <div class="remediation">
        Pistes de travail propos√©es √† partir de tes r√©ponses&nbsp;:
        <ul id="remediation-list"></ul>
      </div>
    </section>

    <div class="footer-msg">
      R√©sultats enregistr√©s automatiquement pour le professeur <span>‚úì</span> ‚Äî tu peux refaire l‚Äôexercice autant de fois que tu veux.
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.firebasestorage.app",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const copiesCol = collection(db, "bacpro");

    const btn = document.getElementById("btn-resultat");
    const idInput = document.getElementById("identifiant");
    const classeSelect = document.getElementById("classe");
    const idError = document.getElementById("id-error");
    const resultBloc = document.getElementById("resultats");
    const scoreTexte = document.getElementById("score-texte");
    const scoreBadge = document.getElementById("score-badge");
    const scoreCommentaire = document.getElementById("score-commentaire");
    const remediationList = document.getElementById("remediation-list");

    function setFeedback(id, ok, message){
      const el = document.getElementById("fb" + id);
      if(!el) return;
      el.classList.remove("good","bad","neutral");
      if(ok === true){
        el.classList.add("good");
      }else if(ok === false){
        el.classList.add("bad");
      }else{
        el.classList.add("neutral");
      }
      el.textContent = message;
    }

    function analyseTexte(reponse, motsCles){
      const txt = (reponse || "").toLowerCase();
      let count = 0;
      motsCles.forEach(m => {
        if(txt.includes(m)) count++;
      });
      return count;
    }

    async function envoyerDansFirestore(meta, resultat){
      try{
        await addDoc(copiesCol, { meta, resultat });
      }catch(e){
        console.error("Erreur envoi Firestore :", e);
      }
    }

    function commentaireScore(score){
      if(score >= 17) return "Tr√®s bon niveau : tu ma√Ætrises les types de RPS et leurs cons√©quences. Tu es proche des attentes de l‚Äô√©preuve.";
      if(score >= 14) return "Bon r√©sultat : quelques impr√©cisions √† corriger, mais l‚Äôensemble est solide.";
      if(score >= 10) return "R√©sultat moyen : tu as rep√©r√© plusieurs √©l√©ments, mais certains facteurs ou cons√©quences restent confus.";
      return "R√©sultat fragile : reprends la d√©finition des RPS, les six cat√©gories de facteurs et les exemples vus en cours.";
    }

    function majBadge(score){
      scoreBadge.classList.remove("score-good","score-mid","score-bad");
      if(score >= 14){
        scoreBadge.classList.add("score-good");
        scoreBadge.textContent = "Niveau avanc√©";
      }else if(score >= 10){
        scoreBadge.classList.add("score-mid");
        scoreBadge.textContent = "Niveau en progression";
      }else{
        scoreBadge.classList.add("score-bad");
        scoreBadge.textContent = "√Ä renforcer";
      }
    }

    btn.addEventListener("click", async () => {
      const identifiant = (idInput.value || "").trim();
      const classe = (classeSelect.value || "").trim();

      if(!identifiant || !classe){
        idError.style.display = "block";
        idError.textContent = "Merci de saisir ton identifiant et de choisir ta classe avant de voir le r√©sultat.";
        return;
      }else{
        idError.style.display = "none";
      }

      let score = 0;
      remediationList.innerHTML = "";
      const pointsTotal = 20;
      const pistes = new Set();

      // Q1‚Äì5 types de RPS
      const typesCorrects = {
        1:"vi_int",
        2:"vi_ext",
        3:"stress",
        4:"vi_int",
        5:"vi_ext"
      };

      for(let i=1;i<=5;i++){
        const val = (document.getElementById("q"+i).value || "");
        const correct = typesCorrects[i];
        if(!val){
          setFeedback(i, null, "R√©ponse manquante : choisis un type de RPS.");
          pistes.add("Revoir la diff√©rence entre stress, violences internes et violences externes.");
        }else if(val === correct){
          score++;
          let exp = "";
          if(i===1) exp = "Correct : il s‚Äôagit de violences internes, car la pression vient du sup√©rieur dans l‚Äôentreprise.";
          if(i===2) exp = "Correct : c‚Äôest une violence externe, car elle vient d‚Äôun client.";
          if(i===3) exp = "Correct : surcharge de travail + d√©lais courts = situation de stress.";
          if(i===4) exp = "Correct : remarques humiliantes r√©p√©t√©es = violences internes (harc√®lement).";
          if(i===5) exp = "Correct : l‚Äôagression se d√©roule hors de l‚Äôentreprise, par un usager = violence externe.";
          setFeedback(i, true, exp);
        }else{
          let attendu = "";
          if(correct==="stress") attendu = "stress";
          if(correct==="vi_int") attendu = "violences internes";
          if(correct==="vi_ext") attendu = "violences externes";
          let exp = "Incorrect : ici, on parle surtout de " + attendu + ".";
          if(i===1) exp += " C‚Äôest la relation avec le chef (interne √† l‚Äôentreprise) qui pose probl√®me.";
          if(i===2) exp += " Le client appartient √† l‚Äôext√©rieur de l‚Äôentreprise.";
          if(i===3) exp += " La situation d√©crit une surcharge et des d√©lais, pas une agression directe.";
          if(i===4) exp += " Les remarques viennent d‚Äôun coll√®gue ou sup√©rieur, donc interne.";
          if(i===5) exp += " L‚Äôusager n‚Äôest pas un coll√®gue : c‚Äôest une violence externe.";
          setFeedback(i, false, exp);
          pistes.add("Savoir reconna√Ætre √† partir d‚Äôun exemple concret s‚Äôil s‚Äôagit de stress, de violences internes ou externes.");
        }
      }

      // Q6‚Äì11 facteurs
      const facteursCorrects = {
        6:"insecurite",
        7:"autonomie",
        8:"intensite",
        9:"exigences",
        10:"rapports",
        11:"valeurs"
      };
      for(let i=6;i<=11;i++){
        const val = (document.getElementById("q"+i).value || "");
        const correct = facteursCorrects[i];
        if(!val){
          setFeedback(i, null, "R√©ponse manquante : choisis une cat√©gorie de facteur.");
          pistes.add("Revoir les six cat√©gories de facteurs de RPS (intensit√©, exigences √©motionnelles, autonomie, rapports sociaux, valeurs, ins√©curit√©).");
        }else if(val === correct){
          score++;
          let exp = "";
          if(i===6) exp = "Correct : peur de perdre son emploi = ins√©curit√© de la situation de travail.";
          if(i===7) exp = "Correct : impossibilit√© de d√©cider de son travail = manque d‚Äôautonomie.";
          if(i===8) exp = "Correct : surcharge et horaires impr√©visibles = intensit√© et temps de travail.";
          if(i===9) exp = "Correct : tension avec le public et la souffrance = exigences √©motionnelles.";
          if(i===10) exp = "Correct : relations conflictuelles = rapports sociaux d√©grad√©s.";
          if(i===11) exp = "Correct : ne plus se reconna√Ætre dans son travail = conflits de valeurs.";
          setFeedback(i, true, exp);
        }else{
          let attendu = "";
          if(correct==="intensite") attendu = "intensit√© et temps de travail";
          if(correct==="exigences") attendu = "exigences √©motionnelles";
          if(correct==="autonomie") attendu = "manque d‚Äôautonomie";
          if(correct==="rapports") attendu = "rapports sociaux d√©grad√©s";
          if(correct==="valeurs") attendu = "conflits de valeurs";
          if(correct==="insecurite") attendu = "ins√©curit√© de la situation de travail";
          setFeedback(i, false, "Incorrect : la cat√©gorie la plus pertinente ici est ¬´ " + attendu + " ¬ª.");
          pistes.add("√ätre capable de relier une situation professionnelle √† la bonne cat√©gorie de facteur de RPS.");
        }
      }

      // Q12‚Äì16 vrai/faux
      const vfCorrects = {
        12:"vrai",
        13:"faux",
        14:"vrai",
        15:"faux",
        16:"vrai"
      };
      for(let i=12;i<=16;i++){
        const val = (document.getElementById("q"+i).value || "");
        const correct = vfCorrects[i];
        if(!val){
          setFeedback(i, null, "R√©ponse manquante : coche Vrai ou Faux.");
          pistes.add("S√©curiser les connaissances de base sur ce que sont (ou ne sont pas) les RPS.");
        }else if(val === correct){
          score++;
          let exp = "";
          if(i===12) exp = "Correct : les RPS sont li√©s √† l‚Äôorganisation du travail et aux relations.";
          if(i===13) exp = "Correct : tous les m√©tiers peuvent √™tre concern√©s, pas seulement les m√©tiers physiques.";
          if(i===14) exp = "Correct : les RPS touchent fortement la sant√© mentale.";
          if(i===15) exp = "Correct : ils ont aussi un impact sur l‚Äôentreprise (qualit√©, absent√©isme, image‚Ä¶).";
          if(i===16) exp = "Correct : plusieurs facteurs de RPS peuvent s‚Äôaccumuler pour un m√™me salari√©.";
          setFeedback(i, true, exp);
        }else{
          let exp = "";
          if(i===12) exp = "Incorrect : par d√©finition, les RPS sont en lien avec l‚Äôorganisation et les relations au travail.";
          if(i===13) exp = "Incorrect : les RPS peuvent toucher aussi bien un employ√© de bureau qu‚Äôun ouvrier.";
          if(i===14) exp = "Incorrect : la sant√© mentale (anxi√©t√©, burn-out‚Ä¶) est au c≈ìur des RPS.";
          if(i===15) exp = "Incorrect : les RPS d√©gradent aussi la performance de l‚Äôentreprise (absent√©isme, erreurs, conflits).";
          if(i===16) exp = "Incorrect : souvent plusieurs facteurs (intensit√©, conflits, ins√©curit√©‚Ä¶) se cumulent.";
          setFeedback(i, false, exp);
          pistes.add("Bien distinguer les id√©es re√ßues des d√©finitions exactes des RPS.");
        }
      }

      // Q17‚Äì18 impact sant√© / entreprise
      const impactCorrect = { 17:"sante", 18:"les_deux" };
      for(let i=17;i<=18;i++){
        const val = (document.getElementById("q"+i).value || "");
        const correct = impactCorrect[i];
        if(!val){
          setFeedback(i, null, "R√©ponse manquante : choisis l‚Äôimpact principal.");
          pistes.add("Apprendre √† voir les cons√©quences des RPS √† la fois pour la sant√© et pour l‚Äôentreprise.");
        }else if(val === correct){
          score++;
          let exp = "";
          if(i===17) exp = "Correct : l‚Äôarr√™t de travail pour d√©pression touche d‚Äôabord la sant√© du salari√©, m√™me si l‚Äôentreprise est aussi impact√©e.";
          if(i===18) exp = "Correct : turnover, plaintes clients et conflits touchent √† la fois l‚Äôorganisation et, indirectement, la sant√©.";
          setFeedback(i, true, exp);
        }else{
          let exp = "";
          if(i===17) exp = "Incorrect : ici, c‚Äôest d‚Äôabord la sant√© du salari√© qui est atteinte (d√©pression).";
          if(i===18) exp = "Incorrect : cette situation touche √† la fois l‚Äôentreprise (clients, turnover) et la sant√© (conflits, tensions).";
          setFeedback(i, false, exp);
          pistes.add("Rep√©rer si une cons√©quence concerne surtout la sant√©, l‚Äôentreprise, ou les deux.");
        }
      }

      // Q19‚Äì20 textes
      const r19 = document.getElementById("q19").value || "";
      const r20 = document.getElementById("q20").value || "";

      const motsSante = ["fatigue","trouble","sommeil","anxi√©t√©","anxiete","d√©pression","depression","burn-out","burn out","√©puisement","epuisement","maux de t√™te","douleur","hypertension","stress"];
      const motsEntreprise = ["absent√©isme","absenteisme","turnover","rotation","erreur","accident","baisse","productivit√©","qualit√©","image","conflit","retard","co√ªt","cout","proc√®s","litige"];

      const nbSante = analyseTexte(r19, motsSante);
      if(!r19.trim()){
        setFeedback(19, null, "R√©ponse manquante : donne au moins deux exemples concrets (sant√© mentale, physique‚Ä¶).");
        pistes.add("S‚Äôentra√Æner √† formuler clairement les cons√©quences des RPS sur la sant√© du salari√©.");
      }else if(nbSante >= 2){
        score++;
        setFeedback(19, true, "Bon travail : tu cites au moins deux cons√©quences probables sur la sant√© (par exemple troubles du sommeil, anxi√©t√©, d√©pression, burn-out‚Ä¶).");
      }else{
        setFeedback(19, false, "R√©ponse partielle : essaie de citer au moins deux cons√©quences pr√©cises sur la sant√© (troubles du sommeil, anxi√©t√©, d√©pression, burn-out, douleurs physiques‚Ä¶).");
        pistes.add("Varier les exemples de cons√©quences sur la sant√© (physique et mentale).");
      }

      const nbEnt = analyseTexte(r20, motsEntreprise);
      if(!r20.trim()){
        setFeedback(20, null, "R√©ponse manquante : donne au moins deux exemples pour l‚Äôentreprise (qualit√©, accidents, clients‚Ä¶).");
        pistes.add("S‚Äôentra√Æner √† rep√©rer les effets des RPS sur le fonctionnement de l‚Äôentreprise.");
      }else if(nbEnt >= 2){
        score++;
        setFeedback(20, true, "Bon travail : tu identifies au moins deux cons√©quences pour l‚Äôentreprise (absent√©isme, erreurs, baisse de qualit√©, image d√©grad√©e, etc.).");
      }else{
        setFeedback(20, false, "R√©ponse partielle : ajoute d‚Äôautres cons√©quences pour l‚Äôentreprise (absent√©isme, accidents, erreurs, baisse de productivit√©, mauvaise image‚Ä¶).");
        pistes.add("Savoir relier les RPS aux indicateurs de fonctionnement de l‚Äôentreprise (qualit√©, accidents, image‚Ä¶).");
      }

      scoreTexte.textContent = score + " / " + pointsTotal;
      scoreCommentaire.textContent = commentaireScore(score);
      majBadge(score);

      remediationList.innerHTML = "";
      if(pistes.size === 0){
        const li = document.createElement("li");
        li.textContent = "Tu peux maintenant refaire l‚Äôexercice en temps limit√© comme entra√Ænement d‚Äôexamen.";
        remediationList.appendChild(li);
      }else{
        pistes.forEach(p => {
          const li = document.createElement("li");
          li.textContent = p;
          remediationList.appendChild(li);
        });
      }

      resultBloc.style.display = "block";
      resultBloc.scrollIntoView({behavior:"smooth", block:"start"});

      const meta = {
        createdAt: new Date().toISOString(),
        nom: identifiant,
        prenom: identifiant,
        classe: classe,
        type: "exercice",
        support: "RPS_Facteurs_C9_Tle"
      };
      const resultat = {
        score: score + " / " + pointsTotal + " points",
        url: location.href,
        titre: document.title
      };

      await envoyerDansFirestore(meta, resultat);
    });
  </script>
</body>
</html>