<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caf√© Parents - Mobile</title>
    <style>
        /* DESIGN MOBILE APP */
        body { 
            margin: 0; padding: 20px; 
            background: #0f172a; color: white; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        h1 { color: #db2777; margin-bottom: 10px; font-size: 1.8rem; text-align: center; }
        p { color: #cbd5e1; text-align: center; margin-bottom: 30px; }

        /* BADGE ANONYME */
        .badge-anon {
            background: rgba(255, 255, 255, 0.1);
            color: #4ade80; /* Vert rassurant */
            padding: 5px 15px; border-radius: 50px;
            font-size: 0.9rem; font-weight: bold;
            border: 1px solid #4ade80;
            display: inline-flex; align-items: center; gap: 5px;
            margin-bottom: 20px;
        }

        /* INPUTS */
        input[type="text"] {
            width: 100%; max-width: 300px; padding: 15px;
            border-radius: 50px; border: none; outline: none;
            text-align: center; font-size: 1.1rem; margin-bottom: 20px;
            background: #1e293b; color: white; border: 2px solid #334155;
        }
        input[type="text"]:focus { border-color: #db2777; }

        /* BOUTONS */
        .btn {
            background: #db2777; color: white; border: none;
            padding: 15px 30px; border-radius: 50px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            width: 100%; max-width: 300px; transition: 0.2s;
            margin-bottom: 10px; display: block;
        }
        .btn:active { transform: scale(0.95); }

        /* √âCRANS (M√©t√©o, Nuage, etc.) */
        .screen-section { display: none; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .active { display: flex !important; }

        /* GRID M√âT√âO */
        .mood-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 350px; }
        .mood-btn {
            background: #1e293b; border: 2px solid #334155;
            border-radius: 20px; padding: 20px; text-align: center;
            font-size: 3rem; cursor: pointer; transition: 0.2s;
        }
        .mood-btn:hover { background: #334155; }
        .mood-btn:active { transform: scale(0.90); border-color: #db2777; }

    </style>
</head>
<body>

    <div id="step-welcome" class="screen-section active">
        <h1>‚òï Caf√© Parents</h1>
        <div class="badge-anon">üîí 100% Anonyme</div>
        <p>Bienvenue ! Exprimez-vous librement, aucune donn√©e personnelle n'est enregistr√©e.</p>
        <button class="btn" onclick="startApp()">Participer maintenant</button>
    </div>

    <div id="step-wait" class="screen-section">
        <h1>‚è≥ En attente...</h1>
        <div class="badge-anon">üîí Mode Anonyme</div>
        <p>Regardez le grand √©cran, √ßa va commencer !</p>
        <div style="font-size: 3rem; animation: pulse 1.5s infinite;">‚òï</div>
    </div>

    <div id="step-meteo" class="screen-section">
        <h1>üß† Votre M√©t√©o</h1>
        <p>Comment vous sentez-vous ? (Anonyme)</p>
        <div class="mood-grid">
            <div class="mood-btn" onclick="sendMood('super')">ü§©</div>
            <div class="mood-btn" onclick="sendMood('bien')">üôÇ</div>
            <div class="mood-btn" onclick="sendMood('bof')">ü§î</div>
            <div class="mood-btn" onclick="sendMood('mauvais')">üò∞</div>
        </div>
    </div>

    <div id="step-nuage" class="screen-section">
        <h1>‚òÅÔ∏è Nuage de mots</h1>
        <p>Envoyez une id√©e (Anonyme) :</p>
        <input type="text" id="word-input" placeholder="√âcrivez ici...">
        <button class="btn" onclick="sendWord()">Envoyer üöÄ</button>
    </div>

    <div id="step-sondage" class="screen-section">
        <h1>üìä Sondage</h1>
        <p>Votre avis compte (Vote anonyme)</p>
        <button class="btn" style="background:#22c55e;" onclick="sendPoll('oui_top')">Oui, tout √† fait üëç</button>
        <button class="btn" style="background:#eab308;" onclick="sendPoll('oui_moyen')">Plut√¥t oui üòê</button>
        <button class="btn" style="background:#ef4444;" onclick="sendPoll('non_bof')">Pas vraiment üëé</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // On force l'utilisateur en "Anonyme"
    const currentUser = "Parent Anonyme"; 
    let activeSessionId = null;

    // 1. D√âMARRAGE
    window.startApp = function() {
        document.getElementById('step-welcome').classList.remove('active');
        document.getElementById('step-wait').classList.add('active');
        listenToSession(); // On commence √† √©couter
    }

    // 2. √âCOUTER L'√âTAT DE LA S√âANCE (Pilot√© par l'animateur)
    function listenToSession() {
        onSnapshot(doc(db, "config", "live"), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                activeSessionId = data.activeSessionId;
                
                // Si on n'est pas encore sur l'√©cran d'accueil, on suit le live
                if(!document.getElementById('step-welcome').classList.contains('active')) {
                    showScreen(data.currentStep || 'wait');
                }
            }
        });
    }

    function showScreen(stepName) {
        // Mapping de s√©curit√© : si le prof envoie "attente", on affiche "wait"
        if(stepName === 'attente') stepName = 'wait';

        document.querySelectorAll('.screen-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById('step-' + stepName);
        if(target) {
            target.classList.add('active');
        } else {
            // Par d√©faut si √©cran inconnu
            document.getElementById('step-wait').classList.add('active');
        }
    }

    // 3. FONCTIONS D'ENVOI (Toujours Anonyme)
    
    // ENVOI M√âT√âO
    window.sendMood = async function(moodValue) {
        if(!activeSessionId) return;
        try {
            await addDoc(collection(db, `sessions/${activeSessionId}/inputs`), {
                type: 'mood',
                content: moodValue,
                user: currentUser,
                timestamp: serverTimestamp()
            });
            alert("Humeur enregistr√©e !");
            showScreen('wait'); 
        } catch(e) { console.error(e); }
    }

    // ENVOI MOT
    window.sendWord = async function() {
        const word = document.getElementById('word-input').value.trim();
        if(!word || !activeSessionId) return;

        try {
            await addDoc(collection(db, `sessions/${activeSessionId}/inputs`), {
                type: 'word',
                content: word,
                user: currentUser,
                timestamp: serverTimestamp(),
                banned: false
            });
            
            document.getElementById('word-input').value = ""; 
            alert("Message envoy√© !");
            // On laisse l'utilisateur sur la page pour qu'il puisse en envoyer d'autres
        } catch(e) { console.error(e); }
    }

    // ENVOI SONDAGE
    window.sendPoll = async function(voteValue) {
        if(!activeSessionId) return;
        try {
            await addDoc(collection(db, `sessions/${activeSessionId}/inputs`), {
                type: 'poll',
                content: voteValue,
                user: currentUser,
                timestamp: serverTimestamp()
            });
            alert("Vote pris en compte !");
            showScreen('wait');
        } catch(e) { console.error(e); }
    }

</script>
</body>
</html>
