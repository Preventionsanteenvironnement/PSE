<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interface Participant</title>
    <style>
        body { margin: 0; padding: 20px; background: #0f172a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; text-align: center; }
        .hidden { display: none !important; }
        
        /* HEADER */
        h1 { color: #f472b6; font-size: 1.5rem; margin-bottom: 5px; }
        .badge { background: rgba(255,255,255,0.1); color: #4ade80; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 20px; }

        /* BOUTONS DYNAMIQUES */
        .btn-option {
            width: 100%; max-width: 400px; padding: 18px; margin-bottom: 12px;
            background: #1e293b; color: white; border: 2px solid #334155; border-radius: 12px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: 0.1s;
        }
        .btn-option:active { transform: scale(0.98); border-color: #db2777; background: #db2777; }
        
        /* INPUT TEXTE */
        input[type="text"] { width: 100%; max-width: 400px; padding: 15px; border-radius: 10px; border: none; font-size: 1rem; margin-bottom: 10px; text-align: center; }
        .btn-send { background: #db2777; color: white; border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; font-size: 1rem; cursor: pointer; }

        /* EMOJIS */
        .grid-mood { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 350px; }
        .btn-mood { font-size: 3rem; background: #1e293b; border-radius: 15px; padding: 15px; cursor: pointer; border: 2px solid #334155; }
        .btn-mood:active { border-color: #db2777; transform: scale(0.9); }
    </style>
</head>
<body>

    <h1 id="app-title">Bienvenue</h1>
    <div class="badge">ðŸ”’ Anonyme</div>

    <div id="container">
        <p style="color:#94a3b8; margin-top:50px;">En attente de l'animateur...</p>
        <div style="font-size:3rem; animation:pulse 2s infinite">ðŸ“¡</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const app = initializeApp({ apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse" });
    const db = getFirestore(app);
    let activeSessionId = null;

    // Ã‰COUTE CONFIG
    onSnapshot(doc(db, "config", "live"), (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        activeSessionId = data.activeSessionId;
        
        if(data.sessionTitle) document.getElementById('app-title').innerText = data.sessionTitle;
        renderScreen(data);
    });

    function renderScreen(data) {
        const c = document.getElementById('container');
        c.innerHTML = ""; // Reset total

        const step = data.currentStep || 'wait';

        // 1. ATTENTE
        if(step === 'wait' || !activeSessionId) {
            c.innerHTML = `<p style="color:#94a3b8; margin-top:50px;">Regardez l'Ã©cran gÃ©ant...</p><div style="font-size:3rem;">ðŸ‘€</div>`;
            return;
        }

        // 2. MÃ‰TÃ‰O
        if(step === 'meteo') {
            c.innerHTML = `
                <p>Votre humeur ?</p>
                <div class="grid-mood">
                    <div class="btn-mood" onclick="send('mood', 'super')">ðŸ¤©</div>
                    <div class="btn-mood" onclick="send('mood', 'bien')">ðŸ™‚</div>
                    <div class="btn-mood" onclick="send('mood', 'bof')">ðŸ¤”</div>
                    <div class="btn-mood" onclick="send('mood', 'mauvais')">ðŸ˜°</div>
                </div>`;
        }

        // 3. NUAGE
        if(step === 'nuage') {
            let html = `<p>Envoyez un mot :</p>`;
            // Mots suggÃ©rÃ©s
            if(data.wordBank && data.wordBank.length) {
                data.wordBank.forEach(w => {
                    html += `<button class="btn-option" onclick="send('word', '${w}')">${w}</button>`;
                });
                html += `<p style="margin:20px 0;">Ou Ã©crivez :</p>`;
            }
            html += `<input type="text" id="word-in" placeholder="Votre idÃ©e..."><button class="btn-send" onclick="sendCustomWord()">Envoyer ðŸš€</button>`;
            c.innerHTML = html;
        }

        // 4. SONDAGE ou QUIZ
        if(step === 'sondage' || step === 'quiz') {
            const question = data.pollQuestion || data.quizQuestion || "Question ?";
            const options = data.pollOptions || data.quizOptions || [];
            
            let html = `<h2 style="font-size:1.2rem; margin-bottom:20px;">${question}</h2>`;
            options.forEach((opt, idx) => {
                // Pour le quiz, on envoie l'index (0, 1, 2) pour comparer. Pour le sondage, le texte.
                const val = (step === 'quiz') ? idx : opt; 
                html += `<button class="btn-option" onclick="send('${step}', '${val}')">${opt}</button>`;
            });
            c.innerHTML = html;
        }
    }

    // ENVOI
    window.send = async function(type, content) {
        if(!activeSessionId) return;
        await addDoc(collection(db, `sessions/${activeSessionId}/inputs`), { type, content, timestamp: serverTimestamp() });
        // Feedback simple
        document.getElementById('container').innerHTML = `<h2 style="color:#4ade80; margin-top:50px;">ReÃ§u ! âœ…</h2>`;
    }

    window.sendCustomWord = function() {
        const val = document.getElementById('word-in').value.trim();
        if(val) window.send('word', val);
    }
</script>
</body>
</html>
