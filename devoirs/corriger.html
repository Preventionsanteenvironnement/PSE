<script>
  (async function () {
    try {
      const params = new URLSearchParams(location.search);

      // ✅ accepte docId (nouveau) + doc (ancien) pour compatibilité
      const docId = params.get("docId") || params.get("doc") || params.get("docID");
      if (!docId) return;

      // ✅ si annuaire.js est chargé, il expose maintenant window._ensureDb()
      try { if (typeof window._ensureDb === "function") window._ensureDb(); } catch(e) {}

      if (!window.db || !window.db.collection) {
        const status = document.getElementById("status") || document.getElementById("loginStatus");
        if (status) status.textContent = "Erreur : Firestore indisponible (db).";
        return;
      }

      // ✅ collection paramétrable (par défaut devoirs_rendus)
      const collection = params.get("collection") || "devoirs_rendus";

      const snap = await window.db.collection(collection).doc(docId).get();
      if (!snap.exists) {
        alert("Rendu introuvable.");
        return;
      }

      const r = snap.data() || {};
      const eleve = r.eleve || {};
      const details = (r.resultat_auto && r.resultat_auto.details) ? r.resultat_auto.details : {};
      const reponses = r.reponses || {};

      const qids = Array.from(new Set([
        ...Object.keys(details || {}),
        ...Object.keys(reponses || {})
      ])).sort((a,b) => (Number(a) || 0) - (Number(b) || 0));

      const questions = qids.map(qid => {
        const d = details[qid] || {};
        const rep = (reponses[qid] !== undefined) ? reponses[qid] : (d.reponse !== undefined ? d.reponse : "");
        return {
          qnum: String(qid),
          comp: d.competence || "",
          method: "",
          niveau: "",
          barInput: (d.points !== undefined ? String(d.points) : ""),
          points: "",
          corrige: "",
          questionTexte: "Question " + String(qid),
          repEleve: (rep === undefined || rep === null) ? "" : String(rep),
          commentaire: ""
        };
      });

      const fixed = {
        titreEval: r.titre || r.devoirId || "Devoir",
        nom: eleve.nom || r.nom || "",
        prenomEleve: eleve.prenom || r.prenom || "",
        classe: eleve.classe || eleve.classeCode || r.classe || "",
        dateEval: r.createdAtISO ? new Date(r.createdAtISO).toLocaleDateString("fr-FR") : ""
      };

      if (typeof restoreDataFromObject === "function") {
        restoreDataFromObject({ fixed, questions });
      } else {
        alert("Erreur : la fonction restoreDataFromObject est introuvable dans la grille.");
      }

      // ✅ liens cohérents avec ton dossier actuel
      const top = document.createElement("div");
      top.style = "margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;align-items:center";
      top.innerHTML = `
        <a href="./prof-v2.html" style="font-weight:800;text-decoration:none">← Retour</a>
        <a href="${r.url || "#"}" target="_blank" rel="noopener" style="font-weight:800;text-decoration:none">Ouvrir le devoir</a>
        <span style="color:#4b5563;font-weight:700">DocId : ${docId}</span>
      `;
      document.body.prepend(top);

    } catch (e) {
      console.error(e);
      alert("Erreur chargement correction : " + (e && e.message ? e.message : e));
    }
  })();
</script>
