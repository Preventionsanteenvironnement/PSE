<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PAD - Évaluation V2</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#ef4444;
      --border:rgba(148,163,184,.18);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(96,165,250,.18), transparent 55%),
                  radial-gradient(1200px 700px at 85% 20%, rgba(34,197,94,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:980px;margin:0 auto;}
    .top{
      display:flex; gap:12px; align-items:stretch; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .card{
      background:rgba(15,23,42,.78);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h1{margin:0 0 6px 0; font-size:1.15rem;}
    .sub{color:var(--muted); font-size:.92rem; line-height:1.3;}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .grid label{display:block; font-size:.8rem; color:var(--muted); margin-bottom:4px;}
    input, textarea, select{
      width:100%;
      box-sizing:border-box;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.55);
      color:var(--text);
      padding:10px;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical;}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      border:none; border-radius:12px; padding:10px 12px;
      font-weight:700; cursor:pointer;
      background:rgba(96,165,250,.15);
      color:var(--text);
      border:1px solid rgba(96,165,250,.35);
    }
    button.primary{
      background: rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.5);
    }
    button.danger{
      background: rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.45);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background: rgba(148,163,184,.10);
      border:1px solid rgba(148,163,184,.18);
      color:var(--muted); font-size:.82rem;
      margin-top:10px;
    }
    .q{
      margin-top:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.65);
      padding:12px;
    }
    .qhead{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .qleft{display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      width:34px; height:24px;
      border-radius:8px;
      background:rgba(96,165,250,.18);
      border:1px solid rgba(96,165,250,.35);
      font-weight:800;
    }
    .meta{color:var(--muted); font-size:.82rem;}
    .qtext{margin:0; line-height:1.35;}
    .help{color:var(--muted); font-size:.85rem; margin-top:6px;}
    .toast{
      position:fixed; right:14px; bottom:14px;
      background:rgba(2,6,23,.85);
      border:1px solid rgba(148,163,184,.25);
      color:var(--text);
      padding:10px 12px; border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.3);
      opacity:0; transform: translateY(8px);
      transition: .2s;
      max-width:min(420px, calc(100vw - 28px));
      pointer-events:none;
      white-space:pre-wrap;
    }
    .toast.show{opacity:1; transform:none;}
    .small{font-size:.82rem; color:var(--muted);}
    @media (max-width:860px){
      .grid{grid-template-columns:1fr 1fr;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Processus d’apparition d’un dommage - Évaluation V2</h1>
    <div class="sub">Complète chaque champ. Les réponses sont enregistrées et envoyées en ligne à la fin.</div>
    <div class="pill">Anti copier-coller externe actif</div>

    <div class="grid">
      <div>
        <label>Code élève</label>
        <input id="userCode" autocomplete="off" placeholder="ex: MELEC_T01" />
      </div>
      <div>
        <label>Classe</label>
        <input id="classe" autocomplete="off" placeholder="ex: TMELEC" />
      </div>
      <div>
        <label>Nom</label>
        <input id="nom" autocomplete="off" placeholder="Nom" />
      </div>
      <div>
        <label>Prénom</label>
        <input id="prenom" autocomplete="off" placeholder="Prénom" />
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="btnSend">Envoyer</button>
      <button id="btnSave">Sauvegarder sur cet appareil</button>
      <button class="danger" id="btnClear">Effacer tout</button>
    </div>
    <div class="small" style="margin-top:8px;">
      Astuce : si tu dois corriger une faute, réécris dans le champ. Coller un texte depuis une autre application est bloqué.
    </div>
  </div>

  <div id="questions"></div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const DEVOIR_ID = "devoir_1769147302728_v2";
  const BLUEPRINT_URL = `${DEVOIR_ID}_blueprint.json?ts=${Date.now()}`;

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  const toast = (msg) => {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => t.classList.remove("show"), 2600);
  };

  const sanitizeId = (s) => String(s || "")
    .trim()
    .replace(/\s+/g, "_")
    .replace(/[^a-zA-Z0-9_-]/g, "");

  const blockPaste = (el) => {
    el.addEventListener("paste", (e) => {
      e.preventDefault();
      toast("Coller depuis une autre application est bloqué");
    });
  };

  function loadIdentity() {
    $("userCode").value = localStorage.getItem("PAD_userCode") || "";
    $("classe").value  = localStorage.getItem("PAD_classe")  || "";
    $("nom").value     = localStorage.getItem("PAD_nom")     || "";
    $("prenom").value  = localStorage.getItem("PAD_prenom")  || "";
  }

  function saveIdentity() {
    localStorage.setItem("PAD_userCode", $("userCode").value.trim());
    localStorage.setItem("PAD_classe", $("classe").value.trim());
    localStorage.setItem("PAD_nom", $("nom").value.trim());
    localStorage.setItem("PAD_prenom", $("prenom").value.trim());
    toast("Sauvegardé sur cet appareil");
  }

  function clearAll() {
    if (!confirm("Tout effacer ?")) return;
    document.querySelectorAll("textarea, input[data-qid]").forEach(el => el.value = "");
    toast("Tout est effacé");
  }

  function renderQuestions(questions) {
    const host = $("questions");
    host.innerHTML = "";

    questions.forEach((q, i) => {
      const wrap = document.createElement("div");
      wrap.className = "q";

      const label = q.label || `Q${i+1}`;
      const comp = q.competence || "C6";
      const bareme = (q.bareme ?? "");
      const qid = q.qid || `q_${i}`;

      wrap.innerHTML = `
        <div class="qhead">
          <div class="qleft">
            <span class="badge">${label}</span>
            <div class="meta">${comp}${bareme !== "" ? " • barème " + bareme : ""}</div>
          </div>
          <div class="meta">qid ${qid}</div>
        </div>
        <p class="qtext">${q.questionText || ""}</p>
        <div class="help">Réponse attendue : ${q.reponseAttendue || "—"}</div>
        <div style="margin-top:10px;">
          <textarea data-qid="${qid}" id="rep_${qid}" placeholder="Ta réponse"></textarea>
        </div>
      `;

      host.appendChild(wrap);

      const ta = wrap.querySelector("textarea");
      blockPaste(ta);
    });

    toast("Questions chargées");
  }

  function extractQuestionsFromBlueprint(bp) {
    const out = [];
    const walk = (node) => {
      if (!node) return;
      if (Array.isArray(node)) return node.forEach(walk);
      if (typeof node !== "object") return;

      if (node.type === "question") out.push(node);
      if (node.questions) walk(node.questions);
      if (node.content) walk(node.content);
      for (const k of Object.keys(node)) {
        if (k !== "content" && k !== "questions") walk(node[k]);
      }
    };
    if (Array.isArray(bp.questions)) return bp.questions;
    walk(bp);
    return out;
  }

  function collectAnswers() {
    const reponses = {};
    document.querySelectorAll("textarea[data-qid]").forEach(el => {
      const qid = el.getAttribute("data-qid");
      const v = el.value.trim();
      reponses[qid] = v;
    });
    return reponses;
  }

  async function send() {
    const userCode = sanitizeId($("userCode").value);
    const classe = $("classe").value.trim();
    const nom = $("nom").value.trim();
    const prenom = $("prenom").value.trim();

    if (!userCode) {
      toast("Code élève obligatoire");
      return;
    }

    const reponses = collectAnswers();

    const docId = sanitizeId(`${userCode}_${DEVOIR_ID}_${Date.now()}`);
    const payload = {
      devoirId: DEVOIR_ID,
      titre: "Processus d’apparition d’un dommage - V2",
      createdAt: serverTimestamp(),
      eleve: {
        userCode,
        classe,
        nom,
        prenom
      },
      reponses
    };

    await setDoc(doc(db, "devoirs_rendus", docId), payload);

    saveIdentity();
    toast(`Envoyé. id ${docId}`);
    alert("Copie envoyée !");
  }

  // anti-coller sur identité
  ["userCode","classe","nom","prenom"].forEach(id => blockPaste($(id)));

  $("btnSend").addEventListener("click", () => send().catch(e => {
    console.error(e);
    alert("Erreur envoi : " + e.message);
  }));
  $("btnSave").addEventListener("click", saveIdentity);
  $("btnClear").addEventListener("click", clearAll);

  loadIdentity();

  // Charger le blueprint V2 pour rendre exactement les qid attendus
  (async () => {
    const resp = await fetch(BLUEPRINT_URL, { cache: "no-store" });
    if (!resp.ok) throw new Error("Blueprint introuvable : " + BLUEPRINT_URL);
    const bp = await resp.json();
    const qs = extractQuestionsFromBlueprint(bp);
    renderQuestions(qs);
  })().catch(e => {
    console.error(e);
    alert("Erreur chargement : " + e.message);
  });
</script>
</body>
</html>
