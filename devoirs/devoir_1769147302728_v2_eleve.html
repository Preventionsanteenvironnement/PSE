<!DOCTYPE html>
<html lang="fr"><head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title>Devoir PSE - √âditeur (Version 20 - V√©rifier + Anti-collage + Responsive)</title>
<style>
        /* --- STYLE ECRAN (WEB) --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 950px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; padding-bottom: 150px; }
        .container { background-color: white; padding: 40px; box-shadow: 0 0 15px rgba(0,0,0,0.05); border-radius: 8px; position: relative; }
        
        input, textarea, select, button { font-size: inherit; font-family: inherit; }

        h1 { color: #2c3e50; text-align: center; font-size: 1.8em; margin-bottom: 30px; text-transform: uppercase; border-bottom: 3px solid #3498db; padding-bottom: 15px; }
        .main-title-editable { border-bottom: 2px dashed #ccc; padding: 0 10px; color: #3498db; cursor: text; }
        
        /* BANDEAU ELEVE COMPACT */
        .student-info { 
            background-color: #eef2f3; padding: 10px 15px; border-radius: 8px; border: 1px solid #bdc3c7; margin-bottom: 20px; 
            display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: nowrap;
        }
        .input-group { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .input-group label { font-weight: bold; color: #555; font-size: 0.9em; margin: 0; }
        .input-group input { padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; width: 130px; }
        
        /* GRILLE EVALUATION */
        .eval-section { margin-bottom: 20px; border: 2px solid #2c3e50; }
        .eval-header { background-color: #2c3e50; color: white; padding: 8px; font-weight: bold; text-align: center; text-transform: uppercase; }
        table.eval-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        table.eval-table th, table.eval-table td { border: 1px solid #999; padding: 5px; text-align: center; }
        table.eval-table th { background-color: #ecf0f1; }
        .row-c6 { background-color: #fff8e1; border-top: 2px solid #aaa; }
        .row-c6 input.point-input-c6 { width: 45px; text-align: center; border: 1px solid #aaa; border-radius: 3px; background-color: #fff; padding: 2px; }
        .c6-text-editable { font-style: italic; cursor: text; border-bottom: 1px dashed #ccc; padding: 2px; font-size: 0.9em; font-weight: bold;}
        .print-only { display: none; }
        .legend-inline { font-size: 0.7em; font-weight: normal; color: #555; float: left; text-align: left; line-height: 1.1; font-style: italic; padding-left: 5px;}

        /* BLOCS QUESTIONS */
        .question-block { margin-bottom: 30px; background-color: #fff; border: 1px solid #ddd; border-left: 4px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; padding: 0; }
        
        /* En-t√™te gris avec Bar√®me */
        .q-meta-bar { background-color: #f8f9fa; border-bottom: 1px solid #eee; padding: 5px 10px; text-align: right; display: flex; justify-content: flex-end; align-items: center; height: 30px; }
        
        /* Ligne Question */
        .q-content-row { padding: 15px; display: flex; align-items: flex-start; gap: 15px; }
        .num-selector-wrapper { flex-shrink: 0; }
        .editable-text { flex-grow: 1; border-bottom: 1px dashed transparent; cursor: text; padding: 2px 5px; font-weight: normal; min-height: 24px; color: inherit; }
        .editable-text:hover { border-bottom: 1px dashed #bbb; } 
        [contenteditable="true"]:focus { outline: 2px solid #3498db; background-color: #fff; border-radius: 3px; border-bottom: none; }

        /* ZONE EXERCICES (Simplifi√©e pour √©viter les bugs) */
        .exo-container { padding: 0 15px 15px 15px; }
        /* ZONE ORANG√âE - √âL√âMENTS DE R√âPONSE (PROF) */
        .answer-key-zone { margin-top: 10px; border-top: 1px solid #eee; padding: 10px; background-color: #fff7e6; border: 1px dashed #e67e22; border-radius: 6px; }
        .answer-key-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .answer-key-label { font-weight: bold; color: #d35400; }
        .answer-key-level { font-size: 0.9em; color: #7a4a00; display: flex; align-items: center; gap: 6px; }
        select.level-selector { border: 1px solid #e67e22; background: #fff3d6; color: #7a4a00; font-weight: bold; border-radius: 4px; padding: 3px 6px; cursor: pointer; }
        .answer-key-area { width: 100%; min-height: 60px; border: 1px dashed #e67e22; background-color: #fff3d6; color: #7a4a00; font-size: 0.9em; padding: 8px; border-radius: 4px; font-family: 'Segoe UI', sans-serif; resize: vertical; box-sizing: border-box; }

.section-block { margin: 30px 0 20px 0; padding: 10px; position: relative; text-align: center; border-top: 2px solid #eee; border-bottom: 2px solid #eee; }
        .section-title-editable { font-size: 1.4em; font-weight: bold; color: #2c3e50; text-transform: uppercase; letter-spacing: 1px; cursor: text; border: none; background: transparent; width: 100%; text-align: center; }

        .doc-block, .text-block { margin-bottom: 15px; padding: 10px; padding-right: 110px; background-color: #fff; border: 1px solid #eee; position: relative; }
        .numbered-header { display: flex; align-items: center; background-color: #e9ecef; border-left: 5px solid #34495e; padding: 10px; margin-top: 25px; margin-bottom: 15px; border-radius: 0 5px 5px 0; position: relative; padding-right: 110px; }
        .num-box { font-size: 1.5em; font-weight: bold; color: #34495e; margin-right: 15px; min-width: 30px; text-align: center; cursor: text; border-right: 2px solid #ccc; padding-right: 10px; }
        .text-box { font-size: 1.1em; font-weight: bold; color: #2c3e50; flex: 1; cursor: text; }

        /* OUTILS */
        select.comp-selector { background-color: #e8f8f5; color: #16a085; border: 1px solid #16a085; border-radius: 4px; padding: 3px; font-weight: bold; cursor: pointer; font-size: 0.8em; }
        select.num-selector { color: #e74c3c; font-size: 1.1em; font-weight: bold; border: 1px solid #e74c3c; background-color: #fff; padding: 3px; border-radius: 4px; cursor: pointer; min-width: 60px; }
        .points-wrapper { display: flex; align-items: center; font-size: 0.9em; color: #333; white-space: nowrap; margin-left: 10px; background-color: #f9f9f9; padding: 5px; border-radius: 4px; border: 1px solid #eee; }
        input.student-score { width: 45px; padding: 3px; margin-right: 5px; border: 2px solid #2980b9; border-radius: 4px; text-align: center; font-weight: bold; color: #2980b9; background-color: #eaf2f8; }
        input.point-input { width: 45px; padding: 3px; margin: 0 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; color: #7f8c8d; }
        .print-only-grade { display: none; } 

        textarea.reponse-eleve { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Courier New', Courier, monospace; min-height: 60px; resize: vertical; background-color: #fafafa; box-sizing: border-box; overflow-y: hidden; }
        table.exo-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        table.exo-table td { border: 1px solid #ddd; padding: 10px; vertical-align: top; }
        
        .img-container { text-align: center; margin: 10px 0; position: relative; display: inline-block; width: 100%; }
        .img-container img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .doc-title { font-size: 1.1em; font-weight: bold; color: #d35400; margin-bottom: 15px; cursor: text; border-left: 5px solid #d35400; padding-left: 10px; background-color: #fff5f0; padding: 5px 10px; }
        .consigne-simple { font-weight: normal; margin-bottom: 15px; margin-top: 20px; cursor: text; text-align: justify; line-height: 1.6; }

/* ‚≠ê AJOUT : Texte justifi√© dans tous les blocs de texte */
.text-block div, .text-block p, .doc-block div, .doc-block p {
    text-align: justify;
    line-height: 1.6;
}
/* Exception : ne pas justifier les titres */
.doc-title, .section-title-editable, .num-box, .text-box {
    text-align: left !important;
}

/* --- OUTILS D'ANALYSE (ITAMaMi / Ishikawa) --- */
.analysis-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.analysis-table td, .analysis-table th { border: 1px solid #ddd; padding: 10px; vertical-align: top; }
.analysis-table th { background: #f8f9fa; text-align: left; width: 28%; }
.analysis-label-editable { font-weight: bold; cursor: text; }

.ishikawa-wrapper { margin-top: 10px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #fbfbfb; }
.ishikawa-tools { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center; margin-bottom: 10px; }
.ishikawa-effect { border: 2px solid #c0392b; background: #fff5f5; color: #c0392b; padding: 10px; border-radius: 8px; min-height: 42px; font-weight: bold; cursor: text; text-align: center; }
.ishikawa-diagram { display: grid; grid-template-rows: auto 60px auto; gap: 12px; align-items: center; }
.ishikawa-row { display: flex; gap: 10px; justify-content: space-between; flex-wrap: wrap; }
.ish-cat { position: relative; flex: 1 1 180px; min-width: 180px; border: 1px solid #e5e7eb; border-radius: 10px; background: white; padding: 10px; }
.ish-cat::before { content: ""; position: absolute; top: 50%; width: 22px; height: 2px; background: #3498db; }
.ish-cat[data-side="top"]::before { right: -22px; transform: translateY(-50%) rotate(-25deg); transform-origin: left center; }
.ish-cat[data-side="bottom"]::before { right: -22px; transform: translateY(-50%) rotate(25deg); transform-origin: left center; }
.ish-cat-title { font-weight: bold; color: #2c3e50; margin-bottom: 6px; cursor: text; }
textarea.ish-cat-causes { width: 100%; min-height: 70px; resize: vertical; box-sizing: border-box; }
.ish-spine { position: relative; height: 60px; display: flex; align-items: center; justify-content: flex-end; }
.ish-line { position: absolute; left: 0; right: 160px; top: 50%; height: 4px; background: #3498db; border-radius: 4px; transform: translateY(-50%); }
.ish-arrow { position: absolute; right: 160px; top: 50%; width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-left: 16px solid #3498db; transform: translateY(-50%); }
.ish-effect-box { width: 150px; border: 2px solid #c0392b; border-radius: 10px; padding: 8px; background: #fff5f5; color: #c0392b; font-weight: bold; text-align: center; cursor: text; min-height: 44px; }

/* Masquer/afficher la case Effet (Ishikawa) */
.ish-hide-effect .ish-effect-box { display: none !important; }
.ish-hide-effect .ish-line { right: 0 !important; }
.ish-hide-effect .ish-arrow { right: 0 !important; }
.ish-hide-effect .ish-spine { justify-content: flex-end; }


body.student-view .ishikawa-tools { display: none !important; }
body.student-view .analysis-label-editable, body.student-view .ish-cat-title, body.student-view .ish-effect-box { cursor: default; }

        /* --- STYLES EXERCICES INTERACTIFS --- */
                .word-btn { display: inline-block; padding: 5px 10px; margin: 3px; background: #3498db; color: white; border-radius: 4px; cursor: pointer; font-size: 1rem; user-select: none; }
        .word-btn.hole-active { background: #bdc3c7; color: #7f8c8d; text-decoration: line-through; }
        input.trou-eleve { border: none; border-bottom: 2px solid #2c3e50; background: #f4f6f7; color: #2980b9; font-weight: bold; text-align: center; min-width: 120px; width: clamp(120px, 22vw, 240px); max-width: 260px; padding: 0 6px; }
        select.trou-eleve { border: 1px solid #3498db; background: #eaf2f8; color: #2c3e50; font-weight: bold; padding: 2px 5px; border-radius: 4px; }

        .word-bank { margin: 12px 0 8px 0; padding: 10px; background: #eef6ff; border: 1px solid #cfe3ff; border-radius: 10px; }
        .word-bank-title { font-weight: bold; color: #2c3e50; margin-bottom: 6px; }
        .word-chip { display: inline-block; padding: 6px 10px; margin: 4px; background: #3498db; color: white; border-radius: 999px; cursor: pointer; user-select: none; font-weight: 600; }
        .word-chip.used { background: #bdc3c7; color: #7f8c8d; text-decoration: line-through; }
        
        .pair-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .pair-input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .matching-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .matching-select { width: 100%; padding: 8px; border: 2px solid #3498db; border-radius: 4px; font-weight: bold; color: #2c3e50; cursor: pointer; }
        .print-matching-container { display: none; } 
        
        .qcm-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .qcm-option-input { flex: 1; padding: 5px; border: 1px solid #ccc; }
        .qcm-student-option { display: flex; align-items: center; margin-bottom: 8px; font-size: 1.05em; cursor: pointer; }
        .qcm-student-option input { transform: scale(1.3); margin-right: 10px; cursor: pointer; }

        
        .pair-input { resize: vertical; }
        .matching-table td { vertical-align: top; }
        .matching-table .matching-left { white-space: pre-wrap; overflow-wrap: anywhere; }
        .matching-table .matching-right { width: 50%; }
        .matching-table .matching-left { width: 50%; }
        .word-bank { margin: 10px 0; padding: 8px 10px; background: #f1f5f9; border: 1px dashed #94a3b8; border-radius: 6px; font-size: 0.95em; }
        .word-bank .word-chip { display: inline-block; margin: 3px; padding: 4px 8px; border-radius: 999px; background: #e2e8f0; }
/* MODE PROF */
        body.teacher-mode .question-block { border-left: 4px solid #f39c12; border-style: dashed; }
        body.teacher-mode .numbered-header { border-left: 5px solid #f39c12; border-style: dashed; }
        body.teacher-mode .doc-block { border: 2px dashed #95a5a6; } 
        body.teacher-mode .text-block { border: 2px dashed #f1c40f; background: #fef9e7; }
        body.teacher-mode .section-block { border: 2px dashed #8e44ad; }
        body.teacher-mode .img-container { cursor: pointer; border: 2px dashed #3498db; padding: 5px;}
        body.teacher-mode .img-container:hover::after { content: "üìÇ Changer l'image"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; }
        .teacher-controls { display: none; }
        body.teacher-mode .teacher-controls { display: block; margin-top: 10px; text-align: center; }
        .block-controls { position: absolute; top: -10px; right: -10px; display: flex; gap: 2px; background: #fff; padding: 2px; border-radius: 20px; border: 1px solid #ccc; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-add-q { background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin: 3px; display:inline-flex; align-items:center; gap:5px; }
        .btn-del-q { background: #c0392b; color: white; border: none; padding: 4px 8px; border-radius: 50%; cursor: pointer; font-size: 0.9em; opacity: 0.8; width:25px; height:25px; display:flex; align-items:center; justify-content:center;}
        .btn-del-q:hover { opacity: 1; }
        .btn-move { background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 50%; cursor: pointer; font-size: 0.9em; opacity: 0.8; width:25px; height:25px; display:flex; align-items:center; justify-content:center;}
        .btn-move:hover { opacity: 1; }
        .tools-panel { position: fixed; bottom: 20px; right: 20px; left: 20px; display: flex; gap: 10px; z-index: 1000; justify-content: flex-end; flex-wrap: wrap; }
        .btn-tool { padding: 12px 20px; border-radius: 30px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.2s; color: white;}
        .btn-tool:hover { transform: translateY(-2px); }
        .btn-print { background: #3498db; }
        .btn-generate { background: #27ae60; border: 2px solid white;} 
        .btn-save-master { background: #8e44ad; }
        .btn-qc { background: #f39c12; } 

        #rich-format-toolbar { position: absolute; display: none; background: #34495e; padding: 5px; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 9999; flex-wrap: nowrap; gap: 5px; }
        #rich-format-toolbar::after { content: ""; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px; border-style: solid; border-color: #34495e transparent transparent transparent; }
        .fmt-btn { background: transparent; border: none; color: white; cursor: pointer; padding: 5px 8px; border-radius: 3px; font-size: 14px; font-weight: bold; }
        .fmt-btn:hover { background: rgba(255,255,255,0.2); }
        .fmt-sep { width: 1px; background: rgba(255,255,255,0.3); margin: 0 2px; }

        .general-comment-box { margin-top: 15px; border: 2px solid #c0392b; padding: 10px; background-color: #fff9f9; border-radius: 5px; }

        /* --- STYLE IMPRESSION ELEVE --- */
        @media print {
            body { background-color: white; color: black; font-family: 'Times New Roman', serif; font-size: 12pt; padding: 0; margin: 0; line-height: 1.2; }
            .container { box-shadow: none; padding: 0; border: none; width: 100%; max-width: 100%; }
            h1 { font-size: 16pt; margin: 10px 0; border-bottom: 2px solid black; padding-bottom: 5px; color: black; }
            .activity-header { background: #eee; color: black; border: 1px solid #999; padding: 5px; font-size: 12pt; margin-top: 15px; }
            .doc-title { background: none; border-left: 3px solid black; color: black; padding-left: 5px; margin-bottom: 5px; }
            .student-info { background: none; border: none; padding: 0; margin-bottom: 10px; border-bottom: 1px solid #000; gap: 20px; }
            .student-info .input-group input { border: none; border-radius: 0; padding: 0; width: 150px; text-align: left; }
            .question-block, .doc-block, .text-block, .section-block { border: none !important; margin-bottom: 15px; box-shadow: none; page-break-inside: avoid; }
            .section-block { border-top: 1px solid black !important; border-bottom: 1px solid black !important; }
            .q-meta-bar { background: transparent !important; border: none !important; justify-content: flex-end; padding: 0; margin-bottom: -20px; font-size: 0.9em; position:relative; top: 5px; z-index: 5;}
            .q-content-row { padding: 5px 0; display: flex; justify-content: flex-start; gap: 10px; align-items: baseline; }
            .num-selector-wrapper { margin-right: 0; } 
            .editable-text { border: none; padding: 0; }
            textarea.reponse-eleve {
                font-family: 'Times New Roman', serif; background-color: transparent; border: 1px solid #ccc;
                background-image: repeating-linear-gradient(transparent, transparent 29px, #ccc 30px);
                line-height: 30px; padding: 0 5px; min-height: 90px; resize: none; margin-top: 10px;
            }
            .q-response-zone { padding: 0; }
            .points-wrapper { border: none !important; background: transparent !important; padding: 0 !important; }
            .points-wrapper input, .points-wrapper select, .teacher-part, .frozen-score { display: none !important; }
            .print-only-grade, .frozen-num { display: inline-block !important; font-style: italic; font-size: 0.9em; color: black; }
            .frozen-num { border-color: black !important; color: black !important; }
            .no-print { display: none !important; }
            .print-only { display: inline-block !important; }
            .row-c6 input { display: none !important; }
            .matching-table { display: none; }
            .matching-print-view { display: block !important; width: 100%; margin-top: 10px; }
            .print-match-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
            .print-match-col { width: 40%; border: none; padding: 5px; min-height: 25px; }
            .print-match-dot { font-size: 20px; font-weight: bold; }
            input::placeholder, textarea::placeholder { color: transparent; }
            table.eval-table, table.exo-table { width: 100%; border: 1px solid black; font-size: 10pt; }
            table.eval-table th, table.eval-table td, table.exo-table td { border: 1px solid black; padding: 2px; }
            .eval-header { background: #ddd; color: black; border: 1px solid black; }
            .general-comment-box { display: none; }
            .img-container img { max-width: 80%; box-shadow: none; border: 1px solid black; }
        }
    

        /* --- VERIF : D√©tection de collage (zones de r√©ponse √©l√®ve) --- */
        #paste-toast {
            position: fixed;
            left: 16px;
            bottom: 90px;
            z-index: 99999;
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 10px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95em;
            max-width: 300px;
            display: none;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }
        .paste-warning {
            outline: 3px solid #e67e22 !important;
            background-color: #fff3e6 !important;
        }

        /* --- RESPONSIVE (mobile) --- */
        @media (max-width: 720px) {
            body { padding: 10px; }
            .container { padding: 18px; }
            .student-info { flex-wrap: wrap; gap: 10px; }
            .input-group { flex: 1 1 45%; }
            .input-group input { width: 100%; min-width: 0; }
            .q-content-row { flex-wrap: wrap; }
            .num-selector-wrapper { margin-bottom: 6px; }
            .tools-panel { left: 10px; right: 10px; bottom: 10px; flex-direction: column; }
            .btn-tool { padding: 10px 14px; }
        }

        @media print {
            #paste-toast { display: none !important; }
        }

/* Modes */
.builder-only, .prof-only, .student-only { display: none; }
body.builder-view .builder-only { display: inline-flex; }
body.prof-view .prof-only { display: inline-flex; }
body.student-view .student-only { display: inline-flex; }

body.prof-view #rich-format-toolbar { display:none !important; }
body.prof-view .teacher-controls { display:none !important; }
body.prof-view .btn-save-master, body.prof-view .btn-generate, body.prof-view .btn-qc { display:none !important; }
body.student-view #rich-format-toolbar { display:none !important; }
body.student-view .teacher-controls { display:none !important; }
body.student-view #eval-section-container { display:none !important; }
body.student-view #eval-section-container { display:none !important; }


/* =========================
   TABLEAUX RISQUES PRO
   ========================= */
.risk-gravite-wrap{border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff}
.risk-gravite-choices{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-bottom:12px}
.rg-choice{display:flex;gap:10px;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#f8fafc}
.rg-sub{font-weight:800;margin-bottom:8px}
.rg-textarea{width:100%;min-height:84px;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff}

.risk-matrix-wrap{border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff}
.risk-matrix-legend{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:10px;font-size:13px;color:#334155}
.legend-item{display:flex;align-items:center;gap:8px}
.legend-swatch{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.15)}
.legend-swatch.nonprioritaire{background:#dcfce7}
.legend-swatch.prioritaire{background:#ffedd5}
.risk-axis-label.top{font-weight:800;margin-bottom:8px}
.risk-grid{display:grid;grid-template-columns:42px 1fr;gap:10px;align-items:start}
.risk-y-label{writing-mode:vertical-rl;transform:rotate(180deg);font-weight:800;color:#0f172a;font-size:13px;align-self:stretch;justify-self:center}
.risk-matrix{width:100%;border-collapse:collapse}
.risk-matrix th,.risk-matrix td{border:1px solid #cbd5e1;padding:8px;text-align:center}
.risk-matrix th{background:#f1f5f9;font-weight:800;font-size:13px}
.risk-matrix th.corner{background:#fff;border-left-color:#fff;border-top-color:#fff}
.risk-cell{cursor:pointer;min-width:70px;min-height:44px;font-size:18px;font-weight:900;user-select:none}
.risk-cell.selected{outline:3px solid rgba(37,99,235,.35);outline-offset:-3px}
.zone-nonprioritaire{background:#dcfce7}
.zone-prioritaire{background:#ffedd5}
.risk-decision{margin-top:12px;border-top:1px dashed #cbd5e1;padding-top:12px}
.risk-decision-title{font-weight:900;margin-bottom:8px}
.risk-decision-choice{display:flex;gap:10px;align-items:center;margin:6px 0}

/* --- PAD : Processus d'Apparition du Dommage --- */
.pad-wrap{border:1px solid #1e293b;border-radius:12px;padding:16px;background:#1e293b;color:#fff}
.pad-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.pad-box{border-radius:12px;padding:12px;position:relative}
.pad-box-title{font-weight:900;text-transform:uppercase;font-size:13px;margin-bottom:8px;text-align:center;letter-spacing:0.5px}
.pad-box textarea.reponse-eleve{width:100%;min-height:60px;resize:vertical;border:none;border-radius:8px;padding:10px;font-size:14px;box-sizing:border-box}
.pad-situation{background:#e57373;color:#fff}
.pad-situation textarea{background:#ef9a9a;color:#000}
.pad-evenement{background:#ffb74d;color:#000}
.pad-evenement textarea{background:#ffe0b2;color:#000}
.pad-danger{background:#fff176;color:#000;border-radius:50%;min-height:120px;display:flex;flex-direction:column;justify-content:center;align-items:center}
.pad-danger textarea{background:#fff9c4;color:#000;border-radius:8px}
.pad-operateur{background:#81d4fa;color:#000;border-radius:50%;min-height:120px;display:flex;flex-direction:column;justify-content:center;align-items:center}
.pad-operateur textarea{background:#b3e5fc;color:#000;border-radius:8px}
.pad-interaction{display:flex;justify-content:center;align-items:center;font-size:48px;color:#ffc107;text-shadow:0 0 10px rgba(255,193,7,0.5)}
.pad-dommage{background:#81c784;color:#000;grid-column:1/3}
.pad-dommage textarea{background:#c8e6c9;color:#000}
.pad-arrow{display:flex;justify-content:center;align-items:center;color:#90a4ae;font-size:24px}
.pad-row-top{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.pad-row-middle{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;margin:16px 0}
.pad-row-bottom{margin-top:16px}
@media (max-width:600px){
  .pad-grid,.pad-row-top,.pad-row-middle{grid-template-columns:1fr}
  .pad-danger,.pad-operateur{border-radius:12px;min-height:auto}
  .pad-dommage{grid-column:auto}
  .pad-interaction{margin:12px 0}
}

.prevention-wrap{border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff}
.prevention-objectif{font-weight:800;color:#0f172a;margin-bottom:10px}
.prevention-table{width:100%;border-collapse:collapse}
.prevention-table th,.prevention-table td{border:1px solid #cbd5e1;padding:10px;vertical-align:top}
.prevention-table th{background:#f1f5f9;text-align:left;font-weight:900}
.prevention-table .col-type{width:34%;font-weight:800}
.prev-cell{width:100%;min-height:70px;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:10px}

/* --- Sch√©ma situation de travail 2 --- */
.st2-page{border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff}
.st2-header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:12px}
.st2-title{font-weight:1000;font-size:16px;color:#0f172a}
.st2-sub{font-size:13px;color:#334155}
.st2-dots{letter-spacing:2px}
.st2-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.st2-box{border:1px solid #cbd5e1;border-radius:12px;padding:12px;background:#f8fafc}
.st2-boxtitle{font-weight:900;margin-bottom:6px;color:#0f172a}
.st2-hint{font-size:12px;color:#475569;margin-bottom:8px}
.st2-ta{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px;resize:vertical;background:#fff}
.st2-box.pres{grid-column:2 / 3}
.st2-box.reel{grid-column:1 / 3}
.st2-split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.st2-splittitle{font-weight:900;margin-bottom:4px}
@media (max-width: 720px){
  .st2-grid{grid-template-columns:1fr}
  .st2-box.pres{grid-column:auto}
  .st2-box.reel{grid-column:auto}
  .risk-gravite-choices{grid-template-columns:1fr}
  .risk-grid{grid-template-columns:1fr}
  .risk-y-label{writing-mode:horizontal-tb;transform:none;justify-self:start}
}
/* --- PATCH : FORCER LA DISPARITION DES BOUTONS √Ä L'IMPRESSION --- */
    @media print {
        #main-tools, 
        .tools-panel, 
        #btn-print-student, 
        #btn-send, 
        .btn-tool {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            position: absolute !important;
            z-index: -9999 !important;
        }
    }

/* ===== Responsive (ajouts) ===== */
@media (max-width: 900px){
  .container{ width:95%; margin:16px auto; padding:14px; }
  .tools-panel{ left:50%; transform:translateX(-50%); right:auto; max-width:calc(100vw - 16px); flex-wrap:wrap; justify-content:center; }
  .btn-tool{ padding:10px 12px; }
  .student-info{ flex-direction:column; align-items:stretch; }
  .input-group{ width:100%; justify-content:space-between; }
  .input-group input{ width:100%; max-width:100%; }
  .q-content-row{ flex-direction:column; }
  .num-selector-wrapper{ width:100%; justify-content:flex-start; }
  .eval-section{ overflow-x:auto; }
  .eval-table{ min-width:820px; }
}
@media (max-width: 520px){
  h1{ font-size:1.35em; }
  .btn-tool{ width:100%; }
  .tools-panel{ gap:8px; }
}



/* ====== MODAL TELECHARGEMENT (anti-blocage navigateur) ====== */
#download-modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20000;padding:16px;}
#download-modal .dm-card{width:min(680px,100%);background:#ffffff;border-radius:18px;padding:18px 18px 14px;box-shadow:0 20px 60px rgba(0,0,0,.35);}
#download-modal .dm-title{margin:0 0 6px;font-size:1.2rem;font-weight:800;color:#111827;}
#download-modal .dm-sub{margin:0 0 10px;color:#374151;line-height:1.35;font-size:.98rem;}
#download-modal .dm-links{display:grid;gap:10px;margin:12px 0 14px;}
#download-modal a.dm-link{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px 14px;border-radius:14px;border:2px solid #e5e7eb;text-decoration:none;color:#111827;background:#f9fafb;font-weight:800;}
#download-modal a.dm-link small{font-weight:600;color:#6b7280;}
#download-modal a.dm-link:hover{background:#ffffff;border-color:#cbd5e1;}
#download-modal .dm-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
#download-modal button.dm-btn{border:none;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer;}
#download-modal button.dm-close{background:#111827;color:#ffffff;}
#download-modal .dm-note{font-size:.9rem;color:#6b7280;margin:0;}
@media (max-width:520px){
  #download-modal .dm-card{padding:16px 14px 12px;}
  #download-modal a.dm-link{padding:11px 12px;}
}
</style>
<!-- 
  ‚ö†Ô∏è ANNUAIRE.JS EST CHARG√â DYNAMIQUEMENT PLUS BAS AVEC type="module"
  Ne pas charger ici pour √©viter les conflits
-->
<style>
            body.student-view .q-meta-bar, body.student-view .num-selector-wrapper{ user-select:none; }
            body.student-view .num-display{ display:inline-block; min-width:44px; padding:6px 10px; border:2px solid #e36b6b; border-radius:8px; font-weight:700; color:#c0392b; background:#fff; text-align:center; }
            body.student-view .comp-display{ display:inline-block; min-width:44px; padding:4px 10px; border:2px solid #2ecc71; border-radius:999px; font-weight:700; background:#eafff2; color:#1f7a4a; text-align:center; }
            body.student-view .points-display{ display:inline-block; padding:4px 10px; border:2px solid #3498db; border-radius:8px; font-weight:700; background:#eef7ff; color:#1f5c86; }
            body.student-view .teacher-part{ display:none !important; }
            body.student-view .numbered-header{ display: flex !important; align-items: center; }
            body.student-view .num-box{ display: block !important; }
            body.student-view .text-box{ display: block !important; }
          </style><style>
            body.student-view textarea{
                width:100%;
                box-sizing:border-box;
                overflow:hidden;
                resize:none;
            }
            @media (max-width: 700px){
                .container{ padding: 12px !important; }
                h1{ font-size: 1.6rem !important; }
                .student-info{ padding: 10px !important; }
                table{ display:block; overflow-x:auto; }
            }
        </style><style>/* student-lock */
          .student-view .num-static{display:inline-block; min-width:64px; padding:6px 10px; border:2px solid #e74c3c; border-radius:8px; font-weight:800; color:#c0392b; background:#fff;}
          .student-view input, .student-view select{font-size:1em;}
        </style></head>
<body class="student-view" data-id-exercice="devoir_PAD_v2">


<div id="paste-toast"></div>
<div class="container">
<h1><span class="main-title-editable" contenteditable="false">Processus d'apparition d'un dommage<br></span></h1>
<div class="student-info">
                <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                    <div class="input-group">
                        <label>CODE :</label>
                        <input type="text" id="code-eleve" placeholder="Votre code" style="font-weight:bold; color:#2c3e50; background:#eef2f3; width:140px; text-align:center;">
                    </div>
                </div></div>
<div class="eval-section" id="eval-section-container">
<div class="eval-header">GRILLE D'√âVALUATION</div>
<table class="eval-table">
<thead>
<tr><th rowspan="2">Comp√©tences</th><th rowspan="2">Questions</th><th colspan="4">Niveau</th><th rowspan="2">Bar√®me</th><th rowspan="2">Points</th></tr>
<tr><th>NT</th><th>I</th><th>A</th><th>M</th></tr>
</thead>
<tbody id="grid-body"><tr><td><b>C2</b></td><td>1, 2, 3, 4, 5</td><td></td><td></td><td></td><td></td><td>10</td><td style="color:#2980b9; font-weight:bold;"><span class="print-only">......</span></td></tr><tr><td><b>C4</b></td><td>1.1, 2.1, 3.1, 4.1, 6</td><td></td><td></td><td></td><td></td><td>10</td><td style="color:#2980b9; font-weight:bold;"><span class="print-only">......</span></td></tr></tbody>
<tbody>
<tr class="row-c6">
<td><b>C6</b></td>
<td class="c6-text-editable" contenteditable="false">Communication</td>
<td><input type="checkbox" value="on"></td><td><input type="checkbox" value="on"></td><td><input type="checkbox" value="on"></td><td><input type="checkbox" value="on"></td>
<td style="display:flex; align-items:center; justify-content:center;">
<input class="point-input-c6" id="c6-score" min="0" oninput="updateGrid()" placeholder="Pts" step="0.5" type="number" value="0" style="background-color: white;">

<input class="point-input-c6" id="c6-max" min="0" oninput="updateGrid()" step="0.5" type="number" value="0">
<span class="print-only" id="c6-print-span">0</span>
</td>
<td id="c6-display-score" style="font-weight:bold;"><span class="print-only">......</span></td>
</tr>
</tbody>
<tfoot>
<tr style="border-top: 2px solid #000;">
<td colspan="6">
<div style="display:flex; justify-content:space-between; align-items:center;">
<div class="legend-inline">
<b>L√©gende :</b> <b>NT</b>: Non Trait√© | <b>I</b>: Insuffisant | <b>A</b>: Acceptable | <b>M</b>: Ma√Ætris√©
                            </div>
<span style="font-weight: bold; font-size:1.1em;">TOTAL :</span>
</div>
</td>
<td id="total-bareme" style="font-weight: bold;">/ 20</td>
<td id="total-obtenu" style="font-weight: bold; color: #2980b9;"><span class="print-only">......</span></td>
</tr>
</tfoot>
</table>
<div class="general-comment-box">
<span class="general-comment-label">üìù Appr√©ciation G√©n√©rale :</span>
<textarea class="general-comment-area" placeholder="Commentaire global sur le devoir..."></textarea>
</div>
</div>
<br><hr><br>
<div class="questions-container" id="questions-container">
<!-- Devoir vierge - Utilisez les boutons ci-dessous pour ajouter du contenu -->
<div class="text-block">
            
            <div class="doc-title" contenteditable="false" style="margin-bottom: 15px;">&nbsp;RISQUE ELECTRIQUE - SECTEUR INDUSTRIEL</div>
            <div class="consigne-simple" contenteditable="false">Robert, agent de maintenance, intervient sur une cha√Æne de fabrication en panne.<div>Il utilise une baladeuse dont le fil est d√©nud√© pour changer une pi√®ce d√©fectueuse.</div><div>Sa main glisse sur le fil d√©nud√© et il ressent une vive br√ªlure √† la main.</div></div>
        </div><div class="question-block" id="qc-1">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">1</span></div>
            <div class="editable-text" contenteditable="false">Apr√®s avoir identifi√© dans l‚Äôactivit√© de travail Robert, les √©l√©ments du processus<div>d‚Äôapparition d‚Äôun dommage, proposer une repr√©sentation mettant en lien ces √©l√©ments</div></div>
        </div>
        <div class="exo-container">
            <div class="pad-wrap">
                <!-- Ligne du haut : Situation dangereuse + √âv√©nement d√©clencheur -->
                <div class="pad-row-top">
                    <div class="pad-box pad-situation">
                        <div class="pad-box-title">Situation dangereuse</div>
                        <textarea class="reponse-eleve" placeholder="D√©crire la situation dangereuse..." data-qid="q_0_sd"></textarea>
                    </div>
                    <div class="pad-box pad-evenement">
                        <div class="pad-box-title">√âv√©nement d√©clencheur</div>
                        <textarea class="reponse-eleve" placeholder="Quel √©v√©nement d√©clenche le dommage ?" data-qid="q_0_ed"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®ches vers le bas -->
                <div style="display:flex; justify-content:space-around; margin:8px 0;">
                    <div class="pad-arrow">‚Üì</div>
                    <div class="pad-arrow">‚Üì</div>
                </div>
                
                <!-- Ligne du milieu : Danger + Interaction + Op√©rateur -->
                <div class="pad-row-middle">
                    <div class="pad-box pad-danger">
                        <div class="pad-box-title">Danger</div>
                        <textarea class="reponse-eleve" placeholder="Identifier le danger..." style="width:90%;min-height:50px;" data-qid="q_0_danger"></textarea>
                    </div>
                    <div class="pad-interaction">‚ö°</div>
                    <div class="pad-box pad-operateur">
                        <div class="pad-box-title">Op√©rateur</div>
                        <textarea class="reponse-eleve" placeholder="Qui est expos√© ?" style="width:90%;min-height:50px;" data-qid="q_0_operateur"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®che vers le bas -->
                <div style="display:flex; justify-content:center; margin:8px 0;">
                    <div class="pad-arrow" style="color:#ef5350;font-size:32px;">‚Üì</div>
                </div>
                
                <!-- Ligne du bas : Dommage potentiel -->
                <div class="pad-row-bottom">
                    <div class="pad-box pad-dommage">
                        <div class="pad-box-title">Dommage potentiel</div>
                        <textarea class="reponse-eleve" placeholder="Quelle blessure ou atteinte √† la sant√© peut survenir ?" data-qid="q_0_dom"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
    </div><div class="question-block" id="qc-2">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">1.1</span></div>
            <div class="editable-text" contenteditable="false">Proposer des mesures de pr√©vention pour le danger identifi√©</div>
        </div>
        <div class="exo-container">
          <div class="prevention-wrap">
            <div class="prevention-objectif">Objectif : aller du plus efficace au moins efficace.</div>
            <table class="prevention-table" role="table" aria-label="Mesures de pr√©vention">
              <thead>
                <tr>
                  <th class="col-type">Type de mesure</th>
                  <th>Mesures propos√©es</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-type">Supprimer ou r√©duire le risque</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_1"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection collective</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_1"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection individuelle</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_1"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Information / formation</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_1"></textarea></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        
    </div><div class="text-block">
            
            <div class="doc-title" contenteditable="false" style="margin-bottom: 15px;">RISQUE MECANIQUE - SECTEUR INDUSTRIEL</div>
            <div class="consigne-simple" contenteditable="false">Pierre, √©l√®ve de 1re ann√©e CAP m√©tallerie, usine une pi√®ce m√©tallique √† l‚Äôaide d‚Äôune plieuse sans carter de protection et avec des dispositifs de s√©curit√© absents. Sa main passe dans la machine et ses doigts sont √©cras√©s.<div><br></div></div>
        </div><div class="question-block" id="qc-3">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">2</span></div>
            <div class="editable-text" contenteditable="false">Apr√®s avoir identifi√© dans l‚Äôactivit√© de travail Pierre, les √©l√©ments du processus<div>d‚Äôapparition d‚Äôun dommage, proposer une repr√©sentation mettant en lien ces √©l√©ments</div></div>
        </div>
        <div class="exo-container">
            <div class="pad-wrap">
                <!-- Ligne du haut : Situation dangereuse + √âv√©nement d√©clencheur -->
                <div class="pad-row-top">
                    <div class="pad-box pad-situation">
                        <div class="pad-box-title">Situation dangereuse</div>
                        <textarea class="reponse-eleve" placeholder="D√©crire la situation dangereuse..." data-qid="q_2"></textarea>
                    </div>
                    <div class="pad-box pad-evenement">
                        <div class="pad-box-title">√âv√©nement d√©clencheur</div>
                        <textarea class="reponse-eleve" placeholder="Quel √©v√©nement d√©clenche le dommage ?" data-qid="q_2"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®ches vers le bas -->
                <div style="display:flex; justify-content:space-around; margin:8px 0;">
                    <div class="pad-arrow">‚Üì</div>
                    <div class="pad-arrow">‚Üì</div>
                </div>
                
                <!-- Ligne du milieu : Danger + Interaction + Op√©rateur -->
                <div class="pad-row-middle">
                    <div class="pad-box pad-danger">
                        <div class="pad-box-title">Danger</div>
                        <textarea class="reponse-eleve" placeholder="Identifier le danger..." style="width:90%;min-height:50px;" data-qid="q_2"></textarea>
                    </div>
                    <div class="pad-interaction">‚ö°</div>
                    <div class="pad-box pad-operateur">
                        <div class="pad-box-title">Op√©rateur</div>
                        <textarea class="reponse-eleve" placeholder="Qui est expos√© ?" style="width:90%;min-height:50px;" data-qid="q_2"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®che vers le bas -->
                <div style="display:flex; justify-content:center; margin:8px 0;">
                    <div class="pad-arrow" style="color:#ef5350;font-size:32px;">‚Üì</div>
                </div>
                
                <!-- Ligne du bas : Dommage potentiel -->
                <div class="pad-row-bottom">
                    <div class="pad-box pad-dommage">
                        <div class="pad-box-title">Dommage potentiel</div>
                        <textarea class="reponse-eleve" placeholder="Quelle blessure ou atteinte √† la sant√© peut survenir ?" data-qid="q_2"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
    </div><div class="question-block" id="qc-4">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">2.1</span></div>
            <div class="editable-text" contenteditable="false">Proposer des mesures de pr√©vention pour le danger identifi√©</div>
        </div>
        <div class="exo-container">
          <div class="prevention-wrap">
            <div class="prevention-objectif">Objectif : aller du plus efficace au moins efficace.</div>
            <table class="prevention-table" role="table" aria-label="Mesures de pr√©vention">
              <thead>
                <tr>
                  <th class="col-type">Type de mesure</th>
                  <th>Mesures propos√©es</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-type">Supprimer ou r√©duire le risque</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_3_source"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection collective</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_3_collectif"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection individuelle</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_3_individuel"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Information / formation</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_3_info"></textarea></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        
    </div><div class="text-block">
            
            <div class="doc-title" contenteditable="false" style="margin-bottom: 15px;">RISQUE CHIMIQUE - SECTEUR SANITAIRE</div>
            <div class="consigne-simple" contenteditable="false">Sandra, √©l√®ve de seconde BEP Carri√®res sanitaires et sociales, effectue sa PFE (p√©riode de formation en entreprise) dans un EHPAD (√©tablissement d‚Äôh√©bergement pour personnes √¢g√©es d√©pendantes). Lors de l‚Äôentretien des sanitaires, elle m√©lange un d√©tartrant et de l‚Äôeau de Javel. Des vapeurs toxiques se d√©gagent : ses yeux piquent, sa gorge br√ªle, elle tousse et elle perd connaissance.</div>
        </div><div class="question-block" id="qc-5">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">3</span></div>
            <div class="editable-text" contenteditable="false">Apr√®s avoir identifi√© dans l‚Äôactivit√© de travail Sandra, les √©l√©ments du processus<div>d‚Äôapparition d‚Äôun dommage, proposer une repr√©sentation mettant en lien ces √©l√©ments</div></div>
        </div>
        <div class="exo-container">
            <div class="pad-wrap">
                <!-- Ligne du haut : Situation dangereuse + √âv√©nement d√©clencheur -->
                <div class="pad-row-top">
                    <div class="pad-box pad-situation">
                        <div class="pad-box-title">Situation dangereuse</div>
                        <textarea class="reponse-eleve" placeholder="D√©crire la situation dangereuse..." data-qid="q_4"></textarea>
                    </div>
                    <div class="pad-box pad-evenement">
                        <div class="pad-box-title">√âv√©nement d√©clencheur</div>
                        <textarea class="reponse-eleve" placeholder="Quel √©v√©nement d√©clenche le dommage ?" data-qid="q_4"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®ches vers le bas -->
                <div style="display:flex; justify-content:space-around; margin:8px 0;">
                    <div class="pad-arrow">‚Üì</div>
                    <div class="pad-arrow">‚Üì</div>
                </div>
                
                <!-- Ligne du milieu : Danger + Interaction + Op√©rateur -->
                <div class="pad-row-middle">
                    <div class="pad-box pad-danger">
                        <div class="pad-box-title">Danger</div>
                        <textarea class="reponse-eleve" placeholder="Identifier le danger..." style="width:90%;min-height:50px;" data-qid="q_4"></textarea>
                    </div>
                    <div class="pad-interaction">‚ö°</div>
                    <div class="pad-box pad-operateur">
                        <div class="pad-box-title">Op√©rateur</div>
                        <textarea class="reponse-eleve" placeholder="Qui est expos√© ?" style="width:90%;min-height:50px;" data-qid="q_4"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®che vers le bas -->
                <div style="display:flex; justify-content:center; margin:8px 0;">
                    <div class="pad-arrow" style="color:#ef5350;font-size:32px;">‚Üì</div>
                </div>
                
                <!-- Ligne du bas : Dommage potentiel -->
                <div class="pad-row-bottom">
                    <div class="pad-box pad-dommage">
                        <div class="pad-box-title">Dommage potentiel</div>
                        <textarea class="reponse-eleve" placeholder="Quelle blessure ou atteinte √† la sant√© peut survenir ?" data-qid="q_4"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
    </div><div class="question-block" id="qc-6">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">3.1</span></div>
            <div class="editable-text" contenteditable="false">Proposer des mesures de pr√©vention</div>
        </div>
        <div class="exo-container">
          <div class="prevention-wrap">
            <div class="prevention-objectif">Objectif : aller du plus efficace au moins efficace.</div>
            <table class="prevention-table" role="table" aria-label="Mesures de pr√©vention">
              <thead>
                <tr>
                  <th class="col-type">Type de mesure</th>
                  <th>Mesures propos√©es</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-type">Supprimer ou r√©duire le risque</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_5"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection collective</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_5"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection individuelle</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_5"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Information / formation</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_5"></textarea></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        
    </div><div class="text-block">
            
            <div class="doc-title" contenteditable="false" style="margin-bottom: 15px;">RISQUE MECANIQUE - SECTEUR INDUSTRIE</div>
            <div class="consigne-simple" contenteditable="false">Fran√ßois soude une pi√®ce m√©tallique avec un poste √† souder. √Ä la fin du soudage, il soul√®ve la pi√®ce encore chaude √† mains nues. La pi√®ce √©tant br√ªlante, il se br√ªle la main.</div>
        </div><div class="question-block" id="qc-7">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">4</span></div>
            <div class="editable-text" contenteditable="false">Apr√®s avoir identifi√© dans l‚Äôactivit√© de travail Fran√ßois, les √©l√©ments du processus<div>d‚Äôapparition d‚Äôun dommage, proposer une repr√©sentation mettant en lien ces √©l√©ments&nbsp;</div></div>
        </div>
        <div class="exo-container">
            <div class="pad-wrap">
                <!-- Ligne du haut : Situation dangereuse + √âv√©nement d√©clencheur -->
                <div class="pad-row-top">
                    <div class="pad-box pad-situation">
                        <div class="pad-box-title">Situation dangereuse</div>
                        <textarea class="reponse-eleve" placeholder="D√©crire la situation dangereuse..." data-qid="q_6"></textarea>
                    </div>
                    <div class="pad-box pad-evenement">
                        <div class="pad-box-title">√âv√©nement d√©clencheur</div>
                        <textarea class="reponse-eleve" placeholder="Quel √©v√©nement d√©clenche le dommage ?" data-qid="q_6"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®ches vers le bas -->
                <div style="display:flex; justify-content:space-around; margin:8px 0;">
                    <div class="pad-arrow">‚Üì</div>
                    <div class="pad-arrow">‚Üì</div>
                </div>
                
                <!-- Ligne du milieu : Danger + Interaction + Op√©rateur -->
                <div class="pad-row-middle">
                    <div class="pad-box pad-danger">
                        <div class="pad-box-title">Danger</div>
                        <textarea class="reponse-eleve" placeholder="Identifier le danger..." style="width:90%;min-height:50px;" data-qid="q_6"></textarea>
                    </div>
                    <div class="pad-interaction">‚ö°</div>
                    <div class="pad-box pad-operateur">
                        <div class="pad-box-title">Op√©rateur</div>
                        <textarea class="reponse-eleve" placeholder="Qui est expos√© ?" style="width:90%;min-height:50px;" data-qid="q_6"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®che vers le bas -->
                <div style="display:flex; justify-content:center; margin:8px 0;">
                    <div class="pad-arrow" style="color:#ef5350;font-size:32px;">‚Üì</div>
                </div>
                
                <!-- Ligne du bas : Dommage potentiel -->
                <div class="pad-row-bottom">
                    <div class="pad-box pad-dommage">
                        <div class="pad-box-title">Dommage potentiel</div>
                        <textarea class="reponse-eleve" placeholder="Quelle blessure ou atteinte √† la sant√© peut survenir ?" data-qid="q_6"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
    </div><div class="question-block" id="qc-8">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">4.1</span></div>
            <div class="editable-text" contenteditable="false">Proposer des mesures de pr√©vention</div>
        </div>
        <div class="exo-container">
          <div class="prevention-wrap">
            <div class="prevention-objectif">Objectif : aller du plus efficace au moins efficace.</div>
            <table class="prevention-table" role="table" aria-label="Mesures de pr√©vention">
              <thead>
                <tr>
                  <th class="col-type">Type de mesure</th>
                  <th>Mesures propos√©es</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-type">Supprimer ou r√©duire le risque</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_7"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection collective</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_7"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection individuelle</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_7"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Information / formation</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_7"></textarea></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        
    </div><div class="text-block">
            
            <div class="doc-title" contenteditable="false" style="margin-bottom: 15px;">RISQUE ELECTRIQUE - SECTEUR ALIMENTAIRE</div>
            <div class="consigne-simple" contenteditable="false">Dans la l√©gumerie, Adrien √©mince des pommes de terre avec un robot-coupe dont le cordon est d√©nud√©.<div>Au cours du travail, l‚Äôappareil se bloque. Adrien tente de le d√©brancher en tirant sur le cordon. Sa main entre en contact avec le cordon d√©nud√©. Il re√ßoit une d√©charge √©lectrique et se br√ªle la main.</div><div><br></div></div>
        </div><div class="question-block" id="qc-9">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">5</span></div>
            <div class="editable-text" contenteditable="false">Apr√®s avoir identifi√© dans l‚Äôactivit√© de travail d'adrien, les √©l√©ments du processus<div>d‚Äôapparition d‚Äôun dommage, proposer une repr√©sentation mettant en lien ces √©l√©ments</div></div>
        </div>
        <div class="exo-container">
            <div class="pad-wrap">
                <!-- Ligne du haut : Situation dangereuse + √âv√©nement d√©clencheur -->
                <div class="pad-row-top">
                    <div class="pad-box pad-situation">
                        <div class="pad-box-title">Situation dangereuse</div>
                        <textarea class="reponse-eleve" placeholder="D√©crire la situation dangereuse..." data-qid="q_8"></textarea>
                    </div>
                    <div class="pad-box pad-evenement">
                        <div class="pad-box-title">√âv√©nement d√©clencheur</div>
                        <textarea class="reponse-eleve" placeholder="Quel √©v√©nement d√©clenche le dommage ?" data-qid="q_8"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®ches vers le bas -->
                <div style="display:flex; justify-content:space-around; margin:8px 0;">
                    <div class="pad-arrow">‚Üì</div>
                    <div class="pad-arrow">‚Üì</div>
                </div>
                
                <!-- Ligne du milieu : Danger + Interaction + Op√©rateur -->
                <div class="pad-row-middle">
                    <div class="pad-box pad-danger">
                        <div class="pad-box-title">Danger</div>
                        <textarea class="reponse-eleve" placeholder="Identifier le danger..." style="width:90%;min-height:50px;" data-qid="q_8"></textarea>
                    </div>
                    <div class="pad-interaction">‚ö°</div>
                    <div class="pad-box pad-operateur">
                        <div class="pad-box-title">Op√©rateur</div>
                        <textarea class="reponse-eleve" placeholder="Qui est expos√© ?" style="width:90%;min-height:50px;" data-qid="q_8"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®che vers le bas -->
                <div style="display:flex; justify-content:center; margin:8px 0;">
                    <div class="pad-arrow" style="color:#ef5350;font-size:32px;">‚Üì</div>
                </div>
                
                <!-- Ligne du bas : Dommage potentiel -->
                <div class="pad-row-bottom">
                    <div class="pad-box pad-dommage">
                        <div class="pad-box-title">Dommage potentiel</div>
                        <textarea class="reponse-eleve" placeholder="Quelle blessure ou atteinte √† la sant√© peut survenir ?" style="height: 60px;" data-qid="q_8"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
    </div><div class="question-block" id="qc-10">
        
        
        <div class="q-content-row">
            <div class="num-selector-wrapper"><span class="num-display">6</span></div>
            <div class="editable-text" contenteditable="false">Proposer des mesures de pr√©vention</div>
        </div>
        <div class="exo-container">
          <div class="prevention-wrap">
            <div class="prevention-objectif">Objectif : aller du plus efficace au moins efficace.</div>
            <table class="prevention-table" role="table" aria-label="Mesures de pr√©vention">
              <thead>
                <tr>
                  <th class="col-type">Type de mesure</th>
                  <th>Mesures propos√©es</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-type">Supprimer ou r√©duire le risque</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_9"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection collective</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_9"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection individuelle</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_9"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Information / formation</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2" data-qid="q_9"></textarea></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        
    </div></div>

<button onclick="window.tenterEnvoi()" style="display: block; margin: 60px auto; padding: 15px 40px; background: rgb(39, 174, 96); color: white; border: medium; border-radius: 50px; cursor: pointer; font-size: 1.3em; font-weight: bold;">Envoyer au prof üì§</button></div>
<div id="qc-modal" style="display: none; position: fixed; inset: 0px; background: rgba(0, 0, 0, 0.55); z-index: 20000; padding: 20px; box-sizing: border-box;">
<div style="max-width:900px; margin:40px auto; background:white; border-radius:12px; padding:16px 16px 10px 16px; box-shadow:0 10px 30px rgba(0,0,0,0.35);">
<div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
<div style="font-weight:800; color:#2c3e50; font-size:1.1em;">Contr√¥le rapide du devoir</div>
<button style="border:none; background:#e74c3c; color:white; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;">Fermer</button>
</div>
<div id="qc-summary" style="padding:10px; background:#f8f9fa; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:10px;"><b>6</b> point(s) √† v√©rifier.</div>
<ol id="qc-list" style="margin:0; padding-left:20px; max-height:55vh; overflow:auto;"><li style="margin: 6px 0px;"><a href="#" style="color:#2980b9; text-decoration:none; font-weight:600;">Total bar√®me = 22 (info).</a></li><li style="margin: 6px 0px;"><a href="#" style="color:#2980b9; text-decoration:none; font-weight:600;">1 : la consigne ne commence pas clairement par un verbe d‚Äôaction (d√©but : apr√®s).</a></li><li style="margin: 6px 0px;"><a href="#" style="color:#2980b9; text-decoration:none; font-weight:600;">2 : la consigne ne commence pas clairement par un verbe d‚Äôaction (d√©but : apr√®s).</a></li><li style="margin: 6px 0px;"><a href="#" style="color:#2980b9; text-decoration:none; font-weight:600;">3 : la consigne ne commence pas clairement par un verbe d‚Äôaction (d√©but : apr√®s).</a></li><li style="margin: 6px 0px;"><a href="#" style="color:#2980b9; text-decoration:none; font-weight:600;">4 : la consigne ne commence pas clairement par un verbe d‚Äôaction (d√©but : apr√®s).</a></li><li style="margin: 6px 0px;"><a href="#" style="color:#2980b9; text-decoration:none; font-weight:600;">5 : la consigne ne commence pas clairement par un verbe d‚Äôaction (d√©but : apr√®s).</a></li></ol>
<div style="margin-top:10px; font-size:0.9em; color:#555;">
      Astuce : clique sur une alerte pour aller directement √† la question concern√©e.
    </div>
</div>
</div>
<script>
    document.addEventListener('paste', function (e) {
        if (e.target && e.target.isContentEditable) {
            e.preventDefault();
            const cd = e.clipboardData || (e.originalEvent && e.originalEvent.clipboardData);
            const text = cd ? cd.getData('text/plain') : '';
            document.execCommand('insertText', false, text);
        }
    });

    let isTeacherMode = true; 
    let currentImgContainer = null;
    // --- GESTION IMAGE (MODE ORGANISE) ---
    function triggerImgUpload(container) {
        const nom = prompt("Nom du fichier image (ex: schema.jpg) ?\n\nIMPORTANT : L'image devra √™tre plac√©e dans le dossier 'images' situ√© √† c√¥t√© de votre fichier devoir.", "");
        if (nom) {
            const img = container.querySelector('img');
            if (img) img.src = 'images/' + nom.trim();
        }
    }

    const toolbar = document.getElementById('rich-format-toolbar');

    document.addEventListener('selectionchange', () => {
        if (!isTeacherMode) return; 
        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) { toolbar.style.display = 'none'; return; }
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        let parent = range.commonAncestorContainer.parentElement;
        let isEditable = false;
        while (parent) { if (parent.isContentEditable) { isEditable = true; break; } parent = parent.parentElement; }
        if (isEditable && rect.width > 0) {
            toolbar.style.display = 'flex';
            toolbar.style.top = (rect.top + window.scrollY - 50) + 'px';
            toolbar.style.left = (rect.left + window.scrollX + (rect.width / 2) - (toolbar.offsetWidth / 2)) + 'px';
        } else { toolbar.style.display = 'none'; }
    });
    
    toolbar.addEventListener('mousedown', (e) => { e.preventDefault(); });
    function formatDoc(cmd, value) { document.execCommand(cmd, false, value); }

    // --- UTIL : conversion robuste (ex: '2,5' -> 2.5) ---
    function parseNumber(v){
        if(v===null || v===undefined) return NaN;
        if(typeof v==='number') return v;
        const s = String(v).trim().replace(',', '.');
        if(!s) return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
    }


    function moveUp(btn) {
        const block = btn.closest('.question-block') || btn.closest('.doc-block') || btn.closest('.text-block') || btn.closest('.numbered-header') || btn.closest('.section-block');
        if (block && block.previousElementSibling) { block.parentNode.insertBefore(block, block.previousElementSibling); }
    }

    function moveDown(btn) {
        const block = btn.closest('.question-block') || btn.closest('.doc-block') || btn.closest('.text-block') || btn.closest('.numbered-header') || btn.closest('.section-block');
        if (block && block.nextElementSibling) { block.parentNode.insertBefore(block.nextElementSibling, block); }
    }

function qqRowHTML(label) {
    return `<tr>
        <td>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <span class="question-bold" contenteditable="true">${label}</span>
                <button class="btn-del-q teacher-controls" style="position:static;" onclick="qqRemoveRow(this)">‚úñ</button>
            </div>
        </td>
        <td><textarea class="reponse-eleve"></textarea></td>
    </tr>`;
}
function qqAddRow(btn) {
    const table = btn.closest('.exo-container').querySelector('table.exo-table');
    if(!table) return;
    const tmp = document.createElement('tbody');
    tmp.innerHTML = qqRowHTML("Nouvelle ligne");
    const tr = tmp.querySelector('tr');
    table.appendChild(tr);
    const tx = tr.querySelector('textarea');
    if(tx) {
        tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; });
        tx.dispatchEvent(new Event('input'));
    }
    updateGrid();
}
function qqRemoveRow(btn) {
    const tr = btn.closest('tr');
    if(tr) tr.remove();
    updateGrid();
}


    // ‚≠ê NOUVEAU : Calcul automatique du prochain num√©ro de question
    function getNextQuestionNumber() {
        const allSelectors = document.querySelectorAll('.question-block .num-selector');
        if (allSelectors.length === 0) return "1";
        
        let maxMainNum = 0;
        allSelectors.forEach(sel => {
            const val = sel.value || "";
            // Extraire le num√©ro principal (partie avant le point)
            const mainNum = parseInt(val.split('.')[0]) || 0;
            if (mainNum > maxMainNum) maxMainNum = mainNum;
        });
        
        return String(maxMainNum + 1);
    }

    function initSelects(parent, useAutoNumber = false) {
        let numOptionsHTML = "";
        for (let i = 1; i <= 20; i++) {
            numOptionsHTML += `<option value="${i}">${i}</option>`;
            for (let j = 1; j <= 10; j++) { numOptionsHTML += `<option value="${i}.${j}">${i}.${j}</option>`; }
        }
        let compOptionsHTML = "";
        for (let c = 1; c <= 6; c++) { compOptionsHTML += `<option value="C${c}">C${c}</option>`; }

        parent.querySelectorAll('.num-selector').forEach(s => { 
            // V√©rifier si c'est un nouveau select (pas d'options encore)
            const isNewSelect = !s.querySelector('option');
            
            if(isNewSelect) {
                s.innerHTML = numOptionsHTML;
                
                // ‚≠ê NUM√âROTATION AUTOMATIQUE pour les nouveaux selects
                const existingQuestions = document.querySelectorAll('.question-block .num-selector');
                let maxNum = 0;
                existingQuestions.forEach(sel => {
                    // Ne pas se compter soi-m√™me
                    if (sel === s) return;
                    const val = sel.value || "";
                    if (!val) return;
                    const num = parseInt(val.split('.')[0]) || 0;
                    if (num > maxNum) maxNum = num;
                });
                const nextNum = maxNum + 1;
                s.value = String(nextNum);
            }
            
            s.addEventListener('change', updateGrid);
        });
        parent.querySelectorAll('.comp-selector').forEach(s => { 
            if(!s.querySelector('option')) s.innerHTML = compOptionsHTML;
            if(s.dataset.selected) s.value = s.dataset.selected;
            s.addEventListener('change', updateGrid);
        });
        parent.querySelectorAll('.point-input').forEach(i => i.addEventListener('input', updateGrid));
        parent.querySelectorAll('.student-score').forEach(i => i.addEventListener('input', updateGrid)); 
    }

    function getControlButtonsHTML() {
        return `<div class="block-controls teacher-controls"><button class="btn-move" data-action="moveUp">‚¨ÜÔ∏è</button><button class="btn-move" data-action="moveDown">‚¨áÔ∏è</button><button class="btn-del-q" data-action="remove">‚úñ</button></div>`;
    }
    function getControlButtonsHTMLTitle() {
        return `<div class="block-controls teacher-controls"><button class="btn-move" data-action="moveUp">‚¨ÜÔ∏è</button><button class="btn-move" data-action="moveDown">‚¨áÔ∏è</button><button class="btn-del-q" data-action="removeBlock">‚úñ</button></div>`;
    }
    function getControlButtonsHTMLSimple() {
        return `<div class="block-controls teacher-controls"><button class="btn-move" data-action="moveUp">‚¨ÜÔ∏è</button><button class="btn-move" data-action="moveDown">‚¨áÔ∏è</button><button class="btn-del-q" data-action="removeBlock">‚úñ</button></div>`;
    }

    // Fonction pour attacher les √©v√©nements aux boutons de contr√¥le
    function attachBlockEvents(block) {
        block.querySelectorAll('[data-action]').forEach(btn => {
            const action = btn.getAttribute('data-action');
            btn.onclick = null; // Retirer ancien √©v√©nement
            
            if (action === 'moveUp') {
                btn.addEventListener('click', function() { moveUp(this); });
            } else if (action === 'moveDown') {
                btn.addEventListener('click', function() { moveDown(this); });
            } else if (action === 'remove') {
                btn.addEventListener('click', function() { removeQuestion(this); });
            } else if (action === 'removeBlock') {
                btn.addEventListener('click', function() {
                    const block = this.closest('.text-block') || this.closest('.section-block') || this.closest('.doc-block') || this.closest('.numbered-header');
                    if (block && confirm("Supprimer ce bloc ?")) {
                        block.remove();
                        updateGrid();
                    }
                });
            }
        });
    }

    // ‚≠ê AUTO-ATTACHER les √©v√©nements sur TOUS les nouveaux blocs
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.querySelector('.questions-container');
        if (!container) return;
        
        // Observer pour d√©tecter les nouveaux blocs ajout√©s
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.classList) {
                        // Si c'est un bloc avec des boutons de contr√¥le
                        if (node.querySelector && node.querySelector('[data-action]')) {
                            attachBlockEvents(node);
                        }
                    }
                });
            });
        });
        
        // Observer le container
        observer.observe(container, { childList: true, subtree: false });
        
        // Attacher les √©v√©nements aux blocs existants
        container.querySelectorAll('.question-block, .doc-block, .text-block, .section-block, .numbered-header').forEach(block => {
            attachBlockEvents(block);
        });
    });

    function addSectionTitle(btn) {
        const container = document.querySelector('.questions-container');
        const div = document.createElement('div'); div.className = 'section-block';
        div.innerHTML = `${getControlButtonsHTMLTitle()}<input class="section-title-editable" value="ANALYSER LA SITUATION" placeholder="Titre de section">`;
        container.appendChild(div);
    }

    function addNumberedTitle(btn) {
        const container = document.querySelector('.questions-container');
        const div = document.createElement('div'); div.className = 'text-block numbered-header';
        div.innerHTML = `${getControlButtonsHTMLTitle()}<div class="num-box" contenteditable="true">1</div><div class="text-box" contenteditable="true">√Ä partir du document... (Titre de la partie)</div>`;
        container.appendChild(div);
    }

    function addQuestion(btn) {
        const container = document.querySelector('.questions-container');
        const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `
            ${getControlButtonsHTML()}
            <div class="q-meta-bar">
                <div class="points-wrapper">
                    <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                    <span class="teacher-part">/</span> 
                    <input type="number" class="point-input" value="1" step="0.5" oninput="updateGrid()"> 
                    <span class="teacher-part">pts (</span>
                    <select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select>
                    <span class="teacher-part">)</span>
                    <span class="print-only-grade"></span>
                </div>
            </div>
            <div class="q-content-row">
                <div class="num-selector-wrapper"><select class="num-selector"></select></div>
                <div class="editable-text" contenteditable="true">Question...</div>
            </div>
            <div class="exo-container"><textarea class="reponse-eleve"></textarea></div>
            <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>
        `;
        container.appendChild(div); 
        attachBlockEvents(div); // ‚Üê AJOUT
        initSelects(div, true); 
        updateGrid(); 
        div.querySelectorAll('textarea').forEach(tx => { 
            tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; }); 
        });
    }

    function addSimpleDoc(btn) {
        const container = document.querySelector('.questions-container');
        const div = document.createElement('div'); div.className = 'doc-block';
        div.innerHTML = `${getControlButtonsHTMLSimple()}<div class="doc-title" contenteditable="true">Document X : Titre...</div><div class="img-container" onclick="triggerImgUpload(this)"><img src="data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='600'%20height='200'%3E%3Crect%20width='100%25'%20height='100%25'%20fill='%23f1f5f9'/%3E%3Ctext%20x='50%25'%20y='50%25'%20dominant-baseline='middle'%20text-anchor='middle'%20fill='%2364748b'%20font-size='22'%3ECliquez%20pour%20ajouter%20une%20image%3C/text%3E%3C/svg%3E" alt="Doc"></div>`;
        container.appendChild(div);
    }
    
    function addSimpleText(btn) {
        const container = document.querySelector('.questions-container');
        const div = document.createElement('div'); div.className = 'text-block';
        div.innerHTML = `${getControlButtonsHTMLSimple()}<div class="consigne-simple" contenteditable="true">√âcrivez ici votre consigne ou votre texte de transition...</div>`;
        container.appendChild(div);
    }

    function addTitreSeul(btn) {
        const container = document.querySelector('.questions-container');
        const div = document.createElement('div');
        div.className = 'numbered-header';
        div.innerHTML = `${getControlButtonsHTMLSimple()}<div class="num-box" contenteditable="true">üìå</div><div class="text-box" contenteditable="true">Titre de section...</div>`;
        container.appendChild(div);
    }

    function addTexteAvecTitre(btn) {
        const container = document.querySelector('.questions-container');
        const div = document.createElement('div');
        div.className = 'text-block';
        div.innerHTML = `
            ${getControlButtonsHTMLSimple()}
            <div class="doc-title" contenteditable="true" style="margin-bottom: 15px;">üìù Titre du texte...</div>
            <div class="consigne-simple" contenteditable="true">Votre texte ici...</div>
        `;
        container.appendChild(div);
    }

    function addTableQuestion(btn) {
    const container = document.querySelector('.questions-container');
    const div = document.createElement('div');
    div.className = 'question-block';
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span>
                <input type="number" class="point-input" value="2" step="0.5" oninput="updateGrid()">
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true">Compl√©ter le tableau d'analyse.</div>
        </div>
        <div class="exo-container">
            <table class="exo-table qqoqcp-table">
                ${qqRowHTML("Quoi ?")}
                ${qqRowHTML("Qui ?")}
                ${qqRowHTML("O√π ?")}
                ${qqRowHTML("Quand ?")}
                ${qqRowHTML("Comment ?")}
                ${qqRowHTML("Pourquoi ?")}
            </table>
            <div class="teacher-controls" style="margin-top:10px; text-align:center;">
                <button class="btn-add-q" style="background:#34495e;" onclick="qqAddRow(this)">+ Ligne</button>
            </div>
        </div>
        
        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>

    `;
    container.appendChild(div);
    initSelects(div, true);
    updateGrid();

    div.querySelectorAll('textarea').forEach(tx => {
        tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; });
        tx.dispatchEvent(new Event('input'));
    });
}


// --- INIT MATRICE RISQUE ---
function initRiskMatrix(scope){
  try {
    const root = scope || document;
    root.querySelectorAll('.risk-matrix-wrap, .risk-matrix-wrap *').forEach(()=>{}); // no-op: compat
    root.querySelectorAll('.risk-matrix-wrap, .risk-matrix-wrap').forEach(()=>{}); // no-op
    root.querySelectorAll('.risk-matrix-wrap').forEach(wrap => {
      const hidden = wrap.querySelector('.risk-cell-value');
      const displayDiv = wrap.querySelector('.risk-selection-display');
      const displayText = wrap.querySelector('.risk-selection-text');
      const cells = Array.from(wrap.querySelectorAll('.risk-cell'));
      if(!cells.length) return;

      // Fonction pour convertir data-pos en texte lisible
      function posToText(pos) {
        if (!pos) return '';
        const [prob, grav] = pos.split('-');
        const probTexts = {
          'P1': 'Tr√®s improbable',
          'P2': 'Improbable',
          'P3': 'Probable',
          'P4': 'Tr√®s probable'
        };
        const gravTexts = {
          'G1': 'Faible',
          'G2': 'Moyen',
          'G3': 'Grave',
          'G4': 'Tr√®s grave'
        };
        return `${probTexts[prob] || prob} + ${gravTexts[grav] || grav}`;
      }

      function applySelection(cell){
        cells.forEach(c => c.classList.remove('selected'));
        cell.classList.add('selected');
        const pos = cell.getAttribute('data-pos') || '';
        if(hidden) hidden.value = pos;

        // Afficher le texte de s√©lection
        if(displayDiv && displayText) {
          displayDiv.style.display = 'block';
          displayText.textContent = posToText(pos);
        }

        // Auto-d√©cision selon zone
        const isPrio = cell.classList.contains('zone-prioritaire');
        const wanted = isPrio ? 'prioritaire' : 'non_prioritaire';
        const radio = wrap.querySelector('input[type="radio"][value="' + wanted + '"]');
        if(radio) radio.checked = true;
      }

      // Restauration si d√©j√† une valeur
      if(hidden && hidden.value){
        const prev = cells.find(c => (c.getAttribute('data-pos')||'') === hidden.value);
        if(prev) applySelection(prev);
      }

      cells.forEach(cell => {
        cell.setAttribute('tabindex','0');
        cell.setAttribute('role','gridcell');
        cell.addEventListener('click', () => applySelection(cell));
        cell.addEventListener('keydown', (e) => {
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); applySelection(cell); }
        });
      });
    });
  } catch(e){
    console.warn('initRiskMatrix warning', e);
  }
}

function addITAMaMi(btn) {
    const container = document.querySelector('.questions-container');
    const div = document.createElement('div'); 
    div.className = 'question-block';
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span> 
                <input type="number" class="point-input" value="3" step="0.5" oninput="updateGrid()"> 
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true">Compl√©ter le tableau ITAMaMi.</div>
        </div>
        <div class="exo-container">
            <table class="analysis-table">
                <tr><th><div style="display:flex; align-items:center; justify-content:space-between; gap:8px;"><span class="analysis-label-editable" contenteditable="true">Individu</span><button class="btn-del-q teacher-controls" style="position:static;" onclick="removeAnalysisRow(this)">‚úñ</button></div><div style="font-size:0.9em; color:#666;">Qui est l‚Äôop√©rateur ? Quelles caract√©ristiques ?</div></th><td><textarea class="reponse-eleve"></textarea></td></tr>
                <tr><th><div style="display:flex; align-items:center; justify-content:space-between; gap:8px;"><span class="analysis-label-editable" contenteditable="true">T√¢che</span><button class="btn-del-q teacher-controls" style="position:static;" onclick="removeAnalysisRow(this)">‚úñ</button></div><div style="font-size:0.9em; color:#666;">Quel travail demand√© ?</div></th><td><textarea class="reponse-eleve"></textarea></td></tr>
                <tr><th><div style="display:flex; align-items:center; justify-content:space-between; gap:8px;"><span class="analysis-label-editable" contenteditable="true">Activit√©</span><button class="btn-del-q teacher-controls" style="position:static;" onclick="removeAnalysisRow(this)">‚úñ</button></div><div style="font-size:0.9em; color:#666;">Comment le travail est r√©alis√© ?</div></th><td><textarea class="reponse-eleve"></textarea></td></tr>
                <tr><th><div style="display:flex; align-items:center; justify-content:space-between; gap:8px;"><span class="analysis-label-editable" contenteditable="true">Mat√©riel</span><button class="btn-del-q teacher-controls" style="position:static;" onclick="removeAnalysisRow(this)">‚úñ</button></div><div style="font-size:0.9em; color:#666;">Quels √©quipements utilis√©s ?</div></th><td><textarea class="reponse-eleve"></textarea></td></tr>
                <tr><th><div style="display:flex; align-items:center; justify-content:space-between; gap:8px;"><span class="analysis-label-editable" contenteditable="true">Milieu</span><button class="btn-del-q teacher-controls" style="position:static;" onclick="removeAnalysisRow(this)">‚úñ</button></div><div style="font-size:0.9em; color:#666;">O√π, quand, avec qui ?</div></th><td><textarea class="reponse-eleve"></textarea></td></tr>
            </table>
            <div class="teacher-controls" style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                <button class="btn-add-q" style="background:#16a085;" onclick="addAnalysisRow(this)">+ Ligne</button>
                <button class="btn-add-q" style="background:#e67e22;" onclick="itamamiToggleEffect(this)">Effet</button>
            </div>
        </div>
        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>
    `;
    container.appendChild(div); 
    initSelects(div, true); 
    updateGrid();
    div.querySelectorAll('textarea').forEach(tx => { 
        tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; }); 
    });
}

function addAnalysisRow(btn) {
    const wrap = btn.closest('.analysis-wrap') || btn.closest('.question-block') || document;
    const table = wrap.querySelector('table.analysis-table');
    if (!table) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <th style="display:flex;gap:8px;align-items:center;">
        <span contenteditable="true">Nouvelle entr√©e</span>
        <button class="btn-del-mini" type="button" onclick="removeAnalysisRow(this)">‚úñ</button>
      </th>
      <td><textarea class="reponse-eleve" placeholder="R√©ponse √©l√®ve..."></textarea></td>
    `;
    table.appendChild(tr);

    const tx = tr.querySelector('textarea');
    if (tx) {
        tx.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        setTimeout(() => {
            tx.style.height = 'auto';
            tx.style.height = tx.scrollHeight + 'px';
        }, 0);
    }
}

function removeAnalysisRow(btn) {
    const tr = btn.closest('tr');
    if (tr) tr.remove();
}

function itamamiToggleEffect(btn) {
    const exo = btn.closest('.question-block');
    if(!exo) return;
    const table = exo.querySelector('table.analysis-table');
    if(!table) return;
    const existing = table.querySelector('tr.itamami-effect-row');
    if(existing) {
        existing.remove();
        return;
    }
    const tr = document.createElement('tr');
    tr.className = 'itamami-effect-row';
    tr.innerHTML = `
        <th><span class="analysis-label-editable" contenteditable="true">Effet / Dommage</span><div style="font-size:0.9em; color:#666;">Quel r√©sultat / cons√©quence ?</div></th>
        <td><textarea class="reponse-eleve"></textarea></td>
    `;
    table.appendChild(tr);
    const tx = tr.querySelector('textarea');
    if(tx) tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; });
}

function addIshikawa(btn) {
    const container = document.querySelector('.questions-container');
    const div = document.createElement('div'); 
    div.className = 'question-block';
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span> 
                <input type="number" class="point-input" value="4" step="0.5" oninput="updateGrid()"> 
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true">Construire un diagramme d‚ÄôIshikawa : compl√©ter les causes par familles.</div>
        </div>
        <div class="exo-container">
            <div class="ishikawa-wrapper">
                <div class="ishikawa-tools teacher-controls">
                    <button class="btn-add-q" style="background:#c0392b;" onclick="ishAdd5M(this)">5M</button>
                    <button class="btn-add-q" style="background:#e67e22;" onclick="ishToggleEffect(this)">Effet</button>
                    <button class="btn-add-q" style="background:#3498db;" onclick="ishAddCategory(this)">+ Famille</button>
                </div>
                <div class="ishikawa-diagram">
                    <div class="ishikawa-row ish-top"></div>
                    <div class="ish-spine">
                        <div class="ish-line"></div>
                        <div class="ish-arrow"></div>
                        <div class="ish-effect-box" contenteditable="true">Effet (√† d√©finir)</div>
                    </div>
                    <div class="ishikawa-row ish-bottom"></div>
                </div>
            </div>
        </div>
        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>
    `;
    container.appendChild(div);
    initSelects(div, true);
    // Par d√©faut : 5M
    const exo = div.querySelector('.exo-container');
    const topRow = exo.querySelector('.ish-top');
    const bottomRow = exo.querySelector('.ish-bottom');
    const titles = ["Mati√®re", "Milieu", "Main-d'≈ìuvre", "Mat√©riel", "M√©thode"];
    titles.forEach((t, idx) => {
        const side = (idx % 2 === 0) ? 'top' : 'bottom';
        ishCreateCat(side === 'top' ? topRow : bottomRow, side, t);
    });
    updateGrid();
    div.querySelectorAll('textarea').forEach(tx => { 
        tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; }); 
    });
}

function ishCreateCat(rowEl, side, title) {
    const cat = document.createElement('div');
    cat.className = 'ish-cat';
    cat.dataset.side = side;
    cat.innerHTML = `
        <div class="ish-cat-title" contenteditable="true">${title}</div>
        <textarea class="reponse-eleve ish-cat-causes" placeholder="Causes (une par ligne)"></textarea>
        <div class="teacher-controls" style="margin-top:8px; display:flex; gap:8px; justify-content:center;">
            <button class="btn-del-q" style="position:static;" onclick="this.closest('.ish-cat').remove()">‚úñ</button>
            <button class="btn-add-q" style="background:#7f8c8d;" onclick="ishToggleSide(this)">‚áÖ</button>
        </div>
    `;
    rowEl.appendChild(cat);
}

function ishAddCategory(btn) {
    const wrapper = btn.closest('.ishikawa-wrapper');
    const topRow = wrapper.querySelector('.ish-top');
    const bottomRow = wrapper.querySelector('.ish-bottom');
    const toTop = (topRow.children.length <= bottomRow.children.length);
    ishCreateCat(toTop ? topRow : bottomRow, toTop ? 'top' : 'bottom', "Nouvelle famille");
}

function ishAdd5M(btn) {
    const wrapper = btn.closest('.ishikawa-wrapper');
    const topRow = wrapper.querySelector('.ish-top');
    const bottomRow = wrapper.querySelector('.ish-bottom');
    topRow.innerHTML = "";
    bottomRow.innerHTML = "";
    const titles = ["Mati√®re", "Milieu", "Main-d'≈ìuvre", "Mat√©riel", "M√©thode"];
    titles.forEach((t, idx) => {
        const side = (idx % 2 === 0) ? 'top' : 'bottom';
        ishCreateCat(side === 'top' ? topRow : bottomRow, side, t);
    });
}

function ishToggleSide(btn) {
    const cat = btn.closest('.ish-cat');
    const wrapper = btn.closest('.ishikawa-wrapper');
    const topRow = wrapper.querySelector('.ish-top');
    const bottomRow = wrapper.querySelector('.ish-bottom');
    const isTop = cat.dataset.side === 'top';
    cat.dataset.side = isTop ? 'bottom' : 'top';
    (isTop ? bottomRow : topRow).appendChild(cat);
}

function ishToggleEffect(btn) {
    const wrapper = btn.closest('.ishikawa-wrapper');
    if(!wrapper) return;
    wrapper.classList.toggle('ish-hide-effect');
}


// --- TABLEAUX RISQUES PRO (gravit√© / √©valuation / pr√©vention / sch√©ma ST2)

function addGraviteDommage(btn){
    const container = document.querySelector('.questions-container');
    const uid = Date.now();
    const div = document.createElement('div');
    div.className = 'question-block';
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span> 
                <input type="number" class="point-input" value="1" step="0.5" oninput="updateGrid()"> 
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C3" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true">Estimer la gravit√© du dommage.</div>
        </div>
        <div class="exo-container">
          <div class="risk-gravite-wrap">
            <div class="risk-gravite-choices">
              <label class="rg-choice"><input type="radio" name="grav_${uid}" value="1"> Faible (1)</label>
              <label class="rg-choice"><input type="radio" name="grav_${uid}" value="2"> Moyen (2)</label>
              <label class="rg-choice"><input type="radio" name="grav_${uid}" value="3"> Grave (3)</label>
              <label class="rg-choice"><input type="radio" name="grav_${uid}" value="4"> Tr√®s grave (4)</label>
            </div>

            <div class="risk-gravite-justif">
              <div class="rg-sub">Justification</div>
              <textarea class="reponse-eleve rg-textarea" rows="3"></textarea>
            </div>
          </div>
        </div>

        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>
    `;
    container.appendChild(div);
    initSelects(div, true);
    updateGrid();
    div.querySelectorAll('textarea').forEach(tx => { 
        tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; }); 
    });
}
function addEvaluationRisque(btn){
    const container = document.querySelector('.questions-container');
    const uid = Date.now();
    const div = document.createElement('div');
    div.className = 'question-block';
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span> 
                <input type="number" class="point-input" value="2" step="0.5" oninput="updateGrid()"> 
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C3" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true">√âvaluer le risque √† partir de la matrice.</div>
        </div>
        <div class="exo-container">
          <div class="risk-matrix-wrap">
            <div class="risk-matrix-legend" aria-label="L√©gende">
              <span class="legend-item"><span class="legend-swatch nonprioritaire"></span> R√©duction du risque non prioritaire</span>
              <span class="legend-item"><span class="legend-swatch prioritaire"></span> R√©duction du risque prioritaire</span>
            </div>
            <div class="risk-axis-label top">Niveau de gravit√© du dommage</div>
            <div class="risk-grid">
              <div class="risk-y-label">Niveau de probabilit√© d'occurrence du dommage</div>
              <table class="risk-matrix" role="grid" aria-label="Matrice d'√©valuation du risque">
                <thead>
                  <tr>
                    <th class="corner"></th>
                    <th>Faible (1)</th>
                    <th>Moyen (2)</th>
                    <th>Grave (3)</th>
                    <th>Tr√®s grave (4)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th>Tr√®s improbable (1)</th>
                    <td class="risk-cell zone-nonprioritaire" data-pos="P1-G1"></td>
                    <td class="risk-cell zone-nonprioritaire" data-pos="P1-G2"></td>
                    <td class="risk-cell zone-nonprioritaire" data-pos="P1-G3"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P1-G4"></td>
                  </tr>
                  <tr>
                    <th>Improbable (2)</th>
                    <td class="risk-cell zone-nonprioritaire" data-pos="P2-G1"></td>
                    <td class="risk-cell zone-nonprioritaire" data-pos="P2-G2"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P2-G3"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P2-G4"></td>
                  </tr>
                  <tr>
                    <th>Probable (3)</th>
                    <td class="risk-cell zone-nonprioritaire" data-pos="P3-G1"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P3-G2"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P3-G3"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P3-G4"></td>
                  </tr>
                  <tr>
                    <th>Tr√®s probable (4)</th>
                    <td class="risk-cell zone-prioritaire" data-pos="P4-G1"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P4-G2"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P4-G3"></td>
                    <td class="risk-cell zone-prioritaire" data-pos="P4-G4"></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <input type="hidden" class="risk-cell-value reponse-eleve" value="" />
            <div class="risk-selection-display" style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 0 8px 8px 0; display: none;">
              <strong style="color: #1e40af;">‚úì Votre s√©lection :</strong>
              <span class="risk-selection-text" style="color: #0f172a; font-weight: 600;"></span>
            </div>
            <div class="risk-decision">
              <div class="risk-decision-title">D√©cision (cocher une seule r√©ponse)</div>
              <label class="risk-decision-choice">
                <input type="radio" name="decision_${uid}" value="non_prioritaire">
                R√©duction du risque non prioritaire
              </label>
              <label class="risk-decision-choice">
                <input type="radio" name="decision_${uid}" value="prioritaire">
                R√©duction du risque prioritaire
              </label>
            </div>
          </div>
        </div>
        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>
    `;
    container.appendChild(div);
    initSelects(div, true);
    initRiskMatrix(div);
    updateGrid();
}

// --- PAD : Processus d'Apparition du Dommage ---
function addPAD(btn) {
    const container = document.querySelector('.questions-container');
    const div = document.createElement('div');
    div.className = 'question-block';
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span> 
                <input type="number" class="point-input" value="4" step="0.5" oninput="updateGrid()"> 
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true">Compl√©ter le sch√©ma du Processus d'Apparition du Dommage (PAD).</div>
        </div>
        <div class="exo-container">
            <div class="pad-wrap">
                <!-- Ligne du haut : Situation dangereuse + √âv√©nement d√©clencheur -->
                <div class="pad-row-top">
                    <div class="pad-box pad-situation">
                        <div class="pad-box-title">Situation dangereuse</div>
                        <textarea class="reponse-eleve" placeholder="D√©crire la situation dangereuse..."></textarea>
                    </div>
                    <div class="pad-box pad-evenement">
                        <div class="pad-box-title">√âv√©nement d√©clencheur</div>
                        <textarea class="reponse-eleve" placeholder="Quel √©v√©nement d√©clenche le dommage ?"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®ches vers le bas -->
                <div style="display:flex; justify-content:space-around; margin:8px 0;">
                    <div class="pad-arrow">‚Üì</div>
                    <div class="pad-arrow">‚Üì</div>
                </div>
                
                <!-- Ligne du milieu : Danger + Interaction + Op√©rateur -->
                <div class="pad-row-middle">
                    <div class="pad-box pad-danger">
                        <div class="pad-box-title">Danger</div>
                        <textarea class="reponse-eleve" placeholder="Identifier le danger..." style="width:90%;min-height:50px;"></textarea>
                    </div>
                    <div class="pad-interaction">‚ö°</div>
                    <div class="pad-box pad-operateur">
                        <div class="pad-box-title">Op√©rateur</div>
                        <textarea class="reponse-eleve" placeholder="Qui est expos√© ?" style="width:90%;min-height:50px;"></textarea>
                    </div>
                </div>
                
                <!-- Fl√®che vers le bas -->
                <div style="display:flex; justify-content:center; margin:8px 0;">
                    <div class="pad-arrow" style="color:#ef5350;font-size:32px;">‚Üì</div>
                </div>
                
                <!-- Ligne du bas : Dommage potentiel -->
                <div class="pad-row-bottom">
                    <div class="pad-box pad-dommage">
                        <div class="pad-box-title">Dommage potentiel</div>
                        <textarea class="reponse-eleve" placeholder="Quelle blessure ou atteinte √† la sant√© peut survenir ?"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu pour chaque champ du PAD..."></textarea>
        </div>
    `;
    container.appendChild(div);
    initSelects(div, true);
    updateGrid();
    // Auto-resize textareas
    div.querySelectorAll('textarea').forEach(tx => {
        tx.addEventListener('input', function(){ 
            this.style.height='auto'; 
            this.style.height=this.scrollHeight+'px'; 
        });
    });
}

window.addBlockToDoc = function(html, btn) {
    // S√©curisation : on cherche par ID ou par classe
    const container = document.getElementById("questions-container") || document.querySelector(".questions-container");
    
    if (!container) {
        alert("Erreur technique : Conteneur des questions introuvable.");
        return;
    }

    const temp = document.createElement("div");
    temp.innerHTML = (typeof html === "string") ? html.trim() : "";
    const el = temp.firstElementChild;
    
    if (el) {
        container.appendChild(el);
        // R√©initialiser les selecteurs et calculs si les fonctions existent
        if (typeof initSelects === 'function') initSelects(el);
        if (typeof updateGrid === 'function') updateGrid();
        
        // Auto-resize des textarea
        el.querySelectorAll('textarea').forEach(tx => {
            tx.addEventListener('input', function(){ 
                this.style.height='auto'; 
                this.style.height=this.scrollHeight+'px'; 
            });
        });
        
        el.scrollIntoView({behavior:"smooth", block:"center"});
    }
};
function addMesuresPrevention(btn){
    const container = document.querySelector('.questions-container');
    const div = document.createElement('div');
    div.className = 'question-block';
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span> 
                <input type="number" class="point-input" value="2" step="0.5" oninput="updateGrid()"> 
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C3" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true">Proposer des mesures de pr√©vention.</div>
        </div>
        <div class="exo-container">
          <div class="prevention-wrap">
            <div class="prevention-objectif">Objectif : aller du plus efficace au moins efficace.</div>
            <table class="prevention-table" role="table" aria-label="Mesures de pr√©vention">
              <thead>
                <tr>
                  <th class="col-type">Type de mesure</th>
                  <th>Mesures propos√©es</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-type">Supprimer ou r√©duire le risque</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection collective</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Protection individuelle</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2"></textarea></td>
                </tr>
                <tr>
                  <td class="col-type">Information / formation</td>
                  <td><textarea class="reponse-eleve prev-cell" rows="2"></textarea></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>
    `;
    container.appendChild(div);
    initSelects(div, true);
    updateGrid();
    div.querySelectorAll('textarea').forEach(tx => { 
        tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; }); 
    });
}
function addSchemaSituationTravail(btn){
    const container = document.querySelector('.questions-container');
    const uid = Date.now();
    const div = document.createElement('div');
    div.className = 'question-block';
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span> 
                <input type="number" class="point-input" value="4" step="0.5" oninput="updateGrid()"> 
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true">Compl√©ter le sch√©ma de compr√©hension de la situation de travail 2.</div>
        </div>
        <div class="exo-container">
          <div class="st2-page">
            <div class="st2-header">
              <div class="st2-title">Sch√©ma de compr√©hension de la situation de travail 2</div>
              <div class="st2-sub">Situation : <span class="st2-dots">‚Ä¶</span></div>
            </div>
            <div class="st2-grid">
              <div class="st2-box op">
                <div class="st2-boxtitle">D√©terminants op√©rateur</div>
                <div class="st2-hint">(Ex : √¢ge, √©tat de sant√©, comp√©tences, fatigue‚Ä¶)</div>
                <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
              </div>
              <div class="st2-box ent">
                <div class="st2-boxtitle">D√©terminants entreprise</div>
                <div class="st2-hint">(Ex : organisation, moyens mat√©riels, planning‚Ä¶)</div>
                <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
              </div>
              <div class="st2-box pres">
                <div class="st2-boxtitle">Travail prescrit</div>
                <div class="st2-hint">(Ce qui est demand√© par l'entreprise : consignes, objectifs‚Ä¶)</div>
                <textarea class="reponse-eleve st2-ta" rows="3"></textarea>
              </div>
              <div class="st2-box reel">
                <div class="st2-boxtitle">Travail r√©el</div>
                <div class="st2-split">
                  <div class="st2-splitcol">
                    <div class="st2-splittitle">T√¢che r√©elle</div>
                    <div class="st2-hint">(Ce qui est r√©ellement fait)</div>
                    <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
                  </div>
                  <div class="st2-splitcol">
                    <div class="st2-splittitle">Activit√© r√©elle</div>
                    <div class="st2-hint">(Comment c'est fait : gestes, postures, rythme‚Ä¶)</div>
                    <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
                  </div>
                </div>
              </div>
              <div class="st2-box effop">
                <div class="st2-boxtitle">Effets sur l'op√©rateur</div>
                <div class="st2-hint">(Effet 1 : ‚Ä¶ / Effet 2 : ‚Ä¶ / Effet 3 : ‚Ä¶)</div>
                <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
              </div>
              <div class="st2-box effent">
                <div class="st2-boxtitle">Effets sur l'entreprise</div>
                <div class="st2-hint">(Ex : retard, baisse de qualit√©, accident, arr√™t de travail‚Ä¶)</div>
                <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>
    `;
    container.appendChild(div);
    initSelects(div, true);
    updateGrid();
    div.querySelectorAll('textarea').forEach(tx => { 
        tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; }); 
    });
}
// Template du sch√©ma ST2 (option 1 : num√©rotation manuelle)
function getSchemaST2Template(uid){
  return `
    <div class="st2-page">
      <div class="st2-header">
        <div class="st2-title">Sch√©ma de compr√©hension de la situation de travail 2</div>
        <div class="st2-sub">Situation : <span class="st2-dots">‚Ä¶</span></div>
      </div>

      <div class="st2-grid">
        <div class="st2-box op">
          <div class="st2-boxtitle">D√©terminants op√©rateur</div>
          <div class="st2-hint">(Ex : √¢ge, √©tat de sant√©, comp√©tences, fatigue‚Ä¶)</div>
          <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
        </div>

        <div class="st2-box ent">
          <div class="st2-boxtitle">D√©terminants entreprise</div>
          <div class="st2-hint">(Ex : organisation, moyens mat√©riels, planning‚Ä¶)</div>
          <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
        </div>

        <div class="st2-box pres">
          <div class="st2-boxtitle">Travail prescrit</div>
          <div class="st2-hint">(Ce qui est demand√© par l‚Äôentreprise : consignes, objectifs‚Ä¶)</div>
          <textarea class="reponse-eleve st2-ta" rows="3"></textarea>
        </div>

        <div class="st2-box reel">
          <div class="st2-boxtitle">Travail r√©el</div>

          <div class="st2-split">
            <div class="st2-splitcol">
              <div class="st2-splittitle">T√¢che r√©elle</div>
              <div class="st2-hint">(Ce qui est r√©ellement fait)</div>
              <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
            </div>
            <div class="st2-splitcol">
              <div class="st2-splittitle">Activit√© r√©elle</div>
              <div class="st2-hint">(Comment c‚Äôest fait : gestes, postures, rythme‚Ä¶)</div>
              <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
            </div>
          </div>
        </div>

        <div class="st2-box effop">
          <div class="st2-boxtitle">Effets sur l‚Äôop√©rateur</div>
          <div class="st2-hint">(Effet 1 : ‚Ä¶ / Effet 2 : ‚Ä¶ / Effet 3 : ‚Ä¶)</div>
          <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
        </div>

        <div class="st2-box effent">
          <div class="st2-boxtitle">Effets sur l‚Äôentreprise</div>
          <div class="st2-hint">(Ex : retard, baisse de qualit√©, accident, arr√™t de travail‚Ä¶)</div>
          <textarea class="reponse-eleve st2-ta" rows="4"></textarea>
        </div>
      </div>
    </div>
  `;
}



    function removeQuestion(btn) {
        if(confirm("Supprimer cette question ?")) { btn.closest('.question-block').remove(); updateGrid(); }
    }
    
    function renumeroterQuestions() {
        const blocks = document.querySelectorAll('.question-block');
        if (blocks.length === 0) {
            alert("Aucune question √† renum√©roter !");
            return;
        }
        
        if (!confirm(`Renum√©roter ${blocks.length} question(s) de 1 √† ${blocks.length} dans l'ordre d'affichage ?`)) {
            return;
        }
        
        let numero = 1;
        blocks.forEach(block => {
            const numSelector = block.querySelector('.num-selector');
            if (numSelector) {
                numSelector.value = String(numero);
                numero++;
            }
        });
        
        updateGrid();
        alert(`‚úÖ ${blocks.length} question(s) renum√©rot√©e(s) !`);
    }
    
    function updateGrid() {
        const gridBody = document.getElementById('grid-body');
        if(!gridBody) return;
        const totalBaremeEl = document.getElementById('total-bareme');
        const totalObtenuEl = document.getElementById('total-obtenu');
        const blocks = document.querySelectorAll('.question-block');
        let data = {}; let totalBareme = 0; let totalObtenu = 0;

        blocks.forEach(block => {
            const compSel = block.querySelector('.comp-selector');
            const comp = compSel ? compSel.value : 'C?';
            const numSel = block.querySelector('.num-selector');
            const num = numSel ? numSel.value : '?';
            const maxPtsInput = block.querySelector('.point-input');
            const maxPts = maxPtsInput ? (parseNumber(maxPtsInput.value) || 0) : 0;
            const scoreInput = block.querySelector('.student-score');
            let score = scoreInput ? parseNumber(scoreInput.value) : NaN;
            
            const printSpan = block.querySelector('.print-only-grade');
            if(printSpan) {
                printSpan.textContent = `${maxPts} (${comp})`;
            }

            if(isNaN(score)) score = 0; 
            if(scoreInput && score > maxPts) scoreInput.style.backgroundColor = '#fadbd8';
            else if(scoreInput) scoreInput.style.backgroundColor = '#eaf2f8';

            if (!data[comp]) data[comp] = { questions: [], maxPoints: 0, obtainedPoints: 0 };
            data[comp].questions.push(num);
            data[comp].maxPoints += maxPts;
            data[comp].obtainedPoints += score;
            totalBareme += maxPts;
            totalObtenu += score;
        });

        const c6MaxInput = document.getElementById('c6-max');
        const c6ScoreInput = document.getElementById('c6-score');
        const c6Display = document.getElementById('c6-display-score');
        
        let valC6_max = c6MaxInput ? parseNumber(c6MaxInput.value) : 2;
        let valC6_score = c6ScoreInput ? parseNumber(c6ScoreInput.value) : 0;
        
        const c6PrintSpan = document.getElementById('c6-print-span');
        if(c6PrintSpan) { c6PrintSpan.textContent = `${valC6_max}`; }
        
        if(isNaN(valC6_score)) valC6_score = 0;
        if(valC6_score > valC6_max) { c6ScoreInput.style.backgroundColor = '#fadbd8'; } else { c6ScoreInput.style.backgroundColor = 'white'; }
        if(c6Display) { c6Display.innerHTML = `<span class="no-print">${valC6_score}</span><span class="print-only">......</span>`; }

        totalBareme += valC6_max;
        totalObtenu += valC6_score;

        gridBody.innerHTML = '';
        Object.keys(data).sort().forEach(key => {
            const item = data[key];
            const row = document.createElement('tr');
            row.innerHTML = '<td><b>'+key+'</b></td><td>'+item.questions.join(', ')+'</td><td></td><td></td><td></td><td></td><td>'+item.maxPoints+'</td><td style="color:#2980b9; font-weight:bold;"><span class="no-print">'+item.obtainedPoints+'</span><span class="print-only">......</span></td>';
            gridBody.appendChild(row);
        });

        if(totalBaremeEl) totalBaremeEl.textContent = '/ ' + totalBareme;
        if(totalObtenuEl) { totalObtenuEl.innerHTML = `<span class="no-print">${totalObtenu}</span><span class="print-only">......</span>`; }
    }

    

function addClozeTest(btn) {
    const container = document.querySelector('.questions-container');
    const div = document.createElement('div'); 
    div.className = 'question-block';
    const uid = Date.now() + "_" + Math.random().toString(36).slice(2,7);
    div.innerHTML = `
        ${getControlButtonsHTML()}
        <div class="q-meta-bar">
            <div class="points-wrapper">
                <input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()">
                <span class="teacher-part">/</span> 
                <input type="number" class="point-input" value="2" step="0.5" oninput="updateGrid()"> 
                <span class="teacher-part">pts (</span>
                <select class="comp-selector" data-selected="C1" onchange="updateGrid()"></select>
                <span class="teacher-part">)</span>
                <span class="print-only-grade"></span>
            </div>
        </div>
        <div class="q-content-row">
            <div class="num-selector-wrapper"><select class="num-selector"></select></div>
            <div class="editable-text" contenteditable="true" style="color:#d35400; font-weight:bold;">Compl√©tez le texte.</div>
        </div>
        <div class="exo-container">
            <div class="cloze-editor teacher-controls">
                <textarea class="cloze-source" style="width:100%; height:90px; margin-bottom:10px;" placeholder="Collez votre texte ici..."></textarea>
                <div style="margin-bottom: 10px; background: #eee; padding: 5px; border-radius: 4px;">
                    <strong>Type :</strong>
                    <label style="margin-right:15px; cursor:pointer;">
                        <input type="radio" name="cloze-mode-${uid}" value="input" checked> √âcriture
                    </label>
                    <label style="cursor:pointer;">
                        <input type="radio" name="cloze-mode-${uid}" value="select"> Liste D√©roulante
                    </label>
                    <span style="margin-left:15px;">
                        <label style="cursor:pointer;">
                            <input type="checkbox" class="cloze-show-bank"> Afficher une banque de mots
                        </label>
                    </span>
                </div>
                <button class="btn-add-q" onclick="generateWordButtons(this)">1. D√©couper</button>
                <button class="btn-add-q" style="background:#7f8c8d; display:none;" onclick="resetCloze(this)">‚Ü©Ô∏é Revenir au texte</button>
                <div class="word-area" style="margin:10px 0;"></div>
                <button class="btn-save-master" style="display:none;" onclick="finalizeCloze(this)">2. Valider</button>
            </div>

            <div class="cloze-result" style="line-height: 2em; font-size: 1.1em;"></div>

            <div class="teacher-controls" style="margin-top:10px; text-align:center;">
                <button class="btn-add-q" style="background:#e67e22;" onclick="editCloze(this)">‚úèÔ∏è Modifier l'exercice</button>
            </div>
        </div>
        
        <div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>

    `;
    container.appendChild(div);
    initSelects(div, true);
    updateGrid();
}

    function generateWordButtons(btn) {
        const editor = btn.parentElement;
        const text = editor.querySelector('textarea.cloze-source').value;
        const area = editor.querySelector('.word-area');
        const validateBtn = editor.querySelector('.btn-save-master');
        const resetBtn = editor.querySelector('button[onclick="resetCloze(this)"]');

        if(!text.trim()) return alert("√âcrivez du texte d'abord !");
        const words = text.split(/\s+/);
        area.innerHTML = "";
        words.forEach((word) => {
            const span = document.createElement('span');
            span.className = 'word-btn';
            span.textContent = word;
            span.onclick = function() { this.classList.toggle('hole-active'); };
            area.appendChild(span);
            area.appendChild(document.createTextNode(" "));
        });

        validateBtn.style.display = "inline-block";
        if(resetBtn) resetBtn.style.display = "inline-block";
        btn.style.display = "none";
        editor.querySelector('textarea.cloze-source').style.display = "none";
    }


function resetCloze(btn) {
    const editor = btn.closest('.cloze-editor');
    const qBlock = btn.closest('.question-block');
    if(!editor || !qBlock) return;

    const source = editor.querySelector('textarea.cloze-source');
    const cutBtn = editor.querySelector('button[onclick="generateWordButtons(this)"]');
    const validateBtn = editor.querySelector('.btn-save-master');
    const wordArea = editor.querySelector('.word-area');
    const resultArea = qBlock.querySelector('.cloze-result');

    if(source) source.style.display = "block";
    if(cutBtn) cutBtn.style.display = "inline-block";
    if(validateBtn) validateBtn.style.display = "none";
    btn.style.display = "none";
    if(wordArea) wordArea.innerHTML = "";
    if(resultArea) resultArea.innerHTML = "";
}

function editCloze(btn) {
    const qBlock = btn.closest('.question-block');
    if(!qBlock) return;
    const editor = qBlock.querySelector('.cloze-editor');
    if(editor) editor.style.display = "block";

    const validateBtn = qBlock.querySelector('.cloze-editor .btn-save-master');
    const resetBtn = qBlock.querySelector('.cloze-editor button[onclick="resetCloze(this)"]');
    if(validateBtn) validateBtn.style.display = "inline-block";
    if(resetBtn) resetBtn.style.display = "inline-block";
}

function splitPunct(token) {
    const m = token.match(/^([¬´"‚Äú‚Äù'()\[\]{}]*)(.*?)([\.,;:!?‚Ä¶¬ª"‚Äú‚Äù')\[\]{}]*)$/);
    if(!m) return { pre:"", core: token, post:"" };
    return { pre: m[1] || "", core: m[2] || token, post: m[3] || "" };
}

    function finalizeCloze(btn) {
    const editor = btn.parentElement;
    const qBlock = editor.closest('.question-block');
    const resultArea = qBlock.querySelector('.cloze-result');
    const wordSpans = editor.querySelectorAll('.word-btn');
    const mode = editor.querySelector('input[type="radio"]:checked').value;
    const showBank = !!(editor.querySelector('.cloze-show-bank') && editor.querySelector('.cloze-show-bank').checked);

    const hiddenWordsRaw = [];
    wordSpans.forEach(span => {
        if (span.classList.contains('hole-active')) {
            const parts = splitPunct(span.textContent);
            let w = (parts.core || '').trim();
            // Nettoyage l√©ger (garde lettres/chiffres/apostrophes/tirets)
            w = w.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()¬´¬ª"‚Äú‚Äù'‚Äô!?‚Ä¶]/g, "");
            if (w) hiddenWordsRaw.push(w);
        }
    });

    const hiddenWords = [...new Set(hiddenWordsRaw)];
    const shuffledHidden = hiddenWords.slice().sort(() => Math.random() - 0.5);

    resultArea.innerHTML = "";

    if (showBank && shuffledHidden.length) {
        const bank = document.createElement('div');
        bank.className = 'word-bank';
        const title = document.createElement('div');
        title.className = 'word-bank-title';
        title.textContent = 'Banque de mots :';
        bank.appendChild(title);

        shuffledHidden.forEach(w => {
            const chip = document.createElement('span');
            chip.className = 'word-chip';
            chip.textContent = w;
            bank.appendChild(chip);
        });
        resultArea.appendChild(bank);
    }

    const textWrap = document.createElement('div');
    textWrap.className = 'cloze-text';
    resultArea.appendChild(textWrap);

    wordSpans.forEach(span => {
        const parts = splitPunct(span.textContent);
        if (span.classList.contains('hole-active')) {
            if (parts.pre) textWrap.appendChild(document.createTextNode(parts.pre));

            if (mode === 'input') {
                const input = document.createElement('input');
                input.type = "text";
                input.className = "trou-eleve save-me";
                textWrap.appendChild(input);
            } else {
                const select = document.createElement('select');
                select.className = "trou-eleve save-me";
                const defaultOpt = document.createElement('option');
                defaultOpt.text = "???";
                defaultOpt.value = "";
                select.appendChild(defaultOpt);
                shuffledHidden.forEach(w => {
                    const opt = document.createElement('option');
                    opt.value = w;
                    opt.text = w;
                    select.appendChild(opt);
                });
                textWrap.appendChild(select);
            }

            if (parts.post) textWrap.appendChild(document.createTextNode(parts.post));
        } else {
            textWrap.appendChild(document.createTextNode(span.textContent));
        }
        textWrap.appendChild(document.createTextNode(" "));
    });

    editor.style.display = "none";
}

    function addMatchingExercise(btn) {
        const container = document.querySelector('.questions-container');
        const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `${getControlButtonsHTML()}<div class="q-meta-bar"><div class="points-wrapper"><input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()"><span class="teacher-part">/</span> <input type="number" class="point-input" value="2" step="0.5" oninput="updateGrid()"> <span class="teacher-part">pts (</span><select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select><span class="teacher-part">)</span><span class="print-only-grade"></span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector"></select></div><div class="editable-text" contenteditable="true" style="color:#3498db; font-weight:bold;">Reliez chaque √©l√©ment.</div></div><div class="exo-container"><div class="matching-editor teacher-controls"><div class="pairs-container"></div><button class="btn-add-q" onclick="addPairRow(this)" style="margin-top:10px;">+ Paire</button><button class="btn-save-master" onclick="finalizeMatching(this)">Valider</button></div><div class="matching-result"></div></div><div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>`;
        container.appendChild(div); initSelects(div, true); addPairRow(div.querySelector('.btn-add-q')); updateGrid();
    }
    function addPairRow(btn) {
        const container = btn.parentElement.querySelector('.pairs-container');
        const row = document.createElement('div');
        row.className = 'pair-row';
        row.innerHTML = `<textarea class="pair-input pair-left" rows="2" placeholder="Gauche"></textarea>
            <span style="font-weight:bold;">‚Æï</span>
            <textarea class="pair-input pair-right" rows="2" placeholder="Droite"></textarea>
            <button class="btn-del-q" style="position:static;" onclick="this.parentElement.remove()">‚úñ</button>`;
        container.appendChild(row);
        row.querySelectorAll('textarea').forEach(tx => {
            tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; });
            tx.dispatchEvent(new Event('input'));
        });
    }
    // Fonction de s√©curit√© pour √©chapper le HTML
function escapeHTML(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
    function finalizeMatching(btn) {
        const editor = btn.parentElement; const resultArea = editor.closest('.question-block').querySelector('.matching-result'); const rows = editor.querySelectorAll('.pair-row'); let pairs = []; let rightOptions = [];
        rows.forEach(row => { const left = row.querySelector('.pair-left').value.trim(); const right = row.querySelector('.pair-right').value.trim(); if(left && right) { pairs.push({left, right}); rightOptions.push(right); } });
        if(pairs.length < 2) return alert("Au moins 2 paires !");
        rightOptions.sort(() => Math.random() - 0.5);
        
        let tableHTML = '<table class="matching-table">';
        pairs.forEach((pair, index) => { let optionsHTML = '<option value="">???</option>'; rightOptions.forEach(opt => { optionsHTML += `<option value="${escapeHTML(opt)}">${escapeHTML(opt)}</option>`; }); tableHTML += `<tr><td class="matching-left">${escapeHTML(pair.left).replace(/\n/g,"<br>")}</td><td class="matching-center">‚û°</td><td class="matching-right"><select class="matching-select save-me-match" data-id="match_${index}">${optionsHTML}</select></td></tr>`; });
        tableHTML += '</table>';
        
        let printHTML = '<div class="matching-print-view print-matching-container">';
        pairs.forEach(pair => {
             printHTML += `<div class="print-match-row"><div class="print-match-col" style="text-align:right;">${escapeHTML(pair.left).replace(/\n/g,"<br>")}</div><div class="print-match-dot">‚Ä¢</div><div style="flex:1;"></div><div class="print-match-dot">‚Ä¢</div><div class="print-match-col"></div></div>`;
        });
        printHTML += '</div>';

        resultArea.innerHTML = tableHTML + printHTML; 
        editor.style.display = 'none';
    }


    function addQCM(btn) {
        const container = document.querySelector('.questions-container'); const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `${getControlButtonsHTML()}<div class="q-meta-bar"><div class="points-wrapper"><input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()"><span class="teacher-part">/</span> <input type="number" class="point-input" value="1" step="0.5" oninput="updateGrid()"> <span class="teacher-part">pts (</span><select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select><span class="teacher-part">)</span><span class="print-only-grade"></span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector"></select></div><div class="editable-text" contenteditable="true" style="color:#8e44ad; font-weight:bold;">Cochez la bonne r√©ponse.</div></div><div class="exo-container"><div class="qcm-editor teacher-controls"><div style="margin-bottom:10px; background:#f5eef8; padding:5px; border-radius:4px;"><strong>Type :</strong> <label style="margin-right:15px; cursor:pointer;"><input type="radio" name="qcm-type-${Date.now()}" value="radio" checked> Unique</label><label style="cursor:pointer;"><input type="radio" name="qcm-type-${Date.now()}" value="checkbox"> Multiple</label></div><div class="qcm-options-container"></div><button class="btn-add-q" onclick="addQCMOption(this)" style="margin-top:10px; background:#8e44ad;">+ Option</button><button class="btn-save-master" onclick="finalizeQCM(this)">Valider</button></div><div class="qcm-result"></div></div><div class="answer-key-zone">
            <div class="answer-key-header">
                <span class="answer-key-label">üü† √âl√©ments de r√©ponse (Corrig√© ‚Äî r√©serv√© au prof)</span>
            </div>
            <textarea class="answer-key-area" placeholder="‚úÖ Ce qui est attendu (mots-cl√©s, √©tapes, exemples, crit√®res)..."></textarea>
        </div>
        </div>`;
        container.appendChild(div); initSelects(div, true); addQCMOption(div.querySelector('.btn-add-q')); addQCMOption(div.querySelector('.btn-add-q')); updateGrid();
    }
    function addQCMOption(btn) { const container = btn.parentElement.querySelector('.qcm-options-container'); const row = document.createElement('div'); row.className = 'qcm-row'; row.innerHTML = `<input type="text" class="qcm-option-input" placeholder="R√©ponse possible..."><button class="btn-del-q" style="position:static;" onclick="this.parentElement.remove()">‚úñ</button>`; container.appendChild(row); }
    function finalizeQCM(btn) { const editor = btn.parentElement; const resultArea = editor.closest('.question-block').querySelector('.qcm-result'); const type = editor.querySelector('input[type="radio"]:checked').value; const inputs = editor.querySelectorAll('.qcm-option-input'); let options = []; inputs.forEach(inp => { if(inp.value.trim()) options.push(inp.value.trim()); }); if(options.length < 1) return alert("Au moins une option !"); const groupName = 'qcm_group_' + Date.now() + Math.random().toString(36).substr(2, 5); let html = ''; options.forEach(opt => { html += `<label class="qcm-student-option"><input type="${type}" name="${groupName}" class="save-me-qcm"><span>${opt}</span></label>`; }); resultArea.innerHTML = html; editor.style.display = 'none'; }


// --- CONTROLE QUALITE (PROF) ---
function closeQC() {
    const modal = document.getElementById('qc-modal');
    if(modal) modal.style.display = 'none';
}
function openQC() {
    const modal = document.getElementById('qc-modal');
    if(modal) modal.style.display = 'block';
}
function qcGoTo(id) {
    const el = document.getElementById(id);
    if(!el) return;
    closeQC();
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    el.style.boxShadow = '0 0 0 4px rgba(243,156,18,0.45)';
    setTimeout(() => { el.style.boxShadow = ''; }, 1500);
}
function normalizeText(t){
    return (t || '').toString().replace(/\s+/g,' ').trim();
}
function extractFirstWord(sentence){
    const s = normalizeText(sentence).toLowerCase();
    const w = s.split(' ')[0] || '';
    return w.replace(/^[^a-z√†√¢√§√©√®√™√´√Æ√Ø√¥√∂√π√ª√º√ß≈ì-]+/i,'').replace(/[^a-z√†√¢√§√©√®√™√´√Æ√Ø√¥√∂√π√ª√º√ß≈ì-]+$/i,'');
}
function parseNumToTuple(v){
    const s = (v||'').toString().trim();
    if(!s) return null;
    const parts = s.split('.');
    const a = parseInt(parts[0],10);
    const b = parts.length>1 ? parseInt(parts[1],10) : 0;
    return [Number.isFinite(a)?a:9999, Number.isFinite(b)?b:9999];
}
function tupleLess(t1,t2){ return (t1[0] < t2[0]) || (t1[0]===t2[0] && t1[1] < t2[1]); }
function runQualityCheck(silent=false) {
    const warnings = [];
    const blocks = Array.from(document.querySelectorAll('.question-block'));
    const seenNums = new Map();
    const verbes = new Set([
        'indiquer','citer','donner','nommer','relever','rep√©rer','identifier','d√©finir','associer','classer',
        'expliquer','justifier','d√©crire','analyser','comparer','argumenter','proposer','calculer','compl√©ter',
        'cocher','entourer','relier','surligner','√©crire','r√©diger','r√©sumer','lister','choisir'
    ]);

    // ‚≠ê NOUVEAU CONTR√îLE #16 : Titre du devoir manquant
    const mainTitle = document.querySelector('h1');
    const titleText = mainTitle ? mainTitle.textContent.trim() : '';
    if(!titleText || titleText === 'EVALUATION' || titleText === 'DEVOIR' || titleText.length < 5){
        warnings.push({id:'main-title', msg:'Titre du devoir manquant ou trop g√©n√©rique (ex: "EVALUATION PSE - La s√©dentarit√©").'});
    }

    let prevTuple = null;

    blocks.forEach((block, i) => {
        if(!block.id) block.id = 'qc-' + (i+1);

        const numSel = block.querySelector('.num-selector');
        const compSel = block.querySelector('.comp-selector');
        const ptsInp = block.querySelector('.point-input');
        const questionEl = block.querySelector('.editable-text');

        const num = numSel ? numSel.value : '';
        const comp = compSel ? compSel.value : '';
        const pts = ptsInp ? parseNumber(ptsInp.value) : 0;
        const qtxt = questionEl ? normalizeText(questionEl.textContent) : '';

        // Num√©ro manquant / doublon
        if(!num){
            warnings.push({id:block.id, msg:`Question ${i+1} : num√©ro manquant.`});
        } else {
            const c = (seenNums.get(num) || 0) + 1;
            seenNums.set(num, c);
            if(c > 1){
                warnings.push({id:block.id, msg:`Num√©rotation en doublon : ${num}.`});
            }
            const tup = parseNumToTuple(num);
            if(prevTuple && tup && tupleLess(tup, prevTuple)){
                warnings.push({id:block.id, msg:`Ordre de num√©rotation incoh√©rent : ${num} arrive apr√®s un num√©ro plus grand.`});
            }
            // ‚≠ê NOUVEAU CONTR√îLE #18 : D√©tection des sauts de num√©ros principaux
            if(prevTuple && tup) {
                const prevMain = prevTuple[0];
                const currMain = tup[0];
                // Si on passe d'un num√©ro principal √† un autre en sautant des num√©ros
                // Ex: 2 ‚Üí 5 (manque 3, 4) ou 2.1 ‚Üí 5 (manque 3, 4)
                if(currMain > prevMain + 1) {
                    const missing = [];
                    for(let m = prevMain + 1; m < currMain; m++) missing.push(m);
                    warnings.push({id:block.id, msg:`Saut de num√©rotation d√©tect√© : Q${prevMain} ‚Üí Q${currMain} (Q${missing.join(', Q')} manquante(s) ?).`});
                }
            }
            if(tup) prevTuple = tup;
        }

        // Comp√©tence manquante
        if(!/^C[1-6]$/.test(comp)){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : comp√©tence non renseign√©e.`});
        }

        // Bar√®me manquant ou z√©ro
        if(!ptsInp || pts <= 0){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : bar√®me manquant ou √† 0.`});
        }

        // Consigne : verbe d‚Äôaction (heuristique)
        const first = extractFirstWord(qtxt);
        const looksInf = (first.endsWith('er') || first.endsWith('ir') || first.endsWith('re'));
        if(qtxt && !(verbes.has(first) || looksInf)){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : la consigne ne commence pas clairement par un verbe d‚Äôaction (d√©but : ${first || '‚Ä¶'}).`});
        }

        // Deux demandes dans une m√™me question (heuristique)
        const lower = qtxt.toLowerCase();
        if(lower.includes(' et ') || lower.includes(' puis ') || lower.includes(' ainsi que ')){
            // on cherche plusieurs verbes connus
            let count = 0;
            verbes.forEach(v => { if(lower.includes(v+' ')) count++; });
            if(count >= 2){
                warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : possible double consigne (s√©parer en 2 sous-questions si besoin).`});
            }
        }

        // ‚≠ê NOUVEAU CONTR√îLE #8 : R√©ponse attendue (prof) manquante
        const answerKey = block.querySelector('.answer-key-area');
        const answerText = answerKey ? answerKey.value.trim() : '';
        if(!answerText || answerText.length < 5){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : r√©ponse attendue (corrig√© prof) non renseign√©e ou trop courte.`});
        }

        // ‚≠ê NOUVEAU CONTR√îLE #9 : Question trop courte ou vide
        if(qtxt.length > 0 && qtxt.length < 10){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : consigne trop courte (${qtxt.length} caract√®res, minimum 10).`});
        }

        // ‚≠ê NOUVEAU CONTR√îLE #10 : R√©ponse attendue trop courte pour le bar√®me
        if(pts >= 2 && answerText.length > 0 && answerText.length < 20){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : r√©ponse attendue trop courte (${answerText.length} caract√®res) pour ${pts} pts. D√©velopper les crit√®res.`});
        }

        // ‚≠ê NOUVEAU CONTR√îLE #11 : Question se terminant par un point
        if(qtxt.endsWith('.')){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : la consigne ne devrait pas se terminer par un point (infinitif).`});
        }

        // ‚≠ê NOUVEAU CONTR√îLE #12 : Doubles espaces
        if(qtxt.includes('  ')){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : double espace d√©tect√© dans la consigne.`});
        }

        // ‚≠ê NOUVEAU CONTR√îLE #13 : Points de suspension en fin
        if(qtxt.endsWith('...') || qtxt.endsWith('‚Ä¶')){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : points de suspension en fin de consigne (peu professionnel).`});
        }

        // ‚≠ê NOUVEAU CONTR√îLE #14 : Pas de majuscule en d√©but
        if(qtxt.length > 0 && qtxt[0] !== qtxt[0].toUpperCase()){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : la consigne devrait commencer par une majuscule.`});
        }

        // ‚≠ê NOUVEAU CONTR√îLE #15 : Ponctuation excessive
        if(qtxt.includes('??') || qtxt.includes('!!') || qtxt.includes('::') || qtxt.includes(';;')){
            warnings.push({id:block.id, msg:`${num || ('Question '+(i+1))} : ponctuation excessive d√©tect√©e (??, !!, ::).`});
        }

        // ‚≠ê NOUVEAU CONTR√îLE #17 : R√©ponse √©l√®ve pr√©-remplie (CRITIQUE !)
        const studentAnswers = block.querySelectorAll('textarea.reponse-eleve, input.reponse-eleve');
        studentAnswers.forEach(answer => {
            const content = answer.value.trim();
            if(content.length > 0){
                const preview = content.length > 50 ? content.substring(0, 50) + '...' : content;
                warnings.push({
                    id: block.id, 
                    msg: `${num || ('Question '+(i+1))} : üö® R√âPONSE √âL√àVE PR√â-REMPLIE ! "${preview}". D√©placer vers zone prof ou supprimer.`
                });
            }
        });
    });

    // Total bar√®me (optionnel)
    const c6max = parseNumber((document.getElementById('c6-max')||{}).value);
    const total = blocks.reduce((s,b)=> s + parseNumber((b.querySelector('.point-input')||{}).value), 0) + (Number.isFinite(c6max)?c6max:0);
    if(Number.isFinite(total) && total !== 0 && Math.abs(total - 20) > 0.001){
        warnings.unshift({id:'eval-section-container', msg:`Total bar√®me = ${total} (info).`});
        const evalSec = document.getElementById('eval-section-container');
        if(evalSec && !evalSec.id) evalSec.id = 'eval-section-container';
    }

    if(silent) return warnings.length;

    const list = document.getElementById('qc-list');
    const summary = document.getElementById('qc-summary');
    if(list) list.innerHTML = '';
    if(summary){
        summary.innerHTML = warnings.length
            ? `<b>${warnings.length}</b> point(s) √† v√©rifier.`
            : `<b>Aucune alerte d√©tect√©e</b> (contr√¥le rapide).`;
    }

    if(list && warnings.length){
        warnings.forEach(w => {
            const li = document.createElement('li');
            li.style.margin = '6px 0';
            li.innerHTML = `<a href="#" onclick="qcGoTo('${w.id}'); return false;" style="color:#2980b9; text-decoration:none; font-weight:600;">${w.msg}</a>`;
            list.appendChild(li);
        });
    }
    openQC();
    return warnings.length;
}



// --- GARDE-FOU : le bouton V√©rifier ne doit jamais dispara√Ætre ---
function ensureQCButton(){
  try{
    const tools=document.getElementById('main-tools');
    if(!tools) return;
    if(document.getElementById('btn-qc')) return;
    const btn=document.createElement('button');
    btn.id='btn-qc';
    btn.className='btn-tool btn-qc builder-only';
    btn.textContent='‚úÖ V√©rifier';
    btn.onclick=runQualityCheck;
    const printBtn=tools.querySelector('.btn-print');
    if(printBtn) tools.insertBefore(btn, printBtn);
    else tools.appendChild(btn);
  }catch(e){}
}
window.addEventListener('DOMContentLoaded', ensureQCButton);

    initSelects(document);
    document.querySelectorAll('textarea').forEach(tx => { tx.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; }); });
    updateGrid();



// =======================




</script>
<script>
    // --- GESTION IMAGE (MODE ORGANIS√â) ---
    function triggerImgUpload(container) {
        const nom = prompt("Nom du fichier image (ex: schema.jpg) ?\n\nIMPORTANT : L'image devra √™tre plac√©e dans le dossier 'images' situ√© √† c√¥t√© de votre fichier devoir.", "");
        if (nom) container.querySelector('img').src = "images/" + nom.trim();
    }

    
    // Nettoyage s√©curit√© : suppression des anciens blocs prof-eval si jamais un master sauvegard√© en contenait
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.prof-eval-header, .prof-comment-area, .mastery-selector').forEach(el => el.remove());
    });

    // --- SAUVEGARDE MASTER ---
    // --- RAFRAICHISSEMENT GRILLE (Delegation) ---
    (function(){
        const safeUpdate = () => { try { if(typeof updateGrid==='function') updateGrid(); } catch(e){} };
        document.addEventListener('change', (e) => {
            const t = e.target;
            if(!t) return;
            if(t.matches('.comp-selector, .num-selector')) safeUpdate();
        });
        document.addEventListener('input', (e) => {
            const t = e.target;
            if(!t) return;
            if(t.matches('.point-input, .student-score, #c6-score, #c6-max')) safeUpdate();
        });
    })();

    // ========================================
    // üîÑ FONCTION RESET MASTER (Nouveau Devoir)
    // ========================================
    // REMPLACER la fonction resetMaster existante
function resetMaster() {
    if(!confirm("‚ö†Ô∏è RESET COMPLET\n\nCela va TOUT effacer :\n‚Ä¢ Toutes les questions\n‚Ä¢ Le titre\n‚Ä¢ La grille d'√©valuation\n\nContinuer ?")) return;
    
    const titleEl = document.querySelector('.main-title-editable');
    if(titleEl) titleEl.textContent = 'Nouveau Devoir PSE';
    
    const container = document.querySelector('.questions-container');
    if(container) container.innerHTML = '';
    
    document.querySelectorAll('.eval-table tbody td:last-child').forEach(td => {
        td.textContent = '0';
    });
    
    localStorage.removeItem('master_backup');
    
    console.log("‚úÖ Master r√©initialis√© compl√®tement");
    alert("‚úÖ Le Master a √©t√© r√©initialis√© !");
}
    function saveMasterHTML() {
    // ‚≠ê CORRECTION BUG #3 : Fixer l'√©tat des formulaires avant sauvegarde
    fixerEtatFormulaires(document.documentElement);
    
    // Ancienne m√©thode conserv√©e en compl√©ment
    document.querySelectorAll('input, textarea, select').forEach(e => {
        if(e.value) e.setAttribute('value', e.value);
        if(e.tagName==='TEXTAREA') e.textContent = e.value;
    });
    // ‚≠ê FIN CORRECTION BUG #3
		    const content = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
    openDownloadModal('Sauvegarde du Master', 'T√©l√©chargez le fichier master (c√¥t√© prof).', [
        { name: 'Master_Sauvegarde.html', type: 'text/html', content: content, label: 'üíæ T√©l√©charger Master_Sauvegarde.html', hint: 'master' }
    ]);
}

function downloadFile(content, filename, mimeType) {
        try {
            const blob = new Blob([content], { type: mimeType || 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);

            // Fallback Safari/iOS : certains navigateurs bloquent le download Blob
            const isIOS = /iP(ad|hone|od)/.test(navigator.userAgent);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            if (isIOS || isSafari) {
                // On tente d'ouvrir dans un nouvel onglet en plus du clic
                try { window.open(url, '_blank'); } catch(e) {}
            }

            a.click();
            setTimeout(() => {
                try { URL.revokeObjectURL(url); } catch(e) {}
                try { a.remove(); } catch(e) {}
            }, 1200);
        } catch (e) {
            alert('T√©l√©chargement impossible : ' + (e && e.message ? e.message : e));
            throw e;
        }
    }


    // ============================================================
    // üöÄ MOTEUR EXPORT (V3 : DOSSIERS + SECURIT√â + RGPD)
    // ============================================================
    function exportDevoir(){
        try {
            const n = (typeof runQualityCheck === 'function') ? runQualityCheck(true) : 0;
            if(n && n > 0){
                const ok = confirm("Le contr√¥le a d√©tect√© " + n + " point(s).\n\nExporter quand m√™me ?");
                if(!ok) return;
            }
            if(typeof closeQC === 'function') closeQC();
            genererBlueprint();
        } catch (err) {
            alert('Erreur export : ' + (err && err.message ? err.message : err));
        }
    }

    // ‚≠ê CORRECTION BUG #1, #2, #3 : Fixer l'√©tat des formulaires avant export/sauvegarde
    // Cette fonction garantit que les select, textarea et input gardent leur √©tat dans le HTML s√©rialis√©
    function fixerEtatFormulaires(documentElement) {
        // 1. Fixer les <select> : ajouter 'selected' sur l'option courante
        documentElement.querySelectorAll('select').forEach(sel => {
            const selectedValue = sel.value;
            Array.from(sel.options).forEach(opt => {
                if (opt.value === selectedValue) {
                    opt.setAttribute('selected', 'selected');
                } else {
                    opt.removeAttribute('selected');
                }
            });
            // Supprimer l'attribut value du select pour √©viter les conflits
            sel.removeAttribute('value');
        });
        
        // 2. Fixer les <textarea> : mettre le contenu dans textContent
        documentElement.querySelectorAll('textarea').forEach(ta => {
            ta.textContent = ta.value;
            ta.removeAttribute('value');
        });
        
        // 3. Fixer les checkbox/radio
        documentElement.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(inp => {
            if (inp.checked) {
                inp.setAttribute('checked', 'checked');
            } else {
                inp.removeAttribute('checked');
            }
        });
        
        // 4. Fixer les input normaux
        documentElement.querySelectorAll('input[type="text"], input[type="number"]').forEach(inp => {
            inp.setAttribute('value', inp.value);
        });
    }
    // ‚≠ê FIN CORRECTION BUG #1, #2, #3

    function genererBlueprint() {
        // ‚≠ê CORRECTION BUG #1, #2, #3 : Fixer l'√©tat des formulaires AVANT tout
        fixerEtatFormulaires(document.documentElement);
        
        const idDevoir = "devoir_" + Date.now();
        const titre = document.querySelector('h1').innerText.trim() || "Devoir";

        // ‚≠ê CORRECTION BUG #5 : Capturer la structure COMPL√àTE (sections, docs, titres, questions)
        const blueprint = { 
            id: idDevoir, 
            titre: titre, 
            content: []  // Structure compl√®te au lieu de juste "questions"
        };
        
        let questionIndex = 0;
        
        // Parcourir TOUS les blocs dans l'ordre du DOM
        document.querySelectorAll('.section-block, .doc-block, .numbered-header, .question-block').forEach((block) => {
            
            if (block.classList.contains('section-block')) {
                blueprint.content.push({
                    type: "section",
                    title: block.querySelector('.section-title-editable')?.value || ""
                });
            }
            
            else if (block.classList.contains('doc-block')) {
                blueprint.content.push({
                    type: "document",
                    title: block.querySelector('.doc-title')?.textContent || "",
                    image: block.querySelector('img')?.src || ""
                });
            }
            
            else if (block.classList.contains('numbered-header')) {
                blueprint.content.push({
                    type: "part-title",
                    number: block.querySelector('.num-box')?.textContent || "",
                    text: block.querySelector('.text-box')?.textContent || ""
                });
            }
            
            else if (block.classList.contains('question-block')) {
                const qid = "q_" + questionIndex;
                const numSelector = block.querySelector('.num-selector');
                
                // Lire la valeur depuis l'option[selected] maintenant que c'est fix√©
                let label = '';
                if (numSelector) {
                    const selectedOpt = numSelector.querySelector('option[selected]');
                    label = selectedOpt ? selectedOpt.value : (numSelector.options[0]?.value || (questionIndex + 1));
                } else {
                    label = questionIndex + 1;
                }
                
                blueprint.content.push({
                    type: "question",
                    qid: qid,
                    label: label,
                    competence: block.querySelector('.comp-selector')?.value || "C?",
                    bareme: parseFloat(block.querySelector('.point-input')?.value || 0),
                    reponseAttendue: block.querySelector('.answer-key-area')?.value || "",
                    questionText: block.querySelector('.editable-text')?.textContent || ""
                });
                
                // Ajouter data-qid aux champs de r√©ponse
                block.querySelectorAll('textarea, input, select').forEach(inp => {
                    if (!inp.classList.contains('point-input') && !inp.classList.contains('comp-selector') && !inp.classList.contains('num-selector')) {
                        inp.setAttribute('data-qid', qid);
                    }
                });
                
                questionIndex++;
            }
        });
        // ‚≠ê FIN CORRECTION BUG #5
        
        const blueprintStr = JSON.stringify(blueprint, null, 2);
        // 2. HTML √âL√àVE
        const clone = document.documentElement.cloneNode(true);

        // ‚≠ê CORRECTION BUG #4 : Nettoyage complet
        clone.querySelectorAll('.no-print, .answer-key-zone, .teacher-controls, .block-controls, .builder-only, .teacher-only, #main-tools, #rich-format-toolbar, .q-meta-bar').forEach(e => e.remove());
        
        // ‚≠ê CORRECTION BUG #4 : Supprimer TOUS les onclick (images et autres)
        clone.querySelectorAll('[onclick]').forEach(el => {
            el.removeAttribute('onclick');
        });
        
        // Rendre les images non cliquables visuellement
        clone.querySelectorAll('.img-container').forEach(container => {
            container.style.cursor = 'default';
            // ‚≠ê NOUVEAU : D√©sactiver le hover "Changer l'image"
            container.style.pointerEvents = 'none'; // Bloque tous les √©v√©nements
        });
        
        // ‚≠ê NOUVEAU : S'assurer que le body n'a PAS la classe teacher-mode
        const cloneBody = clone.querySelector('body');
        if(cloneBody) {
            cloneBody.classList.remove('teacher-mode', 'builder-view');
            cloneBody.classList.add('student-view');
        }
        
        clone.querySelectorAll('[contenteditable]').forEach(e => e.setAttribute('contenteditable','false'));

        // ‚≠ê CORRECTION BUG #1 : Transformation UNIQUE des select en span (lecture depuis option[selected])
        // NUM√âROS
        clone.querySelectorAll('select.num-selector').forEach(sel => {
            const selectedOpt = sel.querySelector('option[selected]');
            const value = selectedOpt ? selectedOpt.value : (sel.options[0]?.value || '1');
            
            const span = document.createElement('span');
            span.className = 'num-display';
            span.textContent = value;
            sel.replaceWith(span);
        });
        
        // COMP√âTENCES
        clone.querySelectorAll('select.comp-selector').forEach(sel => {
            const selectedOpt = sel.querySelector('option[selected]');
            const value = selectedOpt ? selectedOpt.value : (sel.getAttribute('data-selected') || 'C?');
            
            const span = document.createElement('span');
            span.className = 'comp-display';
            span.textContent = value;
            sel.replaceWith(span);
        });

        // Suppression des √©l√©ments d'√©dition prof restants (bar√®me/notes)
        clone.querySelectorAll('.student-score, .point-input, .teacher-part, .print-only-grade').forEach(e => e.remove());

        // Vider toutes les r√©ponses √©l√®ves
        clone.querySelectorAll('textarea.reponse-eleve').forEach(e => { 
            e.value = ""; 
            e.textContent = ""; 
            e.innerHTML = "";
            e.removeAttribute('value');
        });
        // ‚≠ê FIN CORRECTION BUG #1, #4

        // Style "papier" pour les √©l√©ments fig√©s
        (function addStudentStyle(){
          const head = clone.querySelector('head');
          if(!head) return;
          const st = document.createElement('style');
          st.textContent = `
            body.student-view .q-meta-bar, body.student-view .num-selector-wrapper{ user-select:none; }
            body.student-view .num-display{ display:inline-block; min-width:44px; padding:6px 10px; border:2px solid #e36b6b; border-radius:8px; font-weight:700; color:#c0392b; background:#fff; text-align:center; }
            body.student-view .comp-display{ display:inline-block; min-width:44px; padding:4px 10px; border:2px solid #2ecc71; border-radius:999px; font-weight:700; background:#eafff2; color:#1f7a4a; text-align:center; }
            body.student-view .points-display{ display:inline-block; padding:4px 10px; border:2px solid #3498db; border-radius:8px; font-weight:700; background:#eef7ff; color:#1f5c86; }
            body.student-view .teacher-part{ display:none !important; }
            body.student-view .numbered-header{ display: flex !important; align-items: center; }
            body.student-view .num-box{ display: block !important; }
            body.student-view .text-box{ display: block !important; }
          `;
          head.appendChild(st);
        })();


        // RGPD : Remplacement du bandeau identit√©
        const oldInfo = clone.querySelector('.student-info');
        if(oldInfo) {
            oldInfo.innerHTML = `
                <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                    <div class="input-group">
                        <label>CODE :</label>
                        <input type="text" id="code-eleve" placeholder="Votre code" style="font-weight:bold; color:#2c3e50; background:#eef2f3; width:140px; text-align:center;">
                    </div>
                </div>`;
        }

        // ‚≠ê CORRECTION BUG #8 : Scripts charg√©s dynamiquement pour √©viter ex√©cution pendant export
        const body = clone.querySelector('body');
        
        const sLogic = document.createElement('script');
        sLogic.textContent = `
            const MON_ID_DEVOIR = "${idDevoir}";

            // ‚≠ê Fonction pour la matrice de risque (clics sur les cellules)
            function initRiskMatrix(scope){
              try {
                const root = scope || document;
                root.querySelectorAll('.risk-matrix-wrap').forEach(wrap => {
                  const hidden = wrap.querySelector('.risk-cell-value');
                  const displayDiv = wrap.querySelector('.risk-selection-display');
                  const displayText = wrap.querySelector('.risk-selection-text');
                  const cells = Array.from(wrap.querySelectorAll('.risk-cell'));
                  if(!cells.length) return;

                  // Fonction pour convertir data-pos en texte lisible
                  function posToText(pos) {
                    if (!pos) return '';
                    const [prob, grav] = pos.split('-');
                    const probTexts = {
                      'P1': 'Tr√®s improbable',
                      'P2': 'Improbable',
                      'P3': 'Probable',
                      'P4': 'Tr√®s probable'
                    };
                    const gravTexts = {
                      'G1': 'Faible',
                      'G2': 'Moyen',
                      'G3': 'Grave',
                      'G4': 'Tr√®s grave'
                    };
                    return \`\${probTexts[prob] || prob} + \${gravTexts[grav] || grav}\`;
                  }

                  function applySelection(cell){
                    cells.forEach(c => c.classList.remove('selected'));
                    cell.classList.add('selected');
                    const pos = cell.getAttribute('data-pos') || '';
                    if(hidden) hidden.value = pos;

                    // Afficher le texte de s√©lection
                    if(displayDiv && displayText) {
                      displayDiv.style.display = 'block';
                      displayText.textContent = posToText(pos);
                    }

                    // Auto-d√©cision selon zone
                    const isPrio = cell.classList.contains('zone-prioritaire');
                    const wanted = isPrio ? 'prioritaire' : 'non_prioritaire';
                    const radio = wrap.querySelector('input[type="radio"][value="' + wanted + '"]');
                    if(radio) radio.checked = true;
                  }

                  // Restauration si d√©j√† une valeur
                  if(hidden && hidden.value){
                    const prev = cells.find(c => (c.getAttribute('data-pos')||'') === hidden.value);
                    if(prev) applySelection(prev);
                  }

                  cells.forEach(cell => {
                    cell.setAttribute('tabindex','0');
                    cell.setAttribute('role','gridcell');
                    cell.addEventListener('click', () => applySelection(cell));
                    cell.addEventListener('keydown', (e) => {
                      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); applySelection(cell); }
                    });
                  });
                });
              } catch(e){
                console.warn('initRiskMatrix warning', e);
              }
            }

            window.addEventListener('load', async () => {
                const autoGrow = (ta) => {
                    if(!ta) return;
                    ta.style.height = 'auto';
                    ta.style.height = (ta.scrollHeight + 2) + 'px';
                };

                // ‚≠ê CORRECTION BUG #6 : localStorage avec cl√©s plus sp√©cifiques
                document.querySelectorAll('textarea, input, select').forEach(el => {
                    const fieldId = el.getAttribute('data-qid') || el.id || 'field_' + Math.random();
                    const storageKey = 'autosave_' + MON_ID_DEVOIR + '_' + fieldId;
                    
                    const saved = localStorage.getItem(storageKey);
                    if(saved) el.value = saved;
                    if(el.tagName==='TEXTAREA') autoGrow(el);
                    
                    el.addEventListener('input', function() {
                        localStorage.setItem(storageKey, this.value);
                        if(this.tagName==='TEXTAREA') autoGrow(this);
                    });
                });

                // ‚≠ê Initialiser la matrice de risque (clics sur les cellules)
                initRiskMatrix(document);

                // ‚≠ê NOUVEAU : Syst√®me anti-copier-coller avec d√©tection source
                let totalPastes = 0;
                let externalPastes = 0;
                let documentPastes = 0;
                const pasteLog = {};

                // Collecter tout le texte des documents du devoir
                const documentTexts = Array.from(document.querySelectorAll('.doc-block, .consigne-simple, .text-block'))
                    .map(el => el.textContent.trim())
                    .filter(text => text.length > 20);

                // Fonction pour afficher l'avertissement fermable
                function showPasteWarning(count, isExternal) {
                    const warning = document.createElement('div');
                    warning.style.cssText = \`
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border: 3px solid \${isExternal ? '#ff5722' : '#ff9800'};
                        border-radius: 10px;
                        padding: 20px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        z-index: 10000;
                        max-width: 90%;
                        width: 400px;
                        animation: slideIn 0.3s;
                    \`;
                    
                    warning.innerHTML = \`
                        <style>
                            @keyframes slideIn {
                                from { transform: translate(-50%, -60%); opacity: 0; }
                                to { transform: translate(-50%, -50%); opacity: 1; }
                            }
                        </style>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="margin:0; color:\${isExternal ? '#d32f2f' : '#f57c00'};">
                                ‚ö†Ô∏è COPIER-COLLER D√âTECT√â
                            </h3>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background:none; border:none; font-size:28px; cursor:pointer; color:#999; line-height:1;">
                                √ó
                            </button>
                        </div>
                        
                        <p style="margin:10px 0; line-height:1.5;">
                            Vous devez r√©diger vos <strong>propres r√©ponses</strong> avec vos <strong>propres mots</strong>.
                        </p>
                        
                        <div style="background:\${isExternal ? '#ffebee' : '#fff3e0'}; padding:10px; border-radius:5px; margin:10px 0;">
                            <p style="margin:5px 0; font-size:0.9em; color:#666;">
                                <strong>Collages depuis sources externes :</strong> \${externalPastes} \${isExternal ? '‚ö†Ô∏è' : ''}<br>
                                <strong>Collages depuis le document :</strong> \${documentPastes}
                            </p>
                        </div>
                        
                        <p style="margin:10px 0; color:#d32f2f; font-size:0.9em; font-weight:bold;">
                            üîç Votre enseignant sera inform√©.
                        </p>
                        
                        <button onclick="this.parentElement.remove()" 
                                style="background:#2196F3; color:white; border:none; padding:12px 20px; 
                                       border-radius:5px; cursor:pointer; width:100%; font-size:16px; 
                                       margin-top:10px; font-weight:bold;">
                            J'ai compris
                        </button>
                    \`;
                    
                    document.body.appendChild(warning);
                    
                    // Fermeture auto apr√®s 10 secondes
                    setTimeout(() => {
                        if(warning.parentElement) warning.remove();
                    }, 10000);
                }

                // Popup de r√®glement au d√©marrage
                function showRulesPopup() {
                    const rulesPopup = document.createElement('div');
                    rulesPopup.style.cssText = \`
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        z-index: 20000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    \`;
                    
                    rulesPopup.innerHTML = \`
                        <div style="background:white; border-radius:12px; padding:30px; max-width:500px; width:90%; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                            <h2 style="margin:0 0 20px 0; color:#1976d2; text-align:center;">
                                ‚ö†Ô∏è R√àGLEMENT DU DEVOIR
                            </h2>
                            
                            <p style="margin:15px 0; line-height:1.6;">
                                Ce devoir √©value vos <strong>COMP√âTENCES</strong>.
                            </p>
                            
                            <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin:15px 0;">
                                <p style="margin:5px 0; font-weight:bold; color:#2e7d32;">‚úÖ Vous devez :</p>
                                <ul style="margin:10px 0 0 20px; line-height:1.6;">
                                    <li>R√©diger vos propres r√©ponses</li>
                                    <li>Utiliser vos propres mots</li>
                                    <li>Montrer ce que VOUS savez faire</li>
                                </ul>
                            </div>
                            
                            <div style="background:#ffebee; padding:15px; border-radius:8px; margin:15px 0;">
                                <p style="margin:5px 0; font-weight:bold; color:#c62828;">‚ùå Interdit :</p>
                                <ul style="margin:10px 0 0 20px; line-height:1.6;">
                                    <li>Copier-coller depuis Internet</li>
                                    <li>Copier-coller depuis d'autres sources</li>
                                    <li>Recopier des r√©ponses toutes faites</li>
                                </ul>
                            </div>
                            
                            <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin:15px 0;">
                                <p style="margin:5px 0; font-weight:bold; color:#1565c0;">üí° Autoris√© :</p>
                                <p style="margin:10px 0 0 20px; line-height:1.6;">
                                    Relever des √©l√©ments du document du devoir<br>si la consigne le demande
                                </p>
                            </div>
                            
                            <p style="margin:15px 0; font-size:0.9em; color:#666; line-height:1.6;">
                                üîç <strong>Information :</strong> Les copier-coller sont d√©tect√©s et transmis √† votre enseignant.
                            </p>
                            
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background:#1976d2; color:white; border:none; padding:15px; 
                                           border-radius:8px; cursor:pointer; width:100%; font-size:18px; 
                                           font-weight:bold; margin-top:20px;">
                                J'ai compris et j'accepte
                            </button>
                        </div>
                    \`;
                    
                    document.body.appendChild(rulesPopup);
                }

                // Afficher le popup de r√®glement au d√©marrage
                setTimeout(showRulesPopup, 1000);

                // Attacher les d√©tecteurs de copier-coller
                document.querySelectorAll('textarea.reponse-eleve').forEach(textarea => {
                    textarea.addEventListener('paste', function(e) {
                        const pastedText = e.clipboardData.getData('text').trim();
                        if(!pastedText) return;
                        
                        totalPastes++;
                        
                        // V√©rifier si le texte vient du document du devoir
                        let fromDocument = false;
                        for(const docText of documentTexts) {
                            if(pastedText.length > 15 && docText.includes(pastedText)) {
                                fromDocument = true;
                                break;
                            }
                        }
                        
                        if(fromDocument) {
                            documentPastes++;
                        } else {
                            externalPastes++;
                        }
                        
                        // Logger
                        const questionNum = this.getAttribute('data-qid') || 'unknown';
                        if(!pasteLog[questionNum]) pasteLog[questionNum] = {external: 0, document: 0};
                        if(fromDocument) {
                            pasteLog[questionNum].document++;
                        } else {
                            pasteLog[questionNum].external++;
                        }
                        
                        // Sauvegarder dans localStorage
                        localStorage.setItem('paste_log_' + MON_ID_DEVOIR, JSON.stringify({
                            total: totalPastes,
                            external: externalPastes,
                            document: documentPastes,
                            details: pasteLog,
                            timestamp: new Date().toISOString()
                        }));
                        
                        // Afficher l'avertissement (seulement pour les collages externes)
                        if(!fromDocument) {
                            showPasteWarning(totalPastes, true);
                        }
                    });
                });
                // ‚≠ê FIN Syst√®me anti-copier-coller

                // --- BLOC S√âCURIT√â MOBILE (Liens absolus GitHub) ---
                // ‚ö†Ô∏è IMPORTANT : Charger UNIQUEMENT si pas en mode prof (√©vite demande code dans Master)
                if(!document.body.classList.contains('teacher-mode') && !document.body.classList.contains('builder-view')) {
                    const baseUrl = "https://preventionsanteenvironnement.github.io/PSE/assets/";
                    
                    console.log("üöÄ Chargement s√©curis√© des scripts depuis : " + baseUrl);

                    // 1. Charger l'Annuaire (racine PSE)
                    const s1 = document.createElement('script');
                    s1.src = "https://preventionsanteenvironnement.github.io/PSE/annuaire.js";
                    s1.type = "module";
                    s1.onload = async () => {
                        console.log("‚úÖ Annuaire charg√©");
                        if(typeof window.demanderCode === 'function') {
                            const user = await window.demanderCode("${titre}");
                            if(user && user.code) {
                                const codeInput = document.getElementById('code-eleve');
                                if(codeInput) codeInput.value = user.code;
                            }
                        }
                    };
                    s1.onerror = () => console.warn("‚ö†Ô∏è Annuaire non charg√© (Pas de connexion ?)");
                    document.body.appendChild(s1);

                    // 2. Charger le Facteur (Runner)
                    const s2 = document.createElement('script');
                    s2.src = baseUrl + "pse-runner.js";
                    s2.type = "module";
                    
                    s2.onload = () => console.log("‚úÖ Syst√®me d'envoi pr√™t !");
                    s2.onerror = () => alert("‚ö†Ô∏è ATTENTION : Impossible de charger le syst√®me d'envoi.\\\\nV√©rifiez votre connexion internet (Wifi/4G).");
                    
                    document.body.appendChild(s2);
                }
                // --- FIN BLOC S√âCURIT√â MOBILE ---
            });

            window.tenterEnvoi = async function() {  // ‚≠ê CHANGEMENT 1: Ajout async
    // ‚≠ê NOUVEAU : V√©rification du code √©l√®ve OBLIGATOIRE + VALIDATION
    const codeInput = document.getElementById('code-eleve');
    const code = codeInput ? codeInput.value.trim().toUpperCase() : '';
    
    // BLOQUER si code vide ou trop court
    if(!code || code.length < 3) {
        alert("‚ö†Ô∏è CODE √âL√àVE MANQUANT\\n\\n" +
              "Vous devez saisir votre code √©l√®ve en haut du devoir " +
              "avant d'envoyer votre copie.\\n\\n" +
              "Sans code, votre copie ne pourra pas √™tre identifi√©e.");
        
        // Mettre le focus sur le champ code avec animation
        if(codeInput) {
            codeInput.focus();
            codeInput.style.border = "3px solid red";
            codeInput.style.animation = "pulse 1s";
            setTimeout(() => {
                codeInput.style.border = "";
                codeInput.style.animation = "";
            }, 2000);
        }
        
        return; // STOP, on n'envoie pas
    }
    
    // ‚≠ê CHANGEMENT 2: VALIDATION du code dans l'annuaire (FORMAT ANNUAIRE)
    let eleveData = null;
    if(typeof ANNUAIRE !== 'undefined') {
        const classe = ANNUAIRE[code];
        

// ‚≠ê AJOUTER CES LIGNES ICI ‚≠ê
if(classe) {
    eleveData = {
        code: code,
        prenom: code,  // On utilise le code comme identifiant
        nom: "",
        classe: classe
    };
}

if(!classe) {
      
            alert("‚ùå CODE INVALIDE\\n\\n" +
                  "Le code ¬´ " + code + " ¬ª n'existe pas dans l'annuaire.\\n\\n" +
                  "V√©rifiez votre code ou contactez votre professeur.\\n\\n" +
                  "üí° Conseil : Votre code est compos√© de 4 caract√®res (ex: KA47).");
            
            if(codeInput) {
                codeInput.focus();
                codeInput.select(); // S√©lectionner le texte pour remplacement facile
                codeInput.style.border = "3px solid red";
                setTimeout(() => {
                    codeInput.style.border = "";
                }, 2000);
            }
            
            return; // ‚õî STOP : Code invalide, on n'envoie PAS
        }
        
        console.log("‚úÖ Code valid√© pour:", eleveData.prenom, eleveData.nom);
    } else {
        console.warn("‚ö†Ô∏è Annuaire non charg√© - Validation du code impossible");
        // On continue quand m√™me pour permettre l'envoi (mode d√©grad√©)
    }
    
    // Compter les r√©ponses vides
    const rep = document.querySelectorAll('.reponse-eleve');
    let vides = 0;
    rep.forEach(r => { if(!r.value.trim()) vides++; });
    
    // R√©cup√©rer les stats de copier-coller
    const pasteStats = JSON.parse(localStorage.getItem('paste_log_' + MON_ID_DEVOIR) || '{"total":0,"external":0,"document":0}');
    
    // ‚≠ê CHANGEMENT 3: Message de confirmation am√©lior√© avec nom
    let msg = "üì§ CONFIRMER L'ENVOI\\n\\n";
    
    if(eleveData) {
        msg += "üë§ " + eleveData.prenom + " " + eleveData.nom + "\\n";
        msg += "üè´ Classe : " + eleveData.classe + "\\n";
    } else {
        msg += "Votre code : " + code + "\\n";
    }
    
    msg += "Nombre de r√©ponses : " + rep.length + "\\n";
    
    if(vides > 0) {
        msg += "\\n‚ö†Ô∏è Attention : " + vides + " question(s) vide(s)\\n";
    }
    
    if(pasteStats.total > 0) {
        msg += "\\nüìã Copier-coller d√©tect√©s :\\n";
        msg += "  ‚Ä¢ Depuis sources externes : " + pasteStats.external;
        if(pasteStats.external > 0) msg += " ‚ö†Ô∏è";
        msg += "\\n  ‚Ä¢ Depuis le document : " + pasteStats.document + "\\n";
    }
    
    msg += "\\n√ätes-vous s√ªr(e) de vouloir envoyer ?";
    
    if(confirm(msg)) {
        if(window.envoyerCopie) {
            // ‚≠ê CHANGEMENT 4: Passer eleveData en 3e param√®tre
            window.envoyerCopie(code, pasteStats, eleveData);
        } else {
            alert("‚ùå ERREUR SYST√àME\\n\\nLe syst√®me d'envoi n'est pas charg√©.\\nV√©rifiez votre connexion internet.");
        }
    }
};
        `;
        body.appendChild(sLogic);
        // ‚≠ê FIN CORRECTION BUG #8

        clone.querySelector('body').setAttribute('data-id-exercice', idDevoir);
        clone.querySelector('body').classList.add('student-view');

        // Style mobile + textareas auto-extend (√©l√®ve)
        const style = document.createElement('style');
        style.textContent = `
            body.student-view textarea{
                width:100%;
                box-sizing:border-box;
                overflow:hidden;
                resize:none;
            }
            @media (max-width: 700px){
                .container{ padding: 12px !important; }
                h1{ font-size: 1.6rem !important; }
                .student-info{ padding: 10px !important; }
                table{ display:block; overflow-x:auto; }
            }
        `;
        clone.querySelector('head')?.appendChild(style);


        // Style fig√© (lecture seule)
        const stLock = document.createElement('style');
        stLock.textContent = `/* student-lock */
          .student-view .num-static{display:inline-block; min-width:64px; padding:6px 10px; border:2px solid #e74c3c; border-radius:8px; font-weight:800; color:#c0392b; background:#fff;}
          .student-view input, .student-view select{font-size:1em;}
        `;
        clone.querySelector('head')?.appendChild(stLock);


        const btn = document.createElement('button');
        btn.innerText = "Envoyer au prof üì§";
        btn.style = "display:block; margin:60px auto; padding:15px 40px; background:#27ae60; color:white; border:none; border-radius:50px; cursor:pointer; font-size:1.3em; font-weight:bold;";
        btn.setAttribute('onclick', 'window.tenterEnvoi()');
        const ctn = clone.querySelector('.container') || body;
        ctn.appendChild(btn);

        const eleveHTML = "<!DOCTYPE html>\n" + clone.outerHTML;


        // T√©l√©chargements (2 fichiers)
        // ‚ö†Ô∏è Certains navigateurs bloquent le 2e t√©l√©chargement automatique.
        // On tente l‚Äôauto-download des deux, puis on affiche un panneau de liens cliquables en secours.
        const __files = [
          { name: idDevoir + "_eleve.html", type: "text/html", content: eleveHTML, label: "T√©l√©charger le devoir √©l√®ve (HTML)", hint: "fichier √©l√®ve" },
          { name: idDevoir + "_blueprint.json", type: "application/json", content: blueprintStr, label: "T√©l√©charger le blueprint (JSON)", hint: "fichier JSON" }
        ];

        // Auto-download (dans le m√™me clic)
        try { downloadFile(eleveHTML, idDevoir + "_eleve.html", "text/html"); } catch(e) {}
        try { downloadFile(blueprintStr, idDevoir + "_blueprint.json", "application/json"); } catch(e) {}

        // Secours : liens manuels (si blocage navigateur)
        try { openDownloadModal("Export termin√©", "Si un fichier ne s‚Äôest pas t√©l√©charg√©, cliquez sur les liens ci-dessous.", __files); } catch(e) {
          // fallback ultime
          alert("Export termin√©. Si un fichier manque, autorisez les t√©l√©chargements multiples dans le navigateur.");
        }

    }


// --- MODAL DE TELECHARGEMENT (liens cliquables) ---
let __dm_urls = [];
function openDownloadModal(title, subtitle, files){
  const modal = document.getElementById('download-modal');
  const links = document.getElementById('dm-links');
  const t = document.getElementById('dm-title');
  const s = document.getElementById('dm-sub');
  if(!modal || !links || !t || !s){
    // fallback (dernier recours)
    (files||[]).forEach(f => { try{ downloadFile(f.content, f.name, f.type); }catch(e){} });
    return;
  }
  closeDownloadModal(true);
  t.textContent = title || 'T√©l√©chargements';
  s.textContent = subtitle || '';
  links.innerHTML = '';
  (files||[]).forEach((f) => {
    const blob = new Blob([f.content], {type: f.type || 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    __dm_urls.push(url);
    const a = document.createElement('a');
    a.className = 'dm-link';
    a.href = url;
    a.download = f.name || 'fichier';
    a.target = '_blank';
    const left = document.createElement('span');
    left.textContent = f.label || ('T√©l√©charger ' + (f.name||'fichier'));
    const right = document.createElement('small');
    right.textContent = f.hint || 'ouvrir';
    a.appendChild(left);
    a.appendChild(right);
    links.appendChild(a);
  });
  modal.style.display = 'flex';
}
function closeDownloadModal(keepHidden){
  const modal = document.getElementById('download-modal');
  if(modal) modal.style.display = 'none';
  try{ __dm_urls.forEach(u => URL.revokeObjectURL(u)); }catch(e){}
  __dm_urls = [];
  if(keepHidden && modal) modal.style.display = 'none';
}
</script>

<script src="master_module_tableaux.js"></script>
<script>
            const MON_ID_DEVOIR = "devoir_PAD_v2";

            // ‚≠ê Fonction pour la matrice de risque (clics sur les cellules)
            function initRiskMatrix(scope){
              try {
                const root = scope || document;
                root.querySelectorAll('.risk-matrix-wrap').forEach(wrap => {
                  const hidden = wrap.querySelector('.risk-cell-value');
                  const displayDiv = wrap.querySelector('.risk-selection-display');
                  const displayText = wrap.querySelector('.risk-selection-text');
                  const cells = Array.from(wrap.querySelectorAll('.risk-cell'));
                  if(!cells.length) return;

                  // Fonction pour convertir data-pos en texte lisible
                  function posToText(pos) {
                    if (!pos) return '';
                    const [prob, grav] = pos.split('-');
                    const probTexts = {
                      'P1': 'Tr√®s improbable',
                      'P2': 'Improbable',
                      'P3': 'Probable',
                      'P4': 'Tr√®s probable'
                    };
                    const gravTexts = {
                      'G1': 'Faible',
                      'G2': 'Moyen',
                      'G3': 'Grave',
                      'G4': 'Tr√®s grave'
                    };
                    return `${probTexts[prob] || prob} + ${gravTexts[grav] || grav}`;
                  }

                  function applySelection(cell){
                    cells.forEach(c => c.classList.remove('selected'));
                    cell.classList.add('selected');
                    const pos = cell.getAttribute('data-pos') || '';
                    if(hidden) hidden.value = pos;

                    // Afficher le texte de s√©lection
                    if(displayDiv && displayText) {
                      displayDiv.style.display = 'block';
                      displayText.textContent = posToText(pos);
                    }

                    // Auto-d√©cision selon zone
                    const isPrio = cell.classList.contains('zone-prioritaire');
                    const wanted = isPrio ? 'prioritaire' : 'non_prioritaire';
                    const radio = wrap.querySelector('input[type="radio"][value="' + wanted + '"]');
                    if(radio) radio.checked = true;
                  }

                  // Restauration si d√©j√† une valeur
                  if(hidden && hidden.value){
                    const prev = cells.find(c => (c.getAttribute('data-pos')||'') === hidden.value);
                    if(prev) applySelection(prev);
                  }

                  cells.forEach(cell => {
                    cell.setAttribute('tabindex','0');
                    cell.setAttribute('role','gridcell');
                    cell.addEventListener('click', () => applySelection(cell));
                    cell.addEventListener('keydown', (e) => {
                      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); applySelection(cell); }
                    });
                  });
                });
              } catch(e){
                console.warn('initRiskMatrix warning', e);
              }
            }

            window.addEventListener('load', async () => {
                const autoGrow = (ta) => {
                    if(!ta) return;
                    ta.style.height = 'auto';
                    ta.style.height = (ta.scrollHeight + 2) + 'px';
                };

                // ‚≠ê CORRECTION BUG #6 : localStorage avec cl√©s plus sp√©cifiques
                document.querySelectorAll('textarea, input, select').forEach(el => {
                    const fieldId = el.getAttribute('data-qid') || el.id || 'field_' + Math.random();
                    const storageKey = 'autosave_' + MON_ID_DEVOIR + '_' + fieldId;
                    
                    const saved = localStorage.getItem(storageKey);
                    if(saved) el.value = saved;
                    if(el.tagName==='TEXTAREA') autoGrow(el);
                    
                    el.addEventListener('input', function() {
                        localStorage.setItem(storageKey, this.value);
                        if(this.tagName==='TEXTAREA') autoGrow(this);
                    });
                });

                // ‚≠ê Initialiser la matrice de risque (clics sur les cellules)
                initRiskMatrix(document);

                // ‚≠ê NOUVEAU : Syst√®me anti-copier-coller avec d√©tection source
                let totalPastes = 0;
                let externalPastes = 0;
                let documentPastes = 0;
                const pasteLog = {};

                // Collecter tout le texte des documents du devoir
                const documentTexts = Array.from(document.querySelectorAll('.doc-block, .consigne-simple, .text-block'))
                    .map(el => el.textContent.trim())
                    .filter(text => text.length > 20);

                // Fonction pour afficher l'avertissement fermable
                function showPasteWarning(count, isExternal) {
                    const warning = document.createElement('div');
                    warning.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border: 3px solid ${isExternal ? '#ff5722' : '#ff9800'};
                        border-radius: 10px;
                        padding: 20px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        z-index: 10000;
                        max-width: 90%;
                        width: 400px;
                        animation: slideIn 0.3s;
                    `;
                    
                    warning.innerHTML = `
                        <style>
                            @keyframes slideIn {
                                from { transform: translate(-50%, -60%); opacity: 0; }
                                to { transform: translate(-50%, -50%); opacity: 1; }
                            }
                        </style>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="margin:0; color:${isExternal ? '#d32f2f' : '#f57c00'};">
                                ‚ö†Ô∏è COPIER-COLLER D√âTECT√â
                            </h3>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background:none; border:none; font-size:28px; cursor:pointer; color:#999; line-height:1;">
                                √ó
                            </button>
                        </div>
                        
                        <p style="margin:10px 0; line-height:1.5;">
                            Vous devez r√©diger vos <strong>propres r√©ponses</strong> avec vos <strong>propres mots</strong>.
                        </p>
                        
                        <div style="background:${isExternal ? '#ffebee' : '#fff3e0'}; padding:10px; border-radius:5px; margin:10px 0;">
                            <p style="margin:5px 0; font-size:0.9em; color:#666;">
                                <strong>Collages depuis sources externes :</strong> ${externalPastes} ${isExternal ? '‚ö†Ô∏è' : ''}<br>
                                <strong>Collages depuis le document :</strong> ${documentPastes}
                            </p>
                        </div>
                        
                        <p style="margin:10px 0; color:#d32f2f; font-size:0.9em; font-weight:bold;">
                            üîç Votre enseignant sera inform√©.
                        </p>
                        
                        <button onclick="this.parentElement.remove()" 
                                style="background:#2196F3; color:white; border:none; padding:12px 20px; 
                                       border-radius:5px; cursor:pointer; width:100%; font-size:16px; 
                                       margin-top:10px; font-weight:bold;">
                            J'ai compris
                        </button>
                    `;
                    
                    document.body.appendChild(warning);
                    
                    // Fermeture auto apr√®s 10 secondes
                    setTimeout(() => {
                        if(warning.parentElement) warning.remove();
                    }, 10000);
                }

                // Popup de r√®glement au d√©marrage
                function showRulesPopup() {
                    const rulesPopup = document.createElement('div');
                    rulesPopup.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        z-index: 20000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    
                    rulesPopup.innerHTML = `
                        <div style="background:white; border-radius:12px; padding:30px; max-width:500px; width:90%; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                            <h2 style="margin:0 0 20px 0; color:#1976d2; text-align:center;">
                                ‚ö†Ô∏è R√àGLEMENT DU DEVOIR
                            </h2>
                            
                            <p style="margin:15px 0; line-height:1.6;">
                                Ce devoir √©value vos <strong>COMP√âTENCES</strong>.
                            </p>
                            
                            <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin:15px 0;">
                                <p style="margin:5px 0; font-weight:bold; color:#2e7d32;">‚úÖ Vous devez :</p>
                                <ul style="margin:10px 0 0 20px; line-height:1.6;">
                                    <li>R√©diger vos propres r√©ponses</li>
                                    <li>Utiliser vos propres mots</li>
                                    <li>Montrer ce que VOUS savez faire</li>
                                </ul>
                            </div>
                            
                            <div style="background:#ffebee; padding:15px; border-radius:8px; margin:15px 0;">
                                <p style="margin:5px 0; font-weight:bold; color:#c62828;">‚ùå Interdit :</p>
                                <ul style="margin:10px 0 0 20px; line-height:1.6;">
                                    <li>Copier-coller depuis Internet</li>
                                    <li>Copier-coller depuis d'autres sources</li>
                                    <li>Recopier des r√©ponses toutes faites</li>
                                </ul>
                            </div>
                            
                            <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin:15px 0;">
                                <p style="margin:5px 0; font-weight:bold; color:#1565c0;">üí° Autoris√© :</p>
                                <p style="margin:10px 0 0 20px; line-height:1.6;">
                                    Relever des √©l√©ments du document du devoir<br>si la consigne le demande
                                </p>
                            </div>
                            
                            <p style="margin:15px 0; font-size:0.9em; color:#666; line-height:1.6;">
                                üîç <strong>Information :</strong> Les copier-coller sont d√©tect√©s et transmis √† votre enseignant.
                            </p>
                            
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background:#1976d2; color:white; border:none; padding:15px; 
                                           border-radius:8px; cursor:pointer; width:100%; font-size:18px; 
                                           font-weight:bold; margin-top:20px;">
                                J'ai compris et j'accepte
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(rulesPopup);
                }

                // Afficher le popup de r√®glement au d√©marrage
                setTimeout(showRulesPopup, 1000);

                // Attacher les d√©tecteurs de copier-coller
                document.querySelectorAll('textarea.reponse-eleve').forEach(textarea => {
                    textarea.addEventListener('paste', function(e) {
                        const pastedText = e.clipboardData.getData('text').trim();
                        if(!pastedText) return;
                        
                        totalPastes++;
                        
                        // V√©rifier si le texte vient du document du devoir
                        let fromDocument = false;
                        for(const docText of documentTexts) {
                            if(pastedText.length > 15 && docText.includes(pastedText)) {
                                fromDocument = true;
                                break;
                            }
                        }
                        
                        if(fromDocument) {
                            documentPastes++;
                        } else {
                            externalPastes++;
                        }
                        
                        // Logger
                        const questionNum = this.getAttribute('data-qid') || 'unknown';
                        if(!pasteLog[questionNum]) pasteLog[questionNum] = {external: 0, document: 0};
                        if(fromDocument) {
                            pasteLog[questionNum].document++;
                        } else {
                            pasteLog[questionNum].external++;
                        }
                        
                        // Sauvegarder dans localStorage
                        localStorage.setItem('paste_log_' + MON_ID_DEVOIR, JSON.stringify({
                            total: totalPastes,
                            external: externalPastes,
                            document: documentPastes,
                            details: pasteLog,
                            timestamp: new Date().toISOString()
                        }));
                        
                        // Afficher l'avertissement (seulement pour les collages externes)
                        if(!fromDocument) {
                            showPasteWarning(totalPastes, true);
                        }
                    });
                });
                // ‚≠ê FIN Syst√®me anti-copier-coller

                // --- BLOC S√âCURIT√â MOBILE (Liens absolus GitHub) ---
                // ‚ö†Ô∏è IMPORTANT : Charger UNIQUEMENT si pas en mode prof (√©vite demande code dans Master)
                if(!document.body.classList.contains('teacher-mode') && !document.body.classList.contains('builder-view')) {
                    const baseUrl = "https://preventionsanteenvironnement.github.io/PSE/assets/";
                    
                    console.log("üöÄ Chargement s√©curis√© des scripts depuis : " + baseUrl);

                    // 1. Charger l'Annuaire (racine PSE)
                    const s1 = document.createElement('script');
                    s1.src = "https://preventionsanteenvironnement.github.io/PSE/annuaire.js";
                    s1.type = "module";
                    s1.onload = async () => {
                        console.log("‚úÖ Annuaire charg√©");
                        if(typeof window.demanderCode === 'function') {
                            const user = await window.demanderCode("PROCESSUS D'APPARITION D'UN DOMMAGE");
                            if(user && user.code) {
                                const codeInput = document.getElementById('code-eleve');
                                if(codeInput) codeInput.value = user.code;
                            }
                        }
                    };
                    s1.onerror = () => console.warn("‚ö†Ô∏è Annuaire non charg√© (Pas de connexion ?)");
                    document.body.appendChild(s1);

                    // 2. Charger le Facteur (Runner)
                    const s2 = document.createElement('script');
                    s2.src = baseUrl + "pse-runner.js";
                    s2.type = "module";
                    
                    s2.onload = () => console.log("‚úÖ Syst√®me d'envoi pr√™t !");
                    s2.onerror = () => alert("‚ö†Ô∏è ATTENTION : Impossible de charger le syst√®me d'envoi.\\nV√©rifiez votre connexion internet (Wifi/4G).");
                    
                    document.body.appendChild(s2);
                }
                // --- FIN BLOC S√âCURIT√â MOBILE ---
            });

            window.tenterEnvoi = async function() {  // ‚≠ê CHANGEMENT 1: Ajout async
    // ‚≠ê NOUVEAU : V√©rification du code √©l√®ve OBLIGATOIRE + VALIDATION
    const codeInput = document.getElementById('code-eleve');
    const code = codeInput ? codeInput.value.trim().toUpperCase() : '';
    
    // BLOQUER si code vide ou trop court
    if(!code || code.length < 3) {
        alert("‚ö†Ô∏è CODE √âL√àVE MANQUANT\n\n" +
              "Vous devez saisir votre code √©l√®ve en haut du devoir " +
              "avant d'envoyer votre copie.\n\n" +
              "Sans code, votre copie ne pourra pas √™tre identifi√©e.");
        
        // Mettre le focus sur le champ code avec animation
        if(codeInput) {
            codeInput.focus();
            codeInput.style.border = "3px solid red";
            codeInput.style.animation = "pulse 1s";
            setTimeout(() => {
                codeInput.style.border = "";
                codeInput.style.animation = "";
            }, 2000);
        }
        
        return; // STOP, on n'envoie pas
    }
    
    // ‚≠ê CHANGEMENT 2: VALIDATION du code dans l'annuaire (FORMAT ANNUAIRE)
    let eleveData = null;
    if(typeof ANNUAIRE !== 'undefined') {
        const classe = ANNUAIRE[code];
        

// ‚≠ê AJOUTER CES LIGNES ICI ‚≠ê
if(classe) {
    eleveData = {
        code: code,
        prenom: code,  // On utilise le code comme identifiant
        nom: "",
        classe: classe
    };
}

if(!classe) {
      
            alert("‚ùå CODE INVALIDE\n\n" +
                  "Le code ¬´ " + code + " ¬ª n'existe pas dans l'annuaire.\n\n" +
                  "V√©rifiez votre code ou contactez votre professeur.\n\n" +
                  "üí° Conseil : Votre code est compos√© de 4 caract√®res (ex: KA47).");
            
            if(codeInput) {
                codeInput.focus();
                codeInput.select(); // S√©lectionner le texte pour remplacement facile
                codeInput.style.border = "3px solid red";
                setTimeout(() => {
                    codeInput.style.border = "";
                }, 2000);
            }
            
            return; // ‚õî STOP : Code invalide, on n'envoie PAS
        }
        
        console.log("‚úÖ Code valid√© pour:", eleveData.prenom, eleveData.nom);
    } else {
        console.warn("‚ö†Ô∏è Annuaire non charg√© - Validation du code impossible");
        // On continue quand m√™me pour permettre l'envoi (mode d√©grad√©)
    }
    
    // Compter les r√©ponses vides
    const rep = document.querySelectorAll('.reponse-eleve');
    let vides = 0;
    rep.forEach(r => { if(!r.value.trim()) vides++; });
    
    // R√©cup√©rer les stats de copier-coller
    const pasteStats = JSON.parse(localStorage.getItem('paste_log_' + MON_ID_DEVOIR) || '{"total":0,"external":0,"document":0}');
    
    // ‚≠ê CHANGEMENT 3: Message de confirmation am√©lior√© avec nom
    let msg = "üì§ CONFIRMER L'ENVOI\n\n";
    
    if(eleveData) {
        msg += "üë§ " + eleveData.prenom + " " + eleveData.nom + "\n";
        msg += "üè´ Classe : " + eleveData.classe + "\n";
    } else {
        msg += "Votre code : " + code + "\n";
    }
    
    msg += "Nombre de r√©ponses : " + rep.length + "\n";
    
    if(vides > 0) {
        msg += "\n‚ö†Ô∏è Attention : " + vides + " question(s) vide(s)\n";
    }
    
    if(pasteStats.total > 0) {
        msg += "\nüìã Copier-coller d√©tect√©s :\n";
        msg += "  ‚Ä¢ Depuis sources externes : " + pasteStats.external;
        if(pasteStats.external > 0) msg += " ‚ö†Ô∏è";
        msg += "\n  ‚Ä¢ Depuis le document : " + pasteStats.document + "\n";
    }
    
    msg += "\n√ätes-vous s√ªr(e) de vouloir envoyer ?";
    
    if(confirm(msg)) {
        if(window.envoyerCopie) {
            // ‚≠ê CHANGEMENT 4: Passer eleveData en 3e param√®tre
            window.envoyerCopie(code, pasteStats, eleveData);
        } else {
            alert("‚ùå ERREUR SYST√àME\n\nLe syst√®me d'envoi n'est pas charg√©.\nV√©rifiez votre connexion internet.");
        }
    }
};
        </script></body></html>
