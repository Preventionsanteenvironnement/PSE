<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PROCESSUS D'APPARITION D'UN DOMMAGE (V2)</title>
  <style>
    :root { --max: 980px; --bd:#e5e7eb; --txt:#0f172a; --mut:#64748b; --bg:#ffffff; --card:#f8fafc; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; color:var(--txt); background:var(--bg); }
    header { padding:18px 14px; border-bottom:1px solid var(--bd); background:linear-gradient(180deg,#fff, #f8fafc); }
    .wrap { max-width: var(--max); margin:0 auto; }
    h1 { margin:0; font-size:1.2rem; }
    .sub { color:var(--mut); font-size:0.95rem; margin-top:6px; line-height:1.35; }
    main { padding:14px; }
    .card { border:1px solid var(--bd); border-radius:12px; padding:12px; background:var(--card); margin:12px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .field { flex:1 1 220px; display:flex; flex-direction:column; gap:6px; }
    label { font-weight:700; font-size:0.92rem; }
    input, textarea { font: inherit; padding:10px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    textarea { min-height:64px; resize:vertical; }
    .qhead { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .meta { color:var(--mut); font-size:0.85rem; white-space:nowrap; }
    .qtitle { font-weight:800; }
    .qtext { margin-top:8px; color:#111827; line-height:1.4; }
    .help { color:var(--mut); font-size:0.9rem; margin-top:6px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:12px 14px; border-radius:12px; border:1px solid #0ea5e9; background:#0ea5e9; color:white; font-weight:800; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn2 { border:1px solid var(--bd); background:white; color:#111827; }
    .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .ok { padding:10px 12px; border:1px solid #16a34a; color:#166534; background:#dcfce7; border-radius:12px; display:none; }
    .err { padding:10px 12px; border:1px solid #dc2626; color:#991b1b; background:#fee2e2; border-radius:12px; display:none; }
    .small { font-size:0.85rem; color:var(--mut); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>PROCESSUS D'APPARITION D'UN DOMMAGE (V2)</h1>
      <div class="sub">
        Remplis les r√©ponses puis clique sur <b>Envoyer</b>.<br>
        Important : les r√©ponses sont enregistr√©es quand tu envoies. Ne ferme pas la page avant le message de confirmation.
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="qhead">
        <div>
          <div class="qtitle">Identification</div>
          <div class="help">Ton code √©l√®ve sert √† retrouver ta copie. Si tu ne le connais pas, demande au professeur.</div>
        </div>
        <div class="meta">DevoirId : <b>devoir_1769147302728_v2</b></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label for="eleveCode">Code √©l√®ve</label>
          <input id="eleveCode" autocomplete="off" inputmode="text" placeholder="ex : B2MELEC_07" />
        </div>
        <div class="field">
          <label for="classe">Classe</label>
          <input id="classe" autocomplete="off" inputmode="text" placeholder="ex : 1JP / TMELEC / CAP..." />
        </div>
      </div>

      <div class="small" style="margin-top:10px;">
        Astuce : si tu reviens sur cette page, tes champs Code √©l√®ve / Classe se remplissent automatiquement.
      </div>
    </div>

    <div id="questions"></div>

    <div class="card">
      <div class="bar">
        <button id="btnSend" class="btn">‚úÖ Envoyer ma copie</button>
        <button id="btnSaveLocal" class="btn btn2" type="button">üíæ Sauvegarder en brouillon (sur cet appareil)</button>
        <div id="msgOk" class="ok">Copie envoy√©e. Tu peux fermer la page.</div>
        <div id="msgErr" class="err"></div>
      </div>
      <div class="small" style="margin-top:10px;">
        Si tu as un probl√®me de r√©seau, utilise le brouillon puis renvoie quand tu as du r√©seau.
      </div>
    </div>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const DEVOIR_ID = "devoir_1769147302728_v2";
  const BLUEPRINT_URL = "devoir_1769147302728_v2_blueprint.json?ts=" + Date.now();

  const PROCESS_FIELDS = ["Danger","Op√©rateur","Situation dangereuse","√âv√©nement dangereux","Dommage"];
  const PREV_FIELDS = ["Supprimer / r√©duire le risque","Protection collective","Protection individuelle","Information / formation"];

  const $ = (id) => document.getElementById(id);

  // Blocage collage (optionnel) : on bloque uniquement sur les champs r√©ponse
  function blockPasteOn(el) {
    el.addEventListener('paste', (e) => {
      e.preventDefault();
      alert("Coller n'est pas autoris√© dans les r√©ponses.");
    });
  }

  function escHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[c]);
  }

  function loadIdentity() {
    $("eleveCode").value = localStorage.getItem("pse_eleveCode") || "";
    $("classe").value = localStorage.getItem("pse_classe") || "";
  }

  function saveIdentity() {
    localStorage.setItem("pse_eleveCode", $("eleveCode").value.trim());
    localStorage.setItem("pse_classe", $("classe").value.trim());
  }

  async function loadBlueprint() {
    const r = await fetch(BLUEPRINT_URL, { cache: "no-store" });
    if (!r.ok) throw new Error("Blueprint introuvable : " + BLUEPRINT_URL);
    const bp = await r.json();
    const questions = extractQuestions(bp);
    if (!questions.length) throw new Error("Aucune question trouv√©e dans le blueprint.");
    renderQuestions(questions);
    // Recharger un brouillon local si pr√©sent
    const draftKey = "draft_" + DEVOIR_ID;
    const rawDraft = localStorage.getItem(draftKey);
    if (rawDraft) {
      try {
        const d = JSON.parse(rawDraft);
        hydrateAnswers(d.reponses || {});
      } catch(_) {}
    }
  }

  function extractQuestions(bp) {
    if (Array.isArray(bp?.questions) && bp.questions.length) return bp.questions;
    const out = [];
    function walk(blocks) {
      if (!Array.isArray(blocks)) return;
      for (const b of blocks) {
        if (b && b.type === "question") out.push(b);
        if (b && b.content) walk(b.content);
      }
    }
    walk(bp?.content);
    return out;
  }

  function renderQuestions(list) {
    const host = $("questions");
    host.innerHTML = "";
    list.forEach((q, idx) => {
      const type = q.typeQuestion || (String(q.questionText||"").toLowerCase().includes("mesures") ? "prevention" : "processus");
      const fields = Array.isArray(q.champs) && q.champs.length ? q.champs : (type === "prevention" ? PREV_FIELDS : PROCESS_FIELDS);
      const label = q.label || ("Q" + (idx+1));
      const comp = q.competence || "C6";
      const bareme = q.bareme ?? "";
      const qid = q.qid || ("q_" + idx);

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.qid = qid;
      card.dataset.type = type;

      card.innerHTML = `
        <div class="qhead">
          <div>
            <div class="qtitle">${escHtml(label)} ‚Äî ${escHtml(comp)}</div>
            <div class="qtext">${escHtml(q.questionText || "").replace(/\n/g,"<br>")}</div>
          </div>
          <div class="meta">Bar√®me : <b>${escHtml(bareme)}</b></div>
        </div>
        <div class="row" style="margin-top:10px;"></div>
      `;

      const row = card.querySelector(".row");

      fields.forEach((fname) => {
        const f = document.createElement("div");
        f.className = "field";
        const id = qid + "_" + fname.replace(/\W+/g,"_");
        f.innerHTML = `
          <label for="${id}">${escHtml(fname)}</label>
          <textarea id="${id}" data-qid="${qid}" data-field="${escHtml(fname)}" placeholder="Ta r√©ponse..."></textarea>
        `;
        const ta = f.querySelector("textarea");
        blockPasteOn(ta);
        row.appendChild(f);
      });

      host.appendChild(card);
    });
  }

  function collectAnswers() {
    const reponses = {};
    // On stocke chaque question sous forme de liste "Champ : valeur"
    document.querySelectorAll("textarea[data-qid]").forEach((ta) => {
      const qid = ta.dataset.qid;
      const field = ta.dataset.field;
      const val = (ta.value || "").trim();
      if (!reponses[qid]) reponses[qid] = [];
      reponses[qid].push(`${field} : ${val ? val : "(non r√©pondu)"}`);
    });
    return reponses;
  }

  function hydrateAnswers(reponses) {
    if (!reponses) return;
    for (const [qid, arr] of Object.entries(reponses)) {
      if (!Array.isArray(arr)) continue;
      for (const line of arr) {
        // line = "Champ : valeur"
        const parts = String(line).split(":");
        const field = parts[0]?.trim();
        const value = parts.slice(1).join(":").trim();
        const ta = document.querySelector(`textarea[data-qid="${qid}"][data-field="${CSS.escape(field)}"]`);
        if (ta) ta.value = (value === "(non r√©pondu)") ? "" : value;
      }
    }
  }

  function showOk() {
    $("msgErr").style.display = "none";
    $("msgOk").style.display = "block";
  }
  function showErr(msg) {
    $("msgOk").style.display = "none";
    $("msgErr").style.display = "block";
    $("msgErr").textContent = msg;
  }

  $("btnSaveLocal").addEventListener("click", () => {
    saveIdentity();
    const draftKey = "draft_" + DEVOIR_ID;
    const payload = {
      devoirId: DEVOIR_ID,
      savedAt: new Date().toISOString(),
      eleve: {
        userCode: $("eleveCode").value.trim(),
        classe: $("classe").value.trim()
      },
      reponses: collectAnswers()
    };
    localStorage.setItem(draftKey, JSON.stringify(payload));
    alert("Brouillon sauvegard√© sur cet appareil.");
  });

  $("btnSend").addEventListener("click", async () => {
    try {
      $("btnSend").disabled = true;
      saveIdentity();

      const userCode = $("eleveCode").value.trim();
      if (!userCode) throw new Error("Code √©l√®ve manquant.");

      const classe = $("classe").value.trim();

      const payload = {
        devoirId: DEVOIR_ID,
        titre: document.title,
        createdAt: serverTimestamp(),
        eleve: {
          userCode,
          classe
        },
        reponses: collectAnswers(),
        version: "v2"
      };

      const docRef = await addDoc(collection(db, "devoirs_rendus"), payload);

      // On supprime le brouillon local si pr√©sent
      const draftKey = "draft_" + DEVOIR_ID;
      localStorage.removeItem(draftKey);

      showOk();
      alert("Copie envoy√©e !\n\nIdentifiant : " + docRef.id);
    } catch (e) {
      showErr(e.message || String(e));
      alert("Erreur : " + (e.message || e));
      $("btnSend").disabled = false;
    }
  });

  loadIdentity();
  loadBlueprint().catch((e) => {
    showErr(e.message || String(e));
  });
</script>
</body>
</html>
