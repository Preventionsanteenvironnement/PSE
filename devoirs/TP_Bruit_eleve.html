<!DOCTYPE html>
<html lang="fr"><head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title>Devoir PSE - √âditeur (V39 - FINAL : ITAMaMi R√©par√© + Code √âl√®ve OK)</title>
<style>
    /* --- STYLE ECRAN (WEB) --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 950px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; padding-bottom: 150px; }
    .container { background-color: white; padding: 40px; box-shadow: 0 0 15px rgba(0,0,0,0.05); border-radius: 8px; position: relative; }
    
    input, textarea, select, button { font-size: inherit; font-family: inherit; }

    h1 { color: #2c3e50; text-align: center; font-size: 1.8em; margin-bottom: 30px; text-transform: uppercase; border-bottom: 3px solid #3498db; padding-bottom: 15px; }
    .main-title-editable { border-bottom: 2px dashed #ccc; padding: 0 10px; color: #3498db; cursor: text; }
    
    /* BANDEAU ELEVE */
    .student-info { background-color: #eef2f3; padding: 10px 15px; border-radius: 8px; border: 1px solid #bdc3c7; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: nowrap; }
    .input-group { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
    .input-group label { font-weight: bold; color: #555; font-size: 0.9em; margin: 0; }
    .input-group input { padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; width: 130px; }
    
    /* GRILLE EVALUATION */
    .eval-section { margin-bottom: 20px; border: 2px solid #2c3e50; }
    .eval-header { background-color: #2c3e50; color: white; padding: 8px; font-weight: bold; text-align: center; text-transform: uppercase; }
    table.eval-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    table.eval-table th, table.eval-table td { border: 1px solid #999; padding: 5px; text-align: center; }
    table.eval-table th { background-color: #ecf0f1; }
    .row-c6 { background-color: #fff8e1; border-top: 2px solid #aaa; }
    .row-c6 input.point-input-c6 { width: 45px; text-align: center; border: 1px solid #aaa; border-radius: 3px; background-color: #fff; padding: 2px; }
    .c6-text-editable { font-style: italic; cursor: text; border-bottom: 1px dashed #ccc; padding: 2px; font-size: 0.9em; font-weight: bold;}
    .print-only { display: none; }
    .legend-inline { font-size: 0.7em; font-weight: normal; color: #555; float: left; text-align: left; line-height: 1.1; font-style: italic; padding-left: 5px;}

    /* BLOCS QUESTIONS */
    .question-block { margin-bottom: 30px; background-color: #fff; border: 1px solid #ddd; border-left: 4px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; padding: 0; }
    .q-meta-bar { background-color: #f8f9fa; border-bottom: 1px solid #eee; padding: 5px 10px; text-align: right; display: flex; justify-content: flex-end; align-items: center; height: 30px; }
    .q-content-row { padding: 15px; display: flex; align-items: flex-start; gap: 15px; }
    .num-selector-wrapper { flex-shrink: 0; }
    .editable-text { flex-grow: 1; border-bottom: 1px dashed transparent; cursor: text; padding: 2px 5px; font-weight: normal; min-height: 24px; color: inherit; }
    .editable-text:hover { border-bottom: 1px dashed #bbb; } 
    [contenteditable="true"]:focus { outline: 2px solid #3498db; background-color: #fff; border-radius: 3px; border-bottom: none; }
    .exo-container { padding: 0 15px 15px 15px; }

    /* CORRIG√â */
    .answer-key-zone { margin-top: 10px; border-top: 1px solid #eee; padding: 10px; background-color: #fff7e6; border: 1px dashed #e67e22; border-radius: 6px; }
    .answer-key-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
    .answer-key-label { font-weight: bold; color: #d35400; }
    .answer-key-area { width: 100%; min-height: 60px; border: 1px dashed #e67e22; background-color: #fff3d6; color: #7a4a00; font-size: 0.9em; padding: 8px; border-radius: 4px; resize: vertical; box-sizing: border-box; }

    /* SELECTEURS */
    select.comp-selector { background-color: #e8f8f5; color: #16a085; border: 1px solid #16a085; border-radius: 4px; padding: 3px; font-weight: bold; cursor: pointer; font-size: 0.8em; }
    select.num-selector { color: #e74c3c; font-size: 1.1em; font-weight: bold; border: 1px solid #e74c3c; background-color: #fff; padding: 3px; border-radius: 4px; cursor: pointer; min-width: 60px; }
    .points-wrapper { display: flex; align-items: center; font-size: 0.9em; color: #333; white-space: nowrap; margin-left: 10px; background-color: #f9f9f9; padding: 5px; border-radius: 4px; border: 1px solid #eee; }
    input.point-input { width: 45px; padding: 3px; margin: 0 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; color: #7f8c8d; }
    input.student-score { width: 45px; padding: 3px; margin-right: 5px; border: 2px solid #2980b9; border-radius: 4px; text-align: center; font-weight: bold; color: #2980b9; background-color: #eaf2f8; }
    .print-only-grade { display: none; } 

    textarea.reponse-eleve { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Courier New', Courier, monospace; min-height: 60px; resize: vertical; background-color: #fafafa; box-sizing: border-box; }
    table.exo-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table.exo-table td { border: 1px solid #ddd; padding: 10px; vertical-align: top; }
    
    .img-container { text-align: center; margin: 10px 0; position: relative; display: inline-block; width: 100%; cursor: pointer; border: 2px dashed #3498db; padding: 5px; background: #f0f9ff; }
    .img-container img { max-width: 100%; height: auto; border: 1px solid #ddd; }

    /* STRUCTURE */
    .section-block { margin: 30px 0 20px 0; padding: 10px; position: relative; text-align: center; border-top: 2px solid #eee; border-bottom: 2px solid #eee; }
    .section-title-editable { font-size: 1.4em; font-weight: bold; color: #2c3e50; text-transform: uppercase; letter-spacing: 1px; cursor: text; border: none; background: transparent; width: 100%; text-align: center; }
    .doc-block, .text-block { margin-bottom: 15px; padding: 10px; padding-right: 110px; background-color: #fff; border: 1px solid #eee; position: relative; }
    .numbered-header { display: flex; align-items: center; background-color: #e9ecef; border-left: 5px solid #34495e; padding: 10px; margin-top: 25px; margin-bottom: 15px; border-radius: 0 5px 5px 0; position: relative; padding-right: 110px; }
    .num-box { font-size: 1.5em; font-weight: bold; color: #34495e; margin-right: 15px; min-width: 30px; text-align: center; cursor: text; border-right: 2px solid #ccc; padding-right: 10px; }
    .text-box { font-size: 1.1em; font-weight: bold; color: #2c3e50; flex: 1; cursor: text; }
    
    /* ANALYSE (ITAMaMi) */
    .analysis-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .analysis-table td, .analysis-table th { border: 1px solid #ddd; padding: 10px; vertical-align: top; }
    .analysis-table th { background: #f8f9fa; text-align: left; width: 28%; }
    .analysis-label-editable { font-weight: bold; cursor: text; }

    /* ISHIKAWA */
    .ishikawa-wrapper { margin-top: 10px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #fbfbfb; }
    .ishikawa-tools { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center; margin-bottom: 10px; }
    .ishikawa-diagram { display: grid; grid-template-rows: auto 60px auto; gap: 12px; align-items: center; }
    .ishikawa-row { display: flex; gap: 10px; justify-content: space-between; flex-wrap: wrap; }
    .ish-cat { position: relative; flex: 1 1 180px; min-width: 180px; border: 1px solid #e5e7eb; border-radius: 10px; background: white; padding: 10px; }
    .ish-cat-title { font-weight: bold; color: #2c3e50; margin-bottom: 6px; cursor: text; }
    textarea.ish-cat-causes { width: 100%; min-height: 70px; resize: vertical; box-sizing: border-box; }
    .ish-spine { position: relative; height: 60px; display: flex; align-items: center; justify-content: flex-end; }
    .ish-line { position: absolute; left: 0; right: 160px; top: 50%; height: 4px; background: #3498db; border-radius: 4px; transform: translateY(-50%); }
    .ish-arrow { position: absolute; right: 160px; top: 50%; width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-left: 16px solid #3498db; transform: translateY(-50%); }
    .ish-effect-box { width: 150px; border: 2px solid #c0392b; border-radius: 10px; padding: 8px; background: #fff5f5; color: #c0392b; font-weight: bold; text-align: center; cursor: text; min-height: 44px; }
    .ish-hide-effect .ish-effect-box { display: none !important; }
    .ish-hide-effect .ish-line { right: 0 !important; }
    .ish-hide-effect .ish-arrow { right: 0 !important; }

    /* MATRICE RISQUE */
    .risk-matrix { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .risk-matrix td, .risk-matrix th { border: 1px solid #cbd5e1; padding: 8px; text-align: center; }
    .risk-matrix th { background: #f1f5f9; font-weight: 800; font-size: 13px; }
    .risk-cell { cursor: pointer; min-width: 70px; min-height: 44px; font-size: 18px; font-weight: 900; user-select: none; }
    .zone-nonprioritaire { background: #dcfce7; }
    .zone-prioritaire { background: #ffedd5; }
    .risk-cell.selected { outline: 3px solid rgba(37,99,235,.35); outline-offset: -3px; }
    .risk-gravite-wrap, .risk-matrix-wrap, .prevention-wrap, .st2-page { border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:#fff; margin-bottom:10px; }
    .risk-gravite-choices { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-bottom:12px; }
    .rg-choice { padding:10px; border:1px solid #eee; border-radius:8px; background:#f9f9f9; display:flex; gap:10px; align-items:center; }
    .prevention-table { width:100%; border-collapse:collapse; }
    .prevention-table th { background:#f1f5f9; text-align:left; padding:10px; }
    .prevention-table td { border:1px solid #eee; padding:10px; }

    /* ST2 */
    .st2-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .st2-box { border:1px solid #cbd5e1; padding:10px; border-radius:12px; background:#f8fafc; }
    .st2-boxtitle { font-weight:900; margin-bottom:6px; }
    .st2-ta { width:100%; resize:vertical; border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fff; }

    /* QCM / TROUS */
    .word-btn { display: inline-block; padding: 5px 10px; margin: 3px; background: #3498db; color: white; border-radius: 4px; cursor: pointer; font-size: 1rem; user-select: none; }
    .word-btn.hole-active { background: #bdc3c7; color: #7f8c8d; text-decoration: line-through; }
    input.trou-eleve { border: none; border-bottom: 2px solid #2c3e50; background: #f4f6f7; color: #2980b9; font-weight: bold; text-align: center; min-width: 120px; width: clamp(120px, 22vw, 240px); max-width: 260px; padding: 0 6px; }
    select.trou-eleve { border: 1px solid #3498db; background: #eaf2f8; color: #2c3e50; font-weight: bold; padding: 2px 5px; border-radius: 4px; }
    .word-bank { margin: 12px 0 8px 0; padding: 10px; background: #eef6ff; border: 1px solid #cfe3ff; border-radius: 10px; }
    .word-bank-title { font-weight: bold; color: #2c3e50; margin-bottom: 6px; }
    .word-chip { display: inline-block; padding: 6px 10px; margin: 4px; background: #3498db; color: white; border-radius: 999px; cursor: pointer; user-select: none; font-weight: 600; }
    .pair-row, .qcm-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
    .pair-input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    .qcm-option-input { flex: 1; padding: 5px; border: 1px solid #ccc; }
    .qcm-student-option { display: flex; align-items: center; margin-bottom: 8px; font-size: 1.05em; cursor: pointer; }
    .qcm-student-option input { transform: scale(1.3); margin-right: 10px; cursor: pointer; }

    /* OUTILS PROF */
    .tools-panel { position: fixed; bottom: 20px; right: 20px; left: 20px; display: flex; gap: 10px; z-index: 1000; justify-content: flex-end; flex-wrap: wrap; pointer-events: none; }
    .tools-panel > * { pointer-events: auto; }
    .btn-tool { padding: 12px 20px; border-radius: 30px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); color: white; transition: transform 0.2s; }
    .btn-tool:hover { transform: translateY(-2px); }
    .teacher-controls { display: block; margin-top: 10px; text-align: center; }
    .block-controls { position: absolute; top: -10px; right: -10px; display: flex; gap: 2px; background: #fff; padding: 2px; border-radius: 20px; border: 1px solid #ccc; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn-del-q { background: #c0392b; color: white; border: none; padding: 4px; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-move { background: #3498db; color: white; border: none; padding: 4px; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-add-q { background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin: 3px; }

    /* TOOLBAR FORMAT */
    #rich-format-toolbar { position: absolute; display: none; background: #34495e; padding: 5px; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 9999; flex-wrap: nowrap; gap: 5px; }
    .fmt-btn { background: transparent; border: none; color: white; cursor: pointer; padding: 5px 8px; font-weight: bold; }

    /* MODES */
    .builder-only { display: inline-flex; }
    .student-only { display: none; }
    body.student-view .teacher-controls, body.student-view .block-controls, body.student-view .tools-panel, body.student-view #rich-format-toolbar { display: none !important; }
    body.student-view .builder-only { display: none !important; }
    body.student-view .answer-key-zone { display: none !important; }
    body.student-view .print-only-grade { display: inline-block !important; }
    body.student-view input.point-input, body.student-view input.student-score, body.student-view .teacher-part, body.student-view .comp-selector { display: none !important; }
    
    @media print {
        .no-print, .tools-panel, .teacher-controls, .block-controls, .answer-key-zone { display: none !important; }
        .container { box-shadow: none; padding: 0; }
        .question-block { border: none; page-break-inside: avoid; }
        .print-only-grade { display: inline-block; }
    }
</style>

<script src="https://preventionsanteenvironnement.github.io/PSE/annuaire.js"></script>
<script>
    window.demanderCode = window.demanderCode || (async function(){ return { ok:true, code:(localStorage.getItem("userCode")||"PSE"), classe:(localStorage.getItem("userClasse")||"VISITEUR") }; });
</script>
</head>
<body class="builder-view teacher-mode student-view" data-id-exercice="devoir_1768662160288">





<div class="container">
    

    <h1><span class="main-title-editable">Titre du Devoir</span></h1>

    <div class="student-info">
                <div style="display:flex; gap:15px; align-items:center; justify-content:flex-end; padding:10px;">
                    <div style="background:#eef2f3; padding:5px 10px; border-radius:5px; border:1px solid #ccc; font-size:0.9em;">
                        CODE : <input type="text" id="code-eleve" style="font-weight:bold; color:#2c3e50; background:white; width:120px; text-align:center; border:1px solid #ccc;">
                    </div>
                    <input type="hidden" id="classe-eleve">
                </div>
            </div>

    

    <div class="questions-container"><div class="section-block"><input class="section-title-editable" value="NOUVELLE SECTION"></div><div class="text-block"><div class="editable-text"><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">En France, de nombreux adolescents en formation professionnelle passent une grande partie de leur temps libre devant les √©crans. En dehors des cours et de l‚ÄôEPS, ils pratiquent peu d‚Äôactivit√© physique. Cette s√©dentarit√© √©lev√©e peut avoir des cons√©quences sur leur sant√© physique, mentale et sociale. Les autorit√©s de sant√© rappellent l‚Äôimportance de bouger r√©guli√®rement pour pr√©server son capital sant√©.</span><br></div></div><div class="doc-block"><div class="editable-text" style="font-weight:bold; color:#d35400;">Document X</div><div class="img-container" onclick="triggerImgUpload(this)"><img src="https://via.placeholder.com/600x200?text=Image" alt="Doc"></div></div><div class="question-block"><div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <span>3</span> pts ( <span style="font-weight: bold;">C1</span> )<span class="print-only-grade">3 pts (C2)</span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><span style="font-weight: bold;">1</span></div><div class="editable-text"><strong style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">Analyser</strong><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">&nbsp;la situation en compl√©tant le tableau d‚Äôanalyse (QQOQCP)</span><br></div></div>
        <div class="exo-container"><table class="exo-table qqoqcp-table"><tbody><tr><td><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><span>Quoi ?</span></div></td><td><textarea class="reponse-eleve" data-qid="q_0_0"></textarea></td></tr><tr><td><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><span>Qui ?</span></div></td><td><textarea class="reponse-eleve" data-qid="q_0_1"></textarea></td></tr><tr><td><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><span>O√π ?</span></div></td><td><textarea class="reponse-eleve" data-qid="q_0_2"></textarea></td></tr><tr><td><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><span>Pourquoi ?</span></div></td><td><textarea class="reponse-eleve" data-qid="q_0_3"></textarea></td></tr></tbody></table></div>
        </div><div class="question-block"><div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <span>3</span> pts ( <span style="font-weight: bold;">C1</span> )<span class="print-only-grade">3 pts (C3)</span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><span style="font-weight: bold;">1</span></div><div class="editable-text"><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">√Ä l‚Äôaide de vos connaissances,&nbsp;<strong>expliquer</strong>&nbsp;ce que signifie la s√©dentarit√©.</span><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">&nbsp;</span>...</div></div><div class="exo-container"><textarea class="reponse-eleve" data-qid="q_1_0"></textarea></div></div><div class="doc-block"><div class="editable-text" style="font-weight:bold; color:#d35400;"><span class="doc-label" style="margin: 30px 0px 5px; display: block; caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">Document 1 : Le trajet de l‚Äôinformation nerveuse pour r√©aliser un mouvement</span></div><div class="img-container" onclick="triggerImgUpload(this)"><img src="images/devoirs/images/bienetre_mental.jpg" alt="Doc"></div></div><div class="text-block numbered-header"><div class="num-box">3</div><div class="text-box"><span style="font-weight: 400; caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif; font-size: medium;">√Ä l‚Äôaide du document 1&nbsp;</span><br></div></div><div class="question-block"><div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <span>3</span> pts ( <span style="font-weight: bold;">C1</span> )<span class="print-only-grade">3 pts (C3)</span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><span style="font-weight: bold;">1</span></div><div class="editable-text"><strong style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">Rep√©rer</strong><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">&nbsp;l‚Äôorgane qui commande le mouvement.</span>...</div></div><div class="exo-container"><textarea class="reponse-eleve" data-qid="q_2_0"></textarea></div></div><div class="question-block"><div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <span>2</span> pts ( <span style="font-weight: bold;">C1</span> )<span class="print-only-grade">2 pts (C5)</span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><span style="font-weight: bold;">1</span></div><div class="editable-text">D√©crire le trajet du message nerveux du cerveau jusqu‚Äôau muscle....</div></div><div class="exo-container"><textarea class="reponse-eleve" data-qid="q_3_0"></textarea></div></div><div class="doc-block"><div class="editable-text" style="font-weight:bold; color:#d35400;"><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">Document 2 : L‚Äôanatomie du muscle et la contraction musculaire</span><br></div><div class="img-container" onclick="triggerImgUpload(this)"><img src="https://via.placeholder.com/600x200?text=Image" alt="Doc"></div></div><div class="question-block"><div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <span>2</span> pts ( <span style="font-weight: bold;">C1</span> )<span class="print-only-grade">2 pts (C3)</span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><span style="font-weight: bold;">1</span></div><div class="editable-text"><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">4. √Ä l‚Äôaide du document 2,&nbsp;</span><strong style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">expliquer</strong><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">&nbsp;comment le muscle se contracte.</span>...</div></div><div class="exo-container"><textarea class="reponse-eleve" data-qid="q_4_0"></textarea></div></div><div class="doc-block"><div class="editable-text" style="font-weight:bold; color:#d35400;"><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">Document 3 : Les √©changes entre le sang et les muscles</span><br></div><div class="img-container" onclick="triggerImgUpload(this)"><img src="https://via.placeholder.com/600x200?text=Image" alt="Doc"></div></div><div class="text-block numbered-header"><div class="num-box">5</div><div class="text-box"><span style="font-weight: 400; caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif; font-size: medium;">&nbsp;√Ä l‚Äôaide du document 3 :</span><br></div></div><div class="question-block"><div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <span>2</span> pts ( <span style="font-weight: bold;">C1</span> )<span class="print-only-grade">2 pts (C4)</span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><span style="font-weight: bold;">1</span></div><div class="editable-text"><strong style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">Citer</strong><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">&nbsp;les deux √©l√©ments n√©cessaires au fonctionnement du muscle.</span>...</div></div><div class="exo-container"><textarea class="reponse-eleve" data-qid="q_5_0"></textarea></div></div><div class="question-block"><div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <span>3</span> pts ( <span style="font-weight: bold;">C1</span> )<span class="print-only-grade">3 pts (C4)</span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><span style="font-weight: bold;">1</span></div><div class="editable-text"><strong style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">Proposer</strong><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Arial, sans-serif;">&nbsp;deux activit√©s physiques simples permettant de respecter cette recommandation</span>...</div></div><div class="exo-container"><textarea class="reponse-eleve" data-qid="q_6_0"></textarea></div></div></div>
    
    
<button onclick="window.tenterEnvoi()" style="display: block; margin: 60px auto; padding: 15px 40px; background: rgb(39, 174, 96); color: white; border: medium; border-radius: 50px; cursor: pointer; font-size: 1.3em; font-weight: bold;">Envoyer au prof üì§</button></div>

<script>
    // --- GESTION IMAGE ---
    function triggerImgUpload(container) {
        const nom = prompt("Nom du fichier image (ex: schema.jpg) ?\n(L'image devra √™tre dans le dossier 'devoirs/images/')", "");
        if (nom) container.querySelector('img').src = "images/" + nom.trim();
    }

    // --- TOOLBAR ---
    const toolbar = document.getElementById('rich-format-toolbar');
    document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed) { toolbar.style.display = 'none'; return; }
        if (sel.anchorNode.parentElement.isContentEditable) {
            const rect = sel.getRangeAt(0).getBoundingClientRect();
            toolbar.style.display = 'flex';
            toolbar.style.top = (rect.top + window.scrollY - 40) + 'px';
            toolbar.style.left = (rect.left + window.scrollX) + 'px';
        } else { toolbar.style.display = 'none'; }
    });
    toolbar.addEventListener('mousedown', e => e.preventDefault());

    // --- UTILS ---
    function getControls() { return `<div class="block-controls no-print"><button class="btn-move" onclick="moveUp(this)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="moveDown(this)">‚¨áÔ∏è</button><button class="btn-del-q" onclick="this.parentElement.parentElement.remove(); updateGrid();">‚úñ</button></div>`; }
    function moveUp(btn) { const el = btn.parentElement.parentElement; if(el.previousElementSibling) el.parentNode.insertBefore(el, el.previousElementSibling); }
    function moveDown(btn) { const el = btn.parentElement.parentElement; if(el.nextElementSibling) el.parentNode.insertBefore(el.nextElementSibling, el); }
    function getNumOptions() { let h=""; for(let i=1;i<=20;i++){ h+=`<option value="${i}">${i}</option>`; for(let j=1;j<=9;j++) h+=`<option value="${i}.${j}">${i}.${j}</option>`; } return h; }
    function getCompOptions() { return `<option value="C1">C1</option><option value="C2">C2</option><option value="C3">C3</option><option value="C4">C4</option><option value="C5">C5</option><option value="C6">C6</option>`; }
    
    function initSelects(div) {
        div.querySelectorAll('.num-selector').forEach(s => { if(!s.innerHTML) s.innerHTML = getNumOptions(); s.addEventListener('change', updateGrid); });
        div.querySelectorAll('.comp-selector').forEach(s => { if(!s.innerHTML) s.innerHTML = getCompOptions(); s.addEventListener('change', updateGrid); });
        div.querySelectorAll('.point-input, .student-score').forEach(i => i.addEventListener('input', updateGrid));
    }
    
    function escapeHTML(str) { if(!str) return ""; return str.replace(/[&<>"']/g, function(m) { switch(m) { case '&': return '&amp;'; case '<': return '&lt;'; case '>': return '&gt;'; case '"': return '&quot;'; case "'": return '&#039;'; default: return m; } }); }

    // --- FONCTIONS AJOUT (INTEGRALES - VOS VERSIONS) ---
    function addQuestion() {
        const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="1" step="0.5"> pts ( <select class="comp-selector">${getCompOptions()}</select> )<span class="print-only-grade"></span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector">${getNumOptions()}</select></div><div class="editable-text" contenteditable="true">Question...</div></div><div class="exo-container"><textarea class="reponse-eleve"></textarea></div><div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area" placeholder="R√©ponse type..."></textarea></div>`;
        document.querySelector('.questions-container').appendChild(div); initSelects(div); updateGrid();
    }

    function addTableQuestion() {
        const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="2"> pts ( <select class="comp-selector">${getCompOptions()}</select> )<span class="print-only-grade"></span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector">${getNumOptions()}</select></div><div class="editable-text" contenteditable="true">Tableau QQOQCP.</div></div>
        <div class="exo-container"><table class="exo-table qqoqcp-table">${qqRowHTML("Quoi ?")}${qqRowHTML("Qui ?")}${qqRowHTML("O√π ?")}${qqRowHTML("Quand ?")}${qqRowHTML("Comment ?")}${qqRowHTML("Pourquoi ?")}</table><div class="teacher-controls" style="margin-top:10px;text-align:center;"><button class="btn-add-q" onclick="qqAddRow(this)" style="background:#34495e;">+ Ligne</button></div></div>
        <div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div>`;
        document.querySelector('.questions-container').appendChild(div); initSelects(div); updateGrid();
    }
    function qqRowHTML(l){return `<tr><td><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><span contenteditable="true">${l}</span><button class="btn-del-q" onclick="this.closest('tr').remove()" style="position:static;">‚úñ</button></div></td><td><textarea class="reponse-eleve"></textarea></td></tr>`;}
    function qqAddRow(btn){ const t=btn.closest('.exo-container').querySelector('table'); const tr=document.createElement('tr'); tr.innerHTML=qqRowHTML("Nouvelle ligne"); t.appendChild(tr);}

    // ITAMAMI (REMIS EN PLACE)
    function addITAMaMi() {
        const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="3"> pts ( <select class="comp-selector">${getCompOptions()}</select> )<span class="print-only-grade"></span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector">${getNumOptions()}</select></div><div class="editable-text" contenteditable="true">Tableau ITAMaMi.</div></div>
        <div class="exo-container"><table class="analysis-table"><tr><th>Individu</th><td><textarea class="reponse-eleve"></textarea></td></tr><tr><th>T√¢che</th><td><textarea class="reponse-eleve"></textarea></td></tr><tr><th>Activit√©</th><td><textarea class="reponse-eleve"></textarea></td></tr><tr><th>Mat√©riel</th><td><textarea class="reponse-eleve"></textarea></td></tr><tr><th>Milieu</th><td><textarea class="reponse-eleve"></textarea></td></tr></table><div class="teacher-controls" style="margin-top:10px;display:flex;gap:8px;justify-content:center;"><button class="btn-add-q" onclick="addAnalysisRow(this)" style="background:#16a085;">+ Ligne</button><button class="btn-add-q" onclick="itamamiToggleEffect(this)" style="background:#e67e22;">Effet</button></div></div>
        <div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div>`;
        document.querySelector('.questions-container').appendChild(div); initSelects(div); updateGrid();
    }
    function addAnalysisRow(btn) { const t=btn.closest('.exo-container').querySelector('table'); const tr=document.createElement('tr'); tr.innerHTML=`<th><div style="display:flex;align-items:center;justify-content:space-between;"><span contenteditable="true">Nouvelle entr√©e</span><button class="btn-del-q teacher-controls" onclick="this.closest('tr').remove()" style="position:static;">‚úñ</button></div></th><td><textarea class="reponse-eleve"></textarea></td>`; t.appendChild(tr); }
    function itamamiToggleEffect(btn) { const t=btn.closest('.exo-container').querySelector('table'); if(t.querySelector('.itamami-effect-row')) t.querySelector('.itamami-effect-row').remove(); else { const tr=document.createElement('tr'); tr.className='itamami-effect-row'; tr.innerHTML=`<th><span contenteditable="true">Effet / Dommage</span></th><td><textarea class="reponse-eleve"></textarea></td>`; t.appendChild(tr); } }

    // QCM COMPLET (VOTRE VERSION)
    function addQCM(btn) {
        const container = document.querySelector('.questions-container'); const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="1"> pts ( <select class="comp-selector">${getCompOptions()}</select> )<span class="print-only-grade"></span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector" data-defaut="1.5"></select></div><div class="editable-text" contenteditable="true" style="color:#8e44ad; font-weight:bold;">Cochez la bonne r√©ponse.</div></div><div class="exo-container"><div class="qcm-editor teacher-controls"><div style="margin-bottom:10px; background:#f5eef8; padding:5px; border-radius:4px;"><strong>Type :</strong> <label style="margin-right:15px; cursor:pointer;"><input type="radio" name="qcm-type-${Date.now()}" value="radio" checked> Unique</label><label style="cursor:pointer;"><input type="radio" name="qcm-type-${Date.now()}" value="checkbox"> Multiple</label></div><div class="qcm-options-container"></div><button class="btn-add-q" onclick="addQCMOption(this)" style="margin-top:10px; background:#8e44ad;">+ Option</button><button class="btn-save-master" onclick="finalizeQCM(this)">Valider</button></div><div class="qcm-result"></div></div><div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div></div>`;
        container.appendChild(div); initSelects(div); addQCMOption(div.querySelector('.btn-add-q')); addQCMOption(div.querySelector('.btn-add-q')); updateGrid();
    }
    function addQCMOption(btn) { const container = btn.parentElement.querySelector('.qcm-options-container'); const row = document.createElement('div'); row.className = 'qcm-row'; row.innerHTML = `<input type="text" class="qcm-option-input" placeholder="R√©ponse possible..."><button class="btn-del-q" style="position:static;" onclick="this.parentElement.remove()">‚úñ</button>`; container.appendChild(row); }
    function finalizeQCM(btn) { const editor = btn.parentElement; const resultArea = editor.closest('.question-block').querySelector('.qcm-result'); const type = editor.querySelector('input[type="radio"]:checked').value; const inputs = editor.querySelectorAll('.qcm-option-input'); let options = []; inputs.forEach(inp => { if(inp.value.trim()) options.push(inp.value.trim()); }); if(options.length < 1) return alert("Au moins une option !"); const groupName = 'qcm_group_' + Date.now() + Math.random().toString(36).substr(2, 5); let html = ''; options.forEach(opt => { html += `<label class="qcm-student-option"><input type="${type}" name="${groupName}" class="save-me-qcm"><span>${opt}</span></label>`; }); resultArea.innerHTML = html; editor.style.display = 'none'; }

    // CLOZE TEST COMPLET (VOTRE VERSION)
    function addClozeTest(btn) {
        const container = document.querySelector('.questions-container'); const div = document.createElement('div'); div.className = 'question-block'; const uid = Date.now();
        div.innerHTML = `${getControls()}<div class="q-meta-bar"><div class="points-wrapper"><input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()"><span class="teacher-part">/</span> <input type="number" class="point-input" value="2" step="0.5" oninput="updateGrid()"> <span class="teacher-part">pts (</span><select class="comp-selector" data-selected="C1" onchange="updateGrid()"></select><span class="teacher-part">)</span><span class="print-only-grade"></span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector" data-defaut="1.3"></select></div><div class="editable-text" contenteditable="true" style="color:#d35400; font-weight:bold;">Compl√©tez le texte.</div></div><div class="exo-container"><div class="cloze-editor teacher-controls"><textarea class="cloze-source" style="width:100%; height:90px; margin-bottom:10px;" placeholder="Collez votre texte ici..."></textarea><div style="margin-bottom: 10px;"><strong>Type :</strong> <label><input type="radio" name="cloze-mode-${uid}" value="input" checked> √âcriture</label> <label><input type="radio" name="cloze-mode-${uid}" value="select"> Liste</label> <label><input type="checkbox" class="cloze-show-bank"> Banque de mots</label></div><button class="btn-add-q" onclick="generateWordButtons(this)">1. D√©couper</button><button class="btn-add-q" style="background:#7f8c8d; display:none;" onclick="resetCloze(this)">‚Ü©Ô∏é Retour</button><div class="word-area" style="margin:10px 0;"></div><button class="btn-save-master" style="display:none;" onclick="finalizeCloze(this)">2. Valider</button></div><div class="cloze-result" style="line-height: 2em; font-size: 1.1em;"></div><div class="teacher-controls" style="text-align:center;"><button class="btn-add-q" style="background:#e67e22;" onclick="editCloze(this)">‚úèÔ∏è Modifier</button></div></div><div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div></div>`;
        container.appendChild(div); initSelects(div); updateGrid();
    }
    function generateWordButtons(btn) { const ed=btn.parentElement; const txt=ed.querySelector('textarea.cloze-source').value; const area=ed.querySelector('.word-area'); if(!txt.trim())return alert("Texte vide !"); const words=txt.split(/\s+/); area.innerHTML=""; words.forEach(w=>{ const s=document.createElement('span'); s.className='word-btn'; s.textContent=w; s.onclick=function(){this.classList.toggle('hole-active');}; area.appendChild(s); area.appendChild(document.createTextNode(" ")); }); ed.querySelector('.btn-save-master').style.display="inline-block"; ed.querySelector('button[onclick*="reset"]').style.display="inline-block"; btn.style.display="none"; ed.querySelector('textarea').style.display="none"; }
    function finalizeCloze(btn) { const ed=btn.parentElement; const res=ed.closest('.question-block').querySelector('.cloze-result'); const spans=ed.querySelectorAll('.word-btn'); const mode=ed.querySelector('input[type=radio]:checked').value; const bank=ed.querySelector('.cloze-show-bank').checked; let hidden=[]; spans.forEach(s=>{ if(s.classList.contains('hole-active')) hidden.push(s.textContent.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"")); }); hidden=[...new Set(hidden)].sort(()=>Math.random()-0.5); res.innerHTML=""; if(bank){ const b=document.createElement('div'); b.className='word-bank'; hidden.forEach(w=>{ b.innerHTML+=`<span class="word-chip">${w}</span> `; }); res.appendChild(b); } const d=document.createElement('div'); spans.forEach(s=>{ if(s.classList.contains('hole-active')){ if(mode=='input') d.innerHTML+=`<input type="text" class="trou-eleve save-me"> `; else { let o=`<option></option>`; hidden.forEach(w=>o+=`<option>${w}</option>`); d.innerHTML+=`<select class="trou-eleve save-me">${o}</select> `; } } else d.innerHTML+=s.textContent+" "; }); res.appendChild(d); ed.style.display='none'; }
    function resetCloze(btn){ const ed=btn.closest('.cloze-editor'); ed.querySelector('textarea').style.display="block"; ed.querySelector('.btn-save-master').style.display="none"; btn.style.display="none"; ed.querySelector('button[onclick*="generate"]').style.display="inline-block"; ed.querySelector('.word-area').innerHTML=""; }
    function editCloze(btn){ btn.closest('.question-block').querySelector('.cloze-editor').style.display="block"; }

    function addMatchingExercise(btn) {
        const container = document.querySelector('.questions-container'); const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `${getControls()}<div class="q-meta-bar"><div class="points-wrapper"><input type="number" class="student-score" value="" min="0" step="0.5" placeholder="Note" oninput="updateGrid()"><span class="teacher-part">/</span> <input type="number" class="point-input" value="2" step="0.5" oninput="updateGrid()"> <span class="teacher-part">pts (</span><select class="comp-selector" data-selected="C2" onchange="updateGrid()"></select><span class="teacher-part">)</span><span class="print-only-grade"></span></div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector" data-defaut="1.4"></select></div><div class="editable-text" contenteditable="true" style="color:#3498db; font-weight:bold;">Reliez chaque √©l√©ment.</div></div><div class="exo-container"><div class="matching-editor teacher-controls"><div class="pairs-container"></div><button class="btn-add-q" onclick="addPairRow(this)" style="margin-top:10px;">+ Paire</button><button class="btn-save-master" onclick="finalizeMatching(this)">Valider</button></div><div class="matching-result"></div></div><div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div></div>`;
        container.appendChild(div); initSelects(div); addPairRow(div.querySelector('.btn-add-q')); updateGrid();
    }
    function addPairRow(btn) { const c=btn.parentElement.querySelector('.pairs-container'); const r=document.createElement('div'); r.className='pair-row'; r.innerHTML=`<textarea class="pair-input pair-left" placeholder="Gauche"></textarea> ‚Æï <textarea class="pair-input pair-right" placeholder="Droite"></textarea><button class="btn-del-q" onclick="this.parentElement.remove()" style="position:static;">‚úñ</button>`; c.appendChild(r); }
    function finalizeMatching(btn) { const ed=btn.parentElement; const res=ed.closest('.question-block').querySelector('.matching-result'); const rows=ed.querySelectorAll('.pair-row'); let pairs=[], right=[]; rows.forEach(r=>{ const l=r.querySelector('.pair-left').value; const rg=r.querySelector('.pair-right').value; if(l&&rg){ pairs.push({l,r:rg}); right.push(rg); } }); if(pairs.length<2)return alert("2 paires min."); right.sort(()=>Math.random()-0.5); let h='<table class="matching-table">'; pairs.forEach((p,i)=>{ let o='<option></option>'; right.forEach(rt=>o+=`<option>${rt}</option>`); h+=`<tr><td>${p.l}</td><td>‚û°</td><td><select class="matching-select save-me-match">${o}</select></td></tr>`; }); h+='</table>'; res.innerHTML=h; ed.style.display='none'; }

    // --- AUTRES (VOS VERSIONS COMPLEXES) ---
    function addSimpleDoc() { const div = document.createElement('div'); div.className = 'doc-block'; div.innerHTML = `${getControls()}<div class="editable-text" contenteditable="true" style="font-weight:bold; color:#d35400;">Document X</div><div class="img-container" onclick="triggerImgUpload(this)"><img src="https://via.placeholder.com/600x200?text=Image" alt="Doc"></div>`; document.querySelector('.questions-container').appendChild(div); }
    function addSimpleText() { const div = document.createElement('div'); div.className = 'text-block'; div.innerHTML = `${getControls()}<div class="editable-text" contenteditable="true">Consigne...</div>`; document.querySelector('.questions-container').appendChild(div); }
    function addSectionTitle() { const div = document.createElement('div'); div.className = 'section-block'; div.innerHTML = `${getControls()}<input class="section-title-editable" value="NOUVELLE SECTION">`; document.querySelector('.questions-container').appendChild(div); }
    function addNumberedTitle() { const div = document.createElement('div'); div.className = 'text-block numbered-header'; div.innerHTML = `${getControls()}<div class="num-box" contenteditable="true">1</div><div class="text-box" contenteditable="true">Titre...</div>`; document.querySelector('.questions-container').appendChild(div); }
    
    function addIshikawa() { const div=document.createElement('div'); div.className='question-block'; div.innerHTML=`${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="4"> pts ( <select class="comp-selector">${getCompOptions()}</select> )</div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector">${getNumOptions()}</select></div><div class="editable-text" contenteditable="true">Diagramme Ishikawa.</div></div><div class="exo-container"><div class="ishikawa-wrapper"><div class="ishikawa-tools teacher-controls"><button class="btn-add-q" style="background:#c0392b;" onclick="ishAdd5M(this)">5M</button><button class="btn-add-q" style="background:#e67e22;" onclick="ishToggleEffect(this)">Effet</button><button class="btn-add-q" style="background:#3498db;" onclick="ishAddCategory(this)">+ Famille</button></div><div class="ishikawa-diagram"><div class="ishikawa-row ish-top"></div><div class="ish-spine"><div class="ish-line"></div><div class="ish-effect-box" contenteditable="true">Effet</div></div><div class="ishikawa-row ish-bottom"></div></div></div></div><div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div>`; document.querySelector('.questions-container').appendChild(div); initSelects(div); ishAdd5M(div.querySelector('.btn-add-q')); updateGrid(); }
    function ishAdd5M(btn){ const w=btn.closest('.ishikawa-wrapper'); const t=w.querySelector('.ish-top'); const b=w.querySelector('.ish-bottom'); t.innerHTML=""; b.innerHTML=""; ["Mati√®re","Milieu","Main d'≈ìuvre","Mat√©riel","M√©thode"].forEach((l,i)=>{ const d=document.createElement('div'); d.className='ish-cat'; d.innerHTML=`<div class="ish-cat-title" contenteditable="true">${l}</div><textarea class="reponse-eleve ish-cat-causes"></textarea>`; if(i%2==0) t.appendChild(d); else b.appendChild(d); }); }
    function ishAddCategory(btn){ const w=btn.closest('.ishikawa-wrapper'); const d=document.createElement('div'); d.className='ish-cat'; d.innerHTML=`<div class="ish-cat-title" contenteditable="true">Famille</div><textarea class="reponse-eleve ish-cat-causes"></textarea>`; w.querySelector('.ish-top').appendChild(d); }
    function ishToggleSide(btn){ const c=btn.closest('.ish-cat'); const w=btn.closest('.ishikawa-wrapper'); if(c.parentElement.classList.contains('ish-top')) w.querySelector('.ish-bottom').appendChild(c); else w.querySelector('.ish-top').appendChild(c); }
    function ishToggleEffect(btn){ btn.closest('.ishikawa-wrapper').classList.toggle('ish-hide-effect'); }

    function addGraviteDommage() { const div=document.createElement('div'); div.className='question-block'; const uid = Date.now(); div.innerHTML=`${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="1"> pts ( <select class="comp-selector">${getCompOptions()}</select> )</div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector">${getNumOptions()}</select></div><div class="editable-text" contenteditable="true">Gravit√©.</div></div><div class="exo-container"><div class="risk-gravite-wrap"><div class="risk-gravite-choices"><label class="rg-choice"><input type="radio" name="g${uid}" value="1"> Faible</label><label class="rg-choice"><input type="radio" name="g${uid}" value="2"> Moyen</label><label class="rg-choice"><input type="radio" name="g${uid}" value="3"> Grave</label><label class="rg-choice"><input type="radio" name="g${uid}" value="4"> Tr√®s grave</label></div><div class="risk-gravite-justif"><div class="rg-sub">Justification</div><textarea class="reponse-eleve rg-textarea"></textarea></div></div></div><div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div>`; document.querySelector('.questions-container').appendChild(div); initSelects(div); updateGrid(); }
    
    function addMesuresPrevention() { const div=document.createElement('div'); div.className='question-block'; div.innerHTML=`${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="2"> pts ( <select class="comp-selector">${getCompOptions()}</select> )</div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector">${getNumOptions()}</select></div><div class="editable-text" contenteditable="true">Pr√©vention.</div></div><div class="exo-container"><table class="prevention-table"><tr><th>Type</th><th>Mesure</th></tr><tr><td class="col-type">Intrins√®que</td><td><textarea class="reponse-eleve prev-cell"></textarea></td></tr><tr><td class="col-type">Collective</td><td><textarea class="reponse-eleve prev-cell"></textarea></td></tr><tr><td class="col-type">Individuelle</td><td><textarea class="reponse-eleve prev-cell"></textarea></td></tr><tr><td class="col-type">Information</td><td><textarea class="reponse-eleve prev-cell"></textarea></td></tr></table></div><div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div>`; document.querySelector('.questions-container').appendChild(div); initSelects(div); updateGrid(); }
    
    function addEvaluationRisque() {
        const div = document.createElement('div'); div.className = 'question-block'; const uid = Date.now();
        div.innerHTML = `${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="2"> pts ( <select class="comp-selector">${getCompOptions()}</select> )</div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector">${getNumOptions()}</select></div><div class="editable-text" contenteditable="true">Matrice des risques.</div></div>
        <div class="exo-container"><div class="risk-matrix-wrap"><div class="risk-grid"><table class="risk-matrix"><tr><th class="corner"></th><th>Faible</th><th>Moyen</th><th>Grave</th><th>Tr√®s Grave</th></tr><tr><th>Tr√®s Improbable</th><td class="risk-cell zone-nonprioritaire" data-pos="1"></td><td class="risk-cell zone-nonprioritaire" data-pos="2"></td><td class="risk-cell zone-nonprioritaire" data-pos="3"></td><td class="risk-cell zone-prioritaire" data-pos="4"></td></tr><tr><th>Improbable</th><td class="risk-cell zone-nonprioritaire" data-pos="2"></td><td class="risk-cell zone-nonprioritaire" data-pos="3"></td><td class="risk-cell zone-prioritaire" data-pos="4"></td><td class="risk-cell zone-prioritaire" data-pos="5"></td></tr><tr><th>Probable</th><td class="risk-cell zone-nonprioritaire" data-pos="3"></td><td class="risk-cell zone-prioritaire" data-pos="4"></td><td class="risk-cell zone-prioritaire" data-pos="5"></td><td class="risk-cell zone-prioritaire" data-pos="6"></td></tr><tr><th>Tr√®s Probable</th><td class="risk-cell zone-prioritaire" data-pos="4"></td><td class="risk-cell zone-prioritaire" data-pos="5"></td><td class="risk-cell zone-prioritaire" data-pos="6"></td><td class="risk-cell zone-prioritaire" data-pos="7"></td></tr></table></div><input type="hidden" class="risk-cell-value"><div class="risk-decision"><label class="risk-decision-choice"><input type="radio" name="d${uid}"> Non Prioritaire</label> <label class="risk-decision-choice"><input type="radio" name="d${uid}"> Prioritaire</label></div></div></div>
        <div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div>`;
        document.querySelector('.questions-container').appendChild(div); initSelects(div); initRiskMatrix(div); updateGrid();
    }

    function addSchemaSituationTravail() {
        const div = document.createElement('div'); div.className = 'question-block';
        div.innerHTML = `${getControls()}<div class="q-meta-bar"><div class="points-wrapper">Bar√®me : <input type="number" class="point-input" value="4"> pts ( <select class="comp-selector">${getCompOptions()}</select> )</div></div><div class="q-content-row"><div class="num-selector-wrapper"><select class="num-selector">${getNumOptions()}</select></div><div class="editable-text" contenteditable="true">Sch√©ma ST2.</div></div>
        <div class="exo-container">
            <div class="st2-page">
                <div class="st2-grid">
                    <div class="st2-box op"><div class="st2-boxtitle">Op√©rateur</div><div class="st2-hint">(√Çge, formation...)</div><textarea class="reponse-eleve st2-ta" rows="3"></textarea></div>
                    <div class="st2-box ent"><div class="st2-boxtitle">Entreprise</div><div class="st2-hint">(Moyens, mat√©riel...)</div><textarea class="reponse-eleve st2-ta" rows="3"></textarea></div>
                    <div class="st2-box pres"><div class="st2-boxtitle">Travail Prescrit</div><div class="st2-hint">(Consignes...)</div><textarea class="reponse-eleve st2-ta" rows="2"></textarea></div>
                    <div class="st2-box reel"><div class="st2-boxtitle">Travail R√©el</div><div class="st2-hint">(Activit√© r√©elle...)</div><textarea class="reponse-eleve st2-ta" rows="3"></textarea></div>
                    <div class="st2-box effop"><div class="st2-boxtitle">Effets Op√©rateur</div><textarea class="reponse-eleve st2-ta" rows="3"></textarea></div>
                    <div class="st2-box effent"><div class="st2-boxtitle">Effets Entreprise</div><textarea class="reponse-eleve st2-ta" rows="3"></textarea></div>
                </div>
            </div>
        </div>
        <div class="answer-key-zone"><div class="answer-key-header"><span class="answer-key-label">üü† Corrig√© :</span></div><textarea class="answer-key-area"></textarea></div>`;
        document.querySelector('.questions-container').appendChild(div); initSelects(div); updateGrid();
    }

    // --- FONCTION CRITIQUE RISQUE ---
    function initRiskMatrix(container) {
        const cells = container.querySelectorAll('.risk-cell');
        const input = container.querySelector('.risk-cell-value');
        cells.forEach(cell => {
            cell.addEventListener('click', function() {
                cells.forEach(c => { c.classList.remove('selected'); c.style.outline = 'none'; });
                this.classList.add('selected');
                this.style.outline = '3px solid #3498db';
                if(input) input.value = this.getAttribute('data-pos');
            });
        });
    }

    // --- GRILLE EVAL ---
    function updateGrid() {
        const body = document.getElementById('grid-body'); if(!body) return; body.innerHTML = "";
        let total = 0; let totalScore = 0;
        let data = {};
        
        document.querySelectorAll('.question-block').forEach(b => {
            const comp = b.querySelector('.comp-selector')?.value || "?";
            const num = b.querySelector('.num-selector')?.value || "?";
            const pts = parseFloat(b.querySelector('.point-input')?.value || 0);
            const score = parseFloat(b.querySelector('.student-score')?.value || 0);
            
            if(!data[comp]) data[comp] = { nums: [], pts: 0, score: 0 };
            data[comp].nums.push(num);
            data[comp].pts += pts;
            data[comp].score += score;
            total += pts; totalScore += score;
            
            const span = b.querySelector('.print-only-grade');
            if(span) span.innerText = `${pts} pts (${comp})`;
        });

        // C6
        const c6max = parseFloat(document.getElementById('c6-max')?.value || 0);
        const c6score = parseFloat(document.getElementById('c6-score')?.value || 0);
        total += c6max; totalScore += c6score;
        document.getElementById('c6-display-score').innerText = c6score;

        Object.keys(data).sort().forEach(k => {
            const row = `<tr><td><b>${k}</b></td><td>${data[k].nums.join(', ')}</td><td></td><td></td><td></td><td></td><td>${data[k].pts}</td><td><b>${data[k].score}</b></td></tr>`;
            body.innerHTML += row;
        });

        document.getElementById('total-bareme').innerText = "/ " + total;
        document.getElementById('total-obtenu').innerText = totalScore;
    }

    // --- SAUVEGARDE MASTER ---
    function saveMasterHTML() {
        document.querySelectorAll('input, textarea, select').forEach(e => { if(e.value) e.setAttribute('value',e.value); if(e.tagName=='TEXTAREA') e.textContent=e.value; });
        downloadFile("<!DOCTYPE html>\n"+document.documentElement.outerHTML, "Master_Sauvegarde.html", "text/html");
    }
    function downloadFile(c,n,t) { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([c],{type:t})); a.download=n; a.click(); }

    // --- EXPORT ELEVE (AVEC NETTOYAGE STRICT) ---
    function exportDevoir() { genererBlueprint(); }

    function genererBlueprint() {
        const idDevoir = "devoir_" + Date.now();
        const titre = document.querySelector('h1').innerText.trim() || "Devoir";

        // JSON
        const blueprint = { id: idDevoir, titre: titre, questions: [] };
        document.querySelectorAll('.question-block').forEach((b, idx) => {
            blueprint.questions.push({
                qid: "q_" + idx,
                label: b.querySelector('.num-selector')?.value || (idx+1),
                competence: b.querySelector('.comp-selector')?.value || "C?",
                bareme: parseFloat(b.querySelector('.point-input')?.value || 0),
                reponseAttendue: b.querySelector('.answer-key-area')?.value || ""
            });
            let subIdx = 0;
            b.querySelectorAll('textarea, input').forEach(inp => { 
                if(!inp.classList.contains('point-input')) inp.setAttribute('data-qid', "q_"+idx+"_"+(subIdx++)); 
            });
        });
        downloadFile(JSON.stringify(blueprint, null, 2), idDevoir + "_blueprint.json", "application/json");

        // HTML ELEVE
        const clone = document.documentElement.cloneNode(true);
        
        // 1. SUPPRESSION RADICALE des √©l√©ments profs (dont les boutons qui font planter ITAMaMi)
        clone.querySelectorAll('.no-print, .answer-key-zone, .teacher-controls, .block-controls, #main-tools, #rich-format-toolbar, #eval-section-container, .btn-del-q, .btn-add-q').forEach(e => e.remove());
        
        // 2. FIGER LES CONTENUS (Plus de contenteditable)
        clone.querySelectorAll('[contenteditable]').forEach(e => {
            e.removeAttribute('contenteditable');
        });

        // 3. FIGER LES SELECTS et INPUTS DE POINTS
        clone.querySelectorAll('select.num-selector, select.comp-selector').forEach(s => {
            const span = document.createElement('span');
            span.innerText = s.value;
            span.style.fontWeight = 'bold';
            s.parentNode.replaceChild(span, s);
        });
        clone.querySelectorAll('input.point-input').forEach(i => {
            const span = document.createElement('span');
            span.innerText = i.value;
            i.parentNode.replaceChild(span, i);
        });
        
        // 4. PRESERVER LES REPONSES VIDES
        clone.querySelectorAll('textarea.reponse-eleve').forEach(e => { e.value=""; e.textContent=""; });

        // RGPD : Code Seul (Input modifiable si pas connect√©)
        const oldInfo = clone.querySelector('.student-info');
        if(oldInfo) {
            oldInfo.innerHTML = `
                <div style="display:flex; gap:15px; align-items:center; justify-content:flex-end; padding:10px;">
                    <div style="background:#eef2f3; padding:5px 10px; border-radius:5px; border:1px solid #ccc; font-size:0.9em;">
                        CODE : <input type="text" id="code-eleve" style="font-weight:bold; color:#2c3e50; background:white; width:120px; text-align:center; border:1px solid #ccc;">
                    </div>
                    <input type="hidden" id="classe-eleve">
                </div>
            `;
        }

        const body = clone.querySelector('body');
        const s1 = document.createElement('script'); s1.src = "../annuaire.js"; body.appendChild(s1);
        const s2 = document.createElement('script'); s2.src = "../assets/pse-runner.js"; s2.type="module"; body.appendChild(s2);

        const sLogic = document.createElement('script');
        sLogic.textContent = `
            const MON_ID_DEVOIR = "${idDevoir}";
            window.addEventListener('load', async () => {
                // Restauration Auto
                document.querySelectorAll('textarea, input').forEach(el => {
                    const k = el.getAttribute('data-qid') || el.id;
                    const saved = localStorage.getItem('autosave_' + MON_ID_DEVOIR + '_' + k);
                    if(saved) el.value = saved;
                    el.addEventListener('input', function() {
                        localStorage.setItem('autosave_' + MON_ID_DEVOIR + '_' + k, this.value);
                    });
                });
                // Matrice Risque Interactive √âl√®ve
                const riskCells = document.querySelectorAll('.risk-cell');
                if(riskCells.length > 0) {
                     riskCells.forEach(cell => {
                        cell.addEventListener('click', function() {
                             // Trouver le groupe de cellules parent (la table)
                             const table = this.closest('table');
                             table.querySelectorAll('.risk-cell').forEach(c => { c.classList.remove('selected'); c.style.outline = 'none'; });
                             this.classList.add('selected');
                             this.style.outline = '3px solid #3498db';
                             const hiddenInput = this.closest('.risk-matrix-wrap').querySelector('.risk-cell-value');
                             if(hiddenInput) hiddenInput.value = this.getAttribute('data-pos');
                        });
                    });
                }
                
                if(typeof window.demanderCode === 'function') {
                    const user = await window.demanderCode("${titre}");
                    if(user && user.code) {
                        const codeField = document.getElementById('code-eleve');
                        if(codeField) codeField.value = user.code;
                        const cField = document.getElementById('classe-eleve');
                        if(cField) cField.value = user.classe;
                        sessionStorage.setItem('userClasse', user.classe);
                    }
                } else { alert("‚ö†Ô∏è Annuaire non charg√©."); }
            });
            window.tenterEnvoi = function() {
                const rep = document.querySelectorAll('.reponse-eleve');
                let vides = 0;
                rep.forEach(r => { if(!r.value.trim()) vides++; });
                let msg = "‚ö†Ô∏è Vous allez envoyer votre copie d√©finitive.\\n\\n";
                if(vides > 0) msg += "Il reste " + vides + " questions vides.\\n";
                msg += "Confirmer ?";
                if(confirm(msg)) { if(window.envoyerCopie) window.envoyerCopie(); else alert("Erreur d'envoi."); }
            };
        `;
        body.appendChild(sLogic);
        clone.querySelector('body').setAttribute('data-id-exercice', idDevoir);
        clone.querySelector('body').classList.add('student-view');
        
        const btn = document.createElement('button');
        btn.innerText = "Envoyer au prof üì§";
        btn.style = "display:block; margin:60px auto; padding:15px 40px; background:#27ae60; color:white; border:none; border-radius:50px; cursor:pointer; font-size:1.3em; font-weight:bold;";
        btn.setAttribute('onclick', 'window.tenterEnvoi()');
        clone.querySelector('.container').appendChild(btn);

        downloadFile("<!DOCTYPE html>\n"+clone.outerHTML, idDevoir + "_eleve.html", "text/html");
        alert("‚úÖ Export termin√© !");
    }
</script>

<script src="../annuaire.js"></script><script src="../assets/pse-runner.js" type="module"></script><script>
            const MON_ID_DEVOIR = "devoir_1768662160288";
            window.addEventListener('load', async () => {
                // Restauration Auto
                document.querySelectorAll('textarea, input').forEach(el => {
                    const k = el.getAttribute('data-qid') || el.id;
                    const saved = localStorage.getItem('autosave_' + MON_ID_DEVOIR + '_' + k);
                    if(saved) el.value = saved;
                    el.addEventListener('input', function() {
                        localStorage.setItem('autosave_' + MON_ID_DEVOIR + '_' + k, this.value);
                    });
                });
                // Matrice Risque Interactive √âl√®ve
                const riskCells = document.querySelectorAll('.risk-cell');
                if(riskCells.length > 0) {
                     riskCells.forEach(cell => {
                        cell.addEventListener('click', function() {
                             // Trouver le groupe de cellules parent (la table)
                             const table = this.closest('table');
                             table.querySelectorAll('.risk-cell').forEach(c => { c.classList.remove('selected'); c.style.outline = 'none'; });
                             this.classList.add('selected');
                             this.style.outline = '3px solid #3498db';
                             const hiddenInput = this.closest('.risk-matrix-wrap').querySelector('.risk-cell-value');
                             if(hiddenInput) hiddenInput.value = this.getAttribute('data-pos');
                        });
                    });
                }
                
                if(typeof window.demanderCode === 'function') {
                    const user = await window.demanderCode("TITRE DU DEVOIR");
                    if(user && user.code) {
                        const codeField = document.getElementById('code-eleve');
                        if(codeField) codeField.value = user.code;
                        const cField = document.getElementById('classe-eleve');
                        if(cField) cField.value = user.classe;
                        sessionStorage.setItem('userClasse', user.classe);
                    }
                } else { alert("‚ö†Ô∏è Annuaire non charg√©."); }
            });
            window.tenterEnvoi = function() {
                const rep = document.querySelectorAll('.reponse-eleve');
                let vides = 0;
                rep.forEach(r => { if(!r.value.trim()) vides++; });
                let msg = "‚ö†Ô∏è Vous allez envoyer votre copie d√©finitive.\n\n";
                if(vides > 0) msg += "Il reste " + vides + " questions vides.\n";
                msg += "Confirmer ?";
                if(confirm(msg)) { if(window.envoyerCopie) window.envoyerCopie(); else alert("Erreur d'envoi."); }
            };
        </script></body></html>