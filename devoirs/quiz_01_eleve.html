<script type="module">
    const statusEl = document.getElementById("envoi-status");
    const segRaw = location.pathname.split("/").filter(Boolean)[0] || "";
    const seg = segRaw.includes(".") ? "" : segRaw;
    const prefixes = [];
    if (seg) prefixes.push("/" + seg);
    prefixes.push("/PSE");
    prefixes.push("");
    const uniquePrefixes = [...new Set(prefixes)];

    // Fonction corrigée (sans l'erreur de syntaxe const)
    function buildUrl(prefix, relPath) {
        const p = prefix || "";
        const base = p ? p.replace(/\/+$/, "") : "";
        const rel = String(relPath || "").replace(/^\/+/, "");
        return (base ? base + "/" : "/") + rel;
    }

    async function importWithPrefixes(fileRelativePath, optionalRelativePaths = []) {
        let lastError = null;
        const attempts = [];

        uniquePrefixes.forEach(prefix => attempts.push(buildUrl(prefix, fileRelativePath)));
        optionalRelativePaths.forEach(opt => {
            uniquePrefixes.forEach(prefix => attempts.push(buildUrl(prefix, opt)));
        });

        const uniqueAttempts = [...new Set(attempts)];

        for (const url of uniqueAttempts) {
            try {
                console.warn("Tentative import:", url);
                await import(url);
                return url;
            } catch (e) {
                lastError = e;
                console.warn("Import échoué:", url, e);
            }
        }

        throw lastError || new Error("Impossible de charger le module: " + fileRelativePath);
    }

    try {
        statusEl.textContent = "Chargement des modules...";

        // --- CORRECTION DES LIENS ICI (On utilise mapse.fr directement) ---
        const annuaireUrl = "https://mapse.fr/annuaire.js";
        const runnerUrl = "https://mapse.fr/assets/pse-runner.js";

        await import(annuaireUrl);
        await import(runnerUrl);

        console.log("Modules chargés:", { annuaireUrl, runnerUrl, seg, prefixes: uniquePrefixes });
        statusEl.textContent = "Système prêt.";
    } catch(e) {
        console.error("Erreur modules:", e);
        statusEl.textContent = "Erreur de chargement des modules (vérifiez votre connexion).";
        statusEl.style.color = "red";
    }
</script>
</body>
</html>
