<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>√âvaluation PSE ‚Äì Module C11</title>
  <style>
    :root { --bg: #f4f4f4; --card: #ffffff; --text: #111827; --band: #0f172a; --bandText: #ffffff; --focus: #2563eb; }
    body { font-family: Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .container { max-width: 980px; margin: 0 auto; background: var(--card); padding: 25px; border-radius: 14px; display: none; } /* Cach√© par d√©faut */
    
    /* Overlay de verrouillage */
    #lock-screen { position: fixed; inset: 0; background: var(--band); display: flex; align-items: center; justify-content: center; z-index: 1000; color: white; flex-direction: column; }
    .lock-box { background: white; color: black; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    
    .phase { border: 1px solid #e5e7eb; border-radius: 14px; margin-bottom: 20px; overflow: hidden; background: #fff; }
    .phase-title { background: var(--band); color: white; padding: 12px; font-weight: bold; }
    .phase-content { padding: 15px; }
    .reponse-eleve { width: 100%; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px; resize: none; min-height: 60px; margin-top: 10px; }
    .doc { background: #f9fafb; border-left: 5px solid var(--band); padding: 15px; margin: 15px 0; }
    .submit-btn { background: #10b981; color: white; padding: 18px; border: none; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1.2em; }
    #statusMsg { color: #ef4444; font-weight: bold; text-align: center; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 10px; }
  </style>
</head>
<body data-id-exercice="devoir_c11_analyse_situation_travail_v1">

<div id="lock-screen">
  <div class="lock-box">
    <h2>Acc√®s au Devoir</h2>
    <p>Veuillez saisir votre code √©l√®ve pour commencer :</p>
    <input type="text" id="entry-code" placeholder="Ex: KA47" style="padding:12px; font-size:1.2em; width:150px; text-transform:uppercase; text-align:center; border:2px solid #2563eb; border-radius:8px;">
    <p id="lock-error" style="color:red; font-size:0.9em; margin-top:10px;"></p>
  </div>
</div>

<div class="container" id="main-content">
    <header style="background: var(--band); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
      <h1 id="titre-devoir">√âvaluation PSE ‚Äì Module C11</h1>
      <p>√âl√®ve : <span id="nom-eleve-display" style="font-weight:bold; color:#10b981;"></span></p>
    </header>

    <section class="phase">
      <div class="phase-title">Phase 1 ‚Äì Situation-probl√®me</div>
      <div class="phase-content">
        <div class="doc">
          <strong>Situation :</strong> Maya, 19 ans, travaille en restauration collective... (Texte int√©gral identique √† votre fichier)
        </div>
        <p>1) Formuler la probl√©matique ? <textarea class="reponse-eleve" data-qid="q_1_problematique"></textarea></p>
      </div>
    </section>

    <section class="phase">
      <div class="phase-title">Phase 2 ‚Äì ITAMaMi</div>
      <div class="phase-content">
        <table>
          <tr><td>I - Individu</td><td><textarea class="reponse-eleve" data-qid="q_2_itamami_individu"></textarea></td></tr>
          <tr><td>T - T√¢che</td><td><textarea class="reponse-eleve" data-qid="q_2_itamami_tache"></textarea></td></tr>
          <tr><td>A - Activit√©</td><td><textarea class="reponse-eleve" data-qid="q_2_itamami_activite"></textarea></td></tr>
          <tr><td>Ma - Mat√©riel</td><td><textarea class="reponse-eleve" data-qid="q_2_itamami_materiel"></textarea></td></tr>
          <tr><td>Mi - Milieu</td><td><textarea class="reponse-eleve" data-qid="q_2_itamami_milieu"></textarea></td></tr>
        </table>
        <p>3) Classer T√¢che/Activit√©... <textarea class="reponse-eleve" data-qid="q_3_classement"></textarea></p>
      </div>
    </section>

    <div id="statusMsg"></div>
    <button class="submit-btn" onclick="tenterEnvoi()">üöÄ ENVOYER MA COPIE</button>
</div>

<script src="https://preventionsanteenvironnement.github.io/PSE/annuaire.js"></script>
<script src="https://preventionsanteenvironnement.github.io/PSE/assets/pse-runner.js"></script>

<script>
const DEVOIR_ID = "devoir_c11_analyse_situation_travail_v1";
let pasteStats = { total: 0, external: 0, document: 0 };

// 1. GESTION DU CODE D'ACC√àS (VERROU)
document.getElementById('entry-code').addEventListener('input', function(e) {
    const code = e.target.value.toUpperCase();
    if (window.ANNUAIRE && window.ANNUAIRE[code]) {
        window.eleveData = { code: code, ...window.ANNUAIRE[code] };
        document.getElementById('nom-eleve-display').textContent = window.eleveData.nom + " (" + window.eleveData.classe + ")";
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        initSmartPaste(); // Active la surveillance apr√®s d√©verrouillage
    } else if (code.length >= 4) {
        document.getElementById('lock-error').textContent = "Code inconnu dans l'annuaire.";
    }
});

// 2. SURVEILLANCE COPIER-COLLER (AVERTISSEMENT)
function initSmartPaste() {
    const docTexts = Array.from(document.querySelectorAll('.doc, p, h1, h2, strong')).map(el => el.innerText.trim());

    document.querySelectorAll('.reponse-eleve').forEach(area => {
        area.addEventListener('paste', (e) => {
            const pastedText = e.clipboardData.getData('text').trim();
            pasteStats.total++;

            const isInternal = docTexts.some(t => t.includes(pastedText));
            if (!isInternal) {
                pasteStats.external++;
                // AVERTISSEMENT √âL√àVE
                alert("‚ö†Ô∏è ATTENTION : Le copier-coller provenant d'une source externe est interdit. Cette action a √©t√© signal√©e √† votre professeur.");
            } else {
                pasteStats.document++;
            }
        });
    });
}

// 3. ENVOI FIREBASE
async function tenterEnvoi() {
    const responses = {};
    document.querySelectorAll('.reponse-eleve').forEach(el => {
        responses[el.getAttribute('data-qid')] = el.value;
    });

    if (confirm("Voulez-vous envoyer votre travail termin√© ?")) {
        if (window.envoyerCopie) {
            // Envoi des r√©ponses + stats de triche
            window.envoyerCopie(window.eleveData.code, pasteStats, window.eleveData);
        } else {
            alert("Erreur : Le syst√®me de transmission (Runner) est absent.");
        }
    }
}
</script>
</body>
</html>
