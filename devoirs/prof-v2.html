<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSE ‚Äî Zone Prof (V4)</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#4b5563;--border:#e5e7eb;--accent:#2563eb;--shadow:0 10px 30px rgba(0,0,0,.08);--radius:18px;--focus:0 0 0 3px rgba(37,99,235,.25)}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 70px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:20px}
    h1{margin:0 0 6px;font-size:1.25rem}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border)}
    input, select{padding:8px 12px;border:1px solid var(--border);border-radius:10px;font-size:0.95rem}
    input:focus, select:focus{outline:none;box-shadow:var(--focus);border-color:var(--accent)}

    button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer;transition:all .2s}
    button:hover{background:#f9fafb;border-color:#d1d5db}

    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button.primary:hover{background:#1d4ed8}

    button.success{background:#10b981;border-color:#10b981;color:#fff}
    button.success:hover{background:#059669}

    button.danger{background:#fff;border-color:#fee2e2;color:#dc2626}
    button.danger:hover{background:#fee2e2;border-color:#dc2626}

    .table-responsive{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:0.9rem}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:800;background:#f9fafb;white-space:nowrap}
    tr:hover td{background:#f9fafb}

    .tag{display:inline-block;padding:2px 8px;border-radius:99px;font-size:0.8em;font-weight:700;background:#e5e7eb;color:#374151}
    .tag.cls{background:#dbeafe;color:#1e40af}
    .score-bad{color:#dc2626;font-weight:800}
    .score-good{color:#16a34a;font-weight:800}

    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:999}
    .modal-overlay.open{display:flex}
    .modal{background:#fff;width:90%;max-width:800px;max-height:90vh;border-radius:14px;display:flex;flex-direction:column;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)}
    .modal-head{padding:14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:800}
    .modal-body{padding:0;overflow:auto;flex:1;background:#f8fafc}
    .modal-body pre{margin:0;padding:14px;font-family:monospace;font-size:0.85rem;white-space:pre-wrap}
    .close-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;padding:0 8px;color:var(--muted)}

    .status{font-weight:700;color:var(--muted);font-size:0.9rem}
    .status.err{color:#dc2626}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card" id="loginCard">
      <h1>üîê Acc√®s Prof V4</h1>
      <div class="toolbar" style="border:none;margin:0;padding:0">
        <input id="profCode" type="password" placeholder="Mot de passe..." autocomplete="current-password" />
        <button class="primary" id="unlockBtn">D√©verrouiller</button>
        <span class="status" id="loginStatus"></span>
      </div>
    </div>

    <div class="card" id="dashCard" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h1>üìö Devoirs Rendus</h1>
        <div>
          <button class="success" id="csvBtn" title="Ouvrir dans Excel">üìÑ Export CSV</button>
          <button id="refreshBtn">‚Üª Actualiser</button>
        </div>
      </div>

      <div class="toolbar">
        <select id="filterDevoir" style="max-width:200px">
          <option value="">Tous les devoirs</option>
        </select>
        <input type="text" id="filterClasse" placeholder="Classe (ex: 2CAP)" size="12">
        <input type="text" id="filterEleve" placeholder="üîç Recherche √©l√®ve..." size="18">
        <span class="status" id="countStatus" style="margin-left:auto;font-size:0.85em">0 rendus</span>
      </div>

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Nom Pr√©nom</th>
              <th>Classe</th>
              <th>Devoir</th>
              <th>Score</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="jsonModal">
    <div class="modal">
      <div class="modal-head">
        <span id="modalTitle">D√©tail copie</span>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <pre id="jsonContent"></pre>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>window.PSE_CODE_REQUIRED = false;</script>
  <script src="./annuaire.js"></script>

  <script>
    const PROF_PASSWORD = "BrahmsPSE";

    // Page de correction (grille)
    const CORRIGER_URL = "./grille-correction.html";
    const CORRIGER_COLLECTION = "devoirs_rendus";

    const $ = (s)=>document.querySelector(s);
    let ALL_DATA = [];

    $("#unlockBtn").addEventListener("click", () => {
      if($("#profCode").value.trim() === PROF_PASSWORD){
        $("#loginCard").hidden = true;
        $("#dashCard").hidden = false;
        loadData();
      } else {
        $("#loginStatus").textContent = "Mot de passe incorrect.";
        $("#loginStatus").className = "status err";
      }
    });
    $("#profCode").addEventListener("keydown", (e) => { if(e.key==="Enter") $("#unlockBtn").click(); });
    $("#refreshBtn").addEventListener("click", loadData);

    $("#csvBtn").addEventListener("click", () => {
      if(!ALL_DATA.length) return alert("Aucune donn√©e √† exporter.");

      let csv = "Date;Nom;Prenom;Classe;Devoir;Score;Max\n";
      ALL_DATA.forEach(r => {
        const dt = r.createdAtISO ? new Date(r.createdAtISO).toLocaleDateString("fr-FR") : "?";
        const nom = (r.eleve?.nom || r.nom || "").toUpperCase();
        const prenom = (r.eleve?.prenom || r.prenom || "");
        const classe = (r.eleve?.classe || r.classe || "").toUpperCase();
        const devoir = r.devoirId || r.module || "?";
        const sc = r.resultat_auto?.score ?? r.meta?.score ?? r.score ?? "";
        const max = r.resultat_auto?.maxScore ?? r.meta?.maxScore ?? r.maxScore ?? "";
        csv += `${dt};${nom};${prenom};${classe};${devoir};${sc};${max}\n`;
      });

      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "resultats_pse_" + new Date().toISOString().slice(0,10) + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    async function loadData(){
      const status = $("#countStatus");
      status.textContent = "Chargement...";
      try {
        if(!window.db) throw new Error("Erreur DB");
        const snap = await window.db.collection("devoirs_rendus").orderBy("createdAtISO", "desc").limit(100).get();
        ALL_DATA = [];
        snap.forEach(doc => ALL_DATA.push({ id: doc.id, ...doc.data() }));
        updateFiltersOptions();
        renderTable();
      } catch(e) {
        console.error(e);
        status.textContent = "Erreur : " + e.message;
        status.className = "status err";
      }
    }

    function updateFiltersOptions(){
      const devoirs = [...new Set(ALL_DATA.map(d => d.devoirId || d.module || "Inconnu"))].sort();
      const sel = $("#filterDevoir");
      const current = sel.value;
      sel.innerHTML = '<option value="">Tous les devoirs</option>';
      devoirs.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        sel.appendChild(opt);
      });
      sel.value = current;
    }

    function renderTable(){
      const fDevoir = $("#filterDevoir").value.toLowerCase();
      const fClasse = $("#filterClasse").value.trim().toLowerCase();
      const fEleve = $("#filterEleve").value.trim().toLowerCase();

      const filtered = ALL_DATA.filter(r => {
        const devId = (r.devoirId || r.module || "").toLowerCase();
        const cls = (r.eleve?.classe || r.classe || "").toLowerCase();
        const nomComplet = ((r.eleve?.nom||"") + " " + (r.eleve?.prenom||"")).toLowerCase();

        if(fDevoir && !devId.includes(fDevoir)) return false;
        if(fClasse && !cls.includes(fClasse)) return false;
        if(fEleve && !nomComplet.includes(fEleve)) return false;
        return true;
      });

      $("#countStatus").textContent = `${filtered.length} rendu(s)`;

      const tbody = $("#tbody");
      tbody.innerHTML = "";

      filtered.forEach(r => {
        const nom = (r.eleve?.nom || r.nom || "").toUpperCase();
        const prenom = (r.eleve?.prenom || r.prenom || "");
        const classe = (r.eleve?.classe || r.classe || "").toUpperCase();
        const devoir = r.devoirId || r.module || "?";

        const sc = r.resultat_auto?.score ?? r.meta?.score ?? r.score;
        const max = r.resultat_auto?.maxScore ?? r.meta?.maxScore ?? r.maxScore;
        let scoreDisp = "";
        let scoreClass = "";

        if(sc !== undefined && sc !== ""){
          scoreDisp = max ? `${sc}/${max}` : sc;
          if(max && Number(sc) < 10) scoreClass = "score-bad";
          else if(max && Number(sc) >= 14) scoreClass = "score-good";
        }

        const date = r.createdAtISO ? new Date(r.createdAtISO).toLocaleString("fr-FR") : "?";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="font-size:0.85em;color:#666">${date}</td>
          <td style="font-weight:600">${prenom} ${nom}</td>
          <td><span class="tag cls">${classe}</span></td>
          <td>${devoir}</td>
          <td class="${scoreClass}">${scoreDisp}</td>
          <td>
            <button class="success" onclick='corriger("${r.id}")' title="Corriger">‚úçÔ∏è</button>
            <button onclick='viewJson("${r.id}")' title="Voir JSON">üëÅÔ∏è</button>
            <button class="danger" onclick='deleteItem("${r.id}", "${nom}")' title="Supprimer">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    $("#filterDevoir").addEventListener("change", renderTable);
    $("#filterClasse").addEventListener("input", renderTable);
    $("#filterEleve").addEventListener("input", renderTable);

    window.viewJson = (id) => {
      const item = ALL_DATA.find(i => i.id === id);
      if(!item) return;
      $("#modalTitle").textContent = `D√©tail copie ‚Äî ${(item.eleve?.nom || item.nom || "")} ${(item.eleve?.prenom || item.prenom || "")}`;
      $("#jsonContent").textContent = JSON.stringify(item, null, 2);
      $("#jsonModal").classList.add("open");
    };

    // ‚úÖ OUVRIR LA GRILLE DE CORRECTION EN PASSANT docId (et quelques infos utiles)
    window.corriger = (id) => {
      const item = ALL_DATA.find(i => i.id === id);
      if(!item) return;

      // Cache local (optionnel, pratique si tu veux pr√©-remplir sans re-fetch)
      try {
        sessionStorage.setItem("PSE_CORRIGE_DOCID", id);
        sessionStorage.setItem("PSE_CORRIGE_DATA_" + id, JSON.stringify(item));
      } catch(e) {}

      const params = new URLSearchParams({
        docId: id,
        collection: CORRIGER_COLLECTION,
        devoirId: item.devoirId || "",
        classe: item.eleve?.classe || item.classe || "",
        nom: item.eleve?.nom || item.nom || "",
        prenom: item.eleve?.prenom || item.prenom || ""
      });

      window.open(CORRIGER_URL + "?" + params.toString(), "_blank", "noopener");
    };

    window.deleteItem = async (id, nomEleve) => {
      if(!confirm(`‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nTu vas supprimer d√©finitivement la copie de ${nomEleve}.\n\nEs-tu s√ªr de vouloir faire √ßa ?`)) return;

      try {
        await window.db.collection("devoirs_rendus").doc(id).delete();
        ALL_DATA = ALL_DATA.filter(item => item.id !== id);
        updateFiltersOptions();
        renderTable();
        alert("Copie supprim√©e.");
      } catch(e) {
        alert("Erreur lors de la suppression : " + e.message);
      }
    };

    window.closeModal = () => $("#jsonModal").classList.remove("open");
    $("#jsonModal").addEventListener("click", (e) => { if(e.target === $("#jsonModal")) closeModal(); });
  </script>
</body>
</html>
