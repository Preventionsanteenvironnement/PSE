<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©t√©o & D√©fis de Classe</title>
    <style>
        :root { --primary: #4299e1; --success: #48bb78; --danger: #f56565; --bg: #f7fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #2d3748; margin: 0; padding: 20px; display: flex; flex-direction: column; min-height: 95vh; }
        
        /* --- DESIGN √âL√àVE --- */
        #student-view { max-width: 500px; margin: 0 auto; width: 100%; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .grid-emojis { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .btn-emoji { background: #edf2f7; border: 2px solid transparent; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
        .btn-emoji span { display: block; font-size: 2.5rem; margin-bottom: 5px; }
        .btn-emoji.selected { background: #ebf8ff; border-color: var(--primary); transform: scale(1.05); }

        .list-defis { display: flex; flex-direction: column; gap: 10px; }
        .btn-defi { background: #edf2f7; border: 2px solid transparent; padding: 15px; border-radius: 10px; cursor: pointer; text-align: left; display: flex; align-items: center; }
        .btn-defi.selected { background: #f0fff4; border-color: var(--success); }
        .defi-icon { font-size: 1.5rem; margin-right: 15px; }

        #btn-send { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* --- DESIGN PROF (Tableau) --- */
        #teacher-view { display: none; height: 90vh; flex-direction: column; } /* Cach√© au d√©but */
        
        /* Sonom√®tre */
        .sono-header { background: white; padding: 15px 30px; border-radius: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .meter-track { flex-grow: 1; height: 30px; background: #e2e8f0; border-radius: 15px; margin: 0 30px; overflow: hidden; }
        .meter-fill { height: 100%; width: 0%; background: var(--success); transition: width 0.1s linear; }
        .db-display { font-size: 2rem; font-weight: bold; min-width: 120px; text-align: right; }
        
        .alert-mode { background: #fff5f5; border: 2px solid var(--danger); }
        .alert-text { color: var(--danger); animation: pulse 1s infinite; }

        /* Nuage M√©t√©o */
        .cloud-container { flex-grow: 1; position: relative; background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .center-trend { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; opacity: 0.5; filter: grayscale(0%); transition: 0.5s; }
        .floating-bubble { position: absolute; text-align: center; opacity: 0; animation: floatUp 8s ease-out forwards; }
        .bubble-emoji { font-size: 3rem; }
        .bubble-text { background: rgba(255,255,255,0.9); padding: 2px 8px; border-radius: 8px; font-size: 0.9rem; color: #555; }
        @keyframes floatUp { 0% { transform: translateY(100px) scale(0); opacity: 0; } 10% { opacity: 1; transform: translateY(0) scale(1); } 90% { opacity: 1; } 100% { transform: translateY(-300px); opacity: 0; } }

        /* --- LOGIN & MODALS --- */
        .footer-link { margin-top: auto; text-align: center; font-size: 0.8rem; color: #cbd5e0; cursor: pointer; padding: 20px; }
        #login-modal, #bilan-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; width: 90%; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; margin-bottom: 10px; text-align: center; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="student-view">
        <h2 style="color:#4a5568;">Ma M√©t√©o & Mon D√©fi</h2>
        
        <div class="card">
            <h3>1. Mon humeur</h3>
            <div class="grid-emojis">
                <div class="btn-emoji" onclick="selectMood(this, 'Joie', 'ü§©')"><span>ü§©</span>Joie</div>
                <div class="btn-emoji" onclick="selectMood(this, 'Calme', 'üòé')"><span>üòé</span>Calme</div>
                <div class="btn-emoji" onclick="selectMood(this, 'Col√®re', 'üò°')"><span>üò°</span>Col√®re</div>
                <div class="btn-emoji" onclick="selectMood(this, 'Fatigue', 'üò¥')"><span>üò¥</span>Fatigue</div>
            </div>
        </div>

        <div class="card">
            <h3>2. Mon d√©fi</h3>
            <div class="list-defis">
                <div class="btn-defi" onclick="selectDefi(this, 'Je l√®ve la main pour demander de l\'aide')"><span class="defi-icon">‚úã</span>Je l√®ve la main pour demander de l'aide</div>
                <div class="btn-defi" onclick="selectDefi(this, 'Je me mets au travail sans attendre')"><span class="defi-icon">üöÄ</span>Je me mets au travail sans attendre</div>
                <div class="btn-defi" onclick="selectDefi(this, 'J\'√©coute la consigne jusqu\'au bout')"><span class="defi-icon">üëÇ</span>J'√©coute la consigne jusqu'au bout</div>
                <div class="btn-defi" onclick="selectDefi(this, 'Je reste concentr√©(e) sur mon exercice')"><span class="defi-icon">üéØ</span>Je reste concentr√©(e) sur mon exercice</div>
                <div class="btn-defi" onclick="selectDefi(this, 'Je corrige mon attitude d√®s la 1√®re remarque')"><span class="defi-icon">‚ö°</span>Je corrige mon attitude (1√®re remarque)</div>
                <div class="btn-defi" onclick="selectDefi(this, 'Je reste zen et positif(ve)')"><span class="defi-icon">üßò</span>Je reste zen et positif(ve)</div>
            </div>
        </div>

        <button id="btn-send" onclick="envoyerVote()">Valider</button>
        <div id="success-msg" class="hidden" style="margin-top:20px;">
            <div style="font-size:3rem;">‚úÖ</div>
            <h3>C'est not√© ! Regarde le tableau.</h3>
        </div>

        <div class="footer-link" onclick="showLogin()">Acc√®s Prof</div>
    </div>

    <div id="teacher-view">
        <div class="sono-header" id="sono-box">
            <div>üîä Volume</div>
            <div class="meter-track"><div class="meter-fill" id="meter-bar"></div></div>
            <div class="db-display" id="db-val">-- dB</div>
        </div>

        <div class="cloud-container" id="cloud-zone">
            <div class="center-trend" id="trend-display">
                <div style="font-size:5rem;" id="trend-emoji">‚òÅÔ∏è</div>
                <div style="font-size:1.5rem;" id="trend-text">En attente...</div>
            </div>
        </div>

        <div style="text-align:center; padding:20px;">
            <button onclick="showBilan()" style="background:#2d3748; color:white; padding:10px 30px; border-radius:30px; border:none; cursor:pointer; font-size:1.2rem;">üèÅ Bilan du Cours</button>
        </div>
    </div>

    <div id="login-modal">
        <div class="modal-box">
            <h3>Espace Professeur</h3>
            <input type="password" id="pass-input" placeholder="Mot de passe (1234)">
            <br>
            <button onclick="checkPass()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Entrer</button>
            <button onclick="closeLogin()" style="background:transparent; color:#888; border:none; margin-left:10px; cursor:pointer;">Annuler</button>
        </div>
    </div>

    <div id="bilan-modal">
        <div class="modal-box">
            <h2>Bilan de la s√©ance</h2>
            <div style="margin:20px 0; padding:20px; background:#f7fafc; border-radius:10px;">
                <p>Pic sonore maximum :</p>
                <div style="font-size:3rem; font-weight:bold;" id="bilan-db">0 dB</div>
                <p id="bilan-msg" style="font-weight:bold;"></p>
            </div>
            <button onclick="resetData()" style="background:#e53e3e; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">üóëÔ∏è Effacer & Recommencer</button>
            <button onclick="document.getElementById('bilan-modal').style.display='none'" style="margin-left:10px; padding:10px 20px; border:none; background:#eee; border-radius:5px; cursor:pointer;">Fermer</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TA CL√â CORRIG√âE
        const firebaseConfig = {
            apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
            authDomain: "devoirs-pse.firebaseapp.com",
            projectId: "devoirs-pse",
            storageBucket: "devoirs-pse.firebasestorage.app",
            messagingSenderId: "614730413904",
            appId: "1:614730413904:web:a5dd478af5de30f6bede55",
            measurementId: "G-7R9N0JL6GG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colName = "meteo_final"; // Nouvelle collection propre

        // --- VARIABLES GLOBALES ---
        let userMood = null, userEmoji = null, userDefi = null;
        let maxSessionDb = 0;
        let isMonitoring = false;

        // --- PARTIE √âL√àVE ---
        window.selectMood = (el, m, e) => {
            document.querySelectorAll('.btn-emoji').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            userMood = m; userEmoji = e;
        };

        window.selectDefi = (el, d) => {
            document.querySelectorAll('.btn-defi').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            userDefi = d;
        };

        window.envoyerVote = async () => {
            if(!userMood || !userDefi) return alert("Choisis une humeur ET un d√©fi !");
            document.getElementById('btn-send').innerText = "Envoi...";
            try {
                await addDoc(collection(db, colName), {
                    mood: userMood, emoji: userEmoji, defi: userDefi, timestamp: Date.now()
                });
                document.getElementById('btn-send').classList.add('hidden');
                document.getElementById('success-msg').classList.remove('hidden');
                document.querySelector('.card').style.display = 'none'; // Cache les choix pour nettoyer
            } catch(e) { alert("Erreur: " + e.message); }
        };

        // --- GESTION ACC√àS PROF ---
        window.showLogin = () => document.getElementById('login-modal').style.display = 'flex';
        window.closeLogin = () => document.getElementById('login-modal').style.display = 'none';
        
        window.checkPass = () => {
            const p = document.getElementById('pass-input').value;
            if(p === "1234") { // MOT DE PASSE SIMPLE
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('student-view').style.display = 'none';
                document.getElementById('teacher-view').style.display = 'flex';
                startProfFeatures();
            } else { alert("Mot de passe incorrect"); }
        };

        // --- FONCTIONS PROF ---
        function startProfFeatures() {
            startSonometer();
            
            // √âcoute Firebase en temps r√©el
            onSnapshot(collection(db, colName), (snap) => {
                const counts = {};
                snap.docChanges().forEach(change => {
                    if(change.type === "added") {
                        const d = change.doc.data();
                        spawnBubble(d.emoji, d.mood);
                    }
                });

                snap.forEach(doc => {
                    const m = doc.data().mood;
                    counts[m] = (counts[m] || 0) + 1;
                });

                let max=0, dom="En attente...", domEmo="‚òÅÔ∏è";
                const map = {'Joie':'ü§©', 'Calme':'üòé', 'Col√®re':'üò°', 'Fatigue':'üò¥'};
                for(const [m, c] of Object.entries(counts)) {
                    if(c > max) { max = c; dom = m; domEmo = map[m]; }
                }
                if(max > 0) {
                    document.getElementById('trend-text').innerText = dom;
                    document.getElementById('trend-emoji').innerText = domEmo;
                }
            });
        }

        function spawnBubble(emoji, text) {
            const z = document.getElementById('cloud-zone');
            const b = document.createElement('div');
            b.className = 'floating-bubble';
            b.style.left = (Math.random() * 80 + 10) + "%";
            b.style.bottom = "-50px";
            b.innerHTML = `<div class="bubble-emoji">${emoji}</div><div class="bubble-text">${text}</div>`;
            z.appendChild(b);
            setTimeout(() => b.remove(), 8000);
        }

        async function startSonometer() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const ctx = new AudioContext();
                const analyser = ctx.createAnalyser();
                const src = ctx.createMediaStreamSource(stream);
                const script = ctx.createScriptProcessor(2048, 1, 1);
                src.connect(analyser); analyser.connect(script); script.connect(ctx.destination);
                isMonitoring = true;

                script.onaudioprocess = () => {
                    if(!isMonitoring) return;
                    const arr = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(arr);
                    let sum = 0; for(let i=0; i<arr.length; i++) sum+=arr[i];
                    let db = Math.round((sum/arr.length/130)*100);
                    if(db<10) db=10;

                    const bar = document.getElementById('meter-bar');
                    const val = document.getElementById('db-val');
                    const box = document.getElementById('sono-box');

                    bar.style.width = db + "%";
                    if(db > maxSessionDb) maxSessionDb = db;

                    if(db > 80) {
                        val.innerText = db + " dB !";
                        box.classList.add('alert-mode');
                        val.classList.add('alert-text');
                    } else {
                        val.innerText = db + " dB";
                        box.classList.remove('alert-mode');
                        val.classList.remove('alert-text');
                    }
                };
            } catch(e) { console.error("Micro err:", e); }
        }

        // --- BILAN ---
        window.showBilan = () => {
            isMonitoring = false;
            document.getElementById('bilan-modal').style.display = 'flex';
            document.getElementById('bilan-db').innerText = maxSessionDb + " dB";
            const msg = document.getElementById('bilan-msg');
            if(maxSessionDb > 85) { msg.innerText = "‚ö†Ô∏è Trop bruyant !"; msg.style.color="#f56565"; }
            else { msg.innerText = "‚úÖ Bravo, calme."; msg.style.color="#48bb78"; }
        };

        window.resetData = async () => {
            if(confirm("Tout effacer ?")) {
                const snap = await getDocs(collection(db, colName));
                snap.forEach(d => deleteDoc(d.ref));
                location.reload();
            }
        };

    </script>
</body>
</html>
