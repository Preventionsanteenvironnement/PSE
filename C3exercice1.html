<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSE Bac Pro — Maîtriser la compétence C3</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f1730;
      --card2:#111a33;
      --line:rgba(255,255,255,.10);
      --txt:#eef2ff;
      --muted:#b9c5ff;
      --ok:#2bd4a6;
      --bad:#ff5a7a;
      --warn:#ffcf5a;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(92,124,255,.22), transparent 60%),
        radial-gradient(900px 600px at 82% 28%, rgba(43,212,166,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 95%, rgba(255,90,122,.14), transparent 55%),
        var(--bg);
      line-height:1.45;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .top{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ .top{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:16px;
      box-shadow:var(--shadow);
    }
    h1{margin:0 0 8px 0;font-size:22px}
    h2{margin:0 0 10px 0;font-size:18px}
    h3{margin:14px 0 8px 0;font-size:15px;color:var(--muted)}
    p{margin:8px 0;color:var(--muted)}
    .pillRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:8px 10px;border-radius:999px;
      font-size:13px;color:var(--muted);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      padding:2px 6px;border-radius:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .scoreBox{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .scoreBig{font-size:18px;font-weight:800}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;border:1px solid var(--line);min-width:180px}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg, rgba(43,212,166,.95), rgba(92,124,255,.95))}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      font-weight:750;
      transition: transform .08s ease, background .2s ease;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button:active{transform: translateY(1px)}
    .primary{background: rgba(43,212,166,.16);border-color: rgba(43,212,166,.35)}
    .danger{background: rgba(255,90,122,.14);border-color: rgba(255,90,122,.32)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    .stepRow{display:flex;gap:8px;flex-wrap:wrap}
    .step{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      padding:10px 12px;border-radius:14px;
      display:flex;gap:10px;align-items:flex-start;
      flex:1;
      min-width:210px;
    }
    .step strong{color:var(--txt)}
    .step span{color:var(--muted);font-size:13px}

    .q{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    .qHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:4px 8px;border-radius:999px
    }
    select, input[type="text"], textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .choices{display:grid;gap:8px;margin-top:8px}
    .choice{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px;border-radius:14px;
      cursor:pointer;
    }
    .choice input{margin-top:2px}
    .feedback{
      margin-top:10px;
      padding:10px 12px;border-radius:14px;
      border:1px dashed var(--line);
      color:var(--muted);
      display:none;
    }
    .feedback.ok{display:block;border-color:rgba(43,212,166,.45);color:rgba(214,255,244,.95);background: rgba(43,212,166,.10)}
    .feedback.bad{display:block;border-color:rgba(255,90,122,.50);color:rgba(255,220,228,.95);background: rgba(255,90,122,.10)}
    .feedback.warn{display:block;border-color:rgba(255,207,90,.55);color:rgba(255,243,210,.95);background: rgba(255,207,90,.10)}

    .drags{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.drags{grid-template-columns:1fr}}
    .bank,.zone{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.14);
      min-height:120px;
    }
    .token{
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      margin:6px 6px 0 0;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      cursor:grab;
      font-size:13px;
    }
    .token:active{cursor:grabbing}
    .bank h4,.zone h4{margin:0 0 8px 0;font-size:13px;color:var(--muted);font-weight:800}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.twoCols{grid-template-columns:1fr}}
    .rubric{display:grid;gap:8px;margin-top:10px}
    .rubric label{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px;border-radius:14px;
      cursor:pointer;color:var(--muted)
    }
    .rubric input{margin-top:2px}
    .mini{font-size:12px;color:var(--muted);margin-top:10px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    .linkish{color:rgba(180,200,255,.95);font-weight:800}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid var(--line);
      padding:10px 12px;border-radius:14px;
      color:var(--txt);
      display:none;
      box-shadow: var(--shadow);
      max-width: calc(100% - 28px);
    }

    @media print{
      body{background:white;color:black}
      .wrap{padding:0}
      .btnRow, .toast{display:none !important}
      .card{box-shadow:none;border:1px solid #ccc;background:white}
      .q{background:white}
      select,input,textarea{border:1px solid #999;background:white;color:black}
      .token{border:1px solid #999;background:white;color:black}
      .pill,.tag,.kbd{border:1px solid #999;background:white;color:black}
      .feedback{display:block !important;border:1px solid #999 !important;background:white !important;color:black !important}
    }
  
.token.selected{outline:2px solid var(--accent, #7ee7d7); box-shadow:0 0 0 4px rgba(126,231,215,.15);}
.dndInfo{margin-top:10px; font-size:0.92rem; opacity:.85; line-height:1.25;}
</style>
</head>
<body>
  <div class="wrap">

    <section class="top">
      <div class="card">
        <h1>Maîtriser la compétence C3 en PSE</h1>

        <p>Définition à retenir</p>

        <div class="pillRow">
          <div class="pill"><span class="kbd">C3</span> Expliquer un phénomène physiologique, un enjeu environnemental, une disposition réglementaire</div>
          <div class="pill">Lien avec la prévention seulement si la consigne le demande</div>
        </div>

        <div class="sep"></div>

        <h2>Méthode C3</h2>

        <div class="stepRow">
          <div class="step"><strong>Cause</strong><span>De quoi on parle, quel facteur agit</span></div>
          <div class="step"><strong>Mécanisme</strong><span>Comment ça fonctionne, ce qui se passe</span></div>
          <div class="step"><strong>Conséquence</strong><span>Effet sur santé, travail, environnement</span></div>
          <div class="step"><strong>Prévention</strong><span>Seulement si demandé</span></div>
          <div class="step"><strong>Justification</strong><span>En quoi la prévention réduit le risque</span></div>
        </div>

        <div class="mini">
          Repère bac pro : si la consigne commence par expliquer comment, expliquer en quoi, expliquer le lien, expliquer l’intérêt, expliquer le rôle, on est souvent en C3
        </div>
      </div>

      <aside class="card">
        <h2>Suivi</h2>

        <div class="scoreBox">
          <div>
            <div class="small">Élève</div>
            <input id="studentName" type="text" placeholder="Prénom" />
          </div>
          <div>
            <div class="small">Score</div>
            <div class="scoreBig"><span id="score">0</span> / <span id="maxScore">24</span></div>
          </div>
          <div style="min-width:220px">
            <div class="small">Progression</div>
            <div class="bar"><div id="barFill"></div></div>
          </div>
        </div>

        <div class="btnRow">
          <button class="primary" id="checkAll">Tout corriger</button>
          <button id="saveBtn">Sauvegarder</button>
          <button id="exportBtn">Exporter</button>
          <button id="printBtn">Imprimer</button>
          <button class="danger" id="resetBtn">Réinitialiser</button>
        </div>

        <div class="sep"></div>

        <h2>Choisir un thème</h2>

        <p>Les exercices restent identiques, mais les exemples changent</p>

        <select id="themeSelect"></select>

        <div class="mini">
          Astuce devoir : une réponse C3 réussie explique un mécanisme, pas seulement une définition
        </div>
      </aside>
    </section>

    <section class="grid">

      <div class="card">
        <h2>Verbes d’action C3</h2>

        <p>Objectif : savoir ce que chaque verbe attend dans la copie</p>

        <div class="q">
          <div class="qHead">
            <strong>Comprendre</strong>
            <span class="tag">Bloom : comprendre</span>
          </div>
          <div class="twoCols">
            <div>
              <div class="pill"><span class="kbd">Expliquer</span> Pourquoi ou comment</div>
              <div class="hint">Cause → mécanisme → conséquence</div>
            </div>
            <div>
              <div class="pill"><span class="kbd">Justifier</span> Donner une raison solide</div>
              <div class="hint">Parce que → donc → ce qui permet de</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="twoCols">
            <div>
              <div class="pill"><span class="kbd">Décrire</span> Étapes ou fonctionnement</div>
              <div class="hint">Dans l’ordre, sans raconter hors sujet</div>
            </div>
            <div>
              <div class="pill"><span class="kbd">Relier</span> Faire un lien explicite</div>
              <div class="hint">A entraîne B car… donc…</div>
            </div>
          </div>
        </div>

        <div class="q">
          <div class="qHead">
            <strong>Différencier C2, C3, C4</strong>
            <span class="tag">Bloom : analyser</span>
          </div>

          <p>
            C2 repérer, identifier, indiquer, relever
            <br>
            C3 expliquer, décrire un mécanisme, expliquer un lien, expliquer une règle
            <br>
            C4 proposer une mesure de prévention
          </p>

          <div class="mini">
            Si la réponse peut tenir en un mot, une date, un numéro, une flèche sur un schéma, c’est souvent C2
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Entraînement progressif</h2>

        <div class="q" data-q="1" data-max="6">
          <div class="qHead">
            <strong>Exercice 1</strong>
            <span class="tag">Identifier</span>
            <span class="tag">6 points</span>
          </div>

          <p>Identifier si la consigne correspond plutôt à C2, C3 ou C4</p>

          <div class="choices" id="ex1"></div>

          <button class="primary" data-action="check1">Corriger</button>

          <div class="feedback" id="fb1"></div>
        </div>

        <div class="q" data-q="2" data-max="6">
          <div class="qHead">
            <strong>Exercice 2</strong>
            <span class="tag">Expliquer</span>
            <span class="tag">6 points</span>
          </div>

          <p>Compléter une explication C3 en choisissant les bons mots</p>

          <div class="sep"></div>

          <div id="clozeText" class="hint"></div>

          <div style="margin-top:10px;display:grid;gap:10px">
            <select id="c2a"></select>
            <select id="c2b"></select>
            <select id="c2c"></select>
          </div>

          <button class="primary" data-action="check2">Corriger</button>

          <div class="feedback" id="fb2"></div>
        </div>

        <div class="q" data-q="3" data-max="6">
          <div class="qHead">
            <strong>Exercice 3</strong>
            <span class="tag">Analyser</span>
            <span class="tag">6 points</span>
          </div>

          <p>Classer : cause, mécanisme, conséquence, prévention</p>

          <p class="hint">Ordinateur : glisse-dépose. Smartphone ou tablette : touche un mot pour le sélectionner, puis touche la case où le déposer.</p>
<div class="drags">
            <div class="bank" id="bank">
              <h4>Banque</h4>
            </div>

            <div style="display:grid;gap:12px">
              <div class="zone" data-accept="cause"><h4>Cause</h4></div>
              <div class="zone" data-accept="meca"><h4>Mécanisme</h4></div>
              <div class="zone" data-accept="cons"><h4>Conséquence</h4></div>
              <div class="zone" data-accept="prev"><h4>Prévention</h4></div>
            </div>
          </div>

          <div class="btnRow">
            <button class="primary" data-action="check3">Corriger</button>
            <button data-action="reset3">Remettre</button>
          </div>

          <div class="feedback" id="fb3"></div>
        </div>

        <div class="q" data-q="4" data-max="6">
          <div class="qHead">
            <strong>Exercice 4</strong>
            <span class="tag">Créer</span>
            <span class="tag">6 points</span>
          </div>

          <p>Rédiger une réponse type devoir en suivant la méthode</p>

          <div class="twoCols">
            <div>
              <h3>Consigne</h3>
              <div id="prompt4" class="hint"></div>

              <div class="sep"></div>

              <textarea id="answer4" placeholder="Écris ta réponse ici (6 à 10 lignes)"></textarea>

              <div class="btnRow">
                <button class="primary" data-action="check4">Valider</button>
                <button data-action="showModel">Voir un modèle</button>
                <button data-action="buildAnswer">Générer avec les blocs</button>
              </div>

              <div class="feedback" id="fb4"></div>
            </div>

            <div>
              <h3>Auto-barème</h3>

              <div class="rubric" id="rubric4">
                <label><input type="checkbox" data-pts="1"> J’ai nommé la cause ou le facteur principal</label>
                <label><input type="checkbox" data-pts="1"> J’ai expliqué le mécanisme avec un vocabulaire précis</label>
                <label><input type="checkbox" data-pts="1"> J’ai donné une conséquence claire</label>
                <label><input type="checkbox" data-pts="1"> Si la consigne parle de prévention, j’ai donné une mesure</label>
                <label><input type="checkbox" data-pts="1"> J’ai justifié le lien prévention → réduction du risque</label>
                <label><input type="checkbox" data-pts="1"> J’ai utilisé des connecteurs logiques (car, donc, ainsi, c’est pourquoi)</label>
              </div>

              <div class="sep"></div>

              <h3>Blocs C3</h3>

              <div class="hint">Remplis puis clique générer avec les blocs</div>

              <div style="display:grid;gap:10px;margin-top:8px">
                <textarea id="bCause" placeholder="Cause"></textarea>
                <textarea id="bMeca" placeholder="Mécanisme"></textarea>
                <textarea id="bCons" placeholder="Conséquence"></textarea>
                <textarea id="bPrev" placeholder="Prévention si demandé"></textarea>
                <textarea id="bJust" placeholder="Justification de la prévention"></textarea>
              </div>

              <div class="q" style="margin-top:12px">
                <div class="qHead">
                  <strong>Modèle</strong>
                  <span class="tag">Exemple</span>
                </div>
                <div id="model4" class="hint"></div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </section>

    <div class="toast" id="toast"></div>
  </div>

  <script>

    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    
const isTouch = (('ontouchstart' in window) || (navigator.maxTouchPoints > 0));
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));

    const themes = [
      {
        id:"sommeil",
        title:"Sommeil + smartphone",
        ex1:[
          {txt:"Indiquer le nom de l’hormone du sommeil", ans:"C2", why:"Réponse courte, un mot"},
          {txt:"Expliquer comment la lumière bleue peut retarder l’endormissement", ans:"C3", why:"Mécanisme cause → effet"},
          {txt:"Proposer deux mesures pour améliorer la qualité du sommeil", ans:"C4", why:"Mesures concrètes"},
          {txt:"Expliquer en quoi l’activité physique favorise le sommeil", ans:"C3", why:"Lien cause → effet"},
          {txt:"Identifier un facteur qui trouble le sommeil", ans:"C2", why:"Information à repérer"},
          {txt:"Proposer une règle personnelle d’usage des écrans le soir", ans:"C4", why:"Mesure de prévention"}
        ],
        cloze:{
          text:"Quand on utilise un téléphone le soir, la ___ envoie au cerveau le signal qu’il fait jour. Cela ___ la production de ___. Résultat : l’endormissement est ___.",
          a:{label:"Choisir le facteur", opts:["lumière bleue","bruit blanc","température froide"], ans:"lumière bleue"},
          b:{label:"Choisir l’action sur l’hormone", opts:["inhibe","augmente","remplace"], ans:"inhibe"},
          c:{label:"Choisir l’hormone", opts:["mélatonine","adrénaline","insuline"], ans:"mélatonine"}
        },
        drag:[
          {t:"Je consulte mon téléphone au lit", type:"cause"},
          {t:"La lumière bleue perturbe le signal jour nuit", type:"meca"},
          {t:"La mélatonine est moins produite", type:"meca"},
          {t:"Je m’endors plus tard", type:"cons"},
          {t:"Je suis fatigué le lendemain", type:"cons"},
          {t:"Couper les écrans 60 minutes avant dormir", type:"prev"}
        ],
        prompt:"Expliquer comment l’usage du téléphone le soir peut agir sur l’endormissement. Si tu ajoutes une prévention, justifie-la.",
        model:"La lumière bleue des écrans indique au cerveau qu’il fait encore jour. Cela inhibe la production de mélatonine, l’hormone qui facilite l’endormissement, et retarde donc l’endormissement. Pour limiter ce phénomène, on peut arrêter les écrans environ une heure avant de dormir ou activer un filtre, car cela réduit la lumière bleue reçue par le cerveau."
      },
      {
        id:"eau",
        title:"Eau potable + environnement",
        ex1:[
          {txt:"Indiquer la provenance initiale de l’eau du robinet", ans:"C2", why:"Une info à repérer"},
          {txt:"Expliquer l’intérêt de traiter l’eau avant sa distribution", ans:"C3", why:"Pourquoi, mécanisme sanitaire"},
          {txt:"Proposer quatre mesures individuelles pour réduire sa consommation d’eau", ans:"C4", why:"Mesures concrètes"},
          {txt:"Expliquer l’intérêt d’assainir l’eau avant rejet", ans:"C3", why:"Lien pollution → impact"},
          {txt:"Identifier l’ordre des étapes du circuit urbain", ans:"C2", why:"Repérage"},
          {txt:"Argumenter l’intérêt de boire l’eau du robinet", ans:"C5", why:"Choix + justification"}
        ],
        cloze:{
          text:"L’eau prélevée dans la nature n’est pas toujours ___. Elle peut contenir des ___. Le traitement permet donc de la rendre ___ pour protéger la santé.",
          a:{label:"Choisir", opts:["potable","déminéralisée","sucrée"], ans:"potable"},
          b:{label:"Choisir", opts:["microorganismes","vitamines","fibres"], ans:"microorganismes"},
          c:{label:"Choisir", opts:["potable","opaque","salée"], ans:"potable"}
        },
        drag:[
          {t:"Eau prélevée en rivière ou nappe", type:"cause"},
          {t:"Présence possible de microorganismes", type:"cause"},
          {t:"Traitement : filtration, désinfection", type:"meca"},
          {t:"Risque de maladies si non traitée", type:"cons"},
          {t:"Protection de la santé publique", type:"cons"},
          {t:"Assainissement avant rejet pour limiter la pollution", type:"prev"}
        ],
        prompt:"Expliquer l’intérêt de traiter l’eau avant sa distribution. Si tu ajoutes une prévention, justifie-la.",
        model:"Lorsqu’on prélève l’eau dans la nature, elle n’est pas forcément potable et peut contenir des microorganismes ou des polluants. Le traitement (filtration, désinfection) permet d’éliminer ces dangers afin de rendre l’eau potable. Cela protège la population en réduisant le risque de maladies liées à une eau contaminée."
      },
      {
        id:"at",
        title:"Accident du travail + réglementation",
        ex1:[
          {txt:"Identifier la nature du risque évoqué", ans:"C2", why:"Repérage"},
          {txt:"Expliquer en quoi un accident est reconnu accident du travail", ans:"C3", why:"Critères réglementaires"},
          {txt:"Proposer une mesure de prévention pour éviter ce type d’accident", ans:"C4", why:"Mesure"},
          {txt:"Expliquer le rôle du SST avant et après un accident", ans:"C3", why:"Rôle + lien"},
          {txt:"Indiquer le contenu du message d’alerte", ans:"C2", why:"Liste d’informations"},
          {txt:"Argumenter l’intérêt de former au SST", ans:"C5", why:"Choix + justification"}
        ],
        cloze:{
          text:"Un accident du travail est un fait ___ qui survient ___ le lieu de travail, à l’occasion du travail, et provoque une ___.",
          a:{label:"Choisir", opts:["soudain","progressif","imaginaire"], ans:"soudain"},
          b:{label:"Choisir", opts:["sur","hors","loin du"], ans:"sur"},
          c:{label:"Choisir", opts:["lésion","récompense","promotion"], ans:"lésion"}
        },
        drag:[
          {t:"Salarié en activité de travail", type:"cause"},
          {t:"Événement soudain", type:"meca"},
          {t:"Sur le lieu et pendant le travail", type:"meca"},
          {t:"Lésion + arrêt possible", type:"cons"},
          {t:"Reconnaissance et indemnisation", type:"cons"},
          {t:"Respecter les démarches pour être indemnisé", type:"prev"}
        ],
        prompt:"Expliquer en quoi l’accident du salarié est reconnu accident du travail. Si tu ajoutes une prévention, justifie-la.",
        model:"Un accident du travail correspond à un événement soudain survenu sur le lieu de travail, à l’occasion du travail, et qui entraîne une lésion. Si ces critères sont réunis, l’accident peut être reconnu comme accident du travail, ce qui permet au salarié d’être pris en charge et indemnisé pendant l’arrêt."
      }
    ];

    const state = {
      points:{1:0,2:0,3:0,4:0},
      max:{1:6,2:6,3:6,4:6},
      themeId: themes[0].id
    };

    function totalScore(){ return Object.values(state.points).reduce((a,b)=>a+b,0); }
    function maxScore(){ return Object.values(state.max).reduce((a,b)=>a+b,0); }

    function renderScore(){
      $("#score").textContent = totalScore();
      $("#maxScore").textContent = maxScore();
      const pct = (totalScore()/maxScore())*100;
      $("#barFill").style.width = clamp(pct,0,100).toFixed(0) + "%";
    }

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._id);
      toast._id = setTimeout(()=>t.style.display="none", 1800);
    }

    function setFeedback(id, kind, html){
      const el = $(id);
      el.className = "feedback " + kind;
      el.innerHTML = html;
    }

    function currentTheme(){
      return themes.find(t=>t.id===state.themeId) || themes[0];
    }

    function fillThemes(){
      const sel = $("#themeSelect");
      sel.innerHTML = themes.map(t=>`<option value="${t.id}">${t.title}</option>`).join("");
      sel.value = state.themeId;
      sel.addEventListener("change", ()=>{
        state.themeId = sel.value;
        buildAll();
        toast("Thème changé");
        saveLocal();
      });
    }

    function buildEx1(){
      const t = currentTheme();
      const wrap = $("#ex1");
      const labels = {C2:"C2", C3:"C3", C4:"C4"};
      wrap.innerHTML = "";

      t.ex1.forEach((item, idx)=>{
        const qId = `ex1_${idx}`;
        const block = document.createElement("div");
        block.className = "choice";
        block.innerHTML = `
          <input type="radio" name="${qId}" value="C2" aria-label="C2">
          <input type="radio" name="${qId}" value="C3" aria-label="C3">
          <input type="radio" name="${qId}" value="C4" aria-label="C4">
          <div>
            <div style="font-weight:800">${idx+1}. ${item.txt}</div>
            <div class="hint">Choix : <span class="kbd">${labels.C2}</span> <span class="kbd">${labels.C3}</span> <span class="kbd">${labels.C4}</span></div>
            <div class="small">Indice : ${item.why}</div>
          </div>
        `;
        wrap.appendChild(block);
      });
    }

    function check1(){
      const t = currentTheme();
      let pts = 0;
      let wrong = [];
      t.ex1.forEach((item, idx)=>{
        const qId = `ex1_${idx}`;
        const picked = ($$(`input[name="${qId}"]:checked`)[0] || {}).value || "";
        if(picked === item.ans) pts += 1;
        else wrong.push(idx+1);
      });
      state.points[1] = pts;
      if(pts === 6){
        setFeedback("#fb1","ok",`✅ ${pts}/6. Tu différencies bien C2, C3, C4.`);
      }else{
        setFeedback("#fb1","warn",`⚠️ ${pts}/6. À revoir : item(s) ${wrong.join(", ")}. Astuce : proposer une mesure = C4, expliquer un mécanisme = C3, repérer une info = C2.`);
      }
      renderScore();
      saveLocal();
    }

    function buildCloze(){
      const t = currentTheme();
      $("#clozeText").innerHTML = t.cloze.text.replaceAll("___", `<span class="kbd">…</span>`);
      const a = $("#c2a"), b = $("#c2b"), c = $("#c2c");
      a.innerHTML = `<option value="">${t.cloze.a.label}</option>` + t.cloze.a.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      b.innerHTML = `<option value="">${t.cloze.b.label}</option>` + t.cloze.b.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      c.innerHTML = `<option value="">${t.cloze.c.label}</option>` + t.cloze.c.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
    }

    function check2(){
      const t = currentTheme();
      let pts = 0;
      if($("#c2a").value === t.cloze.a.ans) pts += 2;
      if($("#c2b").value === t.cloze.b.ans) pts += 2;
      if($("#c2c").value === t.cloze.c.ans) pts += 2;
      state.points[2] = pts;

      if(pts === 6){
        setFeedback("#fb2","ok","✅ 6/6. Tu construis une explication C3 propre.");
      }else{
        setFeedback("#fb2","bad",`❌ ${pts}/6. Reprends la logique cause → mécanisme → conséquence, puis relis la phrase pour vérifier qu’elle a du sens.`);
      }
      renderScore();
      saveLocal();
    }

    let dragItem = null;

    function enableDnD(){
      document.addEventListener("dragstart", e=>{
        if(e.target.classList.contains("token")){
          dragItem = e.target;
          setTimeout(()=>dragItem.style.opacity=".55",0);
        }
      });
      document.addEventListener("dragend", e=>{
        if(dragItem){
          dragItem.style.opacity="1";
          dragItem = null;
        }
      });

      $$(".zone, #bank").forEach(z=>{
        z.addEventListener("dragover", e=>e.preventDefault());
        z.addEventListener("drop", e=>{
          e.preventDefault();
          if(!dragItem) return;
          z.appendChild(dragItem);
        });
      });
    }

function enableTouchPickPlace(){
  // Mode mobile : toucher pour sélectionner, toucher une zone pour déposer
  const bank = $("#bank");
  let selected = null;

  const toast = (msg)=>{
    const t = $("#toast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>t.classList.remove("show"), 1200);
  };

  const clearSel = ()=>{
    if(selected){
      selected.classList.remove("selected");
      selected = null;
    }
  };

  document.addEventListener("pointerdown", (e)=>{
    if(!isTouch) return;

    const tok = e.target.closest(".token");
    const drop = e.target.closest(".zone, #bank");

    if(tok){
      e.preventDefault();
      if(selected === tok){
        bank.appendChild(tok);
        clearSel();
        toast("Mot remis dans la banque");
      }else{
        clearSel();
        selected = tok;
        tok.classList.add("selected");
        toast("Mot sélectionné");
      }
      return;
    }

    if(drop && selected){
      e.preventDefault();
      drop.appendChild(selected);
      clearSel();
      toast("Déposé");
      return;
    }

    // Tap ailleurs : on annule la sélection
    if(selected) clearSel();
  }, {passive:false});
}



    function buildDrag(){
      const t = currentTheme();
      const bank = $("#bank");
      bank.innerHTML = "<h4>Banque</h4>";
      t.drag.forEach((item)=>{
        const d = document.createElement("div");
        d.className = "token";
        d.draggable = !isTouch;
        d.dataset.type = item.type;
        d.textContent = item.t;
        bank.appendChild(d);
      });

      $$(".zone").forEach(z=>{
        $$(".token", z).forEach(tok=>bank.appendChild(tok));
      });
    }

    function reset3(){
      const bank = $("#bank");
      $$(".zone .token").forEach(t=>bank.appendChild(t));
      state.points[3] = 0;
      setFeedback("#fb3","warn","Remis à zéro. Recommence le classement.");
      renderScore();
      saveLocal();
    }

    function check3(){
      let pts = 0;
      let details = [];
      $$(".zone").forEach(z=>{
        const accept = z.dataset.accept;
        $$(".token", z).forEach(tok=>{
          if(tok.dataset.type === accept) pts += 1;
          else details.push(tok.textContent.trim());
        });
      });

      state.points[3] = clamp(pts,0,6);

      if(state.points[3] === 6){
        setFeedback("#fb3","ok","✅ 6/6. Ta structure cause → mécanisme → conséquence est maîtrisée.");
      }else{
        const ex = details.slice(0,3).map(s=>`• ${s}`).join("<br>");
        setFeedback("#fb3","warn",`⚠️ ${state.points[3]}/6. À remettre au bon endroit :<br>${ex}${details.length>3?"<br>• …":""}<br><br>Astuce : prévention = action concrète qui réduit le risque.`);
      }
      renderScore();
      saveLocal();
    }

    function buildEx4(){
      const t = currentTheme();
      $("#prompt4").innerHTML = `<span class="linkish">${t.title}</span><br><br>${t.prompt}`;
      $("#model4").textContent = t.model;
    }

    function check4(){
      const text = $("#answer4").value.trim();
      let pts = 0;

      $$('#rubric4 input[type="checkbox"]').forEach(cb=>{
        if(cb.checked) pts += Number(cb.dataset.pts || 0);
      });

      if(text.length < 180){
        pts = Math.min(pts, 3);
        setFeedback("#fb4","warn",`⚠️ ${pts}/6. Réponse trop courte. Vise 6 à 10 lignes avec mécanisme + conséquence.`);
      }else{
        if(pts >= 5) setFeedback("#fb4","ok",`✅ ${pts}/6. Niveau devoir.`);
        else if(pts >= 3) setFeedback("#fb4","warn",`⚠️ ${pts}/6. Ajoute mécanisme précis et justification de la prévention si tu en proposes une.`);
        else setFeedback("#fb4","bad",`❌ ${pts}/6. Reprends la méthode : cause → mécanisme → conséquence, puis prévention si demandé.`);
      }

      state.points[4] = clamp(pts,0,6);
      renderScore();
      saveLocal();
    }

    function showModel(){
      const m = $("#model4");
      m.parentElement.scrollIntoView({behavior:"smooth", block:"start"});
      toast("Modèle visible");
    }

    function buildAnswerFromBlocks(){
      const parts = [];
      const c = $("#bCause").value.trim();
      const m = $("#bMeca").value.trim();
      const k = $("#bCons").value.trim();
      const p = $("#bPrev").value.trim();
      const j = $("#bJust").value.trim();

      if(c) parts.push(c);
      if(m) parts.push(m);
      if(k) parts.push(k);
      if(p) parts.push(p);
      if(j) parts.push(j);

      const built = parts.join(" ");
      if(built.length < 10){
        toast("Remplis au moins un bloc");
        return;
      }
      $("#answer4").value = built;
      toast("Réponse générée");
      saveLocal();
    }

    function checkAll(){
      check1();
      check2();
      check3();
      check4();
      const pct = Math.round((totalScore()/maxScore())*100);
      if(pct >= 85) toast("Bravo : C3 bien maîtrisée");
      else if(pct >= 60) toast("Bien : retravailler la justification");
      else toast("À reprendre : méthode cause → mécanisme → conséquence");
    }

    function resetAll(){
      state.points = {1:0,2:0,3:0,4:0};

      // ex1
      currentTheme().ex1.forEach((_, idx)=>{
        const qId = `ex1_${idx}`;
        $$(`input[name="${qId}"]`).forEach(r=>r.checked=false);
      });

      // ex2
      $("#c2a").value = ""; $("#c2b").value = ""; $("#c2c").value = "";

      // ex3
      reset3();

      // ex4
      $("#answer4").value = "";
      $$("#rubric4 input").forEach(cb=>cb.checked=false);
      $("#bCause").value=""; $("#bMeca").value=""; $("#bCons").value=""; $("#bPrev").value=""; $("#bJust").value="";

      ["#fb1","#fb2","#fb3","#fb4"].forEach(id=>{
        const el = $(id);
        el.className = "feedback";
        el.style.display = "none";
        el.textContent = "";
      });

      renderScore();
      saveLocal();
      toast("Réinitialisé");
    }

    function saveLocal(){
      const payload = {
        themeId: state.themeId,
        points: state.points,
        studentName: $("#studentName").value || "",
        inputs: {
          c2a: $("#c2a").value,
          c2b: $("#c2b").value,
          c2c: $("#c2c").value,
          answer4: $("#answer4").value,
          rubric4: $$("#rubric4 input").map(cb=>cb.checked),
          blocks: {
            bCause: $("#bCause").value,
            bMeca: $("#bMeca").value,
            bCons: $("#bCons").value,
            bPrev: $("#bPrev").value,
            bJust: $("#bJust").value
          },
          ex1: currentTheme().ex1.map((_, idx)=>{
            const qId = `ex1_${idx}`;
            const picked = ($$(`input[name="${qId}"]:checked`)[0] || {}).value || "";
            return picked;
          }),
          drag: {
            bank: $$(".token", $("#bank")).map(t=>t.textContent),
            zones: $$(".zone").map(z=>({
              accept: z.dataset.accept,
              tokens: $$(".token", z).map(t=>({text:t.textContent, type:t.dataset.type}))
            }))
          }
        }
      };
      localStorage.setItem("pse_c3_pack", JSON.stringify(payload));
    }

    function restoreLocal(){
      const raw = localStorage.getItem("pse_c3_pack");
      if(!raw) return;
      try{
        const payload = JSON.parse(raw);
        if(payload.themeId) state.themeId = payload.themeId;
        if(payload.studentName) $("#studentName").value = payload.studentName;

        $("#themeSelect").value = state.themeId;
        buildAll();

        // ex1 restore
        const ex1 = payload.inputs?.ex1 || [];
        ex1.forEach((val, idx)=>{
          const qId = `ex1_${idx}`;
          if(val) {
            const r = $(`input[name="${qId}"][value="${val}"]`);
            if(r) r.checked = true;
          }
        });

        // cloze
        if(payload.inputs?.c2a) $("#c2a").value = payload.inputs.c2a;
        if(payload.inputs?.c2b) $("#c2b").value = payload.inputs.c2b;
        if(payload.inputs?.c2c) $("#c2c").value = payload.inputs.c2c;

        // ex4
        if(payload.inputs?.answer4) $("#answer4").value = payload.inputs.answer4;
        const rb = payload.inputs?.rubric4 || [];
        $$("#rubric4 input").forEach((cb,i)=>cb.checked = !!rb[i]);

        const blocks = payload.inputs?.blocks || {};
        $("#bCause").value = blocks.bCause || "";
        $("#bMeca").value = blocks.bMeca || "";
        $("#bCons").value = blocks.bCons || "";
        $("#bPrev").value = blocks.bPrev || "";
        $("#bJust").value = blocks.bJust || "";

        // points
        if(payload.points) state.points = payload.points;
        renderScore();
      }catch(e){}
    }

    async function exportAll(){
      const name = ($("#studentName").value || "eleve").trim().replaceAll(" ","_");
      const data = {
        student: name,
        theme: currentTheme().title,
        score: {got: totalScore(), max: maxScore()},
        answer4: $("#answer4").value || "",
        timestamp: new Date().toISOString()
      };
      const txt = JSON.stringify(data, null, 2);
      try{
        await navigator.clipboard.writeText(txt);
        toast("Export copié");
      }catch(e){
        toast("Copie impossible");
      }
    }

    function buildAll(){
      buildEx1();
      buildCloze();
      buildDrag();
      buildEx4();
      renderScore();
    }

    document.addEventListener("click", e=>{
      const a = e.target?.dataset?.action;
      if(!a) return;
      if(a==="check1") check1();
      if(a==="check2") check2();
      if(a==="check3") check3();
      if(a==="reset3") reset3();
      if(a==="check4") check4();
      if(a==="showModel") showModel();
      if(a==="buildAnswer") buildAnswerFromBlocks();
    });

    $("#checkAll").addEventListener("click", checkAll);
    $("#resetBtn").addEventListener("click", resetAll);
    $("#saveBtn").addEventListener("click", ()=>{ saveLocal(); toast("Sauvegardé"); });
    $("#exportBtn").addEventListener("click", exportAll);
    $("#printBtn").addEventListener("click", ()=>window.print());
    $("#studentName").addEventListener("input", saveLocal);

    fillThemes();
    buildAll();
    enableDnD();
  if(isTouch) enableTouchPickPlace();
    restoreLocal();
  
</script>
</body>
</html>
