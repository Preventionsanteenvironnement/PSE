<!doctype html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Analyse de risque au travail · Fiche interactive</title>

<style>
:root{
  --bg0:#0b1220; --bg1:#09101c; --card:#0f1b2e; --card2:#0c1728;
  --text:#e9f0ff; --muted:#a9b7d6; --line:rgba(255,255,255,.10);
  --accent:#6d5efc; --accent2:#1fd1a1; --danger:#ff5b7c; --warn:#ffd36b;
  --ok:#42e38e;
  --radius:18px;
  --btnText:#07111f;
  --chipBg:rgba(255,255,255,.05);
  --chipBorder:rgba(255,255,255,.12);
  --focus:rgba(109,94,252,.75);
  --zoneBg:rgba(109,94,252,.07);
  --zoneBorder:rgba(109,94,252,.35);
}

html[data-theme="light"]{
  --bg0:#f6f8ff; --bg1:#eef2ff; --card:#ffffff; --card2:#ffffff;
  --text:#0b1220; --muted:#384563; --line:rgba(0,0,0,.12);
  --btnText:#0b1220;
  --chipBg:rgba(0,0,0,.04);
  --chipBorder:rgba(0,0,0,.14);
  --focus:rgba(0,86,179,.55);
  --zoneBg:rgba(109,94,252,.08);
  --zoneBorder:rgba(109,94,252,.40);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  color:var(--text);
  background:
    radial-gradient(1200px 800px at 20% -10%, rgba(109,94,252,.22), transparent 55%),
    radial-gradient(900px 700px at 90% 0%, rgba(31,209,161,.18), transparent 50%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}
html[data-theme="light"] body{
  background:
    radial-gradient(1200px 800px at 20% -10%, rgba(109,94,252,.16), transparent 55%),
    radial-gradient(900px 700px at 90% 0%, rgba(31,209,161,.12), transparent 50%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

.container{max-width:980px;margin:0 auto;padding:20px 16px 42px}
.header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin:10px 0 18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:14px;background:
  radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%),
  linear-gradient(135deg, rgba(109,94,252,.9), rgba(31,209,161,.7));
  box-shadow: 0 12px 30px rgba(0,0,0,.25);
}
h1{font-size:20px;line-height:1.15;margin:0}
.subtitle{color:var(--muted);font-size:13px;margin-top:6px}
.pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pill{border:1px solid var(--line);background:rgba(255,255,255,.04);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted)}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line); border-radius:var(--radius);
  box-shadow: 0 14px 35px rgba(0,0,0,.18);
}
html[data-theme="light"] .card{
  background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.01));
  box-shadow: 0 14px 35px rgba(0,0,0,.08);
}
.card-inner{padding:16px}
.section{margin:14px 0}
h2{font-size:16px;margin:0 0 10px}
p{margin:10px 0;color:var(--muted);line-height:1.45}
hr.sep{border:none;border-top:1px solid var(--line);margin:14px 0}

.grid{display:grid;gap:12px}
@media (min-width:860px){ .grid.cols2{grid-template-columns: 1fr 1fr} }

.btnrow{display:flex;gap:10px;flex-wrap:wrap}
button{
  appearance:none;border:none;cursor:pointer;
  padding:12px 14px;border-radius:14px;
  background:linear-gradient(135deg, rgba(109,94,252,.9), rgba(31,209,161,.75));
  color:var(--btnText);font-weight:800;
  box-shadow:0 10px 24px rgba(0,0,0,.16);
}
button.secondary{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--text);
  font-weight:700;
}
html[data-theme="light"] button.secondary{
  background:rgba(0,0,0,.04);
}
button:active{transform:translateY(1px)}
.small{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:var(--muted);font-size:12px}
.badge strong{color:var(--text)}

.exercise{margin-top:14px}
.exercise-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.exercise-title{display:flex;align-items:center;gap:10px}
.tag{display:inline-flex;align-items:center;gap:8px;background:rgba(109,94,252,.14);border:1px solid rgba(109,94,252,.35);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
.tag .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
.points{display:inline-flex;align-items:center;gap:10px}
.points .pill2{background:rgba(255,255,255,.06);border:1px solid var(--line);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
.hint{margin:10px 0 0;color:var(--muted);font-size:13px}

.q{
  background:rgba(0,0,0,.12);
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
}
html[data-theme="light"] .q{
  background:rgba(0,0,0,.03);
}
.q h3{margin:0 0 8px;font-size:14px}

.choice{display:flex;align-items:flex-start;gap:10px;padding:10px 10px;border-radius:14px;border:1px solid transparent}
.choice:hover{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.06)}
html[data-theme="light"] .choice:hover{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.06)}
.choice input{transform:translateY(2px)}
.choice span{color:var(--text);font-size:13px;line-height:1.35}

textarea,input[type="text"]{
  width:100%;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  color:var(--text);
  padding:12px 12px;
  font-size:14px;
  outline:none;
}
html[data-theme="light"] textarea, html[data-theme="light"] input[type="text"]{
  background:rgba(0,0,0,.03);
}
textarea{min-height:92px;resize:vertical}
.kbd{
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  padding:2px 6px;
  border-radius:8px;
  color:var(--text);
  font-size:12px
}
html[data-theme="light"] .kbd{
  background:rgba(0,0,0,.04);
}

.bank{
  margin-top:10px;
  border:1px dashed rgba(255,255,255,.22);
  background:rgba(255,255,255,.03);
  border-radius:16px;
  padding:12px;
  min-height:58px;
}
html[data-theme="light"] .bank{
  border:1px dashed rgba(0,0,0,.18);
  background:rgba(0,0,0,.02);
}

.bank-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.bank-title{color:var(--muted);font-size:13px}
.chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

.chip{
  user-select:none;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--chipBorder);
  background:var(--chipBg);
  color:var(--text);
  font-size:13px;
  line-height:1;
  touch-action:manipulation;
}
.chip[draggable="true"]{cursor:grab}
.chip.selected{outline:2px solid var(--focus); background:rgba(109,94,252,.18)}

.zone{
  border:2px dashed var(--zoneBorder);
  background:var(--zoneBg);
  border-radius:16px;
  min-height:66px;
  padding:10px;
}
.zone-title{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
.zone-title strong{font-size:13px}
.zone-title span{color:var(--muted);font-size:12px}
.zone.over{border-color:rgba(31,209,161,.55); background:rgba(31,209,161,.10)}
.zone .chips{margin-top:0}
.zone .chip{background:rgba(255,255,255,.06)}
html[data-theme="light"] .zone .chip{background:rgba(0,0,0,.04)}

.feedback{margin-top:10px;border-radius:16px;border:1px solid var(--line);padding:12px;background:rgba(255,255,255,.04)}
html[data-theme="light"] .feedback{background:rgba(0,0,0,.02)}
.feedback.good{border-color:rgba(66,227,142,.35);background:rgba(66,227,142,.10)}
.feedback.bad{border-color:rgba(255,91,124,.35);background:rgba(255,91,124,.10)}
.feedback h4{margin:0 0 6px;font-size:13px}
.feedback p{margin:0;color:var(--muted)}

.scorebar{
  position:sticky;top:0;z-index:20;
  backdrop-filter: blur(10px);
  background: rgba(9,16,28,.65);
  border-bottom:1px solid rgba(255,255,255,.08);
}
html[data-theme="light"] .scorebar{
  background: rgba(246,248,255,.70);
  border-bottom:1px solid rgba(0,0,0,.10);
}
.scorebar-inner{max-width:980px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.progress{flex:1;min-width:200px;height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
html[data-theme="light"] .progress{background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.12)}
.progress > div{height:100%;width:0%;background:linear-gradient(90deg, rgba(109,94,252,.95), rgba(31,209,161,.9))}
.scoretext{font-size:13px;color:var(--muted)}
.scoretext strong{color:var(--text)}

.toast{
  position:fixed;left:12px;right:12px;bottom:14px;max-width:980px;margin:0 auto;
  border:1px solid var(--line);border-radius:16px;padding:12px 14px;background:rgba(9,16,28,.85);
  box-shadow:0 16px 40px rgba(0,0,0,.25);display:none
}
html[data-theme="light"] .toast{
  background:rgba(255,255,255,.88);
  box-shadow:0 16px 40px rgba(0,0,0,.12);
}
.toast.show{display:block}
.toast .t{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.toast .t p{margin:0;color:var(--muted)}
.toast .t strong{color:var(--text)}

:focus-visible{
  outline:3px solid var(--focus);
  outline-offset:3px;
  border-radius:14px;
}
</style>
</head>

<body>
<div class="scorebar">
  <div class="scorebar-inner">
    <div class="scoretext">
      <strong id="scoreNow">0</strong> / <span id="scoreMax">0</span> points · <span id="doneCount">0</span>/<span id="totalCount">0</span> exercices corrigés
    </div>

    <div class="progress" aria-label="Progression"><div id="progressFill"></div></div>

    <div class="btnrow">
      <button class="secondary" id="themeToggle" type="button" aria-label="Basculer le thème">Thème</button>
      <button class="secondary" id="resetAll" type="button">Réinitialiser</button>
      <button id="finalBtn" type="button">Voir mon résultat</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Analyse de risque au travail · Fiche interactive</h1>
        <div class="subtitle">Danger · Situation dangereuse · Événement dangereux · Dommage</div>
      </div>
    </div>
  </div>

  <!-- Bloc identification anonyme pour l'envoi Firebase -->
  <div class="card section">
    <div class="card-inner">
      <h2>Identification anonyme</h2>
      <p class="small">Renseigne ta <strong>classe</strong> et ton <strong>code élève</strong> (ex : C2-07). Ces informations servent uniquement à envoyer ta copie à ton professeur.</p>
      <div class="grid cols2" style="margin-top:10px">
        <div>
          <div class="small">Classe</div>
          <input type="text" id="meta_classe" placeholder="ex : 1CAP PSR" autocomplete="off"/>
        </div>
        <div>
          <div class="small">Code élève</div>
          <input type="text" id="meta_code" placeholder="ex : C2-07" autocomplete="off"/>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-inner">
      <h2>Rappels rapides : analyser un risque au travail</h2>
      <p>Objectif : repérer <strong>Danger</strong> → <strong>Situation dangereuse</strong> → <strong>Événement dangereux</strong> → <strong>Dommage</strong>, puis identifier des <strong>mesures de prévention</strong>.</p>

      <div class="grid cols2">
        <div class="q">
          <h3>Les 4 mots-clés</h3>
          <p><strong>Danger</strong> : cause capable de provoquer une lésion ou une atteinte à la santé.</p>
          <p><strong>Situation dangereuse</strong> : situation où une personne est exposée à un ou plusieurs dangers.</p>
          <p><strong>Événement dangereux</strong> : événement susceptible de causer un dommage (soudain ou à long terme).</p>
          <p><strong>Dommage</strong> : lésion / atteinte à la santé.</p>
        </div>

        <div class="q">
          <h3>Le processus (version simple)</h3>
          <p>Quand une <strong>personne</strong> se trouve dans une <strong>situation dangereuse</strong> (exposée au <strong>danger</strong>), un <strong>événement dangereux</strong> peut se produire et provoquer un <strong>dommage</strong>.</p>
          <div class="small" style="margin-top:10px">
            Astuce : <span class="kbd">Qu’est-ce qui blesse ?</span> (danger) · <span class="kbd">Dans quelles conditions ?</span> (situation) · <span class="kbd">Qu’est-ce qui arrive ?</span> (événement) · <span class="kbd">Qu’est-ce que ça fait ?</span> (dommage)
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card section exercise" data-exo="exo1" data-max="4">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 1 · Définitions</div>
          <div class="badge"><strong>4</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C1 / C2</div></div>
      </div>

      <div class="grid cols2" style="margin-top:12px">
        <div class="q">
          <h3>1) Cause capable de provoquer une lésion</h3>
          <label class="choice"><input type="radio" name="q1" value="a"/><span>Événement dangereux</span></label>
          <label class="choice"><input type="radio" name="q1" value="b"/><span>Danger</span></label>
          <label class="choice"><input type="radio" name="q1" value="c"/><span>Dommage</span></label>
        </div>

        <div class="q">
          <h3>2) Personne exposée à un danger</h3>
          <label class="choice"><input type="radio" name="q2" value="a"/><span>Situation dangereuse</span></label>
          <label class="choice"><input type="radio" name="q2" value="b"/><span>Dommage</span></label>
          <label class="choice"><input type="radio" name="q2" value="c"/><span>Danger</span></label>
        </div>

        <div class="q">
          <h3>3) Ce qui se produit (glissade, contact, chute…)</h3>
          <label class="choice"><input type="radio" name="q3" value="a"/><span>Événement dangereux</span></label>
          <label class="choice"><input type="radio" name="q3" value="b"/><span>Danger</span></label>
          <label class="choice"><input type="radio" name="q3" value="c"/><span>Situation dangereuse</span></label>
        </div>

        <div class="q">
          <h3>4) Fracture, brûlure, intoxication…</h3>
          <label class="choice"><input type="radio" name="q4" value="a"/><span>Dommage</span></label>
          <label class="choice"><input type="radio" name="q4" value="b"/><span>Danger</span></label>
          <label class="choice"><input type="radio" name="q4" value="c"/><span>Événement dangereux</span></label>
        </div>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct" type="button">Corriger</button>
        <button class="secondary btn-reset" type="button">Réinitialiser cet exercice</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <div class="card section exercise" data-exo="exo2" data-max="8">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 2 · Classer</div>
          <div class="badge"><strong>8</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C2</div></div>
      </div>

      <p class="hint">Classe chaque élément dans la bonne famille. Sur téléphone : touche un chip (il devient violet), puis touche une zone pour le déposer.</p>

      <div class="bank" role="region" aria-label="Banque (exercice 2)" tabindex="0" data-bank="exo2">
        <div class="bank-head">
          <div class="bank-title"><strong>Banque</strong> (8 éléments)</div>
          <button class="secondary btn-reset" type="button" style="padding:10px 12px;border-radius:14px">Réinitialiser</button>
        </div>
        <div class="chips">
          <div class="chip" draggable="true" data-id="c1">Sol glissant (huile / eau)</div>
          <div class="chip" draggable="true" data-id="c2">Glissade</div>
          <div class="chip" draggable="true" data-id="c3">Entorse</div>
          <div class="chip" draggable="true" data-id="c4">Se déplacer sur une zone encombrée</div>
          <div class="chip" draggable="true" data-id="c5">Électricité</div>
          <div class="chip" draggable="true" data-id="c6">Contact avec un conducteur nu</div>
          <div class="chip" draggable="true" data-id="c7">Électrocution</div>
          <div class="chip" draggable="true" data-id="c8">Travailler au voisinage d’un conducteur sous tension</div>
        </div>
      </div>

      <div class="grid cols2" style="margin-top:12px">
        <div class="zone" data-zone="danger" tabindex="0" role="region" aria-label="Zone Danger (cause) exercice 2">
          <div class="zone-title"><strong>Danger</strong><span>cause</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="situation" tabindex="0" role="region" aria-label="Zone Situation dangereuse (exposition) exercice 2">
          <div class="zone-title"><strong>Situation dangereuse</strong><span>exposition</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="event" tabindex="0" role="region" aria-label="Zone Événement dangereux (ce qui arrive) exercice 2">
          <div class="zone-title"><strong>Événement dangereux</strong><span>ce qui arrive</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="dommage" tabindex="0" role="region" aria-label="Zone Dommage (lésion) exercice 2">
          <div class="zone-title"><strong>Dommage</strong><span>lésion</span></div>
          <div class="chips"></div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct" type="button">Corriger</button>
        <button class="secondary btn-reset" type="button">Réinitialiser cet exercice</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <div class="card section exercise" data-exo="exo3" data-max="8">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 3 · Mini étude de cas</div>
          <div class="badge"><strong>8</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C2</div></div>
      </div>

      <div class="q">
        <h3>Situation</h3>
        <p>En atelier, une élève transporte des cartons. Le sol est humide près d’une porte. Elle glisse, tombe et se fait une entorse.</p>
        <hr class="sep"/>
        <p><strong>Consigne</strong> : complète les 4 cases.</p>

        <div class="grid cols2" style="margin-top:10px">
          <div>
            <div class="small">Danger</div>
            <input type="text" id="t_danger" placeholder="" autocomplete="off"/>
          </div>
          <div>
            <div class="small">Situation dangereuse</div>
            <input type="text" id="t_situation" placeholder="" autocomplete="off"/>
          </div>
          <div>
            <div class="small">Événement dangereux</div>
            <input type="text" id="t_event" placeholder="" autocomplete="off"/>
          </div>
          <div>
            <div class="small">Dommage</div>
            <input type="text" id="t_dommage" placeholder="" autocomplete="off"/>
          </div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct" type="button">Corriger</button>
        <button class="secondary btn-reset" type="button">Réinitialiser cet exercice</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <div class="card section exercise" data-exo="exo4" data-max="6">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 4 · Remettre dans l’ordre</div>
          <div class="badge"><strong>6</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C2</div></div>
      </div>

      <p class="hint">Place les étapes dans l’ordre logique (1 → 4). Sur téléphone : touche un chip (il devient violet), puis touche une zone 1 à 4.</p>

      <div class="bank" role="region" aria-label="Banque (exercice 4)" tabindex="0" data-bank="exo4">
        <div class="bank-head">
          <div class="bank-title"><strong>Banque</strong> (4 étapes)</div>
          <button class="secondary btn-reset" type="button" style="padding:10px 12px;border-radius:14px">Réinitialiser</button>
        </div>
        <div class="chips">
          <div class="chip" draggable="true" data-id="s1">Dommage (lésion)</div>
          <div class="chip" draggable="true" data-id="s2">Danger</div>
          <div class="chip" draggable="true" data-id="s3">Situation dangereuse</div>
          <div class="chip" draggable="true" data-id="s4">Événement dangereux</div>
        </div>
      </div>

      <div class="grid cols2" style="margin-top:12px">
        <div class="zone" data-zone="o1" data-max="1" tabindex="0" role="region" aria-label="Zone ordre 1 (début) exercice 4">
          <div class="zone-title"><strong>1</strong><span>Début</span></div><div class="chips"></div>
        </div>
        <div class="zone" data-zone="o2" data-max="1" tabindex="0" role="region" aria-label="Zone ordre 2 exercice 4">
          <div class="zone-title"><strong>2</strong><span></span></div><div class="chips"></div>
        </div>
        <div class="zone" data-zone="o3" data-max="1" tabindex="0" role="region" aria-label="Zone ordre 3 exercice 4">
          <div class="zone-title"><strong>3</strong><span></span></div><div class="chips"></div>
        </div>
        <div class="zone" data-zone="o4" data-max="1" tabindex="0" role="region" aria-label="Zone ordre 4 (fin) exercice 4">
          <div class="zone-title"><strong>4</strong><span>Fin</span></div><div class="chips"></div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct" type="button">Corriger</button>
        <button class="secondary btn-reset" type="button">Réinitialiser cet exercice</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <div class="card section">
    <div class="card-inner">
      <h2>Résultat</h2>
      <p class="small">Clavier : Tab pour naviguer · Entrée/Espace pour sélectionner un chip puis déposer dans une zone · Si un chip est dans une zone, Entrée/Espace le renvoie à la banque.</p>
      <div class="btnrow">
        <button class="secondary" id="openAllCorr" type="button">Afficher toutes les corrections</button>
        <button id="scrollTop" type="button">Revenir en haut</button>
        <button id="sendFirebase" type="button">Envoyer ma copie</button>
      </div>
      <div id="finalBox" class="feedback" style="display:none;margin-top:12px"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite">
  <div class="t">
    <p id="toastMsg"><strong>OK</strong></p>
    <button class="secondary" id="toastClose" type="button" style="padding:8px 10px;border-radius:12px">Fermer</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
  authDomain: "devoirs-pse.firebaseapp.com",
  projectId: "devoirs-pse",
  storageBucket: "devoirs-pse.firebasestorage.app",
  messagingSenderId: "614730413904",
  appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const copiesCol = collection(db, "bacpro");

const STORAGE_KEY = "pse_risque_v2";

const state = {
  totalMax: 0,
  totalScore: 0,
  perExo: {},
  selectedChipId: null,
  selectedChipEl: null
};

function $(sel, root=document){return root.querySelector(sel)}
function $all(sel, root=document){return Array.from(root.querySelectorAll(sel))}

function toast(msg) {
  const t = $("#toast");
  $("#toastMsg").innerHTML = msg;
  t.classList.add("show");
  window.clearTimeout(t._timer);
  t._timer = window.setTimeout(()=>t.classList.remove("show"), 2400);
}
$("#toastClose").addEventListener("click", ()=>$("#toast").classList.remove("show"));

function updateTopBar() {
  const max = state.totalMax;
  let score = 0;
  let done = 0;
  for (const v of Object.values(state.perExo)) {
    score += (v.score||0);
    if (v.done) done++;
  }
  state.totalScore = score;
  $("#scoreNow").textContent = score;
  $("#scoreMax").textContent = max;
  $("#doneCount").textContent = done;
  $("#totalCount").textContent = Object.keys(state.perExo).length;
  const pct = max ? Math.round((score/max)*100) : 0;
  $("#progressFill").style.width = pct + "%";
}

function normalize(s) {
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .replace(/[’']/g,"'")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

function tokensOf(s){ return normalize(s).split(" ").filter(Boolean); }

const NEGATORS = new Set(["pas","sans","aucun","aucune","jamais","ni","plus","n","ne"]);
function containsAnyPositive(text, keywords) {
  const tks = tokensOf(text);
  if (!tks.length) return false;

  for (const kw of keywords) {
    const kwT = tokensOf(kw);
    if (!kwT.length) continue;

    for (let i=0;i<=tks.length-kwT.length;i++) {
      let ok = true;
      for (let j=0;j<kwT.length;j++){
        if (tks[i+j] !== kwT[j]) { ok=false; break; }
      }
      if (!ok) continue;

      const start = Math.max(0, i-4);
      const before = tks.slice(start, i);
      const neg = before.some(w => NEGATORS.has(w));
      if (!neg) return true;
    }
  }
  return false;
}

function hasAny(text, keywords){
  return containsAnyPositive(text, keywords);
}

function markDone(exId, score, max) {
  state.perExo[exId] = state.perExo[exId] || {max};
  state.perExo[exId].score = score;
  state.perExo[exId].done = true;
  updateTopBar();
  saveState();
}

function makeFeedback(el, ok, title, html) {
  el.classList.remove("good","bad");
  el.classList.add(ok ? "good" : "bad");
  el.innerHTML = `<h4>${title}</h4><p>${html}</p>`;
  el.style.display = "block";
  saveState();
}

function resetSelection() {
  if (state.selectedChipEl) state.selectedChipEl.classList.remove("selected");
  state.selectedChipEl = null;
  state.selectedChipId = null;
  saveState();
}

function selectChip(chip){
  if (!chip) return;
  if (state.selectedChipId === chip.dataset.id) {
    resetSelection();
    return;
  }
  resetSelection();
  state.selectedChipId = chip.dataset.id;
  state.selectedChipEl = chip;
  chip.classList.add("selected");
  saveState();
}

function moveChipToContainer(chip, container){
  if (!chip || !container) return;
  container.appendChild(chip);
  resetSelection();
  saveState();
}

function enableDnD(root=document) {
  $all(".chip[draggable='true']", root).forEach(chip => {
    chip.addEventListener("dragstart", (e)=>{
      e.dataTransfer.setData("text/plain", chip.dataset.id);
      e.dataTransfer.effectAllowed="move";
      resetSelection();
    });
  });

  $all(".zone, .bank", root).forEach(zone => {
    zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("over"); });
    zone.addEventListener("dragleave", ()=>zone.classList.remove("over"));
    zone.addEventListener("drop", (e)=>{
      e.preventDefault();
      zone.classList.remove("over");
      const id = e.dataTransfer.getData("text/plain");
      if (!id) return;
      const chip = root.querySelector(`.chip[data-id="${CSS.escape(id)}"]`);
      if (!chip) return;

      const max = zone.dataset.max ? parseInt(zone.dataset.max,10) : null;
      const wrap = zone.querySelector(".chips") || zone;
      if (max && wrap.querySelectorAll(".chip").length >= max) {
        toast("Cette zone est déjà remplie.");
        return;
      }
      wrap.appendChild(chip);
      saveState();
    });
  });

  $all(".chip", root).forEach(chip => {
    chip.setAttribute("role","button");
    chip.setAttribute("tabindex","0");
    chip.setAttribute("aria-pressed","false");

    chip.addEventListener("click", ()=>{
      const ex = chip.closest("[data-exo]");
      const bank = ex?.querySelector(".bank .chips");
      const inZone = chip.closest(".zone");

      if (!state.selectedChipId) {
        if (inZone && bank) {
          bank.appendChild(chip);
          saveState();
          return;
        }
      }
      selectChip(chip);
      $all(".chip", root).forEach(c=>c.setAttribute("aria-pressed", c.classList.contains("selected") ? "true" : "false"));
    });

    chip.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        chip.click();
      }
    });
  });

  $all(".zone, .bank", root).forEach(zone => {
    zone.addEventListener("click", (e)=>{
      if (e.target.classList.contains("chip")) return;
      if (!state.selectedChipId || !state.selectedChipEl) return;

      const max = zone.dataset.max ? parseInt(zone.dataset.max,10) : null;
      const wrap = zone.querySelector(".chips") || zone;
      if (max && wrap.querySelectorAll(".chip").length >= max) {
        toast("Cette zone est déjà remplie.");
        return;
      }
      wrap.appendChild(state.selectedChipEl);
      resetSelection();
      saveState();
    });

    zone.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        zone.click();
      }
    });
  });
}

function wireExo1(){
  const ex = document.querySelector("[data-exo='exo1']");
  const fb = ex.querySelector(".feedback");
  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    let score=0;
    const ans = {q1:"b", q2:"a", q3:"a", q4:"a"};
    for (const [q,good] of Object.entries(ans)){
      const v = (ex.querySelector(`input[name='${q}']:checked`)||{}).value;
      if (v===good) score++;
    }
    makeFeedback(fb, score===4, "Correction", `Score : <strong>${score}</strong>/4. Danger = cause · Situation dangereuse = exposition · Événement dangereux = ce qui arrive · Dommage = lésion.`);
    markDone("exo1", score, 4);
  });

  ex.querySelector(".btn-reset").addEventListener("click", ()=>{
    ex.querySelectorAll("input[type='radio']").forEach(r=>r.checked=false);
    fb.style.display="none";
    state.perExo["exo1"]={max:4, score:0, done:false};
    updateTopBar();
    saveState();
  });

  ex.querySelectorAll("input[type='radio']").forEach(r=>{
    r.addEventListener("change", saveState);
  });
}

function wireExo2(){
  const ex = document.querySelector("[data-exo='exo2']");
  const fb = ex.querySelector(".feedback");
  const correct = {c1:"danger",c5:"danger",c4:"situation",c8:"situation",c2:"event",c6:"event",c3:"dommage",c7:"dommage"};

  function compute(){
    let score=0;
    for (const [id,zone] of Object.entries(correct)){
      const chip = ex.querySelector(`.chip[data-id="${CSS.escape(id)}"]`);
      const z = chip?.closest(".zone")?.dataset.zone || "bank";
      if (z===zone) score++;
    }
    return score;
  }

  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    const score = compute();
    makeFeedback(fb, score===8, "Correction", `Score : <strong>${score}</strong>/8. Sol glissant = danger · Se déplacer sur zone encombrée = situation · Glissade/Contact = événement · Entorse/Électrocution = dommage.`);
    markDone("exo2", score, 8);
  });

  ex.querySelectorAll(".btn-reset").forEach(btn=>btn.addEventListener("click", ()=>{
    const bank = ex.querySelector(".bank .chips");
    ex.querySelectorAll(".chip").forEach(ch=>bank.appendChild(ch));
    fb.style.display="none";
    state.perExo["exo2"]={max:8, score:0, done:false};
    updateTopBar();
    resetSelection();
    saveState();
  }));
}

function wireExo3(){
  const ex = document.querySelector("[data-exo='exo3']");
  const fb = ex.querySelector(".feedback");

  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    let score=0;
    const d = $("#t_danger").value;
    const s = $("#t_situation").value;
    const e = $("#t_event").value;
    const dom = $("#t_dommage").value;

    if (hasAny(d, ["sol glissant","sol humide","humidite","eau","huile"])) score+=2;
    if (hasAny(s, ["se deplacer","marcher","transport","porter","zone humide","pres de la porte","atelier"])) score+=2;
    if (hasAny(e, ["glisse","glissade","chute","tombe"])) score+=2;
    if (hasAny(dom, ["entorse","blessure","lesion"])) score+=2;

    makeFeedback(fb, score>=6, "Correction", `Score : <strong>${score}</strong>/8. Exemple : Danger = sol humide/glissant · Situation = se déplacer en portant des cartons près de la zone humide · Événement = glissade/chute · Dommage = entorse.`);
    markDone("exo3", score, 8);
  });

  ex.querySelector(".btn-reset").addEventListener("click", ()=>{
    ["t_danger","t_situation","t_event","t_dommage"].forEach(id=>$("#"+id).value="");
    fb.style.display="none";
    state.perExo["exo3"]={max:8, score:0, done:false};
    updateTopBar();
    saveState();
  });

  ["t_danger","t_situation","t_event","t_dommage"].forEach(id=>{
    $("#"+id).addEventListener("input", saveState);
  });
}

function wireExo4(){
  const ex = document.querySelector("[data-exo='exo4']");
  const fb = ex.querySelector(".feedback");
  const correctOrder = ["s2","s3","s4","s1"];

  function compute(){
    let score=0;
    for (let i=1;i<=4;i++){
      const zone = ex.querySelector(`.zone[data-zone="o${i}"]`);
      const chip = zone.querySelector(".chip");
      if (chip && chip.dataset.id===correctOrder[i-1]) score += 1.5;
    }
    return score;
  }

  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    const score = compute();
    makeFeedback(fb, score===6, "Correction", `Score : <strong>${score}</strong>/6. Ordre : Danger → Situation dangereuse → Événement dangereux → Dommage.`);
    markDone("exo4", score, 6);
  });

  ex.querySelectorAll(".btn-reset").forEach(btn=>btn.addEventListener("click", ()=>{
    const bank = ex.querySelector(".bank .chips");
    ex.querySelectorAll(".chip").forEach(ch=>bank.appendChild(ch));
    fb.style.display="none";
    state.perExo["exo4"]={max:6, score:0, done:false};
    updateTopBar();
    resetSelection();
    saveState();
  }));
}

function snapshotChipsByExo(){
  const out = {};
  $all("[data-exo]").forEach(ex=>{
    const exId = ex.dataset.exo;
    const zones = {};
    const bankWrap = ex.querySelector(".bank .chips");
    if (bankWrap) zones.bank = [];

    $all(".zone", ex).forEach(z=>{
      const k = z.dataset.zone || "zone";
      zones[k] = [];
      const wrap = z.querySelector(".chips") || z;
      $all(".chip", wrap).forEach(ch=>zones[k].push(ch.dataset.id));
    });

    if (bankWrap){
      $all(".chip", bankWrap).forEach(ch=>zones.bank.push(ch.dataset.id));
    }
    out[exId] = zones;
  });
  return out;
}

function restoreChipsByExo(data){
  if (!data) return;

  $all("[data-exo]").forEach(ex=>{
    const exId = ex.dataset.exo;
    const zones = data[exId];
    if (!zones) return;

    const byId = {};
    $all(".chip", ex).forEach(ch=>{ byId[ch.dataset.id] = ch; });

    Object.entries(zones).forEach(([zoneKey, ids])=>{
      const idsArr = Array.isArray(ids) ? ids : [];
      let wrap = null;

      if (zoneKey === "bank") {
        wrap = ex.querySelector(".bank .chips");
      } else {
        const z = ex.querySelector(`.zone[data-zone="${CSS.escape(zoneKey)}"]`);
        wrap = z ? (z.querySelector(".chips") || z) : null;
      }
      if (!wrap) return;

      idsArr.forEach(id=>{
        const chip = byId[id];
        if (chip) wrap.appendChild(chip);
      });
    });
  });
}

function saveState(){
  const payload = {
    v: 1,
    theme: document.documentElement.getAttribute("data-theme") || "dark",
    perExo: state.perExo,
    chips: snapshotChipsByExo(),
    radios: {},
    texts: {}
  };

  $all("input[type='radio']").forEach(r=>{
    if (r.checked) payload.radios[r.name] = r.value;
  });

  $all("input[type='text'], textarea").forEach(t=>{
    if (t.id) payload.texts[t.id] = t.value;
  });

  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(e){}
}

function loadState(){
  let raw = null;
  try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){}
  if (!raw) return;
  let payload = null;
  try{ payload = JSON.parse(raw); }catch(e){ return; }
  if (!payload || payload.v !== 1) return;

  const theme = payload.theme === "light" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", theme);

  if (payload.radios){
    Object.entries(payload.radios).forEach(([name, val])=>{
      const r = document.querySelector(`input[type='radio'][name="${CSS.escape(name)}"][value="${CSS.escape(val)}"]`);
      if (r) r.checked = true;
    });
  }

  if (payload.texts){
    Object.entries(payload.texts).forEach(([id, val])=>{
      const el = document.getElementById(id);
      if (el) el.value = val;
    });
  }

  restoreChipsByExo(payload.chips);

  if (payload.perExo && typeof payload.perExo === "object"){
    for (const [k,v] of Object.entries(payload.perExo)){
      if (state.perExo[k]) {
        state.perExo[k].score = v.score || 0;
        state.perExo[k].done = !!v.done;
      }
    }
  }
}

function clearSaved(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
}

function resetAll(root=document) {
  $all("input[type='radio']", root).forEach(r=>r.checked=false);
  $all("textarea, input[type='text']", root).forEach(t=>t.value="");

  $all("[data-exo]", root).forEach(ex=>{
    const bank = ex.querySelector(".bank .chips");
    if (!bank) return;
    $all(".chip", ex).forEach(ch=>bank.appendChild(ch));
  });

  $all(".feedback", root).forEach(f=>{ if (f.id!=="finalBox") f.style.display="none"; });
  $("#finalBox").style.display="none";

  for (const [k,v] of Object.entries(state.perExo)) {
    state.perExo[k] = {max: v.max, score:0, done:false};
  }

  resetSelection();
  updateTopBar();
  clearSaved();
  toast("<strong>Réinitialisé</strong> · Tu peux recommencer.");
}

function initTheme(){
  const saved = (()=>{ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }catch(e){ return null; }})();
  if (!saved) {
    const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
    document.documentElement.setAttribute("data-theme", prefersLight ? "light" : "dark");
  }
  $("#themeToggle").addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    const next = (cur === "dark") ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    saveState();
    toast(next === "light" ? "<strong>Thème clair</strong>" : "<strong>Thème sombre</strong>");
  });
}

function buildPayloadForFirebase(classe, code){
  const radios = {};
  $all("input[type='radio']").forEach(r=>{
    if (r.checked) radios[r.name] = r.value;
  });

  const texts = {};
  $all("input[type='text'], textarea").forEach(t=>{
    if (t.id) texts[t.id] = t.value;
  });

  const chips = snapshotChipsByExo();

  const exo1Answers = {
    q1: radios.q1 || null,
    q2: radios.q2 || null,
    q3: radios.q3 || null,
    q4: radios.q4 || null
  };

  const exo3Answers = {
    danger: texts["t_danger"] || "",
    situation: texts["t_situation"] || "",
    event: texts["t_event"] || "",
    dommage: texts["t_dommage"] || ""
  };

  const exo2Chips = (chips && chips.exo2) ? chips.exo2 : {};
  const exo4Chips = (chips && chips.exo4) ? chips.exo4 : {};

  const LABELS_EXO2 = {
    c1: "Sol glissant (huile / eau)",
    c2: "Glissade",
    c3: "Entorse",
    c4: "Se déplacer sur une zone encombrée",
    c5: "Électricité",
    c6: "Contact avec un conducteur nu",
    c7: "Électrocution",
    c8: "Travailler au voisinage d’un conducteur sous tension"
  };

  const LABELS_EXO4 = {
    s1: "Dommage (lésion)",
    s2: "Danger",
    s3: "Situation dangereuse",
    s4: "Événement dangereux"
  };

  function mapZone(zones, labels){
    const out = {};
    Object.entries(zones).forEach(([zoneName, ids])=>{
      out[zoneName] = (ids||[]).map(id => ({ id, label: labels[id] || id }));
    });
    return out;
  }

  const exo2Answers = mapZone(exo2Chips, LABELS_EXO2);
  const exo4Answers = mapZone(exo4Chips, LABELS_EXO4);

  const max = state.totalMax;
  const total = state.totalScore;
  const percent = max ? Math.round((total/max)*100) : 0;

  return {
    meta: {
      exoId: "fiche_risque_travail_v1",
      classe: classe || "",
      eleveCode: code,
      createdAt: serverTimestamp()
    },
    score: { total, max, percent },
    perExo: state.perExo,
    answers: {
      exo1: exo1Answers,
      exo2: exo2Answers,
      exo3: exo3Answers,
      exo4: exo4Answers
    },
    raw: {
      radios,
      texts,
      chips
    },
    client: {
      ua: navigator.userAgent || "",
      ts: Date.now()
    }
  };
}

document.addEventListener("DOMContentLoaded", ()=>{
  state.totalMax = 0;
  $all("[data-exo]").forEach(ex=>{
    const id = ex.dataset.exo;
    const max = parseInt(ex.dataset.max,10) || 0;
    state.perExo[id] = {max, score:0, done:false};
    state.totalMax += max;
  });
  $("#scoreMax").textContent = state.totalMax;

  initTheme();
  enableDnD(document);

  wireExo1();
  wireExo2();
  wireExo3();
  wireExo4();

  loadState();
  updateTopBar();

  $("#resetAll").addEventListener("click", ()=>resetAll(document));
  $("#scrollTop").addEventListener("click", ()=>window.scrollTo({top:0, behavior:"smooth"}));

  $("#openAllCorr").addEventListener("click", ()=>{
    $all("[data-exo]").forEach(ex=>{
      const btn = ex.querySelector(".btn-correct");
      if (btn) btn.click();
    });
    toast("<strong>Corrections</strong> · Affichées pour tous les exercices.");
  });

  $("#finalBtn").addEventListener("click", ()=>{
    const max = state.totalMax;
    let score = 0, done=0;
    for (const v of Object.values(state.perExo)) {
      score += (v.score||0);
      if (v.done) done++;
    }
    const pct = max ? Math.round((score/max)*100) : 0;
    const msg = (done < Object.keys(state.perExo).length)
      ? `Tu as corrigé <strong>${done}</strong> exercice(s) sur <strong>${Object.keys(state.perExo).length}</strong>.`
      : `Tout est corrigé.`;
    const level = pct>=80 ? "Très solide" : pct>=60 ? "Correct" : pct>=40 ? "À renforcer" : "À reprendre";
    const box = $("#finalBox");
    box.classList.remove("good","bad");
    box.classList.add(pct>=60 ? "good" : "bad");
    box.style.display="block";
    box.innerHTML = `<h4>Score final : ${score} / ${max} (${pct}%)</h4><p>${msg} Niveau : <strong>${level}</strong>.</p>`;
    box.scrollIntoView({behavior:"smooth", block:"center"});
    saveState();
  });

  $all("input[type='radio']").forEach(r=>{
    r.addEventListener("change", saveState);
  });

  const sendBtn = $("#sendFirebase");
  if (sendBtn) {
    sendBtn.addEventListener("click", async ()=>{
      const classe = ($("#meta_classe")?.value || "").trim();
      const code = ($("#meta_code")?.value || "").trim();
      if (!code){
        toast("Merci d’indiquer ton <strong>code élève</strong>.");
        return;
      }
      try{
        const payload = buildPayloadForFirebase(classe, code);
        await addDoc(copiesCol, payload);
        toast("<strong>Copie envoyée</strong> · Ton professeur la recevra dans son cockpit.");
      } catch(e){
        console.error(e);
        toast("Erreur d’envoi. Vérifie la connexion puis réessaie.");
      }
    });
  }
});
</script>
</body>
</html>
