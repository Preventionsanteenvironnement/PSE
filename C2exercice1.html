<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSE Bac Pro — Compétence C2 (Exercice 1)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f1730;
      --line:rgba(255,255,255,.10);
      --txt:#eef2ff;
      --muted:#b9c5ff;
      --ok:#2bd4a6;
      --bad:#ff5a7a;
      --warn:#ffcf5a;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(92,124,255,.22), transparent 60%),
        radial-gradient(900px 600px at 82% 28%, rgba(43,212,166,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 95%, rgba(255,90,122,.14), transparent 55%),
        var(--bg);
      line-height:1.45;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .top{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ .top{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:16px;
      box-shadow:var(--shadow);
    }
    h1{margin:0 0 8px 0;font-size:22px}
    h2{margin:0 0 10px 0;font-size:18px}
    h3{margin:14px 0 8px 0;font-size:15px;color:var(--muted)}
    p{margin:8px 0;color:var(--muted)}
    .pillRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:8px 10px;border-radius:999px;
      font-size:13px;color:var(--muted);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      padding:2px 6px;border-radius:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .scoreBox{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .scoreBig{font-size:18px;font-weight:800}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;border:1px solid var(--line);min-width:180px}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg, rgba(43,212,166,.95), rgba(92,124,255,.95))}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      font-weight:750;
      transition: transform .08s ease, background .2s ease;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button:active{transform: translateY(1px)}
    .primary{background: rgba(43,212,166,.16);border-color: rgba(43,212,166,.35)}
    .danger{background: rgba(255,90,122,.14);border-color: rgba(255,90,122,.32)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    .stepRow{display:flex;gap:8px;flex-wrap:wrap}
    .step{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      padding:10px 12px;border-radius:14px;
      display:flex;gap:10px;align-items:flex-start;
      flex:1;
      min-width:210px;
    }
    .step strong{color:var(--txt)}
    .step span{color:var(--muted);font-size:13px}

    .q{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    .qHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:4px 8px;border-radius:999px
    }
    select, input[type="text"], textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .choices{display:grid;gap:10px;margin-top:8px}
    .choiceBox{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:12px;border-radius:16px;
    }
    .choiceRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .radioPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .radioPill input{margin:0}
    .small{font-size:12px;color:var(--muted)}
    .feedback{
      margin-top:10px;
      padding:10px 12px;border-radius:14px;
      border:1px dashed var(--line);
      color:var(--muted);
      display:none;
    }
    .feedback.ok{display:block;border-color:rgba(43,212,166,.45);color:rgba(214,255,244,.95);background: rgba(43,212,166,.10)}
    .feedback.bad{display:block;border-color:rgba(255,90,122,.50);color:rgba(255,220,228,.95);background: rgba(255,90,122,.10)}
    .feedback.warn{display:block;border-color:rgba(255,207,90,.55);color:rgba(255,243,210,.95);background: rgba(255,207,90,.10)}

    .drags{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.drags{grid-template-columns:1fr}}
    .bank,.zone{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.14);
      min-height:120px;
    }
    .token{
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      margin:6px 6px 0 0;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      cursor:grab;
      font-size:13px;
    }
    .token:active{cursor:grabbing}
    .bank h4,.zone h4{margin:0 0 8px 0;font-size:13px;color:var(--muted);font-weight:800}

    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.twoCols{grid-template-columns:1fr}}

    .rubric{display:grid;gap:8px;margin-top:10px}
    .rubric label{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px;border-radius:14px;
      cursor:pointer;color:var(--muted)
    }
    .rubric input{margin-top:2px}
    .mini{font-size:12px;color:var(--muted);margin-top:10px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .linkish{color:rgba(180,200,255,.95);font-weight:800}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid var(--line);
      padding:10px 12px;border-radius:14px;
      color:var(--txt);
      display:none;
      box-shadow: var(--shadow);
      max-width: calc(100% - 28px);
      z-index: 9999;
    }

    @media print{
      body{background:white;color:black}
      .wrap{padding:0}
      .btnRow, .toast{display:none !important}
      .card{box-shadow:none;border:1px solid #ccc;background:white}
      .q{background:white}
      select,input,textarea{border:1px solid #999;background:white;color:black}
      .token{border:1px solid #999;background:white;color:black}
      .pill,.tag,.kbd{border:1px solid #999;background:white;color:black}
      .feedback{display:block !important;border:1px solid #999 !important;background:white !important;color:black !important}
    }
  
.token.selected{outline:2px solid var(--accent, #7ee7d7); box-shadow:0 0 0 4px rgba(126,231,215,.15);}
.dndInfo{margin-top:10px; font-size:0.92rem; opacity:.85; line-height:1.25;}
</style>
</head>
<body>
  <div class="wrap">

    <section class="top">
      <div class="card">
        <h1>Compétence C2 — Exercice 1</h1>

        <div class="pillRow">
          <div class="pill"><span class="kbd">C2</span> Appliquer une démarche d’analyse : repérer, trier, organiser, relier</div>
          <div class="pill"><span class="kbd">Outils</span> QQOQCP • causes/conséquences • risques (gravité/probabilité)</div>
          <div class="pill"><span class="kbd">C6</span> Réponses claires : phrases + vocabulaire + connecteurs</div>
        </div>

        <div class="sep"></div>

        <h2>Méthode C2 en 5 étapes</h2>

        <div class="stepRow">
          <div class="step"><strong>1. Problème</strong><span>formuler la problématique</span></div>
          <div class="step"><strong>2. Infos</strong><span>repérer les faits utiles</span></div>
          <div class="step"><strong>3. Trier</strong><span>classer (QQOQCP)</span></div>
          <div class="step"><strong>4. Relier</strong><span>causes ↔ conséquences</span></div>
          <div class="step"><strong>5. Diagnostic</strong><span>résumer clairement</span></div>
        </div>

        <div class="q">
          <div class="qHead">
            <strong>Qualité de rédaction</strong>
            <span class="tag">C6</span>
          </div>
          <div class="hint">
            Phrases complètes<br>
            Mots précis du cours (ex : mélatonine, TMS, DUERP, risque chimique)<br>
            Connecteurs : car, donc, ainsi, en effet, par conséquent, c’est pourquoi
          </div>
        </div>

        <div class="mini">
          Deux contextes : Smartphone & TMS • Eau & risque chimique
        </div>
      </div>

      <aside class="card">
        <h2>Suivi</h2>

        <div class="scoreBox">
          <div style="min-width:220px">
            <div class="small">Élève</div>
            <input id="studentName" type="text" placeholder="Prénom" />
          </div>
          <div>
            <div class="small">Score</div>
            <div class="scoreBig"><span id="score">0</span> / <span id="maxScore">24</span></div>
          </div>
          <div style="min-width:220px">
            <div class="small">Progression</div>
            <div class="bar"><div id="barFill"></div></div>
          </div>
        </div>

        <div class="btnRow">
          <button class="primary" id="checkAll">Tout corriger</button>
          <button id="saveBtn">Sauvegarder</button>
          <button id="exportBtn">Exporter</button>
          <button id="printBtn">Imprimer</button>
          <button class="danger" id="resetBtn">Réinitialiser</button>
        </div>

        <div class="sep"></div>

        <h2>Choisir un mini-sujet</h2>
        <select id="themeSelect"></select>

        <div class="mini">
          Objectif : réussir les questions C2 en évaluation (repérer et analyser une situation)
        </div>
      </aside>
    </section>

    <section class="grid">

      <div class="card">
        <h2>Repères</h2>

        <div class="q">
          <div class="qHead">
            <strong>Différencier C2, C3, C4, C5</strong>
            <span class="tag">rapide</span>
          </div>
          <div class="hint">
            <span class="kbd">C2</span> énoncer une problématique, identifier, indiquer, préciser, évaluer, classer<br>
            <span class="kbd">C3</span> expliquer un mécanisme ou un lien cause → effet<br>
            <span class="kbd">C4</span> proposer une mesure<br>
            <span class="kbd">C5</span> choisir + argumenter
          </div>
          <div class="mini">
            Si tu repères des infos dans le dossier, c’est souvent C2
          </div>
        </div>

        <div class="q">
          <div class="qHead">
            <strong>Mini check C2</strong>
            <span class="tag">auto</span>
          </div>
          <div class="hint">
            Ai-je formulé le problème en une phrase<br>
            Ai-je listé les infos clés du dossier<br>
            Ai-je classé et relié les infos (causes/conséquences)<br>
            Ai-je écrit une conclusion courte et claire
          </div>
        </div>

      </div>

      <div class="card">
        <h2>Entraînement progressif</h2>

        <div class="q" data-q="1" data-max="6">
          <div class="qHead">
            <strong>Exercice 1</strong>
            <span class="tag">Choisir la compétence</span>
            <span class="tag">6 points</span>
          </div>

          <p>Pour chaque consigne, choisir la compétence la plus logique</p>

          <div class="choices" id="ex1"></div>

          <button class="primary" data-action="check1">Corriger</button>

          <div class="feedback" id="fb1"></div>
        </div>

        <div class="q" data-q="2" data-max="6">
          <div class="qHead">
            <strong>Exercice 2</strong>
            <span class="tag">Repérer les bonnes infos</span>
            <span class="tag">6 points</span>
          </div>

          <div id="clozeText" class="hint"></div>

          <div style="margin-top:10px;display:grid;gap:10px">
            <select id="c2a"></select>
            <select id="c2b"></select>
            <select id="c2c"></select>
          </div>

          <button class="primary" data-action="check2">Corriger</button>

          <div class="feedback" id="fb2"></div>
        </div>

        <div class="q" data-q="3" data-max="6">
          <div class="qHead">
            <strong>Exercice 3</strong>
            <span class="tag">QQOQCP (glisser-déposer)</span>
            <span class="tag">6 points</span>
          </div>

          <p class="hint">Ordinateur : glisse-dépose. Smartphone ou tablette : touche un mot pour le sélectionner, puis touche la case où le déposer.</p>
<div class="drags">
            <div class="bank" id="bank">
              <h4>Banque</h4>
            </div>

            <div style="display:grid;gap:12px">
              <div class="zone" data-accept="qui"><h4>Qui ?</h4></div>
              <div class="zone" data-accept="quoi"><h4>Quoi ?</h4></div>
              <div class="zone" data-accept="ou"><h4>Où ?</h4></div>
              <div class="zone" data-accept="quand"><h4>Quand ?</h4></div>
              <div class="zone" data-accept="comment"><h4>Comment ?</h4></div>
              <div class="zone" data-accept="pourquoi"><h4>Pourquoi ?</h4></div>
            </div>
          </div>

          <div class="btnRow">
            <button class="primary" data-action="check3">Corriger</button>
            <button data-action="reset3">Remettre</button>
          </div>

          <div class="feedback" id="fb3"></div>
        </div>

        <div class="q" data-q="4" data-max="6">
          <div class="qHead">
            <strong>Exercice 4</strong>
            <span class="tag">Analyse courte</span>
            <span class="tag">6 points</span>
          </div>

          <div class="twoCols">
            <div>
              <h3>Consigne</h3>
              <div id="prompt4" class="hint"></div>

              <div class="sep"></div>

              <textarea id="answer4" placeholder="6 à 10 lignes, phrases complètes"></textarea>

              <div class="btnRow">
                <button class="primary" data-action="check4">Valider</button>
                <button data-action="showModel">Voir le modèle</button>
                <button data-action="buildAnswer">Générer avec les blocs</button>
              </div>

              <div class="feedback" id="fb4"></div>
            </div>

            <div>
              <h3>Auto-barème</h3>

              <div class="rubric" id="rubric4">
                <label><input type="checkbox" data-pts="1"> Problème formulé en 1 phrase</label>
                <label><input type="checkbox" data-pts="1"> Au moins 4 infos pertinentes repérées</label>
                <label><input type="checkbox" data-pts="1"> Infos triées (QQOQCP ou catégories)</label>
                <label><input type="checkbox" data-pts="1"> Causes / facteurs identifiés</label>
                <label><input type="checkbox" data-pts="1"> Conséquences ou enjeux identifiés</label>
                <label><input type="checkbox" data-pts="1"> C6 : phrases + vocabulaire + connecteurs</label>
              </div>

              <div class="sep"></div>

              <h3>Blocs C2</h3>
              <div class="hint">Remplir les blocs puis générer</div>

              <div style="display:grid;gap:10px;margin-top:8px">
                <textarea id="bProb" placeholder="Problématique"></textarea>
                <textarea id="bInfos" placeholder="Infos repérées (liste courte)"></textarea>
                <textarea id="bTri" placeholder="Tri (QQOQCP / catégories)"></textarea>
                <textarea id="bCauses" placeholder="Causes / facteurs"></textarea>
                <textarea id="bCons" placeholder="Conséquences / enjeux"></textarea>
                <textarea id="bDiag" placeholder="Diagnostic (1 phrase)"></textarea>
              </div>

              <div class="q" style="margin-top:12px">
                <div class="qHead">
                  <strong>Modèle</strong>
                  <span class="tag">exemple</span>
                </div>
                <div id="model4" class="hint"></div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </section>

    <div class="toast" id="toast"></div>
  </div>

  <script>

    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    
const isTouch = (('ontouchstart' in window) || (navigator.maxTouchPoints > 0));
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));

    const themes = [
      {
        id:"smartphone_tms",
        title:"Contexte 1 — Smartphone & TMS (C2)",
        ex1:[
          {txt:"Énoncer la problématique présentée dans la situation", ans:"C2", why:"On formule le problème"},
          {txt:"Identifier trois effets de l’utilisation excessive sur la santé mentale", ans:"C2", why:"On repère des effets"},
          {txt:"Expliquer comment la lumière bleue agit sur l’endormissement", ans:"C3", why:"On explique un mécanisme"},
          {txt:"Proposer deux mesures pour améliorer le sommeil", ans:"C4", why:"On propose des mesures"},
          {txt:"Argumenter le choix d’une mesure qui te convient", ans:"C5", why:"Choix + justification"},
          {txt:"Préciser la signification du sigle TMS", ans:"C2", why:"On donne une définition courte"}
        ],
        cloze:{
          text:"Pour analyser la situation (C2), je repère que l’hormone du sommeil est ___ et que le facteur qui trouble le sommeil est ___. Je peux aussi identifier comme effet possible : ___.",
          a:{label:"Choisir l’hormone", opts:["mélatonine","adrénaline","testostérone"], ans:"mélatonine"},
          b:{label:"Choisir le facteur", opts:["lumière bleue","bruit des vagues","vitamines"], ans:"lumière bleue"},
          c:{label:"Choisir un effet", opts:["troubles du sommeil","meilleure endurance","croissance des cheveux"], ans:"troubles du sommeil"}
        },
        drag:[
          {t:"Utilisateur / élève (smartphone)", type:"qui"},
          {t:"Usage excessif du téléphone", type:"quoi"},
          {t:"À la maison (soir)", type:"ou"},
          {t:"Le soir / avant de dormir", type:"quand"},
          {t:"Écran allumé, lumière bleue", type:"comment"},
          {t:"Parce que cela perturbe le sommeil", type:"pourquoi"}
        ],
        prompt:"À partir d’un dossier sur le smartphone et le sommeil, réaliser une analyse C2 : problématique + 4 infos du dossier + 1 diagnostic.",
        model:"Problématique : l’usage excessif du smartphone met-il en danger la santé (sommeil et santé mentale) ? Infos : l’hormone du sommeil est la mélatonine ; la lumière bleue est un facteur qui trouble le sommeil ; l’utilisation excessive peut entraîner stress/angoisse et troubles du sommeil ; certains salariés peuvent développer des TMS (ex : canal carpien). Diagnostic : il existe un risque réel pour le sommeil et la santé, il faut identifier les facteurs et les conséquences avant de proposer des solutions."
      },
      {
        id:"eau_chimique",
        title:"Contexte 2 — Eau & risque chimique (C2)",
        ex1:[
          {txt:"Énoncer la problématique présentée dans la situation", ans:"C2", why:"On formule le problème"},
          {txt:"Préciser l’objectif du site rappel.conso.gouv", ans:"C2", why:"On repère une information"},
          {txt:"Expliquer l’intérêt de traiter l’eau avant distribution", ans:"C3", why:"Mécanisme/enjeu"},
          {txt:"Indiquer les étapes à suivre après un message de rappel", ans:"C2", why:"Procédure à repérer"},
          {txt:"Proposer des mesures pour réduire la consommation d’eau", ans:"C4", why:"Proposer"},
          {txt:"Évaluer la probabilité du dommage sur DUERP", ans:"C2", why:"Évaluer avec une échelle"}
        ],
        cloze:{
          text:"Dans une analyse C2, je repère que le site ___ sert à ___. Si j’ai des bouteilles rappelées, je dois d’abord ___ puis ne pas ingérer et rapporter/détruire.",
          a:{label:"Choisir le site", opts:["rappel.conso.gouv","meteo.fr","ameli.fr"], ans:"rappel.conso.gouv"},
          b:{label:"Choisir l’objectif", opts:["informer rapidement sur les rappels de produits dangereux","vendre des bouteilles","donner des recettes"], ans:"informer rapidement sur les rappels de produits dangereux"},
          c:{label:"Choisir la 1re étape", opts:["vérifier le numéro de lot et la date","boire pour tester","jeter sans vérifier"], ans:"vérifier le numéro de lot et la date"}
        },
        drag:[
          {t:"Consommateur / conducteur", type:"qui"},
          {t:"Rappel de bouteilles / risque chimique", type:"quoi"},
          {t:"Magasin / entreprise", type:"ou"},
          {t:"Après le message / après l’accident", type:"quand"},
          {t:"Vérifier lot puis appeler/alerter SST", type:"comment"},
          {t:"Parce que le produit peut être dangereux", type:"pourquoi"}
        ],
        prompt:"À partir d’un dossier sur un rappel d’eau et un risque chimique, analyser la situation (C2) : problématique + 4 infos pertinentes + tri QQOQCP + diagnostic.",
        model:"Problématique : que doit faire un consommateur face à un rappel de bouteilles d’eau et quels risques sont en jeu ? Infos : le site rappel.conso.gouv informe sur les rappels ; il faut vérifier numéro de lot et date ; si concerné, ne pas ingérer et rapporter/détruire ; si déjà bu, appeler le numéro de renseignement ; en entreprise, le risque évoqué peut être chimique et le DUERP permet d’évaluer gravité/probabilité. Diagnostic : l’analyse des faits et des procédures permet de prendre la bonne décision et de limiter les risques pour la santé."
      }
    ];

    const state = {
      points:{1:0,2:0,3:0,4:0},
      max:{1:6,2:6,3:6,4:6},
      themeId: themes[0].id
    };

    function totalScore(){ return Object.values(state.points).reduce((a,b)=>a+b,0); }
    function maxScore(){ return Object.values(state.max).reduce((a,b)=>a+b,0); }

    function renderScore(){
      $("#score").textContent = totalScore();
      $("#maxScore").textContent = maxScore();
      const pct = (totalScore()/maxScore())*100;
      $("#barFill").style.width = clamp(pct,0,100).toFixed(0) + "%";
    }

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._id);
      toast._id = setTimeout(()=>t.style.display="none", 1700);
    }

    function setFeedback(id, kind, html){
      const el = $(id);
      el.className = "feedback " + kind;
      el.style.display = "block";
      el.innerHTML = html;
    }

    function currentTheme(){
      return themes.find(t=>t.id===state.themeId) || themes[0];
    }

    function fillThemes(){
      const sel = $("#themeSelect");
      sel.innerHTML = themes.map(t=>`<option value="${t.id}">${t.title}</option>`).join("");
      sel.value = state.themeId;
      sel.addEventListener("change", ()=>{
        state.themeId = sel.value;
        buildAll();
        toast("Mini-sujet changé");
        saveLocal();
      });
    }

    function makeRadio(name, value, label){
      const id = `${name}_${value}`;
      return `
        <label class="radioPill" for="${id}">
          <input id="${id}" type="radio" name="${name}" value="${value}">
          <span class="kbd">${label}</span>
        </label>
      `;
    }

    function buildEx1(){
      const t = currentTheme();
      const wrap = $("#ex1");
      wrap.innerHTML = "";

      t.ex1.forEach((item, idx)=>{
        const qId = `ex1_${idx}`;
        const block = document.createElement("div");
        block.className = "choiceBox";
        block.innerHTML = `
          <div style="font-weight:900">${idx+1}. ${item.txt}</div>
          <div class="small" style="margin-top:6px">Indice : ${item.why}</div>
          <div class="choiceRow" role="group" aria-label="Choix de compétence">
            ${makeRadio(qId,"C2","C2")}
            ${makeRadio(qId,"C3","C3")}
            ${makeRadio(qId,"C4","C4")}
            ${makeRadio(qId,"C5","C5")}
          </div>
          <div class="small">Choix : <span class="kbd">C2</span> <span class="kbd">C3</span> <span class="kbd">C4</span> <span class="kbd">C5</span></div>
        `;
        wrap.appendChild(block);
      });
    }

    function check1(){
      const t = currentTheme();
      let pts = 0;
      let wrong = [];
      t.ex1.forEach((item, idx)=>{
        const qId = `ex1_${idx}`;
        const picked = ($$(`input[name="${qId}"]:checked`)[0] || {}).value || "";
        if(picked === item.ans) pts += 1;
        else wrong.push(idx+1);
      });
      state.points[1] = pts;
      if(pts === 6){
        setFeedback("#fb1","ok",`✅ ${pts}/6. Bonne lecture des consignes.`);
      }else{
        setFeedback("#fb1","warn",`⚠️ ${pts}/6. À revoir : item(s) ${wrong.join(", ")}. Astuce : identifier/indiquer/évaluer = C2 ; expliquer = C3 ; proposer = C4 ; argumenter = C5.`);
      }
      renderScore();
      saveLocal();
    }

    function buildCloze(){
      const t = currentTheme();
      $("#clozeText").innerHTML = t.cloze.text.replaceAll("___", `<span class="kbd">…</span>`);
      const a = $("#c2a"), b = $("#c2b"), c = $("#c2c");
      a.innerHTML = `<option value="">${t.cloze.a.label}</option>` + t.cloze.a.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      b.innerHTML = `<option value="">${t.cloze.b.label}</option>` + t.cloze.b.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      c.innerHTML = `<option value="">${t.cloze.c.label}</option>` + t.cloze.c.opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      a.value=""; b.value=""; c.value="";
    }

    function check2(){
      const t = currentTheme();
      let pts = 0;
      if($("#c2a").value === t.cloze.a.ans) pts += 2;
      if($("#c2b").value === t.cloze.b.ans) pts += 2;
      if($("#c2c").value === t.cloze.c.ans) pts += 2;
      state.points[2] = pts;

      if(pts === 6){
        setFeedback("#fb2","ok","✅ 6/6. Bon repérage des informations.");
      }else{
        setFeedback("#fb2","bad",`❌ ${pts}/6. Reviens au dossier : C2 = repérer l’info exacte (mot précis).`);
      }
      renderScore();
      saveLocal();
    }

    let dragItem = null;

    function enableDnD(){
      document.addEventListener("dragstart", e=>{
        if(e.target.classList && e.target.classList.contains("token")){
          dragItem = e.target;
          setTimeout(()=>dragItem.style.opacity=".55",0);
        }
      });
      document.addEventListener("dragend", ()=>{
        if(dragItem){
          dragItem.style.opacity="1";
          dragItem = null;
        }
      });

      $$(".zone, #bank").forEach(z=>{
        z.addEventListener("dragover", e=>e.preventDefault());
        z.addEventListener("drop", e=>{
          e.preventDefault();
          if(!dragItem) return;
          z.appendChild(dragItem);
        });
      });
    }

function enableTouchPickPlace(){
  // Mode mobile : toucher pour sélectionner, toucher une zone pour déposer
  const bank = $("#bank");
  let selected = null;

  const toast = (msg)=>{
    const t = $("#toast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>t.classList.remove("show"), 1200);
  };

  const clearSel = ()=>{
    if(selected){
      selected.classList.remove("selected");
      selected = null;
    }
  };

  document.addEventListener("pointerdown", (e)=>{
    if(!isTouch) return;

    const tok = e.target.closest(".token");
    const drop = e.target.closest(".zone, #bank");

    if(tok){
      e.preventDefault();
      if(selected === tok){
        bank.appendChild(tok);
        clearSel();
        toast("Mot remis dans la banque");
      }else{
        clearSel();
        selected = tok;
        tok.classList.add("selected");
        toast("Mot sélectionné");
      }
      return;
    }

    if(drop && selected){
      e.preventDefault();
      drop.appendChild(selected);
      clearSel();
      toast("Déposé");
      return;
    }

    // Tap ailleurs : on annule la sélection
    if(selected) clearSel();
  }, {passive:false});
}



    function buildDrag(){
      const t = currentTheme();
      const bank = $("#bank");
      bank.innerHTML = "<h4>Banque</h4>";
      t.drag.forEach((item)=>{
        const d = document.createElement("div");
        d.className = "token";
        d.draggable = !isTouch;
        d.dataset.type = item.type;
        d.textContent = item.t;
        bank.appendChild(d);
      });

      $$(".zone").forEach(z=>{
        $$(".token", z).forEach(tok=>bank.appendChild(tok));
      });
    }

    function reset3(){
      const bank = $("#bank");
      $$(".zone .token").forEach(t=>bank.appendChild(t));
      state.points[3] = 0;
      setFeedback("#fb3","warn","Remis à zéro.");
      renderScore();
      saveLocal();
    }

    function check3(){
      let pts = 0;
      let wrong = [];
      $$(".zone").forEach(z=>{
        const accept = z.dataset.accept;
        $$(".token", z).forEach(tok=>{
          if(tok.dataset.type === accept) pts += 1;
          else wrong.push(tok.textContent.trim());
        });
      });

      state.points[3] = clamp(pts,0,6);

      if(state.points[3] === 6){
        setFeedback("#fb3","ok","✅ 6/6. QQOQCP maîtrisé.");
      }else{
        const ex = wrong.slice(0,4).map(s=>`• ${s}`).join("<br>");
        setFeedback("#fb3","warn",`⚠️ ${state.points[3]}/6. À replacer :<br>${ex}${wrong.length>4?"<br>• …":""}`);
      }
      renderScore();
      saveLocal();
    }

    function buildEx4(){
      const t = currentTheme();
      $("#prompt4").innerHTML = `<span class="linkish">${t.title}</span><br><br>${t.prompt}`;
      $("#model4").textContent = t.model;

      $("#answer4").value = "";
      $$("#rubric4 input").forEach(cb=>cb.checked=false);
      $("#bProb").value=""; $("#bInfos").value=""; $("#bTri").value=""; $("#bCauses").value=""; $("#bCons").value=""; $("#bDiag").value="";
    }

    function check4(){
      const text = $("#answer4").value.trim();
      let pts = 0;

      $$("#rubric4 input[type='checkbox']").forEach(cb=>{
        if(cb.checked) pts += Number(cb.dataset.pts || 0);
      });

      if(text.length < 220){
        pts = Math.min(pts, 3);
        setFeedback("#fb4","warn",`⚠️ ${pts}/6. Réponse trop courte. Vise 8 à 12 lignes, avec tri et diagnostic.`);
      }else{
        if(pts >= 5) setFeedback("#fb4","ok",`✅ ${pts}/6. Analyse C2 solide.`);
        else if(pts >= 3) setFeedback("#fb4","warn",`⚠️ ${pts}/6. Ajoute tri (QQOQCP) + diagnostic final.`);
        else setFeedback("#fb4","bad",`❌ ${pts}/6. Reprends la méthode : problème → infos → tri → causes/conséquences → diagnostic.`);
      }

      state.points[4] = clamp(pts,0,6);
      renderScore();
      saveLocal();
    }

    function showModel(){
      $("#model4").parentElement.scrollIntoView({behavior:"smooth", block:"start"});
      toast("Modèle visible");
    }

    function buildAnswerFromBlocks(){
      const parts = [];
      const p = $("#bProb").value.trim();
      const i = $("#bInfos").value.trim();
      const t = $("#bTri").value.trim();
      const c = $("#bCauses").value.trim();
      const k = $("#bCons").value.trim();
      const d = $("#bDiag").value.trim();

      if(p) parts.push("Problématique : " + p);
      if(i) parts.push("Infos : " + i);
      if(t) parts.push("Tri : " + t);
      if(c) parts.push("Causes/facteurs : " + c);
      if(k) parts.push("Conséquences/enjeux : " + k);
      if(d) parts.push("Diagnostic : " + d);

      const built = parts.join("
");
      if(built.replaceAll("
","").length < 10){
        toast("Remplir au moins un bloc");
        return;
      }
      $("#answer4").value = built;
      toast("Réponse générée");
      saveLocal();
    }

    function checkAll(){
      check1();
      check2();
      check3();
      check4();
      const pct = Math.round((totalScore()/maxScore())*100);
      if(pct >= 85) toast("Bravo");
      else if(pct >= 60) toast("Bien");
      else toast("À reprendre");
    }

    function resetAll(){
      state.points = {1:0,2:0,3:0,4:0};

      currentTheme().ex1.forEach((_, idx)=>{
        const qId = `ex1_${idx}`;
        $$(`input[name="${qId}"]`).forEach(r=>r.checked=false);
      });

      $("#c2a").value = ""; $("#c2b").value = ""; $("#c2c").value = "";

      reset3();

      $("#answer4").value = "";
      $$("#rubric4 input").forEach(cb=>cb.checked=false);
      $("#bProb").value=""; $("#bInfos").value=""; $("#bTri").value=""; $("#bCauses").value=""; $("#bCons").value=""; $("#bDiag").value="";

      ["#fb1","#fb2","#fb3","#fb4"].forEach(id=>{
        const el = $(id);
        el.className = "feedback";
        el.style.display = "none";
        el.textContent = "";
      });

      renderScore();
      saveLocal();
      toast("Réinitialisé");
    }

    const LS_KEY = "pse_c2_ex1_2024_file1";

    function saveLocal(){
      const payload = {
        themeId: state.themeId,
        points: state.points,
        studentName: $("#studentName").value || "",
        inputs: {
          c2a: $("#c2a").value,
          c2b: $("#c2b").value,
          c2c: $("#c2c").value,
          answer4: $("#answer4").value,
          rubric4: $$("#rubric4 input").map(cb=>cb.checked),
          blocks: {
            bProb: $("#bProb").value,
            bInfos: $("#bInfos").value,
            bTri: $("#bTri").value,
            bCauses: $("#bCauses").value,
            bCons: $("#bCons").value,
            bDiag: $("#bDiag").value
          },
          ex1: currentTheme().ex1.map((_, idx)=>{
            const qId = `ex1_${idx}`;
            const picked = ($$(`input[name="${qId}"]:checked`)[0] || {}).value || "";
            return picked;
          })
        }
      };
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
    }

    function restoreLocal(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try{
        const payload = JSON.parse(raw);
        if(payload.themeId) state.themeId = payload.themeId;
        if(payload.studentName) $("#studentName").value = payload.studentName;

        $("#themeSelect").value = state.themeId;
        buildAll(false);

        const ex1 = payload.inputs?.ex1 || [];
        ex1.forEach((val, idx)=>{
          const qId = `ex1_${idx}`;
          if(val) {
            const r = $(`input[name="${qId}"][value="${val}"]`);
            if(r) r.checked = true;
          }
        });

        if(payload.inputs?.c2a) $("#c2a").value = payload.inputs.c2a;
        if(payload.inputs?.c2b) $("#c2b").value = payload.inputs.c2b;
        if(payload.inputs?.c2c) $("#c2c").value = payload.inputs.c2c;

        if(payload.inputs?.answer4) $("#answer4").value = payload.inputs.answer4;
        const rb = payload.inputs?.rubric4 || [];
        $$("#rubric4 input").forEach((cb,i)=>cb.checked = !!rb[i]);

        const blocks = payload.inputs?.blocks || {};
        $("#bProb").value = blocks.bProb || "";
        $("#bInfos").value = blocks.bInfos || "";
        $("#bTri").value = blocks.bTri || "";
        $("#bCauses").value = blocks.bCauses || "";
        $("#bCons").value = blocks.bCons || "";
        $("#bDiag").value = blocks.bDiag || "";

        if(payload.points) state.points = payload.points;
        renderScore();
      }catch(e){}
    }

    async function exportAll(){
      const name = ($("#studentName").value || "eleve").trim().replaceAll(" ","_");
      const t = currentTheme();
      const data = {
        student: name,
        theme: t.title,
        score: {got: totalScore(), max: maxScore()},
        answer: $("#answer4").value || "",
        timestamp: new Date().toISOString()
      };
      const txt = JSON.stringify(data, null, 2);
      try{
        await navigator.clipboard.writeText(txt);
        toast("Export copié");
      }catch(e){
        toast("Copie impossible");
      }
    }

    function buildAll(resetEx4=true){
      buildEx1();
      buildCloze();
      buildDrag();
      if(resetEx4) buildEx4();
      renderScore();
    }

    document.addEventListener("click", e=>{
      const a = e.target?.dataset?.action;
      if(!a) return;
      if(a==="check1") check1();
      if(a==="check2") check2();
      if(a==="check3") check3();
      if(a==="reset3") reset3();
      if(a==="check4") check4();
      if(a==="showModel") showModel();
      if(a==="buildAnswer") buildAnswerFromBlocks();
    });

    $("#checkAll").addEventListener("click", checkAll);
    $("#resetBtn").addEventListener("click", resetAll);
    $("#saveBtn").addEventListener("click", ()=>{ saveLocal(); toast("Sauvegardé"); });
    $("#exportBtn").addEventListener("click", exportAll);
    $("#printBtn").addEventListener("click", ()=>window.print());
    $("#studentName").addEventListener("input", saveLocal);

    fillThemes();
    buildAll();
    enableDnD();
  if(isTouch) enableTouchPickPlace();
    restoreLocal();
    renderScore();
  
</script>
</body>
</html>
