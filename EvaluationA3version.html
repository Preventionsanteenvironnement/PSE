<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ÉVALUATION – ACTIVITÉ PHYSIQUE – MODULE A3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* STYLES IDENTIQUES À LA VERSION PRÉCÉDENTE */
    body{ font-family: Arial, sans-serif; margin:0; padding:0; color:#000; line-height:1.5; background:#fff; }
    .container{ width:100%; max-width:none; padding:0 1cm; box-sizing:border-box; }
    header{ border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:15px; text-align: center; }
    h1{ font-size:1.6em; margin:0; text-transform:uppercase; }
    .identite{ display:flex; justify-content:space-between; margin-top:10px; font-weight:bold; gap:10px; flex-wrap:wrap; }
    .competences{ font-size:0.85em; margin-top:8px; text-align: left; }
    .section-title{ font-weight:bold; margin:20px 0 5px; font-size:1.1em; }
    .situation{ display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap; }
    .situation img{ width:120px; max-width:100%; }
    
    /* GESTION DU GRAS */
    .question{ margin-bottom:18px; font-weight: normal; }
    .q-text, .question div, .question span { font-weight: normal; }
    strong { font-weight: bold; }
    .q-head{ margin-bottom:5px; font-weight: normal; }
    .q-comp{ font-size:0.85em; margin-left:8px; color:#333; font-weight: bold; }
    
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th, td{ border:1px solid #000; padding:8px; vertical-align:top; }
    th{ width:30%; background:#eee; }
    
    textarea{ width:100%; min-height:60px; resize:vertical; box-sizing:border-box; font-family:inherit; font-size:1em; padding:6px; border: 1px solid #999; }
    
    .doc{ margin-top:20px; }
    .doc-title{ font-weight:bold; margin-bottom:5px; }
    .doc img{ max-width:70%; display:block; }
    .doc-source{ font-size:0.7em; color:#555; margin-bottom:10px; }
    
    .actions{ position:fixed; bottom:15px; right:15px; display:flex; gap:8px; z-index:1000; }
    .btn{ padding:10px 12px; border:1px solid #000; background:#fff; cursor:pointer; font-weight:bold; font-size:0.9em; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
    .btn:hover { background-color: #f0f0f0; }
    #sendBtn { background-color: #2c3e50; color: white; border: none; }

    @media print{ .actions{ display:none; } .container{ padding:0; } }
  </style>
</head>

<body>
<div class="container">

<header>
  <h1>Évaluation – Activité physique – Module A3</h1>

  <div class="identite">
    <div>
      Nom : <input type="text" id="nom">  
      Prénom : <input type="text" id="prenom">  
      Classe : <input type="text" id="classe">  
      Date : <input type="date" id="date">
    </div>
    <div>Note : / 20</div>
  </div>

  <div class="competences">
    Évaluation par compétences :<br>
    C2 – Appliquer une démarche d’analyse dans une situation donnée<br>
    C3 – Expliquer un phénomène physiologique ou un enjeu de santé<br>
    C4 – Proposer une solution adaptée<br>
    C5 – Argumenter un choix lié à la prévention
  </div>
</header>

<div class="section-title">SITUATION</div>
<div class="situation">
  <div>
    En France, de nombreux adolescents en formation professionnelle passent une grande partie
    de leur temps libre devant les écrans. En dehors des cours et de l’EPS, ils pratiquent peu
    d’activité physique. Cette sédentarité élevée peut avoir des conséquences sur leur santé
    physique, mentale et sociale. Les autorités de santé rappellent l’importance de bouger
    régulièrement pour préserver son capital santé.
  </div>
  <img src="situation.jpg" alt="">
</div>

<div class="question">
  <div class="q-head">1. <strong>Analyser</strong> la situation en complétant le tableau d’analyse (QQOQCP) <span class="q-comp">(C2)</span></div>
  <table>
    <tr><th>QUI</th><td><textarea id="q1_qui"></textarea></td></tr>
    <tr><th>QUOI</th><td><textarea id="q1_quoi"></textarea></td></tr>
    <tr><th>OÙ</th><td><textarea id="q1_ou"></textarea></td></tr>
    <tr><th>POURQUOI</th><td><textarea id="q1_pourquoi"></textarea></td></tr>
  </table>
</div>

<div class="question">
  <div class="q-head">2. À l’aide de vos connaissances, <strong>expliquer</strong> ce que signifie la sédentarité <span class="q-comp">(C3)</span></div>
  <textarea id="q2"></textarea>
</div>

<div class="doc">
  <div class="doc-title">Document 1 : Le trajet de l’information nerveuse pour réaliser un mouvement</div>
  <img src="lemouvement.jpg" alt="">
  <div class="doc-source">Source : Éditions FOUCHER</div>
</div>

<div class="question">
  <div class="q-head">3. À l’aide du document 1</div>
  3.1 <strong>Repérer</strong> l’organe qui commande le mouvement <span class="q-comp">(C2)</span>  
  <textarea id="q3_1"></textarea>

  3.2 <strong>Décrire</strong> le trajet du message nerveux du cerveau jusqu’au muscle <span class="q-comp">(C2)</span>  
  <textarea id="q3_2"></textarea>
</div>

<div class="doc">
  <div class="doc-title">Document 2 : L’anatomie du muscle et la contraction musculaire</div>
  <img src="muscle s.jpg" alt="">
  <div class="doc-source">Source : Éditions FOUCHER</div>
</div>

<div class="question">
  <div class="q-head">4. À l’aide du document 2, <strong>expliquer</strong> comment le muscle se contracte <span class="q-comp">(C3)</span></div>
  <textarea id="q4"></textarea>
</div>

<div class="doc">
  <div class="doc-title">Document 3 : Les échanges entre le sang et les muscles</div>
  <img src="Le mecanisme_du travail_musculaire.jpg" alt="">
  <div class="doc-source">Source : Éditions FOUCHER</div>
</div>

<div class="question">
  <div class="q-head">5. À l’aide du document 3</div>
  5.1 <strong>Citer</strong> les deux éléments nécessaires au fonctionnement du muscle <span class="q-comp">(C2)</span>  
  <textarea id="q5_1"></textarea>

  5.2 <strong>Expliquer</strong> pourquoi le muscle consomme du dioxygène lors de l’activité <span class="q-comp">(C3)</span>  
  <textarea id="q5_2"></textarea>

  5.3 <strong>Identifier</strong> le déchet rejeté par le muscle <span class="q-comp">(C2)</span>  
  <textarea id="q5_3"></textarea>
</div>

<div class="doc">
  <div class="doc-title">Document 4 : Activité physique et santé</div>
  <img src="Lactivitephysiquerecommandeeparjour.jpg" alt="">
</div>

<div class="question">
  <div class="q-head">6. À l’aide du document 4</div>
  6.1 <strong>Indiquer</strong> la recommandation de l’OMS pour un adolescent <span class="q-comp">(C2)</span>  
  <textarea id="q6_1"></textarea>

  6.2 <strong>Justifier</strong> en quoi l’activité physique est une mesure de prévention pour la santé <span class="q-comp">(C5)</span>  
  <textarea id="q6_2"></textarea>
</div>

<div class="question">
  <div class="q-head">7. <strong>Proposer</strong> deux activités physiques simples permettant de respecter cette recommandation <span class="q-comp">(C4)</span></div>
  <textarea id="q7"></textarea>
</div>

</div>

<div class="actions">
  <button class="btn" onclick="window.print()">Imprimer PDF</button>
  <button class="btn" id="downloadJsonBtn">Enregistrer JSON</button>
  <button class="btn" id="sendBtn">Envoyer</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJJn3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.firebasestorage.app",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55",
    measurementId: "G-7R9N0JL6GG"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function validerIdentite(data){
    if(!data.nom || !data.prenom || !data.classe){
      alert("Merci de compléter Nom, Prénom et Classe avant d'envoyer.");
      return false;
    }
    return true;
  }

  // MODIFICATION : Nouvelle fonction getDataPayload
  // Format harmonisé avec le Devoir 1 (reponses objet + meta data)
  function getDataPayload(){
    const nom = document.getElementById("nom").value.trim();
    const prenom = document.getElementById("prenom").value.trim();
    const classe = document.getElementById("classe").value.trim();

    const reponsesObj = {};
    Array.from(document.querySelectorAll("textarea")).forEach((t, i) => {
      // Les clés seront "1", "2", "3"... correspondant à l'ordre des textareas
      reponsesObj[String(i + 1)] = (t.value || "").trim();
    });

    return {
      type: "copie_eleve_pse", // Type harmonisé
      nom,
      prenom,
      classe,
      reponses: reponsesObj,
      meta: {
        createdAt: new Date().toISOString(),
        competences: ["C2","C3","C4","C5"],
        score: null,
        maxScore: null,
        bareme: "",
        details: {}
      }
    };
  }

  async function envoyerCopie(){
    const data = getDataPayload();
    if(!validerIdentite(data)) return;

    const btn = document.getElementById("sendBtn");
    const texteOriginal = btn.textContent;
    btn.textContent = "Envoi...";
    btn.disabled = true;

    try {
      await addDoc(collection(db, "bacpro"), data);
      alert("Confirmation : Votre devoir a bien été envoyé.");
      btn.textContent = "Envoyé";
    } catch (e) {
      console.error(e);
      alert("Erreur technique lors de l'envoi.");
      btn.textContent = texteOriginal;
      btn.disabled = false;
    }
  }

  // MODIFICATION : telechargerJSON sauvegarde maintenant tout le payload
  function telechargerJSON(){
    const data = getDataPayload();
    if(!validerIdentite(data)) return;

    // Sauvegarde complète pour cohérence maximale
    const structureGrille = data;

    const blob = new Blob([JSON.stringify(structureGrille, null, 2)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const safeName = (str) => str ? str.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'copie';
    a.download = `eval_A3_${safeName(data.classe)}_${safeName(data.nom)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  document.getElementById("sendBtn").addEventListener("click", envoyerCopie);
  document.getElementById("downloadJsonBtn").addEventListener("click", telechargerJSON);

</script>

</body>
</html>
