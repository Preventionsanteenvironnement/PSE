<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>QQOQCP ‚Äì Entra√Ænement Bac Pro (Final V4)</title>
<style>
  :root{
    --bg:#0f172a; --text:#f1f5f9; --muted:#94a3b8; 
    --line:rgba(255,255,255,.12);
    --c1:#8b5cf6; --c2:#3b82f6; --c3:#06b6d4; --c4:#10b981; --c5:#f59e0b; --err:#ef4444;
    --shadow:0 12px 30px rgba(0,0,0,.45); --radius:20px;
    --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:var(--font-ui); color:var(--text);
    background:var(--bg); padding:16px; padding-bottom:120px;
    background-image: 
      radial-gradient(at 0% 0%, rgba(139,92,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 0%, rgba(59,130,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 100%, rgba(16,185,129,0.1) 0px, transparent 50%);
    background-attachment: fixed;
    overflow-x:hidden;
  }
  
  .wrap{max-width:800px; margin:0 auto; display:grid; gap:20px}
  
  /* --- Header & HUD --- */
  .header{ display:flex; flex-wrap:wrap; gap:16px; align-items:stretch; }
  .hero{
    flex:1 1 100%; border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(255,255,255,.03); backdrop-filter:blur(10px);
    padding:20px; box-shadow:var(--shadow); position:relative; overflow:hidden;
  }
  .hero h1{margin:0 0 8px 0; font-size:1.4rem; background:linear-gradient(90deg, #fff, #cbd5e1); -webkit-background-clip:text; -webkit-text-fill-color: transparent;}
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
  .chip{
    padding:6px 12px; border-radius:99px; font-size:0.75rem; font-weight:700;
    border:1px solid var(--line); background:rgba(255,255,255,.05); display:flex; align-items:center; gap:6px;
  }
  
  .hud-strip {
    display:flex; justify-content: space-between; align-items: center;
    background: rgba(15, 23, 42, 0.8); border: 1px solid var(--line);
    padding: 10px 20px; border-radius: 99px; font-weight: 700; font-size: 0.9rem;
    backdrop-filter: blur(5px);
  }
  .progress-track{ width:100px; height:8px; background:rgba(255,255,255,.1); border-radius:99px; overflow:hidden; margin:0 10px; }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--c1), var(--c3)); transition:width 0.5s ease; }

  /* --- LOGIN MODAL --- */
  #loginOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(11, 18, 32, 0.85); backdrop-filter: blur(8px);
    z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .login-card {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
    border: 1px solid rgba(255,255,255,0.15); border-radius: 24px;
    padding: 30px; width: 100%; max-width: 400px; text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transform: translateY(0); animation: floatUp 0.5s ease-out;
  }
  @keyframes floatUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
  
  .login-avatar {
    width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
    border: 3px solid var(--c2); margin-bottom: 20px;
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
  }
  
  /* --- Inputs & Buttons --- */
  input[type="text"], textarea{
    background:rgba(0,0,0,.3); border:1px solid var(--line); color:white;
    padding:14px; border-radius:12px; outline:none; font-family:inherit; font-weight:500; font-size:1rem;
    width: 100%; transition:0.2s;
  }
  input[type="text"]:focus, textarea:focus{ border-color:var(--c3); box-shadow:0 0 0 3px rgba(6,182,212,.2); }
  
  textarea { min-height: 120px; resize: vertical; line-height: 1.5; }

  .btn{
    border:none; padding:14px 24px; border-radius:12px; font-weight:700; cursor:pointer;
    font-family:inherit; font-size:1rem; transition:all 0.2s; 
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
  }
  .btn-primary{ background:linear-gradient(135deg, var(--c2), var(--c1)); color:white; width:100%; }
  .btn-primary:active{ transform:scale(0.98); }
  
  .btn-check{ background: var(--c3); color: #0f172a; width: auto; margin-left: auto; }
  .btn-success{ background:linear-gradient(135deg, var(--c4), #059669); color:#022c22; flex:1;}
  .btn-danger{ background:rgba(239,68,68,0.2); border:1px solid var(--err); color:#fca5a5; flex:1;}

  /* --- Question Card --- */
  .card{
    border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(30,41,59,.6); padding:20px; box-shadow:var(--shadow);
    transition: transform 0.2s;
  }
  
  .stepper{display:flex; gap:6px; margin-bottom:16px}
  .step{ width:30px; height:6px; border-radius:4px; background:rgba(255,255,255,.1); transition:0.3s; }
  .step.active{ background:var(--c3); box-shadow:0 0 10px var(--c3); }
  .step.done{ background:var(--c4); }

  .q-tag{
    display:inline-flex; align-items:center; gap:8px; padding:6px 12px;
    border-radius:99px; background:rgba(6,182,212,.1); color:var(--c3);
    font-weight:800; font-size:0.8rem; margin-bottom:12px; border:1px solid rgba(6,182,212,.2);
  }

  .situation-box{
    background:rgba(0,0,0,.2); border-radius:16px; padding:16px; border:1px solid var(--line);
    margin-bottom:16px; display:grid; gap:16px;
  }
  @media(min-width:600px){ .situation-box{grid-template-columns: 2fr 1fr;} }
  
  /* --- CORRECTION TEXTE (Prend tout l'espace) --- */
  .sit-text{ 
    line-height:1.6; font-size:0.95rem; 
    white-space: normal; /* Remplit l'espace sans coupures */
    text-align: justify;
  }
  .sit-img{
    width:100%; height:200px; object-fit:cover; border-radius:12px; 
    border:1px solid var(--line); background:#000;
  }

  .prompt{
    font-size:1.1rem; font-weight:700; margin-bottom:16px; display:flex; gap:12px; align-items:start;
    background:rgba(255,255,255,.03); padding:16px; border-radius:16px; border-left:4px solid var(--c5);
  }

  /* Correction Panel */
  .correction-box {
    margin-top:20px; padding:20px; border-radius:16px; background:rgba(16,185,129,0.05);
    border:1px solid rgba(16,185,129,0.3); display:none; animation: slideDown 0.4s ease;
  }
  .model-answer { font-weight:700; color:#6ee7b7; margin-bottom:10px; font-size:1.05rem; }
  .keywords-list { font-size:0.9rem; color:var(--muted); margin-bottom:16px; }
  .redac-tip { 
    background:rgba(245,158,11,0.1); border-left:3px solid var(--c5); padding:10px; 
    font-size:0.85rem; color:#fcd34d; margin-bottom:20px; border-radius:4px;
  }
  .eval-buttons { display:flex; gap:12px; margin-top: 10px; }

  /* --- FLOATING COACH SYSTEM --- */
  #floatCoach {
    position: fixed; bottom: 20px; right: 20px; z-index: 1000;
    display: flex; flex-direction: column; align-items: flex-end;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4));
  }
  
  #floatAvatar {
    width: 70px; height: 70px; border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.2);
    object-fit: cover; background: #1e293b;
    cursor: pointer; transition: transform 0.2s;
  }
  #floatAvatar:active { transform: scale(0.95); }

  #floatBubble {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.99));
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff; padding: 16px; border-radius: 20px 20px 4px 20px;
    margin-bottom: 12px; max-width: 300px; width: 85vw;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-size: 0.95rem; line-height: 1.5;
  }
  
  /* Mode "Typing" : Le coach se fait discret MAIS RESTE EN COULEUR */
  body.typing-mode #floatBubble {
    opacity: 0; transform: translateY(20px) scale(0.8); pointer-events: none;
  }
  body.typing-mode #floatCoach {
    opacity: 0.3; transform: scale(0.7) translate(20px, 20px); 
    /* CORRECTION : Suppression du filtre grayscale pour garder la couleur */
  }

  /* Animations & Misc */
  @keyframes slideDown{ from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
  @keyframes popIn { from{opacity:0; transform:scale(0.8) translateY(10px)} to{opacity:1; transform:scale(1) translateY(0)} }
  .pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes pop { 0%{transform:scale(0.9)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }

  #confetti{ position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }
  #finalScreen{ text-align:center; padding:40px 20px; display:none; }
  .big-score{ font-size:3rem; font-weight:900; margin:10px 0; background:linear-gradient(to right, var(--c4), var(--c3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div id="loginOverlay">
  <div class="login-card">
    <img src="avatar-neutral.png" alt="Coach" class="login-avatar" id="startAvatar">
    <h2 style="margin-top:0">Bienvenue !</h2>
    <p style="color:var(--muted); margin-bottom:20px">Je suis votre coach. On va s'entra√Æner √† r√©diger ensemble.</p>
    <div style="text-align:center; margin-bottom:15px">
      <div id="display-pseudo" style="font-size:1.3rem; font-weight:bold; color:var(--accent)"></div>
    </div>
    <button class="btn btn-primary" id="startBtn">Commencer l'entra√Ænement</button>
  </div>
</div>

<div id="floatCoach" style="display:none">
  <div id="floatBubble">Bonjour ! Pr√™t √† commencer ?</div>
  <img id="floatAvatar" src="avatar-neutral.png" alt="Coach">
</div>

<div class="wrap">
  
  <div class="header">
    <div class="hero">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h1>QQOQCP ‚Äì Bac Pro</h1>
        <button class="btn" style="padding:6px 12px; font-size:0.8rem; background:rgba(255,255,255,0.1)" onclick="toggleMemo()">? M√©mo</button>
      </div>
      <div class="chips">
        <span class="chip" style="color:var(--c1)">‚óè M√©thodologie</span>
        <span class="chip" style="color:var(--c2)">‚óè R√©daction C2</span>
      </div>
    </div>
    
    <div class="hud-strip">
      <span>Progression <span id="txtProg" style="color:var(--c3)">0 / 7</span></span>
      <div class="progress-track"><div id="bar" class="progress-fill"></div></div>
      <span>Score <span id="txtScore" style="color:#fff">0</span></span>
    </div>
  </div>

  <div id="memoPanel" class="card" style="display:none; border-color:var(--c3)">
    <h3 style="margin-top:0; color:var(--c3)">Rappel M√©thode</h3>
    <ul style="padding-left:20px; line-height:1.6; color:var(--muted)">
      <li><strong style="color:#dc2626">Quoi :</strong> Nature du probl√®me</li>
      <li><strong style="color:#ea580c">Qui :</strong> Personnes concern√©es</li>
      <li><strong style="color:#b91c1c">O√π :</strong> Lieu</li>
      <li><strong style="color:#7c3aed">Quand :</strong> Date, moment, dur√©e</li>
      <li><strong style="color:#2563eb">Comment :</strong> Cause, mani√®re</li>
      <li><strong style="color:#16a34a">Pourquoi :</strong> Cons√©quences, enjeux</li>
    </ul>
  </div>

  <div class="main-grid" id="gameGrid" style="display:none">
    
    <div class="card" id="qCard">
      <div class="stepper" id="stepper"></div>
      
      <div id="gameContent">
        <div class="q-tag" id="qTag">Tag</div>
        <h2 id="qTitle" style="margin:0 0 16px 0; font-size:1.3rem">Titre Question</h2>
        
        <div class="situation-box">
          <div class="sit-text" id="qText">Texte situation...</div>
          <img id="qImg" class="sit-img" src="" alt="Situation" onerror="this.style.display='none'">
        </div>

        <div class="prompt">
          <span style="color:var(--c5); font-size:1.5rem; margin-right:8px">?</span>
          <span id="qPrompt">La question...</span>
        </div>

        <div id="inputZone">
          <textarea id="userAnswer" placeholder="R√©dige ta r√©ponse ici..."></textarea>
          <div style="margin-top:10px; display:flex; justify-content:flex-end">
            <button class="btn btn-primary btn-check" id="btnCheck">V√©rifier</button>
          </div>
        </div>

        <div id="correctionZone" class="correction-box">
          <div style="font-size:0.8rem; text-transform:uppercase; color:var(--muted); margin-bottom:4px">R√©ponse attendue</div>
          <div class="model-answer" id="modelAns">...</div>
          
          <div class="keywords-list" id="keywords">...</div>
          <div class="redac-tip" id="redacTip">...</div>

          <div style="border-top:1px solid rgba(255,255,255,0.1); margin-top:16px; padding-top:16px">
            <p style="margin:0 0 10px 0; font-weight:700; font-size:0.95rem">Ta r√©ponse est-elle proche ?</p>
            <div class="eval-buttons">
              <button class="btn btn-success" id="btnYes">Oui, c'est bon</button>
              <button class="btn btn-danger" id="btnNo">Non, incomplet</button>
            </div>
          </div>
        </div>

      </div>

      <div id="finalScreen">
        <h2>Termin√© !</h2>
        <div class="big-score" id="finalScoreVal">0/7</div>
        <p id="finalMsg" style="color:var(--muted); margin-bottom:30px">Analyse...</p>
        <button class="btn btn-primary" onclick="location.reload()">Recommencer</button>
      </div>
    </div>

  </div>

</div>

<script>
/* --- DATA --- */
const AVATARS = {
  neutral: "avatar-neutral.png",
  happy: "avatar-bravo.png",    
  think: "avatar-reflechir.png",
  warn: "avatar-attention.png"
};

const QUESTIONS = [
  {
    title: "Situation 1 : Accident de L√©a",
    tag: "Le Probl√®me",
    text: `L√©a, titulaire d‚Äôun bac pro M√©tiers du commerce et de la vente, travaille dans un hypermarch√© employant 135 salari√©s. √Ä 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est situ√©e au sous-sol et accessible par un escalier interne en colima√ßon. Lorsque L√©a descend l‚Äôescalier, elle heurte des cartons stock√©s sur les deux derni√®res marches, perd l‚Äô√©quilibre et chute. Avant l‚Äôarriv√©e des secours, L√©a est prise en charge par le SST. Suite √† cet accident du travail, elle pr√©sente une double fracture du tibia qui n√©cessite un arr√™t de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "Formulez le probl√®me pos√© dans la situation.",
    model: "C'est un accident du travail suite √† une double fracture du tibia.",
    keys: "Mots-cl√©s : Accident du travail, fracture.",
    tip: "Conseil : Commence ta phrase par un groupe nominal (ex: 'Un accident...')."
  },
  {
    title: "Situation 1 : Accident de L√©a",
    tag: "Comment ?",
    text: `L√©a, titulaire d‚Äôun bac pro M√©tiers du commerce et de la vente, travaille dans un hypermarch√© employant 135 salari√©s. √Ä 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est situ√©e au sous-sol et accessible par un escalier interne en colima√ßon. Lorsque L√©a descend l‚Äôescalier, elle heurte des cartons stock√©s sur les deux derni√®res marches, perd l‚Äô√©quilibre et chute. Avant l‚Äôarriv√©e des secours, L√©a est prise en charge par le SST. Suite √† cet accident du travail, elle pr√©sente une double fracture du tibia qui n√©cessite un arr√™t de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "De quelle mani√®re cela s'est-il pass√© ?",
    model: "En descendant l'escalier, elle heurte des cartons stock√©s sur les deux derni√®res marches.",
    keys: "Mots-cl√©s : Descendant, heurte, cartons stock√©s.",
    tip: "Conseil : D√©cris l'action pr√©cise qui a caus√© la chute."
  },
  {
    title: "Situation 1 : Accident de L√©a",
    tag: "Quand ?",
    text: `L√©a, titulaire d‚Äôun bac pro M√©tiers du commerce et de la vente, travaille dans un hypermarch√© employant 135 salari√©s. √Ä 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est situ√©e au sous-sol et accessible par un escalier interne en colima√ßon. Lorsque L√©a descend l‚Äôescalier, elle heurte des cartons stock√©s sur les deux derni√®res marches, perd l‚Äô√©quilibre et chute. Avant l‚Äôarriv√©e des secours, L√©a est prise en charge par le SST. Suite √† cet accident du travail, elle pr√©sente une double fracture du tibia qui n√©cessite un arr√™t de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "Quand cela s'est-il pass√© (Date et Heure) ?",
    model: "Cela s'est pass√© √† 10 heures, le 4 novembre.",
    keys: "Mots-cl√©s : 10 heures, 4 novembre.",
    tip: "Conseil : Cherche bien l'horaire pr√©cis et la date dans le texte."
  },
  {
    title: "Situation 2 : Le Stress",
    tag: "Qui ?",
    text: `Selon une √©tude [...], plus de la moiti√© des Fran√ßais (60 %) ont √©prouv√© une augmentation de leur niveau de stress au cours des six derniers mois. Un chiffre qui est encore plus important chez les femmes (68 %), mais aussi chez les jeunes de moins de 35 ans (66 %). Parmi ces derniers, la tranche d‚Äô√¢ge des 18-24 ans est d‚Äôailleurs la plus expos√©e au stress (70 %). La situation sanitaire, mais aussi leur inqui√©tude face √† leur avenir et celui de leurs enfants, ont √©t√© les principaux facteurs de ce sentiment d‚Äôanxi√©t√©. Une anxi√©t√© qui va souvent de pair avec une baisse de la qualit√© du sommeil.`,
    img: "situation-stress.jpg",
    prompt: "Quelles sont les personnes concern√©es par le probl√®me (en g√©n√©ral) ?",
    model: "Ce sont plus de la moiti√© des Fran√ßais (60 %) qui sont concern√©s.",
    keys: "Mots-cl√©s : Plus de la moiti√©, Fran√ßais, 60%.",
    tip: "Conseil : N'oublie pas de citer le pourcentage global donn√© au d√©but du texte."
  },
  {
    title: "Situation 2 : Le Stress",
    tag: "Quoi / Causes",
    text: `Selon une √©tude [...], plus de la moiti√© des Fran√ßais (60 %) ont √©prouv√© une augmentation de leur niveau de stress au cours des six derniers mois. Un chiffre qui est encore plus important chez les femmes (68 %), mais aussi chez les jeunes de moins de 35 ans (66 %). Parmi ces derniers, la tranche d‚Äô√¢ge des 18-24 ans est d‚Äôailleurs la plus expos√©e au stress (70 %). La situation sanitaire, mais aussi leur inqui√©tude face √† leur avenir et celui de leurs enfants, ont √©t√© les principaux facteurs de ce sentiment d‚Äôanxi√©t√©. Une anxi√©t√© qui va souvent de pair avec une baisse de la qualit√© du sommeil.`,
    img: "situation-stress.jpg",
    prompt: "Quelles sont les causes du probl√®me ?",
    model: "Les causes sont la situation sanitaire et l'inqui√©tude des Fran√ßais face √† leur avenir.",
    keys: "Mots-cl√©s : Situation sanitaire, inqui√©tude, avenir.",
    tip: "Conseil : Rel√®ve les deux causes principales cit√©es √† la fin du texte."
  },
  {
    title: "Situation 3 : Le Bruit",
    tag: "O√π ?",
    text: `Pr√®s de 70 % des Fran√ßais se d√©clarent g√™n√©s par le bruit, en particulier dans les villes o√π il constitue l‚Äôune des principales sources de plaintes des habitants. De simple d√©sagr√©ment, il peut devenir une r√©elle source de stress constituant alors un probl√®me de sant√© portant atteinte √† la qualit√© de vie.\nLe co√ªt social du bruit en France a m√™me √©t√© √©valu√© par l‚ÄôADEME √† pr√®s de 147 milliards d‚Äôeuros par an !\nL‚Äôorganisme humain ne s‚Äôhabitue pas au bruit. Si nous connaissons depuis longtemps les effets des niveaux sonores √©lev√©s sur le syst√®me auditif, nous savons maintenant que m√™me des bruits de faible intensit√© peuvent nuire au bien-√™tre des individus et avoir des r√©percussions sur leur sant√©.`,
    img: "situation-bruit.jpg",
    prompt: "O√π le probl√®me se pose-t-il principalement ?",
    model: "Le probl√®me se pose en particulier dans les villes.",
    keys: "Mots-cl√©s : Villes.",
    tip: "Conseil : Rep√®re le lieu g√©ographique cit√© d√®s la premi√®re phrase."
  },
  {
    title: "Situation 3 : Le Bruit",
    tag: "Pourquoi / Cons√©quences",
    text: `Pr√®s de 70 % des Fran√ßais se d√©clarent g√™n√©s par le bruit, en particulier dans les villes o√π il constitue l‚Äôune des principales sources de plaintes des habitants. De simple d√©sagr√©ment, il peut devenir une r√©elle source de stress constituant alors un probl√®me de sant√© portant atteinte √† la qualit√© de vie.\nLe co√ªt social du bruit en France a m√™me √©t√© √©valu√© par l‚ÄôADEME √† pr√®s de 147 milliards d‚Äôeuros par an !\nL‚Äôorganisme humain ne s‚Äôhabitue pas au bruit. Si nous connaissons depuis longtemps les effets des niveaux sonores √©lev√©s sur le syst√®me auditif, nous savons maintenant que m√™me des bruits de faible intensit√© peuvent nuire au bien-√™tre des individus et avoir des r√©percussions sur leur sant√©.`,
    img: "situation-bruit.jpg",
    prompt: "Quelles sont les cons√©quences du probl√®me (Pourquoi faut-il le r√©gler) ?",
    model: "Le bruit est source de stress, nuit √† la sant√© et au bien-√™tre, et engendre un co√ªt social √©lev√©.",
    keys: "Mots-cl√©s : Stress, sant√©, bien-√™tre, co√ªt social.",
    tip: "Conseil : Cherche les impacts sur la sant√© et l'√©conomie (co√ªt)."
  },
  {
    title: "Situation 4 : Les Panneaux",
    tag: "O√π ?",
    text: `Avec 564 000 accidents de travail et 89 000 maladies professionnelles, tous les employeurs sont contraints par le Code du travail d‚Äôafficher un certain nombre d‚Äôinformations pour assurer la s√©curit√© des salari√©s afin de pr√©venir tous risques professionnels.`,
    img: "situation-panneaux.jpg",
    prompt: "O√π ces consignes doivent-elles √™tre mises en place ?",
    model: "Elles doivent √™tre affich√©es en entreprise (ou √©tablissement de formation) car c'est une obligation de l'employeur.",
    keys: "Mots-cl√©s : Entreprise, employeur, Code du travail.",
    tip: "Conseil : Justifie ta r√©ponse en citant le cadre l√©gal (Code du travail)."
  }
];

/* --- LOGIC --- */
const $=(id)=>document.getElementById(id);
/* PSEUDO AUTO (RGPD) */
const PSEUDOS = [
    "Panda üêº","Etoile ‚≠ê","Fusee üöÄ","Diamant üíé","Tigre üêØ","Dragon üêâ",
    "Licorne ü¶Ñ","Phoenix üî•","Ninja ü•∑","Robot ü§ñ","Koala üê®","Dauphin üê¨",
    "Aigle ü¶Ö","Papillon ü¶ã","Lion ü¶Å","Comete ‚òÑÔ∏è","Eclair ‚ö°","Flocon ‚ùÑÔ∏è",
    "Soleil ‚òÄÔ∏è","Lune üåô","Galaxie üåå","Hibou ü¶â","Renard ü¶ä","Tornade üå™Ô∏è",
    "Volcan üåã","Cristal üí†","Trefle üçÄ","Cerise üçí","Arc-en-ciel üåà","Pingouin üêß"
];
const myPseudo = PSEUDOS[Math.floor(Math.random() * PSEUDOS.length)];
document.getElementById('display-pseudo').textContent = myPseudo;

let state={ idx:0, score:0, name:"" };

const setCoach=(msg, mood="neutral")=>{
  $("floatBubble").textContent = msg;
  if(AVATARS[mood]) $("floatAvatar").src = AVATARS[mood];
}

const toggleMemo=()=>{
  const p = $("memoPanel");
  p.style.display = (p.style.display==="none") ? "block" : "none";
}

/* GESTION DU FOCUS : On garde la couleur mais on r√©duit l'opacit√© */
const ua = $("userAnswer");
ua.addEventListener("focus", ()=>{ document.body.classList.add("typing-mode"); });
ua.addEventListener("blur", ()=>{ document.body.classList.remove("typing-mode"); });

const startGame=()=>{
  state.name = myPseudo;
  const n = myPseudo;

  // Transition Overlay -> Game
  $("loginOverlay").style.opacity = "0";
  setTimeout(()=>{
    $("loginOverlay").style.display = "none";
    $("floatCoach").style.display = "flex";
    $("gameGrid").style.display = "grid";
    setCoach(`C'est parti ${n} ! A toi de jouer.`, "neutral");
    loadQuestion();
  }, 500);
}

const loadQuestion=()=>{
  if(state.idx >= QUESTIONS.length){ showFinal(); return; }
  const q = QUESTIONS[state.idx];
  
  $("qTitle").textContent = q.title; $("qTag").textContent = q.tag;
  $("qText").textContent = q.text; $("qImg").src = q.img; $("qPrompt").textContent = q.prompt;
  
  // Reset UI
  $("userAnswer").value = ""; $("userAnswer").disabled = false;
  $("inputZone").style.display = "block";
  $("correctionZone").style.display = "none";
  $("btnCheck").style.display = "inline-flex";
  
  updateHUD();
  if(state.idx>0) setCoach("Nouvelle question. Prends ton temps.", "neutral");
}

const checkAnswer=()=>{
  const txt = $("userAnswer").value.trim();
  if(txt.length < 5){
    setCoach("Ta r√©ponse est trop courte ! R√©dige une phrase.", "warn");
    return;
  }
  
  const q = QUESTIONS[state.idx];
  $("userAnswer").disabled = true; 
  $("btnCheck").style.display = "none";
  
  $("modelAns").textContent = q.model;
  $("keywords").textContent = q.keys;
  $("redacTip").textContent = q.tip;
  
  $("correctionZone").style.display = "block";
  setCoach("Compare ta r√©ponse avec la mienne ci-dessus.", "think");
}

const selfEval=(isCorrect)=>{
  if(isCorrect){
    state.score++;
    setCoach("Super ! Continue comme √ßa.", "happy");
    // CORRECTION : Pas de confetti ici, seulement √† la fin
  } else {
    setCoach("Pas grave, observe bien les mots-cl√©s.", "neutral");
  }
  state.idx++;
  setTimeout(loadQuestion, 1500);
}

const updateHUD=()=>{
  $("txtProg").textContent = `${state.idx}/${QUESTIONS.length}`;
  $("bar").style.width = `${(state.idx/QUESTIONS.length)*100}%`;
  $("txtScore").textContent = state.score;
  
  const st=$("stepper"); st.innerHTML="";
  for(let i=0;i<QUESTIONS.length;i++){
    st.innerHTML+=`<div class="step ${i===state.idx?'active':(i<state.idx?'done':'')}"></div>`;
  }
}

const showFinal=()=>{
  $("gameContent").style.display="none"; $("finalScreen").style.display="block";
  $("finalScoreVal").textContent = `${state.score} / ${QUESTIONS.length}`;
  const pct = state.score/QUESTIONS.length;
  let msg = pct>0.8 ? "Excellent travail !" : "Bien jou√© !";
  $("finalMsg").textContent = msg;
  setCoach("Session termin√©e ! " + msg, "happy");
  launchConfetti(); // CORRECTION : Confettis ici seulement
}

function launchConfetti() {
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const pieces = [];
  for(let i=0; i<100; i++){ pieces.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height - canvas.height, color: `hsl(${Math.random()*360}, 100%, 50%)`, size: Math.random()*8+4, speed: Math.random()*3+2 }); }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); p.y += p.speed; if(p.y > canvas.height) p.y = -10; });
    requestAnimationFrame(draw);
  }
  draw(); setTimeout(()=>cancelAnimationFrame(draw), 5000);
}

$("startBtn").addEventListener("click", startGame);
$("btnCheck").addEventListener("click", checkAnswer);
$("btnYes").addEventListener("click", ()=>selfEval(true));
$("btnNo").addEventListener("click", ()=>selfEval(false));

</script>
</body>
</html>