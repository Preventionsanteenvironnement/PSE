<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>QQOQCP – Entraînement Bac Pro (Final V4)</title>
<style>
  :root{
    --bg:#0f172a; --text:#f1f5f9; --muted:#94a3b8; 
    --line:rgba(255,255,255,.12);
    --c1:#8b5cf6; --c2:#3b82f6; --c3:#06b6d4; --c4:#10b981; --c5:#f59e0b; --err:#ef4444;
    --shadow:0 12px 30px rgba(0,0,0,.45); --radius:20px;
    --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:var(--font-ui); color:var(--text);
    background:var(--bg); padding:16px; padding-bottom:120px;
    background-image: 
      radial-gradient(at 0% 0%, rgba(139,92,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 0%, rgba(59,130,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 100%, rgba(16,185,129,0.1) 0px, transparent 50%);
    background-attachment: fixed;
    overflow-x:hidden;
  }
  
  .wrap{max-width:800px; margin:0 auto; display:grid; gap:20px}
  
  /* --- Header & HUD --- */
  .header{ display:flex; flex-wrap:wrap; gap:16px; align-items:stretch; }
  .hero{
    flex:1 1 100%; border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(255,255,255,.03); backdrop-filter:blur(10px);
    padding:20px; box-shadow:var(--shadow); position:relative; overflow:hidden;
  }
  .hero h1{margin:0 0 8px 0; font-size:1.4rem; background:linear-gradient(90deg, #fff, #cbd5e1); -webkit-background-clip:text; -webkit-text-fill-color: transparent;}
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
  .chip{
    padding:6px 12px; border-radius:99px; font-size:0.75rem; font-weight:700;
    border:1px solid var(--line); background:rgba(255,255,255,.05); display:flex; align-items:center; gap:6px;
  }
  
  .hud-strip {
    display:flex; justify-content: space-between; align-items: center;
    background: rgba(15, 23, 42, 0.8); border: 1px solid var(--line);
    padding: 10px 20px; border-radius: 99px; font-weight: 700; font-size: 0.9rem;
    backdrop-filter: blur(5px);
  }
  .progress-track{ width:100px; height:8px; background:rgba(255,255,255,.1); border-radius:99px; overflow:hidden; margin:0 10px; }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--c1), var(--c3)); transition:width 0.5s ease; }

  /* --- LOGIN MODAL --- */
  #loginOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(11, 18, 32, 0.85); backdrop-filter: blur(8px);
    z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .login-card {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
    border: 1px solid rgba(255,255,255,0.15); border-radius: 24px;
    padding: 30px; width: 100%; max-width: 400px; text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transform: translateY(0); animation: floatUp 0.5s ease-out;
  }
  @keyframes floatUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
  
  .login-avatar {
    width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
    border: 3px solid var(--c2); margin-bottom: 20px;
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
  }
  
  /* --- Inputs & Buttons --- */
  input[type="text"], textarea{
    background:rgba(0,0,0,.3); border:1px solid var(--line); color:white;
    padding:14px; border-radius:12px; outline:none; font-family:inherit; font-weight:500; font-size:1rem;
    width: 100%; transition:0.2s;
  }
  input[type="text"]:focus, textarea:focus{ border-color:var(--c3); box-shadow:0 0 0 3px rgba(6,182,212,.2); }
  
  textarea { min-height: 120px; resize: vertical; line-height: 1.5; }

  .btn{
    border:none; padding:14px 24px; border-radius:12px; font-weight:700; cursor:pointer;
    font-family:inherit; font-size:1rem; transition:all 0.2s; 
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
  }
  .btn-primary{ background:linear-gradient(135deg, var(--c2), var(--c1)); color:white; width:100%; }
  .btn-primary:active{ transform:scale(0.98); }
  
  .btn-check{ background: var(--c3); color: #0f172a; width: auto; margin-left: auto; }
  .btn-success{ background:linear-gradient(135deg, var(--c4), #059669); color:#022c22; flex:1;}
  .btn-danger{ background:rgba(239,68,68,0.2); border:1px solid var(--err); color:#fca5a5; flex:1;}

  /* --- Question Card --- */
  .card{
    border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(30,41,59,.6); padding:20px; box-shadow:var(--shadow);
    transition: transform 0.2s;
  }
  
  .stepper{display:flex; gap:6px; margin-bottom:16px}
  .step{ width:30px; height:6px; border-radius:4px; background:rgba(255,255,255,.1); transition:0.3s; }
  .step.active{ background:var(--c3); box-shadow:0 0 10px var(--c3); }
  .step.done{ background:var(--c4); }

  .q-tag{
    display:inline-flex; align-items:center; gap:8px; padding:6px 12px;
    border-radius:99px; background:rgba(6,182,212,.1); color:var(--c3);
    font-weight:800; font-size:0.8rem; margin-bottom:12px; border:1px solid rgba(6,182,212,.2);
  }

  .situation-box{
    background:rgba(0,0,0,.2); border-radius:16px; padding:16px; border:1px solid var(--line);
    margin-bottom:16px; display:grid; gap:16px;
  }
  @media(min-width:600px){ .situation-box{grid-template-columns: 2fr 1fr;} }
  
  /* --- CORRECTION TEXTE (Prend tout l'espace) --- */
  .sit-text{ 
    line-height:1.6; font-size:0.95rem; 
    white-space: normal; /* Remplit l'espace sans coupures */
    text-align: justify;
  }
  .sit-img{
    width:100%; height:200px; object-fit:cover; border-radius:12px; 
    border:1px solid var(--line); background:#000;
  }

  .prompt{
    font-size:1.1rem; font-weight:700; margin-bottom:16px; display:flex; gap:12px; align-items:start;
    background:rgba(255,255,255,.03); padding:16px; border-radius:16px; border-left:4px solid var(--c5);
  }

  /* Correction Panel */
  .correction-box {
    margin-top:20px; padding:20px; border-radius:16px; background:rgba(16,185,129,0.05);
    border:1px solid rgba(16,185,129,0.3); display:none; animation: slideDown 0.4s ease;
  }
  .model-answer { font-weight:700; color:#6ee7b7; margin-bottom:10px; font-size:1.05rem; }
  .keywords-list { font-size:0.9rem; color:var(--muted); margin-bottom:16px; }
  .redac-tip { 
    background:rgba(245,158,11,0.1); border-left:3px solid var(--c5); padding:10px; 
    font-size:0.85rem; color:#fcd34d; margin-bottom:20px; border-radius:4px;
  }
  .eval-buttons { display:flex; gap:12px; margin-top: 10px; }

  /* --- FLOATING COACH SYSTEM --- */
  #floatCoach {
    position: fixed; bottom: 20px; right: 20px; z-index: 1000;
    display: flex; flex-direction: column; align-items: flex-end;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4));
  }
  
  #floatAvatar {
    width: 70px; height: 70px; border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.2);
    object-fit: cover; background: #1e293b;
    cursor: pointer; transition: transform 0.2s;
  }
  #floatAvatar:active { transform: scale(0.95); }

  #floatBubble {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.99));
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff; padding: 16px; border-radius: 20px 20px 4px 20px;
    margin-bottom: 12px; max-width: 300px; width: 85vw;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-size: 0.95rem; line-height: 1.5;
  }
  
  /* Mode "Typing" : Le coach se fait discret MAIS RESTE EN COULEUR */
  body.typing-mode #floatBubble {
    opacity: 0; transform: translateY(20px) scale(0.8); pointer-events: none;
  }
  body.typing-mode #floatCoach {
    opacity: 0.3; transform: scale(0.7) translate(20px, 20px); 
    /* CORRECTION : Suppression du filtre grayscale pour garder la couleur */
  }

  /* Animations & Misc */
  @keyframes slideDown{ from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
  @keyframes popIn { from{opacity:0; transform:scale(0.8) translateY(10px)} to{opacity:1; transform:scale(1) translateY(0)} }
  .pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes pop { 0%{transform:scale(0.9)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }

  #confetti{ position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }
  #finalScreen{ text-align:center; padding:40px 20px; display:none; }
  .big-score{ font-size:3rem; font-weight:900; margin:10px 0; background:linear-gradient(to right, var(--c4), var(--c3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div id="loginOverlay">
  <div class="login-card">
    <img src="avatar-neutral.png" alt="Coach" class="login-avatar" id="startAvatar">
    <h2 style="margin-top:0">Bienvenue !</h2>
    <p style="color:var(--muted); margin-bottom:20px">Je suis votre coach. On va s'entraîner à rédiger ensemble.</p>
    <div style="text-align:left; margin-bottom:15px">
      <label style="font-size:0.9rem; font-weight:700; margin-left:4px">Ton prénom :</label>
      <input type="text" id="prenom" placeholder="Ex: Thomas" autocomplete="off" style="margin-top:5px">
    </div>
    <button class="btn btn-primary" id="startBtn">Commencer l'entraînement</button>
  </div>
</div>

<div id="floatCoach" style="display:none">
  <div id="floatBubble">Bonjour ! Prêt à commencer ?</div>
  <img id="floatAvatar" src="avatar-neutral.png" alt="Coach">
</div>

<div class="wrap">
  
  <div class="header">
    <div class="hero">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h1>QQOQCP – Bac Pro</h1>
        <button class="btn" style="padding:6px 12px; font-size:0.8rem; background:rgba(255,255,255,0.1)" onclick="toggleMemo()">? Mémo</button>
      </div>
      <div class="chips">
        <span class="chip" style="color:var(--c1)">● Méthodologie</span>
        <span class="chip" style="color:var(--c2)">● Rédaction C2</span>
      </div>
    </div>
    
    <div class="hud-strip">
      <span>Progression <span id="txtProg" style="color:var(--c3)">0 / 7</span></span>
      <div class="progress-track"><div id="bar" class="progress-fill"></div></div>
      <span>Score <span id="txtScore" style="color:#fff">0</span></span>
    </div>
  </div>

  <div id="memoPanel" class="card" style="display:none; border-color:var(--c3)">
    <h3 style="margin-top:0; color:var(--c3)">Rappel Méthode</h3>
    <ul style="padding-left:20px; line-height:1.6; color:var(--muted)">
      <li><strong style="color:#dc2626">Quoi :</strong> Nature du problème</li>
      <li><strong style="color:#ea580c">Qui :</strong> Personnes concernées</li>
      <li><strong style="color:#b91c1c">Où :</strong> Lieu</li>
      <li><strong style="color:#7c3aed">Quand :</strong> Date, moment, durée</li>
      <li><strong style="color:#2563eb">Comment :</strong> Cause, manière</li>
      <li><strong style="color:#16a34a">Pourquoi :</strong> Conséquences, enjeux</li>
    </ul>
  </div>

  <div class="main-grid" id="gameGrid" style="display:none">
    
    <div class="card" id="qCard">
      <div class="stepper" id="stepper"></div>
      
      <div id="gameContent">
        <div class="q-tag" id="qTag">Tag</div>
        <h2 id="qTitle" style="margin:0 0 16px 0; font-size:1.3rem">Titre Question</h2>
        
        <div class="situation-box">
          <div class="sit-text" id="qText">Texte situation...</div>
          <img id="qImg" class="sit-img" src="" alt="Situation" onerror="this.style.display='none'">
        </div>

        <div class="prompt">
          <span style="color:var(--c5); font-size:1.5rem; margin-right:8px">?</span>
          <span id="qPrompt">La question...</span>
        </div>

        <div id="inputZone">
          <textarea id="userAnswer" placeholder="Rédige ta réponse ici..."></textarea>
          <div style="margin-top:10px; display:flex; justify-content:flex-end">
            <button class="btn btn-primary btn-check" id="btnCheck">Vérifier</button>
          </div>
        </div>

        <div id="correctionZone" class="correction-box">
          <div style="font-size:0.8rem; text-transform:uppercase; color:var(--muted); margin-bottom:4px">Réponse attendue</div>
          <div class="model-answer" id="modelAns">...</div>
          
          <div class="keywords-list" id="keywords">...</div>
          <div class="redac-tip" id="redacTip">...</div>

          <div style="border-top:1px solid rgba(255,255,255,0.1); margin-top:16px; padding-top:16px">
            <p style="margin:0 0 10px 0; font-weight:700; font-size:0.95rem">Ta réponse est-elle proche ?</p>
            <div class="eval-buttons">
              <button class="btn btn-success" id="btnYes">Oui, c'est bon</button>
              <button class="btn btn-danger" id="btnNo">Non, incomplet</button>
            </div>
          </div>
        </div>

      </div>

      <div id="finalScreen">
        <h2>Terminé !</h2>
        <div class="big-score" id="finalScoreVal">0/7</div>
        <p id="finalMsg" style="color:var(--muted); margin-bottom:30px">Analyse...</p>
        <button class="btn btn-primary" onclick="location.reload()">Recommencer</button>
      </div>
    </div>

  </div>

</div>

<script>
/* --- DATA --- */
const AVATARS = {
  neutral: "avatar-neutral.png",
  happy: "avatar-bravo.png",    
  think: "avatar-reflechir.png",
  warn: "avatar-attention.png"
};

const QUESTIONS = [
  {
    title: "Situation 1 : Accident de Léa",
    tag: "Le Problème",
    text: `Léa, titulaire d’un bac pro Métiers du commerce et de la vente, travaille dans un hypermarché employant 135 salariés. À 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est située au sous-sol et accessible par un escalier interne en colimaçon. Lorsque Léa descend l’escalier, elle heurte des cartons stockés sur les deux dernières marches, perd l’équilibre et chute. Avant l’arrivée des secours, Léa est prise en charge par le SST. Suite à cet accident du travail, elle présente une double fracture du tibia qui nécessite un arrêt de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "Formulez le problème posé dans la situation.",
    model: "C'est un accident du travail suite à une double fracture du tibia.",
    keys: "Mots-clés : Accident du travail, fracture.",
    tip: "Conseil : Commence ta phrase par un groupe nominal (ex: 'Un accident...')."
  },
  {
    title: "Situation 1 : Accident de Léa",
    tag: "Comment ?",
    text: `Léa, titulaire d’un bac pro Métiers du commerce et de la vente, travaille dans un hypermarché employant 135 salariés. À 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est située au sous-sol et accessible par un escalier interne en colimaçon. Lorsque Léa descend l’escalier, elle heurte des cartons stockés sur les deux dernières marches, perd l’équilibre et chute. Avant l’arrivée des secours, Léa est prise en charge par le SST. Suite à cet accident du travail, elle présente une double fracture du tibia qui nécessite un arrêt de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "De quelle manière cela s'est-il passé ?",
    model: "En descendant l'escalier, elle heurte des cartons stockés sur les deux dernières marches.",
    keys: "Mots-clés : Descendant, heurte, cartons stockés.",
    tip: "Conseil : Décris l'action précise qui a causé la chute."
  },
  {
    title: "Situation 1 : Accident de Léa",
    tag: "Quand ?",
    text: `Léa, titulaire d’un bac pro Métiers du commerce et de la vente, travaille dans un hypermarché employant 135 salariés. À 10 heures, le 4 novembre, elle se rend en salle de pause. Cette salle est située au sous-sol et accessible par un escalier interne en colimaçon. Lorsque Léa descend l’escalier, elle heurte des cartons stockés sur les deux dernières marches, perd l’équilibre et chute. Avant l’arrivée des secours, Léa est prise en charge par le SST. Suite à cet accident du travail, elle présente une double fracture du tibia qui nécessite un arrêt de travail de 40 jours.`,
    img: "situation-lea.jpg",
    prompt: "Quand cela s'est-il passé (Date et Heure) ?",
    model: "Cela s'est passé à 10 heures, le 4 novembre.",
    keys: "Mots-clés : 10 heures, 4 novembre.",
    tip: "Conseil : Cherche bien l'horaire précis et la date dans le texte."
  },
  {
    title: "Situation 2 : Le Stress",
    tag: "Qui ?",
    text: `Selon une étude [...], plus de la moitié des Français (60 %) ont éprouvé une augmentation de leur niveau de stress au cours des six derniers mois. Un chiffre qui est encore plus important chez les femmes (68 %), mais aussi chez les jeunes de moins de 35 ans (66 %). Parmi ces derniers, la tranche d’âge des 18-24 ans est d’ailleurs la plus exposée au stress (70 %). La situation sanitaire, mais aussi leur inquiétude face à leur avenir et celui de leurs enfants, ont été les principaux facteurs de ce sentiment d’anxiété. Une anxiété qui va souvent de pair avec une baisse de la qualité du sommeil.`,
    img: "situation-stress.jpg",
    prompt: "Quelles sont les personnes concernées par le problème (en général) ?",
    model: "Ce sont plus de la moitié des Français (60 %) qui sont concernés.",
    keys: "Mots-clés : Plus de la moitié, Français, 60%.",
    tip: "Conseil : N'oublie pas de citer le pourcentage global donné au début du texte."
  },
  {
    title: "Situation 2 : Le Stress",
    tag: "Quoi / Causes",
    text: `Selon une étude [...], plus de la moitié des Français (60 %) ont éprouvé une augmentation de leur niveau de stress au cours des six derniers mois. Un chiffre qui est encore plus important chez les femmes (68 %), mais aussi chez les jeunes de moins de 35 ans (66 %). Parmi ces derniers, la tranche d’âge des 18-24 ans est d’ailleurs la plus exposée au stress (70 %). La situation sanitaire, mais aussi leur inquiétude face à leur avenir et celui de leurs enfants, ont été les principaux facteurs de ce sentiment d’anxiété. Une anxiété qui va souvent de pair avec une baisse de la qualité du sommeil.`,
    img: "situation-stress.jpg",
    prompt: "Quelles sont les causes du problème ?",
    model: "Les causes sont la situation sanitaire et l'inquiétude des Français face à leur avenir.",
    keys: "Mots-clés : Situation sanitaire, inquiétude, avenir.",
    tip: "Conseil : Relève les deux causes principales citées à la fin du texte."
  },
  {
    title: "Situation 3 : Le Bruit",
    tag: "Où ?",
    text: `Près de 70 % des Français se déclarent gênés par le bruit, en particulier dans les villes où il constitue l’une des principales sources de plaintes des habitants. De simple désagrément, il peut devenir une réelle source de stress constituant alors un problème de santé portant atteinte à la qualité de vie.\nLe coût social du bruit en France a même été évalué par l’ADEME à près de 147 milliards d’euros par an !\nL’organisme humain ne s’habitue pas au bruit. Si nous connaissons depuis longtemps les effets des niveaux sonores élevés sur le système auditif, nous savons maintenant que même des bruits de faible intensité peuvent nuire au bien-être des individus et avoir des répercussions sur leur santé.`,
    img: "situation-bruit.jpg",
    prompt: "Où le problème se pose-t-il principalement ?",
    model: "Le problème se pose en particulier dans les villes.",
    keys: "Mots-clés : Villes.",
    tip: "Conseil : Repère le lieu géographique cité dès la première phrase."
  },
  {
    title: "Situation 3 : Le Bruit",
    tag: "Pourquoi / Conséquences",
    text: `Près de 70 % des Français se déclarent gênés par le bruit, en particulier dans les villes où il constitue l’une des principales sources de plaintes des habitants. De simple désagrément, il peut devenir une réelle source de stress constituant alors un problème de santé portant atteinte à la qualité de vie.\nLe coût social du bruit en France a même été évalué par l’ADEME à près de 147 milliards d’euros par an !\nL’organisme humain ne s’habitue pas au bruit. Si nous connaissons depuis longtemps les effets des niveaux sonores élevés sur le système auditif, nous savons maintenant que même des bruits de faible intensité peuvent nuire au bien-être des individus et avoir des répercussions sur leur santé.`,
    img: "situation-bruit.jpg",
    prompt: "Quelles sont les conséquences du problème (Pourquoi faut-il le régler) ?",
    model: "Le bruit est source de stress, nuit à la santé et au bien-être, et engendre un coût social élevé.",
    keys: "Mots-clés : Stress, santé, bien-être, coût social.",
    tip: "Conseil : Cherche les impacts sur la santé et l'économie (coût)."
  },
  {
    title: "Situation 4 : Les Panneaux",
    tag: "Où ?",
    text: `Avec 564 000 accidents de travail et 89 000 maladies professionnelles, tous les employeurs sont contraints par le Code du travail d’afficher un certain nombre d’informations pour assurer la sécurité des salariés afin de prévenir tous risques professionnels.`,
    img: "situation-panneaux.jpg",
    prompt: "Où ces consignes doivent-elles être mises en place ?",
    model: "Elles doivent être affichées en entreprise (ou établissement de formation) car c'est une obligation de l'employeur.",
    keys: "Mots-clés : Entreprise, employeur, Code du travail.",
    tip: "Conseil : Justifie ta réponse en citant le cadre légal (Code du travail)."
  }
];

/* --- LOGIC --- */
const $=(id)=>document.getElementById(id);
let state={ idx:0, score:0, name:"" };

const setCoach=(msg, mood="neutral")=>{
  $("floatBubble").textContent = msg;
  if(AVATARS[mood]) $("floatAvatar").src = AVATARS[mood];
}

const toggleMemo=()=>{
  const p = $("memoPanel");
  p.style.display = (p.style.display==="none") ? "block" : "none";
}

/* GESTION DU FOCUS : On garde la couleur mais on réduit l'opacité */
const ua = $("userAnswer");
ua.addEventListener("focus", ()=>{ document.body.classList.add("typing-mode"); });
ua.addEventListener("blur", ()=>{ document.body.classList.remove("typing-mode"); });

const startGame=()=>{
  const n = $("prenom").value.trim();
  if(!n) { alert("Entre ton prénom !"); return; }
  state.name = n;
  
  // Transition Overlay -> Game
  $("loginOverlay").style.opacity = "0";
  setTimeout(()=>{
    $("loginOverlay").style.display = "none";
    $("floatCoach").style.display = "flex";
    $("gameGrid").style.display = "grid";
    setCoach(`C'est parti ${n} ! À toi de jouer.`, "neutral");
    loadQuestion();
  }, 500);
}

const loadQuestion=()=>{
  if(state.idx >= QUESTIONS.length){ showFinal(); return; }
  const q = QUESTIONS[state.idx];
  
  $("qTitle").textContent = q.title; $("qTag").textContent = q.tag;
  $("qText").textContent = q.text; $("qImg").src = q.img; $("qPrompt").textContent = q.prompt;
  
  // Reset UI
  $("userAnswer").value = ""; $("userAnswer").disabled = false;
  $("inputZone").style.display = "block";
  $("correctionZone").style.display = "none";
  $("btnCheck").style.display = "inline-flex";
  
  updateHUD();
  if(state.idx>0) setCoach("Nouvelle question. Prends ton temps.", "neutral");
}

const checkAnswer=()=>{
  const txt = $("userAnswer").value.trim();
  if(txt.length < 5){
    setCoach("Ta réponse est trop courte ! Rédige une phrase.", "warn");
    return;
  }
  
  const q = QUESTIONS[state.idx];
  $("userAnswer").disabled = true; 
  $("btnCheck").style.display = "none";
  
  $("modelAns").textContent = q.model;
  $("keywords").textContent = q.keys;
  $("redacTip").textContent = q.tip;
  
  $("correctionZone").style.display = "block";
  setCoach("Compare ta réponse avec la mienne ci-dessus.", "think");
}

const selfEval=(isCorrect)=>{
  if(isCorrect){
    state.score++;
    setCoach("Super ! Continue comme ça.", "happy");
    // CORRECTION : Pas de confetti ici, seulement à la fin
  } else {
    setCoach("Pas grave, observe bien les mots-clés.", "neutral");
  }
  state.idx++;
  setTimeout(loadQuestion, 1500);
}

const updateHUD=()=>{
  $("txtProg").textContent = `${state.idx}/${QUESTIONS.length}`;
  $("bar").style.width = `${(state.idx/QUESTIONS.length)*100}%`;
  $("txtScore").textContent = state.score;
  
  const st=$("stepper"); st.innerHTML="";
  for(let i=0;i<QUESTIONS.length;i++){
    st.innerHTML+=`<div class="step ${i===state.idx?'active':(i<state.idx?'done':'')}"></div>`;
  }
}

const showFinal=()=>{
  $("gameContent").style.display="none"; $("finalScreen").style.display="block";
  $("finalScoreVal").textContent = `${state.score} / ${QUESTIONS.length}`;
  const pct = state.score/QUESTIONS.length;
  let msg = pct>0.8 ? "Excellent travail !" : "Bien joué !";
  $("finalMsg").textContent = msg;
  setCoach("Session terminée ! " + msg, "happy");
  launchConfetti(); // CORRECTION : Confettis ici seulement
}

function launchConfetti() {
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const pieces = [];
  for(let i=0; i<100; i++){ pieces.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height - canvas.height, color: `hsl(${Math.random()*360}, 100%, 50%)`, size: Math.random()*8+4, speed: Math.random()*3+2 }); }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); p.y += p.speed; if(p.y > canvas.height) p.y = -10; });
    requestAnimationFrame(draw);
  }
  draw(); setTimeout(()=>cancelAnimationFrame(draw), 5000);
}

$("startBtn").addEventListener("click", startGame);
$("btnCheck").addEventListener("click", checkAnswer);
$("btnYes").addEventListener("click", ()=>selfEval(true));
$("btnNo").addEventListener("click", ()=>selfEval(false));

</script>
</body>
</html>