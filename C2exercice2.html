<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Module C.2 ¬∑ Analyse de risque : Chute / tr√©buchement</title>
<style>
:root{
  --bg0:#f8fafc; --bg1:#f1f5f9; --card:#ffffff; --card2:#f8fafc;
  --text:#1e293b; --muted:#64748b; --line:#e2e8f0;
  --accent:#7c3aed; --accent2:#10b981; --danger:#ef4444; --warn:#f59e0b;
  --ok:#10b981;
  --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  color:var(--text);
  background: linear-gradient(180deg, var(--bg0), var(--bg1));
  min-height:100vh;
}
.container{max-width:980px;margin:0 auto;padding:20px 16px 42px}
.header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin:10px 0 18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:14px;background:
  linear-gradient(135deg, #7c3aed, #10b981);
  box-shadow: 0 8px 20px rgba(124,58,237,.25);
}
h1{font-size:20px;line-height:1.15;margin:0;color:var(--text)}
.subtitle{color:var(--muted);font-size:13px;margin-top:6px}
.pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pill{border:1px solid var(--line);background:white;padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted);box-shadow:0 2px 4px rgba(0,0,0,.05)}

.card{
  background:var(--card);
  border:1px solid var(--line); border-radius:var(--radius);
  box-shadow: 0 4px 12px rgba(0,0,0,.06);
}
.card-inner{padding:16px}
.section{margin:14px 0}
h2{font-size:16px;margin:0 0 10px;color:var(--text)}
p{margin:10px 0;color:var(--muted);line-height:1.45}
hr.sep{border:none;border-top:1px solid var(--line);margin:14px 0}

.grid{display:grid;gap:12px}
@media (min-width:860px){ .grid.cols2{grid-template-columns: 1fr 1fr} }

.btnrow{display:flex;gap:10px;flex-wrap:wrap}
button{
  appearance:none;border:none;cursor:pointer;
  padding:12px 14px;border-radius:14px;
  background:linear-gradient(135deg, #7c3aed, #10b981);
  color:white;font-weight:700;
  box-shadow:0 4px 12px rgba(124,58,237,.25);
}
button:hover{box-shadow:0 6px 16px rgba(124,58,237,.35)}
button.secondary{
  background:white;
  border:1px solid var(--line);
  color:var(--text);
  font-weight:600;
  box-shadow:0 2px 4px rgba(0,0,0,.05);
}
button:active{transform:translateY(1px)}
.small{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:var(--muted);font-size:12px}
.badge strong{color:var(--text)}

/* === OBJECTIF BOX === */
.box-objectif{
  background:linear-gradient(135deg, #d1fae5, #a7f3d0);
  border-left:4px solid var(--accent2);
  padding:16px;
  border-radius:0 var(--radius) var(--radius) 0;
  margin-bottom:14px;
}
.box-objectif h3{color:#047857;margin:0 0 8px;font-size:14px;text-transform:uppercase;letter-spacing:1px}
.box-objectif p{margin:0;color:var(--text);font-size:14px;line-height:1.5}

/* === COMP√âTENCES BOX === */
.box-competences{
  background:linear-gradient(135deg, #fef3c7, #fde68a);
  border-left:4px solid var(--warn);
  padding:16px;
  border-radius:0 var(--radius) var(--radius) 0;
  margin-bottom:14px;
}
.box-competences h3{color:#b45309;margin:0 0 12px;font-size:14px;text-transform:uppercase;letter-spacing:1px}
.comp-list{list-style:none;padding:0;margin:0}
.comp-list li{display:flex;align-items:flex-start;gap:10px;padding:6px 0;font-size:13px;color:var(--text)}
.comp-tag{background:var(--accent);color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;flex-shrink:0}

/* === SIGLE BOX === */
.sigle-box{
  background:#ede9fe;
  border:1px dashed #a78bfa;
  padding:12px;
  border-radius:12px;
  margin-top:12px;
  font-size:13px;
  line-height:1.5;
}
.sigle-box strong{color:var(--accent)}

/* === KEYWORD HIGHLIGHT === */
.keyword{
  background:#ede9fe;
  padding:2px 6px;
  border-radius:4px;
  color:#7c3aed;
  font-weight:600;
}

.exercise{margin-top:14px}
.exercise-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.exercise-title{display:flex;align-items:center;gap:10px}
.tag{display:inline-flex;align-items:center;gap:8px;background:#ede9fe;border:1px solid #c4b5fd;padding:8px 10px;border-radius:999px;font-size:12px;color:#7c3aed;font-weight:600}
.tag .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
.points{display:inline-flex;align-items:center;gap:10px}
.points .pill2{background:#f1f5f9;border:1px solid var(--line);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted);font-weight:600}
.hint{margin:10px 0 0;color:var(--muted);font-size:13px;background:#fef3c7;padding:10px 12px;border-radius:10px;border-left:3px solid var(--warn)}

.q{
  background:#f8fafc;
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
}
.q h3{margin:0 0 8px;font-size:14px;color:var(--text)}
.choice{display:flex;align-items:flex-start;gap:10px;padding:10px 10px;border-radius:14px;border:2px solid transparent;cursor:pointer}
.choice:hover{background:#f1f5f9;border-color:var(--line)}
.choice input{transform:translateY(2px);accent-color:var(--accent)}
.choice span{color:var(--text);font-size:13px;line-height:1.35}
textarea,input[type="text"]{
  width:100%;
  border-radius:14px;
  border:2px solid var(--line);
  background:white;
  color:var(--text);
  padding:12px 12px;
  font-size:14px;
  outline:none;
}
textarea{min-height:92px;resize:vertical}
textarea:focus,input[type="text"]:focus{border-color:var(--accent)}

.bank{
  margin-top:10px;
  border:2px dashed #c4b5fd;
  background:#faf5ff;
  border-radius:16px;
  padding:12px;
  min-height:58px;
}
.bank-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.bank-title{color:var(--accent);font-size:13px;font-weight:600}
.chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.chip{
  user-select:none;
  padding:10px 12px;
  border-radius:999px;
  border:2px solid var(--accent);
  background:white;
  color:var(--accent);
  font-size:13px;
  line-height:1;
  touch-action:manipulation;
  font-weight:600;
  box-shadow:0 2px 4px rgba(124,58,237,.1);
}
.chip[draggable="true"]{cursor:grab}
.chip.selected{background:var(--accent);color:white;box-shadow:0 4px 12px rgba(124,58,237,.3)}

.zone{
  border:2px dashed #c4b5fd;
  background:#faf5ff;
  border-radius:16px;
  min-height:66px;
  padding:10px;
}
.zone:hover{background:#f3e8ff}
.zone-title{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
.zone-title strong{font-size:13px;color:var(--accent)}
.zone-title span{color:var(--muted);font-size:12px}
.zone.over{border-color:var(--accent2); background:#d1fae5}
.zone .chips{margin-top:0}
.zone .chip{background:#ede9fe;border-color:#a78bfa}

.feedback{margin-top:10px;border-radius:16px;border:1px solid var(--line);padding:14px;background:#f8fafc;line-height:1.6}
.feedback.good{border-color:#86efac;background:#d1fae5}
.feedback.bad{border-color:#fca5a5;background:#fee2e2}
.feedback h4{margin:0 0 8px;font-size:14px;color:var(--text)}
.feedback p{margin:0;color:var(--text)}

.scorebar{
  position:sticky;top:0;z-index:20;
  backdrop-filter: blur(10px);
  background: rgba(255,255,255,.9);
  border-bottom:1px solid var(--line);
  box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.scorebar-inner{max-width:980px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.progress{flex:1;min-width:200px;height:10px;border-radius:999px;background:#e2e8f0;overflow:hidden;border:1px solid var(--line)}
.progress > div{height:100%;width:0%;background:linear-gradient(90deg, #7c3aed, #10b981)}
.scoretext{font-size:13px;color:var(--muted)}
.scoretext strong{color:var(--text)}

.toast{
  position:fixed;left:12px;right:12px;bottom:14px;max-width:980px;margin:0 auto;
  border:1px solid var(--line);border-radius:16px;padding:12px 14px;background:white;
  box-shadow:0 8px 24px rgba(0,0,0,.15);display:none
}
.toast.show{display:block}
.toast .t{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.toast .t p{margin:0;color:var(--muted)}
.toast .t strong{color:var(--text)}

@media(max-width:600px){
  .header{flex-direction:column}
  .pills{justify-content:flex-start}
  .scorebar-inner{flex-direction:column;align-items:stretch}
  .scoretext{text-align:center}
  .btnrow{justify-content:center}
}
</style>
</head>
<body>

<!-- ===== BARRE DE SCORE ===== -->
<div class="scorebar">
  <div class="scorebar-inner">
    <div class="scoretext">
      <strong id="scoreNow">0</strong> / <span id="scoreMax">0</span> points ¬∑
      <span id="doneCount">0</span>/<span id="totalCount">0</span> exercices corrig√©s
    </div>
    <div class="progress" aria-label="Progression"><div id="progressFill"></div></div>
    <div class="btnrow">
      <button class="secondary" id="resetAll">R√©initialiser</button>
      <button id="finalBtn">Voir mon r√©sultat</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Module C.2 ¬∑ Analyse de risque : Chute / tr√©buchement</h1>
        <div class="subtitle">PSE ‚Äì Baccalaur√©at Professionnel</div>
      </div>
    </div>

  </div>

  <!-- ===== OBJECTIF ===== -->
  <div class="card section">
    <div class="card-inner">
      <div class="box-objectif">
        <h3>üéØ Objectif ‚Äì √ätre capable de :</h3>
        <p>Analyser une situation de travail √† risque en utilisant le <strong>PAD</strong> (Processus d'Apparition du Dommage) et proposer des <strong>mesures de pr√©vention</strong> adapt√©es en les classant par ordre de priorit√©.</p>
      </div>

      <div class="box-competences">
        <h3>üìö Comp√©tences √©valu√©es</h3>
        <ul class="comp-list">
          <li><span class="comp-tag">C1</span> Traiter une information (extraire les √©l√©ments cl√©s du sc√©nario)</li>
          <li><span class="comp-tag">C2</span> Appliquer une d√©marche d'analyse (utiliser le PAD)</li>
          <li><span class="comp-tag">C4</span> Proposer des solutions (classer les mesures de pr√©vention)</li>
          <li><span class="comp-tag">C5</span> Argumenter un choix (justifier la mesure prioritaire)</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ===== DOCUMENTS RESSOURCES ===== -->
  <div class="card section">
    <div class="card-inner">
      <h2>üìÇ Documents ressources</h2>
      
      <div class="grid cols2">
        <div class="q">
          <h3>üìã Doc 1 ‚Äì Le PAD (Processus d'Apparition du Dommage)</h3>
          <p style="text-align:center;font-weight:600;color:var(--accent);margin:12px 0;background:#ede9fe;padding:10px;border-radius:10px;">
            DANGER ‚Üí SITUATION DANGEREUSE ‚Üí √âV√âNEMENT DANGEREUX ‚Üí DOMMAGE
          </p>
          <p><strong>Danger :</strong> Cause capable de provoquer une l√©sion (sol encombr√©, c√¢bles, gravats...)</p>
          <p><strong>Situation dangereuse :</strong> L'op√©rateur est expos√© au danger (circuler dans une zone encombr√©e)</p>
          <p><strong>√âv√©nement dangereux :</strong> Ce qui d√©clenche l'accident (tr√©buchement, chute)</p>
          <p><strong>Dommage :</strong> La l√©sion (entorse, fracture, contusion)</p>
          <div class="sigle-box">
            <strong>PAD</strong> = Processus d'Apparition du Dommage<br>
            C'est l'outil qui analyse comment un accident survient, √©tape par √©tape.
          </div>
        </div>

        <div class="q">
          <h3>üõ°Ô∏è Doc 2 ‚Äì Les 4 familles de pr√©vention</h3>
          <p><strong>1Ô∏è‚É£ Suppression / r√©duction</strong> = Agir √† la SOURCE (d√©gager, nettoyer, prot√©ger les saillies)</p>
          <p><strong>2Ô∏è‚É£ Protection collective</strong> = Prot√©ger TOUT LE MONDE (balisage, √©clairage, am√©nagement)</p>
          <p><strong>3Ô∏è‚É£ EPI</strong> = Prot√©ger UNE personne (chaussures antid√©rapantes, v√©rifier semelles)</p>
          <p><strong>4Ô∏è‚É£ Compl√©mentaires</strong> = Formation, consignes, information</p>
          <div class="sigle-box">
            <strong>EPI</strong> = √âquipement de Protection Individuelle<br>
            Exemples : casque, gants, lunettes, chaussures de s√©curit√©, bouchons d'oreille...
          </div>
        </div>
      </div>

      <div class="q" style="margin-top:12px">
        <h3>üìç Doc 3 ‚Äì Sc√©nario : accident sur un chantier</h3>
        <p style="color:var(--text);font-size:14px;line-height:1.6">
          Sur un chantier de construction, une <strong>zone de passage est encombr√©e</strong> : fers en attente qui d√©passent, gravats au sol, c√¢bles √©lectriques mal rang√©s.<br><br>
          Un salari√© doit traverser cette zone pour rejoindre son poste. Il ne voit pas un c√¢ble au sol, <strong>tr√©buche</strong> et <strong>chute</strong>.<br><br>
          R√©sultat : il se blesse √† la cheville ‚Üí <strong>entorse</strong>.
        </p>
      </div>
    </div>
  </div>

  <!-- ===== EXERCICE 1 ===== -->
  <div class="card section exercise" data-exo="exo1" data-max="8">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 1 ¬∑ Analyser avec le PAD</div>
          <div class="badge"><strong>8</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C1 / C2</div></div>
      </div>

      <div class="q" style="margin-top:12px">
        <p><strong>Consigne :</strong> D'apr√®s le sc√©nario (Doc 3), compl√®te les 4 √©tapes du PAD.</p>
        <div class="grid cols2" style="margin-top:10px">
          <div>
            <div class="small"><strong>1. DANGER</strong> (Qu'est-ce qui peut blesser ?)</div>
            <input type="text" id="p_danger" placeholder="Ex: sol glissant, objet tranchant...">
          </div>
          <div>
            <div class="small"><strong>2. SITUATION DANGEREUSE</strong> (Dans quelles conditions ?)</div>
            <input type="text" id="p_situation" placeholder="Ex: travailler pr√®s de...">
          </div>
          <div>
            <div class="small"><strong>3. √âV√âNEMENT DANGEREUX</strong> (Qu'est-ce qui d√©clenche ?)</div>
            <input type="text" id="p_event" placeholder="Ex: glissade, chute de...">
          </div>
          <div>
            <div class="small"><strong>4. DOMMAGE</strong> (Quelle blessure ?)</div>
            <input type="text" id="p_dommage" placeholder="Ex: fracture, br√ªlure...">
          </div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct">Corriger</button>
        <button class="secondary btn-reset">R√©initialiser</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <!-- ===== EXERCICE 2 ===== -->
  <div class="card section exercise" data-exo="exo2" data-max="10">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 2 ¬∑ Classer les mesures de pr√©vention</div>
          <div class="badge"><strong>10</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C2 / C4</div></div>
      </div>

      <p class="hint">üì± <strong>Sur t√©l√©phone :</strong> Touche une mesure (elle devient violette), puis touche la zone pour la d√©poser. Pour remettre une mesure dans la banque, touche-la dans la zone.</p>

      <div class="bank" data-bank="exo2">
        <div class="bank-head">
          <div class="bank-title"><strong>Banque de mesures</strong> (10)</div>
          <button class="secondary btn-reset" style="padding:10px 12px;border-radius:14px">R√©initialiser</button>
        </div>
        <div class="chips">
          <div class="chip" draggable="true" data-id="m1">D√©gager les zones de circulation (enlever obstacles)</div>
          <div class="chip" draggable="true" data-id="m2">Nettoyage r√©gulier (huile/eau) + √©vacuer les d√©chets</div>
          <div class="chip" draggable="true" data-id="m3">Balisage / signalisation des zones √† risque</div>
          <div class="chip" draggable="true" data-id="m4">Am√©nager les voies de circulation</div>
          <div class="chip" draggable="true" data-id="m5">√âclairage suffisant des zones de passage</div>
          <div class="chip" draggable="true" data-id="m6">Chaussures de s√©curit√© antid√©rapantes</div>
          <div class="chip" draggable="true" data-id="m7">Nouer ses lacets / v√©rifier les semelles</div>
          <div class="chip" draggable="true" data-id="m8">Former / sensibiliser (rangement, d√©placements)</div>
          <div class="chip" draggable="true" data-id="m9">Consignes + rappel des r√®gles de rangement</div>
          <div class="chip" draggable="true" data-id="m10">Prot√©ger les saillies (recourber/poser des bouchons)</div>
        </div>
      </div>

      <div class="grid cols2" style="margin-top:12px">
        <div class="zone" data-zone="suppr">
          <div class="zone-title"><strong>1Ô∏è‚É£ Suppression / r√©duction</strong><span>agir √† la SOURCE</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="collect">
          <div class="zone-title"><strong>2Ô∏è‚É£ Protection collective</strong><span>pour TOUS</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="epi">
          <div class="zone-title"><strong>3Ô∏è‚É£ EPI</strong><span>pour UNE personne</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="compl">
          <div class="zone-title"><strong>4Ô∏è‚É£ Compl√©mentaires</strong><span>formation / consignes</span></div>
          <div class="chips"></div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct">Corriger</button>
        <button class="secondary btn-reset">R√©initialiser</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <!-- ===== EXERCICE 3 ===== -->
  <div class="card section exercise" data-exo="exo3" data-max="8">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 3 ¬∑ Argumenter un choix (C5)</div>
          <div class="badge"><strong>8</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C5</div></div>
      </div>

      <div class="q" style="margin-top:12px">
        <p><strong>Question :</strong> Quelle action est la <strong>plus prioritaire</strong> pour r√©duire le risque de chute sur ce chantier ?</p>
        <label class="choice"><input type="radio" name="prio" value="a"><span>Distribuer des casques de chantier √† tous les salari√©s</span></label>
        <label class="choice"><input type="radio" name="prio" value="b"><span>D√©gager les obstacles + baliser les zones + organiser les circulations</span></label>
        <label class="choice"><input type="radio" name="prio" value="c"><span>Afficher une pancarte "Attention danger ‚Äì Sol encombr√©"</span></label>
        <hr class="sep">
        <p><strong>Argumente ton choix</strong> (explique POURQUOI cette mesure est prioritaire) :</p>
        <textarea id="prio_txt" placeholder="J'ai choisi cette mesure parce que..."></textarea>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct">Corriger</button>
        <button class="secondary btn-reset">R√©initialiser</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <!-- ===== R√âSULTAT ===== -->
  <div class="card section">
    <div class="card-inner">
      <h2>üìä R√©sultat final</h2>
      <div class="btnrow">
        <button class="secondary" id="openAllCorr">Afficher toutes les corrections</button>
        <button id="scrollTop">Revenir en haut</button>
      </div>
      <div id="finalBox" class="feedback" style="display:none;margin-top:12px"></div>
    </div>
  </div>

</div>

<!-- ===== TOAST ===== -->
<div class="toast" id="toast">
  <div class="t">
    <p id="toastMsg"><strong>OK</strong></p>
    <button class="secondary" id="toastClose" style="padding:8px 10px;border-radius:12px">Fermer</button>
  </div>
</div>

<script>
const state = {
  totalMax: 0,
  totalScore: 0,
  perExo: {},
  selectedChipId: null,
  selectedChipEl: null
};

function $(sel, root=document){return root.querySelector(sel)}
function $all(sel, root=document){return Array.from(root.querySelectorAll(sel))}

function toast(msg) {
  const t = $("#toast");
  $("#toastMsg").innerHTML = msg;
  t.classList.add("show");
  window.clearTimeout(t._timer);
  t._timer = window.setTimeout(()=>t.classList.remove("show"), 3000);
}
$("#toastClose").addEventListener("click", ()=>$("#toast").classList.remove("show"));

function normalizeBase(s) {
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .replace(/['']/g,"'")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

function hasAny(text, keywords){
  const t = normalizeBase(text);
  return keywords.some(k => t.includes(normalizeBase(k)));
}

function updateTopBar() {
  const max = state.totalMax;
  let score = 0;
  let done = 0;
  for (const v of Object.values(state.perExo)) {
    score += (v.score||0);
    if (v.done) done++;
  }
  state.totalScore = score;
  $("#scoreNow").textContent = score;
  $("#scoreMax").textContent = max;
  $("#doneCount").textContent = done;
  $("#totalCount").textContent = Object.keys(state.perExo).length;
  const pct = max ? Math.round((score/max)*100) : 0;
  $("#progressFill").style.width = pct + "%";
}

function markDone(exId, score, max) {
  state.perExo[exId] = state.perExo[exId] || {max};
  state.perExo[exId].score = score;
  state.perExo[exId].done = true;
  updateTopBar();
}

function makeFeedback(el, ok, title, html) {
  el.classList.remove("good","bad");
  el.classList.add(ok ? "good" : "bad");
  el.innerHTML = `<h4>${title}</h4><p>${html}</p>`;
  el.style.display = "block";
}

function resetSelection() {
  if (state.selectedChipEl) state.selectedChipEl.classList.remove("selected");
  state.selectedChipEl = null;
  state.selectedChipId = null;
}

function enableDnD(root=document) {
  $all(".chip[draggable='true']", root).forEach(chip => {
    chip.addEventListener("dragstart", (e)=>{
      e.dataTransfer.setData("text/plain", chip.dataset.id);
      e.dataTransfer.effectAllowed="move";
      resetSelection();
    });
  });

  $all(".zone, .bank", root).forEach(zone => {
    zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("over"); });
    zone.addEventListener("dragleave", ()=>zone.classList.remove("over"));
    zone.addEventListener("drop", (e)=>{
      e.preventDefault();
      zone.classList.remove("over");
      const id = e.dataTransfer.getData("text/plain");
      if (!id) return;
      const chip = root.querySelector(`.chip[data-id="${CSS.escape(id)}"]`);
      if (!chip) return;
      const wrap = zone.querySelector(".chips") || zone;
      wrap.appendChild(chip);
    });
  });

  // tap-to-place pour mobile
  $all(".chip", root).forEach(chip => {
    chip.setAttribute("role","button");
    chip.setAttribute("tabindex","0");
    chip.addEventListener("click", ()=>{
      const ex = chip.closest("[data-exo]");
      const bank = ex?.querySelector(".bank .chips");
      const inZone = chip.closest(".zone");
      if (!state.selectedChipId) {
        if (inZone && bank) {
          bank.appendChild(chip);
          return;
        }
      }
      if (state.selectedChipId === chip.dataset.id) {
        resetSelection();
      } else {
        resetSelection();
        state.selectedChipId = chip.dataset.id;
        state.selectedChipEl = chip;
        chip.classList.add("selected");
      }
    });

    chip.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        chip.click();
      }
    });
  });

  $all(".zone, .bank", root).forEach(zone => {
    zone.setAttribute("tabindex","0");
    zone.addEventListener("click", (e)=>{
      if (e.target.classList.contains("chip")) return;
      if (!state.selectedChipId || !state.selectedChipEl) return;
      const wrap = zone.querySelector(".chips") || zone;
      wrap.appendChild(state.selectedChipEl);
      resetSelection();
    });
    zone.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        zone.click();
      }
    });
  });
}

function resetAll(root=document) {
  $all("input[type='radio']", root).forEach(r=>r.checked=false);
  $all("textarea, input[type='text']", root).forEach(t=>t.value="");
  $all("[data-exo]", root).forEach(ex=>{
    const bank = ex.querySelector(".bank .chips");
    if (!bank) return;
    $all(".chip", ex).forEach(ch=>bank.appendChild(ch));
  });
  $all(".feedback", root).forEach(f=>{ if (f.id!=="finalBox") f.style.display="none"; });
  $("#finalBox").style.display="none";
  for (const [k,v] of Object.entries(state.perExo)) {
    state.perExo[k] = {max: v.max, score:0, done:false};
  }
  resetSelection();
  updateTopBar();
  toast("<strong>R√©initialis√©</strong> ¬∑ Tu peux recommencer.");
}

// =====================================================
// EXERCICE 1 - PAD
// =====================================================
function wireExo1(){
  const ex = document.querySelector("[data-exo='exo1']");
  const fb = ex.querySelector(".feedback");
  
  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    let score=0;
    const d = $("#p_danger").value;
    const s = $("#p_situation").value;
    const e = $("#p_event").value;
    const dom = $("#p_dommage").value;

    if (hasAny(d, ["sol encombre","obstacle","fer saillant","saillie","cable","gravats","trou","sol glissant","encombre","desordre"])) score+=2;
    if (hasAny(s, ["circuler","se deplacer","passage","zone encombre","chantier","transport","marcher","traverser"])) score+=2;
    if (hasAny(e, ["trebuche","trebuchement","chute","glissade","heurte","tombe","perd equilibre"])) score+=2;
    if (hasAny(dom, ["entorse","fracture","blessure","lesion","traumatisme","contusion","foulure"])) score+=2;

    const html = `
      <strong>Score : ${score}/8</strong><br><br>
      <strong>Correction avec le <span class="keyword">PAD</span> :</strong><br><br>
      <strong>1. DANGER :</strong> <span class="keyword">Zone encombr√©e</span> (fers en attente, gravats, c√¢bles au sol)<br><br>
      <strong>2. SITUATION DANGEREUSE :</strong> <span class="keyword">Circuler / se d√©placer</span> dans une zone de passage encombr√©e<br><br>
      <strong>3. √âV√âNEMENT DANGEREUX :</strong> <span class="keyword">Tr√©buchement</span> sur un c√¢ble ‚Üí <span class="keyword">Chute</span><br><br>
      <strong>4. DOMMAGE :</strong> <span class="keyword">Entorse</span> √† la cheville (ou fracture, contusion)
      <div class="sigle-box" style="margin-top:12px">
        <strong>üí° √Ä RETENIR :</strong> Le <strong>PAD</strong> (Processus d'Apparition du Dommage) permet d'analyser un accident en identifiant : la CAUSE (danger) ‚Üí l'EXPOSITION (situation) ‚Üí le D√âCLENCHEUR (√©v√©nement) ‚Üí la CONS√âQUENCE (dommage).
      </div>
    `;
    makeFeedback(fb, score>=6, "‚úÖ Correction ‚Äì Exercice 1", html);
    markDone("exo1", score, 8);
  });

  ex.querySelector(".btn-reset").addEventListener("click", ()=>{
    ["p_danger","p_situation","p_event","p_dommage"].forEach(id=>$("#"+id).value="");
    fb.style.display="none";
    state.perExo["exo1"]={max:8, score:0, done:false};
    updateTopBar();
  });
}

// =====================================================
// EXERCICE 2 - CLASSEMENT
// =====================================================
function wireExo2(){
  const ex = document.querySelector("[data-exo='exo2']");
  const fb = ex.querySelector(".feedback");
  const correct = {
    m1:"suppr",
    m2:"suppr",
    m10:"suppr",
    m3:"collect",
    m4:"collect",
    m5:"collect",
    m6:"epi",
    m7:"epi",
    m8:"compl",
    m9:"compl"
  };

  function compute(){
    let score=0;
    for (const [id,zone] of Object.entries(correct)){
      const chip = ex.querySelector(`.chip[data-id="${CSS.escape(id)}"]`);
      const z = chip?.closest(".zone")?.dataset.zone || "bank";
      if (z===zone) score++;
    }
    return score;
  }

  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    const score = compute();
    const html = `
      <strong>Score : ${score}/10</strong><br><br>
      <strong>Correction :</strong><br><br>
      <strong>1Ô∏è‚É£ SUPPRESSION / R√âDUCTION (source) :</strong><br>
      ‚Ä¢ <span class="keyword">D√©gager les zones de circulation</span><br>
      ‚Ä¢ <span class="keyword">Nettoyage r√©gulier</span> (huile, eau)<br>
      ‚Ä¢ <span class="keyword">Prot√©ger les saillies</span> (fers en attente)<br><br>
      <strong>2Ô∏è‚É£ PROTECTION COLLECTIVE (pour tous) :</strong><br>
      ‚Ä¢ <span class="keyword">Balisage / signalisation</span><br>
      ‚Ä¢ <span class="keyword">Am√©nager les voies</span> de circulation<br>
      ‚Ä¢ <span class="keyword">√âclairage suffisant</span><br><br>
      <strong>3Ô∏è‚É£ EPI (pour une personne) :</strong><br>
      ‚Ä¢ <span class="keyword">Chaussures antid√©rapantes</span><br>
      ‚Ä¢ <span class="keyword">V√©rifier ses semelles</span><br><br>
      <strong>4Ô∏è‚É£ COMPL√âMENTAIRES (formation) :</strong><br>
      ‚Ä¢ <span class="keyword">Former / sensibiliser</span><br>
      ‚Ä¢ <span class="keyword">Consignes de rangement</span>
      <div class="sigle-box" style="margin-top:12px">
        <strong>üí° √Ä RETENIR :</strong> On applique les mesures dans l'ordre de priorit√© : <strong>1 ‚Üí 2 ‚Üí 3 ‚Üí 4</strong>. Les mesures √† la <strong>SOURCE</strong> sont toujours prioritaires car elles √©liminent le danger pour tout le monde !<br><br>
        <strong>EPI</strong> = √âquipement de Protection Individuelle
      </div>
    `;
    makeFeedback(fb, score>=8, "‚úÖ Correction ‚Äì Exercice 2", html);
    markDone("exo2", score, 10);
  });

  ex.querySelectorAll(".btn-reset").forEach(btn=>btn.addEventListener("click", ()=>{
    const bank = ex.querySelector(".bank .chips");
    ex.querySelectorAll(".chip").forEach(ch=>bank.appendChild(ch));
    fb.style.display="none";
    state.perExo["exo2"]={max:10, score:0, done:false};
    updateTopBar();
    resetSelection();
  }));
}

// =====================================================
// EXERCICE 3 - ARGUMENTATION
// =====================================================
function wireExo3(){
  const ex = document.querySelector("[data-exo='exo3']");
  const fb = ex.querySelector(".feedback");
  
  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    let score=0;
    const v = (ex.querySelector("input[name='prio']:checked")||{}).value;
    const txt = $("#prio_txt").value;

    if (v==="b") score += 4;
    if (txt.trim().length >= 40) score += 2;
    if (hasAny(txt, ["source","supprimer","reduire","circulation","obstacle","balis","organis","collectif","probabilite","eviter","cause","danger","elimine","tous","tout le monde"])) score += 2;

    const html = `
      <strong>Score : ${score}/8</strong><br><br>
      <strong>Bonne r√©ponse :</strong> <span class="keyword">D√©gager les obstacles + baliser + organiser les circulations</span><br><br>
      <strong>Pourquoi cette r√©ponse ?</strong><br><br>
      <strong>1.</strong> C'est une mesure de <span class="keyword">SUPPRESSION √† la SOURCE</span> (famille n¬∞1) : on √©limine le danger (les obstacles).<br><br>
      <strong>2.</strong> C'est aussi une <span class="keyword">PROTECTION COLLECTIVE</span> (famille n¬∞2) : le balisage et l'organisation prot√®gent <strong>tous les salari√©s</strong>, pas seulement une personne.<br><br>
      <strong>3.</strong> Ces mesures agissent sur la <strong>CAUSE</strong> de l'accident (la zone encombr√©e).<br><br>
      <strong>Pourquoi pas les autres ?</strong><br>
      ‚Ä¢ Les <strong>casques</strong> ne prot√®gent pas contre les chutes de plain-pied (ils prot√®gent la t√™te contre les chutes d'objets).<br>
      ‚Ä¢ L'<strong>affiche seule</strong> est une mesure compl√©mentaire (famille n¬∞4) : elle informe mais ne supprime pas le danger.
      <div class="sigle-box" style="margin-top:12px">
        <strong>üí° √Ä RETENIR pour argumenter (C5) :</strong><br>
        On privil√©gie TOUJOURS les mesures qui :<br>
        ‚Ä¢ Agissent √† la <strong>SOURCE</strong> du danger (supprimer/r√©duire)<br>
        ‚Ä¢ Prot√®gent <strong>TOUT LE MONDE</strong> (collectif)<br>
        ‚Ä¢ S'attaquent √† la <strong>CAUSE</strong> et non aux cons√©quences
      </div>
    `;
    makeFeedback(fb, score>=6, "‚úÖ Correction ‚Äì Exercice 3", html);
    markDone("exo3", score, 8);
  });

  ex.querySelector(".btn-reset").addEventListener("click", ()=>{
    ex.querySelectorAll("input[name='prio']").forEach(r=>r.checked=false);
    $("#prio_txt").value="";
    fb.style.display="none";
    state.perExo["exo3"]={max:8, score:0, done:false};
    updateTopBar();
  });
}

// =====================================================
// INIT
// =====================================================
document.addEventListener("DOMContentLoaded", ()=>{
  state.totalMax = 0;
  $all("[data-exo]").forEach(ex=>{
    const id = ex.dataset.exo;
    const max = parseInt(ex.dataset.max,10) || 0;
    state.perExo[id] = {max, score:0, done:false};
    state.totalMax += max;
  });
  $("#scoreMax").textContent = state.totalMax;

  enableDnD(document);
  wireExo1();
  wireExo2();
  wireExo3();
  updateTopBar();

  $("#resetAll").addEventListener("click", ()=>resetAll(document));
  $("#scrollTop").addEventListener("click", ()=>window.scrollTo({top:0, behavior:"smooth"}));

  $("#openAllCorr").addEventListener("click", ()=>{
    $all("[data-exo]").forEach(ex=>{
      const btn = ex.querySelector(".btn-correct");
      if (btn) btn.click();
    });
    toast("<strong>Corrections affich√©es</strong> ¬∑ Lis attentivement les explications.");
  });

  $("#finalBtn").addEventListener("click", ()=>{
    const max = state.totalMax;
    let score = 0, done=0;
    for (const v of Object.values(state.perExo)) {
      score += (v.score||0);
      if (v.done) done++;
    }
    const pct = max ? Math.round((score/max)*100) : 0;
    const msg = (done < Object.keys(state.perExo).length)
      ? `Tu as corrig√© <strong>${done}</strong> exercice(s) sur <strong>${Object.keys(state.perExo).length}</strong>.`
      : `Tous les exercices sont corrig√©s.`;
    
    let level, advice;
    if (pct >= 80) {
      level = "üèÜ Tr√®s bien ma√Ætris√©";
      advice = "Tu ma√Ætrises l'analyse de risque avec le PAD et le classement des mesures de pr√©vention.";
    } else if (pct >= 60) {
      level = "üëç Correct";
      advice = "Revois les corrections pour consolider tes connaissances, notamment l'ordre de priorit√© des mesures.";
    } else if (pct >= 40) {
      level = "üìö √Ä renforcer";
      advice = "Relis les documents et les corrections. Retiens : PAD (Danger ‚Üí Situation ‚Üí √âv√©nement ‚Üí Dommage) et priorit√© (Source ‚Üí Collectif ‚Üí EPI ‚Üí Formation).";
    } else {
      level = "‚ö†Ô∏è √Ä reprendre";
      advice = "Reprends le cours sur le PAD et les 4 familles de pr√©vention avant de refaire l'exercice.";
    }
    
    const box = $("#finalBox");
    box.classList.remove("good","bad");
    box.classList.add(pct>=60 ? "good" : "bad");
    box.style.display="block";
    box.innerHTML = `<h4>Score final : ${score} / ${max} (${pct}%)</h4><p>${msg}<br><br><strong>${level}</strong><br>${advice}</p>`;
    box.scrollIntoView({behavior:"smooth", block:"center"});
  });
});
</script>
</body>
</html>
