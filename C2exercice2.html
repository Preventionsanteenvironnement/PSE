<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Analyse de risque au travail · Chute / trébuchement</title>
<style>
:root{
  --bg0:#0b1220; --bg1:#09101c; --card:#0f1b2e; --card2:#0c1728;
  --text:#e9f0ff; --muted:#a9b7d6; --line:rgba(255,255,255,.10);
  --accent:#6d5efc; --accent2:#1fd1a1; --danger:#ff5b7c; --warn:#ffd36b;
  --ok:#42e38e;
  --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  color:var(--text);
  background:
    radial-gradient(1200px 800px at 20% -10%, rgba(109,94,252,.22), transparent 55%),
    radial-gradient(900px 700px at 90% 0%, rgba(31,209,161,.18), transparent 50%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}
.container{max-width:980px;margin:0 auto;padding:20px 16px 42px}
.header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin:10px 0 18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:14px;background:
  radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%),
  linear-gradient(135deg, rgba(109,94,252,.9), rgba(31,209,161,.7));
  box-shadow: 0 12px 30px rgba(0,0,0,.35);
}
h1{font-size:20px;line-height:1.15;margin:0}
.subtitle{color:var(--muted);font-size:13px;margin-top:6px}
.pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pill{border:1px solid var(--line);background:rgba(255,255,255,.04);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted)}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line); border-radius:var(--radius);
  box-shadow: 0 14px 35px rgba(0,0,0,.25);
}
.card-inner{padding:16px}
.section{margin:14px 0}
h2{font-size:16px;margin:0 0 10px}
p{margin:10px 0;color:var(--muted);line-height:1.45}
hr.sep{border:none;border-top:1px solid var(--line);margin:14px 0}

.grid{display:grid;gap:12px}
@media (min-width:860px){ .grid.cols2{grid-template-columns: 1fr 1fr} }

.btnrow{display:flex;gap:10px;flex-wrap:wrap}
button{
  appearance:none;border:none;cursor:pointer;
  padding:12px 14px;border-radius:14px;
  background:linear-gradient(135deg, rgba(109,94,252,.9), rgba(31,209,161,.75));
  color:#07111f;font-weight:800;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
}
button.secondary{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--text);
  font-weight:700;
}
button:active{transform:translateY(1px)}
.small{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:var(--muted);font-size:12px}
.badge strong{color:var(--text)}

.exercise{margin-top:14px}
.exercise-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.exercise-title{display:flex;align-items:center;gap:10px}
.tag{display:inline-flex;align-items:center;gap:8px;background:rgba(109,94,252,.14);border:1px solid rgba(109,94,252,.35);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
.tag .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
.points{display:inline-flex;align-items:center;gap:10px}
.points .pill2{background:rgba(255,255,255,.06);border:1px solid var(--line);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
.hint{margin:10px 0 0;color:var(--muted);font-size:13px}

.q{
  background:rgba(0,0,0,.12);
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
}
.q h3{margin:0 0 8px;font-size:14px}
.choice{display:flex;align-items:flex-start;gap:10px;padding:10px 10px;border-radius:14px;border:1px solid transparent}
.choice:hover{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.06)}
.choice input{transform:translateY(2px)}
.choice span{color:var(--text);font-size:13px;line-height:1.35}
textarea,input[type="text"]{
  width:100%;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  color:var(--text);
  padding:12px 12px;
  font-size:14px;
  outline:none;
}
textarea{min-height:92px;resize:vertical}
.kbd{
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  padding:2px 6px;
  border-radius:8px;
  color:var(--text);
  font-size:12px
}

.bank{
  margin-top:10px;
  border:1px dashed rgba(255,255,255,.22);
  background:rgba(255,255,255,.03);
  border-radius:16px;
  padding:12px;
  min-height:58px;
}
.bank-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.bank-title{color:var(--muted);font-size:13px}
.chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.chip{
  user-select:none;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  color:var(--text);
  font-size:13px;
  line-height:1;
  touch-action:manipulation;
}
.chip[draggable="true"]{cursor:grab}
.chip.selected{outline:2px solid rgba(109,94,252,.75); background:rgba(109,94,252,.18)}

.zone{
  border:2px dashed rgba(109,94,252,.35);
  background:rgba(109,94,252,.07);
  border-radius:16px;
  min-height:66px;
  padding:10px;
}
.zone-title{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
.zone-title strong{font-size:13px}
.zone-title span{color:var(--muted);font-size:12px}
.zone.over{border-color:rgba(31,209,161,.55); background:rgba(31,209,161,.10)}
.zone .chips{margin-top:0}
.zone .chip{background:rgba(255,255,255,.06)}

.feedback{margin-top:10px;border-radius:16px;border:1px solid var(--line);padding:12px;background:rgba(255,255,255,.04)}
.feedback.good{border-color:rgba(66,227,142,.35);background:rgba(66,227,142,.10)}
.feedback.bad{border-color:rgba(255,91,124,.35);background:rgba(255,91,124,.10)}
.feedback h4{margin:0 0 6px;font-size:13px}
.feedback p{margin:0;color:var(--muted)}

.scorebar{
  position:sticky;top:0;z-index:20;
  backdrop-filter: blur(10px);
  background: rgba(9,16,28,.65);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.scorebar-inner{max-width:980px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.progress{flex:1;min-width:200px;height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
.progress > div{height:100%;width:0%;background:linear-gradient(90deg, rgba(109,94,252,.95), rgba(31,209,161,.9))}
.scoretext{font-size:13px;color:var(--muted)}
.scoretext strong{color:var(--text)}

.toast{
  position:fixed;left:12px;right:12px;bottom:14px;max-width:980px;margin:0 auto;
  border:1px solid var(--line);border-radius:16px;padding:12px 14px;background:rgba(9,16,28,.85);
  box-shadow:0 16px 40px rgba(0,0,0,.35);display:none
}
.toast.show{display:block}
.toast .t{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.toast .t p{margin:0;color:var(--muted)}
.toast .t strong{color:var(--text)}
</style>
</head>
<body>
<div class="scorebar">
  <div class="scorebar-inner">
    <div class="scoretext">
      <strong id="scoreNow">0</strong> / <span id="scoreMax">0</span> points ·
      <span id="doneCount">0</span>/<span id="totalCount">0</span> exercices corrigés
    </div>
    <div class="progress" aria-label="Progression"><div id="progressFill"></div></div>
    <div class="btnrow">
      <button class="secondary" id="resetAll">Réinitialiser</button>
      <button id="finalBtn">Voir mon résultat</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Analyse de risque au travail · Chute / trébuchement</h1>
        <div class="subtitle">Plain-pied : repérer le processus et classer les mesures de prévention</div>
      </div>
    </div>
    <div class="pills">
      <div class="pill">Mobile + PC</div>
      <div class="pill">Auto-correction</div>
      <div class="pill">Mode téléphone : toucher pour placer</div>
    </div>
  </div>

  <!-- Identification RGPD-friendly -->
  <div class="card section">
    <div class="card-inner">
      <h2>Identification anonyme</h2>
      <p class="small">
        Indique ta <strong>classe</strong> et ton <strong>code élève</strong> (ex : C2-07).
        Ces informations servent uniquement à envoyer ta copie au professeur.
      </p>
      <div class="grid cols2" style="margin-top:10px">
        <div>
          <div class="small">Classe</div>
          <input type="text" id="meta_classe" placeholder="ex : 1CAP PSR" autocomplete="off">
        </div>
        <div>
          <div class="small">Code élève</div>
          <input type="text" id="meta_code" placeholder="ex : C2-07" autocomplete="off">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-inner">
      <h2>Thème : risques de chute / trébuchement (plain-pied)</h2>
      <p>Objectif : analyser une situation de travail, puis classer des <strong>mesures de prévention</strong> (suppression/réduction, collective, EPI, complémentaires).</p>
      <div class="grid cols2">
        <div class="q">
          <h3>Familles de prévention</h3>
          <p><strong>1) Suppression / réduction du danger</strong> : agir à la source.</p>
          <p><strong>2) Protection collective</strong> : protéger tout le monde.</p>
          <p><strong>3) Protection individuelle (EPI)</strong> : protéger la personne.</p>
          <p><strong>4) Mesures complémentaires</strong> : formation, consignes, information.</p>
        </div>
        <div class="q">
          <h3>Mini scénario (chantier)</h3>
          <p>Une zone de passage est encombrée (fers en attente, gravats, câbles). Un salarié trébuche et chute. Il se blesse.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card section exercise" data-exo="exo1" data-max="8">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 1 · Repérer les éléments</div>
          <div class="badge"><strong>8</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C2</div></div>
      </div>

      <div class="q">
        <p><strong>Consigne</strong> : complète avec une expression courte.</p>
        <div class="grid cols2" style="margin-top:10px">
          <div>
            <div class="small">Danger</div>
            <input type="text" id="p_danger" placeholder="">
          </div>
          <div>
            <div class="small">Situation dangereuse</div>
            <input type="text" id="p_situation" placeholder="">
          </div>
          <div>
            <div class="small">Événement dangereux</div>
            <input type="text" id="p_event" placeholder="">
          </div>
          <div>
            <div class="small">Dommage</div>
            <input type="text" id="p_dommage" placeholder="">
          </div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct">Corriger</button>
        <button class="secondary btn-reset">Réinitialiser cet exercice</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <div class="card section exercise" data-exo="exo2" data-max="10">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 2 · Classer les mesures</div>
          <div class="badge"><strong>10</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C2 / C4</div></div>
      </div>

      <p class="hint">Classe chaque mesure dans la bonne famille.</p>

      <div class="bank" data-bank="exo2">
        <div class="bank-head">
          <div class="bank-title"><strong>Banque de mesures</strong> (10)</div>
          <button class="secondary btn-reset" style="padding:10px 12px;border-radius:14px">Réinitialiser</button>
        </div>
        <div class="chips">
          <div class="chip" draggable="true" data-id="m1">Dégager les zones de circulation (enlever obstacles)</div>
          <div class="chip" draggable="true" data-id="m2">Nettoyage régulier (huile/eau) + évacuer les déchets</div>
          <div class="chip" draggable="true" data-id="m3">Balisage / signalisation des zones à risque</div>
          <div class="chip" draggable="true" data-id="m4">Aménager les voies de circulation</div>
          <div class="chip" draggable="true" data-id="m5">Éclairage suffisant des zones de passage</div>
          <div class="chip" draggable="true" data-id="m6">Chaussures de sécurité antidérapantes</div>
          <div class="chip" draggable="true" data-id="m7">Nouer ses lacets / vérifier les semelles</div>
          <div class="chip" draggable="true" data-id="m8">Former / sensibiliser (rangement, déplacements)</div>
          <div class="chip" draggable="true" data-id="m9">Consignes + rappel des règles de rangement</div>
          <div class="chip" draggable="true" data-id="m10">Protéger les saillies (recourber/poser des bouchons)</div>
        </div>
      </div>

      <div class="grid cols2" style="margin-top:12px">
        <div class="zone" data-zone="suppr">
          <div class="zone-title"><strong>Suppression / réduction</strong><span>agir à la source</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="collect">
          <div class="zone-title"><strong>Protection collective</strong><span>pour tous</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="epi">
          <div class="zone-title"><strong>EPI</strong><span>pour la personne</span></div>
          <div class="chips"></div>
        </div>
        <div class="zone" data-zone="compl">
          <div class="zone-title"><strong>Complémentaires</strong><span>formation / consignes</span></div>
          <div class="chips"></div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct">Corriger</button>
        <button class="secondary btn-reset">Réinitialiser cet exercice</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <div class="card section exercise" data-exo="exo3" data-max="8">
    <div class="card-inner">
      <div class="exercise-head">
        <div class="exercise-title">
          <div class="tag"><span class="dot"></span>Exercice 3 · Choisir une priorité</div>
          <div class="badge"><strong>8</strong> points</div>
        </div>
        <div class="points"><div class="pill2">C5</div></div>
      </div>

      <div class="q">
        <p>Quelle action est la plus prioritaire pour réduire le risque de chute ?</p>
        <label class="choice"><input type="radio" name="prio" value="a"><span>Distribuer des casques à tout le monde</span></label>
        <label class="choice"><input type="radio" name="prio" value="b"><span>Dégager + baliser + organiser les zones de circulation</span></label>
        <label class="choice"><input type="radio" name="prio" value="c"><span>Mettre une affiche “attention danger”</span></label>
        <hr class="sep">
        <p><strong>Argumente</strong> (2 phrases)</p>
        <textarea id="prio_txt" placeholder="J’ai choisi… parce que…"></textarea>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn-correct">Corriger</button>
        <button class="secondary btn-reset">Réinitialiser cet exercice</button>
      </div>
      <div class="feedback" style="display:none"></div>
    </div>
  </div>

  <div class="card section">
    <div class="card-inner">
      <h2>Résultat</h2>
      <p class="small">
        Conseil : sur téléphone, si tu ne peux pas faire un glisser-déposer,
        utilise le mode toucher : touche un chip (il devient violet), puis touche une zone pour le déposer.
      </p>
      <div class="btnrow">
        <button class="secondary" id="openAllCorr">Afficher toutes les corrections</button>
        <button id="scrollTop">Revenir en haut</button>
        <button id="sendFirebase">Envoyer ma copie</button>
      </div>
      <div id="finalBox" class="feedback" style="display:none;margin-top:12px"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="t">
    <p id="toastMsg"><strong>OK</strong></p>
    <button class="secondary" id="toastClose" style="padding:8px 10px;border-radius:12px">Fermer</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
  authDomain: "devoirs-pse.firebaseapp.com",
  projectId: "devoirs-pse",
  storageBucket: "devoirs-pse.firebasestorage.app",
  messagingSenderId: "614730413904",
  appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const copiesCol = collection(db, "bacpro");

const STORAGE_KEY = "pse_chute_plainpied_v1";

const state = {
  totalMax: 0,
  totalScore: 0,
  perExo: {},
  selectedChipId: null,
  selectedChipEl: null
};

function $(sel, root=document){return root.querySelector(sel)}
function $all(sel, root=document){return Array.from(root.querySelectorAll(sel))}

function toast(msg) {
  const t = $("#toast");
  $("#toastMsg").innerHTML = msg;
  t.classList.add("show");
  window.clearTimeout(t._timer);
  t._timer = window.setTimeout(()=>t.classList.remove("show"), 2600);
}
$("#toastClose").addEventListener("click", ()=>$("#toast").classList.remove("show"));

function normalizeBase(s) {
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .replace(/[’']/g,"'")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

function hasAny(text, keywords){
  const t = normalizeBase(text);
  return keywords.some(k => t.includes(normalizeBase(k)));
}

function updateTopBar() {
  const max = state.totalMax;
  let score = 0;
  let done = 0;
  for (const v of Object.values(state.perExo)) {
    score += (v.score||0);
    if (v.done) done++;
  }
  state.totalScore = score;
  $("#scoreNow").textContent = score;
  $("#scoreMax").textContent = max;
  $("#doneCount").textContent = done;
  $("#totalCount").textContent = Object.keys(state.perExo).length;
  const pct = max ? Math.round((score/max)*100) : 0;
  $("#progressFill").style.width = pct + "%";
}

function markDone(exId, score, max) {
  state.perExo[exId] = state.perExo[exId] || {max};
  state.perExo[exId].score = score;
  state.perExo[exId].done = true;
  updateTopBar();
  saveState();
}

function makeFeedback(el, ok, title, html) {
  el.classList.remove("good","bad");
  el.classList.add(ok ? "good" : "bad");
  el.innerHTML = `<h4>${title}</h4><p>${html}</p>`;
  el.style.display = "block";
  saveState();
}

function resetSelection() {
  if (state.selectedChipEl) state.selectedChipEl.classList.remove("selected");
  state.selectedChipEl = null;
  state.selectedChipId = null;
  saveState();
}

function enableDnD(root=document) {
  $all(".chip[draggable='true']", root).forEach(chip => {
    chip.addEventListener("dragstart", (e)=>{
      e.dataTransfer.setData("text/plain", chip.dataset.id);
      e.dataTransfer.effectAllowed="move";
      resetSelection();
    });
  });

  $all(".zone, .bank", root).forEach(zone => {
    zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("over"); });
    zone.addEventListener("dragleave", ()=>zone.classList.remove("over"));
    zone.addEventListener("drop", (e)=>{
      e.preventDefault();
      zone.classList.remove("over");
      const id = e.dataTransfer.getData("text/plain");
      if (!id) return;
      const chip = root.querySelector(`.chip[data-id="${CSS.escape(id)}"]`);
      if (!chip) return;
      const max = zone.dataset.max ? parseInt(zone.dataset.max,10) : null;
      const wrap = zone.querySelector(".chips") || zone;
      if (max && wrap.querySelectorAll(".chip").length >= max) {
        toast("Cette zone est déjà remplie.");
        return;
      }
      wrap.appendChild(chip);
      saveState();
    });
  });

  // tap-to-place
  $all(".chip", root).forEach(chip => {
    chip.setAttribute("role","button");
    chip.setAttribute("tabindex","0");
    chip.addEventListener("click", ()=>{
      const ex = chip.closest("[data-exo]");
      const bank = ex?.querySelector(".bank .chips");
      const inZone = chip.closest(".zone");
      if (!state.selectedChipId) {
        if (inZone && bank) {
          bank.appendChild(chip);
          saveState();
          return;
        }
      }
      if (state.selectedChipId === chip.dataset.id) {
        resetSelection();
      } else {
        resetSelection();
        state.selectedChipId = chip.dataset.id;
        state.selectedChipEl = chip;
        chip.classList.add("selected");
        saveState();
      }
    });

    chip.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        chip.click();
      }
    });
  });

  $all(".zone, .bank", root).forEach(zone => {
    zone.setAttribute("tabindex","0");
    zone.addEventListener("click", (e)=>{
      if (e.target.classList.contains("chip")) return;
      if (!state.selectedChipId || !state.selectedChipEl) return;
      const max = zone.dataset.max ? parseInt(zone.dataset.max,10) : null;
      const wrap = zone.querySelector(".chips") || zone;
      if (max && wrap.querySelectorAll(".chip").length >= max) {
        toast("Cette zone est déjà remplie.");
        return;
      }
      wrap.appendChild(state.selectedChipEl);
      resetSelection();
      saveState();
    });
    zone.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        zone.click();
      }
    });
  });
}

function snapshotChipsByExo(){
  const out = {};
  $all("[data-exo]").forEach(ex=>{
    const exId = ex.dataset.exo;
    const zones = {};
    const bankWrap = ex.querySelector(".bank .chips");
    if (bankWrap) zones.bank = [];

    $all(".zone", ex).forEach(z=>{
      const k = z.dataset.zone || "zone";
      zones[k] = [];
      const wrap = z.querySelector(".chips") || z;
      $all(".chip", wrap).forEach(ch=>zones[k].push(ch.dataset.id));
    });

    if (bankWrap){
      $all(".chip", bankWrap).forEach(ch=>zones.bank.push(ch.dataset.id));
    }
    out[exId] = zones;
  });
  return out;
}

function restoreChipsByExo(data){
  if (!data) return;

  $all("[data-exo]").forEach(ex=>{
    const exId = ex.dataset.exo;
    const zones = data[exId];
    if (!zones) return;

    const byId = {};
    $all(".chip", ex).forEach(ch=>{ byId[ch.dataset.id] = ch; });

    Object.entries(zones).forEach(([zoneKey, ids])=>{
      const idsArr = Array.isArray(ids) ? ids : [];
      let wrap = null;

      if (zoneKey === "bank") {
        wrap = ex.querySelector(".bank .chips");
      } else {
        const z = ex.querySelector(`.zone[data-zone="${CSS.escape(zoneKey)}"]`);
        wrap = z ? (z.querySelector(".chips") || z) : null;
      }
      if (!wrap) return;

      idsArr.forEach(id=>{
        const chip = byId[id];
        if (chip) wrap.appendChild(chip);
      });
    });
  });
}

function saveState(){
  const payload = {
    v: 1,
    perExo: state.perExo,
    chips: snapshotChipsByExo(),
    radios: {},
    texts: {}
  };

  $all("input[type='radio']").forEach(r=>{
    if (r.checked) payload.radios[r.name] = r.value;
  });

  $all("input[type='text'], textarea").forEach(t=>{
    if (t.id) payload.texts[t.id] = t.value;
  });

  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(e){}
}

function loadState(){
  let raw = null;
  try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){}
  if (!raw) return;
  let payload = null;
  try{ payload = JSON.parse(raw); }catch(e){ return; }
  if (!payload || payload.v !== 1) return;

  if (payload.radios){
    Object.entries(payload.radios).forEach(([name, val])=>{
      const r = document.querySelector(`input[type='radio'][name="${CSS.escape(name)}"][value="${CSS.escape(val)}"]`);
      if (r) r.checked = true;
    });
  }

  if (payload.texts){
    Object.entries(payload.texts).forEach(([id, val])=>{
      const el = document.getElementById(id);
      if (el) el.value = val;
    });
  }

  restoreChipsByExo(payload.chips);

  if (payload.perExo && typeof payload.perExo === "object"){
    for (const [k,v] of Object.entries(payload.perExo)){
      if (state.perExo[k]) {
        state.perExo[k].score = v.score || 0;
        state.perExo[k].done = !!v.done;
      }
    }
  }
}

function clearSaved(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
}

function resetAll(root=document) {
  $all("input[type='radio']", root).forEach(r=>r.checked=false);
  $all("textarea, input[type='text']", root).forEach(t=>t.value="");
  $all("[data-exo]", root).forEach(ex=>{
    const bank = ex.querySelector(".bank .chips");
    if (!bank) return;
    $all(".chip", ex).forEach(ch=>bank.appendChild(ch));
  });
  $all(".feedback", root).forEach(f=>{ if (f.id!=="finalBox") f.style.display="none"; });
  $("#finalBox").style.display="none";
  for (const [k,v] of Object.entries(state.perExo)) {
    state.perExo[k] = {max: v.max, score:0, done:false};
  }
  resetSelection();
  updateTopBar();
  clearSaved();
  toast("<strong>Réinitialisé</strong> · Tu peux recommencer.");
}

function wireExo1(){
  const ex = document.querySelector("[data-exo='exo1']");
  const fb = ex.querySelector(".feedback");
  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    let score=0;
    const d = $("#p_danger").value;
    const s = $("#p_situation").value;
    const e = $("#p_event").value;
    const dom = $("#p_dommage").value;

    if (hasAny(d, ["sol encombre","obstacle","fer saillant","saillie","cable","gravats","trou","sol glissant"])) score+=2;
    if (hasAny(s, ["circuler","se deplacer","passage","zone encombre","chantier","transport"])) score+=2;
    if (hasAny(e, ["trebuche","trebuchement","chute","glissade","heurte"])) score+=2;
    if (hasAny(dom, ["entorse","fracture","blessure","lesion","traumatisme"])) score+=2;

    makeFeedback(
      fb,
      score>=6,
      "Correction",
      `Score : <strong>${score}</strong>/8. Exemple : Danger = zone encombrée / fers saillants · Situation = circuler dans une zone encombrée · Événement = trébuchement/chute · Dommage = entorse/fracture.`
    );
    markDone("exo1", score, 8);
  });

  ex.querySelector(".btn-reset").addEventListener("click", ()=>{
    ["p_danger","p_situation","p_event","p_dommage"].forEach(id=>$("#"+id).value="");
    fb.style.display="none";
    state.perExo["exo1"]={max:8, score:0, done:false};
    updateTopBar();
    saveState();
  });

  ["p_danger","p_situation","p_event","p_dommage"].forEach(id=>{
    $("#"+id).addEventListener("input", saveState);
  });
}

function wireExo2(){
  const ex = document.querySelector("[data-exo='exo2']");
  const fb = ex.querySelector(".feedback");
  const correct = {
    m1:"suppr",
    m2:"suppr",
    m10:"suppr",
    m3:"collect",
    m4:"collect",
    m5:"collect",
    m6:"epi",
    m7:"epi",
    m8:"compl",
    m9:"compl"
  };

  function compute(){
    let score=0;
    for (const [id,zone] of Object.entries(correct)){
      const chip = ex.querySelector(`.chip[data-id="${CSS.escape(id)}"]`);
      const z = chip?.closest(".zone")?.dataset.zone || "bank";
      if (z===zone) score++;
    }
    return score;
  }

  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    const score = compute();
    makeFeedback(
      fb,
      score>=8,
      "Correction",
      `Score : <strong>${score}</strong>/10. On privilégie : agir à la source → protection collective → EPI → mesures complémentaires.`
    );
    markDone("exo2", score, 10);
  });

  ex.querySelectorAll(".btn-reset").forEach(btn=>btn.addEventListener("click", ()=>{
    const bank = ex.querySelector(".bank .chips");
    ex.querySelectorAll(".chip").forEach(ch=>bank.appendChild(ch));
    fb.style.display="none";
    state.perExo["exo2"]={max:10, score:0, done:false};
    updateTopBar();
    resetSelection();
    saveState();
  }));
}

function wireExo3(){
  const ex = document.querySelector("[data-exo='exo3']");
  const fb = ex.querySelector(".feedback");
  ex.querySelector(".btn-correct").addEventListener("click", ()=>{
    let score=0;
    const v = (ex.querySelector("input[name='prio']:checked")||{}).value;
    const txt = $("#prio_txt").value;

    if (v==="b") score += 4;
    if (txt.trim().length >= 40) score += 2;
    if (hasAny(txt, ["source","supprimer","reduire","circulation","obstacle","balis","organis","collectif","probabilite","eviter"])) score += 2;

    makeFeedback(
      fb,
      score>=6,
      "Correction",
      `Score : <strong>${score}</strong>/8. Priorité : dégager + baliser + organiser les circulations (agit sur la cause et protège tout le monde).`
    );
    markDone("exo3", score, 8);
  });

  ex.querySelector(".btn-reset").addEventListener("click", ()=>{
    ex.querySelectorAll("input[name='prio']").forEach(r=>r.checked=false);
    $("#prio_txt").value="";
    fb.style.display="none";
    state.perExo["exo3"]={max:8, score:0, done:false};
    updateTopBar();
    saveState();
  });

  ex.querySelectorAll("input[name='prio']").forEach(r=>{
    r.addEventListener("change", saveState);
  });
  $("#prio_txt").addEventListener("input", saveState);
}

function buildPayloadForFirebase(classe, code){
  const radios = {};
  $all("input[type='radio']").forEach(r=>{
    if (r.checked) radios[r.name] = r.value;
  });

  const texts = {};
  $all("input[type='text'], textarea").forEach(t=>{
    if (t.id) texts[t.id] = t.value;
  });

  const chips = snapshotChipsByExo();

  const exo1Answers = {
    danger: texts["p_danger"] || "",
    situation: texts["p_situation"] || "",
    event: texts["p_event"] || "",
    dommage: texts["p_dommage"] || ""
  };

  const exo3Answers = {
    choix: radios["prio"] || null,
    justification: texts["prio_txt"] || ""
  };

  const exo2Chips = (chips && chips.exo2) ? chips.exo2 : {};

  const LABELS_EXO2 = {
    m1: "Dégager les zones de circulation (enlever obstacles)",
    m2: "Nettoyage régulier (huile/eau) + évacuer les déchets",
    m3: "Balisage / signalisation des zones à risque",
    m4: "Aménager les voies de circulation",
    m5: "Éclairage suffisant des zones de passage",
    m6: "Chaussures de sécurité antidérapantes",
    m7: "Nouer ses lacets / vérifier les semelles",
    m8: "Former / sensibiliser (rangement, déplacements)",
    m9: "Consignes + rappel des règles de rangement",
    m10: "Protéger les saillies (recourber/poser des bouchons)"
  };

  function mapZone(zones, labels){
    const out = {};
    Object.entries(zones).forEach(([zoneName, ids])=>{
      out[zoneName] = (ids||[]).map(id => ({ id, label: labels[id] || id }));
    });
    return out;
  }

  const exo2Answers = mapZone(exo2Chips, LABELS_EXO2);

  const max = state.totalMax;
  const total = state.totalScore;
  const percent = max ? Math.round((total/max)*100) : 0;

  return {
    meta: {
      exoId: "fiche_chute_plainpied_v1",
      classe: classe || "",
      eleveCode: code,
      createdAt: serverTimestamp()
    },
    score: { total, max, percent },
    perExo: state.perExo,
    answers: {
      exo1: exo1Answers,
      exo2: exo2Answers,
      exo3: exo3Answers
    },
    raw: {
      radios,
      texts,
      chips
    },
    client: {
      ua: navigator.userAgent || "",
      ts: Date.now()
    }
  };
}

document.addEventListener("DOMContentLoaded", ()=>{
  state.totalMax = 0;
  $all("[data-exo]").forEach(ex=>{
    const id = ex.dataset.exo;
    const max = parseInt(ex.dataset.max,10) || 0;
    state.perExo[id] = {max, score:0, done:false};
    state.totalMax += max;
  });
  $("#scoreMax").textContent = state.totalMax;

  enableDnD(document);
  wireExo1();
  wireExo2();
  wireExo3();

  loadState();
  updateTopBar();

  $("#resetAll").addEventListener("click", ()=>resetAll(document));
  $("#scrollTop").addEventListener("click", ()=>window.scrollTo({top:0, behavior:"smooth"}));

  $("#openAllCorr").addEventListener("click", ()=>{
    $all("[data-exo]").forEach(ex=>{
      const btn = ex.querySelector(".btn-correct");
      if (btn) btn.click();
    });
    toast("<strong>Corrections</strong> · Affichées pour tous les exercices.");
  });

  $("#finalBtn").addEventListener("click", ()=>{
    const max = state.totalMax;
    let score = 0, done=0;
    for (const v of Object.values(state.perExo)) {
      score += (v.score||0);
      if (v.done) done++;
    }
    const pct = max ? Math.round((score/max)*100) : 0;
    const msg = (done < Object.keys(state.perExo).length)
      ? `Tu as corrigé <strong>${done}</strong> exercice(s) sur <strong>${Object.keys(state.perExo).length}</strong>.`
      : `Tout est corrigé.`;
    const level = pct>=80 ? "Très solide" : pct>=60 ? "Correct" : pct>=40 ? "À renforcer" : "À reprendre";
    const box = $("#finalBox");
    box.classList.remove("good","bad");
    box.classList.add(pct>=60 ? "good" : "bad");
    box.style.display="block";
    box.innerHTML = `<h4>Score final : ${score} / ${max} (${pct}%)</h4><p>${msg} Niveau : <strong>${level}</strong>.</p>`;
    box.scrollIntoView({behavior:"smooth", block:"center"});
    saveState();
  });

  const sendBtn = $("#sendFirebase");
  if (sendBtn) {
    sendBtn.addEventListener("click", async ()=>{
      const classe = ($("#meta_classe")?.value || "").trim();
      const code = ($("#meta_code")?.value || "").trim();
      if (!code){
        toast("Merci d’indiquer ton <strong>code élève</strong>.");
        return;
      }
      try{
        const payload = buildPayloadForFirebase(classe, code);
        await addDoc(copiesCol, payload);
        toast("<strong>Copie envoyée</strong> · Ton professeur la recevra dans son cockpit.");
      } catch(e){
        console.error(e);
        toast("Erreur d’envoi. Vérifie la connexion puis réessaie.");
      }
    });
  }
});
</script>
</body>
</html>
