<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escape Game Finance : Le Coffre de Sophie</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="annuaire.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <style>
    :root { --primary:#2563eb; --success:#16a34a; --error:#dc2626; --bg:#0f172a; --gold:#fbbf24; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; }
    body{
      font-family:'Segoe UI',sans-serif; background:var(--bg); color:#e2e8f0;
      padding:20px; display:flex; flex-direction:column; align-items:center;
      overflow-x:hidden;
    }
    .container{ max-width:1100px; width:100%; }
    header{
      background:linear-gradient(135deg,#1e293b,#334155); color:var(--gold);
      padding:30px; border-radius:15px; text-align:center; margin-bottom:25px;
      border:2px solid var(--gold); box-shadow:0 0 20px rgba(251,191,36,0.2);
      max-width:100%;
    }
    .obj-box{
      margin-top:10px; padding:10px; border-radius:10px;
      background:rgba(251,191,36,0.08); border:1px solid rgba(251,191,36,0.25);
      color:#fde68a; font-weight:700;
    }
    .mission-box{
      background:#1e293b; padding:20px; border-radius:15px;
      border-left:5px solid var(--gold); margin-bottom:25px; line-height:1.6;
      overflow-wrap:anywhere; max-width:100%;
    }

    /* CALCULATRICE */
    .calc-toggle{
      position:fixed; bottom:20px; right:20px; z-index:1000;
      background:var(--gold); color:#0f172a; border:none;
      width:60px; height:60px; border-radius:50%; font-size:1.8rem;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);
      transition:transform 0.2s; display:flex; align-items:center; justify-content:center;
    }
    .calc-toggle:hover{ transform:scale(1.1); }
    .calc-toggle:active{ transform:scale(0.95); }

    .calculator{
      position:fixed; bottom:90px; right:20px; z-index:999;
      background:#1e293b; border:3px solid var(--gold); border-radius:20px;
      padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.5);
      display:none; width:280px;
    }
    .calculator.visible{ display:block; animation:slideIn 0.3s; }
    @keyframes slideIn{ from{ opacity:0; transform:translateY(20px); } to{ opacity:1; transform:translateY(0); } }

    .calc-header{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;
    }
    .calc-header h3{ margin:0; color:var(--gold); font-size:1.1rem; }
    .calc-close{
      background:transparent; border:none; color:#94a3b8; font-size:1.5rem;
      cursor:pointer; padding:0; width:30px; height:30px;
    }
    .calc-close:hover{ color:var(--error); }

    .calc-display{
      background:#0f172a; color:#0f0; font-family:'Courier New',monospace;
      padding:15px; border-radius:10px; font-size:1.5rem; text-align:right;
      margin-bottom:15px; border:2px solid #334155; min-height:50px;
      word-break:break-all;
    }

    .calc-buttons{
      display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;
    }
    .calc-btn{
      background:#334155; color:#e2e8f0; border:none; padding:15px;
      border-radius:10px; font-size:1.1rem; font-weight:700; cursor:pointer;
      transition:0.15s;
    }
    .calc-btn:hover{ background:#475569; }
    .calc-btn:active{ transform:scale(0.95); }
    .calc-btn.operator{ background:#3b82f6; color:white; }
    .calc-btn.equals{ background:var(--success); color:white; grid-column:span 2; }
    .calc-btn.clear{ background:var(--error); color:white; }
    .calc-btn.zero{ grid-column:span 2; }

    #item-bank{
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
      background:#334155; padding:20px; border-radius:12px;
      border:2px dashed var(--gold); margin-bottom:25px; min-height:80px;
      max-width:100%;
    }
    .draggable-item{
      padding:12px 15px; background:#f8fafc; border:2px solid #64748b;
      border-radius:10px; cursor:pointer; font-weight:900; color:#1e293b;
      transition:0.15s; user-select:none; text-align:center;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
      max-width:100%;
    }
    .draggable-item.selected{ border-color:var(--gold); background:#fef3c7; transform:scale(1.03); }
    .draggable-item.correct{ border-color:var(--success); }
    .draggable-item.wrong{ border-color:var(--error); }

    .correct-info{ display:none; font-size:0.85rem; color:#f87171; margin-top:6px; font-weight:900; }

    .budget-container{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:12px; width:100%; max-width:100%;
    }
    .column{
      background:#1e293b; border-radius:12px; padding:15px;
      display:flex; flex-direction:column; min-height:350px;
      border-top:6px solid #64748b;
      max-width:100%;
    }
    #col-recettes{ border-top-color:#28a745; }
    #col-fixes{ border-top-color:#007bff; }
    #col-courantes{ border-top-color:#ffc107; }
    #col-occas{ border-top-color:#dc3545; }

    .drop-zone{
      flex-grow:1; padding:10px; border-radius:10px;
      background:rgba(255,255,255,0.05); min-height:120px;
      cursor:pointer; margin-bottom:10px; overflow:auto;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .sub-zone{
      background:rgba(40,167,69,0.1); border-radius:10px;
      padding:8px; margin-bottom:8px; overflow:auto;
    }
    h3{
      text-align:center; margin:0 0 15px 0; font-size:0.9rem; color:var(--gold);
      letter-spacing:0.06em;
    }
    h4{
      margin:0 0 8px 0; font-size:0.78rem; color:#94a3b8;
      text-transform:uppercase; letter-spacing:0.06em;
    }

    .calc-zone{
      text-align:center; border-top:1px solid #334155; padding-top:10px;
      display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap;
    }
    input[type="text"]{
      width:110px; padding:8px; border:2px solid #334155; border-radius:8px;
      text-align:center; background:#0f172a; color:white; font-weight:900;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .hint{ width:100%; font-size:0.85rem; color:#94a3b8; }

    .safe-zone{
      margin-top:40px; background:#1e293b; padding:30px; border-radius:20px;
      border:4px solid var(--gold); text-align:center; width:100%; max-width:600px;
      position:relative; overflow:hidden;
    }
    .lock-icon{ font-size:4rem; transition:transform 0.5s; display:block; margin-bottom:10px; }
    .safe-display{
      font-family:'Courier New',monospace; background:#000; color:#0f0;
      padding:16px; font-size:2rem; border-radius:12px; margin:16px 0 10px;
      border:2px solid #334155; width:100%; max-width:420px;
    }
    .btn-unlock{
      background:var(--gold); color:#0f172a; border:none;
      padding:20px 40px; border-radius:14px; font-size:1.25rem;
      font-weight:1000; cursor:pointer; width:auto;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    .btn-disabled{ opacity:0.75; cursor:not-allowed; }

    .victory-badge{
      display:none; background:linear-gradient(45deg,#fbbf24,#f59e0b);
      color:#1e293b; padding:18px; border-radius:15px; font-weight:1000;
      margin-top:18px; animation:bounce 1s infinite;
    }
    @keyframes bounce{ 0%,100%{ transform:scale(1);} 50%{ transform:scale(1.08);} }

    #result-zone{ display:none; margin-top:25px; text-align:center; width:100%; max-width:100%; }
    .chart-box{ height:300px; margin:20px 0; background:white; border-radius:15px; padding:15px; max-width:100%; }
    .chart-box canvas{ max-width:100% !important; height:100% !important; display:block; }

    .score-card{
      max-width:700px; margin:0 auto; background:rgba(255,255,255,0.06);
      border:1px solid rgba(148,163,184,0.35); border-radius:14px;
      padding:12px 14px; text-align:left;
    }
    .row{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding:6px 0; border-bottom:1px dashed rgba(148,163,184,0.25);
    }
    .row:last-child{ border-bottom:none; }
    .row b{ color:#fde68a; }
    .row .ok{ color:#86efac; font-weight:900; }
    .row .ko{ color:#fca5a5; font-weight:900; }

    @media (max-width:600px){
      body{ padding:12px; }
      header{ padding:18px; }
      .btn-unlock{ width:100%; padding:16px; font-size:1.05rem; }
      .safe-display{ font-size:1.6rem; }
      .chart-box{ height:260px; padding:12px; }
      input[type="text"]{ width:140px; }
      .calc-toggle{ bottom:15px; right:15px; width:55px; height:55px; font-size:1.6rem; }
      .calculator{ bottom:80px; right:15px; width:260px; padding:15px; }
      .calc-btn{ padding:12px; font-size:1rem; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1 style="margin:0;">üîê ESCAPE GAME : LE COFFRE DE SOPHIE</h1>
      <div class="obj-box">Mission : classe les flux et trouve le solde exact pour ouvrir le coffre</div>
    </header>

    <script>
      if(typeof enregistrerVisite === "function") {
        try { enregistrerVisite("Escape Game - Sophie"); } catch(e) {}
      }
    </script>

    <div class="mission-box">
      <strong>LE DOSSIER :</strong> le code du coffre est le <strong>Solde Mensuel exact</strong> de Sophie<br><br>
      <strong>Donn√©es :</strong> Salaire net (1 753,12 ‚Ç¨), Aide au logement (154,50 ‚Ç¨)<br>
      <strong>D√©penses :</strong> Loyer (652,30 ‚Ç¨), Internet (31,99 ‚Ç¨), Assurance (45,12 ‚Ç¨), Courses (342,65 ‚Ç¨),
      Transport (85,00 ‚Ç¨), Coiffeur (45,00 ‚Ç¨) et V√©lo (420,50 ‚Ç¨)
    </div>

    <div id="item-bank" aria-label="Banque d'√©tiquettes"></div>

    <div class="budget-container">
      <div class="column" id="col-recettes">
        <h3>RECETTES</h3>
        <div class="drop-zone sub-zone" data-category="recette-travail" role="button" tabindex="0"><h4>TRAVAIL</h4></div>
        <div class="drop-zone sub-zone" data-category="recette-social" role="button" tabindex="0"><h4>SOCIAL</h4></div>
        <div class="calc-zone">
          Total :
          <input type="text" inputmode="decimal" id="in-recettes" placeholder="1907,62">
          ‚Ç¨
          <div class="hint">Virgule, point, espaces et ‚Ç¨ accept√©s</div>
        </div>
      </div>

      <div class="column" id="col-fixes">
        <h3>FIXES</h3>
        <div class="drop-zone" data-category="fixe" role="button" tabindex="0"></div>
        <div class="calc-zone">
          Total :
          <input type="text" inputmode="decimal" id="in-fixes" placeholder="729,41">
          ‚Ç¨
        </div>
      </div>

      <div class="column" id="col-courantes">
        <h3>COURANTES</h3>
        <div class="drop-zone" data-category="courante" role="button" tabindex="0"></div>
        <div class="calc-zone">
          Total :
          <input type="text" inputmode="decimal" id="in-courantes" placeholder="427,65">
          ‚Ç¨
        </div>
      </div>

      <div class="column" id="col-occas">
        <h3>OCCASIONNELLES</h3>
        <div class="drop-zone" data-category="occas" role="button" tabindex="0"></div>
        <div class="calc-zone">
          Total :
          <input type="text" inputmode="decimal" id="in-occas" placeholder="465,50">
          ‚Ç¨
        </div>
      </div>
    </div>

    <div class="safe-zone" id="safe-container">
      <span class="lock-icon" id="lock-status">üîí</span>
      <h2 style="margin:0 0 6px 0; color:#fde68a;">CODE DE D√âVERROUILLAGE</h2>
      <div style="color:#94a3b8; font-weight:700; margin-bottom:8px;">Entre le solde mensuel exact (Recettes - D√©penses)</div>

      <input type="text" inputmode="decimal" id="final-code-input" class="safe-display" placeholder="285,06">
      <br>
      <button class="btn-unlock" id="btn-open" type="button">TENTER L'OUVERTURE</button>
      <div class="victory-badge" id="badge">üèÜ MA√éTRE DES FINANCES üèÜ</div>
    </div>

    <div id="result-zone">
      <h2 id="final-score" style="margin:10px 0 0 0; color:#fde68a;">Score : -- / 20</h2>

      <div class="score-card" id="score-details"></div>

      <div class="chart-box"><canvas id="barChart"></canvas></div>
      <div id="chart-fallback" style="display:none; margin: 15px 0; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(148,163,184,0.35); text-align:left;"></div>
      <button class="btn-unlock" type="button" style="background:#64748b;" onclick="location.reload()">üîÑ RECOMMENCER</button>
    </div>
  </div>

  <!-- CALCULATRICE -->
  <button class="calc-toggle" id="calc-toggle" aria-label="Ouvrir la calculatrice">üßÆ</button>
  
  <div class="calculator" id="calculator">
    <div class="calc-header">
      <h3>Calculatrice</h3>
      <button class="calc-close" id="calc-close" aria-label="Fermer">√ó</button>
    </div>
    <div class="calc-display" id="calc-display">0</div>
    <div class="calc-buttons">
      <button class="calc-btn clear" data-action="clear">C</button>
      <button class="calc-btn operator" data-action="backspace">‚Üê</button>
      <button class="calc-btn operator" data-action="divide">√∑</button>
      <button class="calc-btn operator" data-action="multiply">√ó</button>
      
      <button class="calc-btn" data-number="7">7</button>
      <button class="calc-btn" data-number="8">8</button>
      <button class="calc-btn" data-number="9">9</button>
      <button class="calc-btn operator" data-action="subtract">‚àí</button>
      
      <button class="calc-btn" data-number="4">4</button>
      <button class="calc-btn" data-number="5">5</button>
      <button class="calc-btn" data-number="6">6</button>
      <button class="calc-btn operator" data-action="add">+</button>
      
      <button class="calc-btn" data-number="1">1</button>
      <button class="calc-btn" data-number="2">2</button>
      <button class="calc-btn" data-number="3">3</button>
      <button class="calc-btn equals" data-action="equals">=</button>
      
      <button class="calc-btn zero" data-number="0">0</button>
      <button class="calc-btn" data-action="decimal">,</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    try {
      if (typeof firebase !== "undefined" && firebaseConfig && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      window.db = (typeof firebase !== "undefined") ? firebase.firestore() : null;
    } catch(e) {
      window.db = null;
    }
  </script>

  <script>
    // CALCULATRICE
    const calcToggle = document.getElementById("calc-toggle");
    const calculator = document.getElementById("calculator");
    const calcClose = document.getElementById("calc-close");
    const calcDisplay = document.getElementById("calc-display");

    let calcValue = "0";
    let calcOperator = null;
    let calcPrevValue = null;
    let calcWaitingForOperand = false;

    function updateCalcDisplay(){
      calcDisplay.textContent = calcValue.replace(".", ",");
    }

    function calcClear(){
      calcValue = "0";
      calcOperator = null;
      calcPrevValue = null;
      calcWaitingForOperand = false;
      updateCalcDisplay();
    }

    function calcBackspace(){
      if(calcValue.length > 1){
        calcValue = calcValue.slice(0, -1);
      } else {
        calcValue = "0";
      }
      updateCalcDisplay();
    }

    function calcInputNumber(num){
      if(calcWaitingForOperand){
        calcValue = String(num);
        calcWaitingForOperand = false;
      } else {
        calcValue = calcValue === "0" ? String(num) : calcValue + num;
      }
      updateCalcDisplay();
    }

    function calcInputDecimal(){
      if(calcWaitingForOperand){
        calcValue = "0.";
        calcWaitingForOperand = false;
      } else if(calcValue.indexOf(".") === -1){
        calcValue += ".";
      }
      updateCalcDisplay();
    }

    function calcPerformOperation(nextOperator){
      const inputValue = parseFloat(calcValue);

      if(calcPrevValue === null){
        calcPrevValue = inputValue;
      } else if(calcOperator){
        const result = calcCalculate(calcPrevValue, inputValue, calcOperator);
        calcValue = String(result);
        calcPrevValue = result;
      }

      calcWaitingForOperand = true;
      calcOperator = nextOperator;
      updateCalcDisplay();
    }

    function calcCalculate(prev, current, op){
      switch(op){
        case "+": return prev + current;
        case "-": return prev - current;
        case "*": return prev * current;
        case "/": return current !== 0 ? prev / current : 0;
        default: return current;
      }
    }

    function calcEquals(){
      const inputValue = parseFloat(calcValue);
      if(calcPrevValue !== null && calcOperator){
        const result = calcCalculate(calcPrevValue, inputValue, calcOperator);
        calcValue = String(Math.round(result * 100) / 100);
        calcOperator = null;
        calcPrevValue = null;
        calcWaitingForOperand = true;
        updateCalcDisplay();
      }
    }

    calcToggle.addEventListener("click", ()=>{
      calculator.classList.toggle("visible");
    });

    calcClose.addEventListener("click", ()=>{
      calculator.classList.remove("visible");
    });

    document.querySelectorAll(".calc-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const action = btn.dataset.action;
        const number = btn.dataset.number;

        if(number !== undefined){
          calcInputNumber(number);
        } else if(action === "clear"){
          calcClear();
        } else if(action === "backspace"){
          calcBackspace();
        } else if(action === "decimal"){
          calcInputDecimal();
        } else if(action === "add"){
          calcPerformOperation("+");
        } else if(action === "subtract"){
          calcPerformOperation("-");
        } else if(action === "multiply"){
          calcPerformOperation("*");
        } else if(action === "divide"){
          calcPerformOperation("/");
        } else if(action === "equals"){
          calcEquals();
        }
      });
    });

    // Support clavier pour la calculatrice
    document.addEventListener("keydown", (e)=>{
      if(!calculator.classList.contains("visible")) return;

      if(e.key >= "0" && e.key <= "9"){
        calcInputNumber(e.key);
      } else if(e.key === "," || e.key === "."){
        calcInputDecimal();
      } else if(e.key === "+"){
        calcPerformOperation("+");
      } else if(e.key === "-"){
        calcPerformOperation("-");
      } else if(e.key === "*"){
        calcPerformOperation("*");
      } else if(e.key === "/"){
        e.preventDefault();
        calcPerformOperation("/");
      } else if(e.key === "Enter" || e.key === "="){
        calcEquals();
      } else if(e.key === "Escape"){
        calculator.classList.remove("visible");
      } else if(e.key === "Backspace"){
        calcBackspace();
      } else if(e.key === "c" || e.key === "C"){
        calcClear();
      }
    });
  </script>

  <script>
    const items = [
      { id: 1, name: "Salaire",       val: 1753.12, cat: "recette-travail", label: "TRAVAIL" },
      { id: 2, name: "Aide logement", val:  154.50, cat: "recette-social",  label: "SOCIAL" },
      { id: 3, name: "Loyer",        val:  652.30, cat: "fixe",            label: "FIXES" },
      { id: 4, name: "Internet",     val:   31.99, cat: "fixe",            label: "FIXES" },
      { id: 5, name: "Assurance",    val:   45.12, cat: "fixe",            label: "FIXES" },
      { id: 6, name: "Courses",      val:  342.65, cat: "courante",        label: "COURANTES" },
      { id: 7, name: "Transport",    val:   85.00, cat: "courante",        label: "COURANTES" },
      { id: 8, name: "Coiffeur",     val:   45.00, cat: "occas",           label: "OCCASIONNELLES" },
      { id: 9, name: "V√©lo",         val:  420.50, cat: "occas",           label: "OCCASIONNELLES" }
    ];

    const EXPECT = {
      recettes: 1907.62,
      fixes:    729.41,
      cour:     427.65,
      occas:    465.50,
      dep:     1622.56,
      solde:    285.06
    };

    function normalizeNumberInput(str){
      if(!str) return null;
      let s = String(str).replace(/\u00A0/g," ").trim();
      s = s.replace(/\s+/g,"").replace(/‚Ç¨/g,"");
      s = s.replace(/[^0-9+\-.,]/g,"");

      const lastComma = s.lastIndexOf(",");
      const lastDot   = s.lastIndexOf(".");
      const decPos = Math.max(lastComma,lastDot);

      if(decPos !== -1){
        const intPart = s.slice(0,decPos).replace(/[.,]/g,"");
        const decPart = s.slice(decPos+1).replace(/[.,]/g,"");
        s = intPart + "." + decPart;
      } else {
        s = s.replace(/[.,]/g,"");
      }

      if(!s || s==="+" || s==="-" || s==="." || s==="+." || s==="-.") return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function isClose(n,target,tol){
      return (typeof n==="number") && Number.isFinite(n) && Math.abs(n-target) <= tol;
    }

    function kbActivate(e, fn){
      if(e.key==="Enter" || e.key===" "){ e.preventDefault(); fn(); }
    }

    let selectedItem = null;
    const bank = document.getElementById("item-bank");

    function toggleSelect(el){
      if(selectedItem === el){
        el.classList.remove("selected");
        selectedItem = null;
        return;
      }
      if(selectedItem) selectedItem.classList.remove("selected");
      selectedItem = el;
      el.classList.add("selected");
    }

    items.slice().sort(()=>Math.random()-0.5).forEach(item=>{
      const el = document.createElement("div");
      el.className = "draggable-item";
      el.id = "i-" + item.id;
      el.setAttribute("role","button");
      el.setAttribute("tabindex","0");
      el.innerHTML = `${item.name}<br>${item.val.toFixed(2)}‚Ç¨ <div class="correct-info" id="info-${item.id}">Doit √™tre en : ${item.label}</div>`;
      el.onclick = (e)=>{ e.stopPropagation(); toggleSelect(el); };
      el.onkeydown = (e)=>kbActivate(e, ()=>toggleSelect(el));
      bank.appendChild(el);
    });

    document.querySelectorAll(".drop-zone, #item-bank").forEach(zone=>{
      zone.onclick = ()=>{
        if(selectedItem){
          zone.appendChild(selectedItem);
          selectedItem.classList.remove("selected");
          selectedItem = null;
        }
      };
      zone.onkeydown = (e)=>kbActivate(e, ()=>zone.click());
    });

    function resetFeedback(){
      items.forEach(item=>{
        const el = document.getElementById("i-" + item.id);
        const info = document.getElementById("info-" + item.id);
        if(el){ el.classList.remove("correct","wrong"); el.style.borderColor=""; }
        if(info){ info.style.display="none"; }
      });
    }

    let chartInstance = null;
    let sending = false;

    document.getElementById("btn-open").addEventListener("click", ouvrirCoffre);

    async function ouvrirCoffre(){
      const btn = document.getElementById("btn-open");
      if(sending) return;
      sending = true;
      btn.disabled = true;
      btn.classList.add("btn-disabled");

      resetFeedback();

      let goodPlace = 0;
      let stats = { rec:0, dep:0 };
      const totalItems = items.length;

      items.forEach(item=>{
        const el = document.getElementById("i-" + item.id);
        const info = document.getElementById("info-" + item.id);
        const parentCat = (el && el.parentElement && el.parentElement.dataset) ? el.parentElement.dataset.category : undefined;

        if(parentCat === item.cat){
          goodPlace++;
          el.classList.add("correct");
          if(item.cat.includes("recette")) stats.rec++; else stats.dep++;
        } else {
          el.classList.add("wrong");
          if(info) info.style.display = "block";
        }
      });

      const vRec = normalizeNumberInput(document.getElementById("in-recettes").value);
      const vFix = normalizeNumberInput(document.getElementById("in-fixes").value);
      const vCou = normalizeNumberInput(document.getElementById("in-courantes").value);
      const vOcc = normalizeNumberInput(document.getElementById("in-occas").value);
      const vCode = normalizeNumberInput(document.getElementById("final-code-input").value);

      const recOk = isClose(vRec, EXPECT.recettes, 0.03);
      const fixOk = isClose(vFix, EXPECT.fixes,   0.03);
      const couOk = isClose(vCou, EXPECT.cour,    0.03);
      const occOk = isClose(vOcc, EXPECT.occas,   0.03);
      const codeOk = isClose(vCode, EXPECT.solde, 0.05);

      // Bar√®me /20 : 9 placements + 4 totaux + 7 code
      let note = 0;
      note += goodPlace;
      if(recOk) note += 1;
      if(fixOk) note += 1;
      if(couOk) note += 1;
      if(occOk) note += 1;
      if(codeOk) note += 7;
      note = Math.max(0, Math.min(20, Math.round(note)));

      // Coffre
      const lock = document.getElementById("lock-status");
      const badge = document.getElementById("badge");
      const safe = document.getElementById("safe-container");

      if(codeOk){
        lock.innerText = "üîì";
        lock.style.transform = "scale(1.5)";
        safe.style.borderColor = "var(--success)";
        if(codeOk && goodPlace === totalItems && recOk && fixOk && couOk && occOk){
          badge.style.display = "block";
          try{ if(typeof confetti !== "undefined") confetti({ particleCount: 160, spread: 70, origin:{ y:0.6 } }); }catch(e){}
        } else {
          badge.style.display = "none";
        }
      } else {
        badge.style.display = "none";
        lock.innerText = "‚ùå";
        lock.style.transform = "scale(1)";
        safe.style.borderColor = "var(--gold)";
        setTimeout(()=>{ lock.innerText = "üîí"; }, 900);
      }

      // R√©sultats
      document.getElementById("result-zone").style.display = "block";
      document.getElementById("final-score").innerText = `Score : ${note} / 20`;

      const details = document.getElementById("score-details");
      const ok = (b)=> b ? '<span class="ok">‚úÖ</span>' : '<span class="ko">‚ùå</span>';
      details.innerHTML = `
        <div class="row"><span><b>Classement</b> (${goodPlace}/${totalItems})</span><span>${ok(goodPlace===totalItems)}</span></div>
        <div class="row"><span>Total recettes</span><span>${ok(recOk)}</span></div>
        <div class="row"><span>Total fixes</span><span>${ok(fixOk)}</span></div>
        <div class="row"><span>Total courantes</span><span>${ok(couOk)}</span></div>
        <div class="row"><span>Total occasionnelles</span><span>${ok(occOk)}</span></div>
        <div class="row"><span><b>Code (solde)</b></span><span>${ok(codeOk)}</span></div>
      `;

      // Graphique
      const pcRec = ((stats.rec + (recOk ? 1 : 0)) / 3) * 100;
      const pcDep = ((stats.dep + ((fixOk?1:0)+(couOk?1:0)+(occOk?1:0))) / 10) * 100;
      const pcCode = codeOk ? 100 : 0;

      const fallback = document.getElementById("chart-fallback");
      if(fallback) fallback.style.display = "none";

      try{
        const canvas = document.getElementById("barChart");
        const canDraw = (typeof Chart !== "undefined") && canvas && canvas.getContext;
        if(canDraw){
          if(chartInstance){ chartInstance.destroy(); chartInstance = null; }
          chartInstance = new Chart(canvas, {
            type:"bar",
            data:{
              labels:["Recettes","D√©penses","Code"],
              datasets:[{
                label:"% de r√©ussite",
                data:[pcRec, pcDep, pcCode],
                backgroundColor:["#28a745","#ffc107","#fbbf24"],
                borderRadius:8
              }]
            },
            options:{
              responsive:true,
              maintainAspectRatio:false,
              scales:{ y:{ beginAtZero:true, max:100 } },
              plugins:{ legend:{ display:false } }
            }
          });
        } else if(fallback){
          fallback.style.display = "block";
          fallback.innerHTML = `<b>R√©sultats</b><br>Recettes : ${Math.round(pcRec)}%<br>D√©penses : ${Math.round(pcDep)}%<br>Code : ${Math.round(pcCode)}%`;
        }
      } catch(e){
        if(fallback){
          fallback.style.display = "block";
          fallback.innerHTML = `<b>R√©sultats</b><br>Recettes : ${Math.round(pcRec)}%<br>D√©penses : ${Math.round(pcDep)}%<br>Code : ${Math.round(pcCode)}%`;
        }
      }

      window.scrollTo({ top: document.getElementById("result-zone").offsetTop, behavior:"smooth" });

      // Envoi Firebase
      try{
        const codeEleve = localStorage.getItem("userCode") || localStorage.getItem("codeEleve") || "ANONYME";
        const classe =
          localStorage.getItem("userClasse") ||
          ((typeof ANNUAIRE !== "undefined" && ANNUAIRE && ANNUAIRE[codeEleve]) ? ANNUAIRE[codeEleve] : "AUTRE");

        if(window.db && typeof firebase !== "undefined"){
          const sentKey = "sent_escape_sophie_" + codeEleve;
          if(!sessionStorage.getItem(sentKey)){
            await db.collection("resultats_exercices").add({
              eleve: codeEleve,
              classe: classe,
              exercice: "Escape Game Finance - Sophie",
              note: note,
              total: 20,
              competences: { "C1": note, "C2": note },
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            sessionStorage.setItem(sentKey, "1");
          }
        }
      } catch(e){
        console.error("Erreur Firebase : ", e);
      }

      setTimeout(()=>{
        btn.disabled = false;
        btn.classList.remove("btn-disabled");
        sending = false;
      }, 450);
    }
  </script>
</body>
</html>
