<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Yanis : Sortir du rouge et √©pargner</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="annuaire.js"></script>

    <style>
        :root { --primary: #2563eb; --success: #16a34a; --error: #dc2626; --bg: #f8fafc; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; color: #1e293b; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .box { background: #fef2f2; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 6px solid var(--error); }
        .step { display: none; margin-top: 20px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; }
        .step.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .data-table td { padding: 8px 5px; border-bottom: 1px solid #e2e8f0; }
        
        /* INPUT RESPONSIVE */
        .input-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
        input[type="text"], input[type="number"] { 
            padding: 12px; 
            border: 2px solid #cbd5e1; 
            border-radius: 6px; 
            width: 100%; 
            max-width: 160px; 
            font-weight: bold; 
            font-size: 1.1rem;
        }
        input:focus { border-color: var(--primary); outline: none; }
        .unit { font-weight: bold; font-size: 1.1rem; }
        
        .btn { 
            padding: 12px 20px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            margin-top: 10px; 
            width: 100%;
            max-width: 280px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .btn-restart { 
            background: #64748b; 
            margin-top: 25px; 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1rem; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
        }
        .btn-restart:hover { background: #475569; }
        
        .feedback { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; }
        .feedback.success { display: block; background: #dcfce7; color: #166534; border-left: 5px solid var(--success); }
        .feedback.error { display: block; background: #fee2e2; color: #991b1b; border-left: 5px solid var(--error); }
        .feedback.warning { display: block; background: #fef3c7; color: #92400e; border-left: 5px solid #f59e0b; }
        
        .math-box { 
            background: #f8fafc; 
            padding: 12px; 
            border: 1px dashed #cbd5e1; 
            margin-top: 10px; 
            font-family: 'Courier New', monospace; 
            font-weight: bold; 
            color: #1e293b; 
            border-radius: 6px;
            overflow-x: auto;
        }
        
        h1 { font-size: 1.4rem; }
        h3 { color: var(--primary); margin-bottom: 10px; }
        
        /* MOBILE */
        @media (max-width: 480px) {
            .container { padding: 15px; }
            h1 { font-size: 1.2rem; }
            .data-table td { font-size: 0.9rem; }
            input[type="text"], input[type="number"] { max-width: 120px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üõ†Ô∏è Mission : Le Budget de Yanis</h1>
        <script>
            if(typeof enregistrerVisite === "function") {
                enregistrerVisite("Exercice Yanis - Arbitrage");
            }
        </script>
    </header>

    <div class="box">
        <strong>üìã SITUATION CRITIQUE :</strong> Yanis est √† d√©couvert. Sa voiture est en panne et la r√©paration co√ªte <strong>450,00 ‚Ç¨</strong>.
        
        <table class="data-table">
            <tr><td>Total des Recettes (Salaire + Aides) :</td><td align="right"><strong>1 250,50 ‚Ç¨</strong></td></tr>
            <tr><td>Total des D√©penses Actuelles :</td><td align="right"><strong>1 310,00 ‚Ç¨</strong></td></tr>
        </table>
    </div>

    <!-- √âTAPE 1 -->
    <div id="step1" class="step active">
        <h3>üìä √âtape 1 : Calculer le solde actuel</h3>
        <p>Pour comprendre pourquoi Yanis est en difficult√©, calculez son solde mensuel :</p>
        <p><strong>Recettes - D√©penses = ?</strong></p>
        <p><em>üí° Astuce : Le r√©sultat sera n√©gatif (les d√©penses d√©passent les revenus).</em></p>
        
        <div class="input-group">
            <input type="text" inputmode="decimal" id="q1-solde" placeholder="Ex : -25,00">
            <span class="unit">‚Ç¨</span>
        </div>
        
        <button class="btn" onclick="verifierEtape1()">‚úì V√©rifier le diagnostic</button>
        <div id="fb1" class="feedback"></div>
    </div>

    <!-- √âTAPE 2 -->
    <div id="step2" class="step">
        <h3>‚úÇÔ∏è √âtape 2 : Stopper le d√©ficit (Arbitrage)</h3>
        <p>Yanis d√©cide de <strong>supprimer ses abonnements de streaming</strong> et de <strong>r√©duire ses sorties</strong>.</p>
        <p>Il √©conomise ainsi <strong>160,00 ‚Ç¨</strong> par mois.</p>
        <p><strong>Quel est son NOUVEAU solde ?</strong></p>
        <p><em>üí° Calcul : Ancien solde + √âconomies = ?</em></p>
        
        <div class="input-group">
            <input type="text" inputmode="decimal" id="q2-solde" placeholder="Ex : 75,00">
            <span class="unit">‚Ç¨</span>
        </div>
        
        <button class="btn" onclick="verifierEtape2()">‚úì Calculer le nouveau solde</button>
        <div id="fb2" class="feedback"></div>
    </div>

    <!-- √âTAPE 3 -->
    <div id="step3" class="step">
        <h3>üè¶ √âtape 3 : √âpargner pour la r√©paration</h3>
        <p>Maintenant que Yanis a un budget <strong>exc√©dentaire</strong>, il peut √©pargner pour sa r√©paration de <strong>450,00 ‚Ç¨</strong>.</p>
        <p><strong>Dans combien de mois entiers aura-t-il la somme totale ?</strong></p>
        <p><em>üí° Divise le co√ªt de la r√©paration par l'√©pargne mensuelle, puis arrondis au mois sup√©rieur.</em></p>
        
        <div class="input-group">
            <input type="number" inputmode="numeric" id="q3-mois" min="1" max="12" placeholder="?">
            <span class="unit">mois</span>
        </div>
        
        <button class="btn" onclick="verifierEtape3()">‚úì V√©rifier la dur√©e</button>
        <div id="fb3" class="feedback"></div>
    </div>

    <!-- FINAL -->
    <div id="final-step" style="display:none;">
        <div style="text-align: center; padding: 20px; background: #dcfce7; border-radius: 10px; margin-top: 20px;">
            <h2 style="color: #166534;">üéâ F√©licitations !</h2>
            <p>Tu as aid√© Yanis √† r√©√©quilibrer son budget et √† planifier son √©pargne.</p>
        </div>
        <button class="btn-restart" onclick="location.reload()">üîÑ RECOMMENCER L'EXERCICE</button>
    </div>
</div>

<script>
    const prixReparation = 450.00;
    const soldeInitial = -59.50;
    const nouveauSolde = 100.50;
    const moisNecessaires = 5;

    // === FONCTION UTILITAIRE : Normaliser les entr√©es ===
    function normaliserNombre(valeur) {
        if (!valeur || valeur.trim() === '') return NaN;
        // Remplace virgule par point et supprime les espaces
        const normalise = valeur.replace(/\s/g, '').replace(',', '.');
        return parseFloat(normalise);
    }

    // === √âTAPE 1 ===
    function verifierEtape1() {
        const input = document.getElementById('q1-solde');
        const userSolde = normaliserNombre(input.value);
        const fb = document.getElementById('fb1');
        
        // V√©rification champ vide
        if (isNaN(userSolde)) {
            fb.innerHTML = `‚ö†Ô∏è <b>Entre un nombre !</b><br>Calcule : 1250,50 - 1310,00 et entre le r√©sultat (avec le signe n√©gatif).`;
            fb.className = "feedback warning";
            input.focus();
            return;
        }
        
        // V√©rification r√©ponse
        if (Math.abs(userSolde - soldeInitial) < 0.5) {
            fb.innerHTML = `‚úÖ <b>Correct !</b> Yanis perd <b>59,50 ‚Ç¨</b> chaque mois. Son budget est <b>d√©ficitaire</b>.<br>
            <div class="math-box">üìê Calcul : 1 250,50 ‚Ç¨ (Revenus) ‚àí 1 310,00 ‚Ç¨ (D√©penses) = <strong>‚àí59,50 ‚Ç¨</strong></div>`;
            fb.className = "feedback success";
            document.getElementById('step2').classList.add('active');
            document.getElementById('q2-solde').focus();
        } else if (userSolde > 0) {
            fb.innerHTML = `‚ùå <b>Attention au signe !</b><br>Les d√©penses (1 310 ‚Ç¨) sont <em>sup√©rieures</em> aux revenus (1 250,50 ‚Ç¨).<br>Le r√©sultat doit donc √™tre <strong>n√©gatif</strong>.`;
            fb.className = "feedback error";
        } else {
            fb.innerHTML = `‚ùå <b>V√©rifie ton calcul.</b><br>Fais l'op√©ration : <strong>1 250,50 ‚àí 1 310,00 = ?</strong>`;
            fb.className = "feedback error";
        }
    }

    // === √âTAPE 2 ===
    function verifierEtape2() {
        const input = document.getElementById('q2-solde');
        const userNouvSolde = normaliserNombre(input.value);
        const fb = document.getElementById('fb2');
        
        // V√©rification champ vide
        if (isNaN(userNouvSolde)) {
            fb.innerHTML = `‚ö†Ô∏è <b>Entre un nombre !</b><br>Calcule : ‚àí59,50 + 160,00 = ?`;
            fb.className = "feedback warning";
            input.focus();
            return;
        }

        // V√©rification r√©ponse
        if (Math.abs(userNouvSolde - nouveauSolde) < 0.5) {
            fb.innerHTML = `‚úÖ <b>Bien jou√© !</b> Son budget est maintenant <b>exc√©dentaire</b>.<br>
            <div class="math-box">üìê Calcul : ‚àí59,50 ‚Ç¨ (D√©ficit) + 160,00 ‚Ç¨ (√âconomies) = <strong>+100,50 ‚Ç¨</strong> d'√©pargne possible par mois</div>`;
            fb.className = "feedback success";
            document.getElementById('step3').classList.add('active');
            document.getElementById('q3-mois').focus();
        } else if (userNouvSolde < 0) {
            fb.innerHTML = `‚ùå <b>Le r√©sultat devrait √™tre positif !</b><br>Yanis part de ‚àí59,50 ‚Ç¨ et <em>ajoute</em> 160 ‚Ç¨ d'√©conomies.<br>Calcul : ‚àí59,50 + 160 = ?`;
            fb.className = "feedback error";
        } else {
            fb.innerHTML = `‚ùå <b>V√©rifie ton calcul.</b><br>Yanis part de <strong>‚àí59,50 ‚Ç¨</strong>. S'il √©conomise <strong>160,00 ‚Ç¨</strong>, son nouveau solde est :<br><strong>‚àí59,50 + 160,00 = ?</strong>`;
            fb.className = "feedback error";
        }
    }

    // === √âTAPE 3 ===
    async function verifierEtape3() {
        const input = document.getElementById('q3-mois');
        const userMois = parseInt(input.value);
        const fb = document.getElementById('fb3');
        
        // V√©rification champ vide
        if (isNaN(userMois) || userMois < 1) {
            fb.innerHTML = `‚ö†Ô∏è <b>Entre un nombre de mois !</b><br>Divise 450 par 100,50 et arrondis au mois sup√©rieur.`;
            fb.className = "feedback warning";
            input.focus();
            return;
        }
        
        // V√©rification r√©ponse
        if (userMois === moisNecessaires) {
            fb.innerHTML = `üèÜ <b>Mission r√©ussie !</b><br>
            <div class="math-box">üìê Calcul : 450 ‚Ç¨ √∑ 100,50 ‚Ç¨ = 4,47 mois<br>
            ‚Üí Au 4√®me mois : 4 √ó 100,50 = 402 ‚Ç¨ (pas assez)<br>
            ‚Üí Au <strong>5√®me mois</strong> : 5 √ó 100,50 = <strong>502,50 ‚Ç¨</strong> ‚úì</div>
            <p style="margin-top:10px;">Yanis doit attendre le <strong>5√®me mois</strong> pour avoir les 450 ‚Ç¨ n√©cessaires √† la r√©paration.</p>`;
            fb.className = "feedback success";
            document.getElementById('final-step').style.display = 'block';
            
            // Envoi du score
            envoyerResultatFinal();
        } else if (userMois === 4) {
            fb.innerHTML = `‚ùå <b>Presque !</b><br>Au 4√®me mois, Yanis aura : 4 √ó 100,50 = <strong>402 ‚Ç¨</strong><br>C'est insuffisant pour payer les 450 ‚Ç¨. Il doit donc attendre <strong>un mois de plus</strong>.`;
            fb.className = "feedback error";
        } else {
            fb.innerHTML = `‚ùå <b>Attention √† l'arrondi !</b><br>Divise <strong>450 √∑ 100,50 = 4,47...</strong><br>Comme on ne peut pas attendre 4,47 mois, Yanis doit attendre le mois <strong>entier suivant</strong>.`;
            fb.className = "feedback error";
        }
    }

    // === ENVOI FIREBASE ===
    async function envoyerResultatFinal() {
        try {
            if (typeof firebase === 'undefined' || !firebase.apps) {
                console.log("Firebase non disponible - Mode hors ligne");
                return;
            }
            
            if (!firebase.apps.length && typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
            }
            
            if (!firebase.apps.length) {
                console.log("Configuration Firebase manquante");
                return;
            }
            
            const db = firebase.firestore();
            const code = localStorage.getItem("codeEleve") || "ANONYME";
            const classe = (typeof ANNUAIRE !== 'undefined' && ANNUAIRE[code]) ? ANNUAIRE[code] : "AUTRE";

            await db.collection("resultats_exercices").add({
                eleve: code,
                classe: classe,
                exercice: "Module D2 - Yanis Arbitrage",
                note: 20,
                total: 20,
                competences: {
                    "C1": 20, 
                    "C2": 20,
                    "C4": 20
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("‚úÖ R√©sultats envoy√©s vers C1, C2 et C4 pour " + code);

        } catch (e) {
            console.error("Erreur lors de l'envoi Firebase : ", e);
        }
    }

    // === VALIDATION PAR TOUCHE ENTR√âE ===
    document.getElementById('q1-solde').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifierEtape1();
    });
    document.getElementById('q2-solde').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifierEtape2();
    });
    document.getElementById('q3-mois').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifierEtape3();
    });
</script>
</body>
</html>
