<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Yanis : Sortir du rouge et √©pargner</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="annuaire.js"></script>

    <style>
        :root { --primary: #2563eb; --success: #16a34a; --error: #dc2626; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .box { background: #fef2f2; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 6px solid var(--error); }
        .step { display: none; margin-top: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; }
        .step.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .data-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        input[type="number"] { padding: 10px; border: 2px solid #cbd5e1; border-radius: 6px; width: 140px; font-weight: bold; }
        .btn { padding: 12px 25px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .btn-restart { background: #64748b; margin-top: 30px; width: 100%; padding: 15px; font-size: 1.1rem; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .feedback { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; }
        .feedback.success { display: block; background: #dcfce7; color: #166534; border-left: 5px solid var(--success); }
        .feedback.error { display: block; background: #fee2e2; color: #991b1b; border-left: 5px solid var(--error); }
        .math-box { background: #fff; padding: 10px; border: 1px dashed #cbd5e1; margin-top: 10px; font-family: monospace; font-weight: bold; color: #1e293b; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üõ†Ô∏è Mission : Le Budget de Yanis</h1>
        <script>
            if(typeof enregistrerVisite === "function") {
                enregistrerVisite("Exercice Yanis - Arbitrage");
            }
        </script>
    </header>

    <div class="box">
        <strong>SITUATION CRITIQUE :</strong> Yanis est √† d√©couvert. Sa voiture est en panne et la r√©paration co√ªte <strong>450,00 ‚Ç¨</strong>.
        
        <table class="data-table">
            <tr><td>Total des Recettes (Salaire + Aides) :</td><td align="right"><strong>1 250,50 ‚Ç¨</strong></td></tr>
            <tr><td>Total des D√©penses Actuelles :</td><td align="right"><strong>1 310,00 ‚Ç¨</strong></td></tr>
        </table>
    </div>

    <div id="step1" class="step active">
        <h3>1. Calculer le solde actuel</h3>
        <p>Pour comprendre pourquoi Yanis est en difficult√©, calculez son solde mensuel (Recettes - D√©penses).</p>
        <p><i>Astuce : Le r√©sultat sera n√©gatif.</i></p>
        <input type="number" step="0.01" id="q1-solde"> ‚Ç¨
        <button class="btn" onclick="verifierEtape1()">V√©rifier le diagnostic</button>
        <div id="fb1" class="feedback"></div>
    </div>

    <div id="step2" class="step">
        <h3>2. Stopper le d√©ficit (Arbitrage)</h3>
        <p>Yanis d√©cide de supprimer ses abonnements de streaming et de r√©duire ses sorties. Il √©conomise ainsi <strong>160,00 ‚Ç¨</strong> par mois.</p>
        <p><strong>Quel est son NOUVEAU solde (Ancien solde + 160,00 ‚Ç¨) ?</strong></p>
        <input type="number" step="0.01" id="q2-solde"> ‚Ç¨
        <button class="btn" onclick="verifierEtape2()">Calculer le nouveau solde</button>
        <div id="fb2" class="feedback"></div>
    </div>

    <div id="step3" class="step">
        <h3>3. √âpargner pour la r√©paration</h3>
        <p>Maintenant qu'il lui reste de l'argent √† la fin du mois, il peut √©pargner pour sa r√©paration de 450,00 ‚Ç¨.</p>
        <p><strong>Dans combien de mois entiers aura-t-il la somme totale ?</strong></p>
        <input type="number" id="q3-mois"> mois
        <button class="btn" onclick="verifierEtape3()">V√©rifier la dur√©e</button>
        <div id="fb3" class="feedback"></div>
    </div>

    <div id="final-step" style="display:none;">
        <button class="btn-restart" onclick="location.reload()">üîÑ RECOMMENCER L'EXERCICE</button>
    </div>
</div>

<script>
    const prixReparation = 450.00;
    const soldeInitial = -59.50;

    function verifierEtape1() {
        const userSolde = parseFloat(document.getElementById('q1-solde').value);
        const fb = document.getElementById('fb1');
        
        if (Math.abs(userSolde - soldeInitial) < 0.1) {
            fb.innerHTML = `‚úÖ <b>Correct !</b> Yanis perd <b>59,50 ‚Ç¨</b> chaque mois. Son budget est <b>d√©ficitaire</b>.<br>
            <div class="math-box">Calcul : 1250,50 (Revenus) - 1310,00 (D√©penses) = -59,50 ‚Ç¨</div>`;
            fb.className = "feedback success";
            document.getElementById('step2').classList.add('active');
        } else {
            fb.innerHTML = `‚ùå <b>Erreur de calcul.</b><br>Fais l'op√©ration : 1250,50 - 1310,00. Le r√©sultat doit √™tre n√©gatif car les d√©penses sont plus grandes que les revenus.`;
            fb.className = "feedback error";
        }
    }

    function verifierEtape2() {
        const userNouvSolde = parseFloat(document.getElementById('q2-solde').value);
        const fb = document.getElementById('fb2');
        const nouveauSolde = 100.50;

        if (Math.abs(userNouvSolde - nouveauSolde) < 0.1) {
            fb.innerHTML = `‚úÖ <b>Bien jou√© !</b> Son budget est maintenant <b>exc√©dentaire</b>.<br>
            <div class="math-box">Calcul : -59,50 (D√©ficit) + 160,00 (√âconomies) = 100,50 ‚Ç¨ d'√©pargne possible par mois.</div>`;
            fb.className = "feedback success";
            document.getElementById('step3').classList.add('active');
        } else {
            fb.innerHTML = `‚ùå <b>V√©rifie ton calcul.</b><br>Yanis part de -59,50 ‚Ç¨. S'il rajoute 160,00 ‚Ç¨ d'√©conomies, combien lui reste-t-il ? (-59,50 + 160)`;
            fb.className = "feedback error";
        }
    }

    async function verifierEtape3() {
        const userMois = parseInt(document.getElementById('q3-mois').value);
        const fb = document.getElementById('fb3');
        
        if (userMois === 5) {
            fb.innerHTML = `üèÜ <b>Mission r√©ussie !</b><br>
            <div class="math-box">Calcul : 450 ‚Ç¨ (R√©paration) / 100,50 ‚Ç¨ (√âpargne) = 4,47 mois.<br>Julie doit attendre le 5√®me mois pour avoir la somme compl√®te de 450 ‚Ç¨.</div>`;
            fb.className = "feedback success";
            document.getElementById('final-step').style.display = 'block';
            
            // Validation finale -> Envoi Score
            envoyerResultatFinal();
        } else {
            fb.innerHTML = `‚ùå <b>Attention √† l'arrondi !</b><br>Divise 450 par 100,50. Si tu trouves 4,47, cela veut dire qu'au 4√®me mois, il n'a pas encore assez. Il doit donc attendre le <b>5√®me mois</b>.`;
            fb.className = "feedback error";
        }
    }

    async function envoyerResultatFinal() {
        // --- ENVOI FIREBASE (Comp√©tences C1, C2, C4) ---
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();
            
            // R√©cup√©ration Identit√©
            const code = localStorage.getItem("codeEleve") || "ANONYME";
            const classe = (typeof ANNUAIRE !== 'undefined' && ANNUAIRE[code]) ? ANNUAIRE[code] : "AUTRE";

            // Envoi (Note max car exercice r√©ussi)
            await db.collection("resultats_exercices").add({
                eleve: code,
                classe: classe,
                exercice: "Module D2 - Yanis Arbitrage",
                note: 20,
                total: 20,
                competences: {
                    "C1": 20, 
                    "C2": 20,
                    "C4": 20
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("‚úÖ R√©sultats envoy√©s vers C1, C2 et C4 pour " + code);

        } catch (e) {
            console.error("Erreur lors de l'envoi Firebase : ", e);
        }
    }
</script>
</body>
</html>
