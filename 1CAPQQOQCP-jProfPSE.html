<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover"/>
<title>QQOQCP – Entraînement CAP (Mobile)</title>
<style>
  :root{
    --bg:#0f172a; --text:#f1f5f9; --muted:#94a3b8;
    --line:rgba(255,255,255,.12);
    --c1:#8b5cf6; --c2:#3b82f6; --c3:#06b6d4; --c4:#10b981; --c5:#f59e0b; --err:#ef4444;
    --shadow:0 12px 30px rgba(0,0,0,.45); --radius:20px;
    --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
  body{
    margin:0; font-family:var(--font-ui); color:var(--text);
    background:var(--bg); padding:16px; padding-bottom:140px;
    background-image:
      radial-gradient(at 0% 0%, rgba(139,92,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 0%, rgba(59,130,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 100%, rgba(16,185,129,0.1) 0px, transparent 50%);
    background-attachment: fixed;
    overflow-x:hidden;
  }

  .wrap{max-width:800px; margin:0 auto; display:grid; gap:20px}
  .card{
    border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(30,41,59,.6); padding:20px; box-shadow:var(--shadow);
  }

  /* Page 0 */
  #introOverlay{
    position:fixed; inset:0;
    background: rgba(11, 18, 32, 0.88);
    backdrop-filter: blur(10px);
    z-index: 2000;
    display:flex; align-items:center; justify-content:center;
    padding: max(18px, env(safe-area-inset-top)) 18px max(18px, env(safe-area-inset-bottom)) 18px;
  }
  .intro-card{
    width:100%; max-width:520px;
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.92), rgba(15, 23, 42, 0.96));
    border:1px solid rgba(255,255,255,0.16);
    border-radius:24px;
    padding:22px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.55);
    text-align:center;
  }
  .intro-kicker{ font-weight:900; letter-spacing:.2px; }
  .intro-title{
    margin:10px 0 12px 0;
    font-size:1.35rem;
    background:linear-gradient(90deg, #fff, #cbd5e1);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .intro-obj{
    margin:0;
    color:var(--text);
    line-height:1.55;
    font-size:1rem;
  }
  .intro-obj b{ color:#fff; }
  .intro-comp{
    margin-top:12px;
    display:inline-flex; align-items:center; justify-content:center;
    padding:8px 14px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.05);
    font-weight:900;
  }

  .btn{
    border:none; padding:14px 18px; border-radius:14px; font-weight:900; cursor:pointer;
    font-family:inherit; font-size:1rem; transition:all 0.2s;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-primary{ background:linear-gradient(135deg, var(--c2), var(--c1)); color:white; width:100%; margin-top:16px; }
  .btn-primary:active{ transform:scale(0.98); }
  .btn-sec{ background:rgba(255,255,255,.08); color:var(--text); border:1px solid var(--line); min-width:120px; }
  .btn-check{ background: var(--c3); color: #0f172a; min-width:140px; }

  /* Navigation */
  .topbar{
    position:sticky;
    top: max(10px, env(safe-area-inset-top));
    z-index: 10;
    display:flex;
    gap:10px;
    justify-content:space-between;
    align-items:center;
  }
  .topbar .navgroup{ display:flex; gap:10px; flex-wrap:wrap; }
  .navbtn{
    padding:10px 12px;
    border-radius:14px;
    background: rgba(15, 23, 42, 0.8);
    border:1px solid var(--line);
    color:var(--text);
    font-weight:900;
    cursor:pointer;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .navbtn:active{ transform:scale(0.98); }
  .navbtn[hidden]{ display:none !important; }

  /* Header */
  .header{ display:grid; gap:14px; }
  .hero{
    border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(255,255,255,.03); backdrop-filter:blur(10px);
    padding:18px; box-shadow:var(--shadow); overflow:hidden;
  }
  .hero h1{
    margin:0 0 8px 0;
    font-size:1.35rem;
    background:linear-gradient(90deg, #fff, #cbd5e1);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .chip{
    padding:6px 12px; border-radius:99px; font-size:0.78rem; font-weight:900;
    border:1px solid var(--line); background:rgba(255,255,255,.05);
  }
  .hud-strip{
    display:flex; flex-wrap:wrap; gap:10px;
    justify-content:center; align-items:center;
    background: rgba(15, 23, 42, 0.8); border: 1px solid var(--line);
    padding: 10px 16px; border-radius: 99px; font-weight: 900; font-size: 0.92rem;
    backdrop-filter: blur(5px);
  }
  .progress-track{ width:160px; height:8px; background:rgba(255,255,255,.1); border-radius:99px; overflow:hidden; }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--c1), var(--c3)); transition:width 0.4s ease; }

  /* Quiz */
  .stepper{display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap}
  .step{ width:30px; height:6px; border-radius:4px; background:rgba(255,255,255,.1); transition:0.3s; }
  .step.active{ background:var(--c3); box-shadow:0 0 10px var(--c3); }
  .step.done{ background:var(--c4); }

  .q-tag{
    display:inline-flex; align-items:center; gap:8px; padding:6px 12px;
    border-radius:99px; background:rgba(6,182,212,.1); color:var(--c3);
    font-weight:900; font-size:0.82rem; margin-bottom:12px; border:1px solid rgba(6,182,212,.2);
  }

  .situation-box{
    background:rgba(0,0,0,.2); border-radius:16px; padding:16px; border:1px solid var(--line);
    margin-bottom:16px; display:grid; gap:16px;
  }
  @media(min-width:600px){ .situation-box{grid-template-columns: 2fr 1fr;} }
  .sit-text{ line-height:1.6; font-size:1rem; text-align: justify; }
  .sit-img{
    width:100%; height:160px; object-fit:cover; border-radius:12px;
    border:1px solid var(--line); background:#000;
  }

  .prompt{
    font-size:1.05rem; font-weight:900; margin-bottom:16px; display:flex; gap:12px; align-items:flex-start;
    background:rgba(255,255,255,.03); padding:16px; border-radius:16px; border-left:4px solid var(--c5);
  }

  .options { display:grid; gap:12px; margin-bottom:20px; }
  .opt-label{
    display:flex; align-items:center; gap:12px; padding:16px;
    background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:16px;
    cursor:pointer; transition:0.2s;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .opt-label:active{ background:rgba(255,255,255,.1); transform:scale(0.99); }
  .opt-label input{ width:22px; height:22px; accent-color:var(--c3); }
  .opt-text{ font-weight:700; line-height:1.4; font-size:1rem; }

  .panel{ margin-top:16px; padding:16px; border-radius:16px; display:none; animation: slideDown 0.25s ease; font-weight:900; }
  .panel.ok{ background:rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.3); color:#6ee7b7; }
  .panel.bad{ background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.3); color:#fca5a5; }
  .panel.warn{ background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.3); color:#fcd34d; }

  .help-line{
    margin-top:12px;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color: var(--muted);
    line-height:1.45;
    font-weight:800;
  }

  .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
  @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
  @keyframes slideDown{ from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)} }

  #confetti{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:999; }
  #finalScreen{ text-align:center; padding:40px 20px; display:none; }
  .big-score{ font-size:3rem; font-weight:900; margin:10px 0; background:linear-gradient(to right, var(--c4), var(--c3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

  @media (max-width:420px){
    body{ padding:12px; padding-bottom:140px; }
    .card{ padding:16px; }
    .hero{ padding:16px; }
    .progress-track{ width:140px; }
  }
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div id="introOverlay">
  <div class="intro-card">
    <div class="intro-kicker">PSE</div>
    <div class="intro-title">QQOQCP – Entraînement CAP (Mobile)</div>
    <p class="intro-obj"><b>Objectif :</b> être capable d’appliquer la méthode QQOQCP.</p>
    <div class="intro-comp">compétence 2</div>
    <button class="btn btn-primary" id="startBtn" type="button">Démarrer</button>
  </div>
</div>

<div class="wrap">

  <div class="topbar">
    <div class="navgroup">
      <button class="navbtn" type="button" id="btnBack">Retour</button>
      <button class="navbtn" type="button" id="btnTop">Haut</button>
    </div>
    <button class="navbtn" type="button" id="btnHome" hidden>Sommaire</button>
  </div>

  <div class="header">
    <div class="hero">
      <h1>QQOQCP – CAP</h1>
      <div class="chips">
        <span class="chip" style="color:var(--c1)">● Méthodologie</span>
        <span class="chip" style="color:var(--c2)">● Compétence C2</span>
      </div>
      <div class="help-line" id="helpLine">Lis la situation puis réponds à la question.</div>
    </div>

    <div class="hud-strip">
      <span>Progression <span id="txtProg" style="color:var(--c3)">1 / 6</span></span>
      <div class="progress-track"><div id="bar" class="progress-fill"></div></div>
      <span>Score <span id="txtScore" style="color:#fff">0</span></span>
    </div>
  </div>

  <div class="card" id="qCard" style="display:none">
    <div class="stepper" id="stepper"></div>

    <div id="gameContent">
      <div class="q-tag" id="qTag">Tag</div>
      <h2 id="qTitle" style="margin:0 0 16px 0; font-size:1.25rem">Titre Question</h2>

      <div class="situation-box">
        <div class="sit-text" id="qText">Texte situation...</div>
        <img id="qImg" class="sit-img" src="" alt="Situation" onerror="this.style.display='none'">
      </div>

      <div class="prompt">
        <span style="color:var(--c5); font-size:1.5rem; margin-right:8px">?</span>
        <span id="qPrompt">La question...</span>
      </div>

      <div class="options" id="optionsBox"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:20px; padding-top:20px; border-top:1px solid var(--line)">
        <button class="btn btn-primary btn-check" id="btnVal" type="button">Valider</button>
        <button class="btn btn-sec" id="btnHint" type="button" disabled>Indice</button>
        <button class="btn btn-sec" id="btnSkip" type="button" style="opacity:0.8">Passer</button>
      </div>

      <div id="feedback" class="panel"></div>
    </div>

    <div id="finalScreen">
      <h2>Terminé</h2>
      <div class="big-score" id="finalScoreVal">0/18</div>
      <p id="finalMsg" style="color:var(--muted); margin-bottom:30px; font-weight:900">Analyse...</p>
      <button class="btn btn-primary" type="button" onclick="location.reload()">Recommencer</button>
    </div>
  </div>

</div>

<script>
  const HOME_URL = ""; // si vide, on cache le bouton Sommaire

  const QUESTIONS = [
    {
      title: "Niveau 1 — Identifier le problème",
      tag: "Problème",
      text: "Trois personnes meurent chaque jour, en France, d’un accident ou d’une maladie liés à leurs conditions de travail. Beaucoup auraient pu être évités si les mesures de prévention étaient respectées.",
      img: "photo-accident-travail.jpg",
      prompt: "Quel est le problème posé ici ?",
      options: [
        {id:"a", text:"Comment améliorer les conditions de travail ?"},
        {id:"b", text:"Le non-respect des mesures de prévention."},
        {id:"c", text:"Comment devenir acteur de prévention ?"}
      ],
      ans: "b",
      exp: "Le texte lie directement les décès au fait que les mesures ne sont pas respectées."
    },
    {
      title: "Niveau 2 — Identifier Qui ?",
      tag: "QQOQCP : Qui",
      text: "Accidents et maladies liés au travail : les victimes sont des salariés, en majorité des ouvriers.",
      img: "photo-ouvrier-travail.jpg",
      prompt: "Qui est concerné par le problème ?",
      options: [
        {id:"a", text:"Les élèves du lycée"},
        {id:"b", text:"Les salariés, majoritairement des ouvriers"},
        {id:"c", text:"Les touristes et passants"}
      ],
      ans: "b",
      exp: "C'est écrit noir sur blanc : 'les victimes sont des salariés'."
    },
    {
      title: "Niveau 3 — Identifier Où ?",
      tag: "QQOQCP : Où",
      text: "Le problème apparaît sur le lieu de travail et se répète chaque jour.",
      img: "photo-lieu-travail.jpg",
      prompt: "'Sur le lieu de travail' répond à quelle question ?",
      options: [
        {id:"a", text:"Quand ? (Temps)"},
        {id:"b", text:"Pourquoi ? (Cause)"},
        {id:"c", text:"Où ? (Lieu)"}
      ],
      ans: "c",
      exp: "Le lieu de travail indique une localisation géographique = OÙ."
    },
    {
      title: "Niveau 4 — Analyser le Pourquoi",
      tag: "Contraception",
      text: "Ophélie a oublié sa pilule. Le couple ne souhaite pas d’enfant pour l’instant et s'inquiète.",
      img: "photo-couple-jeunes.jpg",
      prompt: "Pourquoi faut-il résoudre ce problème ?",
      options: [
        {id:"a", text:"Pour changer de méthode de contraception"},
        {id:"b", text:"Pour éviter une grossesse non désirée"},
        {id:"c", text:"Pour améliorer leurs performances"}
      ],
      ans: "b",
      exp: "L'enjeu (le Pourquoi) est d'éviter une grossesse qu'ils ne souhaitent pas."
    },
    {
      title: "Niveau 5 — Analyser l'Enjeu",
      tag: "Santé Publique",
      text: "Le manque d’exercice est un facteur de risque. Les personnes inactives ont un risque de décès majoré de 20% à 30%.",
      img: "photo-sedentarite-canape.jpg",
      prompt: "Quel est l'enjeu majeur ici ?",
      options: [
        {id:"a", text:"Réduire le risque de décès lié à la sédentarité"},
        {id:"b", text:"Interdire les voitures en ville"},
        {id:"c", text:"Regarder moins la télévision"}
      ],
      ans: "a",
      exp: "Le texte parle d'un risque de décès augmenté : l'enjeu est donc de réduire ce risque."
    },
    {
      title: "Niveau 6 — Définir la Sédentarité",
      tag: "Définition",
      text: "Définition : La sédentarité correspond à des situations passées en position assise ou allongée (en dehors du sommeil), dans lesquelles les dépenses énergétiques sont très faibles.",
      img: "photo-sedentarite.jpg",
      prompt: "D'après cette définition, quelle situation est sédentaire ?",
      options: [
        {id:"a", text:"Faire une séance de sport intensive en salle."},
        {id:"b", text:"Travailler longuement assis devant un écran."},
        {id:"c", text:"Aller courir ou faire une activité physique régulière."}
      ],
      ans: "b",
      exp: "Dormir est exclu. Marcher est une activité physique. Être assis à l'écran correspond à la définition."
    }
  ];

  const $ = (id)=>document.getElementById(id);

  let state = { idx:0, score:0, tries:0, locked:false };

  const setHelp = (msg)=>{ $("helpLine").textContent = msg; };

  const startGame = ()=>{
    $("introOverlay").style.display = "none";
    $("qCard").style.display = "block";
    setHelp("Lis la situation puis réponds à la question.");
    loadQuestion();
    window.scrollTo({ top: 0, behavior: "instant" });
  };

  const loadQuestion = ()=>{
    if(state.idx >= QUESTIONS.length){ showFinal(); return; }
    const q = QUESTIONS[state.idx];
    state.tries = 0; state.locked = false;

    $("qTitle").textContent = q.title;
    $("qTag").textContent = q.tag;
    $("qText").textContent = q.text;
    $("qImg").style.display = "";
    $("qImg").src = q.img;
    $("qPrompt").textContent = q.prompt;

    $("feedback").style.display="none";
    $("feedback").className="panel";
    $("btnVal").disabled = false;
    $("btnHint").disabled = true;

    const box = $("optionsBox");
    box.innerHTML = "";

    [...q.options].sort(()=>Math.random()-0.5).forEach(o=>{
      const div = document.createElement("div");
      div.className = "opt-label";
      div.innerHTML = `<input type="radio" name="opt" value="${o.id}" id="opt_${o.id}">
                       <label class="opt-text" for="opt_${o.id}" style="cursor:pointer; flex:1">${o.text}</label>`;
      div.addEventListener("click", ()=>{
        div.querySelector("input").checked = true;
        document.querySelectorAll(".opt-label").forEach(d=>d.style.borderColor="var(--line)");
        div.style.borderColor = "var(--c3)";
      });
      box.appendChild(div);
    });

    updateHUD();
  };

  const validate = ()=>{
    if(state.locked) return;
    const sel = document.querySelector('input[name="opt"]:checked');
    if(!sel){
      setHelp("Choisis une réponse.");
      $("optionsBox").classList.add("shake");
      setTimeout(()=>$("optionsBox").classList.remove("shake"), 500);
      return;
    }

    const q = QUESTIONS[state.idx];
    state.tries++;

    if(sel.value === q.ans){
      state.locked = true;
      const pts = (state.tries===1)? 3 : (state.tries===2? 2 : 1);
      state.score += pts;

      $("feedback").textContent = "Bravo ! " + q.exp;
      $("feedback").className = "panel ok";
      $("feedback").style.display = "block";
      setHelp(`Correct. +${pts} points.`);

      $("btnVal").disabled = true;
      setTimeout(nextQ, 1400);
    } else {
      if(state.tries >= 1) $("btnHint").disabled = false;
      $("optionsBox").classList.add("shake");
      setTimeout(()=>$("optionsBox").classList.remove("shake"), 500);

      $("feedback").textContent = `Tentative ${state.tries}/3 incorrecte.`;
      $("feedback").className = "panel bad";
      $("feedback").style.display = "block";
      setHelp("Essaie encore.");
    }
    updateHUD();
  };

  const showHint = ()=>{
    setHelp("Indice affiché.");
    $("feedback").className = "panel warn";
    $("feedback").textContent = "Indice : relis bien le texte, la réponse y est souvent écrite.";
    $("feedback").style.display = "block";
  };

  const nextQ = ()=>{ state.idx++; loadQuestion(); };

  const updateHUD = ()=>{
    const len = QUESTIONS.length;
    $("txtProg").textContent = `${Math.min(state.idx+1, len)} / ${len}`;
    $("bar").style.width = `${(state.idx / len)*100}%`;
    $("txtScore").textContent = state.score;

    const st = $("stepper");
    st.innerHTML = "";
    for(let i=0;i<len;i++){
      st.innerHTML += `<div class="step ${i===state.idx?'active':(i<state.idx?'done':'')}"></div>`;
    }
  };

  const showFinal = ()=>{
    $("gameContent").style.display = "none";
    $("finalScreen").style.display = "block";
    $("finalScoreVal").textContent = `${state.score} / ${QUESTIONS.length*3}`;
    const pct = state.score / (QUESTIONS.length*3);
    $("finalMsg").textContent = pct > 0.8 ? "Tu es un expert." : "Bien joué.";
    setHelp("Session terminée.");
    launchConfetti();
    updateHUD();
  };

  function launchConfetti() {
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d', { alpha:true });
    const resize = ()=>{ canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    resize();

    const pieces = [];
    for(let i=0;i<100;i++){
      pieces.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height - canvas.height,
        color: `hsl(${Math.random()*360}, 100%, 50%)`,
        size: Math.random()*8+4,
        speed: Math.random()*3+2,
        drift: (Math.random()-0.5)*1.2
      });
    }

    const start = Date.now();
    let rafId = 0;

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      pieces.forEach(p=>{
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, p.size, p.size);
        p.y += p.speed;
        p.x += p.drift;
        if(p.y > canvas.height + 10) p.y = -10;
        if(p.x < -10) p.x = canvas.width + 10;
        if(p.x > canvas.width + 10) p.x = -10;
      });
      if(Date.now() - start < 4500){
        rafId = requestAnimationFrame(draw);
      }else{
        cancelAnimationFrame(rafId);
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
    }
    draw();

    window.addEventListener("resize", resize, { passive:true });
    setTimeout(()=>window.removeEventListener("resize", resize), 5000);
  }

  function initNav(){
    const homeBtn = $("btnHome");
    if(HOME_URL && HOME_URL.trim() !== ""){
      homeBtn.hidden = false;
      homeBtn.addEventListener("click", ()=>{ window.location.href = HOME_URL; });
    }else{
      homeBtn.hidden = true;
    }

    $("btnBack").addEventListener("click", ()=>{
      if(history.length > 1) history.back();
      else window.scrollTo({ top: 0, behavior: "smooth" });
    });

    $("btnTop").addEventListener("click", ()=>{
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  }

  $("startBtn").addEventListener("click", startGame);
  $("btnVal").addEventListener("click", validate);
  $("btnHint").addEventListener("click", showHint);
  $("btnSkip").addEventListener("click", nextQ);

  initNav();
  updateHUD();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentDocId = null;
  let startTime = Date.now();

  function getIdentity() { return localStorage.getItem("cockpit_student_id"); }

  async function demarrerVisite() {
    try {
      let userCode = getIdentity() || "ANONYME";
      let userClass = localStorage.getItem("cockpit_student_class") || "VISITEUR";
      const pageName = document.title || window.location.pathname.split("/").pop();
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);

      const ref = await addDoc(collection(db, "statistiques_usage"), {
        page: pageName,
        userCode: userCode,
        classe: userClass,
        device: isMobile ? "Mobile" : "Desktop",
        action: "Consultation",
        duree: 0,
        timestamp: serverTimestamp(),
        date: new Date().toISOString()
      });

      currentDocId = ref.id;

      setInterval(async () => {
        if (currentDocId && document.visibilityState === "visible") {
          try {
            await updateDoc(doc(db, "statistiques_usage", currentDocId), {
              duree: Math.floor((Date.now() - startTime) / 1000)
            });
          } catch (e) {}
        }
      }, 10000);

    } catch (e) { console.warn("Erreur Tracker", e); }
  }

  demarrerVisite();
</script>

</body>
</html>
