<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"/>
<title>QQOQCP ‚Äì Entra√Ænement CAP (Mobile)</title>
<style>
  :root{
    --bg:#0f172a; --text:#f1f5f9; --muted:#94a3b8; 
    --line:rgba(255,255,255,.12);
    --c1:#8b5cf6; --c2:#3b82f6; --c3:#06b6d4; --c4:#10b981; --c5:#f59e0b; --err:#ef4444;
    --shadow:0 12px 30px rgba(0,0,0,.45); --radius:20px;
    --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:var(--font-ui); color:var(--text);
    background:var(--bg); padding:16px; padding-bottom:140px;
    background-image: 
      radial-gradient(at 0% 0%, rgba(139,92,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 0%, rgba(59,130,246,0.15) 0px, transparent 50%),
      radial-gradient(at 100% 100%, rgba(16,185,129,0.1) 0px, transparent 50%);
    background-attachment: fixed;
    overflow-x:hidden;
  }
  
  .wrap{max-width:800px; margin:0 auto; display:grid; gap:20px}
  
  .header{ display:flex; flex-wrap:wrap; gap:16px; align-items:stretch; }
  .hero{
    flex:1 1 100%; border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(255,255,255,.03); backdrop-filter:blur(10px);
    padding:20px; box-shadow:var(--shadow); position:relative; overflow:hidden;
  }
  .hero h1{margin:0 0 8px 0; font-size:1.4rem; background:linear-gradient(90deg, #fff, #cbd5e1); -webkit-background-clip:text; -webkit-text-fill-color: transparent;}
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
  .chip{
    padding:6px 12px; border-radius:99px; font-size:0.75rem; font-weight:700;
    border:1px solid var(--line); background:rgba(255,255,255,.05); display:flex; align-items:center; gap:6px;
  }
  
  .hud-strip {
    display:flex; flex-wrap:wrap; gap:10px;
    justify-content:center; align-items:center;
    background: rgba(15, 23, 42, 0.8); border: 1px solid var(--line);
    padding: 10px 16px; border-radius: 99px; font-weight: 700; font-size: 0.9rem;
    backdrop-filter: blur(5px);
  }
  .progress-track{ width:140px; height:8px; background:rgba(255,255,255,.1); border-radius:99px; overflow:hidden; }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--c1), var(--c3)); transition:width 0.5s ease; }

  #loginOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(11, 18, 32, 0.85); backdrop-filter: blur(8px);
    z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .login-card {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
    border: 1px solid rgba(255,255,255,0.15); border-radius: 24px;
    padding: 30px; width: 100%; max-width: 400px; text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transform: translateY(0); animation: floatUp 0.5s ease-out;
  }
  @keyframes floatUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
  
  .login-avatar {
    width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
    border: 3px solid var(--c2); margin-bottom: 20px;
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    background:#1e293b;
  }
  
  .btn{
    border:none; padding:14px 24px; border-radius:12px; font-weight:700; cursor:pointer;
    font-family:inherit; font-size:1rem; transition:all 0.2s; 
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
  }
  .btn-primary{ background:linear-gradient(135deg, var(--c2), var(--c1)); color:white; width:100%; }
  .btn-primary:active{ transform:scale(0.98); }
  
  .btn-check{ background: var(--c3); color: #0f172a; width: auto; min-width: 140px; }
  .btn-sec{ background:rgba(255,255,255,.08); color:var(--text); border:1px solid var(--line); width: auto; min-width: 100px; }
  .btn:disabled{ opacity:0.5; filter:grayscale(1); cursor:not-allowed; }

  .card{
    border:1px solid var(--line); border-radius:var(--radius);
    background:rgba(30,41,59,.6); padding:20px; box-shadow:var(--shadow);
    transition: transform 0.2s;
  }
  
  .stepper{display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap}
  .step{ width:30px; height:6px; border-radius:4px; background:rgba(255,255,255,.1); transition:0.3s; }
  .step.active{ background:var(--c3); box-shadow:0 0 10px var(--c3); }
  .step.done{ background:var(--c4); }

  .q-tag{
    display:inline-flex; align-items:center; gap:8px; padding:6px 12px;
    border-radius:99px; background:rgba(6,182,212,.1); color:var(--c3);
    font-weight:800; font-size:0.8rem; margin-bottom:12px; border:1px solid rgba(6,182,212,.2);
  }

  .situation-box{
    background:rgba(0,0,0,.2); border-radius:16px; padding:16px; border:1px solid var(--line);
    margin-bottom:16px; display:grid; gap:16px;
  }
  @media(min-width:600px){ .situation-box{grid-template-columns: 2fr 1fr;} }
  
  .sit-text{ 
    line-height:1.6; font-size:0.95rem; 
    white-space: normal;
    text-align: justify;
  }
  .sit-img{
    width:100%; height:160px; object-fit:cover; border-radius:12px; 
    border:1px solid var(--line); background:#000;
  }

  .prompt{
    font-size:1.1rem; font-weight:700; margin-bottom:16px; display:flex; gap:12px; align-items:start;
    background:rgba(255,255,255,.03); padding:16px; border-radius:16px; border-left:4px solid var(--c5);
  }

  .options { display:grid; gap:12px; margin-bottom:20px; }
  .opt-label {
    display:flex; align-items:center; gap:12px; padding:16px;
    background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:16px;
    cursor:pointer; transition:0.2s;
  }
  .opt-label:active { background:rgba(255,255,255,.1); transform:scale(0.99); }
  .opt-label input { width:20px; height:20px; accent-color:var(--c3); }
  .opt-text { font-weight:500; line-height:1.4; font-size:1rem; }

  .panel{ margin-top:16px; padding:16px; border-radius:16px; display:none; animation: slideDown 0.3s ease; }
  .panel.ok{ background:rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.3); color:#6ee7b7; }
  .panel.bad{ background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.3); color:#fca5a5; }
  .panel.warn{ background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.3); color:#fcd34d; }

  #floatCoach {
    position: fixed; bottom: 20px; right: 20px; z-index: 1000;
    display: flex; flex-direction: column; align-items: flex-end;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4));
  }
  #floatCoach.moved-left { right: auto; left: 20px; align-items: flex-start; }
  
  #floatAvatar {
    width: 70px; height: 70px; border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.2);
    object-fit: cover; background: #1e293b;
    cursor: pointer; transition: transform 0.2s;
  }
  #floatAvatar:active { transform: scale(0.95); }

  #floatBubble {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.99));
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff; padding: 16px; border-radius: 20px 20px 4px 20px;
    margin-bottom: 12px; max-width: 300px; width: 85vw;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-size: 0.95rem; line-height: 1.5;
  }
  #floatCoach.moved-left #floatBubble { border-radius: 20px 20px 20px 4px; }

  .a11y{
    display:flex; gap:8px; align-items:center;
  }
  .btn-a11y{
    padding:6px 10px; font-size:0.85rem; border-radius:10px;
    background:rgba(255,255,255,.08); color:var(--text); border:1px solid var(--line);
    cursor:pointer; font-weight:800;
  }
  .btn-a11y:active{ transform:scale(0.98); }

  @keyframes slideDown{ from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
  @keyframes popIn { from{opacity:0; transform:scale(0.8) translateY(10px)} to{opacity:1; transform:scale(1) translateY(0)} }
  .pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes pop { 0%{transform:scale(0.9)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }
  .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
  @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

  #confetti{ position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }
  #finalScreen{ text-align:center; padding:40px 20px; display:none; }
  .big-score{ font-size:3rem; font-weight:900; margin:10px 0; background:linear-gradient(to right, var(--c4), var(--c3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div id="loginOverlay">
  <div class="login-card">
    <img src="avatar-neutral.png" alt="Coach" class="login-avatar" id="startAvatar"
         onerror="this.src='https://placehold.co/100x100?text=Coach'">
    <h2 style="margin-top:0">Bienvenue !</h2>
    <p style="color:var(--muted); margin-bottom:20px">Je suis votre Prof PSE. On s'entra√Æne ?</p>
    <button class="btn btn-primary" id="startBtn">Commencer le Quiz</button>
  </div>
</div>

<div id="floatCoach" style="display:none" onclick="toggleCoachPos()">
  <div id="floatBubble">Bonjour ! Pr√™t √† commencer ?</div>
  <img id="floatAvatar" src="avatar-neutral.png" alt="Coach"
       onerror="this.src='https://placehold.co/70x70?text=Coach'">
</div>

<div class="wrap">
  
  <div class="header">
    <div class="hero">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap">
        <h1>QQOQCP ‚Äì CAP</h1>
        <div class="a11y">
          <button class="btn-a11y" type="button" onclick="changeSize(-1)">A-</button>
          <button class="btn-a11y" type="button" onclick="changeSize(1)">A+</button>
          <button class="btn" style="padding:6px 12px; font-size:0.8rem; background:rgba(255,255,255,0.1)" type="button" onclick="toggleMemo()">üìùM√©mo</button>
        </div>
      </div>
      <div class="chips">
        <span class="chip" style="color:var(--c1)">‚óè M√©thodologie</span>
        <span class="chip" style="color:var(--c2)">‚óè Comp√©tence C2</span>
      </div>
    </div>
    
    <div class="hud-strip">
      <span>Progression <span id="txtProg" style="color:var(--c3)">0 / 6</span></span>
      <div class="progress-track"><div id="bar" class="progress-fill"></div></div>
      <span>Score <span id="txtScore" style="color:#fff">0</span></span>
    </div>
  </div>

  <div id="memoPanel" class="card" style="display:none; border-color:var(--c3)">
    <h3 style="margin-top:0; color:var(--c3)">Rappel M√©thode</h3>
    <ul style="padding-left:20px; line-height:1.6; color:var(--muted)">
      <li><strong style="color:#dc2626">Quoi :</strong> Nature du probl√®me</li>
      <li><strong style="color:#ea580c">Qui :</strong> Personnes concern√©es</li>
      <li><strong style="color:#b91c1c">O√π :</strong> Lieu</li>
      <li><strong style="color:#7c3aed">Quand :</strong> Date, moment, dur√©e</li>
      <li><strong style="color:#2563eb">Comment :</strong> Cause, mani√®re</li>
      <li><strong style="color:#16a34a">Pourquoi :</strong> Cons√©quences, enjeux</li>
    </ul>
  </div>

  <div class="main-grid" id="gameGrid" style="display:none">
    <div class="card" id="qCard">
      <div class="stepper" id="stepper"></div>
      
      <div id="gameContent">
        <div class="q-tag" id="qTag">Tag</div>
        <h2 id="qTitle" style="margin:0 0 16px 0; font-size:1.3rem">Titre Question</h2>
        
        <div class="situation-box">
          <div class="sit-text" id="qText">Texte situation...</div>
          <img id="qImg" class="sit-img" src="" alt="Situation" onerror="this.style.display='none'">
        </div>

        <div class="prompt">
          <span style="color:var(--c5); font-size:1.5rem; margin-right:8px">?</span>
          <span id="qPrompt">La question...</span>
        </div>

        <div class="options" id="optionsBox"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:20px; padding-top:20px; border-top:1px solid var(--line)">
          <button class="btn btn-primary btn-check" id="btnVal" type="button">Valider</button>
          <button class="btn btn-sec" id="btnHint" type="button" disabled>Indice ?</button>
          <button class="btn btn-sec" id="btnSkip" type="button" style="opacity:0.6">Passer</button>
        </div>

        <div id="feedback" class="panel"></div>
      </div>

      <div id="finalScreen">
        <h2>Termin√© !</h2>
        <div class="big-score" id="finalScoreVal">0/15</div>
        <p id="finalMsg" style="color:var(--muted); margin-bottom:30px">Analyse...</p>
        <button class="btn btn-primary" type="button" onclick="location.reload()">Recommencer</button>
      </div>
    </div>
  </div>

</div>

<script>
let currentSize = 16;
function changeSize(delta) {
  currentSize += delta;
  if (currentSize < 12) currentSize = 12;
  if (currentSize > 24) currentSize = 24;
  document.documentElement.style.fontSize = currentSize + 'px';
  const h1 = document.querySelector('h1');
  if(h1) h1.style.fontSize = (2 * (currentSize/16)) + 'rem';
  try { localStorage.setItem("ui_font_size_px", String(currentSize)); } catch(e){}
}

(function restoreFont(){
  try{
    const v = parseInt(localStorage.getItem("ui_font_size_px") || "", 10);
    if(!isNaN(v)) { currentSize = v; changeSize(0); }
  }catch(e){}
})();
</script>

<script>
const AVATARS = {
  neutral: "avatar-neutral.png",
  happy: "avatar-bravo.png",
  think: "avatar-reflechir.png",
  warn: "avatar-attention.png"
};

const QUESTIONS = [
  {
    title: "Niveau 1 ‚Äî Identifier le probl√®me",
    tag: "Probl√®me",
    text: "Trois personnes meurent chaque jour, en France, d‚Äôun accident ou d‚Äôune maladie li√©s √† leurs conditions de travail. Beaucoup auraient pu √™tre √©vit√©s si les mesures de pr√©vention √©taient respect√©es.",
    img: "photo-accident-travail.jpg",
    prompt: "Quel est le probl√®me pos√© ici ?",
    options: [
      {id:"a", text:"Comment am√©liorer les conditions de travail ?"},
      {id:"b", text:"Le non-respect des mesures de pr√©vention."},
      {id:"c", text:"Comment devenir acteur de pr√©vention ?"}
    ],
    ans: "b",
    exp: "Le texte lie directement les d√©c√®s au fait que les mesures ne sont pas respect√©es."
  },
  {
    title: "Niveau 2 ‚Äî Identifier Qui ?",
    tag: "QQOQCP : Qui",
    text: "Accidents et maladies li√©s au travail : les victimes sont des salari√©s, en majorit√© des ouvriers.",
    img: "photo-ouvrier-travail.jpg",
    prompt: "Qui est concern√© par le probl√®me ?",
    options: [
      {id:"a", text:"Les √©l√®ves du lyc√©e"},
      {id:"b", text:"Les salari√©s, majoritairement des ouvriers"},
      {id:"c", text:"Les touristes et passants"}
    ],
    ans: "b",
    exp: "C'est √©crit noir sur blanc : 'les victimes sont des salari√©s'."
  },
  {
    title: "Niveau 3 ‚Äî Identifier O√π ?",
    tag: "QQOQCP : O√π",
    text: "Le probl√®me appara√Æt sur le lieu de travail et se r√©p√®te chaque jour.",
    img: "photo-lieu-travail.jpg",
    prompt: "'Sur le lieu de travail' r√©pond √† quelle question ?",
    options: [
      {id:"a", text:"Quand ? (Temps)"},
      {id:"b", text:"Pourquoi ? (Cause)"},
      {id:"c", text:"O√π ? (Lieu)"}
    ],
    ans: "c",
    exp: "Le lieu de travail indique une localisation g√©ographique = O√ô."
  },
  {
    title: "Niveau 4 ‚Äî Analyser le Pourquoi",
    tag: "Contraception",
    text: "Oph√©lie a oubli√© sa pilule. Le couple ne souhaite pas d‚Äôenfant pour l‚Äôinstant et s'inqui√®te.",
    img: "photo-couple-jeunes.jpg",
    prompt: "Pourquoi faut-il r√©soudre ce probl√®me ?",
    options: [
      {id:"a", text:"Pour changer de m√©thode de contraception"},
      {id:"b", text:"Pour √©viter une grossesse non d√©sir√©e"},
      {id:"c", text:"Pour am√©liorer leurs performances"}
    ],
    ans: "b",
    exp: "L'enjeu (le Pourquoi) est d'√©viter une grossesse qu'ils ne souhaitent pas."
  },
  {
    title: "Niveau 5 ‚Äî Analyser l'Enjeu",
    tag: "Sant√© Publique",
    text: "Le manque d‚Äôexercice est un facteur de risque. Les personnes inactives ont un risque de d√©c√®s major√© de 20% √† 30%.",
    img: "photo-sedentarite-canape.jpg",
    prompt: "Quel est l'enjeu majeur ici ?",
    options: [
      {id:"a", text:"R√©duire le risque de d√©c√®s li√© √† la s√©dentarit√©"},
      {id:"b", text:"Interdire les voitures en ville"},
      {id:"c", text:"Regarder moins la t√©l√©vision"}
    ],
    ans: "a",
    exp: "Le texte parle d'un risque de d√©c√®s augment√© : l'enjeu est donc de r√©duire ce risque."
  },
  {
    title: "Niveau 6 ‚Äî D√©finir la S√©dentarit√©",
    tag: "D√©finition",
    text: "D√©finition : La s√©dentarit√© correspond √† des situations pass√©es en position assise ou allong√©e (en dehors du sommeil), dans lesquelles les d√©penses √©nerg√©tiques sont tr√®s faibles.",
    img: "photo-sedentarite.jpg",
    prompt: "D'apr√®s cette d√©finition, quelle situation est s√©dentaire ?",
    options: [
      {id:"a", text:"Faire une s√©ance de sport intensive en salle."},
      {id:"b", text:"Travailler longuement assis devant un √©cran."},
      {id:"c", text:"Aller courir ou faire une activit√© physique r√©guli√®re."}
    ],
    ans: "b",
    exp: "Dormir est exclu. Marcher est une activit√© physique. √ätre assis √† l'√©cran correspond √† la d√©finition."
  }
];

const $=(id)=>document.getElementById(id);
let state={ idx:0, score:0, name:"", tries:0, locked:false };

function getIdentity(){ try { return localStorage.getItem("cockpit_student_id"); } catch(e){ return null; } }
function getDisplayName(){
  const code = getIdentity();
  return code ? code : "√âl√®ve";
}

const setCoach=(msg, mood="neutral")=>{
  $("floatBubble").textContent = msg;
  if(AVATARS[mood]) {
    $("floatAvatar").src = AVATARS[mood];
    $("floatAvatar").onerror = function(){ this.src="https://placehold.co/70x70?text=Coach"; };
  }
}

const toggleMemo=()=>{
  const p = $("memoPanel");
  p.style.display = (p.style.display==="none") ? "block" : "none";
}

const toggleCoachPos=()=>{
  const c = $("floatCoach");
  c.classList.toggle("moved-left");
}

const startGame=()=>{
  state.name = getDisplayName();

  $("loginOverlay").style.opacity = "0";
  setTimeout(()=>{
    $("loginOverlay").style.display = "none";
    $("floatCoach").style.display = "flex";
    $("gameGrid").style.display = "grid";
    setCoach("C'est parti ! Lis bien la situation.", "neutral");
    loadQuestion();
  }, 300);
}

const loadQuestion=()=>{
  if(state.idx >= QUESTIONS.length){ showFinal(); return; }
  const q = QUESTIONS[state.idx];
  state.tries=0; state.locked=false;
  
  $("qTitle").textContent = q.title; $("qTag").textContent = q.tag;
  $("qText").textContent = q.text;
  $("qImg").style.display = "";
  $("qImg").src = q.img;
  $("qPrompt").textContent = q.prompt;
  $("feedback").style.display="none"; $("feedback").className="panel";
  $("btnVal").disabled=false; $("btnHint").disabled=true;
  
  const box = $("optionsBox"); box.innerHTML = "";
  [...q.options].sort(()=>Math.random()-0.5).forEach(o => {
    const div = document.createElement("div"); div.className = "opt-label";
    div.innerHTML = `<input type="radio" name="opt" value="${o.id}" id="opt_${o.id}"><label class="opt-text" for="opt_${o.id}" style="cursor:pointer; flex:1">${o.text}</label>`;
    div.addEventListener("click", ()=>{ 
      div.querySelector("input").checked=true; 
      document.querySelectorAll(".opt-label").forEach(d=>d.style.borderColor="var(--line)");
      div.style.borderColor = "var(--c3)";
    });
    box.appendChild(div);
  });

  updateHUD();
  if(state.idx===0) setCoach("√Ä toi de jouer !", "neutral");
}

const validate=()=>{
  if(state.locked) return;
  const sel = document.querySelector('input[name="opt"]:checked');
  if(!sel){ 
    setCoach("Choisis une r√©ponse.", "warn");
    $("optionsBox").classList.add("shake");
    setTimeout(()=>$("optionsBox").classList.remove("shake"), 500);
    return; 
  }

  const q = QUESTIONS[state.idx];
  state.tries++;

  if(sel.value === q.ans){
    state.locked = true;
    const pts = (state.tries===1)? 3 : (state.tries===2? 2 : 1);
    state.score += pts;
    
    $("feedback").textContent = "Bravo ! " + q.exp;
    $("feedback").className = "panel ok";
    $("feedback").style.display = "block";
    setCoach(`Bien jou√© ! +${pts} pts.`, "happy");
    $("qCard").classList.add("pop");
    setTimeout(()=>$("qCard").classList.remove("pop"), 500);
    
    $("btnVal").disabled = true;
    setTimeout(nextQ, 1600);
  } else {
    $("optionsBox").classList.add("shake");
    setTimeout(()=>$("optionsBox").classList.remove("shake"), 500);
    
    if(state.tries >= 1) $("btnHint").disabled = false;
    
    setCoach("Non. Essaie encore.", "think");
    $("feedback").textContent = `Tentative ${state.tries}/3 incorrecte.`;
    $("feedback").className = "panel bad";
    $("feedback").style.display = "block";
  }
  updateHUD();
}

const showHint=()=>{
  setCoach("Regarde l'indice.", "think");
  $("feedback").className = "panel warn";
  $("feedback").textContent = "Indice : Relis bien le texte, la r√©ponse y est souvent √©crite.";
  $("feedback").style.display = "block";
}

const nextQ=()=>{ state.idx++; loadQuestion(); }

const updateHUD=()=>{
  $("txtProg").textContent = `${state.idx}/${QUESTIONS.length}`;
  $("bar").style.width = `${(state.idx / QUESTIONS.length)*100}%`;
  $("txtScore").textContent = state.score;
  const st=$("stepper"); st.innerHTML="";
  for(let i=0;i<QUESTIONS.length;i++){
    st.innerHTML+=`<div class="step ${i===state.idx?'active':(i<state.idx?'done':'')}"></div>`;
  }
}

const showFinal=()=>{
  $("gameContent").style.display="none"; $("finalScreen").style.display="block";
  $("finalScoreVal").textContent = `${state.score} / ${QUESTIONS.length*3}`;
  const pct = state.score / (QUESTIONS.length*3);
  let msg = pct > 0.8 ? "Tu es un expert !" : "Bien jou√© !";
  $("finalMsg").textContent = msg;
  setCoach("Session termin√©e ! " + msg, "happy");
  launchConfetti();
}

function launchConfetti() {
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;

  const pieces = [];
  for(let i=0; i<100; i++){
    pieces.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height - canvas.height,
      color: `hsl(${Math.random()*360}, 100%, 50%)`,
      size: Math.random()*8+4,
      speed: Math.random()*3+2
    });
  }

  let rafId = 0;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p => {
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, p.size, p.size);
      p.y += p.speed;
      if(p.y > canvas.height) p.y = -10;
    });
    rafId = requestAnimationFrame(draw);
  }
  draw();
  setTimeout(()=>{ if(rafId) cancelAnimationFrame(rafId); }, 5000);
}

function init(){
  $("startAvatar").onerror = function(){ this.src="https://placehold.co/100x100?text=Coach"; };
  $("floatAvatar").onerror = function(){ this.src="https://placehold.co/70x70?text=Coach"; };
  setCoach("Bonjour ! Pr√™t √† commencer ?", "neutral");
  updateHUD();
}

$("startBtn").addEventListener("click", startGame);
$("btnVal").addEventListener("click", validate);
$("btnHint").addEventListener("click", showHint);
$("btnSkip").addEventListener("click", nextQ);

window.addEventListener("resize", ()=>{
  const canvas = document.getElementById('confetti');
  if(canvas){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
});

init();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentDocId = null;
  let startTime = Date.now();

  function getIdentity() { return localStorage.getItem("cockpit_student_id"); }

  async function demarrerVisite() {
    try {
      let userCode = getIdentity() || "ANONYME";
      let userClass = localStorage.getItem("cockpit_student_class") || "VISITEUR";
      const pageName = document.title || window.location.pathname.split("/").pop();
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);

      const ref = await addDoc(collection(db, "statistiques_usage"), {
        page: pageName,
        userCode: userCode,
        classe: userClass,
        device: isMobile ? "Mobile" : "Desktop",
        action: "Consultation",
        duree: 0,
        timestamp: serverTimestamp(),
        date: new Date().toISOString()
      });

      currentDocId = ref.id;

      setInterval(async () => {
        if (currentDocId && document.visibilityState === "visible") {
          try {
            await updateDoc(doc(db, "statistiques_usage", currentDocId), {
              duree: Math.floor((Date.now() - startTime) / 1000)
            });
          } catch (e) {}
        }
      }, 10000);

    } catch (e) { console.warn("Erreur Tracker", e); }
  }

  demarrerVisite();
</script>

</body>
</html>
