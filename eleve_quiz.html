<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PSE Quiz Live</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* === ECRAN REJOINDRE === */
        #screen-join {
            position: fixed; inset: 0; z-index: 100;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px;
        }
        #screen-join h1 { font-size: 2.5rem; color: white; margin-bottom: 8px; }
        #screen-join .subtitle { color: rgba(255,255,255,0.8); font-size: 1rem; margin-bottom: 40px; }
        #join-input {
            width: 100%; max-width: 300px; padding: 18px; border: none; border-radius: 16px;
            font-size: 1.8rem; font-weight: 900; text-align: center; text-transform: uppercase;
            letter-spacing: 8px; background: white; color: #1a1a2e;
            -webkit-appearance: none; outline: none;
        }
        #join-input::placeholder { letter-spacing: 2px; font-size: 1rem; color: #aaa; font-weight: 400; }
        #btn-join {
            width: 100%; max-width: 300px; margin-top: 16px; padding: 18px;
            border: none; border-radius: 16px; background: #2ecc71; color: white;
            font-size: 1.3rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 4px 0 #27ae60; transition: 0.1s;
        }
        #btn-join:active { transform: translateY(4px); box-shadow: none; }
        #join-error { color: #ff6b6b; margin-top: 12px; font-weight: 600; min-height: 24px; }

        /* === ECRAN LOBBY === */
        #screen-lobby {
            position: fixed; inset: 0; z-index: 90;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }
        .pseudo-display {
            font-size: 3rem; margin-bottom: 10px;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .pseudo-name { font-size: 1.5rem; color: white; font-weight: 800; margin-bottom: 30px; }
        .waiting-msg { color: rgba(255,255,255,0.7); font-size: 1.1rem; }
        .dots::after { content: ''; animation: dots 1.5s infinite; }
        @keyframes dots {
            0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); }
        }

        /* === ECRAN QUESTION === */
        #screen-question {
            position: fixed; inset: 0; z-index: 80;
            background: #f0f4f8;
            display: none; flex-direction: column;
            padding: 20px; padding-top: env(safe-area-inset-top, 20px);
        }
        .question-card {
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 16px; min-height: 100px;
            display: flex; align-items: center; justify-content: center;
            text-align: center;
        }
        .question-text { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; line-height: 1.4; }
        .timer-bar-container {
            height: 8px; background: #e2e8f0; border-radius: 4px;
            margin-bottom: 16px; overflow: hidden;
        }
        .timer-bar {
            height: 100%; background: #2ecc71; border-radius: 4px;
            transition: width 1s linear, background 0.3s;
            width: 100%;
        }
        .timer-bar.warning { background: #f39c12; }
        .timer-bar.danger { background: #e74c3c; }
        .timer-label {
            text-align: center; font-size: 1.1rem; font-weight: 700;
            color: #64748b; margin-bottom: 12px;
        }
        .choices-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 12px; flex: 1;
        }
        .choice-btn {
            border: none; border-radius: 16px; color: white;
            font-size: 1.1rem; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            padding: 16px 12px; text-align: center; line-height: 1.3;
            transition: transform 0.15s, opacity 0.3s;
            min-height: 80px;
        }
        .choice-btn:active { transform: scale(0.95); }
        .choice-btn.selected { animation: pulse 0.5s; border: 4px solid white; }
        .choice-btn.faded { opacity: 0.3; pointer-events: none; }
        .choice-btn.disabled { pointer-events: none; }
        .choice-a { background: #3b82f6; box-shadow: 0 4px 0 #2563eb; }
        .choice-b { background: #f59e0b; box-shadow: 0 4px 0 #d97706; }
        .choice-c { background: #22c55e; box-shadow: 0 4px 0 #16a34a; }
        .choice-d { background: #ef4444; box-shadow: 0 4px 0 #dc2626; }
        .sent-msg {
            text-align: center; padding: 20px; color: #22c55e;
            font-weight: 800; font-size: 1.2rem;
            display: none;
        }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* === MOT INPUT === */
        .mot-container {
            display: none; flex-direction: column; align-items: center;
            justify-content: center; flex: 1; gap: 16px; padding: 20px;
        }
        .mot-input {
            width: 100%; max-width: 350px; padding: 18px; border: 3px solid #e2e8f0;
            border-radius: 16px; font-size: 1.5rem; font-weight: 700; text-align: center;
            outline: none; background: white; color: #1a1a2e;
        }
        .mot-input:focus { border-color: #3b82f6; }
        .mot-input::placeholder { font-size: 1rem; font-weight: 400; color: #aaa; }
        .mot-submit {
            width: 100%; max-width: 350px; padding: 16px;
            background: #22c55e; color: white; border: none; border-radius: 16px;
            font-size: 1.2rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 4px 0 #16a34a; transition: 0.1s;
        }
        .mot-submit:active { transform: translateY(4px); box-shadow: none; }
        .mot-submit:disabled { opacity: 0.4; cursor: not-allowed; }
        .mot-hint { font-size: 0.85rem; color: #94a3b8; text-align: center; }

        /* === ECRAN RESULTAT === */
        #screen-result {
            position: fixed; inset: 0; z-index: 80;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }
        #screen-result.correct { background: linear-gradient(135deg, #22c55e, #16a34a); }
        #screen-result.wrong { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .result-icon { font-size: 5rem; margin-bottom: 16px; animation: bounceIn 0.5s; }
        .result-text { font-size: 1.8rem; font-weight: 900; color: white; margin-bottom: 12px; }
        .result-answer { font-size: 1.1rem; color: rgba(255,255,255,0.9); font-weight: 600; padding: 12px 20px; background: rgba(255,255,255,0.15); border-radius: 12px; }
        .result-waiting { color: rgba(255,255,255,0.6); margin-top: 20px; font-size: 0.9rem; }

        /* === ECRAN BILAN === */
        #screen-summary {
            position: fixed; inset: 0; z-index: 80;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; flex-direction: column; align-items: center;
            padding: 30px; padding-top: 40px; text-align: center;
            overflow-y: auto;
        }
        .summary-emoji { font-size: 5rem; margin-bottom: 10px; animation: bounceIn 0.6s; }
        .summary-score { font-size: 2.5rem; font-weight: 900; color: white; margin-bottom: 8px; }
        .summary-detail { font-size: 1.2rem; color: rgba(255,255,255,0.8); margin-bottom: 8px; }
        .summary-msg { font-size: 1rem; color: rgba(255,255,255,0.6); margin-top: 16px; margin-bottom: 20px; }
        .summary-mapse {
            background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px 20px;
            margin-top: 16px; margin-bottom: 20px;
        }
        .summary-mapse a { color: #f59e0b; font-weight: 800; text-decoration: none; font-size: 1.1rem; }
        .summary-mapse-label { color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 4px; }

        /* === ECRAN PAUSE === */
        #screen-paused {
            position: fixed; inset: 0; z-index: 95;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }

        /* === ANTI-DISPERSION === */
        #alert-tabswitch {
            position: fixed; inset: 0; z-index: 9999;
            background: #ef4444; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center; padding: 30px;
            animation: flashBg 0.4s ease 3;
        }
        @keyframes flashBg { 0%,100% { background: #ef4444; } 50% { background: #b91c1c; } }
        .alert-icon { font-size: 5rem; margin-bottom: 16px; }
        .alert-title { font-size: 1.8rem; font-weight: 900; margin-bottom: 8px; }
        .alert-sub { font-size: 1rem; opacity: 0.8; }
        .alert-count { font-size: 0.85rem; opacity: 0.6; margin-top: 16px; }

        /* === EQUIPE DANS LOBBY === */
        #team-assignment {
            display: none; margin-top: 20px; animation: bounceIn 0.6s;
            background: rgba(255,255,255,0.15); border-radius: 16px; padding: 18px 24px;
            text-align: center; width: 100%; max-width: 320px;
        }
        #team-assignment .team-label { font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 6px; }
        #team-assignment .team-name {
            font-size: 1.6rem; font-weight: 900; color: white; margin-bottom: 8px;
        }
        #team-assignment .team-mates {
            font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.6;
        }
        #team-assignment .team-mate-item {
            display: inline-block; background: rgba(255,255,255,0.12); border-radius: 20px;
            padding: 3px 10px; margin: 2px 3px; font-weight: 600;
        }

        /* === MEDIA QUESTION === */
        .q-media-container { width: 100%; margin-bottom: 12px; text-align: center; }
        .q-media-container img { max-width: 100%; max-height: 200px; border-radius: 12px; object-fit: contain; }
        .q-media-container iframe { width: 100%; max-width: 480px; height: 270px; border: none; border-radius: 12px; }
        .q-media-container .media-texte { background: #f8fafc; border-left: 4px solid #3b82f6; padding: 12px 16px; border-radius: 0 12px 12px 0; color: #334155; font-style: italic; line-height: 1.5; text-align: left; white-space: pre-wrap; font-size: 0.95rem; }
    </style>
</head>
<body>

<!-- ECRAN 1 : REJOINDRE -->
<div id="screen-join">
    <h1>Quiz Live</h1>
    <div class="subtitle">Entre le code donne par ton prof</div>
    <input type="text" id="join-input" placeholder="CODE" maxlength="10" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false">
    <button id="btn-join" onclick="joinSession()">REJOINDRE</button>
    <div id="join-error"></div>
</div>

<!-- ECRAN 2 : LOBBY -->
<div id="screen-lobby">
    <div class="pseudo-display" id="my-pseudo-emoji"></div>
    <div class="pseudo-name" id="my-pseudo-name"></div>
    <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
        <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 8px;">Ton pseudo pour ce quiz :</div>
        <div style="color: white; font-size: 1.8rem; font-weight: 900;" id="my-pseudo-full"></div>
    </div>
    <div id="team-assignment">
        <div class="team-label">Ton equipe :</div>
        <div class="team-name" id="team-name-display"></div>
        <div class="team-mates" id="team-mates-display"></div>
    </div>
    <div class="waiting-msg">En attente du prof<span class="dots"></span></div>
</div>

<!-- ECRAN 3 : QUESTION -->
<div id="screen-question">
    <div class="q-media-container" id="q-media" style="display:none;"></div>
    <div class="question-card">
        <div class="question-text" id="q-text">Chargement...</div>
    </div>
    <div class="timer-label" id="timer-label">15s</div>
    <div class="timer-bar-container" id="timer-bar-container">
        <div class="timer-bar" id="timer-bar"></div>
    </div>
    <div class="choices-grid" id="choices-grid"></div>
    <div class="mot-container" id="mot-container">
        <input type="text" class="mot-input" id="mot-input" placeholder="Tape ta reponse..." autocomplete="off" autocorrect="off" spellcheck="false">
        <button class="mot-submit" id="mot-submit" onclick="submitMotAnswer()">Envoyer</button>
        <div class="mot-hint">Accents et majuscules toleres</div>
    </div>
    <div class="sent-msg" id="sent-msg">Reponse envoyee !</div>
</div>

<!-- ECRAN 4 : RESULTAT -->
<div id="screen-result">
    <div class="result-icon" id="result-icon"></div>
    <div class="result-text" id="result-text"></div>
    <div class="result-answer" id="result-answer"></div>
    <div class="result-waiting">Question suivante<span class="dots"></span></div>
</div>

<!-- ECRAN PAUSE -->
<div id="screen-paused">
    <div style="font-size:5rem; margin-bottom:16px;">‚è∏Ô∏è</div>
    <div style="font-size:1.8rem; font-weight:900; color:white; margin-bottom:12px;">Quiz en pause</div>
    <div style="font-size:1rem; color:rgba(255,255,255,0.6);">Le prof a mis le quiz en pause. Patiente...</div>
</div>

<!-- ALERTE ANTI-DISPERSION -->
<div id="alert-tabswitch">
    <div class="alert-icon">üö®</div>
    <div class="alert-title">Reviens sur le quiz !</div>
    <div class="alert-sub">Ton prof est prevenu que tu as quitte la page.</div>
    <div class="alert-count" id="alert-count-msg"></div>
</div>

<!-- ECRAN 5 : BILAN -->
<div id="screen-summary">
    <div class="summary-emoji" id="summary-emoji"></div>
    <div class="summary-score" id="summary-score"></div>
    <div class="summary-detail" id="summary-detail"></div>
    <div class="summary-msg" id="summary-msg"></div>
    <div id="summary-questions" style="width:100%; max-width:400px;"></div>
    <div class="summary-mapse">
        <div class="summary-mapse-label">Retrouve toutes tes ressources sur :</div>
        <a href="https://mapse.fr" target="_blank">üåê mapse.fr</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === PSEUDOS ===
    const PSEUDOS = [
        "Panda üêº","Etoile ‚≠ê","Fusee üöÄ","Diamant üíé","Tigre üêØ","Dragon üêâ",
        "Licorne ü¶Ñ","Phoenix üî•","Ninja ü•∑","Robot ü§ñ","Koala üê®","Dauphin üê¨",
        "Aigle ü¶Ö","Papillon ü¶ã","Lion ü¶Å","Comete ‚òÑÔ∏è","Eclair ‚ö°","Flocon ‚ùÑÔ∏è",
        "Soleil ‚òÄÔ∏è","Lune üåô","Galaxie üåå","Hibou ü¶â","Renard ü¶ä","Tornade üå™Ô∏è",
        "Volcan üåã","Cristal üí†","Trefle üçÄ","Cerise üçí","Arc-en-ciel üåà","Pingouin üêß",
        "Flamant ü¶©","Abeille üêù","Ours üêª","Loup üê∫","Requin ü¶à","Baleine üêã",
        "Herisson ü¶î","Chat üê±","Perroquet ü¶ú","Tortue üê¢","Crabe ü¶Ä","Meduse ü™º",
        "Pieuvre üêô","Serpent üêç","Cameleon ü¶é","Scarabee ü™≤","Morse ü¶≠","Colibri üå∫"
    ];

    // === TEXT NORMALIZATION ===
    function normalizeText(text) {
        return text.trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    // === STATE ===
    let currentSessionId = null;
    let myPseudo = null;
    let myVisitorId = localStorage.getItem('quiz_live_visitorId');
    if (!myVisitorId) {
        myVisitorId = 'v_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
        localStorage.setItem('quiz_live_visitorId', myVisitorId);
    }
    let currentQuestionIndex = -1;
    let hasAnswered = false;
    let myScore = 0;
    let totalQuestions = 0;
    let tabSwitchCount = 0;
    let timerInterval = null;
    let unsubConfig = null;
    let myTeamId = null;
    let myTeam = null;
    let currentGameMode = 'solo';

    // === REJOINDRE ===
    window.joinSession = async function() {
        const code = document.getElementById('join-input').value.trim().toUpperCase();
        if (!code) {
            document.getElementById('join-error').textContent = "Entre un code !";
            return;
        }
        document.getElementById('join-error').textContent = "Connexion...";
        document.getElementById('btn-join').disabled = true;

        try {
            const configSnap = await getDoc(doc(db, "quiz_live_config", "global"));
            if (!configSnap.exists() || configSnap.data().sessionCode !== code) {
                document.getElementById('join-error').textContent = "Code introuvable. Verifie avec ton prof.";
                document.getElementById('btn-join').disabled = false;
                return;
            }

            currentSessionId = configSnap.data().sessionId;

            const presSnap = await getDocs(query(collection(db, "quiz_live_presence"), where("sessionId", "==", currentSessionId)));
            const takenPseudos = [];
            let existingPseudo = null;
            presSnap.forEach(d => {
                takenPseudos.push(d.data().pseudo);
                if (d.data().visitorId === myVisitorId) existingPseudo = d.data().pseudo;
            });

            if (existingPseudo) {
                myPseudo = existingPseudo;
            } else {
                const available = PSEUDOS.filter(p => !takenPseudos.includes(p));
                myPseudo = available.length > 0 ? available[Math.floor(Math.random() * Math.min(5, available.length))] : "Joueur " + (takenPseudos.length + 1);

                const numero = takenPseudos.length + 1;
                await setDoc(doc(db, "quiz_live_presence", myVisitorId), {
                    visitorId: myVisitorId,
                    pseudo: myPseudo,
                    numero: numero,
                    timestamp: Date.now(),
                    sessionId: currentSessionId
                });
            }

            showScreen('lobby');
            const parts = myPseudo.split(' ');
            document.getElementById('my-pseudo-emoji').textContent = parts[1] || 'üéØ';
            document.getElementById('my-pseudo-name').textContent = parts[0] || myPseudo;
            document.getElementById('my-pseudo-full').textContent = myPseudo;

            startListening();

        } catch(e) {
            console.error(e);
            document.getElementById('join-error').textContent = "Erreur de connexion.";
            document.getElementById('btn-join').disabled = false;
        }
    };

    document.getElementById('join-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') window.joinSession();
    });

    // === MOT INPUT: Enter to submit ===
    document.getElementById('mot-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') window.submitMotAnswer();
    });

    // === ECOUTER CONFIG ===
    function updateTeamDisplay(d) {
        currentGameMode = d.gameMode || 'solo';
        const configTeams = d.teams || [];
        myTeam = configTeams.find(t => t.members.some(m => m.visitorId === myVisitorId)) || null;
        myTeamId = myTeam ? myTeam.teamId : null;

        const teamEl = document.getElementById('team-assignment');
        if (myTeam && currentGameMode !== 'solo') {
            const nameEl = document.getElementById('team-name-display');
            nameEl.innerHTML = '<span style="font-size:2rem; vertical-align:middle;">' + myTeam.teamEmoji + '</span> ' + myTeam.teamName;
            nameEl.style.color = myTeam.teamColor;

            const matesEl = document.getElementById('team-mates-display');
            const teammates = myTeam.members.filter(m => m.visitorId !== myVisitorId);
            if (teammates.length > 0) {
                matesEl.innerHTML = teammates.map(m => '<span class="team-mate-item">' + m.pseudo + '</span>').join(' ');
            } else {
                matesEl.innerHTML = '<span style="opacity:0.5">Seul dans l\'equipe</span>';
            }
            teamEl.style.display = 'block';
        } else {
            teamEl.style.display = 'none';
        }
    }

    function startListening() {
        if (unsubConfig) unsubConfig();
        unsubConfig = onSnapshot(doc(db, "quiz_live_config", "global"), (snap) => {
            if (!snap.exists()) return;
            const d = snap.data();
            if (d.sessionId !== currentSessionId) return;

            // Update team info
            updateTeamDisplay(d);

            // Handle pause
            if (d.paused) {
                showScreen('paused');
                if (timerInterval) clearInterval(timerInterval);
                return;
            }

            const phase = d.phase || 'lobby';
            const qIndex = d.currentQuestionIndex ?? -1;
            const questions = d.questions || [];
            totalQuestions = questions.length;

            if (phase === 'lobby') {
                showScreen('lobby');
            } else if (phase === 'question') {
                if (qIndex !== currentQuestionIndex) {
                    currentQuestionIndex = qIndex;
                    hasAnswered = false;
                    const shuffleMap = d.shuffleMap || null;
                    const isManual = d.mode === 'manual';
                    showQuestion(questions[qIndex], isManual ? 0 : (d.timer || 15), shuffleMap);
                }
            } else if (phase === 'results') {
                if (!hasAnswered) hasAnswered = true;
                const q = questions[qIndex];
                showResult(q);
            } else if (phase === 'summary') {
                showSummary();
            }
        });
    }

    // === MEDIA HELPERS ===
    function extractYouTubeId(url) {
        if (!url) return null;
        const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|shorts\/))([a-zA-Z0-9_-]{11})/);
        return m ? m[1] : null;
    }
    function renderMediaHtml(media) {
        if (!media || !media.type || !media.content) return '';
        if (media.type === 'image') {
            return '<img src="' + media.content + '" alt="Media" onerror="this.style.display=\'none\'">';
        } else if (media.type === 'video') {
            const vid = extractYouTubeId(media.content);
            if (!vid) return '';
            return '<iframe src="https://www.youtube-nocookie.com/embed/' + vid + '" allowfullscreen></iframe>';
        } else if (media.type === 'texte') {
            return '<div class="media-texte">' + media.content.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
        }
        return '';
    }

    // === AFFICHER QUESTION ===
    function showQuestion(q, timer, shuffleMap) {
        showScreen('question');
        // Media
        const mediaEl = document.getElementById('q-media');
        if (q.media) {
            mediaEl.innerHTML = renderMediaHtml(q.media);
            mediaEl.style.display = 'block';
        } else {
            mediaEl.innerHTML = '';
            mediaEl.style.display = 'none';
        }
        document.getElementById('q-text').textContent = q.question;
        document.getElementById('sent-msg').style.display = 'none';

        const qType = q.type || 'qcm';
        const grid = document.getElementById('choices-grid');
        const motContainer = document.getElementById('mot-container');

        if (qType === 'mot') {
            // Short answer type
            grid.style.display = 'none';
            motContainer.style.display = 'flex';
            document.getElementById('mot-input').value = '';
            document.getElementById('mot-input').disabled = false;
            document.getElementById('mot-submit').disabled = false;
            document.getElementById('mot-input').focus();
        } else {
            // QCM type (including V/F converted to 2 choices)
            grid.style.display = 'grid';
            motContainer.style.display = 'none';

            const numChoices = q.choices.length;
            // Determine display order from shuffleMap
            let myOrder;
            if (shuffleMap && shuffleMap[myVisitorId]) {
                myOrder = shuffleMap[myVisitorId];
            } else {
                myOrder = [];
                for (let i = 0; i < numChoices; i++) myOrder.push(i);
            }

            grid.innerHTML = '';
            const letters = ['A', 'B', 'C', 'D'];
            const colors = ['choice-a', 'choice-b', 'choice-c', 'choice-d'];

            myOrder.forEach((origIdx, displayPos) => {
                if (origIdx >= numChoices) return; // safety
                const btn = document.createElement('button');
                btn.className = 'choice-btn ' + colors[displayPos];
                btn.dataset.origIdx = origIdx;
                btn.innerHTML = '<span style="font-size:1.4rem;font-weight:900;margin-right:8px;">' + letters[displayPos] + '</span> ' + q.choices[origIdx];
                btn.onclick = () => submitAnswer(origIdx);
                grid.appendChild(btn);
            });
        }

        // Timer
        startTimer(timer);
    }

    function startTimer(seconds) {
        if (timerInterval) clearInterval(timerInterval);

        // Manual mode - no timer
        if (seconds <= 0) {
            document.getElementById('timer-bar-container').style.display = 'none';
            document.getElementById('timer-label').style.display = 'none';
            return;
        }

        document.getElementById('timer-bar-container').style.display = 'block';
        document.getElementById('timer-label').style.display = 'block';

        let remaining = seconds;
        const bar = document.getElementById('timer-bar');
        const label = document.getElementById('timer-label');
        bar.style.width = '100%';
        bar.className = 'timer-bar';
        label.textContent = remaining + 's';

        timerInterval = setInterval(() => {
            remaining--;
            if (remaining < 0) { clearInterval(timerInterval); return; }
            const pct = (remaining / seconds) * 100;
            bar.style.width = pct + '%';
            label.textContent = remaining + 's';
            if (pct < 20) bar.className = 'timer-bar danger';
            else if (pct < 50) bar.className = 'timer-bar warning';
        }, 1000);
    }

    // === ENVOYER REPONSE QCM ===
    async function submitAnswer(answerIndex) {
        if (hasAnswered) return;
        hasAnswered = true;

        // UI feedback using data-origIdx
        const btns = document.querySelectorAll('.choice-btn');
        btns.forEach((btn) => {
            const origIdx = parseInt(btn.dataset.origIdx);
            if (origIdx === answerIndex) {
                btn.classList.add('selected');
            } else {
                btn.classList.add('faded');
            }
            btn.classList.add('disabled');
        });
        document.getElementById('sent-msg').style.display = 'block';

        try {
            const configSnap = await getDoc(doc(db, "quiz_live_config", "global"));
            const questions = configSnap.data().questions || [];
            const correct = questions[currentQuestionIndex]?.correct;
            const isCorrect = answerIndex === correct;
            if (isCorrect) myScore++;

            const reponseDoc = {
                visitorId: myVisitorId,
                pseudo: myPseudo,
                answer: answerIndex,
                questionIndex: currentQuestionIndex,
                correct: isCorrect,
                timestamp: Date.now(),
                sessionId: currentSessionId
            };
            if (myTeamId) reponseDoc.teamId = myTeamId;
            if (currentGameMode !== 'solo') reponseDoc.gameMode = currentGameMode;
            await setDoc(doc(db, "quiz_live_reponses", myVisitorId + '_q' + currentQuestionIndex), reponseDoc);
        } catch(e) {
            console.error("Erreur envoi reponse:", e);
        }
    }

    // === ENVOYER REPONSE MOT ===
    window.submitMotAnswer = async function() {
        if (hasAnswered) return;

        const input = document.getElementById('mot-input');
        const userAnswer = input.value.trim();
        if (!userAnswer) { input.style.borderColor = '#ef4444'; return; }

        hasAnswered = true;
        input.disabled = true;
        document.getElementById('mot-submit').disabled = true;
        document.getElementById('sent-msg').style.display = 'block';
        document.getElementById('mot-container').style.display = 'none';

        try {
            const configSnap = await getDoc(doc(db, "quiz_live_config", "global"));
            const questions = configSnap.data().questions || [];
            const q = questions[currentQuestionIndex];
            const expectedAnswer = q?.reponse || '';
            const isCorrect = normalizeText(userAnswer) === normalizeText(expectedAnswer);
            if (isCorrect) myScore++;

            const motReponseDoc = {
                visitorId: myVisitorId,
                pseudo: myPseudo,
                answerText: userAnswer,
                answer: -1, // not a choice index
                questionIndex: currentQuestionIndex,
                correct: isCorrect,
                timestamp: Date.now(),
                sessionId: currentSessionId
            };
            if (myTeamId) motReponseDoc.teamId = myTeamId;
            if (currentGameMode !== 'solo') motReponseDoc.gameMode = currentGameMode;
            await setDoc(doc(db, "quiz_live_reponses", myVisitorId + '_q' + currentQuestionIndex), motReponseDoc);
        } catch(e) {
            console.error("Erreur envoi reponse mot:", e);
        }
    };

    // === AFFICHER RESULTAT ===
    function showResult(q) {
        if (timerInterval) clearInterval(timerInterval);

        const qType = q.type || 'qcm';
        const resultScreen = document.getElementById('screen-result');
        const configDoc = doc(db, "quiz_live_reponses", myVisitorId + '_q' + currentQuestionIndex);
        getDoc(configDoc).then(snap => {
            const wasCorrect = snap.exists() && snap.data().correct === true;
            const didAnswer = snap.exists();

            resultScreen.className = '';
            if (!didAnswer) {
                resultScreen.className = 'wrong';
                document.getElementById('result-icon').textContent = '‚è∞';
                document.getElementById('result-text').textContent = "Temps ecoule !";
            } else if (wasCorrect) {
                resultScreen.className = 'correct';
                document.getElementById('result-icon').textContent = '‚úÖ';
                document.getElementById('result-text').textContent = "Bonne reponse !";
            } else {
                resultScreen.className = 'wrong';
                document.getElementById('result-icon').textContent = '‚ùå';
                document.getElementById('result-text').textContent = "Mauvaise reponse";
            }

            // Show correct answer
            if (qType === 'mot') {
                document.getElementById('result-answer').textContent = "Reponse : " + q.reponse;
            } else {
                document.getElementById('result-answer').textContent = "Reponse : " + q.choices[q.correct];
            }

            showScreen('result');
        });
    }

    // === BILAN DETAILLE ===
    async function showSummary() {
        if (timerInterval) clearInterval(timerInterval);
        showScreen('summary');

        const pct = totalQuestions > 0 ? Math.round((myScore / totalQuestions) * 100) : 0;
        document.getElementById('summary-score').textContent = myScore + ' / ' + totalQuestions;
        document.getElementById('summary-detail').textContent = pct + '% de bonnes reponses';

        let emoji, msg;
        if (pct >= 80) { emoji = 'üèÜ'; msg = 'Excellent travail !'; }
        else if (pct >= 60) { emoji = 'üëè'; msg = 'Bien joue !'; }
        else if (pct >= 40) { emoji = 'üí™'; msg = 'Continue comme ca !'; }
        else { emoji = 'üìö'; msg = 'Revise bien pour la prochaine fois !'; }

        document.getElementById('summary-emoji').textContent = emoji;
        document.getElementById('summary-msg').textContent = msg;

        // Build detailed question list
        const container = document.getElementById('summary-questions');
        container.innerHTML = '';

        try {
            const configSnap = await getDoc(doc(db, "quiz_live_config", "global"));
            const questions = configSnap.data().questions || [];

            for (let i = 0; i < totalQuestions; i++) {
                const respSnap = await getDoc(doc(db, "quiz_live_reponses", myVisitorId + '_q' + i));
                const wasCorrect = respSnap.exists() && respSnap.data().correct;
                const didAnswer = respSnap.exists();

                const row = document.createElement('div');
                row.style.cssText = 'display:flex; align-items:center; gap:10px; padding:8px 12px; margin-bottom:6px; background:rgba(255,255,255,0.1); border-radius:10px; animation:fadeIn 0.4s ease ' + (i * 0.1) + 's both;';

                const icon = wasCorrect ? '‚úÖ' : (didAnswer ? '‚ùå' : '‚è∞');
                const q = questions[i];
                const qText = q ? q.question : 'Question ' + (i + 1);
                const shortQ = qText.length > 40 ? qText.substring(0, 40) + '...' : qText;

                let correctAnswerHtml = '';
                if (!wasCorrect && q) {
                    const qType = q.type || 'qcm';
                    if (qType === 'mot') {
                        correctAnswerHtml = '<div style="font-size:0.75rem; color:rgba(255,255,255,0.6); margin-top:2px;">‚Üí ' + q.reponse + '</div>';
                    } else {
                        correctAnswerHtml = '<div style="font-size:0.75rem; color:rgba(255,255,255,0.6); margin-top:2px;">‚Üí ' + q.choices[q.correct] + '</div>';
                    }
                }

                row.innerHTML = '<span style="font-size:1.3rem;">' + icon + '</span>' +
                    '<div style="flex:1; text-align:left;">' +
                    '<div style="font-size:0.85rem; color:white; font-weight:600;">Q' + (i + 1) + ' : ' + shortQ + '</div>' +
                    correctAnswerHtml +
                    '</div>';
                container.appendChild(row);
            }
        } catch(e) {
            console.error("Erreur chargement bilan:", e);
        }
    }

    // === NAVIGATION ECRANS ===
    let _fromPopstate = false;
    function showScreen(name) {
        ['screen-join', 'screen-lobby', 'screen-question', 'screen-result', 'screen-summary', 'screen-paused'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        const el = document.getElementById('screen-' + name);
        if (el) el.style.display = 'flex';
        if (!_fromPopstate) history.pushState({ screen: name }, '', location.pathname + location.search);
    }

    // === ANTI-DISPERSION ===
    document.addEventListener('visibilitychange', async () => {
        if (!currentSessionId || !myPseudo) return;

        if (document.hidden) {
            tabSwitchCount++;
            try {
                await setDoc(doc(db, "quiz_live_presence", myVisitorId), {
                    visitorId: myVisitorId,
                    pseudo: myPseudo,
                    timestamp: Date.now(),
                    sessionId: currentSessionId,
                    tabSwitches: tabSwitchCount,
                    lastSwitch: Date.now()
                }, { merge: true });
            } catch(e) {}
        } else {
            const alertEl = document.getElementById('alert-tabswitch');
            document.getElementById('alert-count-msg').textContent = 'Sortie(s) detectee(s) : ' + tabSwitchCount;
            alertEl.style.display = 'flex';
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 3000);
        }
    });

    // === HISTORY BACK BUTTON ===
    history.replaceState({ screen: 'join' }, '', location.pathname + location.search);
    window.addEventListener('popstate', function(e) {
        var cur = ['join','lobby','question','result','summary','paused']
            .find(n => document.getElementById('screen-' + n).style.display !== 'none');
        if (cur === 'question' || cur === 'result' || cur === 'paused') {
            history.pushState({ screen: cur }, '', location.pathname + location.search);
            return;
        }
        if (e.state && e.state.screen) { _fromPopstate = true; showScreen(e.state.screen); _fromPopstate = false; }
    });
</script>
</body>
</html>
