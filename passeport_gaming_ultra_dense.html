<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéñÔ∏è Passeport Comp√©tences ‚Äî C11 (Mobile ‚Ä¢ Clicks Only)</title>

  <style>
    :root{
      --bg1:#f6f8ff; --bg2:#eef2ff;

      --card: rgba(255,255,255,.94);
      --card2: rgba(255,255,255,.80);

      --stroke: rgba(20,30,55,.12);
      --stroke2: rgba(20,30,55,.10);

      --text:#172033;
      --muted: rgba(23,32,51,.72);

      --shadow: 0 14px 40px rgba(22,32,60,.12);
      --shadow2: 0 10px 30px rgba(22,32,60,.10);

      --good:#1bbf7a;
      --warn:#f4b400;
      --bad:#e53957;
      --blue:#325aff;

      --chip: rgba(23,32,51,.06);
      --chipSel: rgba(50,90,255,.12);
      --focus: rgba(50,90,255,.22);

      --radius: 18px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    html,body{ height:100%; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      color: var(--text);
      font-size: 18px;
      padding: 14px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }

    #passeportApp{ max-width: 980px; margin: 0 auto; padding-bottom: calc(16px + env(safe-area-inset-bottom)); }

    /* Anti-CSS-host : garantit 1 √©cran visible */
    #passeportApp .screen{ display:none !important; }
    #passeportApp .screen.active{ display:block !important; }

    .topbar{
      position: sticky; top: 10px; z-index: 50;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      background: rgba(255,255,255,.82);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:34px; height:34px; border-radius: 10px;
      background: rgba(23,32,51,.06);
      border:1px solid var(--stroke2);
      display:grid; place-items:center;
      font-weight: 900;
    }
    .brand .t1{ font-weight: 950; letter-spacing:.2px; line-height:1.1; font-size: 14px; }
    .brand .t2{ font-size:12px; color: var(--muted); margin-top:2px; }
    .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      border:none; outline:none; cursor:pointer;
      background: rgba(23,32,51,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 800;
      border: 1px solid var(--stroke);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: rgba(50,90,255,.14);
      border-color: rgba(50,90,255,.24);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(20,30,55,.12);
      color: rgba(23,32,51,.88);
    }
    .btn.small{ padding:8px 10px; font-size:12px; }

    .grid{ margin-top: 14px; display:grid; gap: 14px; }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(20,30,55,.10);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .card .title{ font-weight: 950; font-size: 16px; letter-spacing:.2px; }
    .card .sub{ margin-top:4px; font-size: 13px; color: var(--muted); line-height: 1.35; }
    .card .bd{ padding: 14px; }

    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(23,32,51,.06);
      border: 1px solid rgba(20,30,55,.10);
      font-size: 12px;
      color: rgba(23,32,51,.90);
      user-select:none;
      font-weight: 800;
    }
    .pill.good{ background: rgba(27,191,122,.12); border-color: rgba(27,191,122,.26); }
    .pill.warn{ background: rgba(244,180,0,.14); border-color: rgba(244,180,0,.28); }
    .pill.bad{  background: rgba(229,57,87,.12); border-color: rgba(229,57,87,.26); }
    .pill.blue{ background: rgba(50,90,255,.12); border-color: rgba(50,90,255,.24); }

    .note{
      background: rgba(23,32,51,.04);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 16px;
      padding: 12px;
      color: rgba(23,32,51,.95);
      font-size: 14px;
      line-height: 1.45;
    }

    .progress{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 10px;
    }
    .bar{
      flex: 1 1 240px;
      height: 10px;
      border-radius: 999px;
      background: rgba(23,32,51,.06);
      border: 1px solid rgba(20,30,55,.10);
      overflow:hidden;
      min-width: 180px;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(27,191,122,.95), rgba(244,180,0,.95));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .tiny{ font-size: 13px; color: var(--muted); }

    .levelnav{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .levelbtn{
      flex: 1 1 160px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(23,32,51,.04);
      border: 1px solid rgba(20,30,55,.12);
      color: rgba(23,32,51,.92);
      cursor:pointer;
      text-align:left;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .levelbtn:active{ transform: scale(.99); }
    .levelbtn.locked{ opacity:.55; cursor:not-allowed; }
    .levelbtn .k{ font-weight: 950; }
    .levelbtn .d{ margin-top:4px; font-size:13px; color: var(--muted); }
    .levelbtn .tag{
      display:inline-block; margin-top:8px; font-size:11px; padding:4px 8px; border-radius:999px;
      background: rgba(23,32,51,.06); border: 1px solid rgba(20,30,55,.10);
      font-weight: 850;
    }

    .qbox{
      background: var(--card2);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .qtitle{ font-weight: 950; font-size: 16px; }
    .qhint{ margin-top:4px; font-size: 13px; color: var(--muted); line-height: 1.35; }

    .choices{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .choice{
      flex: 1 1 220px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(20,30,55,.12);
      background: rgba(23,32,51,.04);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      min-width: 160px;
    }
    .choice:active{ transform: scale(.99); }
    .choice.sel{
      background: rgba(50,90,255,.12);
      border-color: rgba(50,90,255,.28);
      box-shadow: 0 10px 26px rgba(22,32,60,.12);
    }
    .choice .s{ font-size: 13px; color: var(--muted); margin-top: 4px; line-height: 1.3; }

    .chipbank{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .chip{
      padding: 12px 10px;
      border-radius: 14px;
      background: rgba(23,32,51,.06);
      border: 1px solid rgba(20,30,55,.12);
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      font-size: 14px;
      text-align:center;
    }
    .chip:active{ transform: scale(.99); }
    .chip.sel{
      outline: 2px solid rgba(50,90,255,.22);
      background: rgba(50,90,255,.12);
    }

    .slots{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .slotrow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background: rgba(23,32,51,.04);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 16px;
      padding: 12px;
    }
    .slotlabel{
      font-size: 13px; color: var(--muted);
      min-width: 92px;
      font-weight: 900;
    }
    .slot{
      flex: 1 1 180px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.66);
      border: 1px dashed rgba(20,30,55,.18);
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      min-height: 42px;
      display:flex; align-items:center;
    }
    .slot.filled{
      border-style: solid;
      background: rgba(27,191,122,.12);
      border-color: rgba(27,191,122,.24);
    }
    .slot:focus{ outline: 2px solid var(--focus); }

    .mini{ font-size: 13px; color: var(--muted); margin-top: 8px; line-height: 1.35; }

    .toast{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(20,30,55,.12);
      background: rgba(23,32,51,.04);
      display:none;
      font-size: 14px;
      line-height: 1.4;
    }
    .toast.show{ display:block; }
    .toast.good{ border-color: rgba(27,191,122,.22); background: rgba(27,191,122,.10); }
    .toast.bad{ border-color: rgba(229,57,87,.22); background: rgba(229,57,87,.10); }
    .toast .t{ font-weight: 950; }
    .toast .m{ margin-top: 6px; color: rgba(23,32,51,.92); }

    .footerrow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top: 12px;
    }
    .footerrow .left{ display:flex; gap:8px; flex-wrap:wrap; }
    .footerrow .right{ display:flex; gap:8px; flex-wrap:wrap; }

    details{
      border-top: 1px solid rgba(20,30,55,.10);
      margin-top: 10px;
    }
    summary{
      cursor:pointer;
      list-style:none;
      padding: 12px 14px;
      font-weight: 950;
      user-select:none;
      color: rgba(23,32,51,.92);
    }
    summary::-webkit-details-marker{ display:none; }

    .kpi{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .kpi .box{
      background: rgba(23,32,51,.04);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .box .n{ font-weight: 1000; font-size: 22px; }
    .kpi .box .l{ font-size: 13px; color: var(--muted); margin-top: 2px; }
    @media (min-width: 860px){
      .slots{ grid-template-columns: 1fr 1fr; }
      .kpi{ grid-template-columns: repeat(4, minmax(0,1fr)); }
      .chipbank{ grid-template-columns: repeat(6, minmax(0,1fr)); }
    }

    /* Modal mini-doc (bottom sheet) */
    .modalBack{
      position:fixed; inset:0; z-index: 200;
      background: rgba(10,15,30,.28);
      display:none;
      align-items:flex-end;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .modalBack.show{ display:flex; }
    .modal{
      width:100%;
      max-width: 980px;
      margin:0 auto;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(22,32,60,.18);
      overflow:hidden;
    }
    .modalHd{
      padding: 12px 14px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom: 1px solid rgba(20,30,55,.10);
    }
    .modalHd .ttl{ font-weight: 950; }
    .modalBd{ padding: 14px; font-size: 14px; line-height: 1.45; color: rgba(23,32,51,.95); }
    .muted{ color: var(--muted); }
  </style>
</head>

<body>
  <div id="passeportApp">

    <div class="topbar">
      <div class="brand">
        <div class="logo">üéñÔ∏è</div>
        <div>
          <div class="t1">Passeport Comp√©tences ‚Äî C11</div>
          <div class="t2">Analyse d‚Äôune situation de travail ‚Ä¢ mobile ‚Ä¢ clicks only</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost small" id="btnHome">Accueil</button>
        <button class="btn ghost small" id="btnScore">Mon profil</button>
        <button class="btn ghost small" id="btnDocs">Docs</button>
        <button class="btn ghost small" id="btnReset">Reset</button>
      </div>
    </div>

    <!-- MODAL DOCS -->
    <div class="modalBack" id="docModalBack" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modalHd">
          <div class="ttl" id="docModalTitle">Mini-doc</div>
          <button class="btn small" id="docClose">Fermer</button>
        </div>
        <div class="modalBd" id="docModalBody"></div>
      </div>
    </div>

    <!-- ACCUEIL -->
    <section class="screen active" id="screen_home">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">üéØ Module C11 ‚Äî Passeport Comp√©tences</div>
              <div class="sub">
                Niveau : Bac Pro / CAP (adapt√©) ‚Ä¢ Objectif : r√©ussir en comprenant la comp√©tence derri√®re la question.
              </div>
              <div class="pillrow">
                <span class="pill good">Pivot : C2</span>
                <span class="pill">Fr√©quent : C3</span>
                <span class="pill">Action : C4</span>
                <span class="pill warn">Exigeant : C5</span>
                <span class="pill">Transversal : C1</span>
                <span class="pill">Transversal : C6</span>
              </div>
            </div>
            <span class="pill blue">‚≠ê √©toiles</span>
          </div>

          <div class="bd">
            <div class="note">
              <b>Objectif du module</b><br><br>
              √ätre capable de <b>analyser une situation-probl√®me</b> (avec une m√©thode), puis <b>proposer</b> et <b>justifier</b> des mesures de pr√©vention.<br><br>
              <b>R√®gle du jeu</b> : tu n‚Äôas pas le cours sous les yeux. Les informations n√©cessaires sont dans le passeport (mini-docs).<br>
              <b>√âcriture</b> : 0 √† 2 mots maximum (le reste se fait par clics).
            </div>

            <div class="progress">
              <div class="bar"><i id="globalBar"></i></div>
              <div class="tiny"><span id="globalPct">0%</span> ‚Ä¢ <span id="globalStars">0</span> ‚≠ê ‚Ä¢ Niveau d√©bloqu√© : <span id="unlockedLbl">1</span></div>
            </div>

            <div class="levelnav">
              <div class="levelbtn" data-goto="l1">
                <div class="k">Niveau 1 ‚Äî Reconna√Ætre</div>
                <div class="d">Identifier la comp√©tence + le format attendu.</div>
                <div class="tag">C1‚ÄìC6</div>
              </div>
              <div class="levelbtn locked" data-goto="l2" id="btnL2">
                <div class="k">Niveau 2 ‚Äî Analyser</div>
                <div class="d">C2 guid√©e : probl√®me + outil QQOQCP.</div>
                <div class="tag">C2 (pivot) + C1</div>
              </div>
              <div class="levelbtn locked" data-goto="l3" id="btnL3">
                <div class="k">Niveau 3 ‚Äî Relier</div>
                <div class="d">C2 : cause ‚Üí effet + phrase causale.</div>
                <div class="tag">C2 + C3</div>
              </div>
              <div class="levelbtn locked" data-goto="l4" id="btnL4">
                <div class="k">Niveau 4 ‚Äî Agir</div>
                <div class="d">C4 : proposer et classer des mesures.</div>
                <div class="tag">C4 + C1</div>
              </div>
              <div class="levelbtn locked" data-goto="l5" id="btnL5">
                <div class="k">Niveau 5 ‚Äî Argumenter</div>
                <div class="d">C5 : choisir + justifier avec connecteurs.</div>
                <div class="tag">C5 + C6</div>
              </div>
              <div class="levelbtn locked" data-goto="final" id="btnFinal">
                <div class="k">Final ‚Äî Passeport</div>
                <div class="d">Profil par comp√©tence + conseils.</div>
                <div class="tag">profil</div>
              </div>
            </div>

            <details>
              <summary>üìå Rappel express des comp√©tences</summary>
              <div class="bd">
                <div class="note">
                  <b>C1</b> traiter une information (rep√©rer / classer) ‚Ä¢ <b>C2</b> appliquer une d√©marche d‚Äôanalyse (outil) ‚Ä¢
                  <b>C3</b> expliquer / mettre en relation (sens + pr√©vention) ‚Ä¢ <b>C4</b> proposer des solutions ‚Ä¢
                  <b>C5</b> choisir + argumenter avec preuves ‚Ä¢ <b>C6</b> communiquer clairement (bonus qualit√©).
                </div>
              </div>
            </details>

          </div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 1 -->
    <section class="screen" id="screen_l1">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 1 ‚Äî Reconna√Ætre la comp√©tence</div>
              <div class="sub">Clique la bonne comp√©tence. Si tu te trompes, tu as une rem√©diation claire.</div>
              <div class="pillrow">
                <span class="pill blue">Clics uniquement</span>
                <span class="pill">Pas d‚Äô√©criture</span>
              </div>
            </div>
            <span class="pill good">C1‚ÄìC6</span>
          </div>
          <div class="bd" id="l1_container"></div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 2 -->
    <section class="screen" id="screen_l2">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 2 ‚Äî C2 guid√©e : analyser avec QQOQCP</div>
              <div class="sub">Tout se fait par clic : choisir, puis remplir les cases.</div>
            </div>
            <span class="pill good">Pivot : C2</span>
          </div>
          <div class="bd">
            <div class="note">
              <b>Mini-situation</b><br><br>
              En atelier, Lina doit poncer des pi√®ces en bois. La machine vibre, il y a du bruit, et la cadence est √©lev√©e.
              Apr√®s 1h, elle a des douleurs au poignet et se sent tendue.
              <div style="margin-top:10px;">
                <button class="btn small" id="openDocS">Voir mini-doc situation</button>
              </div>
            </div>

            <div class="qbox" id="l2_q1">
              <div class="qtitle">Q1 ‚Äî Formuler le probl√®me (C2)</div>
              <div class="qhint">Choisis la meilleure phrase-probl√®me (analyser avant solutions).</div>
              <div class="choices" data-question="l2_q1"></div>
              <div class="toast" id="toast_l2_q1"></div>
            </div>

            <div class="qbox" id="l2_q2">
              <div class="qtitle">Q2 ‚Äî Compl√©ter QQOQCP (C2)</div>
              <div class="qhint">S√©lectionne une pastille, puis touche la case correspondante. (0 √©criture)</div>

              <div class="chipbank" id="l2_bank"></div>
              <div class="slots" id="l2_slots"></div>

              <div class="toast" id="toast_l2_q2"></div>

              <div class="footerrow">
                <div class="left">
                  <button class="btn ghost" id="l2_reset">R√©initialiser</button>
                </div>
                <div class="right">
                  <button class="btn primary" id="l2_validate">Valider QQOQCP</button>
                </div>
              </div>
              <div class="mini">
                Rem√©diation rapide : si tu bloques, vise d‚Äôabord <b>Comment</b> (conditions) puis <b>Pourquoi</b> (effets).
              </div>
            </div>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="l2_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="l2_next">Continuer</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 3 -->
    <section class="screen" id="screen_l3">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 3 ‚Äî Relier cause ‚Üí effet + phrase causale</div>
              <div class="sub">C2 (d√©marche) + C3 (sens) ‚Ä¢ 0 √©criture ‚Ä¢ clics uniquement</div>
            </div>
            <span class="pill blue">C2 + C3</span>
          </div>
          <div class="bd">

            <div class="note">
              <b>Mini-doc</b><br><br>
              Une exposition <b>prolong√©e</b> au bruit et √† la vibration augmente la <b>fatigue</b>, la <b>tension</b> et le risque de <b>douleurs</b>.
              La <b>cadence</b> et le manque de pauses peuvent aggraver la situation.
              <div style="margin-top:10px;">
                <button class="btn small" id="openDoc3">Voir mini-doc niveau 3</button>
              </div>
            </div>

            <div class="qbox" id="l3_q1">
              <div class="qtitle">Q1 ‚Äî Choisir la cause principale (C2)</div>
              <div class="qhint">Une cause = ce qui explique le probl√®me dans la situation.</div>
              <div class="choices" data-question="l3_q1"></div>
              <div class="toast" id="toast_l3_q1"></div>
            </div>

            <div class="qbox" id="l3_q2">
              <div class="qtitle">Q2 ‚Äî Construire une phrase causale (C2 ‚Üí C3)</div>
              <div class="qhint">Choisis 1 proposition dans chaque case pour obtenir une phrase correcte.</div>

              <div class="chipbank" id="l3_bank"></div>
              <div class="slots" id="l3_slots"></div>

              <div class="toast" id="toast_l3_q2"></div>

              <div class="footerrow">
                <div class="left">
                  <button class="btn ghost" id="l3_reset">R√©initialiser</button>
                </div>
                <div class="right">
                  <button class="btn primary" id="l3_validate">Valider la phrase</button>
                </div>
              </div>
              <div class="mini">
                Mod√®le : <b>Parce que‚Ä¶</b> ‚Üí <b>alors‚Ä¶</b> ‚Üí <b>ce qui‚Ä¶</b>
              </div>
            </div>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="l3_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="l3_next">Continuer</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 4 -->
    <section class="screen" id="screen_l4">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 4 ‚Äî C4 : proposer et classer des mesures</div>
              <div class="sub">Clique une mesure, puis clique la colonne o√π la placer.</div>
            </div>
            <span class="pill blue">C4 + C1</span>
          </div>
          <div class="bd">

            <div class="qbox">
              <div class="qtitle">Mesures disponibles</div>
              <div class="qhint">Choisis les mesures les plus pertinentes puis classe-les.</div>
              <div class="chipbank" id="l4_measures"></div>
            </div>

            <div class="qbox">
              <div class="qtitle">Classement (clic ‚Üí d√©poser)</div>
              <div class="qhint">Touche une colonne pour y d√©poser la mesure s√©lectionn√©e.</div>

              <div class="slots" id="l4_slots"></div>
              <div class="toast" id="toast_l4"></div>

              <div class="footerrow">
                <div class="left">
                  <button class="btn ghost" id="l4_reset">R√©initialiser</button>
                </div>
                <div class="right">
                  <button class="btn primary" id="l4_validate">Valider le classement</button>
                </div>
              </div>
              <div class="mini">
                Astuce : d‚Äôabord <b>r√©duction √† la source</b> et <b>organisation</b>, puis individuel.
              </div>
            </div>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="l4_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="l4_next">Continuer</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 5 -->
    <section class="screen" id="screen_l5">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 5 ‚Äî C5 : choisir + argumenter (clics)</div>
              <div class="sub">Tu choisis un plan, puis tu construis une justification avec connecteurs.</div>
            </div>
            <span class="pill warn">C5 + C6</span>
          </div>
          <div class="bd">

            <div class="note">
              <b>Deux plans d‚Äôaction</b><br><br>
              <b>Plan A</b> : r√©duire la vibration √† la source + pause r√©guli√®re + r√©organisation de la cadence.<br>
              <b>Plan B</b> : gants anti-vibration + rappel ‚Äútenir fermement‚Äù + affichage de consignes.<br>
              <div class="muted" style="margin-top:8px; font-size:13px;">C5 = trancher et justifier avec logique (pas un avis).</div>
            </div>

            <div class="qbox" id="l5_q1">
              <div class="qtitle">Q1 ‚Äî Choisir le meilleur plan (C5)</div>
              <div class="qhint">Choisir = annoncer ton choix clairement.</div>
              <div class="choices" data-question="l5_q1"></div>
              <div class="toast" id="toast_l5_q1"></div>
            </div>

            <div class="qbox" id="l5_q2">
              <div class="qtitle">Q2 ‚Äî Construire l‚Äôargumentaire (C5 + C6)</div>
              <div class="qhint">S√©lectionne une pastille, puis touche la case. Objectif : logique + connecteurs.</div>

              <div class="chipbank" id="l5_bank"></div>
              <div class="slots" id="l5_slots"></div>

              <div class="toast" id="toast_l5_q2"></div>

              <div class="footerrow">
                <div class="left">
                  <button class="btn ghost" id="l5_reset">R√©initialiser</button>
                </div>
                <div class="right">
                  <button class="btn primary" id="l5_validate">Valider l‚Äôargument</button>
                </div>
              </div>

              <div class="mini">
                Structure attendue : <b>Je choisis‚Ä¶</b> + <b>car‚Ä¶</b> + <b>de plus‚Ä¶</b> + <b>donc‚Ä¶</b> (+ option : <b>cependant‚Ä¶</b>)
              </div>
            </div>

            <div class="qbox" id="l5_meta">
              <div class="qtitle">Mini-check final</div>
              <div class="qhint">Clique la r√©ponse la plus vraie pour toi.</div>
              <div class="choices" data-question="l5_meta"></div>
              <div class="toast" id="toast_l5_meta"></div>
            </div>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="l5_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="l5_next">Voir mon passeport</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- FINAL -->
    <section class="screen" id="screen_final">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">üèÅ Ton passeport comp√©tences</div>
              <div class="sub">Profil par comp√©tence (mesur√©) + conseils cibl√©s. C1/C6 = indicateurs transversaux.</div>
            </div>
            <span class="pill good">profil</span>
          </div>
          <div class="bd">

            <div class="kpi">
              <div class="box">
                <div class="n" id="kpiStars">0</div>
                <div class="l">√âtoiles</div>
              </div>
              <div class="box">
                <div class="n" id="kpiPct">0%</div>
                <div class="l">Progression</div>
              </div>
              <div class="box">
                <div class="n" id="kpiStrong">‚Äî</div>
                <div class="l">Point fort</div>
              </div>
              <div class="box">
                <div class="n" id="kpiWork">‚Äî</div>
                <div class="l">√Ä travailler</div>
              </div>
            </div>

            <div class="qbox">
              <div class="qtitle">Radar (C2‚ÄìC5) + indicateurs (C1/C6)</div>
              <div class="qhint">Le radar n‚Äôaffiche que des comp√©tences r√©ellement mesur√©es.</div>
              <div id="radarWrap"></div>
            </div>

            <div class="qbox">
              <div class="qtitle">Conseils cibl√©s</div>
              <div class="qhint">Deux priorit√©s maximum.</div>
              <div class="note" id="adviceBox"></div>
            </div>

            <details>
              <summary>üßë‚Äçüè´ Corrig√© prof</summary>
              <div class="bd">
                <div class="note" id="teacherKey"></div>
              </div>
            </details>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="final_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="final_restart">Recommencer</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

  </div>

<script>
/* =========================
   DONN√âES
========================= */

const MODULE = {
  code: "C11",
  titre: "Analyse d‚Äôune situation de travail",
  niveau: "CAP / Bac Pro",
  objectif: "Analyser une situation-probl√®me avec une m√©thode, puis proposer et justifier des mesures de pr√©vention."
};

const COMP = {
  C1: "Traiter une information",
  C2: "Appliquer une d√©marche d‚Äôanalyse",
  C3: "Expliquer / mettre en relation",
  C4: "Proposer une solution",
  C5: "Argumenter un choix",
  C6: "Communiquer clairement"
};

const MAX = { C1: 6, C2: 18, C3: 10, C4: 10, C5: 12, C6: 6 };

const DOCS = {
  A: {
    title: "Document A ‚Äî Exemple (C1)",
    body: `
      <b>But</b> : rep√©rer et classer des informations (pas analyser).<br><br>
      Exemple d‚Äôinfos possibles dans un document :<br>
      ‚Ä¢ bruit ‚Ä¢ vibration ‚Ä¢ cadence ‚Ä¢ absence de pauses ‚Ä¢ douleur poignet ‚Ä¢ tension<br><br>
      <span class="muted">Dans le passeport, ces mini-docs remplacent le ‚Äúcours‚Äù.</span>
    `
  },
  S: {
    title: "Mini-doc ‚Äî Situation (Niveau 2)",
    body: `
      <b>Contexte</b> : atelier, pon√ßage de pi√®ces.<br>
      <b>Exposition</b> : bruit + vibration + cadence √©lev√©e.<br>
      <b>Effets</b> : douleurs au poignet + tension apr√®s 1h.<br><br>
      <span class="muted">Objectif : organiser avec QQOQCP (C2).</span>
    `
  },
  N3: {
    title: "Mini-doc ‚Äî Effets exposition (Niveau 3)",
    body: `
      Exposition prolong√©e au bruit/vibration ‚Üí fatigue + tension ‚Üí douleurs (risque accru).<br>
      Cadence √©lev√©e et manque de pauses aggravent.<br><br>
      <span class="muted">Objectif : relier cause ‚Üí cons√©quence ‚Üí effet (C2‚ÜíC3).</span>
    `
  }
};

/* =========================
   STATE
========================= */

const LSKEY = "passeport_c11_clicks_only_light_v2";

let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw) return normalizeState(JSON.parse(raw));
  }catch(e){}
  return normalizeState({
    unlocked: 1,
    stars: 0,
    screen: "home",
    score: { C1:0, C2:0, C3:0, C4:0, C5:0, C6:0 },
    done: {},
    answers: {}
  });
}

function normalizeState(s){
  s.unlocked = clamp(Number(s.unlocked||1),1,6);
  s.stars = clamp(Number(s.stars||0),0,999);
  s.screen = s.screen || "home";
  s.score = s.score || {};
  s.done = s.done || {};
  s.answers = s.answers || {};
  for(const k of Object.keys(MAX)){
    s.score[k] = clamp(Number(s.score[k]||0),0,MAX[k]);
  }
  return s;
}

function saveState(){
  try{ localStorage.setItem(LSKEY, JSON.stringify(state)); }catch(e){}
  renderTop();
}

function resetAll(){
  localStorage.removeItem(LSKEY);
  state = loadState();
  go("home");
}

/* =========================
   UTILS
========================= */

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function pct(a,b){ return b<=0 ? 0 : Math.round((a/b)*100); }

function totalScore(){
  let a=0,b=0;
  for(const k of Object.keys(MAX)){ a+=state.score[k]; b+=MAX[k]; }
  return {a,b};
}
function globalProgress(){
  const {a,b}=totalScore();
  return pct(a,b);
}

function addScore(key, pts){
  state.score[key] = clamp(state.score[key] + pts, 0, MAX[key]);
}
function setDone(id, val=true){ state.done[id] = !!val; }
function isDone(id){ return !!state.done[id]; }
function unlock(level){ state.unlocked = Math.max(state.unlocked, level); }
function levelUnlocked(level){ return state.unlocked >= level; }
function starOnce(levelId){
  if(isDone("star_"+levelId)) return;
  state.stars += 1;
  setDone("star_"+levelId, true);
}

/* =========================
   NAVIGATION
========================= */

const screens = ["home","l1","l2","l3","l4","l5","final"];

function go(name){
  for(const s of screens){
    document.getElementById("screen_"+s).classList.toggle("active", s===name);
  }
  state.screen = name;
  saveState();
  if(name==="final") renderFinal();
  window.scrollTo({top:0, behavior:"smooth"});
}

function explainLock(need){
  const map = {
    2: "Pour d√©bloquer le niveau 2 : r√©ussir au moins 5 questions du niveau 1.",
    3: "Pour d√©bloquer le niveau 3 : valider le QQOQCP (niveau 2).",
    4: "Pour d√©bloquer le niveau 4 : valider la phrase causale (niveau 3).",
    5: "Pour d√©bloquer le niveau 5 : valider le classement des mesures (niveau 4).",
    6: "Pour voir ton passeport : valider l‚Äôargumentaire (niveau 5)."
  };
  alert(map[need] || "Niveau verrouill√©.");
}

document.getElementById("btnHome").addEventListener("click", ()=>go("home"));
document.getElementById("btnScore").addEventListener("click", ()=>{
  if(levelUnlocked(6)) go("final"); else explainLock(6);
});
document.getElementById("btnReset").addEventListener("click", resetAll);

document.querySelectorAll(".levelbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const t = btn.getAttribute("data-goto");
    const map = { l1:1, l2:2, l3:3, l4:4, l5:5, final:6 };
    const need = map[t] || 1;
    if(levelUnlocked(need)) go(t);
    else explainLock(need);
  });
});

/* =========================
   DOC MODAL
========================= */

const docBack = document.getElementById("docModalBack");
const docTitle = document.getElementById("docModalTitle");
const docBody = document.getElementById("docModalBody");

function openDoc(key){
  const d = DOCS[key];
  if(!d) return;
  docTitle.textContent = d.title;
  docBody.innerHTML = d.body;
  docBack.classList.add("show");
}
function closeDoc(){
  docBack.classList.remove("show");
}
document.getElementById("docClose").addEventListener("click", closeDoc);
docBack.addEventListener("click", (e)=>{ if(e.target===docBack) closeDoc(); });

document.getElementById("btnDocs").addEventListener("click", ()=>openDoc("A"));
document.getElementById("openDocS")?.addEventListener("click", ()=>openDoc("S"));
document.getElementById("openDoc3")?.addEventListener("click", ()=>openDoc("N3"));

/* =========================
   UI HELPERS
========================= */

function toastRemed(elId, ok, title, why, how){
  const el = document.getElementById(elId);
  el.className = "toast show " + (ok ? "good" : "bad");
  el.innerHTML = ok
    ? `<div class="t">${title}</div><div class="m">${why}</div>`
    : `<div class="t">${title}</div><div class="m"><b>Pourquoi</b> : ${why}<br><br><b>Pour r√©ussir</b> : ${how}</div>`;
}

function clearToast(elId){
  const el = document.getElementById(elId);
  el.className = "toast";
  el.innerHTML = "";
}

function mkChoice(container, items, onPick){
  container.innerHTML = "";
  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.innerHTML = `<div><b>${it.t}</b></div><div class="s">${it.s||""}</div>`;
    div.addEventListener("click", ()=>{
      [...container.querySelectorAll(".choice")].forEach(c=>c.classList.remove("sel"));
      div.classList.add("sel");
      onPick(it);
    });
    container.appendChild(div);
  });
}

function mkChipBank(container, chips, onPick){
  container.innerHTML = "";
  chips.forEach(ch=>{
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = ch;
    c.addEventListener("click", ()=>{
      [...container.querySelectorAll(".chip")].forEach(x=>x.classList.remove("sel"));
      c.classList.add("sel");
      onPick(ch);
    });
    container.appendChild(c);
  });
}

function mkSlots(container, slots, onClickSlot){
  container.innerHTML = "";
  slots.forEach(s=>{
    const row = document.createElement("div");
    row.className = "slotrow";
    row.innerHTML = `
      <div class="slotlabel">${s.label}</div>
      <div class="slot" tabindex="0" data-key="${s.key}">${s.value||"‚Äî"}</div>
    `;
    const sl = row.querySelector(".slot");
    if(s.value) sl.classList.add("filled");
    sl.addEventListener("click", ()=>onClickSlot(s.key, sl));
    container.appendChild(row);
  });
}

/* =========================
   TOP RENDER
========================= */

function renderTop(){
  const locks = [
    {id:"btnL2", lvl:2},
    {id:"btnL3", lvl:3},
    {id:"btnL4", lvl:4},
    {id:"btnL5", lvl:5},
    {id:"btnFinal", lvl:6}
  ];
  locks.forEach(x=>{
    const el = document.getElementById(x.id);
    if(!el) return;
    el.classList.toggle("locked", !levelUnlocked(x.lvl));
  });

  const gp = globalProgress();
  document.getElementById("globalBar").style.width = gp+"%";
  document.getElementById("globalPct").textContent = gp+"%";
  document.getElementById("globalStars").textContent = state.stars;
  document.getElementById("unlockedLbl").textContent = String(state.unlocked);
}

renderTop();

/* =========================
   NIVEAU 1
========================= */

const L1 = [
  {
    id:"l1_1",
    consigne:"D‚Äôapr√®s le document A, relever 3 facteurs et les classer en cat√©gories.",
    answer:"C1",
    indice:"Verbes relever/classer + tableau/liste.",
    docKey:"A"
  },
  {
    id:"l1_2",
    consigne:"Compl√©ter un QQOQCP √† partir de la situation pour organiser l‚Äôanalyse.",
    answer:"C2",
    indice:"Outil/m√©thode d‚Äôanalyse.",
    docKey:"S"
  },
  {
    id:"l1_3",
    consigne:"Expliquer le lien entre exposition et cons√©quences, puis relier √† une pr√©vention.",
    answer:"C3",
    indice:"M√©canisme/liaison pr√©vention.",
    docKey:"N3"
  },
  {
    id:"l1_4",
    consigne:"Proposer 3 mesures adapt√©es √† la situation et les hi√©rarchiser.",
    answer:"C4",
    indice:"Actions concr√®tes + hi√©rarchie.",
    docKey:"S"
  },
  {
    id:"l1_5",
    consigne:"Choisir entre deux plans d‚Äôaction et justifier avec 2 arguments et des connecteurs.",
    answer:"C5",
    indice:"Trancher + preuves + connecteurs.",
    docKey:"N3"
  },
  {
    id:"l1_6",
    consigne:"R√©diger en phrases claires, avec vocabulaire pr√©cis et connecteurs.",
    answer:"C6",
    indice:"Qualit√© de communication.",
    docKey:"A"
  }
];

function renderL1(){
  const wrap = document.getElementById("l1_container");
  wrap.innerHTML = "";

  const intro = document.createElement("div");
  intro.className = "note";
  intro.innerHTML = `<b>But</b> : lire la consigne comme un correcteur. Si tu h√©sites, clique <b>Voir mini-doc</b>.`;
  wrap.appendChild(intro);

  L1.forEach(item=>{
    const box = document.createElement("div");
    box.className = "qbox";
    box.innerHTML = `
      <div class="qtitle">${item.consigne}</div>
      <div class="qhint">Choisis : C1 / C2 / C3 / C4 / C5 / C6</div>
      <div class="footerrow" style="margin-top:10px;">
        <div class="left">
          <button class="btn small ghost" data-doc="${item.docKey}">Voir mini-doc</button>
        </div>
        <div class="right">
          <span class="pill" id="picked_${item.id}">Choix : ‚Äî</span>
        </div>
      </div>
      <div class="chipbank" id="${item.id}_chips"></div>
      <div class="toast" id="toast_${item.id}"></div>
    `;
    wrap.appendChild(box);

    box.querySelector('[data-doc]').addEventListener("click", ()=>openDoc(item.docKey));

    const bank = box.querySelector("#"+item.id+"_chips");
    const chips = ["C1","C2","C3","C4","C5","C6"];
    mkChipBank(bank, chips, (picked)=>{
      state.answers[item.id] = picked;
      document.getElementById("picked_"+item.id).textContent = "Choix : " + picked;

      if(picked === item.answer){
        toastRemed("toast_"+item.id, true, "‚úÖ Correct", "Indice : " + item.indice, "");
        if(!isDone(item.id)){
          addScore(item.answer, 2);
          addScore("C6", 1); // bonus lecture consigne
          setDone(item.id, true);
          saveState();
        }
      }else{
        toastRemed(
          "toast_"+item.id,
          false,
          "‚õî Pas encore",
          "Tu as choisi " + picked + " mais l‚Äôaction demand√©e ne correspond pas.",
          "Rep√®re le verbe + le format : " + item.indice
        );
        saveState();
      }

      const doneCount = L1.filter(x=>isDone(x.id)).length;
      if(doneCount >= 5){
        unlock(2);
        saveState();
      }
    });

    // Restore selection highlight
    const prev = state.answers[item.id];
    if(prev){
      document.getElementById("picked_"+item.id).textContent = "Choix : " + prev;
      [...bank.querySelectorAll(".chip")].forEach(c=>{
        if(c.textContent.trim()===prev) c.classList.add("sel");
      });
    }
  });

  const foot = document.createElement("div");
  foot.className = "footerrow";
  foot.innerHTML = `
    <div class="left"><button class="btn ghost" id="l1_back">Retour</button></div>
    <div class="right"><button class="btn primary" id="l1_next">Continuer</button></div>
  `;
  wrap.appendChild(foot);

  document.getElementById("l1_back").addEventListener("click", ()=>go("home"));
  document.getElementById("l1_next").addEventListener("click", ()=>{
    if(levelUnlocked(2)) go("l2"); else explainLock(2);
  });
}
renderL1();

/* =========================
   NIVEAU 2
========================= */

const L2_Q1_CHOICES = [
  { id:"a", t:"La situation pr√©sente des facteurs (bruit, vibration, cadence) qui provoquent fatigue et douleurs.", s:"Phrase-probl√®me claire." },
  { id:"b", t:"Lina n‚Äôaime pas son travail.", s:"Avis, pas une analyse." },
  { id:"c", t:"Le bois est un mat√©riau.", s:"Hors sujet." },
  { id:"d", t:"Il faut acheter des gants.", s:"Solution, pas probl√®me." },
];
const L2_Q1_OK = "a";

mkChoice(document.querySelector('#l2_q1 .choices'), L2_Q1_CHOICES, (it)=>{
  state.answers.l2_q1 = it.id;

  if(it.id===L2_Q1_OK){
    toastRemed("toast_l2_q1", true, "‚úÖ Correct (C2)", "Tu formules le probl√®me avant les solutions.", "");
    if(!isDone("l2_q1")){
      addScore("C2", 4);
      addScore("C6", 1);
      setDone("l2_q1", true);
      saveState();
    }
  }else{
    toastRemed(
      "toast_l2_q1",
      false,
      "‚õî √Ä corriger",
      "Ce n‚Äôest pas une formulation de probl√®me (c‚Äôest un avis, un hors-sujet, ou une solution).",
      "Choisis une phrase qui d√©crit le probl√®me avec les facteurs de la situation (bruit/vibration/cadence) et leurs effets."
    );
    saveState();
  }
});

const L2_BANK = [
  "En atelier",
  "Poncer des pi√®ces",
  "Cadence √©lev√©e",
  "Bruit + vibration",
  "Apr√®s 1h",
  "Douleurs poignet",
  "Tension / stress"
];

const L2_SLOTS_DEF = [
  { key:"qui", label:"Qui ?", fixed:"Lina" },
  { key:"quoi", label:"Quoi ?", ok:["Poncer des pi√®ces"] },
  { key:"ou", label:"O√π ?", ok:["En atelier"] },
  { key:"quand", label:"Quand ?", ok:["Apr√®s 1h"] },
  { key:"comment", label:"Comment ?", ok:["Cadence √©lev√©e","Bruit + vibration"], multi:true },
  { key:"pourquoi", label:"Pourquoi ?", ok:["Douleurs poignet","Tension / stress"], multi:true }
];

let l2SelectedChip = null;

function renderL2(){
  mkChipBank(document.getElementById("l2_bank"), L2_BANK, (ch)=>{ l2SelectedChip = ch; });

  const saved = state.answers.l2_slots || {};
  const slots = L2_SLOTS_DEF.map(s=>{
    let val = saved[s.key];
    if(s.fixed) val = s.fixed;
    const show = Array.isArray(val) ? (val.length ? val.join(" ‚Ä¢ ") : "") : (val || "");
    return { label:s.label, key:s.key, value: show };
  });

  mkSlots(document.getElementById("l2_slots"), slots, (key)=>{
    if(key==="qui") return;
    if(!l2SelectedChip) return;

    const def = L2_SLOTS_DEF.find(x=>x.key===key);
    const saved2 = state.answers.l2_slots || {};

    if(def.multi){
      let arr = Array.isArray(saved2[key]) ? saved2[key] : [];
      if(!arr.includes(l2SelectedChip)) arr.push(l2SelectedChip);
      saved2[key] = arr;
    }else{
      saved2[key] = l2SelectedChip;
    }

    state.answers.l2_slots = saved2;
    clearToast("toast_l2_q2");
    saveState();
    renderL2();
  });

  [...document.querySelectorAll("#l2_slots .slot")].forEach(sl=>{
    const t = sl.textContent.trim();
    if(t && t!=="‚Äî") sl.classList.add("filled");
  });
}
renderL2();

document.getElementById("l2_reset").addEventListener("click", ()=>{
  state.answers.l2_slots = {};
  l2SelectedChip = null;
  clearToast("toast_l2_q2");
  saveState();
  renderL2();
});

document.getElementById("l2_validate").addEventListener("click", ()=>{
  const saved = state.answers.l2_slots || {};
  let ok=0, total=0;

  L2_SLOTS_DEF.forEach(def=>{
    if(def.fixed) return;
    total++;
    if(def.multi){
      const arr = Array.isArray(saved[def.key]) ? saved[def.key] : [];
      const hit = def.ok.some(v=>arr.includes(v));
      if(hit) ok++;
    }else{
      if(def.ok.includes(saved[def.key])) ok++;
    }
  });

  const p = Math.round((ok/total)*100);

  if(p>=70){
    toastRemed("toast_l2_q2", true, "‚úÖ Valid√© (C2)", `Outil rempli (${p}%).`, "");
    if(!isDone("l2_q2")){
      addScore("C2", 6);
      addScore("C1", 2);
      addScore("C6", 1);
      setDone("l2_q2", true);
      unlock(3);
      starOnce("l2");
      saveState();
    }
  }else{
    toastRemed(
      "toast_l2_q2",
      false,
      "‚õî √Ä compl√©ter",
      `QQOQCP incomplet (${p}%).`,
      "R√®gle : ‚ÄúComment‚Äù = conditions (cadence/bruit/vibration) ; ‚ÄúPourquoi‚Äù = effets (douleurs/tension)."
    );
    saveState();
  }
});

document.getElementById("l2_back").addEventListener("click", ()=>go("home"));
document.getElementById("l2_next").addEventListener("click", ()=>{
  if(levelUnlocked(3)) go("l3"); else explainLock(3);
});

/* =========================
   NIVEAU 3
========================= */

const L3_Q1_CHOICES = [
  { id:"a", t:"Bruit + vibration + cadence (exposition)", s:"Cause principale probable." },
  { id:"b", t:"La couleur des pi√®ces", s:"Hors analyse." },
  { id:"c", t:"La m√©t√©o", s:"Hors situation." },
  { id:"d", t:"Le fait d‚Äôavoir des gants", s:"Mesure, pas cause." },
];
const L3_Q1_OK = "a";

mkChoice(document.querySelector('#l3_q1 .choices'), L3_Q1_CHOICES, (it)=>{
  state.answers.l3_q1 = it.id;

  if(it.id===L3_Q1_OK){
    toastRemed("toast_l3_q1", true, "‚úÖ Correct (C2)", "Tu identifies une cause li√©e √† l‚Äôexposition.", "");
    if(!isDone("l3_q1")){
      addScore("C2", 4);
      addScore("C6", 1);
      setDone("l3_q1", true);
      saveState();
    }
  }else{
    toastRemed(
      "toast_l3_q1",
      false,
      "‚õî √Ä corriger",
      "Une cause doit expliquer le probl√®me dans la situation (pas un d√©tail hors-sujet, ni une solution).",
      "Choisis ce qui augmente l‚Äôexposition (bruit/vibration/cadence) et peut produire les effets."
    );
    saveState();
  }
});

const L3_BANK = [
  "Parce que l‚Äôexposition est prolong√©e",
  "Parce que la cadence est √©lev√©e",
  "Parce que la vibration est importante",
  "alors la fatigue augmente",
  "alors la tension augmente",
  "ce qui entra√Æne des douleurs",
  "ce qui augmente le risque"
];

const L3_SLOTS = [
  { key:"s1", label:"Parce que‚Ä¶", ok:["Parce que l‚Äôexposition est prolong√©e","Parce que la cadence est √©lev√©e","Parce que la vibration est importante"] },
  { key:"s2", label:"alors‚Ä¶", ok:["alors la fatigue augmente","alors la tension augmente"] },
  { key:"s3", label:"ce qui‚Ä¶", ok:["ce qui entra√Æne des douleurs","ce qui augmente le risque"] }
];

let l3Selected = null;

function renderL3(){
  mkChipBank(document.getElementById("l3_bank"), L3_BANK, (ch)=>{ l3Selected = ch; });
  const saved = state.answers.l3_slots || {};
  const slots = L3_SLOTS.map(s=>({ label:s.label, key:s.key, value: saved[s.key] || "" }));

  mkSlots(document.getElementById("l3_slots"), slots, (key)=>{
    if(!l3Selected) return;
    const saved2 = state.answers.l3_slots || {};
    saved2[key] = l3Selected;
    state.answers.l3_slots = saved2;
    clearToast("toast_l3_q2");
    saveState();
    renderL3();
  });

  [...document.querySelectorAll("#l3_slots .slot")].forEach(sl=>{
    const t = sl.textContent.trim();
    if(t && t!=="‚Äî") sl.classList.add("filled");
  });
}
renderL3();

document.getElementById("l3_reset").addEventListener("click", ()=>{
  state.answers.l3_slots = {};
  l3Selected = null;
  clearToast("toast_l3_q2");
  saveState();
  renderL3();
});

document.getElementById("l3_validate").addEventListener("click", ()=>{
  const saved = state.answers.l3_slots || {};
  let ok=0;
  for(const s of L3_SLOTS){
    if(s.ok.includes(saved[s.key])) ok++;
  }
  if(ok===3){
    toastRemed("toast_l3_q2", true, "‚úÖ Valid√© (C2‚ÜíC3)", "Phrase logique : cause ‚Üí cons√©quence ‚Üí effet.", "");
    if(!isDone("l3_q2")){
      addScore("C2", 4);
      addScore("C3", 4);
      addScore("C6", 1);
      setDone("l3_q2", true);
      unlock(4);
      starOnce("l3");
      saveState();
    }
  }else{
    toastRemed(
      "toast_l3_q2",
      false,
      "‚õî √Ä corriger",
      "La phrase n‚Äôa pas les 3 blocs dans le bon ordre.",
      "Remplis 1 case ‚ÄúParce que‚Ä¶‚Äù, 1 case ‚Äúalors‚Ä¶‚Äù, 1 case ‚Äúce qui‚Ä¶‚Äù."
    );
    saveState();
  }
});

document.getElementById("l3_back").addEventListener("click", ()=>go("home"));
document.getElementById("l3_next").addEventListener("click", ()=>{
  if(levelUnlocked(4)) go("l4"); else explainLock(4);
});

/* =========================
   NIVEAU 4
========================= */

const L4_MEASURES = [
  "R√©duire la vibration √† la source",
  "Installer une protection collective (isolation)",
  "Mettre des pauses r√©guli√®res",
  "R√©organiser la cadence",
  "Gants anti-vibration",
  "Rappel consignes affich√©es",
  "Former au bon geste"
];

const L4_COLS = [
  { key:"col1", label:"R√©duction √† la source", ok:["R√©duire la vibration √† la source"] },
  { key:"col2", label:"Protection collective", ok:["Installer une protection collective (isolation)"] },
  { key:"col3", label:"Organisation", ok:["Mettre des pauses r√©guli√®res","R√©organiser la cadence"] },
  { key:"col4", label:"Individuel / Info", ok:["Gants anti-vibration","Former au bon geste","Rappel consignes affich√©es"] }
];

let l4Selected = null;

function renderL4(){
  mkChipBank(document.getElementById("l4_measures"), L4_MEASURES, (ch)=>{ l4Selected = ch; });

  const saved = state.answers.l4_cols || {};
  const slots = L4_COLS.map(c=>{
    const arr = Array.isArray(saved[c.key]) ? saved[c.key] : [];
    return { label:c.label, key:c.key, value: arr.length ? arr.join(" ‚Ä¢ ") : "" };
  });

  mkSlots(document.getElementById("l4_slots"), slots, (key)=>{
    if(!l4Selected) return;
    const saved2 = state.answers.l4_cols || {};
    let arr = Array.isArray(saved2[key]) ? saved2[key] : [];
    if(!arr.includes(l4Selected)) arr.push(l4Selected);
    saved2[key] = arr;
    state.answers.l4_cols = saved2;
    clearToast("toast_l4");
    saveState();
    renderL4();
  });

  [...document.querySelectorAll("#l4_slots .slot")].forEach(sl=>{
    const t = sl.textContent.trim();
    if(t && t!=="‚Äî") sl.classList.add("filled");
  });
}
renderL4();

document.getElementById("l4_reset").addEventListener("click", ()=>{
  state.answers.l4_cols = {};
  l4Selected = null;
  clearToast("toast_l4");
  saveState();
  renderL4();
});

document.getElementById("l4_validate").addEventListener("click", ()=>{
  const saved = state.answers.l4_cols || {};
  const totalChosen = Object.values(saved).reduce((acc, arr)=> acc + (Array.isArray(arr)?arr.length:0), 0);

  let hits = 0;
  L4_COLS.forEach(c=>{
    const arr = Array.isArray(saved[c.key]) ? saved[c.key] : [];
    c.ok.forEach(v=>{ if(arr.includes(v)) hits++; });
  });

  let points = 0;
  if(totalChosen >= 3) points += 2;
  points += clamp(hits*2, 0, 6);

  if(points >= 6){
    toastRemed("toast_l4", true, "‚úÖ Valid√© (C4)", "Mesures pertinentes + logique de pr√©vention visible.", "");
    if(!isDone("l4")){
      addScore("C4", 8);
      addScore("C1", 2);
      addScore("C6", 1);
      setDone("l4", true);
      unlock(5);
      starOnce("l4");
      saveState();
    }
  }else{
    toastRemed(
      "toast_l4",
      false,
      "‚õî √Ä am√©liorer",
      "Classement ou choix insuffisant.",
      "Place d‚Äôabord ‚Äúr√©duction √† la source‚Äù et ‚Äúorganisation‚Äù, puis ajoute l‚Äôindividuel en compl√©ment."
    );
    saveState();
  }
});

document.getElementById("l4_back").addEventListener("click", ()=>go("home"));
document.getElementById("l4_next").addEventListener("click", ()=>{
  if(levelUnlocked(5)) go("l5"); else explainLock(5);
});

/* =========================
   NIVEAU 5
========================= */

const L5_Q1_CHOICES = [
  { id:"a", t:"Plan A", s:"Agit sur la source + organisation." },
  { id:"b", t:"Plan B", s:"Surtout individuel / info." },
];
const L5_Q1_OK = "a";

mkChoice(document.querySelector('#l5_q1 .choices'), L5_Q1_CHOICES, (it)=>{
  state.answers.l5_q1 = it.id;

  if(it.id===L5_Q1_OK){
    toastRemed("toast_l5_q1", true, "‚úÖ Correct (C5)", "Tu choisis la strat√©gie la plus efficace (source + organisation).", "");
    if(!isDone("l5_q1")){
      addScore("C5", 4);
      addScore("C6", 1);
      setDone("l5_q1", true);
      saveState();
    }
  }else{
    toastRemed(
      "toast_l5_q1",
      false,
      "‚õî √Ä corriger",
      "C5 demande un choix selon des crit√®res (efficacit√©), pas une pr√©f√©rence.",
      "Privil√©gie l‚Äôaction sur la source et l‚Äôorganisation, puis compl√®te avec l‚Äôindividuel."
    );
    saveState();
  }
});

const L5_BANK = [
  "Je choisis le plan A",
  "car il r√©duit la vibration √† la source",
  "de plus il ajuste la cadence",
  "donc il diminue fatigue et douleurs",
  "cependant les gants restent utiles en compl√©ment",

  "Je choisis le plan B",
  "car il prot√®ge individuellement",
  "de plus il rappelle les consignes",
  "donc il limite une partie du risque"
];

const L5_SLOTS = [
  { key:"a1", label:"Choix", ok:["Je choisis le plan A","Je choisis le plan B"] },
  { key:"a2", label:"car‚Ä¶", ok:["car il r√©duit la vibration √† la source","car il prot√®ge individuellement"] },
  { key:"a3", label:"de plus‚Ä¶", ok:["de plus il ajuste la cadence","de plus il rappelle les consignes"] },
  { key:"a4", label:"donc‚Ä¶", ok:["donc il diminue fatigue et douleurs","donc il limite une partie du risque"] },
  { key:"a5", label:"cependant‚Ä¶", ok:["cependant les gants restent utiles en compl√©ment"] }
];

let l5Selected = null;

function renderL5(){
  mkChipBank(document.getElementById("l5_bank"), L5_BANK, (ch)=>{ l5Selected = ch; });

  const saved = state.answers.l5_slots || {};
  const slots = L5_SLOTS.map(s=>({ label:s.label, key:s.key, value: saved[s.key] || "" }));

  mkSlots(document.getElementById("l5_slots"), slots, (key)=>{
    if(!l5Selected) return;
    const saved2 = state.answers.l5_slots || {};
    saved2[key] = l5Selected;
    state.answers.l5_slots = saved2;
    clearToast("toast_l5_q2");
    saveState();
    renderL5();
  });

  [...document.querySelectorAll("#l5_slots .slot")].forEach(sl=>{
    const t = sl.textContent.trim();
    if(t && t!=="‚Äî") sl.classList.add("filled");
  });
}
renderL5();

document.getElementById("l5_reset").addEventListener("click", ()=>{
  state.answers.l5_slots = {};
  l5Selected = null;
  clearToast("toast_l5_q2");
  saveState();
  renderL5();
});

document.getElementById("l5_validate").addEventListener("click", ()=>{
  const pickedPlan = state.answers.l5_q1;
  if(!pickedPlan){
    toastRemed("toast_l5_q2", false, "‚õî √âtape 1", "Tu n‚Äôas pas choisi de plan.", "Commence par Q1 : choisir Plan A ou Plan B.");
    return;
  }

  const saved = state.answers.l5_slots || {};
  const txt = [saved.a1,saved.a2,saved.a3,saved.a4,saved.a5].filter(Boolean).join(" ");

  let points = 0;
  if(saved.a1) points += 1;
  if(saved.a2) points += 2;
  if(saved.a3) points += 2;
  if(saved.a4) points += 2;
  if(saved.a5) points += 1;

  const hasConnectors = /car|donc|de plus|cependant/i.test(txt);
  if(hasConnectors) points += 2;

  const expectA = (pickedPlan===L5_Q1_OK);
  const coherent = expectA ? (saved.a1==="Je choisis le plan A") : (saved.a1==="Je choisis le plan B");
  if(coherent) points += 2;

  if(points >= 9){
    toastRemed("toast_l5_q2", true, "‚úÖ Valid√© (C5 + C6)", "Choix + arguments + connecteurs : logique lisible.", "");
    if(!isDone("l5_q2")){
      addScore("C5", 8);
      addScore("C6", 2);
      setDone("l5_q2", true);
      unlock(6);
      starOnce("l5");
      saveState();
    }
  }else{
    toastRemed(
      "toast_l5_q2",
      false,
      "‚õî √Ä am√©liorer",
      "Argumentaire incomplet ou pas assez structur√©.",
      "Remplis au minimum : Choix + car + de plus + donc. Ajoute ‚Äúcependant‚Äù en bonus."
    );
    saveState();
  }
});

const L5_META_CHOICES = [
  { id:"a", t:"Je confonds encore expliquer (C3) et argumenter (C5).", s:"Conseil C3/C5." },
  { id:"b", t:"Je reconnais les comp√©tences mais j‚Äôai du mal avec les outils (C2).", s:"Conseil C2." },
  { id:"c", t:"Je sais proposer des mesures (C4) mais je les classe mal.", s:"Conseil C4." },
  { id:"d", t:"Je me sens √† l‚Äôaise : je vois ce qu‚Äôon attend.", s:"Bravo." },
];

mkChoice(document.querySelector('#l5_meta .choices'), L5_META_CHOICES, (it)=>{
  state.answers.l5_meta = it.id;
  toastRemed("toast_l5_meta", true, "‚úÖ Not√©", "R√©ponse enregistr√©e.", "");
  if(!isDone("l5_meta")){
    addScore("C6", 1);
    setDone("l5_meta", true);
    saveState();
  }
});

document.getElementById("l5_back").addEventListener("click", ()=>go("home"));
document.getElementById("l5_next").addEventListener("click", ()=>{
  if(levelUnlocked(6)) go("final"); else explainLock(6);
});

/* =========================
   FINAL
========================= */

function radarSVG(values){
  const axes = ["C2","C3","C4","C5","C1","C6"];
  const cx=170, cy=170, R=135;
  const steps=[20,40,60,80,100];

  function pt(i,val){
    const ang = (-90 + i*(360/axes.length)) * Math.PI/180;
    const r = (R * val)/100;
    return { x: cx + r*Math.cos(ang), y: cy + r*Math.sin(ang) };
  }

  let grid="";
  steps.forEach(s=>{
    const pts = axes.map((a,i)=>pt(i,s));
    const d = pts.map((p,i)=> (i===0?`M ${p.x.toFixed(1)} ${p.y.toFixed(1)}`:`L ${p.x.toFixed(1)} ${p.y.toFixed(1)}`)).join(" ") + " Z";
    grid += `<path d="${d}" fill="none" stroke="rgba(20,30,55,.12)" stroke-width="1" />`;
  });

  let lines="";
  axes.forEach((a,i)=>{
    const p = pt(i,100), p2=pt(i,0), lab=pt(i,112);
    lines += `<line x1="${p2.x}" y1="${p2.y}" x2="${p.x}" y2="${p.y}" stroke="rgba(20,30,55,.14)" />`;
    lines += `<text x="${lab.x}" y="${lab.y}" fill="rgba(23,32,51,.92)" font-size="12" font-weight="900" text-anchor="middle" dominant-baseline="middle">${a}</text>`;
  });

  const polyPts = axes.map((a,i)=>pt(i, values[a]||0));
  const ptsStr = polyPts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(" ");

  return `
    <svg viewBox="0 0 340 340" width="100%" style="max-width:520px; display:block; margin: 0 auto;">
      ${grid}
      ${lines}
      <polygon points="${ptsStr}" fill="rgba(27,191,122,.18)" stroke="rgba(27,191,122,.55)" stroke-width="2"></polygon>
      <circle cx="${cx}" cy="${cy}" r="3.5" fill="rgba(23,32,51,.55)"></circle>
    </svg>
  `;
}

function topAndBottomCompetence(){
  const keys = ["C2","C3","C4","C5"];
  const ratios = keys.map(k=>({k, v: pct(state.score[k], MAX[k])}));
  ratios.sort((a,b)=>b.v-a.v);
  return { strong: ratios[0].k, work: ratios[ratios.length-1].k };
}

function adviceText(){
  const {strong, work} = topAndBottomCompetence();
  const meta = state.answers.l5_meta;

  const tips = {
    C2: "Priorit√© C2 : remplis un outil (QQOQCP/5M) puis √©cris/formule le probl√®me avant les solutions.",
    C3: "Priorit√© C3 : explique avec 3 √©tapes (cause ‚Üí m√©canisme/r√®gle ‚Üí lien pr√©vention).",
    C4: "Priorit√© C4 : propose 3‚Äì4 mesures r√©alistes et classe-les (source/collectif/organisation/individuel).",
    C5: "Priorit√© C5 : annonce ton choix puis justifie avec 2 arguments + connecteurs (car, de plus, donc)."
  };

  let extra = "";
  if(meta==="a") extra = "Tu as indiqu√© une confusion C3/C5 : C3 = expliquer, C5 = choisir + d√©fendre.";
  if(meta==="b") extra = "Tu as indiqu√© une difficult√© C2 : utilise toujours un outil avant de proposer.";
  if(meta==="c") extra = "Tu as indiqu√© une difficult√© de classement : commence par source/organisation, puis individuel.";
  if(meta==="d") extra = "Continue : vise une r√©ponse claire (C6) avec connecteurs et vocabulaire pr√©cis.";

  return `
    <b>Point fort</b> : ${strong} ‚Äî ${COMP[strong]}<br>
    <b>√Ä travailler</b> : ${work} ‚Äî ${COMP[work]}<br><br>
    ${tips[work] || ""}<br><br>
    ${extra}
    <hr style="border:none; border-top:1px solid rgba(20,30,55,.10); margin:10px 0;">
    <b>Rappel</b> : C1 et C6 sont transversales. C1 = rep√©rer/classer. C6 = clart√© + connecteurs + vocabulaire.
  `;
}

function teacherKeyText(){
  return `
    <b>Niveau 1</b><br>
    1) C1 ‚Ä¢ 2) C2 ‚Ä¢ 3) C3 ‚Ä¢ 4) C4 ‚Ä¢ 5) C5 ‚Ä¢ 6) C6<br><br>

    <b>Niveau 2</b><br>
    Q1 : phrase-probl√®me = option A.<br>
    QQOQCP : Quoi = poncer des pi√®ces ‚Ä¢ O√π = en atelier ‚Ä¢ Quand = apr√®s 1h ‚Ä¢ Comment = cadence √©lev√©e / bruit+vibration ‚Ä¢ Pourquoi = douleurs poignet / tension.<br><br>

    <b>Niveau 3</b><br>
    Cause principale : exposition (bruit/vibration/cadence).<br>
    Phrase : ‚ÄúParce que ‚Ä¶, alors ‚Ä¶, ce qui ‚Ä¶‚Äù.<br><br>

    <b>Niveau 4</b><br>
    Logique : r√©duction √† la source + organisation avant individuel (gants).<br><br>

    <b>Niveau 5</b><br>
    Choix attendu : Plan A.<br>
    Argument : choix + 2 arguments + conclusion avec car / de plus / donc (+ nuance cependant).
  `;
}

function renderFinal(){
  const gp = globalProgress();
  document.getElementById("kpiStars").textContent = state.stars;
  document.getElementById("kpiPct").textContent = gp+"%";
  const {strong, work} = topAndBottomCompetence();
  document.getElementById("kpiStrong").textContent = strong;
  document.getElementById("kpiWork").textContent = work;

  const values = {};
  for(const k of Object.keys(MAX)){
    values[k] = pct(state.score[k], MAX[k]);
  }

  document.getElementById("radarWrap").innerHTML = radarSVG(values);
  document.getElementById("adviceBox").innerHTML = adviceText();
  document.getElementById("teacherKey").innerHTML = teacherKeyText();
}

document.getElementById("final_back").addEventListener("click", ()=>go("home"));
document.getElementById("final_restart").addEventListener("click", resetAll);

/* =========================
   AUTO-UNLOCK (reprise)
========================= */

function autoUnlock(){
  const l1done = L1.filter(x=>isDone(x.id)).length;
  if(l1done>=5) unlock(2);
  if(isDone("l2_q2")) unlock(3);
  if(isDone("l3_q2")) unlock(4);
  if(isDone("l4")) unlock(5);
  if(isDone("l5_q2")) unlock(6);
}
autoUnlock();
renderTop();

/* Restore last screen safely */
const needMap = { home:1, l1:1, l2:2, l3:3, l4:4, l5:5, final:6 };
if(screens.includes(state.screen) && levelUnlocked(needMap[state.screen]||1)){
  go(state.screen);
}else{
  go("home");
}
</script>
</body>
</html>
