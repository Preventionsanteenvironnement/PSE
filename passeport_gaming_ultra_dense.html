<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéñÔ∏è Passeport Comp√©tences ‚Äî Module C11</title>
  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --card: rgba(255,255,255,.14);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.22);
      --text:#fff;
      --muted: rgba(255,255,255,.78);
      --shadow: 0 18px 55px rgba(0,0,0,.25);
      --radius: 18px;
      --good:#2ee59d;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --chip: rgba(255,255,255,.16);
      --chip2: rgba(0,0,0,.18);
      --focus: rgba(255,255,255,.38);
    }

    *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      padding: 14px;
    }

    .app{ max-width: 980px; margin: 0 auto; }
    .topbar{
      position: sticky; top: 10px; z-index: 10;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 999px;
      backdrop-filter: blur(12px);
      box-shadow: 0 12px 35px rgba(0,0,0,.18);
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:34px; height:34px; border-radius: 10px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      font-weight:900;
    }
    .brand .t1{ font-weight:900; letter-spacing:.2px; line-height:1.1; }
    .brand .t2{ font-size:12px; color:var(--muted); margin-top:2px; }
    .actions{ display:flex; gap:8px; align-items:center; }

    .btn{
      border:none; outline:none; cursor:pointer;
      background: rgba(255,255,255,.16);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 700;
      border: 1px solid rgba(255,255,255,.18);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: rgba(255,255,255,.24);
      border-color: rgba(255,255,255,.28);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.14);
      color: rgba(255,255,255,.90);
    }
    .btn.small{ padding:8px 10px; font-size:12px; }

    .grid{
      margin-top: 14px;
      display:grid; gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.14);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .card .title{
      font-weight: 900;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .card .sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .card .bd{ padding: 14px; }
    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.16);
      font-size: 12px;
      color: rgba(255,255,255,.92);
      user-select:none;
    }
    .pill.good{ background: rgba(46,229,157,.18); border-color: rgba(46,229,157,.35); }
    .pill.warn{ background: rgba(255,209,102,.18); border-color: rgba(255,209,102,.35); }
    .pill.bad{ background: rgba(255,92,122,.18); border-color: rgba(255,92,122,.35); }

    .progress{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 10px;
    }
    .bar{
      flex: 1 1 240px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
      min-width: 180px;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(46,229,157,.95), rgba(255,209,102,.95));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .tiny{ font-size: 12px; color: var(--muted); }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .levelnav{
      display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;
    }
    .levelbtn{
      flex: 1 1 160px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      text-align:left;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .levelbtn:active{ transform: scale(.99); }
    .levelbtn.locked{ opacity:.55; cursor:not-allowed; }
    .levelbtn .k{ font-weight:900; }
    .levelbtn .d{ margin-top:4px; font-size:12px; color: var(--muted); }
    .levelbtn .tag{ display:inline-block; margin-top:8px; font-size:11px; padding:4px 8px; border-radius:999px;
      background: rgba(0,0,0,.18); border: 1px solid rgba(255,255,255,.14);
    }

    .qbox{
      background: var(--card2);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .qtitle{ font-weight: 900; }
    .qhint{ margin-top:4px; font-size: 12px; color: var(--muted); line-height: 1.35; }

    .choices{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .choice{
      flex: 1 1 220px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      min-width: 160px;
    }
    .choice:active{ transform: scale(.99); }
    .choice.sel{
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.32);
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .choice .s{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    .chipbank{ display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid rgba(255,255,255,.18);
      cursor:pointer;
      user-select:none;
      font-weight: 800;
      font-size: 13px;
    }
    .chip:active{ transform: scale(.99); }
    .chip.sel{
      outline: 2px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.22);
    }
    .slots{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .slotrow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 16px;
      padding: 12px;
    }
    .slotlabel{
      font-size: 12px; color: var(--muted);
      min-width: 88px;
      font-weight: 800;
    }
    .slot{
      flex: 1 1 180px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px dashed rgba(255,255,255,.22);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      min-height: 40px;
      display:flex; align-items:center;
    }
    .slot.filled{
      border-style: solid;
      background: rgba(46,229,157,.14);
      border-color: rgba(46,229,157,.28);
    }
    .slot:focus{ outline: 2px solid var(--focus); }
    .mini{ font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.35; }

    .toast{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      display:none;
    }
    .toast.show{ display:block; }
    .toast.good{ border-color: rgba(46,229,157,.35); background: rgba(46,229,157,.12); }
    .toast.bad{ border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.12); }
    .toast .t{ font-weight: 900; }
    .toast .m{ margin-top: 6px; color: rgba(255,255,255,.90); font-size: 13px; line-height: 1.35; }

    .footerrow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top: 12px;
    }
    .footerrow .left{ display:flex; gap:8px; flex-wrap:wrap; }
    .footerrow .right{ display:flex; gap:8px; flex-wrap:wrap; }

    details{
      border-top: 1px solid rgba(255,255,255,.14);
      margin-top: 10px;
    }
    summary{
      cursor:pointer;
      list-style:none;
      padding: 12px 14px;
      font-weight: 900;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }
    details .bd{ padding-top: 0; }
    .note{
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 12px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      line-height: 1.4;
    }
    .kpi{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .kpi .box{
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .box .n{ font-weight: 1000; font-size: 20px; }
    .kpi .box .l{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    @media (min-width: 860px){
      .slots{ grid-template-columns: 1fr 1fr; }
      .kpi{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    }
  </style>
</head>
<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo">üéñÔ∏è</div>
        <div>
          <div class="t1">Passeport Comp√©tences ‚Äî C11</div>
          <div class="t2">Analyse d‚Äôune situation de travail ‚Ä¢ mobile ‚Ä¢ clicks only</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost small" id="btnHome">Accueil</button>
        <button class="btn ghost small" id="btnScore">Mon profil</button>
        <button class="btn ghost small" id="btnReset">Reset</button>
      </div>
    </div>

    <!-- ACCUEIL -->
    <section class="screen active" id="screen_home">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">üéØ Module C11 ‚Äî Passeport Comp√©tences</div>
              <div class="sub">
                Niveau : Bac Pro / CAP (adapt√©) ‚Ä¢ Objectif : r√©ussir en comprenant la comp√©tence derri√®re la question.
              </div>
              <div class="pillrow">
                <span class="pill good">Pivot : C2</span>
                <span class="pill">Fr√©quent : C3</span>
                <span class="pill">Action : C4</span>
                <span class="pill warn">Exigeant : C5</span>
                <span class="pill">Transversal : C1</span>
                <span class="pill">Transversal : C6</span>
              </div>
            </div>
            <span class="pill">‚≠ê √©toiles</span>
          </div>
          <div class="bd">
            <div class="note">
              <b>Objectif du module</b><br><br>
              √ätre capable de <b>analyser une situation-probl√®me</b> (avec une m√©thode), puis <b>proposer</b> et <b>justifier</b> des mesures de pr√©vention.<br><br>
              <b>R√®gle du jeu</b> : tu n‚Äôas pas le cours sous les yeux. Les informations n√©cessaires sont dans le passeport (mini-docs).<br>
              <b>√âcriture</b> : 0 √† 2 mots maximum (le reste se fait par clics).
            </div>

            <div class="progress">
              <div class="bar"><i id="globalBar"></i></div>
              <div class="tiny"><span id="globalPct">0%</span> ‚Ä¢ <span id="globalStars">0</span> ‚≠ê ‚Ä¢ Niveau d√©bloqu√© : <span id="unlockedLbl">1</span></div>
            </div>

            <div class="levelnav">
              <div class="levelbtn" data-goto="l1">
                <div class="k">Niveau 1 ‚Äî Reconna√Ætre</div>
                <div class="d">Identifier la comp√©tence + le format attendu.</div>
                <div class="tag">C1‚ÄìC6</div>
              </div>
              <div class="levelbtn locked" data-goto="l2" id="btnL2">
                <div class="k">Niveau 2 ‚Äî Analyser</div>
                <div class="d">C2 guid√©e : probl√®me + outil QQOQCP.</div>
                <div class="tag">C2 (pivot) + C1</div>
              </div>
              <div class="levelbtn locked" data-goto="l3" id="btnL3">
                <div class="k">Niveau 3 ‚Äî Relier</div>
                <div class="d">C2 approfondie : cause ‚Üí effet + phrase causale.</div>
                <div class="tag">C2 + C3</div>
              </div>
              <div class="levelbtn locked" data-goto="l4" id="btnL4">
                <div class="k">Niveau 4 ‚Äî Agir</div>
                <div class="d">C4 : choisir et classer des mesures de pr√©vention.</div>
                <div class="tag">C4 + C1</div>
              </div>
              <div class="levelbtn locked" data-goto="l5" id="btnL5">
                <div class="k">Niveau 5 ‚Äî Argumenter</div>
                <div class="d">C5 : choisir + justifier avec connecteurs (clics).</div>
                <div class="tag">C5 + C6</div>
              </div>
              <div class="levelbtn locked" data-goto="final" id="btnFinal">
                <div class="k">Final ‚Äî Passeport</div>
                <div class="d">Profil par comp√©tence + conseils cibl√©s.</div>
                <div class="tag">radar + rem√©diation</div>
              </div>
            </div>

            <details>
              <summary>üìå Rappel express des comp√©tences</summary>
              <div class="bd">
                <div class="note">
                  <b>C1</b> traiter une information (rep√©rer / classer) ‚Ä¢ <b>C2</b> appliquer une d√©marche d‚Äôanalyse (outil) ‚Ä¢
                  <b>C3</b> expliquer / mettre en relation (sens + pr√©vention) ‚Ä¢ <b>C4</b> proposer des solutions ‚Ä¢
                  <b>C5</b> choisir + argumenter avec preuves ‚Ä¢ <b>C6</b> communiquer clairement (bonus qualit√©).
                </div>
              </div>
            </details>

          </div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 1 -->
    <section class="screen" id="screen_l1">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 1 ‚Äî Reconna√Ætre la comp√©tence</div>
              <div class="sub">Clique sur la comp√©tence vis√©e. Tu gagnes aussi un bonus si tu rep√®res l‚Äôindice (verbe + format).</div>
            </div>
            <span class="pill good">C1‚ÄìC6</span>
          </div>
          <div class="bd" id="l1_container"></div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 2 -->
    <section class="screen" id="screen_l2">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 2 ‚Äî C2 guid√©e : analyser avec QQOQCP</div>
              <div class="sub">Tout se fait par clic : choisir, puis remplir les cases en touchant une pastille puis une case.</div>
            </div>
            <span class="pill good">Pivot : C2</span>
          </div>
          <div class="bd">
            <div class="note">
              <b>Mini-situation</b><br><br>
              En atelier, Lina doit poncer des pi√®ces en bois. La machine vibre, il y a du bruit, et la cadence est √©lev√©e.
              Apr√®s 1h, elle a des douleurs au poignet et se sent tendue.
            </div>

            <div class="qbox" id="l2_q1">
              <div class="qtitle">Q1 ‚Äî Formuler le probl√®me (C2)</div>
              <div class="qhint">Choisis la meilleure phrase-probl√®me.</div>
              <div class="choices" data-question="l2_q1"></div>
              <div class="toast" id="toast_l2_q1"></div>
            </div>

            <div class="qbox" id="l2_q2">
              <div class="qtitle">Q2 ‚Äî Compl√©ter QQOQCP (C2)</div>
              <div class="qhint">S√©lectionne une pastille, puis touche la case correspondante. (0 √©criture)</div>

              <div class="chipbank" id="l2_bank"></div>

              <div class="slots" id="l2_slots"></div>

              <div class="mini">Astuce : QQOQCP = organiser la situation avec une m√©thode (C2). C1 peut aider si on ‚Äúrep√®re‚Äù des infos, mais ici l‚Äôobjectif est l‚Äôoutil.</div>

              <div class="toast" id="toast_l2_q2"></div>

              <div class="footerrow">
                <div class="left">
                  <button class="btn ghost" id="l2_reset">R√©initialiser</button>
                </div>
                <div class="right">
                  <button class="btn primary" id="l2_validate">Valider QQOQCP</button>
                </div>
              </div>
            </div>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="l2_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="l2_next">Continuer</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 3 -->
    <section class="screen" id="screen_l3">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 3 ‚Äî Relier causes ‚Üí effets + phrase causale</div>
              <div class="sub">Tu construis une phrase de causalit√© par clic (0 √©criture). C2 (d√©marche) + C3 (sens).</div>
            </div>
            <span class="pill">C2 + C3</span>
          </div>
          <div class="bd">

            <div class="note">
              <b>Mini-doc</b><br><br>
              Une exposition <b>prolong√©e</b> au bruit et √† la vibration augmente la <b>fatigue</b>, la <b>tension</b> et le risque de <b>douleurs musculo-squelettiques</b>.
              La <b>cadence</b> et le manque de pauses peuvent aggraver la situation.
            </div>

            <div class="qbox" id="l3_q1">
              <div class="qtitle">Q1 ‚Äî Choisir la cause principale (C2)</div>
              <div class="qhint">Une cause = un √©l√©ment de la situation qui explique le probl√®me.</div>
              <div class="choices" data-question="l3_q1"></div>
              <div class="toast" id="toast_l3_q1"></div>
            </div>

            <div class="qbox" id="l3_q2">
              <div class="qtitle">Q2 ‚Äî Construire une phrase causale (C2 ‚Üí C3)</div>
              <div class="qhint">Choisis 1 proposition dans chaque case pour obtenir une phrase correcte.</div>

              <div class="chipbank" id="l3_bank"></div>

              <div class="slots" id="l3_slots"></div>

              <div class="toast" id="toast_l3_q2"></div>

              <div class="footerrow">
                <div class="left">
                  <button class="btn ghost" id="l3_reset">R√©initialiser</button>
                </div>
                <div class="right">
                  <button class="btn primary" id="l3_validate">Valider la phrase</button>
                </div>
              </div>
            </div>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="l3_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="l3_next">Continuer</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 4 -->
    <section class="screen" id="screen_l4">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 4 ‚Äî C4 : proposer et classer des mesures</div>
              <div class="sub">Clique une mesure, puis clique l‚Äô√©tape o√π tu la places. (Suppression/R√©duction ‚Üí Collectif ‚Üí Individuel ‚Üí Organisation)</div>
            </div>
            <span class="pill">C4 + C1</span>
          </div>
          <div class="bd">

            <div class="qbox">
              <div class="qtitle">Mesures disponibles</div>
              <div class="qhint">Choisis les mesures les plus pertinentes puis classe-les.</div>
              <div class="chipbank" id="l4_measures"></div>
              <div class="mini">Rappel : C4 = proposer des solutions r√©alistes. Le classement montre la logique de pr√©vention.</div>
            </div>

            <div class="qbox">
              <div class="qtitle">Classement (clic ‚Üí d√©poser)</div>
              <div class="qhint">Touche une colonne pour y d√©poser la mesure s√©lectionn√©e.</div>

              <div class="slots" id="l4_slots"></div>

              <div class="toast" id="toast_l4"></div>

              <div class="footerrow">
                <div class="left">
                  <button class="btn ghost" id="l4_reset">R√©initialiser</button>
                </div>
                <div class="right">
                  <button class="btn primary" id="l4_validate">Valider le classement</button>
                </div>
              </div>
            </div>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="l4_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="l4_next">Continuer</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- NIVEAU 5 -->
    <section class="screen" id="screen_l5">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 5 ‚Äî C5 : choisir + argumenter (clics)</div>
              <div class="sub">Tu choisis un plan, puis tu construis une justification avec connecteurs. (0 √©criture)</div>
            </div>
            <span class="pill warn">C5 + C6</span>
          </div>
          <div class="bd">

            <div class="note">
              <b>Deux plans d‚Äôaction</b><br><br>
              <b>Plan A</b> : r√©duire la vibration √† la source + pause r√©guli√®re + r√©organisation de la cadence.<br>
              <b>Plan B</b> : gants anti-vibration + rappel ‚Äútenir fermement‚Äù + affichage de consignes.
            </div>

            <div class="qbox" id="l5_q1">
              <div class="qtitle">Q1 ‚Äî Choisir le meilleur plan (C5)</div>
              <div class="qhint">C5 = trancher et justifier (pas un avis).</div>
              <div class="choices" data-question="l5_q1"></div>
              <div class="toast" id="toast_l5_q1"></div>
            </div>

            <div class="qbox" id="l5_q2">
              <div class="qtitle">Q2 ‚Äî Construire l‚Äôargumentaire (C5 + C6)</div>
              <div class="qhint">S√©lectionne une pastille, puis touche la case. Objectif : logique lisible + connecteurs.</div>

              <div class="chipbank" id="l5_bank"></div>
              <div class="slots" id="l5_slots"></div>

              <div class="toast" id="toast_l5_q2"></div>

              <div class="footerrow">
                <div class="left">
                  <button class="btn ghost" id="l5_reset">R√©initialiser</button>
                </div>
                <div class="right">
                  <button class="btn primary" id="l5_validate">Valider l‚Äôargument</button>
                </div>
              </div>

              <div class="mini">
                Rappel : un bon C5 = <b>choix</b> + <b>preuves</b> + <b>connecteurs</b>. C6 bonus = phrase compl√®te et claire.
              </div>
            </div>

            <div class="qbox" id="l5_meta">
              <div class="qtitle">Mini-check final (m√©tacognition)</div>
              <div class="qhint">Clique la r√©ponse la plus vraie pour toi.</div>
              <div class="choices" data-question="l5_meta"></div>
              <div class="toast" id="toast_l5_meta"></div>
            </div>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="l5_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="l5_next">Voir mon passeport</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- FINAL -->
    <section class="screen" id="screen_final">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">üèÅ Ton passeport comp√©tences</div>
              <div class="sub">Profil par comp√©tence (mesur√©) + conseils cibl√©s. C1/C6 = indicateurs transversaux.</div>
            </div>
            <span class="pill good">profil</span>
          </div>
          <div class="bd">

            <div class="kpi">
              <div class="box">
                <div class="n" id="kpiStars">0</div>
                <div class="l">√âtoiles</div>
              </div>
              <div class="box">
                <div class="n" id="kpiPct">0%</div>
                <div class="l">Progression</div>
              </div>
              <div class="box">
                <div class="n" id="kpiStrong">‚Äî</div>
                <div class="l">Point fort</div>
              </div>
              <div class="box">
                <div class="n" id="kpiWork">‚Äî</div>
                <div class="l">√Ä travailler</div>
              </div>
            </div>

            <div class="qbox">
              <div class="qtitle">Radar (C2‚ÄìC5) + indicateurs (C1/C6)</div>
              <div class="qhint">Le radar n‚Äôaffiche que des comp√©tences r√©ellement mesur√©es.</div>
              <div id="radarWrap"></div>
            </div>

            <div class="qbox">
              <div class="qtitle">Conseils cibl√©s</div>
              <div class="qhint">Deux priorit√©s maximum pour progresser vite.</div>
              <div class="note" id="adviceBox"></div>
            </div>

            <details>
              <summary>üßë‚Äçüè´ Corrig√© prof (√† masquer si besoin)</summary>
              <div class="bd">
                <div class="note" id="teacherKey"></div>
              </div>
            </details>

            <div class="footerrow">
              <div class="left">
                <button class="btn ghost" id="final_back">Retour</button>
              </div>
              <div class="right">
                <button class="btn primary" id="final_restart">Recommencer</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

  </div>

<script>
/* =========================
   DONN√âES P√âDAGOGIQUES
========================= */

const MODULE = {
  code: "C11",
  titre: "Analyse d‚Äôune situation de travail",
  niveau: "CAP / Bac Pro",
  objectif: "√ätre capable d‚Äôanalyser une situation-probl√®me avec une m√©thode, puis proposer et justifier des mesures de pr√©vention.",
  seuils: { l1: 60, l2: 60, l3: 60, l4: 60, l5: 60 }
};

// Comp√©tences (libell√©s stricts)
const COMP = {
  C1: "Traiter une information",
  C2: "Appliquer une d√©marche d‚Äôanalyse",
  C3: "Expliquer / mettre en relation",
  C4: "Proposer une solution",
  C5: "Argumenter un choix",
  C6: "Communiquer clairement"
};

// Bar√®me par comp√©tence (mesur√©)
const MAX = { C1: 6, C2: 18, C3: 10, C4: 10, C5: 12, C6: 6 };

// State
const LSKEY = "passeport_c11_clicks_only_v1";
let state = loadState();

/* =========================
   UTILITAIRES
========================= */

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function pct(a,b){ return b<=0 ? 0 : Math.round((a/b)*100); }

function loadState(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw){
      const s = JSON.parse(raw);
      return normalizeState(s);
    }
  }catch(e){}
  return normalizeState({
    unlocked: 1,
    stars: 0,
    screen: "home",
    score: { C1:0, C2:0, C3:0, C4:0, C5:0, C6:0 },
    done: {},
    answers: {}
  });
}

function normalizeState(s){
  s.unlocked = clamp(Number(s.unlocked||1),1,6);
  s.stars = clamp(Number(s.stars||0),0,999);
  s.screen = s.screen || "home";
  s.score = s.score || {};
  s.done = s.done || {};
  s.answers = s.answers || {};
  for(const k of Object.keys(MAX)){
    s.score[k] = clamp(Number(s.score[k]||0),0,MAX[k]);
  }
  return s;
}

function saveState(){
  try{ localStorage.setItem(LSKEY, JSON.stringify(state)); }catch(e){}
  renderTop();
}

function resetAll(){
  localStorage.removeItem(LSKEY);
  state = loadState();
  go("home");
}

function totalScore(){
  let a=0,b=0;
  for(const k of Object.keys(MAX)){ a+=state.score[k]; b+=MAX[k]; }
  return {a,b};
}

function globalProgress(){
  const {a,b} = totalScore();
  return pct(a,b);
}

function addScore(key, pts){
  state.score[key] = clamp(state.score[key] + pts, 0, MAX[key]);
}

function setDone(id, val=true){
  state.done[id] = !!val;
}

function isDone(id){ return !!state.done[id]; }

function unlock(level){
  state.unlocked = Math.max(state.unlocked, level);
}

function levelUnlocked(level){
  return state.unlocked >= level;
}

function starForPerfect(levelId){
  if(isDone("star_"+levelId)) return;
  state.stars += 1;
  setDone("star_"+levelId, true);
}

/* =========================
   NAVIGATION
========================= */

const screens = ["home","l1","l2","l3","l4","l5","final"];

function go(name){
  for(const s of screens){
    document.getElementById("screen_"+s).classList.toggle("active", s===name);
  }
  state.screen = name;
  saveState();
  if(name==="final") renderFinal();
}

document.getElementById("btnHome").addEventListener("click", ()=>go("home"));
document.getElementById("btnScore").addEventListener("click", ()=>{
  if(levelUnlocked(6)) go("final"); else go("home");
});
document.getElementById("btnReset").addEventListener("click", resetAll);

// Home level buttons
document.querySelectorAll(".levelbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const t = btn.getAttribute("data-goto");
    if(!t) return;
    const map = { l1:1, l2:2, l3:3, l4:4, l5:5, final:6 };
    const need = map[t];
    if(need>state.unlocked) return;
    go(t);
  });
});

/* =========================
   TOP RENDER
========================= */

function renderTop(){
  // lock buttons
  const locks = [
    {id:"btnL2", lvl:2},
    {id:"btnL3", lvl:3},
    {id:"btnL4", lvl:4},
    {id:"btnL5", lvl:5},
    {id:"btnFinal", lvl:6}
  ];
  locks.forEach(x=>{
    const el = document.getElementById(x.id);
    if(!el) return;
    el.classList.toggle("locked", !levelUnlocked(x.lvl));
  });

  // global bar
  const gp = globalProgress();
  document.getElementById("globalBar").style.width = gp+"%";
  document.getElementById("globalPct").textContent = gp+"%";
  document.getElementById("globalStars").textContent = state.stars;
  document.getElementById("unlockedLbl").textContent = String(state.unlocked);

  // final unlocked?
  if(levelUnlocked(6)){
    document.getElementById("btnFinal").classList.remove("locked");
  }
}

renderTop();

/* =========================
   COMPOSANTS UI
========================= */

function toast(elId, ok, title, msg){
  const el = document.getElementById(elId);
  el.className = "toast show " + (ok ? "good" : "bad");
  el.innerHTML = `<div class="t">${title}</div><div class="m">${msg}</div>`;
}

function clearToast(elId){
  const el = document.getElementById(elId);
  el.className = "toast";
  el.innerHTML = "";
}

function mkChoice(container, items, onPick){
  container.innerHTML = "";
  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.innerHTML = `<div><b>${it.t}</b></div><div class="s">${it.s||""}</div>`;
    div.addEventListener("click", ()=>{
      [...container.querySelectorAll(".choice")].forEach(c=>c.classList.remove("sel"));
      div.classList.add("sel");
      onPick(it);
    });
    container.appendChild(div);
  });
}

function mkChipBank(container, chips, onPick){
  container.innerHTML = "";
  chips.forEach(ch=>{
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = ch;
    c.addEventListener("click", ()=>{
      [...container.querySelectorAll(".chip")].forEach(x=>x.classList.remove("sel"));
      c.classList.add("sel");
      onPick(ch);
    });
    container.appendChild(c);
  });
}

function mkSlots(container, slots, onClickSlot){
  container.innerHTML = "";
  slots.forEach(s=>{
    const row = document.createElement("div");
    row.className = "slotrow";
    row.innerHTML = `
      <div class="slotlabel">${s.label}</div>
      <div class="slot" tabindex="0" data-key="${s.key}">${s.value||"‚Äî"}</div>
    `;
    const sl = row.querySelector(".slot");
    if(s.value) sl.classList.add("filled");
    sl.addEventListener("click", ()=>onClickSlot(s.key, sl));
    container.appendChild(row);
  });
}

/* =========================
   NIVEAU 1 : Radar de consignes (clic)
========================= */

const L1 = [
  {
    id:"l1_1",
    consigne:"D‚Äôapr√®s le document A, relever 3 facteurs et les classer en cat√©gories.",
    answer:"C1",
    indice:"Verbes relever/classer + tableau/liste."
  },
  {
    id:"l1_2",
    consigne:"Compl√©ter un QQOQCP √† partir de la situation pour organiser l‚Äôanalyse.",
    answer:"C2",
    indice:"Outil/m√©thode d‚Äôanalyse."
  },
  {
    id:"l1_3",
    consigne:"Expliquer le lien entre exposition et cons√©quences, puis relier √† une pr√©vention.",
    answer:"C3",
    indice:"M√©canisme/liaison pr√©vention."
  },
  {
    id:"l1_4",
    consigne:"Proposer 3 mesures adapt√©es √† la situation et les hi√©rarchiser.",
    answer:"C4",
    indice:"Actions concr√®tes + hi√©rarchie."
  },
  {
    id:"l1_5",
    consigne:"Choisir entre deux plans d‚Äôaction et justifier avec 2 arguments et des connecteurs.",
    answer:"C5",
    indice:"Trancher + preuves + connecteurs."
  },
  {
    id:"l1_6",
    consigne:"R√©diger en phrases compl√®tes, avec vocabulaire pr√©cis et connecteurs.",
    answer:"C6",
    indice:"Qualit√© de communication."
  }
];

function renderL1(){
  const wrap = document.getElementById("l1_container");
  wrap.innerHTML = "";

  const note = document.createElement("div");
  note.className = "note";
  note.innerHTML = `<b>But</b> : apprendre √† lire la consigne comme un correcteur. Clique la comp√©tence.`;
  wrap.appendChild(note);

  L1.forEach(item=>{
    const box = document.createElement("div");
    box.className = "qbox";
    box.innerHTML = `
      <div class="qtitle">${item.consigne}</div>
      <div class="qhint">Choisis : C1 / C2 / C3 / C4 / C5 / C6</div>
      <div class="chipbank" id="${item.id}_chips"></div>
      <div class="toast" id="toast_${item.id}"></div>
    `;
    wrap.appendChild(box);

    const chips = ["C1","C2","C3","C4","C5","C6"].map(c => `${c}`);
    const bank = box.querySelector("#"+item.id+"_chips");
    mkChipBank(bank, chips, (picked)=>{
      state.answers[item.id] = picked;
      if(picked === item.answer){
        clearToast("toast_"+item.id);
        toast("toast_"+item.id, true, "‚úÖ Correct", "Indice : " + item.indice);
        if(!isDone(item.id)){
          // score : 2 pts pour la comp√©tence + 1 bonus C6 (lecture consigne)
          addScore(item.answer, 2);
          addScore("C6", 1);
          setDone(item.id, true);
          saveState();
        }
      }else{
        clearToast("toast_"+item.id);
        toast("toast_"+item.id, false, "‚õî Pas encore", "Indice : " + item.indice);
        saveState();
      }
      // unlock logic
      const doneCount = L1.filter(x=>isDone(x.id)).length;
      if(doneCount >= 5){
        unlock(2);
        saveState();
      }
    });
  });

  const foot = document.createElement("div");
  foot.className = "footerrow";
  foot.innerHTML = `
    <div class="left"><button class="btn ghost" id="l1_back">Retour</button></div>
    <div class="right"><button class="btn primary" id="l1_next">Continuer</button></div>
  `;
  wrap.appendChild(foot);
  document.getElementById("l1_back").addEventListener("click", ()=>go("home"));
  document.getElementById("l1_next").addEventListener("click", ()=>{
    if(levelUnlocked(2)) go("l2");
    else go("home");
  });
}

renderL1();

/* =========================
   NIVEAU 2
========================= */

// Q1 choix phrase-probl√®me
const L2_Q1_CHOICES = [
  { id:"a", t:"La situation pr√©sente des facteurs (bruit, vibration, cadence) qui provoquent fatigue et douleurs.", s:"Phrase-probl√®me claire." },
  { id:"b", t:"Lina n‚Äôaime pas son travail.", s:"Avis, pas une analyse." },
  { id:"c", t:"Le bois est un mat√©riau.", s:"Hors sujet." },
  { id:"d", t:"Il faut acheter des gants.", s:"Solution, pas probl√®me." },
];
const L2_Q1_OK = "a";

const l2Q1Wrap = document.querySelector('#l2_q1 .choices');
mkChoice(l2Q1Wrap, L2_Q1_CHOICES, (it)=>{
  state.answers.l2_q1 = it.id;
  if(it.id===L2_Q1_OK){
    toast("toast_l2_q1", true, "‚úÖ Correct (C2)", "Tu formules le probl√®me avant les solutions.");
    if(!isDone("l2_q1")){
      addScore("C2", 4);
      addScore("C6", 1);
      setDone("l2_q1", true);
      saveState();
    }
  }else{
    toast("toast_l2_q1", false, "‚õî Pas encore", "C2 = analyser : d‚Äôabord formuler le probl√®me, ensuite seulement proposer.");
    saveState();
  }
});

// QQOQCP
const L2_BANK = [
  "En atelier",
  "Poncer des pi√®ces",
  "Cadence √©lev√©e",
  "Bruit + vibration",
  "Apr√®s 1h",
  "Douleurs poignet",
  "Tension / stress"
];

const L2_SLOTS_DEF = [
  { key:"qui", label:"Qui ?", ok:["Lina"] , fixed:"Lina"},
  { key:"quoi", label:"Quoi ?", ok:["Poncer des pi√®ces"], },
  { key:"ou", label:"O√π ?", ok:["En atelier"], },
  { key:"quand", label:"Quand ?", ok:["Apr√®s 1h"], },
  { key:"comment", label:"Comment ?", ok:["Cadence √©lev√©e","Bruit + vibration"], multi:true },
  { key:"pourquoi", label:"Pourquoi ?", ok:["Douleurs poignet","Tension / stress"], multi:true }
];

let l2SelectedChip = null;
function renderL2(){
  // bank
  mkChipBank(document.getElementById("l2_bank"), L2_BANK, (ch)=>{ l2SelectedChip = ch; });

  // slots with saved answers
  const saved = state.answers.l2_slots || {};
  const slots = L2_SLOTS_DEF.map(s=>{
    let val = saved[s.key];
    if(s.fixed) val = s.fixed;
    const show = Array.isArray(val) ? (val.length? val.join(" ‚Ä¢ ") : "‚Äî") : (val || "‚Äî");
    return { label:s.label, key:s.key, value: show==="‚Äî" ? "" : show };
  });

  mkSlots(document.getElementById("l2_slots"), slots, (key, el)=>{
    if(!l2SelectedChip) return;
    if(key==="qui"){ return; } // fixed
    const def = L2_SLOTS_DEF.find(x=>x.key===key);
    const saved2 = state.answers.l2_slots || {};
    if(def.multi){
      let arr = Array.isArray(saved2[key]) ? saved2[key] : [];
      if(!arr.includes(l2SelectedChip)) arr.push(l2SelectedChip);
      saved2[key] = arr;
    }else{
      saved2[key] = l2SelectedChip;
    }
    state.answers.l2_slots = saved2;
    clearToast("toast_l2_q2");
    saveState();
    renderL2(); // quick rerender
  });

  // style filled
  [...document.querySelectorAll("#l2_slots .slot")].forEach(sl=>{
    const t = sl.textContent.trim();
    if(t && t!=="‚Äî") sl.classList.add("filled");
  });
}

renderL2();

document.getElementById("l2_reset").addEventListener("click", ()=>{
  state.answers.l2_slots = {};
  l2SelectedChip = null;
  clearToast("toast_l2_q2");
  saveState();
  renderL2();
});

document.getElementById("l2_validate").addEventListener("click", ()=>{
  const saved = state.answers.l2_slots || {};
  let ok=0, total=0;

  L2_SLOTS_DEF.forEach(def=>{
    if(def.fixed) return;
    total++;
    if(def.multi){
      const arr = Array.isArray(saved[def.key]) ? saved[def.key] : [];
      const hit = def.ok.some(v=>arr.includes(v));
      if(hit) ok++;
    }else{
      if(def.ok.includes(saved[def.key])) ok++;
    }
  });

  const p = Math.round((ok/total)*100);
  if(p>=70){
    toast("toast_l2_q2", true, "‚úÖ Valid√© (C2)", `Bien : outil rempli (${p}%).`);
    if(!isDone("l2_q2")){
      addScore("C2", 6);
      addScore("C1", 2); // rep√©rage infos (appui)
      addScore("C6", 1);
      setDone("l2_q2", true);
      unlock(3);
      saveState();
      starForPerfect("l2");
    }
  }else{
    toast("toast_l2_q2", false, "‚õî √Ä am√©liorer", `QQOQCP incomplet (${p}%). Astuce : ‚ÄúComment‚Äù = conditions (cadence/bruit/vibration) ; ‚ÄúPourquoi‚Äù = effets (douleurs/tension).`);
    saveState();
  }
});

document.getElementById("l2_back").addEventListener("click", ()=>go("home"));
document.getElementById("l2_next").addEventListener("click", ()=>{
  if(levelUnlocked(3)) go("l3"); else go("home");
});

/* =========================
   NIVEAU 3
========================= */

const L3_Q1_CHOICES = [
  { id:"a", t:"Bruit + vibration + cadence (exposition)", s:"Cause principale probable." },
  { id:"b", t:"La couleur des pi√®ces", s:"Hors analyse." },
  { id:"c", t:"La m√©t√©o", s:"Hors situation." },
  { id:"d", t:"Le fait d‚Äôavoir des gants", s:"C‚Äôest une mesure, pas une cause." },
];
const L3_Q1_OK = "a";

mkChoice(document.querySelector('#l3_q1 .choices'), L3_Q1_CHOICES, (it)=>{
  state.answers.l3_q1 = it.id;
  if(it.id===L3_Q1_OK){
    toast("toast_l3_q1", true, "‚úÖ Correct (C2)", "Tu identifies une cause li√©e √† l‚Äôexposition (situation r√©elle).");
    if(!isDone("l3_q1")){
      addScore("C2", 4);
      addScore("C6", 1);
      setDone("l3_q1", true);
      saveState();
    }
  }else{
    toast("toast_l3_q1", false, "‚õî Pas encore", "C2 = chercher ce qui explique le probl√®me dans la situation.");
    saveState();
  }
});

// Phrase causale : 3 slots
const L3_BANK = [
  "Parce que l‚Äôexposition est prolong√©e",
  "Parce que la cadence est √©lev√©e",
  "Parce que la vibration est importante",
  "alors la fatigue augmente",
  "alors la tension augmente",
  "ce qui entra√Æne des douleurs",
  "ce qui augmente le risque"
];

const L3_SLOTS = [
  { key:"s1", label:"D√©but", ok:["Parce que l‚Äôexposition est prolong√©e","Parce que la cadence est √©lev√©e","Parce que la vibration est importante"] },
  { key:"s2", label:"Cons√©quence", ok:["alors la fatigue augmente","alors la tension augmente"] },
  { key:"s3", label:"Effet", ok:["ce qui entra√Æne des douleurs","ce qui augmente le risque"] }
];

let l3Selected = null;
function renderL3(){
  mkChipBank(document.getElementById("l3_bank"), L3_BANK, (ch)=>{ l3Selected = ch; });
  const saved = state.answers.l3_slots || {};
  const slots = L3_SLOTS.map(s=>{
    const val = saved[s.key] || "";
    return { label:s.label, key:s.key, value: val };
  });
  mkSlots(document.getElementById("l3_slots"), slots, (key, el)=>{
    if(!l3Selected) return;
    const saved2 = state.answers.l3_slots || {};
    saved2[key] = l3Selected;
    state.answers.l3_slots = saved2;
    clearToast("toast_l3_q2");
    saveState();
    renderL3();
  });
  [...document.querySelectorAll("#l3_slots .slot")].forEach(sl=>{
    const t = sl.textContent.trim();
    if(t && t!=="‚Äî") sl.classList.add("filled");
  });
}
renderL3();

document.getElementById("l3_reset").addEventListener("click", ()=>{
  state.answers.l3_slots = {};
  l3Selected = null;
  clearToast("toast_l3_q2");
  saveState();
  renderL3();
});

document.getElementById("l3_validate").addEventListener("click", ()=>{
  const saved = state.answers.l3_slots || {};
  let ok = 0;
  for(const s of L3_SLOTS){
    if(s.ok.includes(saved[s.key])) ok++;
  }
  const p = Math.round((ok/3)*100);
  if(p>=100){
    toast("toast_l3_q2", true, "‚úÖ Valid√© (C2‚ÜíC3)", "Phrase compl√®te et logique. Tu relies cause ‚Üí cons√©quence ‚Üí effet.");
    if(!isDone("l3_q2")){
      addScore("C2", 4);
      addScore("C3", 4);
      addScore("C6", 1);
      setDone("l3_q2", true);
      unlock(4);
      saveState();
      starForPerfect("l3");
    }
  }else{
    toast("toast_l3_q2", false, "‚õî √Ä am√©liorer", "Astuce : commence par ‚ÄúParce que‚Ä¶‚Äù, puis ‚Äúalors‚Ä¶‚Äù, puis ‚Äúce qui‚Ä¶‚Äù.");
    saveState();
  }
});

document.getElementById("l3_back").addEventListener("click", ()=>go("home"));
document.getElementById("l3_next").addEventListener("click", ()=>{
  if(levelUnlocked(4)) go("l4"); else go("home");
});

/* =========================
   NIVEAU 4 : Mesures (clic d√©poser)
========================= */

const L4_MEASURES = [
  "R√©duire la vibration √† la source",
  "Installer une protection collective (isolation)",
  "Mettre des pauses r√©guli√®res",
  "R√©organiser la cadence",
  "Gants anti-vibration",
  "Rappel consignes affich√©es",
  "Former au bon geste"
];

const L4_COLS = [
  { key:"col1", label:"Suppression / R√©duction", ok:["R√©duire la vibration √† la source"] },
  { key:"col2", label:"Protection collective", ok:["Installer une protection collective (isolation)"] },
  { key:"col3", label:"Organisation", ok:["Mettre des pauses r√©guli√®res","R√©organiser la cadence"] },
  { key:"col4", label:"Individuel / Info", ok:["Gants anti-vibration","Former au bon geste","Rappel consignes affich√©es"] }
];

let l4Selected = null;

function renderL4(){
  mkChipBank(document.getElementById("l4_measures"), L4_MEASURES, (ch)=>{ l4Selected = ch; });

  const saved = state.answers.l4_cols || {};
  const slots = L4_COLS.map(c=>{
    const arr = Array.isArray(saved[c.key]) ? saved[c.key] : [];
    return { label:c.label, key:c.key, value: arr.length ? arr.join(" ‚Ä¢ ") : "" };
  });

  mkSlots(document.getElementById("l4_slots"), slots, (key)=>{
    if(!l4Selected) return;
    const saved2 = state.answers.l4_cols || {};
    let arr = Array.isArray(saved2[key]) ? saved2[key] : [];
    if(!arr.includes(l4Selected)) arr.push(l4Selected);
    saved2[key] = arr;
    state.answers.l4_cols = saved2;
    clearToast("toast_l4");
    saveState();
    renderL4();
  });

  [...document.querySelectorAll("#l4_slots .slot")].forEach(sl=>{
    const t = sl.textContent.trim();
    if(t && t!=="‚Äî") sl.classList.add("filled");
  });
}
renderL4();

document.getElementById("l4_reset").addEventListener("click", ()=>{
  state.answers.l4_cols = {};
  l4Selected = null;
  clearToast("toast_l4");
  saveState();
  renderL4();
});

document.getElementById("l4_validate").addEventListener("click", ()=>{
  const saved = state.answers.l4_cols || {};
  let points = 0;

  // points for having at least 3 measures total
  const totalChosen = Object.values(saved).reduce((acc, arr)=> acc + (Array.isArray(arr)?arr.length:0), 0);
  if(totalChosen >= 3) points += 2;

  // points for correct classification hits
  let hits = 0;
  L4_COLS.forEach(c=>{
    const arr = Array.isArray(saved[c.key]) ? saved[c.key] : [];
    c.ok.forEach(v=>{
      if(arr.includes(v)) hits++;
    });
  });
  points += clamp(hits*2, 0, 6);

  const ok = points >= 6;
  if(ok){
    toast("toast_l4", true, "‚úÖ Valid√© (C4)", "Mesures pertinentes et logique de pr√©vention visible.");
    if(!isDone("l4")){
      addScore("C4", 8);
      addScore("C1", 2);
      addScore("C6", 1);
      setDone("l4", true);
      unlock(5);
      saveState();
      starForPerfect("l4");
    }
  }else{
    toast("toast_l4", false, "‚õî √Ä am√©liorer", "Astuce : privil√©gier r√©duction √† la source et organisation avant l‚Äôindividuel.");
    saveState();
  }
});

document.getElementById("l4_back").addEventListener("click", ()=>go("home"));
document.getElementById("l4_next").addEventListener("click", ()=>{
  if(levelUnlocked(5)) go("l5"); else go("home");
});

/* =========================
   NIVEAU 5 : Argumentation (clics)
========================= */

const L5_Q1_CHOICES = [
  { id:"a", t:"Plan A", s:"Agit sur la source + organisation." },
  { id:"b", t:"Plan B", s:"Surtout individuel / info." },
];
const L5_Q1_OK = "a";

mkChoice(document.querySelector('#l5_q1 .choices'), L5_Q1_CHOICES, (it)=>{
  state.answers.l5_q1 = it.id;
  if(it.id===L5_Q1_OK){
    toast("toast_l5_q1", true, "‚úÖ Correct (C5)", "Tu privil√©gies une action plus efficace (source + organisation).");
    if(!isDone("l5_q1")){
      addScore("C5", 4);
      addScore("C6", 1);
      setDone("l5_q1", true);
      saveState();
    }
  }else{
    toast("toast_l5_q1", false, "‚õî Pas encore", "C5 : on choisit l‚Äôoption la plus efficace selon des crit√®res (pas une pr√©f√©rence).");
    saveState();
  }
});

// Argument builder
const L5_BANK = [
  "Je choisis le plan A",
  "car il r√©duit la vibration √† la source",
  "de plus il ajuste la cadence",
  "donc il diminue fatigue et douleurs",
  "cependant les gants restent utiles en compl√©ment",
  "Je choisis le plan B",
  "car il prot√®ge individuellement",
  "de plus il rappelle les consignes",
  "donc il limite une partie du risque"
];

const L5_SLOTS = [
  { key:"a1", label:"Choix", ok:["Je choisis le plan A","Je choisis le plan B"] },
  { key:"a2", label:"Argument 1", ok:["car il r√©duit la vibration √† la source","car il prot√®ge individuellement"] },
  { key:"a3", label:"Argument 2", ok:["de plus il ajuste la cadence","de plus il rappelle les consignes"] },
  { key:"a4", label:"Conclusion", ok:["donc il diminue fatigue et douleurs","donc il limite une partie du risque"] },
  { key:"a5", label:"Nuance", ok:["cependant les gants restent utiles en compl√©ment"] }
];

let l5Selected = null;

function renderL5(){
  mkChipBank(document.getElementById("l5_bank"), L5_BANK, (ch)=>{ l5Selected = ch; });
  const saved = state.answers.l5_slots || {};
  const slots = L5_SLOTS.map(s=>({ label:s.label, key:s.key, value: saved[s.key] || "" }));
  mkSlots(document.getElementById("l5_slots"), slots, (key)=>{
    if(!l5Selected) return;
    const saved2 = state.answers.l5_slots || {};
    saved2[key] = l5Selected;
    state.answers.l5_slots = saved2;
    clearToast("toast_l5_q2");
    saveState();
    renderL5();
  });
  [...document.querySelectorAll("#l5_slots .slot")].forEach(sl=>{
    const t = sl.textContent.trim();
    if(t && t!=="‚Äî") sl.classList.add("filled");
  });
}
renderL5();

document.getElementById("l5_reset").addEventListener("click", ()=>{
  state.answers.l5_slots = {};
  l5Selected = null;
  clearToast("toast_l5_q2");
  saveState();
  renderL5();
});

document.getElementById("l5_validate").addEventListener("click", ()=>{
  const saved = state.answers.l5_slots || {};
  const pickedPlan = state.answers.l5_q1;
  if(!pickedPlan){
    toast("toast_l5_q2", false, "‚õî √âtape 1", "Choisis d‚Äôabord un plan (Q1).");
    return;
  }

  // expected alignment
  const expectA = (pickedPlan===L5_Q1_OK);
  const choiceText = saved.a1 || "";
  const arg1 = saved.a2 || "";
  const arg2 = saved.a3 || "";
  const concl = saved.a4 || "";
  const nuance = saved.a5 || "";

  let points = 0;

  // structure points
  if(choiceText) points += 1;
  if(arg1) points += 2;
  if(arg2) points += 2;
  if(concl) points += 2;
  if(nuance) points += 1; // bonus nuance

  // connector bonus (C6)
  const hasConnectors = /car|donc|de plus|cependant/i.test([choiceText,arg1,arg2,concl,nuance].join(" "));
  if(hasConnectors) points += 2;

  // coherence: plan chosen matches first slot
  const coherent = expectA ? (choiceText==="Je choisis le plan A") : (choiceText==="Je choisis le plan B");
  if(coherent) points += 2;

  const ok = points >= 9;

  if(ok){
    toast("toast_l5_q2", true, "‚úÖ Valid√© (C5 + C6)", "Argumentaire structur√© : choix + arguments + conclusion + connecteurs.");
    if(!isDone("l5_q2")){
      addScore("C5", 8);
      addScore("C6", 2);
      setDone("l5_q2", true);
      unlock(6);
      saveState();
      starForPerfect("l5");
    }
  }else{
    toast("toast_l5_q2", false, "‚õî √Ä am√©liorer", "Astuce : 1 choix + 2 arguments + 1 conclusion, avec car / de plus / donc.");
    saveState();
  }
});

// meta quiz
const L5_META_CHOICES = [
  { id:"a", t:"Je confonds encore expliquer (C3) et argumenter (C5).", s:"On va te conseiller C3/C5." },
  { id:"b", t:"Je reconnais bien les comp√©tences mais j‚Äôai du mal avec les outils (C2).", s:"On va te conseiller C2." },
  { id:"c", t:"Je sais proposer des mesures (C4) mais je les classe mal.", s:"On va te conseiller C4." },
  { id:"d", t:"Je me sens √† l‚Äôaise : je vois ce qu‚Äôon attend.", s:"Bravo." },
];

mkChoice(document.querySelector('#l5_meta .choices'), L5_META_CHOICES, (it)=>{
  state.answers.l5_meta = it.id;
  toast("toast_l5_meta", true, "‚úÖ Not√©", "Merci. Cela servira au conseil final.");
  if(!isDone("l5_meta")){
    addScore("C6", 1);
    setDone("l5_meta", true);
    saveState();
  }
});

document.getElementById("l5_back").addEventListener("click", ()=>go("home"));
document.getElementById("l5_next").addEventListener("click", ()=>{
  if(levelUnlocked(6)) go("final"); else go("home");
});

/* =========================
   FINAL : radar + conseils + corrig√©
========================= */

function radarSVG(values){
  // values: {C1..C6} 0..100
  const axes = ["C2","C3","C4","C5","C1","C6"]; // show in that order
  const cx=170, cy=170, R=135;
  const steps = [20,40,60,80,100];

  function pt(i, val){
    const ang = (-90 + i*(360/axes.length)) * Math.PI/180;
    const r = (R * val)/100;
    return { x: cx + r*Math.cos(ang), y: cy + r*Math.sin(ang) };
  }

  let grid = "";
  steps.forEach(s=>{
    const pts = axes.map((a,i)=>pt(i,s));
    const d = pts.map((p,i)=> (i===0?`M ${p.x.toFixed(1)} ${p.y.toFixed(1)}`:`L ${p.x.toFixed(1)} ${p.y.toFixed(1)}`)).join(" ") + " Z";
    grid += `<path d="${d}" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="1" />`;
  });

  // axes lines + labels
  let lines = "";
  axes.forEach((a,i)=>{
    const p = pt(i,100);
    const p2 = pt(i,0);
    lines += `<line x1="${p2.x}" y1="${p2.y}" x2="${p.x}" y2="${p.y}" stroke="rgba(255,255,255,.18)" />`;
    const lab = pt(i,112);
    lines += `<text x="${lab.x}" y="${lab.y}" fill="rgba(255,255,255,.92)" font-size="12" font-weight="900" text-anchor="middle" dominant-baseline="middle">${a}</text>`;
  });

  const polyPts = axes.map((a,i)=>pt(i, values[a]||0));
  const dPoly = polyPts.map((p,i)=> `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(" ");

  return `
    <svg viewBox="0 0 340 340" width="100%" style="max-width:520px; display:block; margin: 0 auto;">
      ${grid}
      ${lines}
      <polygon points="${dPoly}" fill="rgba(46,229,157,.22)" stroke="rgba(46,229,157,.65)" stroke-width="2"></polygon>
      <circle cx="${cx}" cy="${cy}" r="3.5" fill="rgba(255,255,255,.75)"></circle>
    </svg>
  `;
}

function topAndBottomCompetence(){
  const keys = ["C2","C3","C4","C5"]; // main
  const ratios = keys.map(k=>({k, v: pct(state.score[k], MAX[k])}));
  ratios.sort((a,b)=>b.v-a.v);
  return { strong: ratios[0].k, work: ratios[ratios.length-1].k };
}

function adviceText(){
  const {strong, work} = topAndBottomCompetence();
  const meta = state.answers.l5_meta;

  const tips = {
    C2: "Priorit√© C2 : entra√Æne-toi √† remplir un outil (QQOQCP/5M) puis √† √©crire une phrase-probl√®me. Objectif : analyser avant de proposer.",
    C3: "Priorit√© C3 : explique avec une structure en 3 √©tapes (cause ‚Üí m√©canisme/r√®gle ‚Üí lien pr√©vention). Objectif : donner du sens, pas r√©citer.",
    C4: "Priorit√© C4 : propose 3‚Äì4 mesures r√©alistes et classe-les (r√©duction √† la source / collectif / organisation / individuel). Objectif : agir efficacement.",
    C5: "Priorit√© C5 : choisis et justifie avec 2 arguments + connecteurs (car, de plus, donc). Objectif : preuves, pas opinion."
  };

  let extra = "";
  if(meta==="a") extra = "Tu as signal√© une confusion C3/C5 : rappelle-toi que C3 = expliquer, C5 = choisir + d√©fendre.";
  if(meta==="b") extra = "Tu as signal√© une difficult√© C2 : utilise toujours un outil (QQOQCP/5M) avant les solutions.";
  if(meta==="c") extra = "Tu as signal√© une difficult√© de classement : pense ‚Äúsource/collectif/organisation/individuel‚Äù.";
  if(meta==="d") extra = "Continue : vise une r√©ponse toujours claire (C6) avec connecteurs et vocabulaire pr√©cis.";

  return `
    <b>Point fort</b> : ${strong} ‚Äî ${COMP[strong]}<br>
    <b>√Ä travailler</b> : ${work} ‚Äî ${COMP[work]}<br><br>
    ${tips[work] || ""}<br><br>
    ${extra}
    <hr style="border:none; border-top:1px solid rgba(255,255,255,.14); margin:10px 0;">
    <b>Rappel</b> : C1 et C6 sont transversales. C1 aide √† rep√©rer/classer. C6 = clart√© + connecteurs + vocabulaire.
  `;
}

function teacherKeyText(){
  return `
    <b>Niveau 1</b><br>
    1) C1 ‚Ä¢ 2) C2 ‚Ä¢ 3) C3 ‚Ä¢ 4) C4 ‚Ä¢ 5) C5 ‚Ä¢ 6) C6<br><br>

    <b>Niveau 2</b><br>
    Q1 : phrase-probl√®me = option A.<br>
    QQOQCP : Quoi = poncer des pi√®ces ‚Ä¢ O√π = en atelier ‚Ä¢ Quand = apr√®s 1h ‚Ä¢ Comment = cadence √©lev√©e / bruit+vibration ‚Ä¢ Pourquoi = douleurs poignet / tension.<br><br>

    <b>Niveau 3</b><br>
    Cause principale : exposition (bruit/vibration/cadence).<br>
    Phrase : ‚ÄúParce que ‚Ä¶, alors ‚Ä¶, ce qui ‚Ä¶‚Äù (3 segments).<br><br>

    <b>Niveau 4</b><br>
    Exemple de logique : r√©duire √† la source + organisation (pauses/cadence) avant individuel (gants).<br><br>

    <b>Niveau 5</b><br>
    Choix attendu : Plan A (source + organisation).<br>
    Argumentaire attendu : choix + 2 arguments + conclusion, avec connecteurs (car, de plus, donc) + nuance possible (cependant).
  `;
}

function renderFinal(){
  const gp = globalProgress();
  document.getElementById("kpiStars").textContent = state.stars;
  document.getElementById("kpiPct").textContent = gp+"%";
  const {strong, work} = topAndBottomCompetence();
  document.getElementById("kpiStrong").textContent = strong;
  document.getElementById("kpiWork").textContent = work;

  // values in percent
  const values = {};
  for(const k of Object.keys(MAX)){
    values[k] = pct(state.score[k], MAX[k]);
  }

  document.getElementById("radarWrap").innerHTML = radarSVG(values);
  document.getElementById("adviceBox").innerHTML = adviceText();
  document.getElementById("teacherKey").innerHTML = teacherKeyText();
}

document.getElementById("final_back").addEventListener("click", ()=>go("home"));
document.getElementById("final_restart").addEventListener("click", resetAll);

/* =========================
   D√âBLOCAGE AUTO (si reprise)
========================= */

function autoUnlock(){
  // l1 unlock if enough done
  const l1done = L1.filter(x=>isDone(x.id)).length;
  if(l1done>=5) unlock(2);

  // l2 unlock if q2 done
  if(isDone("l2_q2")) unlock(3);
  if(isDone("l3_q2")) unlock(4);
  if(isDone("l4")) unlock(5);
  if(isDone("l5_q2")) unlock(6);
}
autoUnlock();
renderTop();

// restore last screen if valid
if(screens.includes(state.screen) && levelUnlocked({home:1,l1:1,l2:2,l3:3,l4:4,l5:5,final:6}[state.screen]||1)){
  go(state.screen);
}else{
  go("home");
}
</script>
</body>
</html>
