<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéñÔ∏è Passeport Comp√©tences ‚Äî C11 (Mobile ‚Ä¢ Clicks Only ‚Ä¢ Clair)</title>
  <style>
    :root{
      --bg1:#f7f9ff; --bg2:#eef3ff;
      --card: rgba(255,255,255,.95);
      --card2: rgba(255,255,255,.84);
      --stroke: rgba(20,30,55,.12);
      --stroke2: rgba(20,30,55,.10);
      --text:#172033;
      --muted: rgba(23,32,51,.72);
      --shadow: 0 14px 40px rgba(22,32,60,.12);
      --shadow2: 0 10px 30px rgba(22,32,60,.10);
      --good:#1bbf7a; --warn:#f4b400; --bad:#e53957; --blue:#325aff;
      --radius: 18px;
    }
    *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    html,body{ height:100%; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      color: var(--text);
      font-size: 19px;
      padding: 14px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }
    #passeportApp{ max-width: 980px; margin: 0 auto; padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
    #passeportApp .screen{ display:none !important; }
    #passeportApp .screen.active{ display:block !important; }

    .topbar{
      position: sticky; top: 10px; z-index: 50;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:36px; height:36px; border-radius: 10px;
      background: rgba(23,32,51,.06);
      border:1px solid var(--stroke2);
      display:grid; place-items:center;
      font-weight: 900;
    }
    .brand .t1{ font-weight: 950; letter-spacing:.2px; line-height:1.1; font-size: 14px; }
    .brand .t2{ font-size:12px; color: var(--muted); margin-top:2px; }
    .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      border:none; outline:none; cursor:pointer;
      background: rgba(23,32,51,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 850;
      border: 1px solid var(--stroke);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{ background: rgba(50,90,255,.14); border-color: rgba(50,90,255,.24); }
    .btn.ghost{ background: transparent; border-color: rgba(20,30,55,.12); color: rgba(23,32,51,.88); }
    .btn.small{ padding:8px 10px; font-size:12px; }

    .grid{ margin-top: 14px; display:grid; gap: 14px; }
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(20,30,55,.10);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .card .title{ font-weight: 950; font-size: 16px; letter-spacing:.2px; }
    .card .sub{ margin-top:4px; font-size: 13px; color: var(--muted); line-height: 1.35; }
    .card .bd{ padding: 14px; }

    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .pill{
      padding: 6px 10px; border-radius: 999px;
      background: rgba(23,32,51,.06);
      border: 1px solid rgba(20,30,55,.10);
      font-size: 12px; color: rgba(23,32,51,.90);
      user-select:none; font-weight: 850;
    }
    .pill.good{ background: rgba(27,191,122,.12); border-color: rgba(27,191,122,.26); }
    .pill.warn{ background: rgba(244,180,0,.14); border-color: rgba(244,180,0,.28); }
    .pill.bad{  background: rgba(229,57,87,.12); border-color: rgba(229,57,87,.26); }
    .pill.blue{ background: rgba(50,90,255,.12); border-color: rgba(50,90,255,.24); }

    .note{
      background: rgba(23,32,51,.04);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 16px;
      padding: 12px;
      color: rgba(23,32,51,.95);
      font-size: 14px;
      line-height: 1.45;
    }
    .note b{ font-weight: 950; }

    .progress{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 10px;
    }
    .bar{
      flex: 1 1 240px;
      height: 10px;
      border-radius: 999px;
      background: rgba(23,32,51,.06);
      border: 1px solid rgba(20,30,55,.10);
      overflow:hidden;
      min-width: 180px;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(27,191,122,.95), rgba(244,180,0,.95));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .tiny{ font-size: 13px; color: var(--muted); }

    .levelnav{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .levelbtn{
      flex: 1 1 160px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(23,32,51,.04);
      border: 1px solid rgba(20,30,55,.12);
      color: rgba(23,32,51,.92);
      cursor:pointer;
      text-align:left;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .levelbtn:active{ transform: scale(.99); }
    .levelbtn.locked{ opacity:.55; cursor:not-allowed; }
    .levelbtn .k{ font-weight: 950; }
    .levelbtn .d{ margin-top:4px; font-size:13px; color: var(--muted); }
    .levelbtn .tag{
      display:inline-block; margin-top:8px; font-size:11px; padding:4px 8px; border-radius:999px;
      background: rgba(23,32,51,.06); border: 1px solid rgba(20,30,55,.10);
      font-weight: 850;
    }

    .qbox{
      background: var(--card2);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .qtitle{ font-weight: 950; font-size: 16px; }
    .qhint{ margin-top:4px; font-size: 13px; color: var(--muted); line-height: 1.35; }

    .chipbank{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .chip{
      padding: 12px 10px;
      border-radius: 14px;
      background: rgba(23,32,51,.06);
      border: 1px solid rgba(20,30,55,.12);
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      font-size: 14px;
      text-align:center;
    }
    .chip:active{ transform: scale(.99); }
    .chip.sel{
      outline: 2px solid rgba(50,90,255,.22);
      background: rgba(50,90,255,.12);
    }

    .choices{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .choice{
      flex: 1 1 220px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(20,30,55,.12);
      background: rgba(23,32,51,.04);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      min-width: 160px;
    }
    .choice:active{ transform: scale(.99); }
    .choice.sel{
      background: rgba(50,90,255,.12);
      border-color: rgba(50,90,255,.28);
      box-shadow: 0 10px 26px rgba(22,32,60,.12);
    }
    .choice .s{ font-size: 13px; color: var(--muted); margin-top: 4px; line-height: 1.3; }

    .slots{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .slotrow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background: rgba(23,32,51,.04);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 16px;
      padding: 12px;
    }
    .slotlabel{ font-size: 13px; color: var(--muted); min-width: 92px; font-weight: 900; }
    .slot{
      flex: 1 1 180px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px dashed rgba(20,30,55,.18);
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      min-height: 42px;
      display:flex; align-items:center;
    }
    .slot.filled{
      border-style: solid;
      background: rgba(27,191,122,.12);
      border-color: rgba(27,191,122,.24);
    }

    .toast{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(20,30,55,.12);
      background: rgba(23,32,51,.04);
      display:none;
      font-size: 14px;
      line-height: 1.4;
    }
    .toast.show{ display:block; }
    .toast.good{ border-color: rgba(27,191,122,.22); background: rgba(27,191,122,.10); }
    .toast.bad{ border-color: rgba(229,57,87,.22); background: rgba(229,57,87,.10); }
    .toast .t{ font-weight: 950; }
    .toast .m{ margin-top: 6px; color: rgba(23,32,51,.92); }

    .footerrow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top: 12px;
    }
    .footerrow .left{ display:flex; gap:8px; flex-wrap:wrap; }
    .footerrow .right{ display:flex; gap:8px; flex-wrap:wrap; }

    details{ border-top: 1px solid rgba(20,30,55,.10); margin-top: 10px; }
    summary{
      cursor:pointer; list-style:none;
      padding: 12px 14px;
      font-weight: 950;
      user-select:none;
      color: rgba(23,32,51,.92);
    }
    summary::-webkit-details-marker{ display:none; }

    .kpi{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .kpi .box{
      background: rgba(23,32,51,.04);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .box .n{ font-weight: 1000; font-size: 22px; }
    .kpi .box .l{ font-size: 13px; color: var(--muted); margin-top: 2px; }

    @media (min-width: 860px){
      .slots{ grid-template-columns: 1fr 1fr; }
      .kpi{ grid-template-columns: repeat(4, minmax(0,1fr)); }
      .chipbank{ grid-template-columns: repeat(6, minmax(0,1fr)); }
    }

    .modalBack{
      position:fixed; inset:0; z-index: 200;
      background: rgba(10,15,30,.24);
      display:none;
      align-items:flex-end;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .modalBack.show{ display:flex; }
    .modal{
      width:100%;
      max-width: 980px;
      margin:0 auto;
      background: rgba(255,255,255,.98);
      border: 1px solid rgba(20,30,55,.12);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(22,32,60,.16);
      overflow:hidden;
    }
    .modalHd{
      padding: 12px 14px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom: 1px solid rgba(20,30,55,.10);
    }
    .modalHd .ttl{ font-weight: 950; }
    .modalBd{ padding: 14px; font-size: 14px; line-height: 1.45; color: rgba(23,32,51,.95); }
    .muted{ color: var(--muted); }
  </style>
</head>

<body>
  <div id="passeportApp">

    <div class="topbar">
      <div class="brand">
        <div class="logo">üéñÔ∏è</div>
        <div>
          <div class="t1">Passeport Comp√©tences ‚Äî C11</div>
          <div class="t2">Analyse d‚Äôune situation de travail ‚Ä¢ mobile ‚Ä¢ clicks only</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost small" id="btnHome">Accueil</button>
        <button class="btn ghost small" id="btnScore">Mon profil</button>
        <button class="btn ghost small" id="btnDocs">Docs</button>
        <button class="btn ghost small" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="modalBack" id="docModalBack" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modalHd">
          <div class="ttl" id="docModalTitle">Mini-doc</div>
          <button class="btn small" id="docClose">Fermer</button>
        </div>
        <div class="modalBd" id="docModalBody"></div>
      </div>
    </div>

    <section class="screen active" id="screen_home">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">üéØ Module C11 ‚Äî Passeport Comp√©tences</div>
              <div class="sub">Objectif : r√©ussir en comprenant la comp√©tence derri√®re la question.</div>
              <div class="pillrow">
                <span class="pill good">Pivot : C2</span>
                <span class="pill">Fr√©quent : C3</span>
                <span class="pill">Action : C4</span>
                <span class="pill warn">Exigeant : C5</span>
                <span class="pill">Transversal : C1</span>
                <span class="pill">Transversal : C6</span>
              </div>
            </div>
            <span class="pill blue">‚≠ê √©toiles</span>
          </div>

          <div class="bd">
            <div class="note">
              <b>Objectif du module</b><br><br>
              √ätre capable de <b>analyser une situation-probl√®me</b> (avec une m√©thode), puis <b>proposer</b> et <b>justifier</b> des mesures de pr√©vention.<br><br>
              <b>R√®gle du jeu</b> : tu n‚Äôas pas le cours. Tu as des <b>mini-docs</b> (donn√©es) et des <b>indices</b> (aide).<br>
              <b>√âcriture</b> : 0 (ou 1‚Äì2 mots max si demand√©).
            </div>

            <div class="progress">
              <div class="bar"><i id="globalBar"></i></div>
              <div class="tiny"><span id="globalPct">0%</span> ‚Ä¢ <span id="globalStars">0</span> ‚≠ê ‚Ä¢ Niveau d√©bloqu√© : <span id="unlockedLbl">1</span></div>
            </div>

            <div class="levelnav">
              <div class="levelbtn" data-goto="l1">
                <div class="k">Niveau 1 ‚Äî Reconna√Ætre</div>
                <div class="d">Lire une consigne et identifier la comp√©tence.</div>
                <div class="tag">Indices</div>
              </div>
              <div class="levelbtn locked" data-goto="l2" id="btnL2">
                <div class="k">Niveau 2 ‚Äî Analyser</div>
                <div class="d">C2 guid√©e : probl√®me + outil QQOQCP.</div>
                <div class="tag">Mini-docs</div>
              </div>
              <div class="levelbtn locked" data-goto="l3" id="btnL3">
                <div class="k">Niveau 3 ‚Äî Relier</div>
                <div class="d">Cause ‚Üí effet + phrase causale.</div>
                <div class="tag">Mini-docs</div>
              </div>
              <div class="levelbtn locked" data-goto="l4" id="btnL4">
                <div class="k">Niveau 4 ‚Äî Agir</div>
                <div class="d">Proposer + hi√©rarchiser des mesures (C4).</div>
                <div class="tag">Banque</div>
              </div>
              <div class="levelbtn locked" data-goto="l5" id="btnL5">
                <div class="k">Niveau 5 ‚Äî Argumenter</div>
                <div class="d">Choisir + justifier (C5).</div>
                <div class="tag">Connecteurs</div>
              </div>
              <div class="levelbtn locked" data-goto="final" id="btnFinal">
                <div class="k">Final ‚Äî Passeport</div>
                <div class="d">Profil par comp√©tence + conseils.</div>
                <div class="tag">profil</div>
              </div>
            </div>

            <details>
              <summary>üìå Rep√®res (tr√®s simple)</summary>
              <div class="bd">
                <div class="note">
                  <b>C1</b> rep√©rer/classer ‚Ä¢ <b>C2</b> outil d‚Äôanalyse ‚Ä¢ <b>C3</b> expliquer/relier √† pr√©vention ‚Ä¢
                  <b>C4</b> proposer/hi√©rarchiser ‚Ä¢ <b>C5</b> choisir + justifier avec preuves ‚Ä¢ <b>C6</b> phrases claires.
                </div>
              </div>
            </details>

          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="screen_l1">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 1 ‚Äî Reconna√Ætre la comp√©tence</div>
              <div class="sub">Ici, tu ne fais pas la t√¢che. Tu identifies la comp√©tence vis√©e.</div>
              <div class="pillrow">
                <span class="pill blue">Indices</span>
                <span class="pill">Clics uniquement</span>
              </div>
            </div>
            <span class="pill good">C1‚ÄìC6</span>
          </div>
          <div class="bd" id="l1_container"></div>
        </div>
      </div>
    </section>

    <section class="screen" id="screen_l2">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 2 ‚Äî Analyser avec QQOQCP</div>
              <div class="sub">Tu utilises une m√©thode : probl√®me ‚Üí QQOQCP. Tout par clic.</div>
            </div>
            <span class="pill good">Pivot : C2</span>
          </div>
          <div class="bd">

            <div class="note">
              <b>Mini-doc S ‚Äî Situation</b><br><br>
              En atelier, Lina doit poncer des pi√®ces. La machine vibre et il y a du bruit. La cadence est √©lev√©e et elle encha√Æne sans vraie pause.
              Apr√®s 1h, elle ressent une douleur au poignet et une tension g√©n√©rale.<br><br>
              <button class="btn small" id="openDocS">Voir mini-doc S</button>
            </div>

            <div class="qbox" id="l2_q1">
              <div class="qtitle">Q1 ‚Äî Formuler le probl√®me (C2)</div>
              <div class="qhint">Tu d√©cris le probl√®me avec des facteurs + des effets (sans solution).</div>
              <div class="choices" data-question="l2_q1"></div>
              <div class="toast" id="toast_l2_q1"></div>
            </div>

            <div class="qbox" id="l2_q2">
              <div class="qtitle">Q2 ‚Äî Compl√©ter QQOQCP (C2)</div>
              <div class="qhint">1) clique une pastille  2) clique une case  3) valider</div>

              <div class="chipbank" id="l2_bank"></div>
              <div class="slots" id="l2_slots"></div>

              <div class="toast" id="toast_l2_q2"></div>

              <div class="footerrow">
                <div class="left"><button class="btn ghost" id="l2_reset">R√©initialiser</button></div>
                <div class="right"><button class="btn primary" id="l2_validate">Valider QQOQCP</button></div>
              </div>

              <details>
                <summary>Indice (si tu bloques)</summary>
                <div class="bd">
                  <div class="note">
                    <b>Comment</b> = conditions d‚Äôexposition (bruit, vibration, cadence, pauses).<br>
                    <b>Pourquoi</b> = effets observ√©s (douleurs, tension).
                  </div>
                </div>
              </details>
            </div>

            <div class="footerrow">
              <div class="left"><button class="btn ghost" id="l2_back">Retour</button></div>
              <div class="right"><button class="btn primary" id="l2_next">Continuer</button></div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="screen_l3">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 3 ‚Äî Relier cause ‚Üí effet</div>
              <div class="sub">Tu construis une phrase logique (cause ‚Üí cons√©quence ‚Üí effet).</div>
            </div>
            <span class="pill blue">C2 + C3</span>
          </div>
          <div class="bd">

            <div class="note">
              <b>Mini-doc E ‚Äî Effets d‚Äôexposition</b><br><br>
              Une exposition prolong√©e au bruit et aux vibrations augmente la fatigue et la tension.
              La cadence √©lev√©e et le manque de pauses aggravent. Cela peut conduire √† des douleurs et √† un risque accru.<br><br>
              <button class="btn small" id="openDocE">Voir mini-doc E</button>
            </div>

            <div class="qbox" id="l3_q1">
              <div class="qtitle">Q1 ‚Äî Choisir une cause principale (C2)</div>
              <div class="qhint">Une cause = ce qui explique le probl√®me dans la situation.</div>
              <div class="choices" data-question="l3_q1"></div>
              <div class="toast" id="toast_l3_q1"></div>
            </div>

            <div class="qbox" id="l3_q2">
              <div class="qtitle">Q2 ‚Äî Construire la phrase causale (C2 ‚Üí C3)</div>
              <div class="qhint">Remplis 3 cases : Parce que‚Ä¶ / alors‚Ä¶ / ce qui‚Ä¶</div>

              <div class="chipbank" id="l3_bank"></div>
              <div class="slots" id="l3_slots"></div>

              <div class="toast" id="toast_l3_q2"></div>

              <div class="footerrow">
                <div class="left"><button class="btn ghost" id="l3_reset">R√©initialiser</button></div>
                <div class="right"><button class="btn primary" id="l3_validate">Valider la phrase</button></div>
              </div>

              <details>
                <summary>Indice (mod√®le)</summary>
                <div class="bd">
                  <div class="note"><b>Parce que</b> (cause) ‚Üí <b>alors</b> (cons√©quence) ‚Üí <b>ce qui</b> (effet/risque).</div>
                </div>
              </details>
            </div>

            <div class="footerrow">
              <div class="left"><button class="btn ghost" id="l3_back">Retour</button></div>
              <div class="right"><button class="btn primary" id="l3_next">Continuer</button></div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="screen_l4">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 4 ‚Äî Agir : proposer et hi√©rarchiser (C4)</div>
              <div class="sub">Tu choisis 3 mesures, puis tu les places en priorit√© 1 ‚Üí 3.</div>
            </div>
            <span class="pill blue">C4</span>
          </div>
          <div class="bd">

            <div class="note">
              <b>R√®gle</b> : priorit√© = d‚Äôabord <b>source</b> / <b>organisation</b>, puis <b>collectif</b>, puis <b>individuel</b> (en compl√©ment).<br><br>
              <button class="btn small" id="openDocM">Voir mini-doc M</button>
            </div>

            <div class="qbox">
              <div class="qtitle">Banque de mesures (clique)</div>
              <div class="qhint">Clique une mesure (s√©lection), puis clique un emplacement (1, 2 ou 3).</div>
              <div class="chipbank" id="l4_measures"></div>
            </div>

            <div class="qbox">
              <div class="qtitle">Tes 3 priorit√©s (hi√©rarchiser)</div>
              <div class="qhint">Objectif : remplir 1 ‚Üí 3 avec 3 mesures coh√©rentes.</div>
              <div class="slots" id="l4_slots"></div>
              <div class="toast" id="toast_l4"></div>

              <div class="footerrow">
                <div class="left"><button class="btn ghost" id="l4_reset">R√©initialiser</button></div>
                <div class="right"><button class="btn primary" id="l4_validate">Valider</button></div>
              </div>

              <details>
                <summary>Indice (tr√®s simple)</summary>
                <div class="bd">
                  <div class="note">
                    <b>Priorit√© 1</b> : agir sur le danger / l‚Äôorganisation.<br>
                    <b>Priorit√© 2</b> : r√©duire l‚Äôexposition pour tous.<br>
                    <b>Priorit√© 3</b> : compl√©ter (EPI / formation).
                  </div>
                </div>
              </details>
            </div>

            <div class="footerrow">
              <div class="left"><button class="btn ghost" id="l4_back">Retour</button></div>
              <div class="right"><button class="btn primary" id="l4_next">Continuer</button></div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="screen_l5">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Niveau 5 ‚Äî Argumenter (C5) + clart√© (C6)</div>
              <div class="sub">Tu choisis un plan, puis tu construis une justification avec connecteurs.</div>
            </div>
            <span class="pill warn">C5 + C6</span>
          </div>
          <div class="bd">

            <div class="note">
              <b>Deux plans</b><br><br>
              <b>Plan A</b> : r√©duire √† la source + pauses + r√©organisation cadence.<br>
              <b>Plan B</b> : gants + affichage consignes + rappel geste.<br><br>
              <span class="muted">C5 = choisir selon des crit√®res, puis justifier (ce n‚Äôest pas un avis).</span>
            </div>

            <div class="qbox" id="l5_q1">
              <div class="qtitle">Q1 ‚Äî Choisir le meilleur plan (C5)</div>
              <div class="qhint">Choisir = annoncer clairement le plan retenu.</div>
              <div class="choices" data-question="l5_q1"></div>
              <div class="toast" id="toast_l5_q1"></div>
            </div>

            <div class="qbox" id="l5_q2">
              <div class="qtitle">Q2 ‚Äî Construire l‚Äôargumentaire (C5 + C6)</div>
              <div class="qhint">Remplis : Choix + car + de plus + donc (+ bonus cependant)</div>

              <div class="chipbank" id="l5_bank"></div>
              <div class="slots" id="l5_slots"></div>

              <div class="toast" id="toast_l5_q2"></div>

              <div class="footerrow">
                <div class="left"><button class="btn ghost" id="l5_reset">R√©initialiser</button></div>
                <div class="right"><button class="btn primary" id="l5_validate">Valider</button></div>
              </div>

              <details>
                <summary>Indice (connecteurs)</summary>
                <div class="bd">
                  <div class="note">
                    Exemple : <b>Je choisis‚Ä¶</b> <b>car‚Ä¶</b> <b>de plus‚Ä¶</b> <b>donc‚Ä¶</b><br>
                    Bonus : <b>cependant‚Ä¶</b> (nuance).
                  </div>
                </div>
              </details>
            </div>

            <div class="footerrow">
              <div class="left"><button class="btn ghost" id="l5_back">Retour</button></div>
              <div class="right"><button class="btn primary" id="l5_next">Voir mon passeport</button></div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="screen_final">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">üèÅ Ton passeport comp√©tences</div>
              <div class="sub">Profil + conseils. C1/C6 = transversaux (indicateurs).</div>
            </div>
            <span class="pill good">profil</span>
          </div>
          <div class="bd">

            <div class="kpi">
              <div class="box"><div class="n" id="kpiStars">0</div><div class="l">√âtoiles</div></div>
              <div class="box"><div class="n" id="kpiPct">0%</div><div class="l">Progression</div></div>
              <div class="box"><div class="n" id="kpiStrong">‚Äî</div><div class="l">Point fort</div></div>
              <div class="box"><div class="n" id="kpiWork">‚Äî</div><div class="l">√Ä travailler</div></div>
            </div>

            <div class="qbox">
              <div class="qtitle">Radar (C2‚ÄìC5) + indicateurs (C1/C6)</div>
              <div class="qhint">Mesure = ce qui a √©t√© r√©ellement travaill√©.</div>
              <div id="radarWrap"></div>
            </div>

            <div class="qbox">
              <div class="qtitle">Conseils cibl√©s</div>
              <div class="qhint">Deux priorit√©s maximum.</div>
              <div class="note" id="adviceBox"></div>
            </div>

            <details>
              <summary>üßë‚Äçüè´ Corrig√©</summary>
              <div class="bd"><div class="note" id="teacherKey"></div></div>
            </details>

            <div class="footerrow">
              <div class="left"><button class="btn ghost" id="final_back">Retour</button></div>
              <div class="right"><button class="btn primary" id="final_restart">Recommencer</button></div>
            </div>

          </div>
        </div>
      </div>
    </section>

  </div>

<script>
const COMP = {
  C1: "Traiter une information",
  C2: "Appliquer une d√©marche d‚Äôanalyse",
  C3: "Expliquer / mettre en relation",
  C4: "Proposer une solution",
  C5: "Argumenter un choix",
  C6: "Communiquer clairement"
};
const MAX = { C1: 6, C2: 18, C3: 10, C4: 12, C5: 12, C6: 6 };
const LSKEY = "passeport_c11_v4_clair_coherent";

let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw) return normalizeState(JSON.parse(raw));
  }catch(e){}
  return normalizeState({
    unlocked: 1,
    stars: 0,
    screen: "home",
    score: { C1:0, C2:0, C3:0, C4:0, C5:0, C6:0 },
    done: {},
    answers: {}
  });
}
function normalizeState(s){
  s.unlocked = clamp(Number(s.unlocked||1),1,6);
  s.stars = clamp(Number(s.stars||0),0,999);
  s.screen = s.screen || "home";
  s.score = s.score || {};
  s.done = s.done || {};
  s.answers = s.answers || {};
  for(const k of Object.keys(MAX)) s.score[k] = clamp(Number(s.score[k]||0),0,MAX[k]);
  return s;
}
function saveState(){ try{ localStorage.setItem(LSKEY, JSON.stringify(state)); }catch(e){} renderTop(); }
function resetAll(){ localStorage.removeItem(LSKEY); state = loadState(); go("home"); }

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function pct(a,b){ return b<=0 ? 0 : Math.round((a/b)*100); }
function totalScore(){ let a=0,b=0; for(const k of Object.keys(MAX)){ a+=state.score[k]; b+=MAX[k]; } return {a,b}; }
function globalProgress(){ const {a,b}=totalScore(); return pct(a,b); }
function addScore(key, pts){ state.score[key] = clamp(state.score[key] + pts, 0, MAX[key]); }
function setDone(id, val=true){ state.done[id] = !!val; }
function isDone(id){ return !!state.done[id]; }
function unlock(level){ state.unlocked = Math.max(state.unlocked, level); }
function levelUnlocked(level){ return state.unlocked >= level; }
function starOnce(levelId){ if(isDone("star_"+levelId)) return; state.stars += 1; setDone("star_"+levelId, true); }

const screens = ["home","l1","l2","l3","l4","l5","final"];
function go(name){
  for(const s of screens){
    document.getElementById("screen_"+s).classList.toggle("active", s===name);
  }
  state.screen = name;
  saveState();
  if(name==="final") renderFinal();
  window.scrollTo({top:0, behavior:"smooth"});
}
function explainLock(need){
  const map = {
    2: "Pour d√©bloquer le niveau 2 : r√©ussir au moins 5 items du niveau 1.",
    3: "Pour d√©bloquer le niveau 3 : valider le QQOQCP (niveau 2).",
    4: "Pour d√©bloquer le niveau 4 : valider la phrase causale (niveau 3).",
    5: "Pour d√©bloquer le niveau 5 : valider l‚Äôordonnancement des mesures (niveau 4).",
    6: "Pour voir ton passeport : valider l‚Äôargumentaire (niveau 5)."
  };
  alert(map[need] || "Niveau verrouill√©.");
}

document.getElementById("btnHome").addEventListener("click", ()=>go("home"));
document.getElementById("btnScore").addEventListener("click", ()=>{ if(levelUnlocked(6)) go("final"); else explainLock(6); });
document.getElementById("btnReset").addEventListener("click", resetAll);

document.querySelectorAll(".levelbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const t = btn.getAttribute("data-goto");
    const map = { l1:1, l2:2, l3:3, l4:4, l5:5, final:6 };
    const need = map[t] || 1;
    if(levelUnlocked(need)) go(t); else explainLock(need);
  });
});

const docBack = document.getElementById("docModalBack");
const docTitle = document.getElementById("docModalTitle");
const docBody = document.getElementById("docModalBody");
function openDoc(title, body){
  docTitle.textContent = title;
  docBody.innerHTML = body;
  docBack.classList.add("show");
}
function closeDoc(){ docBack.classList.remove("show"); }
document.getElementById("docClose").addEventListener("click", closeDoc);
docBack.addEventListener("click", (e)=>{ if(e.target===docBack) closeDoc(); });

document.getElementById("btnDocs").addEventListener("click", ()=>{
  openDoc("Aide ‚Äî Comment jouer", `
    <b>Niveau 1</b> : tu reconnais la comp√©tence (indices).<br>
    <b>Niveaux 2‚Äì5</b> : tu fais vraiment la t√¢che (mini-docs + banque).<br><br>
    <span class="muted">Astuce : rep√®re le verbe de la consigne.</span>
  `);
});

function toastRemed(elId, ok, title, why, how){
  const el = document.getElementById(elId);
  el.className = "toast show " + (ok ? "good" : "bad");
  el.innerHTML = ok
    ? `<div class="t">${title}</div><div class="m">${why}</div>`
    : `<div class="t">${title}</div><div class="m"><b>Pourquoi</b> : ${why}<br><br><b>Pour r√©ussir</b> : ${how}</div>`;
}
function clearToast(elId){ const el = document.getElementById(elId); el.className = "toast"; el.innerHTML = ""; }

function mkChoice(container, items, onPick){
  container.innerHTML = "";
  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.innerHTML = `<div><b>${it.t}</b></div><div class="s">${it.s||""}</div>`;
    div.addEventListener("click", ()=>{
      [...container.querySelectorAll(".choice")].forEach(c=>c.classList.remove("sel"));
      div.classList.add("sel");
      onPick(it);
    });
    container.appendChild(div);
  });
}
function mkChipBank(container, chips, onPick){
  container.innerHTML = "";
  chips.forEach(ch=>{
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = ch;
    c.addEventListener("click", ()=>{
      [...container.querySelectorAll(".chip")].forEach(x=>x.classList.remove("sel"));
      c.classList.add("sel");
      onPick(ch);
    });
    container.appendChild(c);
  });
}
function mkSlots(container, slots, onClickSlot){
  container.innerHTML = "";
  slots.forEach(s=>{
    const row = document.createElement("div");
    row.className = "slotrow";
    row.innerHTML = `
      <div class="slotlabel">${s.label}</div>
      <div class="slot" data-key="${s.key}">${s.value||"‚Äî"}</div>
    `;
    const sl = row.querySelector(".slot");
    if(s.value) sl.classList.add("filled");
    sl.addEventListener("click", ()=>onClickSlot(s.key, sl));
    container.appendChild(row);
  });
}

function renderTop(){
  const locks = [
    {id:"btnL2", lvl:2},
    {id:"btnL3", lvl:3},
    {id:"btnL4", lvl:4},
    {id:"btnL5", lvl:5},
    {id:"btnFinal", lvl:6}
  ];
  locks.forEach(x=>{
    const el = document.getElementById(x.id);
    if(!el) return;
    el.classList.toggle("locked", !levelUnlocked(x.lvl));
  });
  const gp = globalProgress();
  document.getElementById("globalBar").style.width = gp+"%";
  document.getElementById("globalPct").textContent = gp+"%";
  document.getElementById("globalStars").textContent = state.stars;
  document.getElementById("unlockedLbl").textContent = String(state.unlocked);
}
renderTop();

const L1 = [
  { id:"l1_1", consigne:"Relever 3 facteurs et les classer en cat√©gories.", answer:"C1", indice:"Verbes relever/classer + format tableau/liste = C1." },
  { id:"l1_2", consigne:"Compl√©ter un QQOQCP pour organiser une analyse.", answer:"C2", indice:"Outil/m√©thode d‚Äôanalyse = C2." },
  { id:"l1_3", consigne:"Expliquer le lien entre exposition et cons√©quences, puis relier √† une pr√©vention.", answer:"C3", indice:"M√©canisme + lien pr√©vention = C3." },
  { id:"l1_4", consigne:"Proposer 3 mesures adapt√©es et les hi√©rarchiser.", answer:"C4", indice:"Actions concr√®tes + hi√©rarchie = C4." },
  { id:"l1_5", consigne:"Choisir entre 2 plans et justifier avec des connecteurs.", answer:"C5", indice:"Choix + justification structur√©e (car, donc, de plus) = C5." },
  { id:"l1_6", consigne:"R√©diger en phrases claires, avec vocabulaire pr√©cis.", answer:"C6", indice:"Qualit√© d‚Äôexpression = C6." }
];

function renderL1(){
  const wrap = document.getElementById("l1_container");
  wrap.innerHTML = "";
  const intro = document.createElement("div");
  intro.className = "note";
  intro.innerHTML = "<b>But</b> : lire la consigne comme un correcteur. Ici, tu ne fais pas la t√¢che : tu reconnais la comp√©tence.";
  wrap.appendChild(intro);

  L1.forEach(item=>{
    const box = document.createElement("div");
    box.className = "qbox";
    box.innerHTML = `
      <div class="qtitle">Identifier la comp√©tence vis√©e</div>
      <div class="qhint"><b>Consigne</b> : ${item.consigne}</div>
      <div class="chipbank" id="${item.id}_chips"></div>
      <div class="toast" id="toast_${item.id}"></div>
    `;
    wrap.appendChild(box);

    const bank = box.querySelector("#"+item.id+"_chips");
    mkChipBank(bank, ["C1","C2","C3","C4","C5","C6"], (picked)=>{
      state.answers[item.id] = picked;

      if(picked === item.answer){
        toastRemed("toast_"+item.id, true, "‚úÖ Correct", "Indice : " + item.indice, "");
        if(!isDone(item.id)){
          addScore(item.answer, 2);
          addScore("C6", 1);
          setDone(item.id, true);
          saveState();
        }
      }else{
        toastRemed("toast_"+item.id, false, "‚õî Pas encore", "Tu as choisi " + picked + " mais l‚Äôaction demand√©e ne correspond pas.", item.indice);
        saveState();
      }

      const doneCount = L1.filter(x=>isDone(x.id)).length;
      if(doneCount >= 5){ unlock(2); saveState(); }
    });

    const prev = state.answers[item.id];
    if(prev){
      [...bank.querySelectorAll(".chip")].forEach(c=>{
        if(c.textContent.trim()===prev) c.classList.add("sel");
      });
    }
  });

  const foot = document.createElement("div");
  foot.className = "footerrow";
  foot.innerHTML = `
    <div class="left"><button class="btn ghost" id="l1_back">Retour</button></div>
    <div class="right"><button class="btn primary" id="l1_next">Continuer</button></div>
  `;
  wrap.appendChild(foot);

  document.getElementById("l1_back").addEventListener("click", ()=>go("home"));
  document.getElementById("l1_next").addEventListener("click", ()=>{ if(levelUnlocked(2)) go("l2"); else explainLock(2); });
}
renderL1();

document.getElementById("openDocS").addEventListener("click", ()=>{
  openDoc("Mini-doc S ‚Äî Situation", `
    <b>Contexte</b> : atelier, pon√ßage de pi√®ces.<br>
    <b>Exposition</b> : bruit + vibration + cadence √©lev√©e + peu de pauses.<br>
    <b>Effets</b> : douleurs poignet + tension apr√®s 1h.<br><br>
    <span class="muted">Objectif : organiser avec QQOQCP (C2).</span>
  `);
});

mkChoice(document.querySelector('#l2_q1 .choices'), [
  { id:"a", t:"La situation pr√©sente bruit/vibration/cadence qui entra√Ænent douleur et tension.", s:"Phrase-probl√®me (ok)." },
  { id:"b", t:"Il faut acheter des gants.", s:"Solution (trop t√¥t)." },
  { id:"c", t:"Lina n‚Äôaime pas son travail.", s:"Avis (pas analyse)." },
  { id:"d", t:"Le bois est un mat√©riau.", s:"Hors sujet." },
], (it)=>{
  state.answers.l2_q1 = it.id;
  if(it.id==="a"){
    toastRemed("toast_l2_q1", true, "‚úÖ Correct (C2)", "Tu poses le probl√®me avant les solutions.", "");
    if(!isDone("l2_q1")){ addScore("C2", 4); addScore("C6", 1); setDone("l2_q1", true); saveState(); }
  }else{
    toastRemed("toast_l2_q1", false, "‚õî √Ä corriger", "Ce n‚Äôest pas une formulation de probl√®me.", "D√©cris facteurs + effets (sans proposer).");
    saveState();
  }
});

const L2_BANK = ["En atelier","Poncer des pi√®ces","Cadence √©lev√©e","Bruit + vibration","Peu de pauses","Apr√®s 1h","Douleurs poignet","Tension"];
const L2_SLOTS_DEF = [
  { key:"qui", label:"Qui ?", fixed:"Lina" },
  { key:"quoi", label:"Quoi ?", ok:["Poncer des pi√®ces"] },
  { key:"ou", label:"O√π ?", ok:["En atelier"] },
  { key:"quand", label:"Quand ?", ok:["Apr√®s 1h"] },
  { key:"comment", label:"Comment ?", ok:["Cadence √©lev√©e","Bruit + vibration","Peu de pauses"], multi:true },
  { key:"pourquoi", label:"Pourquoi ?", ok:["Douleurs poignet","Tension"], multi:true }
];
let l2SelectedChip = null;

function renderL2(){
  mkChipBank(document.getElementById("l2_bank"), L2_BANK, (ch)=>{ l2SelectedChip = ch; });
  const saved = state.answers.l2_slots || {};
  const slots = L2_SLOTS_DEF.map(s=>{
    let val = saved[s.key];
    if(s.fixed) val = s.fixed;
    const show = Array.isArray(val) ? (val.length ? val.join(" ‚Ä¢ ") : "") : (val || "");
    return { label:s.label, key:s.key, value: show };
  });
  mkSlots(document.getElementById("l2_slots"), slots, (key)=>{
    if(key==="qui") return;
    if(!l2SelectedChip) return;
    const def = L2_SLOTS_DEF.find(x=>x.key===key);
    const saved2 = state.answers.l2_slots || {};
    if(def.multi){
      let arr = Array.isArray(saved2[key]) ? saved2[key] : [];
      if(!arr.includes(l2SelectedChip)) arr.push(l2SelectedChip);
      saved2[key] = arr;
    }else{
      saved2[key] = l2SelectedChip;
    }
    state.answers.l2_slots = saved2;
    clearToast("toast_l2_q2");
    saveState();
    renderL2();
  });
}
renderL2();

document.getElementById("l2_reset").addEventListener("click", ()=>{
  state.answers.l2_slots = {};
  l2SelectedChip = null;
  clearToast("toast_l2_q2");
  saveState();
  renderL2();
});
document.getElementById("l2_validate").addEventListener("click", ()=>{
  const saved = state.answers.l2_slots || {};
  let ok=0, total=0;
  L2_SLOTS_DEF.forEach(def=>{
    if(def.fixed) return;
    total++;
    if(def.multi){
      const arr = Array.isArray(saved[def.key]) ? saved[def.key] : [];
      const hit = def.ok.some(v=>arr.includes(v));
      if(hit) ok++;
    }else{
      if(def.ok.includes(saved[def.key])) ok++;
    }
  });
  const p = Math.round((ok/total)*100);
  if(p>=70){
    toastRemed("toast_l2_q2", true, "‚úÖ Valid√© (C2)", `QQOQCP compl√©t√© (${p}%).`, "");
    if(!isDone("l2_q2")){
      addScore("C2", 6); addScore("C1", 2); addScore("C6", 1);
      setDone("l2_q2", true); unlock(3); starOnce("l2"); saveState();
    }
  }else{
    toastRemed("toast_l2_q2", false, "‚õî √Ä compl√©ter", `QQOQCP incomplet (${p}%).`, "Commence par ‚ÄúComment‚Äù (exposition) puis ‚ÄúPourquoi‚Äù (effets).");
    saveState();
  }
});

document.getElementById("l2_back").addEventListener("click", ()=>go("home"));
document.getElementById("l2_next").addEventListener("click", ()=>{ if(levelUnlocked(3)) go("l3"); else explainLock(3); });

document.getElementById("openDocE").addEventListener("click", ()=>{
  openDoc("Mini-doc E ‚Äî Effets d‚Äôexposition", `
    Exposition prolong√©e (bruit/vibration) + cadence + manque de pauses ‚Üí fatigue + tension ‚Üí douleurs / risque accru.<br><br>
    <span class="muted">Objectif : construire une phrase cause ‚Üí effet.</span>
  `);
});

mkChoice(document.querySelector('#l3_q1 .choices'), [
  { id:"a", t:"Exposition (bruit/vibration) + cadence + peu de pauses", s:"Cause principale probable." },
  { id:"b", t:"La couleur des pi√®ces", s:"Hors analyse." },
  { id:"c", t:"La m√©t√©o", s:"Hors situation." },
  { id:"d", t:"Acheter des gants", s:"Solution (pas cause)." },
], (it)=>{
  state.answers.l3_q1 = it.id;
  if(it.id==="a"){
    toastRemed("toast_l3_q1", true, "‚úÖ Correct (C2)", "Tu identifies une cause li√©e √† l‚Äôexposition.", "");
    if(!isDone("l3_q1")){ addScore("C2", 4); addScore("C6", 1); setDone("l3_q1", true); saveState(); }
  }else{
    toastRemed("toast_l3_q1", false, "‚õî √Ä corriger", "Une cause explique le probl√®me dans la situation.", "Choisis ce qui augmente l‚Äôexposition (bruit/vibration/cadence/pauses).");
    saveState();
  }
});

const L3_BANK = [
  "Parce que l‚Äôexposition est prolong√©e",
  "Parce que la cadence est √©lev√©e",
  "Parce qu‚Äôil y a peu de pauses",
  "alors la fatigue augmente",
  "alors la tension augmente",
  "ce qui entra√Æne des douleurs",
  "ce qui augmente le risque"
];
const L3_SLOTS = [
  { key:"s1", label:"Parce que‚Ä¶", ok:["Parce que l‚Äôexposition est prolong√©e","Parce que la cadence est √©lev√©e","Parce qu‚Äôil y a peu de pauses"] },
  { key:"s2", label:"alors‚Ä¶", ok:["alors la fatigue augmente","alors la tension augmente"] },
  { key:"s3", label:"ce qui‚Ä¶", ok:["ce qui entra√Æne des douleurs","ce qui augmente le risque"] }
];
let l3Selected = null;

function renderL3(){
  mkChipBank(document.getElementById("l3_bank"), L3_BANK, (ch)=>{ l3Selected = ch; });
  const saved = state.answers.l3_slots || {};
  const slots = L3_SLOTS.map(s=>({ label:s.label, key:s.key, value: saved[s.key] || "" }));
  mkSlots(document.getElementById("l3_slots"), slots, (key)=>{
    if(!l3Selected) return;
    const saved2 = state.answers.l3_slots || {};
    saved2[key] = l3Selected;
    state.answers.l3_slots = saved2;
    clearToast("toast_l3_q2");
    saveState();
    renderL3();
  });
}
renderL3();

document.getElementById("l3_reset").addEventListener("click", ()=>{
  state.answers.l3_slots = {}; l3Selected = null; clearToast("toast_l3_q2"); saveState(); renderL3();
});
document.getElementById("l3_validate").addEventListener("click", ()=>{
  const saved = state.answers.l3_slots || {};
  let ok=0;
  for(const s of L3_SLOTS){ if(s.ok.includes(saved[s.key])) ok++; }
  if(ok===3){
    toastRemed("toast_l3_q2", true, "‚úÖ Valid√© (C2‚ÜíC3)", "Phrase logique : cause ‚Üí cons√©quence ‚Üí effet.", "");
    if(!isDone("l3_q2")){
      addScore("C2", 4); addScore("C3", 4); addScore("C6", 1);
      setDone("l3_q2", true); unlock(4); starOnce("l3"); saveState();
    }
  }else{
    toastRemed("toast_l3_q2", false, "‚õî √Ä corriger", "Il manque une case.", "Remplis 3 cases : Parce que / alors / ce qui.");
    saveState();
  }
});

document.getElementById("l3_back").addEventListener("click", ()=>go("home"));
document.getElementById("l3_next").addEventListener("click", ()=>{ if(levelUnlocked(4)) go("l4"); else explainLock(4); });

document.getElementById("openDocM").addEventListener("click", ()=>{
  openDoc("Mini-doc M ‚Äî Mesures possibles", `
    <b>Mesures possibles</b> (exemples) :<br>
    ‚Ä¢ r√©duire la vibration √† la source<br>
    ‚Ä¢ r√©organiser la cadence<br>
    ‚Ä¢ pauses r√©guli√®res / rotation t√¢ches<br>
    ‚Ä¢ isolation/captation du bruit (collectif)<br>
    ‚Ä¢ gants anti-vibration (compl√©ment)<br>
    ‚Ä¢ formation au bon geste (compl√©ment)<br><br>
    <span class="muted">Objectif : choisir 3 mesures et les hi√©rarchiser.</span>
  `);
});

const L4_MEASURES = [
  "R√©duire la vibration √† la source",
  "R√©organiser la cadence",
  "Mettre des pauses r√©guli√®res",
  "Rotation des t√¢ches",
  "Isoler / capter le bruit (collectif)",
  "Gants anti-vibration",
  "Former au bon geste"
];
const L4_SLOTS = [
  { key:"p1", label:"Priorit√© 1" },
  { key:"p2", label:"Priorit√© 2" },
  { key:"p3", label:"Priorit√© 3" }
];
let l4Selected = null;

function renderL4(){
  mkChipBank(document.getElementById("l4_measures"), L4_MEASURES, (ch)=>{ l4Selected = ch; });
  const saved = state.answers.l4_slots || {};
  const slots = L4_SLOTS.map(s=>({ label:s.label, key:s.key, value: saved[s.key] || "" }));
  mkSlots(document.getElementById("l4_slots"), slots, (key)=>{
    if(!l4Selected) return;
    const saved2 = state.answers.l4_slots || {};
    saved2[key] = l4Selected;
    state.answers.l4_slots = saved2;
    clearToast("toast_l4");
    saveState();
    renderL4();
  });
}
renderL4();

document.getElementById("l4_reset").addEventListener("click", ()=>{
  state.answers.l4_slots = {}; l4Selected = null; clearToast("toast_l4"); saveState(); renderL4();
});
document.getElementById("l4_validate").addEventListener("click", ()=>{
  const saved = state.answers.l4_slots || {};
  const filled = ["p1","p2","p3"].every(k=>!!saved[k]);
  if(!filled){
    toastRemed("toast_l4", false, "‚õî √Ä compl√©ter", "Il manque une priorit√©.", "Place 3 mesures : priorit√© 1, 2 et 3.");
    saveState();
    return;
  }
  const chosen = [saved.p1, saved.p2, saved.p3];
  const uniq = new Set(chosen);
  if(uniq.size !== 3){
    toastRemed("toast_l4", false, "‚õî √Ä corriger", "Une m√™me mesure est utilis√©e plusieurs fois.", "Choisis 3 mesures diff√©rentes.");
    saveState();
    return;
  }
  const isIndiv = (m)=> m.includes("Gants") || m.includes("geste");
  if(isIndiv(saved.p1)){
    toastRemed("toast_l4", false, "‚õî Priorit√© discutable", "Tu as mis une mesure individuelle en priorit√© 1.", "Mets plut√¥t une action sur la source ou l‚Äôorganisation en priorit√© 1.");
    saveState();
    return;
  }
  toastRemed("toast_l4", true, "‚úÖ Valid√© (C4)", "3 mesures hi√©rarchis√©es de fa√ßon coh√©rente.", "");
  if(!isDone("l4")){
    addScore("C4", 10); addScore("C6", 1);
    setDone("l4", true); unlock(5); starOnce("l4"); saveState();
  }
});

document.getElementById("l4_back").addEventListener("click", ()=>go("home"));
document.getElementById("l4_next").addEventListener("click", ()=>{ if(levelUnlocked(5)) go("l5"); else explainLock(5); });

mkChoice(document.querySelector('#l5_q1 .choices'), [
  { id:"a", t:"Plan A", s:"Source + organisation (prioritaire)." },
  { id:"b", t:"Plan B", s:"Surtout individuel (compl√©ment)." },
], (it)=>{
  state.answers.l5_q1 = it.id;
  if(it.id==="a"){
    toastRemed("toast_l5_q1", true, "‚úÖ Correct (C5)", "Plan A est plus efficace (source + organisation).", "");
    if(!isDone("l5_q1")){ addScore("C5", 4); addScore("C6", 1); setDone("l5_q1", true); saveState(); }
  }else{
    toastRemed("toast_l5_q1", false, "‚õî √Ä corriger", "C5 = choisir selon efficacit√©, pas pr√©f√©rence.", "Privil√©gie source/organisation, puis individuel en compl√©ment.");
    saveState();
  }
});

const L5_BANK = [
  "Je choisis le plan A",
  "Je choisis le plan B",
  "car il agit sur la source",
  "car il prot√®ge individuellement",
  "de plus il r√©organise la cadence",
  "de plus il rappelle les consignes",
  "donc il diminue fatigue et douleurs",
  "donc il limite une partie du risque",
  "cependant les gants restent utiles en compl√©ment"
];
const L5_SLOTS = [
  { key:"a1", label:"Choix" },
  { key:"a2", label:"car‚Ä¶" },
  { key:"a3", label:"de plus‚Ä¶" },
  { key:"a4", label:"donc‚Ä¶" },
  { key:"a5", label:"cependant‚Ä¶" }
];
let l5Selected = null;

function renderL5(){
  mkChipBank(document.getElementById("l5_bank"), L5_BANK, (ch)=>{ l5Selected = ch; });
  const saved = state.answers.l5_slots || {};
  const slots = L5_SLOTS.map(s=>({ label:s.label, key:s.key, value: saved[s.key] || "" }));
  mkSlots(document.getElementById("l5_slots"), slots, (key)=>{
    if(!l5Selected) return;
    const saved2 = state.answers.l5_slots || {};
    saved2[key] = l5Selected;
    state.answers.l5_slots = saved2;
    clearToast("toast_l5_q2");
    saveState();
    renderL5();
  });
}
renderL5();

document.getElementById("l5_reset").addEventListener("click", ()=>{
  state.answers.l5_slots = {}; l5Selected = null; clearToast("toast_l5_q2"); saveState(); renderL5();
});
document.getElementById("l5_validate").addEventListener("click", ()=>{
  const saved = state.answers.l5_slots || {};
  const have = Object.values(saved).filter(Boolean).length;
  if(have >= 4){
    toastRemed("toast_l5_q2", true, "‚úÖ Valid√© (C5 + C6)", "Argumentaire structur√©.", "");
    if(!isDone("l5_q2")){
      addScore("C5", 8); addScore("C6", 2);
      setDone("l5_q2", true); unlock(6); starOnce("l5"); saveState();
    }
  }else{
    toastRemed("toast_l5_q2", false, "‚õî √Ä compl√©ter", "Argumentaire incomplet.", "Remplis au minimum : Choix + car + de plus + donc.");
    saveState();
  }
});

document.getElementById("l5_back").addEventListener("click", ()=>go("home"));
document.getElementById("l5_next").addEventListener("click", ()=>{ if(levelUnlocked(6)) go("final"); else explainLock(6); });

function radarSVG(values){
  const axes = ["C2","C3","C4","C5","C1","C6"];
  const cx=170, cy=170, R=135;
  const steps=[20,40,60,80,100];

  function pt(i,val){
    const ang = (-90 + i*(360/axes.length)) * Math.PI/180;
    const r = (R * val)/100;
    return { x: cx + r*Math.cos(ang), y: cy + r*Math.sin(ang) };
  }

  let grid="";
  steps.forEach(s=>{
    const pts = axes.map((a,i)=>pt(i,s));
    const d = pts.map((p,i)=> (i===0?`M ${p.x.toFixed(1)} ${p.y.toFixed(1)}`:`L ${p.x.toFixed(1)} ${p.y.toFixed(1)}`)).join(" ") + " Z";
    grid += `<path d="${d}" fill="none" stroke="rgba(20,30,55,.12)" stroke-width="1" />`;
  });

  let lines="";
  axes.forEach((a,i)=>{
    const p = pt(i,100), p2=pt(i,0), lab=pt(i,112);
    lines += `<line x1="${p2.x}" y1="${p2.y}" x2="${p.x}" y2="${p.y}" stroke="rgba(20,30,55,.14)" />`;
    lines += `<text x="${lab.x}" y="${lab.y}" fill="rgba(23,32,51,.92)" font-size="12" font-weight="900" text-anchor="middle" dominant-baseline="middle">${a}</text>`;
  });

  const polyPts = axes.map((a,i)=>pt(i, values[a]||0));
  const ptsStr = polyPts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(" ");

  return `
    <svg viewBox="0 0 340 340" width="100%" style="max-width:520px; display:block; margin: 0 auto;">
      ${grid}
      ${lines}
      <polygon points="${ptsStr}" fill="rgba(27,191,122,.18)" stroke="rgba(27,191,122,.55)" stroke-width="2"></polygon>
      <circle cx="${cx}" cy="${cy}" r="3.5" fill="rgba(23,32,51,.55)"></circle>
    </svg>
  `;
}

function topAndBottomCompetence(){
  const keys = ["C2","C3","C4","C5"];
  const ratios = keys.map(k=>({k, v: pct(state.score[k], MAX[k])}));
  ratios.sort((a,b)=>b.v-a.v);
  return { strong: ratios[0].k, work: ratios[ratios.length-1].k };
}

function adviceText(){
  const {strong, work} = topAndBottomCompetence();
  const tips = {
    C2: "Priorit√© C2 : utilise un outil (QQOQCP/5M) avant de proposer des solutions.",
    C3: "Priorit√© C3 : explique en 3 √©tapes : cause ‚Üí m√©canisme/r√®gle ‚Üí lien pr√©vention.",
    C4: "Priorit√© C4 : propose 3 mesures r√©alistes et classe : source/organisation d‚Äôabord, individuel en compl√©ment.",
    C5: "Priorit√© C5 : annonce le choix puis justifie avec 2 arguments + connecteurs (car, de plus, donc)."
  };
  return `
    <b>Point fort</b> : ${strong} ‚Äî ${COMP[strong]}<br>
    <b>√Ä travailler</b> : ${work} ‚Äî ${COMP[work]}<br><br>
    ${tips[work] || ""}<br><br>
    <span class="muted">Rappel : C1 et C6 sont transversales (indicateurs).</span>
  `;
}

function teacherKeyText(){
  return `
    <b>Niveau 1</b> : reconnaissance (indices).<br>
    1) C1 ‚Ä¢ 2) C2 ‚Ä¢ 3) C3 ‚Ä¢ 4) C4 ‚Ä¢ 5) C5 ‚Ä¢ 6) C6<br><br>
    <b>Niveau 2</b> : phrase-probl√®me = A ; QQOQCP = exposition en ‚ÄúComment‚Äù, effets en ‚ÄúPourquoi‚Äù.<br><br>
    <b>Niveau 3</b> : cause = exposition/cadence/pauses ; phrase ‚ÄúParce que‚Ä¶ alors‚Ä¶ ce qui‚Ä¶‚Äù.<br><br>
    <b>Niveau 4</b> : 3 mesures hi√©rarchis√©es (source/orga d‚Äôabord).<br><br>
    <b>Niveau 5</b> : plan attendu = A ; argumentaire = Choix + car + de plus + donc (+ cependant en bonus).
  `;
}

function renderFinal(){
  const gp = globalProgress();
  document.getElementById("kpiStars").textContent = state.stars;
  document.getElementById("kpiPct").textContent = gp+"%";
  const {strong, work} = topAndBottomCompetence();
  document.getElementById("kpiStrong").textContent = strong;
  document.getElementById("kpiWork").textContent = work;

  const values = {};
  for(const k of Object.keys(MAX)) values[k] = pct(state.score[k], MAX[k]);
  document.getElementById("radarWrap").innerHTML = radarSVG(values);
  document.getElementById("adviceBox").innerHTML = adviceText();
  document.getElementById("teacherKey").innerHTML = teacherKeyText();
}

document.getElementById("final_back").addEventListener("click", ()=>go("home"));
document.getElementById("final_restart").addEventListener("click", resetAll);

function autoUnlock(){
  const l1done = L1.filter(x=>isDone(x.id)).length;
  if(l1done>=5) unlock(2);
  if(isDone("l2_q2")) unlock(3);
  if(isDone("l3_q2")) unlock(4);
  if(isDone("l4")) unlock(5);
  if(isDone("l5_q2")) unlock(6);
}
autoUnlock();
renderTop();

const needMap = { home:1, l1:1, l2:2, l3:3, l4:4, l5:5, final:6 };
if(screens.includes(state.screen) && levelUnlocked(needMap[state.screen]||1)) go(state.screen);
else go("home");
</script>
</body>
</html>
