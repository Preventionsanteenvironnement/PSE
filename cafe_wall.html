<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>√âcran G√©ant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; background: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; display:flex; justify-content:center; align-items:center; height:100vh; }
        .hidden { display: none !important; }
        .screen { width: 90%; height: 80%; display:none; flex-direction:column; align-items:center; }
        .active { display: flex; animation: fadeUp 0.5s; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        
        h1 { font-size: 3rem; color: #db2777; margin-bottom: 10px; text-align:center; }
        h2 { font-size: 2.5rem; margin-bottom: 30px; text-align:center; }

        /* CHART */
        .chart-container { width: 80%; height: 60vh; position: relative; }
        
        /* NUAGE */
        #cloud-box { position: relative; width: 100%; height: 60vh; }
        .bubble { position: absolute; padding: 10px 20px; border-radius: 30px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); font-weight: bold; color:white; transition: 0.5s; }
    </style>
</head>
<body>

    <div id="view-wait" class="screen active">
        <h1 style="font-size:5rem;">‚òï Caf√© Parents</h1>
        <p style="font-size:2rem; color:#94a3b8;">La session va commencer...</p>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://preventionsanteenvironnement.github.io/PSE/cafe_mobile.html" style="margin-top:30px; border-radius:10px;">
    </div>

    <div id="view-nuage" class="screen">
        <h1>‚òÅÔ∏è Nuage de mots</h1>
        <div id="cloud-box"></div>
    </div>

    <div id="view-poll" class="screen">
        <h2 id="poll-question">Question...</h2>
        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const app = initializeApp({ apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse" });
    const db = getFirestore(app);
    
    let activeSessionId = null;
    let chartInstance = null;
    let currentOptions = [];
    let correctIndex = -1; // Pour le quiz
    let isRevealed = false;

    // CONFIG
    onSnapshot(doc(db, "config", "live"), (snap) => {
        if(!snap.exists()) return;
        const data = snap.data();
        
        // Session ID
        if(data.activeSessionId !== activeSessionId) {
            activeSessionId = data.activeSessionId;
            if(activeSessionId) listenData(activeSessionId);
        }

        // Navigation
        let step = data.currentStep || 'wait';
        if(step === 'meteo') step = 'poll'; // M√©t√©o utilise la vue graphique aussi
        if(step === 'quiz') step = 'poll'; // Quiz utilise la vue graphique

        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        const target = document.getElementById(step === 'nuage' ? 'view-nuage' : (step === 'poll' ? 'view-poll' : 'view-wait'));
        if(target) target.classList.add('active');

        // Setup Graphique
        if(data.currentStep === 'sondage' || data.currentStep === 'quiz' || data.currentStep === 'meteo') {
            let labels = [];
            let question = "";
            
            if(data.currentStep === 'meteo') {
                labels = ['ü§© Super', 'üôÇ Bien', 'ü§î Bof', 'üò∞ Mauvais'];
                question = "M√©t√©o du groupe";
            } else if (data.currentStep === 'quiz') {
                labels = data.quizOptions || [];
                question = data.quizQuestion;
                correctIndex = data.quizCorrect;
                isRevealed = (data.quizState === 'revealed');
            } else {
                labels = data.pollOptions || [];
                question = data.pollQuestion;
                correctIndex = -1; // Pas de bonne r√©ponse
            }

            document.getElementById('poll-question').innerText = question;
            if(JSON.stringify(labels) !== JSON.stringify(currentOptions)) {
                currentOptions = labels;
                initChart(labels);
            }
            // Si c'est un quiz et qu'on r√©v√®le, on update les couleurs
            if(data.currentStep === 'quiz') updateChartColors();
        }
    });

    // DONNEES
    function listenData(sessId) {
        onSnapshot(query(collection(db, `sessions/${sessId}/inputs`)), (snap) => {
            const counts = new Array(currentOptions.length).fill(0);
            const words = [];
            
            snap.forEach(d => {
                const val = d.data().content;
                const type = d.data().type;

                if(type === 'word') words.push(val);
                
                // Comptage votes
                if(type === 'quiz') {
                    if(val >= 0 && val < counts.length) counts[val]++;
                } else if (type === 'poll') {
                    const idx = currentOptions.indexOf(val);
                    if(idx !== -1) counts[idx]++;
                } else if (type === 'mood') {
                    const map = { 'super':0, 'bien':1, 'bof':2, 'mauvais':3 };
                    if(map[val] !== undefined) counts[map[val]]++;
                }
            });

            if(document.getElementById('view-nuage').classList.contains('active')) updateCloud(words);
            else if(chartInstance) {
                chartInstance.data.datasets[0].data = counts;
                chartInstance.update();
            }
        });
    }

    // CHART
    function initChart(labels) {
        const ctx = document.getElementById('myChart');
        if(chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ 
                    label: 'Votes', 
                    data: new Array(labels.length).fill(0),
                    backgroundColor: '#3b82f6',
                    borderRadius: 10
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, ticks: { color:'white', font:{size:20} } },
                    x: { ticks: { color:'white', font:{size:24} } }
                }
            }
        });
    }

    function updateChartColors() {
        if(!chartInstance) return;
        const colors = currentOptions.map((_, i) => {
            if(!isRevealed) return '#3b82f6'; // Bleu normal
            return (i == correctIndex) ? '#10b981' : '#ef4444'; // Vert si juste, Rouge si faux
        });
        chartInstance.data.datasets[0].backgroundColor = colors;
        chartInstance.update();
    }

    // NUAGE
    function updateCloud(words) {
        const box = document.getElementById('cloud-box');
        box.innerHTML = "";
        const counts = {};
        words.forEach(w => counts[w] = (counts[w] || 0) + 1);
        
        Object.keys(counts).forEach(w => {
            const el = document.createElement('div');
            el.className = 'bubble';
            el.innerText = w;
            const size = Math.min(2 + counts[w], 6);
            el.style.fontSize = size + 'rem';
            el.style.left = Math.random() * 80 + '%';
            el.style.top = Math.random() * 80 + '%';
            box.appendChild(el);
        });
    }
</script>
</body>
</html>
