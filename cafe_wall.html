<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caf√© Parents - √âcran G√©ant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; background: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* HEADER */
        .header { position: absolute; top: 0; left: 0; right: 0; padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .title { font-size: 2rem; font-weight: bold; color: #db2777; text-shadow: 0 0 20px rgba(219,39,119,0.5); }
        .qr-box { background: white; padding: 10px; border-radius: 10px; color: black; text-align: center; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        
        /* √âCRANS */
        .wall-screen { display: none; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; align-items: center; justify-content: center; flex-direction: column; }
        .wall-screen.active { display: flex; animation: fadeZoom 0.8s; }
        @keyframes fadeZoom { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }

        /* M√âT√âO */
        .meteo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 80%; text-align: center; }
        .meteo-item { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 30px; border: 1px solid rgba(255,255,255,0.1); }
        .meteo-emoji { font-size: 5rem; display: block; margin-bottom: 20px; transition: 0.3s; }
        .meteo-bar { width: 100%; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; position: relative; }
        .meteo-fill { height: 100%; width: 0%; background: #db2777; transition: 1s ease-out; }

        /* NUAGE */
        #cloud-container { width: 90%; height: 70%; position: relative; }
        .bubble { position: absolute; background: rgba(255,255,255,0.1); padding: 15px 30px; border-radius: 50px; border: 2px solid rgba(255,255,255,0.3); font-weight: bold; font-size: 1.5rem; color: white; transition: 0.5s; white-space: nowrap; box-shadow: 0 0 15px rgba(219,39,119,0.2); animation: float 6s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .empty-msg { width:100%; text-align:center; color: #64748b; font-size: 1.5rem; position:absolute; top:50%; transform:translateY(-50%); }

    </style>
</head>
<body>

    <div class="header">
        <div class="title" id="session-title">‚òï Caf√© Parents</div>
        <div class="qr-box">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://preventionsanteenvironnement.github.io/PSE/cafe_mobile.html" alt="QR">
            <div style="font-size: 0.8rem; font-weight: bold; margin-top: 5px;">Scannez pour participer</div>
        </div>
    </div>

    <div id="wall-attente" class="wall-screen active">
        <h1 style="font-size: 4rem; margin-bottom:10px;">Bienvenue !</h1>
        <p style="font-size: 2rem; color: #94a3b8;">Installez-vous, nous allons commencer.</p>
        <p style="font-size: 1.5rem; color: #4ade80; margin-top: 40px; border: 1px solid #4ade80; padding:10px 20px; border-radius:50px;">
            üîí Participation 100% Anonyme
        </p>
    </div>

    <div id="wall-meteo" class="wall-screen">
        <h2 style="font-size: 3rem; margin-bottom: 50px;">M√©t√©o du groupe üß†</h2>
        <div class="meteo-grid">
            <div class="meteo-item"><span class="meteo-emoji">ü§©</span><div class="meteo-bar"><div id="bar-super" class="meteo-fill"></div></div><h3 id="count-super">0</h3></div>
            <div class="meteo-item"><span class="meteo-emoji">üôÇ</span><div class="meteo-bar"><div id="bar-bien" class="meteo-fill" style="background:#4ade80;"></div></div><h3 id="count-bien">0</h3></div>
            <div class="meteo-item"><span class="meteo-emoji">ü§î</span><div class="meteo-bar"><div id="bar-bof" class="meteo-fill" style="background:#facc15;"></div></div><h3 id="count-bof">0</h3></div>
            <div class="meteo-item"><span class="meteo-emoji">üò∞</span><div class="meteo-bar"><div id="bar-mauvais" class="meteo-fill" style="background:#f87171;"></div></div><h3 id="count-mauvais">0</h3></div>
        </div>
    </div>

    <div id="wall-nuage" class="wall-screen">
        <h2 style="font-size: 3rem; margin-bottom: 20px;">‚òÅÔ∏è Nuage de mots</h2>
        <div id="cloud-container">
            <div class="empty-msg">En attente...</div>
        </div>
    </div>
    
    <div id="wall-sondage" class="wall-screen">
        <h2 id="poll-title-display" style="font-size: 2.5rem; margin-bottom:20px; color:#fff;">R√©sultats du Sondage</h2>
        <div style="width: 70%; height: 60%;">
            <canvas id="pollChart"></canvas>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
      authDomain: "devoirs-pse.firebaseapp.com",
      projectId: "devoirs-pse",
      storageBucket: "devoirs-pse.appspot.com",
      messagingSenderId: "614730413904",
      appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let activeSessionId = null;
    let inputsUnsubscribe = null;
    let pollChartInstance = null;
    let currentPollOptions = []; // Pour stocker les choix actuels (ex: Lundi, Mardi...)

    // 1. √âCOUTER LE CONFIG (Pour savoir QUOI afficher)
    onSnapshot(doc(db, "config", "live"), (docSnap) => {
        if(docSnap.exists()) {
            const data = docSnap.data();
            
            // Titre global
            if(data.sessionTitle) document.getElementById('session-title').innerText = "üìç " + data.sessionTitle;

            // Session ID
            if(data.activeSessionId && data.activeSessionId !== activeSessionId) {
                activeSessionId = data.activeSessionId;
                listenToData(activeSessionId);
            } else if (!data.activeSessionId) {
                // Session ferm√©e
                activeSessionId = null;
                showWall('attente');
                return;
            }

            // Configuration du Sondage (Si elle change)
            if(data.pollQuestion) document.getElementById('poll-title-display').innerText = data.pollQuestion;
            
            // Si les options changent, on recr√©e le graphique
            if(data.pollOptions && JSON.stringify(data.pollOptions) !== JSON.stringify(currentPollOptions)) {
                currentPollOptions = data.pollOptions;
                initChart(currentPollOptions);
            }

            // Navigation
            showWall(data.currentStep || 'attente');
        }
    });

    function showWall(stepName) {
        if(stepName === 'welcome' || stepName === 'wait') stepName = 'attente';
        
        document.querySelectorAll('.wall-screen').forEach(el => el.classList.remove('active'));
        const target = document.getElementById('wall-' + stepName);
        if(target) target.classList.add('active');
    }

    // 2. √âCOUTER LES R√âPONSES (Pour COMPTER)
    function listenToData(sessId) {
        if(inputsUnsubscribe) inputsUnsubscribe();
        
        const q = query(collection(db, `sessions/${sessId}/inputs`));
        
        inputsUnsubscribe = onSnapshot(q, (snapshot) => {
            const words = [];
            const moods = { super:0, bien:0, bof:0, mauvais:0 };
            
            // Compteur dynamique pour le sondage
            // On initialise tout √† 0 selon les options actuelles
            const pollCounts = {}; 
            currentPollOptions.forEach(opt => pollCounts[opt] = 0);

            let totalMood = 0;

            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                if(d.banned) return; 

                if(d.type === 'word') words.push(d.content);
                
                if(d.type === 'mood') { 
                    if(moods[d.content] !== undefined) { moods[d.content]++; totalMood++; }
                }
                
                if(d.type === 'poll') { 
                    // On compte le vote s'il correspond √† une option valide
                    if(pollCounts[d.content] !== undefined) {
                        pollCounts[d.content]++;
                    } else if(currentPollOptions.length === 0) {
                        // Cas par d√©faut (vieux sondage ou pas d'options d√©finies)
                        pollCounts[d.content] = (pollCounts[d.content] || 0) + 1;
                    }
                }
            });

            updateCloud(words);
            updateMeteo(moods, totalMood);
            updatePollChart(pollCounts);
        });
    }

    // --- VISUELS ---

    function updateCloud(words) {
        const container = document.getElementById('cloud-container');
        if(words.length === 0) { container.innerHTML = '<div class="empty-msg">En attente...</div>'; return; }

        const counts = {};
        words.forEach(w => counts[w] = (counts[w] || 0) + 1);
        
        container.innerHTML = "";
        Object.keys(counts).forEach(word => {
            const count = counts[word];
            const el = document.createElement('div');
            el.className = 'bubble';
            el.innerText = word;
            let size = 1.5 + (count * 0.5); 
            el.style.fontSize = Math.min(size, 6) + "rem";
            el.style.left = (Math.random() * 80 + 5) + "%";
            el.style.top = (Math.random() * 80 + 5) + "%";
            const colors = ['#db2777', '#2563eb', '#16a34a', '#d97706', '#8b5cf6'];
            el.style.borderColor = colors[Math.floor(Math.random()*colors.length)];
            container.appendChild(el);
        });
    }

    function updateMeteo(moods, total) {
        if(total === 0) total = 1;
        document.getElementById('bar-super').style.width = (moods.super/total*100) + "%";
        document.getElementById('count-super').innerText = moods.super;
        document.getElementById('bar-bien').style.width = (moods.bien/total*100) + "%";
        document.getElementById('count-bien').innerText = moods.bien;
        document.getElementById('bar-bof').style.width = (moods.bof/total*100) + "%";
        document.getElementById('count-bof').innerText = moods.bof;
        document.getElementById('bar-mauvais').style.width = (moods.mauvais/total*100) + "%";
        document.getElementById('count-mauvais').innerText = moods.mauvais;
    }

    // --- CHART DYNAMIQUE ---

    function initChart(labels) {
        const ctx = document.getElementById('pollChart');
        if(pollChartInstance) pollChartInstance.destroy();

        // Couleurs automatiques
        const bgColors = labels.map((_, i) => {
            const palette = ['#4ade80', '#facc15', '#f87171', '#3b82f6', '#a855f7'];
            return palette[i % palette.length];
        });

        pollChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels, // <--- C'est ici que la magie op√®re (ex: ["Lundi", "Mardi"])
                datasets: [{
                    label: 'Votes',
                    data: new Array(labels.length).fill(0),
                    backgroundColor: bgColors,
                    borderRadius: 15
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: 'white', font:{size:20}, precision:0 } },
                    x: { ticks: { color: 'white', font:{size:24, weight:'bold'} } }
                } 
            }
        });
    }

    function updatePollChart(counts) {
        if(pollChartInstance) {
            // On transforme l'objet {Lundi: 3, Mardi: 1} en tableau [3, 1] dans le bon ordre
            const dataArray = pollChartInstance.data.labels.map(label => counts[label] || 0);
            pollChartInstance.data.datasets[0].data = dataArray;
            pollChartInstance.update();
        }
    }

</script>
</body>
</html>
