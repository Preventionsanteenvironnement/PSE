<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âcran G√©ant - Caf√© Parents</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* DESIGN MUR √âCRAN */
        body { 
            margin: 0; background: #0f172a; color: white; 
            font-family: 'Segoe UI', sans-serif; overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh;
        }
        
        /* HEADER */
        .header { position: absolute; top: 0; left: 0; right: 0; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .title-main { font-size: 2rem; font-weight: bold; color: #db2777; text-transform: uppercase; letter-spacing: 2px; }
        
        /* QR CODE */
        .qr-box { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5); text-align: center; }
        .qr-text { color: black; font-weight: bold; font-size: 0.9rem; margin-top: 5px; }

        /* VUES (√âcrans) */
        .screen { display: none; width: 90%; height: 80%; flex-direction: column; align-items: center; justify-content: center; animation: zoomIn 0.5s; }
        .active { display: flex; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        h1 { font-size: 3.5rem; text-align: center; margin-bottom: 20px; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { font-size: 2rem; color: #cbd5e1; margin-bottom: 40px; }

        /* GRAPHIQUE */
        .chart-wrapper { width: 80%; height: 60vh; position: relative; }

        /* NUAGE DE MOTS */
        #cloud-container { width: 100%; height: 60vh; position: relative; }
        .bubble { 
            position: absolute; padding: 10px 25px; border-radius: 50px; 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: white; font-weight: bold; transition: all 0.5s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="title-main" id="session-title-display">‚òï Caf√© Parents</div>
        <div class="qr-box">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://preventionsanteenvironnement.github.io/PSE/cafe_mobile.html" alt="QR">
            <div class="qr-text">Scannez pour jouer</div>
        </div>
    </div>

    <div id="view-wait" class="screen active">
        <h1>Bienvenue !</h1>
        <h2>Installez-vous, nous allons commencer.</h2>
        <div style="font-size: 5rem; animation: float 3s infinite ease-in-out;">üëã</div>
    </div>

    <div id="view-nuage" class="screen">
        <h1>‚òÅÔ∏è Nuage de mots</h1>
        <div id="cloud-container"></div>
    </div>

    <div id="view-chart" class="screen">
        <h1 id="question-display" style="font-size: 2.5rem;">Question...</h1>
        <div class="chart-wrapper">
            <canvas id="myChart"></canvas>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI", authDomain: "devoirs-pse.firebaseapp.com", projectId: "devoirs-pse", storageBucket: "devoirs-pse.appspot.com", messagingSenderId: "614730413904", appId: "1:614730413904:web:a5dd478af5de30f6bede55" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let activeSessionId = null;
    let chartInstance = null;
    
    // Variables pour g√©rer l'√©tat
    let currentLabels = [];
    let currentQuizCorrectIndex = -1;
    let currentQuizState = 'voting'; // 'voting' ou 'revealed'
    let currentType = 'poll'; // 'poll', 'quiz', 'meteo'

    // 1. √âCOUTE DE LA CONFIGURATION (Le Cerveau)
    onSnapshot(doc(db, "config", "live"), (snap) => {
        if(!snap.exists()) return;
        const data = snap.data();

        // Mise √† jour Session
        if(data.sessionTitle) document.getElementById('session-title-display').innerText = data.sessionTitle;
        if(data.activeSessionId !== activeSessionId) {
            activeSessionId = data.activeSessionId;
            if(activeSessionId) listenToVotes(activeSessionId);
            else showScreen('wait');
        }

        // Mise √† jour √âtat Quiz
        currentQuizState = data.quizState || 'voting';

        // Gestion Navigation
        handleNavigation(data);
    });

    function handleNavigation(data) {
        let step = data.currentStep || 'wait';
        
        // Configuration des Labels et Questions selon le mode
        if(step === 'meteo') {
            setupChartMode("M√©t√©o du groupe", ['ü§© Super', 'üôÇ Bien', 'ü§î Bof', 'üò∞ Mauvais'], 'meteo');
        } 
        else if (step === 'sondage') {
            setupChartMode(data.pollQuestion, data.pollOptions, 'poll');
        }
        else if (step === 'quiz') {
            currentQuizCorrectIndex = data.quizCorrect; // On garde la bonne r√©ponse en m√©moire
            setupChartMode(data.quizQuestion, data.quizOptions, 'quiz');
        }
        else if (step === 'nuage') {
            showScreen('nuage');
        } 
        else {
            showScreen('wait');
        }
    }

    function setupChartMode(question, options, type) {
        currentType = type;
        document.getElementById('question-display').innerText = question || "Sondage";
        
        // Si les options ont chang√©, on refait le graphique
        if(JSON.stringify(options) !== JSON.stringify(currentLabels)) {
            currentLabels = options || [];
            initChart(currentLabels);
        }
        
        // Si c'est un quiz, on met √† jour les couleurs (vert/rouge) selon l'√©tat
        if(type === 'quiz') updateChartColors();
        
        showScreen('chart');
    }

    function showScreen(name) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        const target = document.getElementById('view-' + name);
        if(target) target.classList.add('active');
    }

    // 2. √âCOUTE DES VOTES (Les donn√©es)
    function listenToVotes(sessId) {
        onSnapshot(query(collection(db, `sessions/${sessId}/inputs`)), (snap) => {
            
            const counts = new Array(currentLabels.length).fill(0);
            const words = [];

            snap.forEach(docSnap => {
                const d = docSnap.data();
                
                // NUAGE
                if(d.type === 'word' && !d.banned) words.push(d.content);

                // GRAPHIQUES
                if(d.type === currentType) {
                    if(currentType === 'quiz') {
                        // Quiz : le contenu est un index (0, 1, 2...)
                        const idx = parseInt(d.content);
                        if(idx >= 0 && idx < counts.length) counts[idx]++;
                    } 
                    else if (currentType === 'poll') {
                        // Sondage : le contenu est du texte
                        const idx = currentLabels.indexOf(d.content);
                        if(idx !== -1) counts[idx]++;
                    }
                    else if (currentType === 'meteo') {
                        // M√©t√©o : mapping manuel
                        const map = { 'super':0, 'bien':1, 'bof':2, 'mauvais':3 };
                        if(map[d.content] !== undefined) counts[map[d.content]]++;
                    }
                }
            });

            // Mettre √† jour l'affichage
            if(document.getElementById('view-nuage').classList.contains('active')) {
                renderCloud(words);
            } else if (chartInstance) {
                chartInstance.data.datasets[0].data = counts;
                chartInstance.update();
            }
        });
    }

    // 3. GESTION DU GRAPHIQUE (Chart.js)
    function initChart(labels) {
        const ctx = document.getElementById('myChart');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votes',
                    data: new Array(labels.length).fill(0),
                    backgroundColor: '#3b82f6', // Bleu par d√©faut
                    borderRadius: 10,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { color: 'white', font: { size: 18 } }, grid: { color: '#334155' } },
                    x: { ticks: { color: 'white', font: { size: 22, weight: 'bold' } }, grid: { display: false } }
                }
            }
        });
    }

    function updateChartColors() {
        if(!chartInstance) return;

        // Logique de couleur pour le QUIZ
        const colors = currentLabels.map((_, index) => {
            if (currentQuizState === 'revealed') {
                // Si r√©v√©l√© : Vert pour la bonne r√©ponse, Rouge transparent pour les autres
                return (index === currentQuizCorrectIndex) ? '#22c55e' : '#ef4444';
            } else {
                // Si vote en cours : Bleu myst√®re
                return '#3b82f6';
            }
        });

        chartInstance.data.datasets[0].backgroundColor = colors;
        chartInstance.update();
    }

    // 4. GESTION DU NUAGE
    function renderCloud(words) {
        const container = document.getElementById('cloud-container');
        container.innerHTML = "";
        
        const counts = {};
        words.forEach(w => counts[w] = (counts[w] || 0) + 1);

        Object.keys(counts).forEach(word => {
            const el = document.createElement('div');
            el.className = 'bubble';
            el.innerText = word;
            
            // Taille selon popularit√©
            let size = 1.5 + (counts[word] * 0.5);
            el.style.fontSize = Math.min(size, 5) + "rem";
            
            // Position al√©atoire
            el.style.left = Math.random() * 80 + "%";
            el.style.top = Math.random() * 80 + "%";
            
            // Couleur al√©atoire
            const cols = ['#f472b6', '#4ade80', '#60a5fa', '#facc15'];
            el.style.borderColor = cols[Math.floor(Math.random()*cols.length)];
            
            container.appendChild(el);
        });
    }

</script>
</body>
</html>
