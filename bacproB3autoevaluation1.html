<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche R√©vision PSE - Le Risque Bruit (V8 STABLE)</title>
    <style>
        :root {
            --main-bg: #f5f5f5;
            --page-bg: #ffffff;
            --primary-color: #ff4500;
            --secondary-color: #1e90ff;
            --highlight-color: #ffdb58;
            --text-color: #333333;
            --exercise-bg: #e6f7ff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --consigne-color: #008080;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--main-bg);
            color: var(--text-color);
        }

        .container {
            width: 95%;
            max-width: 1000px;
            margin: 20px auto;
            background-color: var(--page-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* --- Global Styles --- */
        h1, h2, h3 {
            color: var(--primary-color);
            border-bottom: 2px dashed var(--highlight-color);
            padding-bottom: 10px;
            margin-top: 25px;
            font-weight: 900;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease, transform 0.1s;
            margin-top: 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn:hover {
            background-color: #147ad1;
            transform: translateY(-2px);
        }

        /* --- Introduction Section --- */
        .introduction {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--highlight-color);
            border-left: 8px solid var(--primary-color);
            border-radius: 8px;
            color: var(--text-color);
        }

        .concept-box {
            background-color: var(--page-bg);
            border: 2px solid var(--secondary-color);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        /* --- Exercises Section --- */
        .exercise {
            background-color: var(--exercise-bg);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 1px solid #cceeff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .consigne {
            font-weight: bold;
            margin-bottom: 12px;
            color: var(--consigne-color);
            font-size: 1.1em;
        }

        .consigne span {
            font-weight: 900;
            text-decoration: underline;
        }

        .reponse-area {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--page-bg);
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        /* --- Competence Badge (C2, C3, C4, C5) --- */
        .competence-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
            cursor: help;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tooltip {
            visibility: hidden;
            width: 380px;
            background-color: var(--text-color);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 15px;
            position: absolute;
            z-index: 10;
            top: 50%;
            right: 105%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            border: 1px solid var(--highlight-color);
        }

        .tooltip-title {
            font-weight: bold;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .competence-badge:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        /* Ajustements pour les exercices interactifs */
        input[type="text"], textarea, select {
            width: 98%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
        }

        /* Drag and Drop & Sortable */
        .drag-source {
            min-height: 50px;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            border: 2px dashed #aaa;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .drag-item {
            background-color: var(--secondary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: move;
            display: inline-block;
        }

        .drop-target {
            min-width: 180px;
            min-height: 35px;
            padding: 5px;
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            background-color: #fff;
            text-align: center;
        }

        #q9-sortable li {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            list-style: none;
            cursor: move;
            font-weight: bold;
        }
        
        #q9-sortable li[data-value="1"] { background-color: #4CAF50; color: white; } 
        #q9-sortable li[data-value="2"] { background-color: #FFC107; color: var(--text-color); }
        #q9-sortable li[data-value="3"] { background-color: #00BCD4; color: white; }

        /* Correction */
        .score-display {
            font-size: 2.5em;
            text-align: center;
            font-weight: bold;
            padding: 20px;
            color: var(--primary-color);
            border: 4px solid var(--primary-color);
            border-radius: 10px;
            background-color: var(--highlight-color);
        }

        .recap-item {
            padding: 15px;
            border-left: 5px solid var(--secondary-color);
            background-color: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .recap-item strong {
            color: var(--secondary-color);
        }

        .correct-answer-text {
            color: var(--success-color);
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }

        .wrong-answer-text {
            color: var(--danger-color);
            font-style: italic;
        }
        .text-center { text-align: center; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="page1" class="container">
        <h1>Fiche de R√©vision PSE - La Pr√©vention du Risque Bruit et l'Audition</h1>

        <section class="introduction">
            <h2>üí° Les Notions Cl√©s sur le Son et l'Oreille</h2>
            <p>Le son est une onde vibratoire. Comprendre ses caract√©ristiques permet de pr√©venir les atteintes auditives, qui sont souvent irr√©versibles.</p>
            <div class="concept-box">
                <p><strong>Param√®tres √† Retenir :</strong></p>
                <ul>
                    <li><strong>Fr√©quence (en Hertz - Hz) :</strong> D√©finit si un son est grave (basse fr√©quence, 20 Hz) ou aigu (haute fr√©quence, 20 000 Hz).</li>
                    <li><strong>Intensit√© Sonore (en D√©cibels - dB(A)) :</strong> D√©finit si le son est faible ou fort. C'est le principal facteur de dangerosit√©.</li>
                </ul>
                <p><strong>Les Seuils de Risque :</strong></p>
                <ul>
                    <li><strong>60 dB(A) :</strong> Seuil de Fatigue.</li>
                    <li><strong>80 dB(A) :</strong> Seuil de Nocivit√© (le risque augmente avec la dur√©e d'exposition).</li>
                    <li><strong>120 dB(A) :</strong> Seuil de Douleur (risque imm√©diat).</li>
                </ul>
            </div>
            <p><strong>Fonction de l'Oreille :</strong> L'oreille est divis√©e en trois parties.</p>
            <ul>
                <li><strong>Oreille Externe :</strong> Capter les sons et les acheminer vers le tympan.</li>
                <li><strong>Oreille Moyenne :</strong> Transmettre m√©caniquement les vibrations gr√¢ce √† la cha√Æne des osselets.</li>
                <li><strong>Oreille Interne :</strong> Convertir l'√©nergie sonore en influx nerveux via la cochl√©e, qui contient les cellules cili√©es (organes de l'audition).</li>
            </ul>
            <p>L'exposition prolong√©e au bruit (> 80 dB) d√©truit ces cellules cili√©es, provoquant surdit√© ou acouph√®nes.</p>
        </section>

        <div class="text-center">
            <button class="btn" onclick="goToPage('quiz')">üöÄ COMMENCER L'AUTO-√âVALUATION (10 QUESTIONS)</button>
            <p style="margin-top: 10px; font-style: italic;">√âvaluation bas√©e sur les comp√©tences PSE (C2, C3, C4, C5).</p>
        </div>
    </div>

    <div id="page2" class="container hidden">
        <h1>Auto-√âvaluation PSE - Le Risque Bruit</h1>

        <div id="c2-tooltip-data" style="display: none;">
                <div class="tooltip-title">C2 - Appliquer une d√©marche d‚Äôanalyse dans une situation donn√©e</div>
                <p>Identifier et relier les √©l√©ments factuels (causes, cons√©quences, contexte) pour comprendre un probl√®me.</p>
                <p>Exemple : <u>Identifier</u> les causes profondes d'un accident via un outil d'analyse (QQOQCP, 5M).</p>
            </div>
            <div id="c3-tooltip-data" style="display: none;">
                <div class="tooltip-title">C3 - Expliquer un ph√©nom√®ne physiologique, un enjeu environnemental, une disposition r√©glementaire, en lien avec une mesure de pr√©vention</div>
                <p>D√©crire un m√©canisme scientifique ou une r√®gle en montrant le lien de cause √† effet avec une action de pr√©vention.</p>
                <p>Exemple : <u>Expliquer</u> comment le bruit endommage la cochl√©e pour justifier le port de protections.</p>
            </div>
            <div id="c4-tooltip-data" style="display: none;">
                <div class="tooltip-title">C4 - Proposer une solution pour r√©soudre un probl√®me</div>
                <p>Sugg√©rer des actions concr√®tes (mesures de pr√©vention) qui sont pertinentes et efficaces face au probl√®me analys√©.</p>
                <p>Exemple : <u>Proposer</u> une mesure de protection collective prioritaire.</p>
            </div>
            <div id="c5-tooltip-data" style="display: none;">
                <div class="tooltip-title">C5 - Argumenter un choix</div>
                <p>Justifier une d√©cision ou un positionnement en fournissant des arguments solides, bas√©s sur des faits scientifiques ou r√©glementaires.</p>
                <p>Exemple : <u>Argumenter</u> pourquoi une mesure (EPI) est n√©cessaire malgr√© l'existence d'une autre mesure (EPC).</p>
            </div>
            
            <div id="q1" class="exercise">
                <div class="consigne">1. üß† <span><u>Expliquer</u></span> le dommage auditif en compl√©tant le texte : L'exposition prolong√©e au bruit d√©truit les <select id="q1-select-1" name="q1-1"><option value="">-- √©l√©ment --</option><option value="cilliees">cellules cili√©es</option><option value="tympaniques">membranes tympaniques</option></select> situ√©es dans la <select id="q1-select-2" name="q1-2"><option value="">-- zone --</option><option value="osselets">cha√Æne des osselets</option><option value="cochlee">cochl√©e</option></select>, ce qui provoque une surdit√©.</div>
                <span class="competence-badge" data-comp="C3">C3</span>
            </div>

            <div id="q2" class="exercise">
                <div class="consigne">2. üõ°Ô∏è <span><u>Proposer</u></span> la mesure de pr√©vention la plus efficace et prioritaire face au bruit dans un atelier :</div>
                <div class="reponse-area">
                    <div class="qcm-option"><input type="radio" name="q2" value="casque"> Fournir des protections individuelles (EPI) √† tous.</div>
                    <div class="qcm-option"><input type="radio" name="q2" value="encoffrement"> Mettre en place un encoffrement acoustique autour de la machine la plus bruyante.</div>
                    <div class="qcm-option"><input type="radio" name="q2" value="rotation"> Organiser une rotation des t√¢ches pour limiter l'exposition √† 15 minutes par personne.</div>
                </div>
                <span class="competence-badge" data-comp="C4">C4</span>
            </div>

            <div id="q3" class="exercise">
                <div class="consigne">3. ‚öôÔ∏è <span><u>Indiquer</u></span> l'unit√© de mesure de la Fr√©quence du son (aigu/grave) : L'unit√© est le ______________.</div>
                <div class="reponse-area">
                    <input type="text" id="q3-input" name="q3" style="width: 250px;">
                </div>
                <span class="competence-badge" data-comp="C2">C2</span>
            </div>
            
            <div id="q4" class="exercise">
                <div class="consigne">4. üëç <span><u>Argumenter</u></span> le choix d'utiliser des protections individuelles (EPI) m√™me si l'entreprise a d√©j√† install√© une isolation acoustique (mesure collective). (Expliquez le lien avec la hi√©rarchie des mesures).</div>
                <div class="reponse-area">
                    <textarea id="q4-textarea" name="q4" rows="4" style="width: 100%;"></textarea>
                </div>
                <span class="competence-badge" data-comp="C5">C5</span>
            </div>
            
            <div id="q5" class="exercise">
                <div class="consigne">5. üõ†Ô∏è <span><u>Proposer</u></span> une action en compl√©tant la phrase : Pour r√©duire le risque bruit li√© √† la <strong>Main d'≈ìuvre</strong> (5M), il est essentiel de <select id="q5-select-1" name="q5-1"><option value="">-- action --</option><option value="former">former et sensibiliser les op√©rateurs</option><option value="reparer">r√©parer les machines</option></select> pour ma√Ætriser les <select id="q5-select-2" name="q5-2"><option value="">-- causes --</option><option value="physiologiques">causes physiologiques</option><option value="comportementales">causes comportementales</option></select> d'accident.</div>
                <span class="competence-badge" data-comp="C4">C4</span>
            </div>

            <div id="q6" class="exercise">
                <div class="consigne">6. ü§ï <span><u>Expliquer</u></span> le m√©canisme des acouph√®nes (sifflements) apr√®s un traumatisme sonore. (D√©crivez le ph√©nom√®ne physiologique associ√© √† la cochl√©e)</div>
                <div class="reponse-area">
                    <textarea id="q6-textarea" name="q6" rows="4" style="width: 100%;"></textarea>
                </div>
                <span class="competence-badge" data-comp="C3">C3</span>
            </div>

            <div id="q7" class="exercise">
                <div class="consigne">7. üìâ <span><u>Analyser</u></span> le seuil de dangerosit√© : Indiquer le seuil de <strong>NOCIVIT√â</strong> au-del√† duquel l'exposition est dangereuse (en dB(A)) :</div>
                <div class="slider-container">
                    <input type="range" min="70" max="90" value="80" step="1" id="q7-range" oninput="document.getElementById('q7-value').innerText = this.value + ' dB(A)'">
                    <p class="slider-label">Seuil s√©lectionn√© : <span id="q7-value" class="slider-value">80 dB(A)</span></p>
                </div>
                <span class="competence-badge" data-comp="C2">C2</span>
            </div>

            <div id="q8" class="exercise">
                <div class="consigne">8. üëÇ <span><u>Associer</u></span> la partie de l'oreille √† son r√¥le principal :</div>
                <div class="drag-container">
                    <div class="drag-source" id="q8-source">
                        <div id="item-8a" class="drag-item" draggable="true" data-value="cochlee">Cochl√©e</div>
                        <div id="item-8b" class="drag-item" draggable="true" data-value="osselets">Cha√Æne des osselets</div>
                        <div id="item-8c" class="drag-item" draggable="true" data-value="pavillon">Pavillon</div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <tr>
                            <td style="width: 40%; padding: 5px;">Convertit l'onde sonore en influx nerveux :</td>
                            <td style="width: 60%;"><div id="q8-target-1" class="drop-target" data-correct="cochlee"></div></td>
                        </tr>
                        <tr>
                            <td>Transmet m√©caniquement le son :</td>
                            <td><div id="q8-target-2" class="drop-target" data-correct="osselets"></div></td>
                        </tr>
                        <tr>
                            <td>Capte et achemine le son :</td>
                            <td><div id="q8-target-3" class="drop-target" data-correct="pavillon"></div></td>
                        </tr>
                    </table>
                </div>
                <span class="competence-badge" data-comp="C2">C2</span>
            </div>

            <div id="q9" class="exercise">
                <div class="consigne">9. ‚è´ <span><u>Hi√©rarchiser</u></span> ces mesures de pr√©vention du risque bruit, de la plus efficace (1) √† la moins efficace (3), selon les principes de pr√©vention :</div>
                <div class="reponse-area">
                    <ol id="q9-sortable" style="list-style: none; padding: 0;">
                        <li draggable="true" data-value="2">√âloigner les travailleurs de la zone bruyante</li>
                        <li draggable="true" data-value="3">Utiliser des protections auditives individuelles (bouchons)</li>
                        <li draggable="true" data-value="1">Remplacer la machine bruyante par un mod√®le silencieux</li>
                    </ol>
                </div>
                <span class="competence-badge" data-comp="C4">C4</span>
            </div>

            <div id="q10" class="exercise">
                <div class="consigne">10. ‚è±Ô∏è <span><u>Analyser</u></span> la situation : Pourquoi la dur√©e d'exposition est-elle un facteur cl√© dans l'√©valuation du risque bruit, m√™me √† un niveau moyen (85 dB) ? (Expliquez le risque associ√© au temps).</div>
                <div class="reponse-area">
                    <textarea id="q10-textarea" name="q10" rows="3" style="width: 100%;"></textarea>
                </div>
                <span class="competence-badge" data-comp="C2">C2</span>
            </div>

            <div class="text-center">
                <button type="button" class="btn" onclick="submitQuiz()">‚úÖ TERMINER ET AFFICHER LA CORRECTION</button>
            </div>
        
    </div>

    <div id="correction-page" class="container hidden">
        <h1>Correction de l'Auto-√âvaluation</h1>
        <div id="score-display" class="score-display"></div>
        <div class="text-center">
            <button class="btn" style="background-color: var(--primary-color);" onclick="resetQuizAndGoToPage('quiz')">üîÅ RECOMMENCER L'AUTO-√âVALUATION</button>
        </div>

        <section class="correction-section">
            <h2>D√©tail de vos R√©ponses (Note sur 20)</h2>
            <p><strong>Note:</strong> L'√©valuation sur 20 est indicative. Le plus important est de **<u>valider les comp√©tences (C2 √† C5)</u>**.</p>
            <div id="recap-list"></div>
        </section>

        <section class="correction-section">
            <h2>Points √† Revoir et Conseils</h2>
            <ul id="review-points"></ul>
            <p style="margin-top: 20px; text-align: center; font-weight: bold;">
                üí™ Continuez √† travailler ! La ma√Ætrise de ces notions est essentielle pour votre examen.
            </p>
        </section>

        <div class="text-center">
            <button class="btn" style="background-color: var(--success-color);" onclick="downloadHTML()">üíæ ENREGISTRER LE DOCUMENT (CORRECTION INCLUSE)</button>
        </div>
    </div>

    <script>
        const questions = [
            { id: 'q1', comp: 'C3', points: 2, type: 'select', correct: ['cilliees', 'cochlee'], explanation: "L'explication physiologique (C3) est que les cellules cili√©es de la cochl√©e sont l'organe de l'audition et sont d√©truites par le bruit.", keywords: ['cellules cili√©es', 'cochl√©e'] },
            { id: 'q2', comp: 'C4', points: 2, type: 'radio', correct: 'encoffrement', explanation: "Le remplacement ou l'encoffrement de la machine (agir √† la source) est la mesure de pr√©vention collective la plus efficace et prioritaire (C4), avant les EPI.", keywords: ['encoffrement'] },
            { id: 'q3', comp: 'C2', points: 1, type: 'text', correct: 'hertz', keywords: ['hertz', 'Hz'], explanation: "Le Hertz (Hz) est l'unit√© de mesure de la Fr√©quence, permettant l'analyse du son (C2).", keywords: ['hertz'] },
            { id: 'q4', comp: 'C5', points: 3, type: 'textarea', correct: "L'argument (C5) est que les EPI sont un compl√©ment indispensable (derni√®re barri√®re) lorsque les mesures collectives (isolation) ne suffisent pas √† supprimer totalement le risque (bruit r√©siduel) ou en cas de d√©faillance.", keywords: ['compl√©ment', 'r√©siduel', '√©chec', 'hi√©rarchie'] },
            { id: 'q5', comp: 'C4', points: 2, type: 'select', correct: ['former', 'comportementales'], explanation: "Le risque li√© √† la Main d'≈ìuvre (5M) est souvent comportemental et n√©cessite une action de Formation/Sensibilisation (C4).", keywords: ['former', 'comportementales'] },
            { id: 'q6', comp: 'C3', points: 3, type: 'textarea', correct: "L'explication (C3) est que le traumatisme sonore endommage les cellules cili√©es de la cochl√©e. Le cerveau, ne recevant plus le signal auditif normal, g√©n√®re un 'signal fant√¥me' (le sifflement).", keywords: ['cellules cili√©es', 'destruction', 'signal', 'nerveux', 'compense'] },
            { id: 'q7', comp: 'C2', points: 1, type: 'range', correct: 80, tolerance: 3, explanation: "Le seuil de nocivit√© (C2) est fix√© √† 80 dB(A).", keywords: ['80'] },
            { id: 'q8', comp: 'C2', points: 2, type: 'drag', targets: { 'q8-target-1': 'cochlee', 'q8-target-2': 'osselets', 'q8-target-3': 'pavillon' }, explanation: "L'analyse (C2) des r√¥les est : Pavillon (capte), Osselets (transmet m√©caniquement), Cochl√©e (convertit en influx nerveux).", keywords: ['cochl√©e', 'osselets', 'pavillon'] },
            { id: 'q9', comp: 'C4', points: 1, type: 'sort', correct: [1, 2, 3], explanation: "La hi√©rarchie (C4) est : 1. Suppression/Remplacement (Remplacer la machine). 2. Mesures Collectives (√âloigner). 3. Mesures Individuelles (Bouchons).", keywords: ['remplacer', '√©loigner', 'bouchons'] },
            { id: 'q10', comp: 'C2', points: 2, type: 'textarea', correct: "L'analyse (C2) doit inclure que les dommages caus√©s aux cellules cili√©es par l'√©nergie sonore sont cumulatifs (s'additionnent dans le temps) et irr√©versibles.", keywords: ['cumulatif', 'irr√©versible', 'temps', 'additionne'] }
        ];

        let totalScore = 0;
        const totalPoints = questions.reduce((sum, q) => sum + q.points, 0);

        function goToPage(pageId) {
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('page2').classList.add('hidden');
            document.getElementById('correction-page').classList.add('hidden');
            
            let targetId;
            if (pageId === 'quiz') {
                targetId = 'page2';
            } else if (pageId === 'correction') {
                targetId = 'correction-page';
            } else {
                targetId = 'page1'; // Par d√©faut
            }

            const targetPage = document.getElementById(targetId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                
                // Si on va √† la page du quiz
                if (targetId === 'page2') {
                    initDragAndDrop();
                    initSortable();
                    attachTooltips();
                }
            }
        }

        function attachTooltips() {
            document.querySelectorAll('.competence-badge').forEach(badge => {
                const comp = badge.getAttribute('data-comp');
                
                // Remove existing tooltip
                let existingTooltip = badge.querySelector('.tooltip');
                if (existingTooltip) {
                    existingTooltip.remove();
                }

                // Clone content from hidden data div
                const dataDiv = document.getElementById(`${comp.toLowerCase()}-tooltip-data`);
                if (dataDiv) {
                    const tooltipContent = dataDiv.innerHTML;
                    
                    const tooltipDiv = document.createElement('span');
                    tooltipDiv.classList.add('tooltip');
                    tooltipDiv.innerHTML = tooltipContent;
                    
                    badge.appendChild(tooltipDiv);
                }
            });
        }


        function initDragAndDrop() {
            document.querySelectorAll('.drag-source .drag-item').forEach(item => {
                item.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', e.target.id); });
            });

            document.querySelectorAll('.drop-target').forEach(target => {
                target.addEventListener('dragover', (e) => { e.preventDefault(); target.style.backgroundColor = '#f0f8ff'; });
                target.addEventListener('dragleave', (e) => { target.style.backgroundColor = '#fff'; });
                target.addEventListener('drop', (e) => {
                    e.preventDefault();
                    target.style.backgroundColor = '#fff';
                    const data = e.dataTransfer.getData('text/plain');
                    const draggedElement = document.getElementById(data);

                    if (target.querySelector('.drag-item')) {
                        const existingItem = target.querySelector('.drag-item');
                        const sourceContainer = existingItem.closest('.exercise').querySelector('.drag-source');
                        sourceContainer.appendChild(existingItem);
                    }
                    target.innerHTML = '';
                    target.appendChild(draggedElement);
                });
            });
        }

        function initSortable() {
            const sortableList = document.getElementById('q9-sortable');
            if (!sortableList) return; // Protection against null element

            let draggedItem = null;

            sortableList.querySelectorAll('li').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = e.target;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', e.target.id);
                    setTimeout(() => item.style.opacity = '0.5', 0);
                });

                item.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '1';
                    draggedItem = null;
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (e.target.tagName === 'LI' && e.target !== draggedItem) {
                        const rect = e.target.getBoundingClientRect();
                        const next = (e.clientY - rect.top) / rect.height > 0.5;
                        sortableList.insertBefore(draggedItem, next ? e.target.nextSibling : e.target);
                    }
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                });
            });
        }

        function resetQuizAndGoToPage(pageId) {
            // Remet les champs du quiz √† z√©ro
            const quizContainer = document.getElementById('page2');
            if (quizContainer) {
                const formElements = quizContainer.querySelectorAll('select, input, textarea');
                formElements.forEach(element => {
                    if (element.type === 'radio' || element.type === 'checkbox') {
                        element.checked = false;
                    } else if (element.tagName === 'SELECT') {
                        element.selectedIndex = 0;
                    } else if (element.type === 'range') {
                        element.value = 80; // Valeur par d√©faut pour le curseur
                        const valueDisplay = document.getElementById('q7-value');
                        if (valueDisplay) valueDisplay.innerText = '80 dB(A)';
                    } else {
                        element.value = '';
                    }
                });
            }

            // Remet les √©l√©ments drag & drop dans leur source
            questions.forEach(q => {
                if (q.type === 'drag') {
                    const dropTargets = document.querySelectorAll(`#${q.id} .drop-target`);
                    const dragSource = document.querySelector(`#${q.id} .drag-source`);
                    dropTargets.forEach(target => {
                        const item = target.querySelector('.drag-item');
                        if (item && dragSource) {
                            dragSource.appendChild(item);
                        }
                    });
                }
                // R√©initialiser l'ordre de tri (q9)
                if (q.id === 'q9') {
                    const sortableList = document.getElementById('q9-sortable');
                    if (sortableList) {
                         const items = Array.from(sortableList.children);
                        // Tri par valeur data-value pour revenir √† l'√©tat initial
                        items.sort((a, b) => (a.getAttribute('data-value') > b.getAttribute('data-value')) ? 1 : -1);
                        items.forEach(item => sortableList.appendChild(item));
                    }
                }
            });

            // Va √† la page d'√©valuation
            goToPage(pageId);
        }


        function checkAnswer(q) {
            let userResponse = null;
            let isCorrect = false;

            switch (q.type) {
                case 'select':
                    if (Array.isArray(q.correct)) {
                        userResponse = [document.getElementById(q.id + '-select-1')?.value, document.getElementById(q.id + '-select-2')?.value].filter(Boolean);
                        isCorrect = userResponse.length === q.correct.length && userResponse.every((val, index) => val === q.correct[index]);
                    } else {
                        userResponse = document.getElementById(q.id + '-select').value;
                        isCorrect = userResponse === q.correct;
                    }
                    break;
                case 'text':
                    userResponse = document.getElementById(q.id + '-input')?.value.trim() || '';
                    const normalizedResponse = userResponse.toLowerCase();
                    if (q.keywords) {
                        isCorrect = q.keywords.some(k => normalizedResponse.includes(k.toLowerCase()));
                    } else {
                        isCorrect = normalizedResponse === q.correct.toLowerCase();
                    }
                    break;
                case 'radio':
                    const radioChecked = document.querySelector(`input[name="q2"]:checked`); // Use static name for radio group
                    userResponse = radioChecked ? radioChecked.value : null;
                    isCorrect = userResponse === q.correct;
                    break;
                case 'textarea':
                    userResponse = document.getElementById(q.id + '-textarea')?.value.trim() || '';
                    const lowerText = userResponse.toLowerCase();
                    
                    // Score based on keyword presence and minimum length (for open questions)
                    if (q.keywords) {
                        const keywordMatch = q.keywords.some(k => lowerText.includes(k.toLowerCase()));
                        isCorrect = keywordMatch && userResponse.length > 20; 
                    } else {
                        isCorrect = userResponse.length > 20; 
                    }
                    break;
                case 'drag':
                    userResponse = {};
                    isCorrect = true;
                    for (const targetId in q.targets) {
                        const target = document.getElementById(targetId);
                        const item = target?.querySelector('.drag-item');
                        userResponse[targetId] = item ? item.getAttribute('data-value') : null;
                        if (userResponse[targetId] !== q.targets[targetId]) {
                            isCorrect = false;
                        }
                    }
                    break;
                case 'range':
                    const rangeElement = document.getElementById(q.id + '-range');
                    userResponse = rangeElement ? parseInt(rangeElement.value) : null;
                    isCorrect = userResponse !== null && userResponse >= q.correct - q.tolerance && userResponse <= q.correct + q.tolerance;
                    break;
                case 'sort':
                    const sortable = document.getElementById(q.id + '-sortable');
                    if (!sortable) return { isCorrect: false, score: 0, userResponse: null, correctAnswer: q.correct };
                    userResponse = Array.from(sortable.children).map(li => parseInt(li.getAttribute('data-value')));
                    isCorrect = JSON.stringify(userResponse) === JSON.stringify(q.correct);
                    break;
            }

            return {
                isCorrect: isCorrect,
                score: isCorrect ? q.points : 0,
                userResponse: userResponse,
                correctAnswer: q.correct
            };
        }

        function submitQuiz() {
            
            totalScore = 0;
            const recapList = document.getElementById('recap-list');
            recapList.innerHTML = '';
            let reviewPointsContent = new Set();
            const totalPossiblePoints = questions.reduce((sum, q) => sum + q.points, 0);


            questions.forEach((q, index) => {
                const result = checkAnswer(q);
                totalScore += result.score;
                const isAnswered = q.type === 'textarea' ? result.userResponse && result.userResponse.length > 0 : (Array.isArray(result.userResponse) ? result.userResponse.some(r => r !== null) : result.userResponse !== null);
                const status = result.isCorrect ? 'Correcte' : (isAnswered ? 'Incorrecte' : 'Non r√©pondue');
                const statusClass = result.isCorrect ? 'correct-answer-text' : 'wrong-answer-text';

                if (!result.isCorrect) {
                    reviewPointsContent.add(`Revoir la Comp√©tence ${q.comp} : ${q.explanation}`);
                }

                let displayUserAnswer = '';
                let displayCorrectAnswer = '';
                
                if (q.type === 'drag') {
                    displayUserAnswer = 'Vos associations (√âl√©ment gliss√©) : ';
                    displayCorrectAnswer = 'Correct (Valeur attendue) : ';
                    
                    const targetElements = document.querySelectorAll(`#${q.id} .drop-target`);
                    
                    let targetIndex = 1;
                    for (const targetId in q.targets) {
                        const userValue = result.userResponse[targetId] || 'Rien';
                        const isTargetCorrect = userValue === q.targets[targetId];

                        let labelText = '';
                        if(targetElements[targetIndex - 1]) {
                            const row = targetElements[targetIndex - 1].closest('tr');
                            if(row) labelText = row.querySelector('td:first-child').innerText.trim();
                        }
                        
                        displayUserAnswer += `<span class="${isTargetCorrect ? 'correct-answer-text' : 'wrong-answer-text'}" style="display: inline-block;">${labelText}: ${userValue}</span> | `;
                        displayCorrectAnswer += ` ${q.targets[targetId]} | `;
                        targetIndex++;
                    }

                } else if (q.type === 'sort') {
                    const userOrder = Array.from(document.getElementById(q.id + '-sortable')?.children || []).map(li => li.innerText.trim());
                    displayUserAnswer = `Votre ordre (1 > 2 > 3) : ${userOrder.join(' > ')}`;
                    displayCorrectAnswer = `Correct : 1. Remplacer la machine... > 2. √âloigner... > 3. Utiliser des protections...`;
                } else if (q.type === 'select' && Array.isArray(q.correct)) {
                    const select1 = document.getElementById(q.id + '-select-1');
                    const select2 = document.getElementById(q.id + '-select-2');
                    
                    const userText1 = select1 ? select1.options[select1.selectedIndex].text : '';
                    const userText2 = select2 ? select2.options[select2.selectedIndex].text : '';
                    
                    displayUserAnswer = `Votre r√©ponse : ${userText1} / ${userText2}`;
                    displayCorrectAnswer = `Correct : ${q.correct.join(' / ')}`;
                } else if (q.type === 'textarea') {
                    displayUserAnswer = `Votre r√©ponse : <br><em style="font-style: normal; color: ${result.isCorrect ? 'var(--success-color)' : 'var(--danger-color)'};">"${result.userResponse}"</em>`;
                    displayCorrectAnswer = `Id√©es Cl√©s (Mot-cl√©s attendus) : ${q.keywords.join(', ')}`;
                } else {
                    displayUserAnswer = `Votre r√©ponse : ${result.userResponse || 'Non r√©pondu'}`;
                    displayCorrectAnswer = `Correct : ${q.correct}`;
                }


                recapList.innerHTML += `
                    <div class="recap-item">
                        <strong>Question ${index + 1} (${q.comp}) :</strong> <span class="${statusClass}">${status}</span> (${result.score}/${q.points} pts)<br>
                        <em>${displayUserAnswer}</em>
                        <span class="correct-answer-text">R√©ponse Attendue : ${displayCorrectAnswer}</span><br>
                        <span style="font-size: 0.9em; display: block; margin-top: 5px;">Justification (C3/C5) : ${q.explanation}</span>
                    </div>
                `;
            });

            const finalScore = (totalScore / totalPossiblePoints) * 20;

            document.getElementById('score-display').innerHTML = `Note Finale : ${finalScore.toFixed(1)} / 20`;
            
            const reviewList = document.getElementById('review-points');
            reviewList.innerHTML = '';
            reviewPointsContent.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = item;
                reviewList.appendChild(li);
            });
            if (reviewPointsContent.size === 0) {
                 reviewList.innerHTML = '<p style="color: var(--success-color); font-weight: bold;">F√©licitations ! Vous avez une excellente ma√Ætrise des notions. Pensez √† r√©viser le d√©tail des explications (C3) pour les questions ouvertes.</p>';
            }

            goToPage('correction');
        }

        function downloadHTML() {
            const content = document.documentElement.outerHTML;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Revisions_PSE_Risque_Bruit_V7_Definitive.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.onload = () => {
            goToPage('intro'); 
        };
    </script>
</body>
</html>